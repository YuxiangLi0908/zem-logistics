{% extends 'base.html' %}

{% block content %}
<style>
/* æ•´ä½“èƒŒæ™¯å’Œå­—ä½“ */
body {
    font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
    color: #2c3e50;
}

/* æŸ¥è¯¢æ  */
.search-form {
    background: #34495e;
    padding: 20px;
    border-radius: 8px;
    margin-bottom: 20px;
    color: white;
}

.search-input-group {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    align-items: center;
}

.search-input, .search-select {
    padding: 8px 12px;
    border-radius: 4px;
    border: none;
    font-size: 14px;
}

.search-select {
    min-width: 160px;
}

.search-btn {
    padding: 8px 16px;
    background-color: #27ae60;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s;
}

.search-btn:hover {
    background-color: #2ecc71;
}

/* æ¶ˆæ¯æç¤º */
.message {
    padding: 12px;
    border-radius: 4px;
    margin-bottom: 12px;
}

.message.success {
    background: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
}

.message.error {
    background: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
}

.message.warning {
    background: #fff3cd;
    color: #856404;
    border: 1px solid #ffeeba;
}

/* æŸ¥è¯¢ç»“æœè¡¨æ ¼ */
.data-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
}

.data-table th, .data-table td {
    border: 1px solid #bdc3c7;
    padding: 8px 10px;
    text-align: left;
    font-size: 13px;
}

.data-table th {
    background-color: #34495e;
    color: white;
    font-weight: 600;
}

.data-table tr:nth-child(even) {
    background-color: #ecf0f1;
}

.data-table tr:hover {
    background-color: #d0d7de;
}

/* åˆ—å®½é™åˆ¶ */
.col-fba, .col-ref, .col-shipping {
    max-width: 120px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

/* åˆ é™¤æŒ‰é’® */
.delete-btn {
    padding: 4px 8px;
    background: #e74c3c;
    color: white;
    border: none;
    border-radius: 4px;
    font-size: 12px;
    cursor: pointer;
    transition: 0.2s;
}

.delete-btn:hover {
    background: #c0392b;
}

.no-results {
    padding: 20px;
    text-align: center;
    color: #7f8c8d;
    font-style: italic;
    border: 1px solid #bdc3c7;
    border-radius: 4px;
    margin-top: 15px;
}
h2 {
    text-align: center;
    margin-bottom: 20px;
    background: linear-gradient(45deg, #ff6b6b, #4ecdc4, #45b7d1, #96ceb4, #feca57);
    background-size: 400% 400%;
    -webkit-background-clip: text;
    background-clip: text;
    -webkit-text-fill-color: transparent;
    animation: gradient 3s ease infinite;
    font-weight: bold;
}
@keyframes gradient {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
}
</style>

<h2> æ´¾é€è´¦å•æŸ¥è¯¢ </h2>
<!-- æŸ¥è¯¢è¡¨å• -->
<div class="search-form">
    <form method="post">
        {% csrf_token %}
        <input type="hidden" name="step" value="search_invoice_delivery">
        <div class="search-input-group">
            <select name="search_type" class="search-select" required>
                <option value="">é€‰æ‹©æŸ¥è¯¢ç±»å‹</option>
                <option value="container" {% if search_type == 'container' %}selected{% endif %}>æŸœå·æŸ¥è¯¢</option>
                <option value="invoice" {% if search_type == 'invoice' %}selected{% endif %}>å‘ç¥¨å·æŸ¥è¯¢</option>
                <option value="pallet" {% if search_type == 'pallet' %}selected{% endif %}>Pallet ID æŸ¥è¯¢</option>
            </select>
            <input type="text" name="search_value" class="search-input"
                   placeholder="è¾“å…¥æŸ¥è¯¢å€¼" value="{{ search_value|default:'' }}" required>
            <button type="submit" class="search-btn">æŸ¥è¯¢</button>
        </div>
    </form>
</div>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
    <!-- å·¦ä¾§ Container ä¿¡æ¯ -->
    <div>
        {% if container_info %}
        <strong>Container ID:</strong> {{ container_info.id }} | 
        <strong>Container Number:</strong> {{ container_info.number }}
        {% elif invoice_info %}
        <strong>Invoice ID:</strong> {{ invoice_info.id }} | 
        <strong>Invoice Number:</strong> {{ invoice_info.number }}
        {% endif %}
    </div>
    <!-- å³ä¾§åˆ é™¤æŒ‰é’® -->
    {% if container_info %}
    <form method="post" style="margin:0;">
        {% csrf_token %}
        <input type="hidden" name="step" value="delete_container_invoice_deliveries">
        <input type="hidden" name="container_id" value="{{ container_info.id }}">
        <input type="hidden" name="search_type" value="{{ search_type }}">
        <input type="hidden" name="search_value" value="{{ search_value }}">
        <button type="submit" class="delete-btn" 
                style="background:#e74c3c; color:white; border:none; border-radius:6px; padding:6px 12px; cursor:pointer;"
                onclick="return confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæŸœå­ä¸‹æ‰€æœ‰ Invoice Delivery å—ï¼Ÿ')">
            <i class="fas fa-trash"></i> åˆ é™¤æ•´ä¸ªæŸœå­ Invoice Delivery
        </button>
    </form>
    {% endif %}
    <!-- å³ä¾§æœç´¢æ¡† -->
    <div style="position: relative; width: 300px;">
        <input type="text" id="tableSearchInput" placeholder="ğŸ” æœç´¢è¡¨æ ¼å†…å®¹" 
               style="
                   width: 100%;
                   padding: 8px 35px 8px 12px;
                   border-radius: 6px;
                   border: 1px solid #ccc;
                   font-size: 14px;
                   font-family: 'Arial', sans-serif;
                   transition: all 0.3s ease;
               ">
        <span style="
                   position: absolute;
                   right: 10px;
                   top: 50%;
                   transform: translateY(-50%);
                   color: #888;
                   font-size: 16px;
               ">ğŸ”</span>
    </div>
</div>
<!-- æ¶ˆæ¯æç¤º -->
{% if messages %}
    {% for message in messages %}
        <div class="message {% if message.tags %}{{ message.tags }}{% endif %}">
            {{ message }}
        </div>
    {% endfor %}
{% endif %}

<!-- æŸ¥è¯¢ç»“æœ -->
{% if search_results %}
<table class="data-table">
    <thead>
        <tr>
            <th>Pallet ID</th>
            <th>æŸœå·</th>
            <th>Shipment</th>
            <th>Fleet</th>
            <th class="col-fba">FBA</th>
            <th class="col-ref">REF</th>
            <th>ç›®çš„åœ°</th>
            <th>æ´¾é€æ–¹å¼</th>
            <th>CBM</th>
            <th>é‡é‡(lbs)</th>
            <th>ä»¶æ•°</th>
            <th class="col-shipping">ä½ç½®</th>
            <th>å¤‡æ³¨</th>
            <th>Invoice Delivery ID</th>
            <th>æ“ä½œ</th>
        </tr>
    </thead>
    <tbody>
        {% for pallet in search_results %}
        <tr>
            <td>{{ pallet.id }}</td>
            <td>{{ pallet.container_number__container_number }}</td>
            <td>{{ pallet.shipment_batch_number__shipment_batch_number|default_if_none:"" }}</td>
            <td>{{ pallet.shipment_batch_number__fleet_number__fleet_number|default_if_none:"" }}</td>
            <td class="col-fba">{{ pallet.fba_id|default:"-" }}</td>
            <td class="col-ref">{{ pallet.ref_id|default:"-" }}</td>
            <td>{{ pallet.destination|default:"-" }}</td>
            <td>{{ pallet.delivery_method|default:"-" }}</td>
            <td>{{ pallet.cbm|default:"-" }}</td>
            <td>{{ pallet.weight_lbs|default:"-" }}</td>
            <td>{{ pallet.pcs|default:"-" }}</td>
            <td class="col-shipping">{{ pallet.location|default:"-" }}</td>
            <td>{{ pallet.note|default:"-" }}</td>
            <td>{{ pallet.invoice_delivery_id|default:"æ— " }}</td>
            <td>
                {% if pallet.invoice_delivery_id %}
                <form method="post" style="display:inline;">
                    {% csrf_token %}
                    <input type="hidden" name="step" value="delete_pallet_invoice_delivery">
                    <input type="hidden" name="pallet_id" value="{{ pallet.id }}">
                    <input type="hidden" name="search_type" value="{{ search_type }}">
                    <input type="hidden" name="search_value" value="{{ search_value }}">
                    <button type="submit" class="delete-btn"
                        onclick="return confirm('ç¡®å®šåˆ é™¤æ­¤ Invoice Delivery å—ï¼Ÿ')">
                        åˆ é™¤
                    </button>
                </form>
                {% else %}
                <span style="color:#7f8c8d;">æ— </span>
                {% endif %}
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% endif %}

{% if invoice_deliveries %}
<div style="overflow-x:auto;">
    <table class="data-table" style="width:100%; border-collapse: collapse;">
        <thead>
            <tr>
                <th>ID</th>
                <th>Invoice Delivery</th>
                <th>Type</th>
                <th>Delivery Type</th>
                <th>Destination</th>
                <th>Total Pallet</th>
                <th>Total CBM</th>
                <th>Total Weight</th>
                <th>Note</th>
                <th>æ“ä½œ</th>
            </tr>
        </thead>
        <tbody id="tableBody">
            {% for item in invoice_deliveries %}
            <tr>
                <td>{{ item.id }}</td>
                <td style="max-width:100px; overflow:hidden; text-overflow:ellipsis;">{{ item.invoice_delivery }}</td>
                <td>{{ item.invoice_type }}</td>
                <td>{{ item.delivery_type }}</td>
                <td>{{ item.destination }}</td>
                <td>{{ item.total_pallet }}</td>
                <td>{{ item.total_cbm }}</td>
                <td>{{ item.total_weight_lbs }}</td>
                <td style="max-width:120px; overflow:hidden; text-overflow:ellipsis;">{{ item.note }}</td>
                <td>
                    <form method="post" style="display:inline;">
                        {% csrf_token %}
                        <input type="hidden" name="step" value="delete_invoice_delivery">
                        <input type="hidden" name="invoice_delivery_id" value="{{ item.id }}">
                        <input type="hidden" name="search_type" value="{{ search_type }}">
                        <input type="hidden" name="search_value" value="{{ search_value }}">
                        <button type="submit" style="padding:4px 8px; background:#e74c3c; color:white; border:none; border-radius:4px;">åˆ é™¤</button>
                    </form>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    <div style="margin-top:10px;">
        <form method="post">
            {% csrf_token %}
            <input type="hidden" name="step" value="delete_all_invoice_delivery">
            <input type="hidden" name="search_type" value="{{ search_type }}">
            <input type="hidden" name="search_value" value="{{ search_value }}">
            <button type="submit" style="padding:6px 12px; background:#c0392b; color:white; border:none; border-radius:4px;">åˆ é™¤å…¨éƒ¨</button>
        </form>
    </div>
</div>
{% endif %}

<script>
setTimeout(() => {
    document.querySelectorAll('.message').forEach(m => m.style.display='none');
}, 5000);

// è¡¨æ ¼æœç´¢åŠŸèƒ½
document.addEventListener('DOMContentLoaded', function() {
    const input = document.getElementById('tableSearchInput');
    const table = document.querySelector('.data-table');
    if (!input || !table) return;

    input.addEventListener('input', function() {
        const filter = this.value.toLowerCase();
        const rows = table.tBodies[0].rows;

        Array.from(rows).forEach(row => {
            const cells = Array.from(row.cells);
            const match = cells.some(cell => cell.textContent.toLowerCase().includes(filter));
            row.style.display = match ? '' : 'none';
        });
    });
});
</script>
{% endblock %}
