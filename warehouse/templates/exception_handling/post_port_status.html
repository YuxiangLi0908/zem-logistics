{% extends 'base.html' %}

{% block content %}
<style>
    body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        color: #2c3e50;
    }

    .search-form {
        background: #34495e;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        color: white;
    }

    .search-input-group {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        align-items: center;
    }

    .search-input, .search-select {
        padding: 8px 12px;
        border-radius: 4px;
        border: none;
        font-size: 14px;
    }

    .search-input {
        min-width: 300px;
    }

    .search-select {
        min-width: 160px;
    }

    .search-btn {
        padding: 8px 16px;
        background-color: #27ae60;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s;
    }

    .search-btn:hover {
        background-color: #2ecc71;
    }

    .message {
        padding: 12px;
        border-radius: 4px;
        margin-bottom: 12px;
    }

    .message.success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }

    .message.error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }

    .message.warning {
        background: #fff3cd;
        color: #856404;
        border: 1px solid #ffeeba;
    }

    .data-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 15px;
    }

    .data-table th, .data-table td {
        border: 1px solid #bdc3c7;
        padding: 8px 10px;
        text-align: left;
        font-size: 13px;
    }

    .data-table th {
        background-color: #34495e;
        color: white;
        font-weight: 600;
    }

    .data-table tr:nth-child(even) {
        background-color: #ecf0f1;
    }

    .data-table tr:hover {
        background-color: #d0d7de;
    }

    .status-badge {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: 600;
        color: white;
    }

    .status-unknown { background-color: #95a5a6; }
    .status-scheduled { background-color: #3498db; }
    .status-shipped { background-color: #f39c12; }
    .status-arrived { background-color: #27ae60; }
    .status-pod_uploaded { background-color: #9b59b6; }

    .action-btn {
        padding: 4px 8px;
        border: none;
        border-radius: 4px;
        font-size: 12px;
        cursor: pointer;
        margin: 2px;
        transition: 0.2s;
    }

    .btn-primary { background: #3498db; color: white; }
    .btn-warning { background: #f39c12; color: white; }
    .btn-danger { background: #e74c3c; color: white; }
    .btn-success { background: #27ae60; color: white; }
    .btn-info { background: #17a2b8; color: white; }
    .btn-secondary { background: #6c757d; color: white; }

    .action-btn:hover {
        opacity: 0.8;
    }

    .no-results {
        padding: 20px;
        text-align: center;
        color: #7f8c8d;
        font-style: italic;
        border: 1px solid #bdc3c7;
        border-radius: 4px;
        margin-top: 15px;
    }

    .search-info {
        margin-bottom: 15px;
        padding: 10px;
        background: #f8f9fa;
        border-radius: 4px;
        border-left: 4px solid #3498db;
    }
</style>

<!-- æŸ¥è¯¢è¡¨å• -->
<div class="search-form">
    <form method="post">
        {% csrf_token %}
        <input type="hidden" name="step" value="search_shipment">
        <div class="search-input-group">
            <select name="search_type" class="search-select" required>
                <option value="batch" {% if search_type == 'batch' %}selected{% endif %}>æ‰¹æ¬¡å·æŸ¥è¯¢</option>
                <option value="appointment" {% if search_type == 'appointment' %}selected{% endif %}>é¢„çº¦å·æŸ¥è¯¢</option>
                <option value="fleet" {% if search_type == 'fleet' %}selected{% endif %}>è½¦æ¬¡å·æŸ¥è¯¢</option>
            </select>
            <input type="text" name="search_value" class="search-input"
                   placeholder="è¾“å…¥æŸ¥è¯¢å†…å®¹" value="{{ search_value|default:'' }}" required>
            <button type="submit" class="search-btn">æŸ¥è¯¢</button>
        </div>
    </form>
</div>

<!-- æ¶ˆæ¯æç¤º -->
{% if messages %}
    {% for message in messages %}
        <div class="message {% if message.tags %}{{ message.tags }}{% endif %}">
            {{ message }}
        </div>
    {% endfor %}
{% endif %}

<!-- æŸ¥è¯¢ç»“æœ -->
{% if shipments %}
<div class="search-info">
    <strong>æŸ¥è¯¢æ–¹å¼:</strong> 
    {% if search_type == 'batch' %}æ‰¹æ¬¡å·æŸ¥è¯¢
    {% elif search_type == 'appointment' %}é¢„çº¦å·æŸ¥è¯¢
    {% endif %}
    <strong>æŸ¥è¯¢å†…å®¹:</strong> {{ search_value }} | 
    <strong>æŸ¥è¯¢ç»“æœ:</strong> {{ shipments|length }} æ¡è®°å½•
</div>
{% endif %}

{% if fleet %}
<div class="search-info">
    è½¦æ¬¡æŸ¥è¯¢:
    <strong>æŸ¥è¯¢å†…å®¹:</strong> {{ search_value }} | 
    <strong>æŸ¥è¯¢ç»“æœ:</strong> {{ fleet|length }} æ¡è®°å½•
</div>
{% endif %}

{% if shipments %}
<table class="data-table">
    <thead>
        <tr>
            <th>ID</th>
            <th>é¢„çº¦æ‰¹æ¬¡å·</th>
            <th>é¢„çº¦å·</th>
            <th>å½“å‰çŠ¶æ€</th>
            <th>ç›®çš„åœ°</th>
            <th>ç»‘å®šè½¦æ¬¡</th>
            <th>ä¾›åº”å•†</th>
            <th>é¢„çº¦æ—¶é—´</th>
            <th>å‘è´§æ—¶é—´</th>
            <th>é€è¾¾æ—¶é—´</th>
            <th>status</th>
            <th>in_use</th>
            <th>å·²ç»å–æ¶ˆ</th>
            <th>PODé“¾æ¥</th>
            <th>æ“ä½œ</th>
        </tr>
    </thead>
    <tbody>
        {% for shipment in shipments %}
        <tr>
            <td>{{ shipment.id }}</td>
            <td>{{ shipment.shipment_batch_number|default:"-" }}</td>
            <td>{{ shipment.appointment_id|default:"-" }}</td>
            <td>
                <span class="status-badge status-{{ shipment.current_status }}">
                    {{ shipment.status_display }}
                </span>
            </td>
            <td>{{ shipment.destination|default:"-" }}</td>
            <td>{{ shipment.fleet_number}}</td>
            <td>{{ shipment.carrier|default:"-" }}</td>
            <td>{{ shipment.shipment_appointment|default:"-" }}</td>
            <td>{{ shipment.shipped_at|default:"-" }}</td>
            <td>{{ shipment.arrived_at|default:"-" }}</td>
            <td>{{ shipment.status }}</td>
            <td>
                <form method="post" style="display: inline-block; margin: 2px;">
                    {% csrf_token %}
                    <input type="hidden" name="step" value="update_shipment_in_use">
                    <input type="hidden" name="shipment_id" value="{{ shipment.id }}">
                    <input type="hidden" name="search_value" value="{{ search_value }}">
                    <input type="hidden" name="search_type" value="{{ search_type }}">
                    <select name="in_use" class="in-use-select" onchange="this.form.submit()">
                        <option value="true" {% if shipment.in_use %}selected{% endif %}>æ˜¯</option>
                        <option value="false" {% if not shipment.in_use %}selected{% endif %}>å¦</option>
                    </select>
                </form>
                
            </td>
            <td>
                <form method="post" style="display: inline-block; margin: 2px;">
                    {% csrf_token %}
                    <input type="hidden" name="step" value="update_shipment_is_canceled">
                    <input type="hidden" name="shipment_id" value="{{ shipment.id }}">
                    <input type="hidden" name="search_value" value="{{ search_value }}">
                    <input type="hidden" name="search_type" value="{{ search_type }}">
                    <select name="is_canceled" class="is-canceled-select" onchange="this.form.submit()">
                        <option value="true" {% if shipment.is_canceled %}selected{% endif %}>æ˜¯</option>
                        <option value="false" {% if not shipment.is_canceled %}selected{% endif %}>å¦</option>
                    </select>
                </form>
                
            </td>
            <td>
                {% if shipment.pod_link %}
                    <a href="{{ shipment.pod_link }}" target="_blank" 
                    style="color: #3498db; text-decoration: none; font-size: 12px;"
                    onmouseover="this.style.textDecoration='underline'" 
                    onmouseout="this.style.textDecoration='none'">
                        ğŸ“ æŸ¥çœ‹POD
                    </a>
                {% else %}
                    -
                {% endif %}
            </td>
            <td>
                {% for operation in shipment.available_operations %}
                <form method="post" style="display: inline-block; margin: 2px;">
                    {% csrf_token %}
                    <input type="hidden" name="step" value="update_shipment_status">
                    <input type="hidden" name="shipment_id" value="{{ shipment.id }}">
                    <input type="hidden" name="target_status" value="{{ operation.0 }}">
                    <input type="hidden" name="search_batch_number" value="{{ search_value }}">
                    <input type="hidden" name="search_type" value="{{ search_type }}">
                    <button type="submit" class="action-btn {{ operation.2 }}" 
                            onclick="return confirm('ç¡®å®šè¦æ‰§è¡Œæ­¤æ“ä½œå—ï¼Ÿ')">
                        {{ operation.1 }}
                    </button>
                </form>
                {% endfor %}
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% elif fleets %}
<table class="data-table">
    <thead>
        <tr>
            <th>ID</th>
            <th>è½¦æ¬¡å·</th>
            <th>Pickup Number</th>
            <th>è½¦æ¬¡ç±»å‹</th>
            <th>ä»“åº“</th>
            <th>Carrier</th>
            <th>å¸æœºå§“å</th>
            <th>å¸æœºç”µè¯</th>
            <th>Trailer Number</th>
            <th>å…³è”é¢„çº¦æ‰¹æ¬¡</th>
            <th>ä»“åº“å¤„ç†çŠ¶æ€</th>
            <th>é¢„è®¡æè´§æ—¶é—´</th>
            <th>æ€»æ¿æ•°</th>
            <th>æ€»ç®±æ•°</th>
            <th>Pre-load</th>
            <th>æ˜¯å¦å–æ¶ˆ</th>
        </tr>
    </thead>
    <tbody>
        {% for fleet in fleets %}
        <tr>
            <td>{{ fleet.id }}</td>
            <td>{{ fleet.fleet_number|default:"-" }}</td>
            <td>{{ fleet.pickup_number|default:"-" }}</td>
            <td>
                <form method="post" style="display: inline-block; margin: 2px;">
                    {% csrf_token %}
                    <input type="hidden" name="step" value="update_fleet_type">
                    <input type="hidden" name="fleet_id" value="{{ fleet.id }}">
                    <input type="hidden" name="search_value" value="{{ search_value }}">
                    <input type="hidden" name="search_type" value="{{ search_type }}">
                    <select name="fleet_type" class="fleet-type-select" onchange="this.form.submit()">
                        {% for key, value in shipment_type_options.items %}
                        <option value="{{ value }}" {% if fleet.fleet_type == value %}selected{% endif %}>{{ key }}</option>
                        {% endfor %}
                    </select>
                </form>
            </td>
            <td>
                <form method="post" style="display: inline-block; margin: 2px;">
                    {% csrf_token %}
                    <input type="hidden" name="step" value="update_fleet_origin">
                    <input type="hidden" name="fleet_id" value="{{ fleet.id }}">
                    <input type="hidden" name="search_value" value="{{ search_value }}">
                    <input type="hidden" name="search_type" value="{{ search_type }}">
                    <select name="origin" class="origin-select" onchange="this.form.submit()">
                        {% for key, value in warehouse_options.items %}
                        <option value="{{ value }}" {% if fleet.origin == value %}selected{% endif %}>{{ key }}</option>
                        {% endfor %}
                    </select>
                </form>
            </td>
            <td>{{ fleet.carrier|default:"-" }}</td>
            <td>{{ fleet.driver_name|default:"-" }}</td>
            <td>{{ fleet.driver_phone|default:"-" }}</td>
            <td>{{ fleet.trailer_number|default:"-" }}</td>
            <td>
                {% if fleet_sp %}
                    <div style="max-height: 100px; overflow-y: auto;">
                        {% for shipment in fleet_sp %}
                            <div style="margin: 2px 0; font-size: 12px;">
                                {{ shipment.shipment_batch_number }}
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    -
                {% endif %}
            </td>
            <td>
                <span class="status-badge status-{{ fleet.warehouse_process_status }}">
                    {{ fleet.get_warehouse_process_status_display }}
                </span>
            </td>
            <td>{{ fleet.appointment_datetime|default:"-" }}</td>
            <td>{{ fleet.total_pallet|default:"0" }}</td>
            <td>{{ fleet.total_pcs|default:"0" }}</td>
            <td>{{ fleet.pre_load|default:"-" }}</td>
            <td>
                <form method="post" style="display: inline-block; margin: 2px;">
                    {% csrf_token %}
                    <input type="hidden" name="step" value="update_fleet_is_canceled">
                    <input type="hidden" name="fleet_id" value="{{ fleet.id }}">
                    <input type="hidden" name="search_value" value="{{ search_value }}">
                    <input type="hidden" name="search_type" value="{{ search_type }}">
                    <select name="is_canceled" class="is-canceled-select" onchange="this.form.submit()">
                        <option value="true" {% if fleet.is_canceled %}selected{% endif %}>æ˜¯</option>
                        <option value="false" {% if not fleet.is_canceled %}selected{% endif %}>å¦</option>
                    </select>
                </form>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% elif search_value and not shipments %}
<div class="no-results">
    æœªæ‰¾åˆ°ç›¸å…³æ•°æ®
</div>
{% endif %}

<script>
// è‡ªåŠ¨éšè—æ¶ˆæ¯æç¤º
setTimeout(() => {
    document.querySelectorAll('.message').forEach(m => m.style.display='none');
}, 5000);
</script>
{% endblock %}