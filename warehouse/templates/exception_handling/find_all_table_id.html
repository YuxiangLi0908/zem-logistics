{% extends 'base.html' %}

{% block content %}
<style>
    body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        color: #2c3e50;
    }

    .page-title {
        background: #34495e;
        color: white;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
    }

    .page-title h2 {
        margin: 0;
        font-size: 24px;
    }

    .page-title p {
        margin: 5px 0 0 0;
        opacity: 0.9;
        font-size: 14px;
    }

    .search-form {
        background: #ecf0f1;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
    }

    .search-input-group {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        align-items: center;
    }

    .search-select {
        padding: 8px 12px;
        border-radius: 4px;
        border: 1px solid #bdc3c7;
        font-size: 14px;
        min-width: 200px;
    }

    .search-input {
        padding: 8px 12px;
        border-radius: 4px;
        border: 1px solid #bdc3c7;
        font-size: 14px;
        min-width: 300px;
    }

    .search-btn {
        padding: 8px 16px;
        background-color: #27ae60;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s;
    }

    .search-btn:hover {
        background-color: #2ecc71;
    }

    .message {
        padding: 12px;
        border-radius: 4px;
        margin-bottom: 12px;
    }

    .message.success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }

    .message.error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }

    .data-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 15px;
        font-size: 12px;
    }

    .data-table th, .data-table td {
        border: 1px solid #bdc3c7;
        padding: 6px 8px;
        text-align: left;
        max-width: 300px;
        word-wrap: break-word;
    }

    .data-table th {
        background-color: #34495e;
        color: white;
        font-weight: 600;
        position: sticky;
        top: 0;
    }

    .data-table tr:nth-child(even) {
        background-color: #f8f9fa;
    }

    .data-table tr:hover {
        background-color: #e9ecef;
    }

    .field-name {
        font-weight: bold;
        color: #2c3e50;
        min-width: 150px;
    }

    .field-value {
        color: #34495e;
    }

    .no-results {
        padding: 20px;
        text-align: center;
        color: #7f8c8d;
        font-style: italic;
        border: 1px solid #bdc3c7;
        border-radius: 4px;
        margin-top: 15px;
    }

    .search-info {
        margin-bottom: 15px;
        padding: 10px;
        background: #f8f9fa;
        border-radius: 4px;
        border-left: 4px solid #3498db;
        font-size: 14px;
    }

    .query-hint {
        font-size: 12px;
        color: #7f8c8d;
        margin-top: 5px;
    }
    h2 {
        text-align: center;
        margin-bottom: 20px;
        background: linear-gradient(45deg, #ff6b6b, #4ecdc4, #45b7d1, #96ceb4, #feca57);
        background-size: 400% 400%;
        -webkit-background-clip: text;
        background-clip: text;
        -webkit-text-fill-color: transparent;
        animation: gradient 3s ease infinite;
        font-weight: bold;
    }
    .table-filter {
        margin-bottom: 15px;
        padding: 12px 15px;
        background: linear-gradient(135deg, #f5f7fa 0%, #e4e8f0 100%);
        border-radius: 8px;
        border: 1px solid #d1d9e6;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    .filter-input-group {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        align-items: center;
    }

    .filter-input {
        flex: 0 1 200px; /* å›ºå®šå®½åº¦ */
        min-width: 160px;
        max-width: 200px;
        padding: 8px 12px;
        border: 1px solid #c8d0e7;
        border-radius: 6px;
        font-size: 13px;
        background: white;
        transition: all 0.3s;
        box-shadow: inset 0 1px 2px rgba(0,0,0,0.07);
    }

    .filter-input:focus {
        outline: none;
        border-color: #3498db;
        box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.15);
    }

    .filter-btn {
        padding: 8px 16px;
        background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
        font-size: 13px;
        transition: all 0.3s;
        box-shadow: 0 2px 4px rgba(52, 152, 219, 0.2);
        display: flex;
        align-items: center;
        gap: 5px;
    }

    .filter-btn:hover {
        background: linear-gradient(135deg, #2980b9 0%, #2471a3 100%);
        transform: translateY(-1px);
        box-shadow: 0 3px 6px rgba(52, 152, 219, 0.25);
    }

    .filter-btn-clear {
        background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%);
        box-shadow: 0 2px 4px rgba(149, 165, 166, 0.2);
    }

    .filter-btn-clear:hover {
        background: linear-gradient(135deg, #7f8c8d 0%, #707b7c 100%);
        box-shadow: 0 3px 6px rgba(149, 165, 166, 0.25);
    }

    .filter-hint {
        margin-top: 8px;
        font-size: 12px;
        color: #5d6d7e;
        font-style: italic;
    }

    /* é«˜äº®æœç´¢åŒ¹é…çš„æ–‡æœ¬ */
    .highlight {
        background-color: #ffeaa7;
        padding: 1px 4px;
        border-radius: 3px;
        font-weight: 600;
        color: #2d3436;
    }

    /* è¿‡æ»¤ç»“æœæç¤º */
    .filter-result {
        margin-left: 10px;
        padding: 4px 8px;
        background: #e8f4fc;
        border-radius: 4px;
        font-size: 12px;
        color: #2980b9;
        font-weight: 600;
    }
    @keyframes gradient {
        0% { background-position: 0% 50%; }
        50% { background-position: 100% 50%; }
        100% { background-position: 0% 50%; }
    }
</style>

<!-- é¡µé¢æ ‡é¢˜ -->
<h2> ç»Ÿä¸€æ•°æ®è¡¨æŸ¥è¯¢</h2>
<div class="page-title"> 
    <p>é€šè¿‡IDæˆ–å…¶ä»–å­—æ®µæŸ¥è¯¢æ‰€æœ‰è¡¨çš„æ•°æ®è®°å½• - æ”¯æŒå¤šè¡¨å¤šå­—æ®µæŸ¥è¯¢</p>
</div>

<!-- æŸ¥è¯¢è¡¨å• -->
<div class="search-form">
    <form method="post">
        {% csrf_token %}
        <input type="hidden" name="step" value="search_data">
        <div class="search-input-group">
            <select name="table_name" class="search-select" required>
                <option value="">é€‰æ‹©æ•°æ®è¡¨</option>
                <option value="Container" {% if table_name == 'Container' %}selected{% endif %}>Container - è´§æŸœä¿¡æ¯</option>
                <option value="Customer" {% if table_name == 'Customer' %}selected{% endif %}>Customer - å®¢æˆ·ä¿¡æ¯</option>
                <option value="FeeDetail" {% if table_name == 'FeeDetail' %}selected{% endif %}>FeeDetail - è´¹ç”¨è¯¦æƒ…</option>
                <option value="FleetShipmentPallet" {% if table_name == 'FleetShipmentPallet' %}selected{% endif %}>FleetShipmentPallet - è½¦æ¬¡è´§ç›˜</option>
                <option value="Fleet" {% if table_name == 'Fleet' %}selected{% endif %}>Fleet - è½¦æ¬¡ä¿¡æ¯</option>
                <option value="InvoicePreport" {% if table_name == 'InvoicePreport' %}selected{% endif %}>InvoicePreport - å‘ç¥¨æ¸¯å‰</option>
                <option value="InvoiceWarehouse" {% if table_name == 'InvoiceWarehouse' %}selected{% endif %}>InvoiceWarehouse - å‘ç¥¨ä»“åº“</option>
                <option value="InvoiceDelivery" {% if table_name == 'InvoiceDelivery' %}selected{% endif %}>InvoiceDelivery - å‘ç¥¨æ´¾é€</option>
                <option value="Invoice" {% if table_name == 'Invoice' %}selected{% endif %}>Invoice - å‘ç¥¨ä¸»è¡¨</option>
                <option value="InvoiceStatus" {% if table_name == 'InvoiceStatus' %}selected{% endif %}>InvoiceStatus - å‘ç¥¨çŠ¶æ€</option>
                <option value="Invoice" {% if table_name == 'Invoicev2' %}selected{% endif %}>Invoicev2 - å‘ç¥¨ä¸»è¡¨</option>
                <option value="InvoiceStatus" {% if table_name == 'InvoiceStatusv2' %}selected{% endif %}>InvoiceStatusv2 - å‘ç¥¨çŠ¶æ€</option>
                <option value="AbnormalOffloadStatus" {% if table_name == 'AbnormalOffloadStatus' %}selected{% endif %}>AbnormalOffloadStatus - å¼‚å¸¸å¸è´§çŠ¶æ€</option>
                <option value="Order" {% if table_name == 'Order' %}selected{% endif %}>Order - è®¢å•ä¿¡æ¯</option>
                <option value="PackingList" {% if table_name == 'PackingList' %}selected{% endif %}>PackingList - è£…ç®±å•</option>
                <option value="PalletDestroyed" {% if table_name == 'PalletDestroyed' %}selected{% endif %}>PalletDestroyed - é”€æ¯æ‰˜ç›˜</option>
                <option value="Pallet" {% if table_name == 'Pallet' %}selected{% endif %}>Pallet - æ‰˜ç›˜ä¿¡æ¯</option>
                <option value="Historicalpallet" {% if table_name == 'Historicalpallet' %}selected{% endif %}>Historicalpallet - å†å²æ‰˜ç›˜ä¿¡æ¯</option>
                <option value="PoCheckEtaSeven" {% if table_name == 'PoCheckEtaSeven' %}selected{% endif %}>PoCheckEtaSeven - POæŸ¥éªŒ</option>
                <option value="QuotationMaster" {% if table_name == 'QuotationMaster' %}selected{% endif %}>QuotationMaster - æŠ¥ä»·ä¸»è¡¨</option>
                <option value="TransferLocation" {% if table_name == 'TransferLocation' %}selected{% endif %}>TransferLocation - è½¬è¿ä½ç½®</option>
                <option value="Vessel" {% if table_name == 'Vessel' %}selected{% endif %}>Vessel - èˆ¹è¿ä¿¡æ¯</option>
            </select>

            <select name="search_field" class="search-select" required id="search_field_select">
                <option value="">é€‰æ‹©æŸ¥è¯¢å­—æ®µ</option>
                <!-- é€‰é¡¹ä¼šæ ¹æ®é€‰æ‹©çš„è¡¨åŠ¨æ€æ›´æ–° -->
                {% for field in available_fields %}
                <option value="{{ field.0 }}" 
                        {% if search_field == field.0 or default_search_field == field.0 %}selected{% endif %}>
                    {{ field.1 }}
                </option>
                {% endfor %}
            </select>

            <input type="text" name="search_value" class="search-input"
                   placeholder="è¾“å…¥æŸ¥è¯¢å€¼" value="{{ search_value|default:'' }}" required>
            
            <button type="submit" class="search-btn">æŸ¥è¯¢</button>
        </div>
        <div class="query-hint" id="query-hint">
            {% if table_name %}
            å½“å‰è¡¨æ”¯æŒæŸ¥è¯¢å­—æ®µ: 
            {% for field in available_fields %}
            <span style="margin-right: 10px;">{{ field.1 }}</span>
            {% endfor %}
            {% endif %}
        </div>
    </form>
</div>

<!-- æ¶ˆæ¯æç¤º -->
{% if messages %}
    {% for message in messages %}
        <div class="message {% if message.tags %}{{ message.tags }}{% endif %}">
            {{ message }}
        </div>
    {% endfor %}
{% endif %}

<!-- æŸ¥è¯¢ç»“æœ -->
{% if search_info %}
    <div class="search-info">
        <strong>æŸ¥è¯¢è¡¨:</strong> {{ table_name }} | 
        <strong>æŸ¥è¯¢å­—æ®µ:</strong> {{ search_field }} | 
        <strong>æŸ¥è¯¢å€¼:</strong> {{ search_value }} | 
        <strong>æŸ¥è¯¢ç»“æœ:</strong> {{ record_count }} æ¡è®°å½•
    </div>
{% endif %}

{% if records_list %}
    <div class="table-filter">
    <div class="filter-input-group">
        <input type="text" id="filter-input-1" class="filter-input" 
               placeholder="æœç´¢å…³é”®è¯1" title="è¾“å…¥ç¬¬ä¸€ä¸ªæœç´¢å…³é”®è¯">
        <input type="text" id="filter-input-2" class="filter-input" 
               placeholder="æœç´¢å…³é”®è¯2" title="è¾“å…¥ç¬¬äºŒä¸ªæœç´¢å…³é”®è¯">
        <button type="button" id="filter-btn" class="filter-btn">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
            </svg>
            è¿‡æ»¤
        </button>
        <button type="button" id="clear-filter-btn" class="filter-btn filter-btn-clear">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 18L18 6M6 6l12 12"></path>
            </svg>
                æ¸…é™¤
            </button>
            <span id="filter-result" class="filter-result"></span>
        </div>
        <div class="filter-hint">
            ğŸ“Œ åŒæ¡ä»¶æœç´¢ï¼šä¸¤ä¸ªæœç´¢æ¡†æ˜¯"ä¸"å…³ç³»ï¼Œè¡Œå¿…é¡»åŒæ—¶åŒ…å«ä¸¤ä¸ªå…³é”®è¯æ‰ä¼šæ˜¾ç¤ºï¼ˆä¸åŒºåˆ†å¤§å°å†™ï¼‰
        </div>
    </div>
    <!-- æ˜¾ç¤ºæ‰€æœ‰è®°å½•çš„è¡¨æ ¼ -->
    <div style="overflow-x: auto; max-height: 600px;">
        <table class="data-table">
            <thead>
                <tr>
                    <th style="width: 50px;">#</th>
                    {% for field in records_list.0.keys %}
                    <th>{{ field }}</th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                {% for record in records_list %}
                <tr>
                    <td style="text-align: center; font-weight: bold;">{{ forloop.counter }}</td>
                    {% for field, value in record.items %}
                    <td class="field-value">
                        {% if value == None %}
                            <span style="color: #95a5a6; font-style: italic;">null</span>
                        {% elif value == True %}
                            <span style="color: #27ae60;">True</span>
                        {% elif value == False %}
                            <span style="color: #e74c3c;">False</span>
                        {% else %}
                            {{ value|default:""|truncatechars:50 }}
                        {% endif %}
                    </td>
                    {% endfor %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    {% elif search_value and not records_list %}
    <div class="no-results">
        æœªæ‰¾åˆ°ç›¸å…³æ•°æ®
    </div>
{% endif %}

<script>
    // åŠ¨æ€æ›´æ–°æŸ¥è¯¢å­—æ®µé€‰é¡¹
    document.querySelector('select[name="table_name"]').addEventListener('change', function() {
        const tableName = this.value;
        const searchFieldSelect = document.querySelector('select[name="search_field"]');
        const queryHint = document.getElementById('query-hint');
        
        // æ¸…ç©ºç°æœ‰é€‰é¡¹
        searchFieldSelect.innerHTML = '<option value="">é€‰æ‹©æŸ¥è¯¢å­—æ®µ</option>';
        queryHint.innerHTML = '';
        
        if (tableName) {
            // æ ¹æ®é€‰æ‹©çš„è¡¨è®¾ç½®å¯æŸ¥è¯¢å­—æ®µ
            const fieldOptions = getFieldOptions(tableName);
            
            // è®¾ç½®é»˜è®¤é€‰ä¸­å­—æ®µï¼ˆä¼˜å…ˆcontainer_numberï¼Œå¦åˆ™ç¬¬ä¸€ä¸ªå­—æ®µï¼‰
            let defaultField = '';
            if (fieldOptions.some(field => field[0] === 'container_number')) {
                defaultField = 'container_number';
            } else if (fieldOptions.length > 0) {
                defaultField = fieldOptions[0][0];
            }
            
            fieldOptions.forEach(field => {
                const option = document.createElement('option');
                option.value = field[0];
                option.textContent = field[1];
                if (field[0] === defaultField) {
                    option.selected = true;
                }
                searchFieldSelect.appendChild(option);
            });
            
            // æ›´æ–°æŸ¥è¯¢æç¤º
            queryHint.innerHTML = `å½“å‰è¡¨æ”¯æŒæŸ¥è¯¢å­—æ®µ: ${fieldOptions.map(f => f[1]).join(', ')}`;
            
            // å¦‚æœæœ‰é»˜è®¤å­—æ®µï¼Œè‡ªåŠ¨èšç„¦åˆ°æŸ¥è¯¢å€¼è¾“å…¥æ¡†
            if (defaultField) {
                document.querySelector('input[name="search_value"]').focus();
            }
        }
    });

    function getFieldOptions(tableName) {
        const fieldMap = {
            'Container': [
                ['id', 'ID'],
                ['container_number', 'æŸœå·']
            ],
            'Customer': [
                ['id', 'ID'], 
                ['zem_name', 'å®¢æˆ·åç§°']
            ],
            'FeeDetail': [
                ['id', 'ID'],
                ['quotation_id', 'æŠ¥ä»·ID']
            ],
            'FleetShipmentPallet': [
                ['id', 'ID'],
                ['fleet_number', 'è½¦é˜Ÿç¼–å·'],
                ['pickup_number', 'æè´§å·'],
                ['shipment_batch_number', 'å‘è´§æ‰¹æ¬¡å·']
            ],
            'Fleet': [
                ['id', 'ID'],
                ['fleet_number', 'è½¦é˜Ÿç¼–å·'],
                ['pickup_number', 'æè´§å·']
            ],
            'InvoicePreport': [
                ['id', 'ID'],
                ['invoice_number', 'å‘ç¥¨å·ç ']
            ],
            'InvoiceWarehouse': [
                ['id', 'ID'],
                ['invoice_number', 'å‘ç¥¨å·ç ']
            ],
            'InvoiceDelivery': [
                ['id', 'ID'],
                ['invoice_number', 'å‘ç¥¨å·ç ']
            ],
            'Invoice': [
                ['id', 'ID'],
                ['invoice_number', 'å‘ç¥¨å·ç '],
                ['container_number', 'æŸœå·']
            ],
            'InvoiceStatus': [
                ['id', 'ID'],
                ['container_number', 'æŸœå·']
            ],
            'AbnormalOffloadStatus': [
                ['id', 'ID'],
                ['container_number', 'æŸœå·']
            ],
            'Order': [
                ['id', 'ID'],
                ['container_number', 'æŸœå·']
            ],
            'PackingList': [
                ['id', 'ID'],
                ['container_number', 'æŸœå·'],
                ['PO_ID', 'POç¼–å·']
            ],
            'PalletDestroyed': [
                ['id', 'ID'],
                ['container_number', 'æŸœå·']
            ],
            'Pallet': [
                ['id', 'ID'],
                ['container_number', 'æŸœå·'],
                ['PO_ID', 'POç¼–å·'],
                ['slot', 'æ§½ä½']
            ],
            'Historicalpallet':[
                ['id', 'ID'],
                ['container_number', 'æŸœå·'],
                ['PO_ID', 'POç¼–å·'],
                ['slot', 'æ§½ä½']
            ],
            'PoCheckEtaSeven': [
                ['id', 'ID'],
                ['container_number', 'æŸœå·']
            ],
            'QuotationMaster': [
                ['id', 'ID'],
                ['exclusive_user', 'ä¸“å±ç”¨æˆ·'],
                ['quote_type', 'æŠ¥ä»·ç±»å‹']
            ],
            'TransferLocation': [
                ['id', 'ID'],
                ['fleet_number', 'è½¦é˜Ÿç¼–å·'],
                ['container_number', 'æŸœå·']
            ],
            'Vessel': [
                ['id', 'ID'],
                ['vessel', 'èˆ¹å']
            ]
        };
        
        return fieldMap[tableName] || [['id', 'ID']];
    }

    // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
        const tableSelect = document.querySelector('select[name="table_name"]');
        // å¦‚æœæ²¡æœ‰é€‰æ‹©è¡¨ï¼Œé»˜è®¤é€‰æ‹©Container
        if (!tableSelect.value) {
            tableSelect.value = 'Container';
        }
        tableSelect.dispatchEvent(new Event('change'));
    });
    // è®°å½•åˆ‡æ¢åŠŸèƒ½
    function switchRecord() {
        const navigator = document.getElementById('recordNavigator');
        const recordIndex = navigator.value;
        // è¿™é‡Œå¯ä»¥é€šè¿‡AJAXåŠ è½½å…¶ä»–è®°å½•ï¼Œæˆ–è€…åœ¨å‰ç«¯å­˜å‚¨æ‰€æœ‰è®°å½•æ•°æ®
        alert(`åˆ‡æ¢åˆ°è®°å½• ${parseInt(recordIndex) + 1}ï¼Œéœ€è¦åç«¯æ”¯æŒåŠ è½½ç‰¹å®šè®°å½•`);
    }
    document.addEventListener('DOMContentLoaded', function() {
        const filterInput1 = document.getElementById('filter-input-1');
        const filterInput2 = document.getElementById('filter-input-2');
        const filterBtn = document.getElementById('filter-btn');
        const clearFilterBtn = document.getElementById('clear-filter-btn');
        
        if (filterBtn) {
            filterBtn.addEventListener('click', filterTable);
            clearFilterBtn.addEventListener('click', clearFilter);
            
            // æ·»åŠ å›è½¦é”®æ”¯æŒ
            filterInput1.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') filterTable();
            });
            
            filterInput2.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') filterTable();
            });
        }
        
        function filterTable() {
            const value1 = filterInput1.value.trim().toLowerCase();
            const value2 = filterInput2.value.trim().toLowerCase();
            
            // å¦‚æœä¸¤ä¸ªéƒ½ä¸ºç©ºï¼Œæ˜¾ç¤ºæ‰€æœ‰è¡Œ
            if (!value1 && !value2) {
                clearFilter();
                return;
            }
            
            const tableRows = document.querySelectorAll('.data-table tbody tr');
            let visibleCount = 0;
            
            tableRows.forEach(row => {
                const rowText = row.textContent.toLowerCase();
                let shouldShow = true;
                
                // æ£€æŸ¥æ˜¯å¦åŒæ—¶åŒ…å«ä¸¤ä¸ªæœç´¢å€¼ï¼ˆä¸å…³ç³»ï¼‰
                if (value1 && !rowText.includes(value1)) {
                    shouldShow = false;
                }
                if (value2 && !rowText.includes(value2)) {
                    shouldShow = false;
                }
                
                // æ˜¾ç¤ºæˆ–éšè—è¡Œ
                row.style.display = shouldShow ? '' : 'none';
                if (shouldShow) {
                    visibleCount++;
                    
                    // é«˜äº®æ˜¾ç¤ºåŒ¹é…çš„æ–‡æœ¬
                    if (value1 || value2) {
                        highlightRow(row, value1, value2);
                    }
                }
            });
            
            // æ›´æ–°ç»“æœè®¡æ•°
            updateVisibleCount(visibleCount);
        }
        
        function highlightRow(row, value1, value2) {
            const cells = row.querySelectorAll('td');
            cells.forEach(cell => {
                let html = cell.innerHTML;
                let originalHtml = cell.getAttribute('data-original') || html;
                cell.setAttribute('data-original', originalHtml);
                
                // æ¢å¤åŸå§‹å†…å®¹
                html = originalHtml;
                
                // é«˜äº®ç¬¬ä¸€ä¸ªæœç´¢å€¼
                if (value1) {
                    const regex1 = new RegExp(`(${escapeRegExp(value1)})`, 'gi');
                    html = html.replace(regex1, '<span class="highlight">$1</span>');
                }
                
                // é«˜äº®ç¬¬äºŒä¸ªæœç´¢å€¼ï¼ˆå¦‚æœæœ‰ï¼‰
                if (value2) {
                    const regex2 = new RegExp(`(${escapeRegExp(value2)})`, 'gi');
                    html = html.replace(regex2, '<span class="highlight">$1</span>');
                }
                
                cell.innerHTML = html;
            });
        }
        
        function clearHighlight() {
            const cells = document.querySelectorAll('.data-table td[data-original]');
            cells.forEach(cell => {
                cell.innerHTML = cell.getAttribute('data-original');
            });
        }
        
        function clearFilter() {
            filterInput1.value = '';
            filterInput2.value = '';
            
            // æ˜¾ç¤ºæ‰€æœ‰è¡Œ
            const tableRows = document.querySelectorAll('.data-table tbody tr');
            tableRows.forEach(row => {
                row.style.display = '';
            });
            
            // æ¸…é™¤é«˜äº®
            clearHighlight();
            
            // æ¸…ç©ºè¿‡æ»¤ç»“æœæç¤º
            document.getElementById('filter-result').textContent = '';
            
            // æ¢å¤åŸå§‹è®¡æ•°
            const recordCount = {{ record_count|default:0 }};
            updateVisibleCount(recordCount);
        }
        function updateVisibleCount(count) {
            const filterResult = document.getElementById('filter-result');
            const recordCount = {{ record_count|default:0 }};
            
            if (count === recordCount || count === tableRows.length) {
                filterResult.textContent = '';
            } else {
                filterResult.textContent = `æ˜¾ç¤º ${count} / ${recordCount} æ¡`;
            }
            
            // åŒæ—¶æ›´æ–°æœç´¢ä¿¡æ¯ä¸­çš„è®¡æ•°
            const searchInfo = document.querySelector('.search-info');
            if (searchInfo) {
                const originalText = searchInfo.textContent;
                if (count === recordCount) {
                    // æ¢å¤åŸå§‹æ–‡æœ¬
                    const match = originalText.match(/æŸ¥è¯¢ç»“æœ: (\d+) æ¡è®°å½•/);
                    if (match) {
                        searchInfo.textContent = originalText.replace(
                            /æŸ¥è¯¢ç»“æœ: (\d+) æ¡è®°å½•.*/,
                            `æŸ¥è¯¢ç»“æœ: ${match[1]} æ¡è®°å½•`
                        );
                    }
                } else {
                    searchInfo.textContent = originalText.replace(
                        /æŸ¥è¯¢ç»“æœ: (\d+) æ¡è®°å½•.*/,
                        `æŸ¥è¯¢ç»“æœ: ${recordCount} æ¡è®°å½• (è¿‡æ»¤å: ${count} æ¡)`
                    );
                }
            }
        }
        
        function escapeRegExp(string) {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }
    });
</script>
{% endblock %}