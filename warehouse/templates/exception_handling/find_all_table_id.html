{% extends 'base.html' %}

{% block content %}
<style>
    body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        color: #2c3e50;
    }

    .page-title {
        background: #34495e;
        color: white;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
    }

    .page-title h2 {
        margin: 0;
        font-size: 24px;
    }

    .page-title p {
        margin: 5px 0 0 0;
        opacity: 0.9;
        font-size: 14px;
    }

    .search-form {
        background: #ecf0f1;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
    }

    .search-input-group {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        align-items: center;
    }

    .search-select {
        padding: 8px 12px;
        border-radius: 4px;
        border: 1px solid #bdc3c7;
        font-size: 14px;
        min-width: 200px;
    }

    .search-input {
        padding: 8px 12px;
        border-radius: 4px;
        border: 1px solid #bdc3c7;
        font-size: 14px;
        min-width: 300px;
    }

    .search-btn {
        padding: 8px 16px;
        background-color: #27ae60;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s;
    }

    .search-btn:hover {
        background-color: #2ecc71;
    }

    .message {
        padding: 12px;
        border-radius: 4px;
        margin-bottom: 12px;
    }

    .message.success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }

    .message.error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }

    .data-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 15px;
        font-size: 12px;
    }

    .data-table th, .data-table td {
        border: 1px solid #bdc3c7;
        padding: 6px 8px;
        text-align: left;
        max-width: 300px;
        word-wrap: break-word;
    }

    .data-table th {
        background-color: #34495e;
        color: white;
        font-weight: 600;
        position: sticky;
        top: 0;
    }

    .data-table tr:nth-child(even) {
        background-color: #f8f9fa;
    }

    .data-table tr:hover {
        background-color: #e9ecef;
    }

    .field-name {
        font-weight: bold;
        color: #2c3e50;
        min-width: 150px;
    }

    .field-value {
        color: #34495e;
    }

    .no-results {
        padding: 20px;
        text-align: center;
        color: #7f8c8d;
        font-style: italic;
        border: 1px solid #bdc3c7;
        border-radius: 4px;
        margin-top: 15px;
    }

    .search-info {
        margin-bottom: 15px;
        padding: 10px;
        background: #f8f9fa;
        border-radius: 4px;
        border-left: 4px solid #3498db;
        font-size: 14px;
    }

    .query-hint {
        font-size: 12px;
        color: #7f8c8d;
        margin-top: 5px;
    }
</style>

<!-- é¡µé¢æ ‡é¢˜ -->
<div class="page-title">
    <h2>ğŸ” ç»Ÿä¸€æ•°æ®æŸ¥è¯¢ç³»ç»Ÿ</h2>
    <p>é€šè¿‡IDæˆ–å…¶ä»–å­—æ®µæŸ¥è¯¢æ‰€æœ‰è¡¨çš„æ•°æ®è®°å½• - æ”¯æŒå¤šè¡¨å¤šå­—æ®µæŸ¥è¯¢</p>
</div>

<!-- æŸ¥è¯¢è¡¨å• -->
<div class="search-form">
    <form method="post">
        {% csrf_token %}
        <input type="hidden" name="step" value="search_data">
        <div class="search-input-group">
            <select name="table_name" class="search-select" required>
                <option value="">é€‰æ‹©æ•°æ®è¡¨</option>
                <option value="Container" {% if table_name == 'Container' %}selected{% endif %}>Container - è´§æŸœä¿¡æ¯</option>
                <option value="Customer" {% if table_name == 'Customer' %}selected{% endif %}>Customer - å®¢æˆ·ä¿¡æ¯</option>
                <option value="FeeDetail" {% if table_name == 'FeeDetail' %}selected{% endif %}>FeeDetail - è´¹ç”¨è¯¦æƒ…</option>
                <option value="FleetShipmentPallet" {% if table_name == 'FleetShipmentPallet' %}selected{% endif %}>FleetShipmentPallet - è½¦æ¬¡è´§ç›˜</option>
                <option value="Fleet" {% if table_name == 'Fleet' %}selected{% endif %}>Fleet - è½¦æ¬¡ä¿¡æ¯</option>
                <option value="InvoicePreport" {% if table_name == 'InvoicePreport' %}selected{% endif %}>InvoicePreport - å‘ç¥¨æ¸¯å‰</option>
                <option value="InvoiceWarehouse" {% if table_name == 'InvoiceWarehouse' %}selected{% endif %}>InvoiceWarehouse - å‘ç¥¨ä»“åº“</option>
                <option value="InvoiceDelivery" {% if table_name == 'InvoiceDelivery' %}selected{% endif %}>InvoiceDelivery - å‘ç¥¨æ´¾é€</option>
                <option value="Invoice" {% if table_name == 'Invoice' %}selected{% endif %}>Invoice - å‘ç¥¨ä¸»è¡¨</option>
                <option value="InvoiceStatus" {% if table_name == 'InvoiceStatus' %}selected{% endif %}>InvoiceStatus - å‘ç¥¨çŠ¶æ€</option>
                <option value="AbnormalOffloadStatus" {% if table_name == 'AbnormalOffloadStatus' %}selected{% endif %}>AbnormalOffloadStatus - å¼‚å¸¸å¸è´§çŠ¶æ€</option>
                <option value="Order" {% if table_name == 'Order' %}selected{% endif %}>Order - è®¢å•ä¿¡æ¯</option>
                <option value="PackingList" {% if table_name == 'PackingList' %}selected{% endif %}>PackingList - è£…ç®±å•</option>
                <option value="PalletDestroyed" {% if table_name == 'PalletDestroyed' %}selected{% endif %}>PalletDestroyed - é”€æ¯æ‰˜ç›˜</option>
                <option value="Pallet" {% if table_name == 'Pallet' %}selected{% endif %}>Pallet - æ‰˜ç›˜ä¿¡æ¯</option>
                <option value="PoCheckEtaSeven" {% if table_name == 'PoCheckEtaSeven' %}selected{% endif %}>PoCheckEtaSeven - POæŸ¥éªŒ</option>
                <option value="QuotationMaster" {% if table_name == 'QuotationMaster' %}selected{% endif %}>QuotationMaster - æŠ¥ä»·ä¸»è¡¨</option>
                <option value="TransferLocation" {% if table_name == 'TransferLocation' %}selected{% endif %}>TransferLocation - è½¬è¿ä½ç½®</option>
                <option value="Vessel" {% if table_name == 'Vessel' %}selected{% endif %}>Vessel - èˆ¹è¿ä¿¡æ¯</option>
            </select>

            <select name="search_field" class="search-select" required id="search_field_select">
                <option value="">é€‰æ‹©æŸ¥è¯¢å­—æ®µ</option>
                <!-- é€‰é¡¹ä¼šæ ¹æ®é€‰æ‹©çš„è¡¨åŠ¨æ€æ›´æ–° -->
                {% for field in available_fields %}
                <option value="{{ field.0 }}" 
                        {% if search_field == field.0 or default_search_field == field.0 %}selected{% endif %}>
                    {{ field.1 }}
                </option>
                {% endfor %}
            </select>

            <input type="text" name="search_value" class="search-input"
                   placeholder="è¾“å…¥æŸ¥è¯¢å€¼" value="{{ search_value|default:'' }}" required>
            
            <button type="submit" class="search-btn">æŸ¥è¯¢</button>
        </div>
        <div class="query-hint" id="query-hint">
            {% if table_name %}
            å½“å‰è¡¨æ”¯æŒæŸ¥è¯¢å­—æ®µ: 
            {% for field in available_fields %}
            <span style="margin-right: 10px;">{{ field.1 }}</span>
            {% endfor %}
            {% endif %}
        </div>
    </form>
</div>

<!-- æ¶ˆæ¯æç¤º -->
{% if messages %}
    {% for message in messages %}
        <div class="message {% if message.tags %}{{ message.tags }}{% endif %}">
            {{ message }}
        </div>
    {% endfor %}
{% endif %}

<!-- æŸ¥è¯¢ç»“æœ -->
{% if search_info %}
<div class="search-info">
    <strong>æŸ¥è¯¢è¡¨:</strong> {{ table_name }} | 
    <strong>æŸ¥è¯¢å­—æ®µ:</strong> {{ search_field }} | 
    <strong>æŸ¥è¯¢å€¼:</strong> {{ search_value }} | 
    <strong>æŸ¥è¯¢ç»“æœ:</strong> {{ record_count }} æ¡è®°å½•
</div>
{% endif %}

{% if record_data %}
<div style="overflow-x: auto; max-height: 600px;">
    <table class="data-table">
        <thead>
            <tr>
                <th style="width: 200px;">å­—æ®µå</th>
                <th>å­—æ®µå€¼</th>
            </tr>
        </thead>
        <tbody>
            {% for field, value in record_data.items %}
            <tr>
                <td class="field-name">{{ field }}</td>
                <td class="field-value">
                    {% if value == None %}
                        <span style="color: #95a5a6; font-style: italic;">null</span>
                    {% elif value == True %}
                        <span style="color: #27ae60;">True</span>
                    {% elif value == False %}
                        <span style="color: #e74c3c;">False</span>
                    {% else %}
                        {{ value|default:"" }}
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% elif search_value and not record_data %}
<div class="no-results">
    æœªæ‰¾åˆ°ç›¸å…³æ•°æ®
</div>
{% endif %}

<script>
// åŠ¨æ€æ›´æ–°æŸ¥è¯¢å­—æ®µé€‰é¡¹
document.querySelector('select[name="table_name"]').addEventListener('change', function() {
    const tableName = this.value;
    const searchFieldSelect = document.querySelector('select[name="search_field"]');
    const queryHint = document.getElementById('query-hint');
    
    // æ¸…ç©ºç°æœ‰é€‰é¡¹
    searchFieldSelect.innerHTML = '<option value="">é€‰æ‹©æŸ¥è¯¢å­—æ®µ</option>';
    queryHint.innerHTML = '';
    
    if (tableName) {
        // æ ¹æ®é€‰æ‹©çš„è¡¨è®¾ç½®å¯æŸ¥è¯¢å­—æ®µ
        const fieldOptions = getFieldOptions(tableName);
        
        // è®¾ç½®é»˜è®¤é€‰ä¸­å­—æ®µï¼ˆä¼˜å…ˆcontainer_numberï¼Œå¦åˆ™ç¬¬ä¸€ä¸ªå­—æ®µï¼‰
        let defaultField = '';
        if (fieldOptions.some(field => field[0] === 'container_number')) {
            defaultField = 'container_number';
        } else if (fieldOptions.length > 0) {
            defaultField = fieldOptions[0][0];
        }
        
        fieldOptions.forEach(field => {
            const option = document.createElement('option');
            option.value = field[0];
            option.textContent = field[1];
            if (field[0] === defaultField) {
                option.selected = true;
            }
            searchFieldSelect.appendChild(option);
        });
        
        // æ›´æ–°æŸ¥è¯¢æç¤º
        queryHint.innerHTML = `å½“å‰è¡¨æ”¯æŒæŸ¥è¯¢å­—æ®µ: ${fieldOptions.map(f => f[1]).join(', ')}`;
        
        // å¦‚æœæœ‰é»˜è®¤å­—æ®µï¼Œè‡ªåŠ¨èšç„¦åˆ°æŸ¥è¯¢å€¼è¾“å…¥æ¡†
        if (defaultField) {
            document.querySelector('input[name="search_value"]').focus();
        }
    }
});

function getFieldOptions(tableName) {
    const fieldMap = {
        'Container': [
            ['id', 'ID'],
            ['container_number', 'container_number']
        ],
        'Customer': [
            ['id', 'ID'],
            ['zem_name', 'zem_name']
        ],
        'FeeDetail': [
            ['id', 'ID'],
            ['quotation_id', 'quotation_id']
        ],
        'FleetShipmentPallet': [
            ['id', 'ID'],
            ['fleet_number', 'fleet_number'],
            ['pickup_number', 'pickup_number'],
            ['shipment_batch_number', 'shipment_batch_number']
        ],
        'Fleet': [
            ['id', 'ID'],
            ['fleet_number', 'fleet_number'],
            ['pickup_number', 'pickup_number']
        ],
        'InvoicePreport': [
            ['id', 'ID'],
            ['invoice_number', 'invoice_number']
        ],
        'InvoiceWarehouse': [
            ['id', 'ID'],
            ['invoice_number', 'invoice_number']
        ],
        'InvoiceDelivery': [
            ['id', 'ID'],
            ['invoice_number', 'invoice_number']
        ],
        'Invoice': [
            ['id', 'ID'],
            ['invoice_number', 'invoice_number'],
            ['container_number', 'container_number']
        ],
        'InvoiceStatus': [
            ['id', 'ID'],
            ['container_number', 'container_number']
        ],
        'AbnormalOffloadStatus': [
            ['id', 'ID'],
            ['container_number', 'container_number']
        ],
        'Order': [
            ['id', 'ID'],
            ['container_number', 'container_number']
        ],
        'PackingList': [
            ['id', 'ID'],
            ['container_number', 'container_number'],
            ['PO_ID', 'PO_ID']
        ],
        'PalletDestroyed': [
            ['id', 'ID'],
            ['container_number', 'container_number']
        ],
        'Pallet': [
            ['id', 'ID'],
            ['container_number', 'container_number'],
            ['PO_ID', 'PO_ID'],
            ['slot', 'slot']
        ],
        'PoCheckEtaSeven': [
            ['id', 'ID'],
            ['container_number', 'container_number']
        ],
        'QuotationMaster': [
            ['id', 'ID'],
            ['exclusive_user', 'exclusive_user'],
            ['quote_type', 'quote_type']
        ],
        'TransferLocation': [
            ['id', 'ID'],
            ['fleet_number', 'fleet_number'],
            ['container_number', 'container_number']
        ],
        'Vessel': [
            ['id', 'ID'],
            ['vessel', 'vessel']
        ]
    };
    
    return fieldMap[tableName] || [['id', 'ID']];
}

// é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    const tableSelect = document.querySelector('select[name="table_name"]');
    // å¦‚æœæ²¡æœ‰é€‰æ‹©è¡¨ï¼Œé»˜è®¤é€‰æ‹©Container
    if (!tableSelect.value) {
        tableSelect.value = 'Container';
    }
    tableSelect.dispatchEvent(new Event('change'));
});
</script>
{% endblock %}