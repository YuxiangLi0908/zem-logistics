<!--未排车时添加PO弹框-->
<style>
    .filter-info-tooltip {
        position: relative;
        display: inline-block;
    }

    .filter-info-tooltip::after {
        content: attr(data-tooltip);
        white-space: pre-line; /* 支持多行 */
        position: absolute;
        top: calc(50% + 6px);
        left: 120%; /* 在问号右侧一点 */
        transform: translateY(-35%); /* 垂直居中，与问号齐平 */
        background-color: rgba(60, 60, 60, 0.95);
        color: #fff;
        padding: 6px 10px;
        border-radius: 6px;
        font-size: 12px;
        line-height: 1.4;
        width: max-content;
        max-width: 260px;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.2s ease;
        z-index: 1000;
        pointer-events: none;
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }

    /* 悬停时显示 */
    .filter-info-tooltip:hover::after {
        opacity: 1;
        visibility: visible;
    }

    /* 加一个右侧的小箭头 */
    .filter-info-tooltip::before {
        content: "";
        position: absolute;
        top: 50%;
        left: 100%;
        transform: translateY(-50%);
        border-width: 6px;
        border-style: solid;
        border-color: transparent rgba(60, 60, 60, 0.95) transparent transparent;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.2s ease;
    }

    .filter-info-tooltip:hover::before {
        opacity: 1;
        visibility: visible;
    }
    /* 搜索行样式 */
    .search-row {
        background-color: #f8f9fa;
    }
    
    .search-row th {
        padding: 8px !important;
        border-bottom: 1px solid #dee2e6;
    }
    
    .header-search {
        width: 100%;
        padding: 6px 8px;
        border: 1px solid #ced4da;
        border-radius: 4px;
        font-size: 0.8rem;
        box-sizing: border-box;
    }
    
    .header-search:focus {
        outline: none;
        border-color: #3498db;
        box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
    }

    /* 高亮样式 */
    .highlight-color-1 {
        background: yellow;
        font-weight: bold;
    }

    .highlight-color-2 {
        background: #8ef5a6;
        font-weight: bold;
    }

    .highlight-color-3 {
        background: #ffb4b4;
        font-weight: bold;
    }

    .highlight-color-4 {
        background: #b4c9ff;
        font-weight: bold;
    }
</style>
<form method="post" id="addablePOForm">
    {% csrf_token %}
    <input type="hidden" name="tab" id="formTab" value="">
    <input type="hidden" name="step" value="shipment_add_pallet">
    <input type="hidden" name="warehouse" value="{{ warehouse }}">
    <input type="hidden" name="page" value="arm_appointment">
    <input type="hidden" name="appointment_id" value="{{ appointment_id }}">

    <div id="addablePOModal" class="modal">
        <div class="modal-content" style="width: 90%; max-width: 900px; max-height: 700px;">
            <div class="modal-header">
                <h3>
                    <i class="fas fa-plus"></i> 添加PO - {{ appointment_id }}
                    <span class="filter-info-tooltip" 
                        data-tooltip="可添加PO筛选条件：
                    • 柜子类型：转运 或 转运组合
                    • 建单时间：2024年9月1日之后
                    • 状态：未绑定预约
                    • 所在地：{{ warehouse }}
                    • 仓库类型：公仓">
                        <i class="fas fa-question-circle" style="color: #6c757d; font-size: 0.8em; cursor: help; margin-left: 8px;"></i>
                    </span>
                </h3>
                <span class="close" onclick="closeAddablePOModal()">&times;</span>
            </div>
            <div class="modal-body">
                <table class="modal-table">
                    <thead>
                        <tr>
                            <th style="width: 5%; text-align:center;">
                                <input type="checkbox" id="selectAllAddablePos">
                            </th>
                            <th style="width: 20%; word-break: break-word; white-space: normal;">REF ID</th>
                            <th style="width: 20%; word-break: break-word; white-space: normal;">FBA ID</th>
                            <th style="width: 15%; word-break: break-word; white-space: normal;">柜号</th>
                            <th style="width: 20%; word-break: break-word; white-space: normal;">目的地</th>
                            <th style="width: 10%; text-align:center;">板数</th>
                        </tr>
                        <tr class="search-row">
                            <td style="text-align:center;"></td>
                            <td>
                                <input type="text" class="header-search" placeholder="搜索REF ID" data-column="1">
                            </td>
                            <td>
                                <input type="text" class="header-search" placeholder="搜索FBA ID" data-column="2">
                            </td>
                            <td>
                                <input type="text" class="header-search" placeholder="搜索柜号" data-column="3">
                            </td>
                            <td>
                                <input type="text" class="header-search" placeholder="搜索目的地" data-column="4">
                            </td>
                            <td style="text-align:center;">
                                <input type="text" class="header-search" placeholder="搜索板数" data-column="5">
                            </td>
                        </tr>
                    </thead>
                    <tbody id="addablePOTableBody">
                        {% if packing_list_not_scheduled %}
                            {% for po in packing_list_not_scheduled %}
                            <tr data-ref-ids="{{ po.ref_ids|default:''|lower }}" 
                                data-fba-ids="{{ po.fba_ids|default:''|lower }}"
                                data-cns="{{ po.cns|default:''|lower }}"
                                data-destination="{{ po.destination|default:''|lower }}"
                                data-pallet="{{ po.total_n_pallet_act|default:0 }}">
                                <td style="text-align:center;">
                                    <input type="checkbox" class="plt-checkbox" value="{{ po.id }}">
                                    <input type="hidden"  name="plt_ids" value="{{ po.plt_ids }}">
                                    <input type="hidden"  name="cargo_ids" value="{{ po.pl_ids }}">
                                </td>
                                <td style="word-break: break-word; white-space: normal;">{{ po.ref_ids|default:"-" }}</td>
                                <td style="word-break: break-word; white-space: normal;">{{ po.fba_ids|default:"-" }}</td>
                                <td style="word-break: break-word; white-space: normal;">{{ po.cns }}</td>
                                <td style="word-break: break-word; white-space: normal;">{{ po.destination }}</td>
                                <td style="text-align:center;">
                                    {{ po.total_n_pallet_act }}
                                    <input type="hidden" name="scheduled_pallet" value="{{ po.total_n_pallet_act }}">
                                </td>
                            </tr>
                            {% endfor %}
                        {% else %}
                            <tr><td colspan="7" style="text-align:center; color:#888; padding: 20px;">暂无可添加的PO</td></tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
            <div class="modal-actions">
                <button type="submit" class="modal-btn modal-btn-success" onclick="handleAddablePOFormSubmit()">确认添加</button>
                <button type="button" class="modal-btn modal-btn-danger" onclick="closeAddablePOModal()" style="padding:10px 20px;">取消</button>
            </div>
        </div>
    </div>
</form>

<script>
    // 未排车时添加PO模态框的JavaScript
    function closeAddablePOModal() {
        const modal = document.getElementById('addablePOModal');
        if (modal) modal.style.display = 'none';
    }

    function handleAddablePOFormSubmit() {
        const form = document.getElementById('addablePOForm');
        
        // 收集选中的行数据
        const selectedRowsData = [];
        const selectedCheckboxes = document.querySelectorAll('#addablePOModal .plt-checkbox:checked');
        
        selectedCheckboxes.forEach(checkbox => {
            const row = checkbox.closest('tr');
            const pltIdInput = row.querySelector('input[name="plt_ids"]');
            const cargoIdInput = row.querySelector('input[name="cargo_ids"]');
            
            // 判断是 plt_ids 还是 cargo_ids
            const idType = pltIdInput && pltIdInput.value ? 'plt_ids' : 'cargo_ids';
            const idValue = pltIdInput && pltIdInput.value ? pltIdInput.value : 
                        (cargoIdInput && cargoIdInput.value ? cargoIdInput.value : '');
            
            if (idValue) {
                selectedRowsData.push({
                    idType: idType,
                    idValue: idValue,
                });
            }
        });
        
        if (selectedRowsData.length === 0) {
            alert('请至少选择一个PO！');
            return false;
        }
        
        // 移除原有的所有相关输入
        const existingInputs = form.querySelectorAll('input[name="plt_ids"], input[name="cargo_ids"], input[name="scheduled_pallet"], input[name="actual_shipped_pallet"]');
        existingInputs.forEach(input => input.remove());
        
        // 添加选中的数据
        selectedRowsData.forEach(rowData => {
            // 添加 plt_ids 或 cargo_ids
            const idInput = document.createElement('input');
            idInput.type = 'hidden';
            idInput.name = rowData.idType;
            idInput.value = rowData.idValue;
            form.appendChild(idInput);
        });
        
        // 提交表单
        form.submit();
        return true;
    }

    // 全选功能
    document.addEventListener('DOMContentLoaded', function() {
        const selectAll = document.getElementById('selectAllAddablePos');
        if (selectAll) {
            selectAll.addEventListener('click', function() {
                document.querySelectorAll('#addablePOModal .plt-checkbox').forEach(cb => {
                    cb.checked = this.checked;
                });
            });
        }
        // 初始化搜索功能
        initializeAddablePOSearch();
    });

    // 搜索功能初始化
    function initializeAddablePOSearch() {
        const searchInputs = document.querySelectorAll('#addablePOModal .header-search');
        const rows = document.querySelectorAll('#addablePOModal tbody tr');
        
        let searchState = {};
        let searchTimer;

        // 多列 AND 条件搜索
        function applyMultiFilter() {
            // 每次搜索前清空高亮
            clearHighlights();
            
            // 收集每列的搜索内容
            searchState = {};
            searchInputs.forEach(input => {
                const col = input.dataset.column;
                const val = input.value.trim().toLowerCase();
                if (val) searchState[col] = val;
            });

            // 无任何搜索 → 全部显示
            if (Object.keys(searchState).length === 0) {
                rows.forEach(r => r.style.display = '');
                updateSelectAllState();
                return;
            }

            // 应用多列筛选
            rows.forEach(row => {
                let shouldShow = true;
                
                // 检查每一列的筛选条件
                for (const [column, searchValue] of Object.entries(searchState)) {
                    const cellValue = row.getAttribute(`data-${getColumnName(column)}`) || '';
                    if (!cellValue.includes(searchValue)) {
                        shouldShow = false;
                        break;
                    }
                }
                
                row.style.display = shouldShow ? '' : 'none';
            });
            
            // 应用高亮
            applyHighlights(Object.values(searchState));
            updateSelectAllState();
        }

        // 获取列名
        function getColumnName(columnIndex) {
            const columnMap = {
                '1': 'ref-ids',
                '2': 'fba-ids', 
                '3': 'cns',
                '4': 'destination',
                '5': 'pallet'
            };
            return columnMap[columnIndex] || '';
        }

        // 输入框监听
        searchInputs.forEach(input => {
            input.addEventListener('input', function() {
                clearTimeout(searchTimer);
                searchTimer = setTimeout(applyMultiFilter, 300);
            });

            input.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    clearTimeout(searchTimer);
                    applyMultiFilter();
                }
            });
        });

        // 初始筛选
        applyMultiFilter();
    }

    // 清除高亮
    function clearHighlights() {
        document.querySelectorAll('#addablePOModal tbody tr td').forEach(td => {
            // 只恢复文本内容，保持复选框状态
            if (td.querySelector('input[type="checkbox"]') || td.querySelector('input[type="hidden"]')) {
                return; // 跳过包含输入框的单元格
            }
            td.innerHTML = td.textContent;
        });
    }

    // 应用高亮
    function applyHighlights(searchTerms) {
        const rows = document.querySelectorAll('#addablePOModal tbody tr');
        
        rows.forEach(row => {
            if (row.style.display === 'none') return;
            
            row.querySelectorAll('td').forEach((td, index) => {
                // 跳过第一列（复选框列）
                if (index === 0) return;
                
                let html = td.textContent;
                
                searchTerms.forEach((term, termIndex) => {
                    if (!term) return;
                    
                    const colorClass = `highlight-color-${(termIndex % 4) + 1}`;
                    const regex = new RegExp(`(${escapeRegExp(term)})`, 'gi');
                    
                    html = html.replace(regex, `<span class="${colorClass}">$1</span>`);
                });
                
                td.innerHTML = html;
            });
        });
    }

    // 转义正则表达式特殊字符
    function escapeRegExp(string) {
        return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }

    // 更新全选框状态
    function updateSelectAllState() {
        const selectAll = document.getElementById('selectAllAddablePos');
        const visibleCheckboxes = Array.from(document.querySelectorAll('#addablePOModal .plt-checkbox'))
            .filter(cb => cb.closest('tr').style.display !== 'none');
        
        if (visibleCheckboxes.length === 0) {
            selectAll.checked = false;
            selectAll.indeterminate = false;
            return;
        }
        
        const checkedCount = visibleCheckboxes.filter(cb => cb.checked).length;
        
        if (checkedCount === 0) {
            selectAll.checked = false;
            selectAll.indeterminate = false;
        } else if (checkedCount === visibleCheckboxes.length) {
            selectAll.checked = true;
            selectAll.indeterminate = false;
        } else {
            selectAll.checked = false;
            selectAll.indeterminate = true;
        }
    }

    // 为单个复选框添加事件监听，更新全选框状态
    document.addEventListener('click', function(event) {
        if (event.target.classList.contains('plt-checkbox')) {
            updateSelectAllState();
        }
    });
</script>