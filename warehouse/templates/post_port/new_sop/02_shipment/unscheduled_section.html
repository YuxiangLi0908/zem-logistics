{% load custom_filters %}
<style>
    .modal-table th:first-child,
    .modal-table td:first-child {
        width: 40px !important;
        min-width: 40px;
        max-width: 40px;
        text-align: center;
        padding: 8px 4px !important;
    }

    .modal-table th:nth-child(6), /* 板数列 */
    .modal-table td:nth-child(6),
    .modal-table th:nth-child(7), /* CBM列 */
    .modal-table td:nth-child(7) {
        width: 80px !important;
        min-width: 80px;
        max-width: 80px;
        text-align: center;
    }

    /* 其他列均分剩余宽度 */
    .modal-table th:nth-child(2), /* REF ID */
    .modal-table td:nth-child(2),
    .modal-table th:nth-child(3), /* FBA ID */
    .modal-table td:nth-child(3),
    .modal-table th:nth-child(4), /* 柜号 */
    .modal-table td:nth-child(4),
    .modal-table th:nth-child(5), /* 入仓时间 */
    .modal-table td:nth-child(5) {
        width: auto;
        min-width: 100px;
    }

    .modal-table .export-po-checkbox {
        width: 16px;
        height: 16px;
        margin: 0;
    }
    .search-row {
        background-color: #f8f9fa;
    }
    .search-row td {
        padding: 5px !important;
        border-bottom: 1px solid #dee2e6;
    }
    .header-search {
        width: 100%;
        padding: 4px 8px;
        border: 1px solid #ced4da;
        border-radius: 4px;
        font-size: 0.8rem;
    }
    
    /* 高亮样式 */
    .highlight-color-1 {
        background: yellow;
        font-weight: bold;
    }
    .highlight-color-2 {
        background: #8ef5a6;
        font-weight: bold;
    }
    .highlight-color-3 {
        background: #ffb4b4;
        font-weight: bold;
    }
    .highlight-color-4 {
        background: #b4c9ff;
        font-weight: bold;
    }
    .highlight-color-1 {
        background: linear-gradient(120deg, #ffeb3b 0%, #ffeb3b 100%) !important;
        color: #000 !important;
        font-weight: bold !important;
        padding: 2px 4px !important;
        border-radius: 3px !important;
        box-shadow: 0 2px 4px rgba(255, 235, 59, 0.4) !important;
    }

    .highlight-color-2 {
        background: linear-gradient(120deg, #8ef5a6 0%, #4caf50 100%) !important;
        color: #000 !important;
        font-weight: bold !important;
        padding: 2px 4px !important;
        border-radius: 3px !important;
        box-shadow: 0 2px 4px rgba(142, 245, 166, 0.4) !important;
    }

    .highlight-color-3 {
        background: linear-gradient(120deg, #ffb4b4 0%, #f44336 100%) !important;
        color: #000 !important;
        font-weight: bold !important;
        padding: 2px 4px !important;
        border-radius: 3px !important;
        box-shadow: 0 2px 4px rgba(255, 180, 180, 0.4) !important;
    }

    .highlight-color-4 {
        background: linear-gradient(120deg, #b4c9ff 0%, #2196f3 100%) !important;
        color: #000 !important;
        font-weight: bold !important;
        padding: 2px 4px !important;
        border-radius: 3px !important;
        box-shadow: 0 2px 4px rgba(180, 201, 255, 0.4) !important;
    }
</style>
<!-- 未排约标签页 -->
<div class="content-section" id="unscheduled-section">
    <div class="search-box">
        <div style="display: flex; gap: 10px; flex: 1; align-items: center;">                     
            <div class="filter-notice">
                <i class="fas fa-filter"></i> 
                筛选条件：<strong>{{ warehouse }}</strong> | 
                <strong>非暂扣/自提/快递</strong> | 
                <strong>有提柜时间</strong> | 
                <strong>未预约</strong> | 
                <strong>公仓</strong>
            </div>
        </div>
        <div style="display: flex; align-items: center; gap: 8px; margin-left: 10px;">
            <small style="color: #666; white-space: nowrap;">容量限制:</small>
            <span style="font-size: 0.85rem; color: var(--primary-color); font-weight: 600;">
                {{ max_pallet }}板 / {{ max_cbm }}CBM
            </span>
        </div>
        <div class="sort-options" style="margin-bottom: 0;">
            <button class="sort-btn active" data-sort="destination">目的地</button>
            <button class="sort-btn" data-sort="pallets">板数</button>
            <button class="sort-btn" data-sort="delivery_window">派送窗口</button>
        </div>
    </div>

    <!-- 智能匹配建议表格 -->
    {% if matching_suggestions %}
    <div style="margin-top: 20px;">
        <h4 style="margin-bottom: 15px; color: var(--secondary-color);">
            <i class="fas fa-robot"></i> 智能匹配建议 ({{ matching_suggestions|length }}个分组)
        </h4>
        
        <div class="table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>仓点</th>
                        <th>建议预约号</th>
                        <th>REF ID</th>
                        <th>FBA ID</th>
                        <th>柜号</th>
                        <th>入仓时间</th>
                        <th>派送时间</th>
                        <th>板数</th>
                        <th>CBM</th>
                        <th>是否甩板</th>
                        <th>匹配度</th>
                        <th>操作</th>
                    </tr>
                    <tr class="search-row">
                        <td><input type="text" class="header-search" placeholder="搜索仓点" data-column="0"></td>
                        <td><input type="text" class="header-search" placeholder="搜索预约号" data-column="1"></td>
                        <td><input type="text" class="header-search" placeholder="搜索REF ID" data-column="2"></td>
                        <td><input type="text" class="header-search" placeholder="搜索FBA ID" data-column="3"></td>
                        <td><input type="text" class="header-search" placeholder="搜索柜号" data-column="4"></td>
                        <td><input type="text" class="header-search" placeholder="搜索入仓时间" data-column="5"></td>
                        <td><input type="text" class="header-search" placeholder="搜索派送时间" data-column="6"></td>
                        <td><input type="text" class="header-search" placeholder="搜索板数" data-column="7"></td>
                        <td><input type="text" class="header-search" placeholder="搜索CBM" data-column="8"></td>
                        <td><input type="text" class="header-search" placeholder="搜索是否甩板" data-column="9"></td>
                        <td></td>
                        <td></td>
                    </tr>
                </thead>
                <tbody>
                    <!-- 先显示有匹配预约的分组 -->
                    {% for suggestion in matching_suggestions %}
                        {% if suggestion.primary_group.matched_shipment %}
                        <!-- 添加组间隔行 - 每个组都添加 -->
                        <tr class="group-separator">
                            <td colspan="12" style="background: linear-gradient(90deg, #3498db, #6c8bc7); 
                                                height: 2px; padding: 0;"></td>
                        </tr>
                        
                        {% for cargo in suggestion.cargos %}
                        <tr data-suggestion-id="{{ suggestion.suggestion_id }}"
                            data-cargo-id="{{ cargo.ids|default:'' }}"
                            data-plt-id="{{ cargo.plt_ids|default:'' }}">
                            <!-- 仓点列 -->
                            {% if forloop.first %}
                            <td rowspan="{{ suggestion.cargos|length }}" style="vertical-align: middle; background-color: #f8f9fa;">
                                <!-- 添加组标识 -->
                                <div style="position: absolute; top: 8px; left: 8px; width: 8px; height: 8px; 
                                            background: #28a745; border-radius: 50%;"></div>
                                <div style="margin-left: 15px;">
                                <div style="font-size: 16px; font-weight: bold; margin-bottom: 5px;">
                                    {{ suggestion.primary_group.destination }}
                                </div>
                                <div style="font-size: 12px; color: #666;">
                                    {{ suggestion.primary_group.delivery_method }}
                                </div>
                            </td>
                            {% endif %}
                            
                            <!-- 建议预约号 -->
                            {% if forloop.first %}
                            <td rowspan="{{ suggestion.cargos|length }}" style="vertical-align: middle; background-color: #f8f9fa;">
                                <div style="font-weight: bold; color: #28a745; margin-bottom: 5px;">
                                    {{ suggestion.primary_group.matched_shipment.appointment_id|default:"未分配预约号" }}
                                </div>
                                {% if suggestion.primary_group.matched_shipment.shipment_cargo_id %}
                                <div style="font-size: 12px; color: #666;">
                                    shipment: {{ suggestion.primary_group.matched_shipment.shipment_cargo_id }}
                                </div>
                                {% endif %}
                                {% if suggestion.primary_group.matched_shipment.shipment_appointment %}
                                <div style="font-size: 12px; color: #666;">
                                    {{ suggestion.primary_group.matched_shipment.shipment_appointment|date:"Y-m-d H:i" }}
                                </div>
                                {% endif %}
                            </td>
                            {% endif %}
                            
                            <!-- 货物详细信息 -->
                            <td class="ref-ids-col" data-full="{{ cargo.ref_ids|default:'' }}">{{ cargo.ref_ids|default:"-"|truncatechars:20 }}</td>
                            <td class="fba-ids-col" data-full="{{ cargo.fba_ids|default:'' }}">{{ cargo.fba_ids|default:"-"|truncatechars:20 }}</td>
                            <td class="container-no-col" style="max-width: 150px; white-space: pre-line; font-size: 0.8rem;">
                                {{ cargo.cns|linebreaks_cn }}
                            </td>
                            <td class="offload-time-col">
                                {{ cargo.offload_time }}
                            </td>
                            <td>
                                {% if cargo.delivery_window_start or cargo.delivery_window_end %}
                                    {{ cargo.delivery_window_start|date:"M. j" }} ~ {{ cargo.delivery_window_end|date:"M. j" }}
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            <td class="pallet-col">
                                {% if cargo.label == 'ACT' %}
                                    {{ cargo.total_n_pallet_act|default:0|floatformat:2 }}
                                {% else %}
                                    {{ cargo.total_n_pallet_est|default:0|floatformat:2 }}
                                {% endif %}
                            </td>
                            <td class="cbm-col">{{ cargo.total_cbm|default:0|floatformat:3 }}</td>
                            <td class="is-dropped">
                                {% if cargo.is_dropped_pallet == True %}
                                    {% if cargo.rebuilt_is_dropped_pallet %}
                                        {{ cargo.rebuilt_is_dropped_pallet }}
                                    {% else %}
                                        无主约时间
                                    {% endif %}
                                {% endif %}
                            </td>
                            <!-- 匹配度 -->
                            {% if forloop.first %}
                            <td rowspan="{{ suggestion.cargos|length }}" style="vertical-align: middle;">
                                <div style="display: flex; flex-direction: column; gap: 6px; min-width: 100px;">
                                    <!-- 板数进度条 -->
                                    <div style="display: flex; align-items: center; gap: 6px;">
                                        <div class="progress-container" style="flex: 0.6; background: #e9ecef; border-radius: 4px; height: 8px;">
                                            <div class="progress-bar-pallets" style="width: {{ suggestion.primary_group.pallets_percentage }}%; height: 100%; background: #28a745; border-radius: 4px;"></div>
                                        </div>
                                        <span style="font-size: 0.9rem; font-weight: bold; white-space: nowrap; min-width: 50px;">
                                            {{ suggestion.primary_group.total_pallets|floatformat:0 }}/{{ max_pallet }}
                                        </span>
                                    </div>
                                    <!-- CBM进度条 -->
                                    <div style="display: flex; align-items: center; gap: 6px;">
                                        <div class="progress-container" style="flex: 0.6; background: #e9ecef; border-radius: 4px; height: 8px;">
                                            <div class="progress-bar-cbm" style="width: {{ suggestion.primary_group.cbm_percentage }}%; height: 100%; background: #007bff; border-radius: 4px;"></div>
                                        </div>
                                        <span style="font-size: 0.9rem; font-weight: bold; white-space: nowrap; min-width: 50px;">
                                            {{ suggestion.primary_group.total_cbm|floatformat:1 }}/{{ max_cbm }}
                                        </span>
                                    </div>
                                </div>
                            </td>
                            {% endif %}
                            
                            <!-- 操作按钮 -->
                            {% if forloop.first %}
                            <td rowspan="{{ suggestion.cargos|length }}" style="vertical-align: middle;">
                                <button class="action-btn btn-success open-bind-modal"
                                        data-suggestion-id="{{ suggestion.suggestion_id }}"
                                        data-has-appointment="1"
                                        data-shipment-type="{{ suggestion.primary_group.matched_shipment.shipment_type }}"
                                        data-appointment-id="{{ suggestion.primary_group.matched_shipment.appointment_id }}"
                                        data-load-type="{{ suggestion.primary_group.matched_shipment.load_type }}"
                                        data-destination="{{ suggestion.primary_group.destination }}"
                                        data-delivery-method="{{ suggestion.primary_group.delivery_method }}"
                                        data-scheduled-time="{{ suggestion.primary_group.matched_shipment.shipment_appointment|date:'Y-m-d H:i' }}"
                                        data-shipment-account="{{ suggestion.primary_group.matched_shipment.shipment_account }}"
                                        data-origin="{{ warehouse }}"
                                        data-note="{{ suggestion.primary_group.matched_shipment.note }}"
                                        data-address-detail="{{ suggestion.primary_group.matched_shipment.address_detail }}"
                                        data-shipment-cargo-id="{{ suggestion.primary_group.matched_shipment.shipment_cargo_id }}"
                                        data-pickup-time="{{ suggestion.primary_group.matched_shipment.pickup_time|date:'Y-m-d H:i' }}"
                                        data-pickup-number="{{ suggestion.primary_group.matched_shipment.pickup_number }}">
                                    <i class="fas fa-link"></i> 绑定
                                </button>
                                <button class="action-btn btn-success export-group-po" 
                                        data-suggestion-id="{{ suggestion.suggestion_id }}"
                                        style="margin-top: 5px;">
                                    <i class="fas fa-file-export"></i> 导出PO
                                </button>
                                {% with sid="suggestion_"|add:suggestion.suggestion_id %}
                                    <div class="intelligent-po-action">
                                        <button type="button"
                                                class="action-btn btn-primary open-intelligent-modal"
                                                data-script-id="{{ sid }}">
                                            <i class="fas fa-plus"></i> 智能找PO
                                        </button>

                                        {{ suggestion|json_script:sid }}
                                    </div>
                                {% endwith %}
                                {% with sid="suggestion_"|add:suggestion.suggestion_id %}
                                    <div class="intelligent-po-action">
                                        <button type="button" class="action-btn btn-primary" 
                                                onclick="openVirtualFleetModal('{{ suggestion.suggestion_id }}')">
                                            <i class="fas fa-truck-loading"></i> 一提多卸
                                        </button>

                                        {{ suggestion|json_script:sid }}
                                    </div>
                                {% endwith %}
                                
                            </td>
                            {% endif %}
                        </tr>
                        {% endfor %}
                        {% endif %}
                    {% endfor %}
                    
                    <!-- 再显示没有匹配预约的分组 -->
                    {% for suggestion in matching_suggestions %}
                        {% if not suggestion.primary_group.matched_shipment %}
                        <!-- 添加组间隔行 -->
                        <tr class="group-separator">
                            <td colspan="11" style="background: linear-gradient(90deg, #f39c12, #e67e22); 
                                                height: 2px; padding: 0;"></td>
                        </tr>
                        {% for cargo in suggestion.cargos %}
                        <tr data-suggestion-id="{{ suggestion.suggestion_id }}"
                            data-cargo-id="{{ cargo.ids|default:'' }}"
                            data-plt-id="{{ cargo.plt_ids|default:'' }}">
                            <!-- 仓点列 -->
                            {% if forloop.first %}
                            <td rowspan="{{ suggestion.cargos|length }}" style="vertical-align: middle; background-color: #f8f9fa;">
                                <!-- 添加组标识 -->
                                <div style="position: absolute; top: 8px; left: 8px; width: 8px; height: 3px; 
                                            background: #f39c12; border-radius: 50%;"></div>
                                <div style="margin-left: 15px;">
                                <div style="font-size: 16px; font-weight: bold; margin-bottom: 5px;">
                                    {{ suggestion.primary_group.destination }}
                                </div>
                                <div style="font-size: 12px; color: #666;">
                                    {{ suggestion.primary_group.delivery_method }}
                                </div>
                            </td>
                            {% endif %}
                            
                            <!-- 建议预约号 -->
                            {% if forloop.first %}
                            <td rowspan="{{ suggestion.cargos|length }}" style="vertical-align: middle; background-color: #f8f9fa;">
                                <div style="font-weight: bold; color: #6c757d;">
                                    未匹配到预约
                                </div>
                            </td>
                            {% endif %}
                            
                            <!-- 货物详细信息 -->
                            <td class="ref-ids-col" data-full="{{ cargo.ref_ids|default:'' }}">{{ cargo.ref_ids|default:"-"|truncatechars:20 }}</td>
                            <td class="fba-ids-col" data-full="{{ cargo.fba_ids|default:'' }}">{{ cargo.fba_ids|default:"-"|truncatechars:20 }}</td>
                            <td class="container-no-col" style="max-width: 150px; white-space: pre-line; font-size: 0.8rem;">
                                {{ cargo.cns|linebreaks_cn }}
                            </td>
                            <td class="offload-time-col">
                                {{ cargo.offload_time }}
                            </td>
                            <td>
                                {% if cargo.delivery_window_start or cargo.delivery_window_end %}
                                    {{ cargo.delivery_window_start|date:"M. j" }} ~ {{ cargo.delivery_window_end|date:"M. j" }}
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            <td class="pallet-col">
                                {% if cargo.label == 'ACT' %}
                                    {{ cargo.total_n_pallet_act|default:0|floatformat:2 }}
                                {% else %}
                                    {{ cargo.total_n_pallet_est|default:0|floatformat:2 }}
                                {% endif %}
                            </td>
                            <td class="cbm-col">{{ cargo.total_cbm|default:0|floatformat:3 }}</td>
                            <td class="is-dropped">
                                {% if cargo.is_dropped_pallet == True %}
                                    {% if cargo.rebuilt_is_dropped_pallet %}
                                        {{ cargo.rebuilt_is_dropped_pallet }}
                                    {% else %}
                                        无主约时间
                                    {% endif %}
                                {% endif %}
                            </td>
                            <!-- 匹配度 -->
                            {% if forloop.first %}
                            <td rowspan="{{ suggestion.cargos|length }}" style="vertical-align: middle;">
                                <div style="display: flex; flex-direction: column; gap: 6px; min-width: 100px;">
                                    <!-- 板数进度条 -->
                                    <div style="display: flex; align-items: center; gap: 6px;">
                                        <div class="progress-container" style="flex: 0.6; background: #e9ecef; border-radius: 4px; height: 8px;">
                                            <div class="progress-bar-pallets" style="width: {{ suggestion.primary_group.pallets_percentage }}%; height: 100%; background: #28a745; border-radius: 4px;"></div>
                                        </div>
                                        <span style="font-size: 0.9rem; font-weight: bold; white-space: nowrap; min-width: 50px;">
                                            {{ suggestion.primary_group.total_pallets|floatformat:0 }}/{{ max_pallet }}
                                        </span>
                                    </div>
                                    <!-- CBM进度条 -->
                                    <div style="display: flex; align-items: center; gap: 6px;">
                                        <div class="progress-container" style="flex: 0.6; background: #e9ecef; border-radius: 4px; height: 8px;">
                                            <div class="progress-bar-cbm" style="width: {{ suggestion.primary_group.cbm_percentage }}%; height: 100%; background: #007bff; border-radius: 4px;"></div>
                                        </div>
                                        <span style="font-size: 0.9rem; font-weight: bold; white-space: nowrap; min-width: 50px;">
                                            {{ suggestion.primary_group.total_cbm|floatformat:1 }}/{{ max_cbm }}
                                        </span>
                                    </div>
                                </div>
                            </td>
                            {% endif %}
                            
                            <!-- 操作按钮 -->
                            {% if forloop.first %}
                            <td rowspan="{{ suggestion.cargos|length }}" style="vertical-align: middle;">
                                <button class="action-btn btn-primary open-bind-modal"
                                        data-suggestion-id="{{ suggestion.suggestion_id }}"
                                        data-has-appointment="0"
                                        data-destination="{{ suggestion.primary_group.destination }}"
                                        data-delivery-method="{{ suggestion.primary_group.delivery_method }}"
                                        data-origin="{{ warehouse }}">
                                    <i class="fas fa-calendar-plus"></i> 预约
                                </button>
                                <button class="action-btn btn-success export-group-po" 
                                        data-suggestion-id="{{ suggestion.suggestion_id }}"
                                        style="margin-top: 5px;">
                                    <i class="fas fa-file-export"></i> 导出PO
                                </button>
                                {% with sid="suggestion_"|add:suggestion.suggestion_id %}
                                    <div class="intelligent-po-action">
                                        <button type="button"
                                                class="action-btn btn-primary open-intelligent-modal"
                                                data-script-id="{{ sid }}">
                                            <i class="fas fa-plus"></i> 智能找PO
                                        </button>

                                        {{ suggestion|json_script:sid }}
                                    </div>
                                {% endwith %}
                                {% with sid="suggestion_"|add:suggestion.suggestion_id %}
                                    <div class="intelligent-po-action">
                                        <button type="button" class="action-btn btn-primary" 
                                                onclick="openVirtualFleetModal('{{ suggestion.suggestion_id }}')">
                                            <i class="fas fa-truck-loading"></i> 一提多卸
                                        </button>

                                        {{ suggestion|json_script:sid }}
                                    </div>
                                {% endwith %}
                            </td>
                            {% endif %}
                        </tr>
                        {% endfor %}
                        {% endif %}
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% else %}
    <div style="text-align: center; padding: 40px; color: #6c757d;">
        <i class="fas fa-robot" style="font-size: 3rem; margin-bottom: 15px;"></i>
        <p>暂无智能匹配建议</p>
    </div>
    {% endif %}
</div>
<!-- 导出PO模态框 -->
<div id="exportPoModal" class="modal">
    <div class="modal-content" style="width: 85%; max-width: 900px;">
        <div class="modal-header">
            <h3><i class="fas fa-file-export"></i> 导出PO预览</h3>
            <span class="close" id="closeExportPoModal">&times;</span>
        </div>
        <div class="modal-body">
            <input type="hidden" id="exportSuggestionId">
            <input type="hidden" id="exportCargoIds">
            <input type="hidden" id="exportPltIds">

            <h4><i class="fas fa-box"></i> 当前PO列表</h4>
            <table class="modal-table">
                <thead>
                    <tr>
                        <th style="width: 30px;"><input type="checkbox" id="checkAllExportPo"></th>
                        <th style="max-width: 120px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">REF ID</th>
                        <th style="max-width: 120px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">FBA ID</th>
                        <th>柜号</th>
                        <th>入仓时间</th>
                        <th>板数</th>
                        <th>CBM</th>
                        <th>是否甩板</th>
                    </tr>
                </thead>
                <tbody id="exportPoTableBody">
                    <!-- JS 动态填充 -->
                </tbody>
            </table>

            <div class="modal-actions">
                <button class="modal-btn modal-btn-success" id="confirmExportPo">
                    <i class="fas fa-file-export"></i> 确认导出
                </button>
                <button class="modal-btn modal-btn-danger" id="cancelExportPo">
                    <i class="fas fa-times"></i> 取消
                </button>
            </div>
        </div>
    </div>
</div>
<script>
    function openExportPoModal() {
        const modal = document.getElementById('exportPoModal');
        modal.style.display = 'block';
    }
    function closeExportPoModal() {
        document.getElementById('exportPoModal').style.display = 'none';
    }
    // 搜索相关变量
    let searchState = {};
    let searchTimer;

    // 搜索功能工具函数
    function escapeRegExp(string) {
        return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }

    function isRowMatchSingle(row, searchTerm) {
        const cells = row.querySelectorAll('td');
        
        for (let i = 0; i < cells.length; i++) {
            // 跳过操作列和匹配度列（最后几列）
            if (i >= 10) continue;
            
            const cellText = cells[i].textContent.toLowerCase().trim();
            if (cellText.includes(searchTerm)) {
                return true;
            }
        }
        return false;
    }

    function isRowMatchAll(row, searchState) {
        const cells = row.querySelectorAll('td');
        
        for (const [colIndex, searchTerm] of Object.entries(searchState)) {
            const cellIndex = parseInt(colIndex);
            if (cellIndex >= cells.length || cellIndex >= 10) continue;
            
            const cellText = cells[cellIndex].textContent.toLowerCase().trim();
            if (!cellText.includes(searchTerm)) {
                return false;
            }
        }
        return true;
    }

    function handleUnscheduledSearch(rows, searchTerm) {
        const groupMap = new Map();

        // 按 suggestionId 分组
        rows.forEach(row => {
            if (row.classList.contains('group-separator')) return;
            const suggestionId = row.getAttribute('data-suggestion-id');
            if (suggestionId) {
                if (!groupMap.has(suggestionId)) {
                    groupMap.set(suggestionId, []);
                }
                groupMap.get(suggestionId).push(row);
            }
        });

        // 处理每个组
        groupMap.forEach(groupRows => {
            let groupMatched = false;
            
            // 检查组内是否有任何行匹配搜索词
            groupRows.forEach(row => {
                if (isRowMatchSingle(row, searchTerm)) {
                    groupMatched = true;
                }
            });
            
            // 设置整个组的显示状态
            groupRows.forEach(row => {
                row.style.display = groupMatched ? '' : 'none';
            });
        });
    }

    function handleUnscheduledSearchForVisible(rows, searchTerm) {
        const visibleGroups = new Set();
        rows.forEach(r => {
            if (r.style.display !== 'none') {
                const groupId = r.dataset.suggestionId;
                if (groupId) visibleGroups.add(groupId);
            }
        });

        const matchedGroups = new Set();
        
        // 检查每个可见组是否有任何行匹配搜索词
        visibleGroups.forEach(groupId => {
            const groupRows = document.querySelectorAll(`tr[data-suggestion-id="${groupId}"]`);
            let groupMatched = false;
            
            groupRows.forEach(tr => {
                if (isRowMatchSingle(tr, searchTerm)) {
                    groupMatched = true;
                }
            });
            
            if (groupMatched) {
                matchedGroups.add(groupId);
            }
        });

        // 隐藏不匹配的组
        rows.forEach(tr => {
            const groupId = tr.dataset.suggestionId;
            if (groupId && !matchedGroups.has(groupId)) {
                tr.style.display = 'none';
            }
        });
    }

    function clearHighlightsUnscheduledSection() {
        const rows = document.querySelectorAll('#unscheduled-section tbody tr');
        
        rows.forEach(row => {
            if (row.classList.contains('group-separator')) return;
            
            const cells = row.querySelectorAll('td');
            cells.forEach(cell => {
                // 恢复原始HTML内容
                const originalHtml = cell.getAttribute('data-original-html');
                if (originalHtml) {
                    cell.innerHTML = originalHtml;
                    cell.removeAttribute('data-original-html');
                }
            });
        });
    }

    function applyHighlightsUnscheduledSP(searchTerms) {
        if (searchTerms.length === 0) {
            clearHighlightsUnscheduledSection();
            return;
        }
        
        const rows = document.querySelectorAll('#unscheduled-section tbody tr');
        
        rows.forEach(row => {
            if (row.style.display === 'none' || row.classList.contains('group-separator')) return;
            
            const cells = row.querySelectorAll('td');
            cells.forEach((cell, cellIndex) => {
                // 跳过操作列和匹配度列（最后2列）
                if (cellIndex >= 10) return;
                
                let cellText = cell.textContent;
                
                // 保存原始HTML（如果有的话）
                if (!cell.hasAttribute('data-original-html')) {
                    cell.setAttribute('data-original-html', cell.innerHTML);
                }
                
                let highlightedHtml = cellText;
                
                // 对每个搜索词应用高亮
                searchTerms.forEach((term, termIndex) => {
                    if (!term) return;
                    
                    const colorClass = `highlight-color-${(termIndex % 4) + 1}`;
                    // 创建不区分大小写的正则表达式
                    const regex = new RegExp(`(${escapeRegExp(term)})`, 'gi');
                    
                    highlightedHtml = highlightedHtml.replace(regex, `<span class="${colorClass}">$1</span>`);
                });
                
                // 只有当有实际变化时才更新innerHTML
                if (highlightedHtml !== cellText) {
                    cell.innerHTML = highlightedHtml;
                }
            });
        });
    }

    function updateGroupSeparators() {
        const groupSeparators = document.querySelectorAll('#unscheduled-section .group-separator');
        groupSeparators.forEach(separator => {
            // 找到分隔行后面的第一个数据行
            let nextRow = separator.nextElementSibling;
            let shouldShowSeparator = false;
            
            // 查找分隔行后面的第一个有效数据行
            while (nextRow) {
                if (nextRow.classList && !nextRow.classList.contains('group-separator')) {
                    if (nextRow.style.display !== 'none') {
                        shouldShowSeparator = true;
                    }
                    break;
                }
                nextRow = nextRow.nextElementSibling;
            }
            
            separator.style.display = shouldShowSeparator ? '' : 'none';
        });
    }

    // 多列 AND 条件搜索
    function applyMultiFilterUnscheduledSection() {

        clearHighlightsUnscheduledSection();

        const searchInputs = document.querySelectorAll('#unscheduled-section .header-search');
        const rows = document.querySelectorAll('#unscheduled-section tbody tr');
        
        // 收集搜索条件
        searchState = {};
        let hasSearchCondition = false;
        searchInputs.forEach(input => {
            const col = input.dataset.column;
            const val = input.value.trim().toLowerCase();
            if (val) {
                searchState[col] = val;
                hasSearchCondition = true;
            }
        });

        const searchTerms = Object.values(searchState);

        // 没有搜索条件时显示所有行和分隔线
        if (searchTerms.length === 0) {
            rows.forEach(r => {
                if (!r.classList.contains('group-separator')) {
                    r.style.display = '';
                }
            });
            updateGroupSeparators();
            return;
        }
        let firstRound = true;

        // 应用AND搜索逻辑
        for (let term of searchTerms) {
            if (firstRound) {
                handleUnscheduledSearch(rows, term);
                firstRound = false;
            } else {
                handleUnscheduledSearchForVisible(rows, term);
            }
            const visibleRows = document.querySelectorAll('#unscheduled-section tbody tr:not(.group-separator)[style=""]');
        }
        // 处理组间隔行的显示
        updateGroupSeparators();
        // 应用高亮
        applyHighlightsUnscheduledSP(searchTerms);
    }

    let searchTimers = {};
    // 初始化搜索功能
    function initSearch() {
        const searchInputs = document.querySelectorAll('#unscheduled-section .header-search');
        
        searchInputs.forEach(input => {
            // 清除现有事件监听器（避免重复绑定）
            const newInput = input.cloneNode(true);
            input.parentNode.replaceChild(newInput, input);
        });
        
        // 重新获取输入框
        const freshInputs = document.querySelectorAll('#unscheduled-section .header-search');
        
        freshInputs.forEach(input => {
            const column = input.dataset.column;
            
            input.addEventListener('input', function() {
                // 清除该列之前的定时器
                if (searchTimers[column]) {
                    clearTimeout(searchTimers[column]);
                }
                
                // 设置新的定时器
                searchTimers[column] = setTimeout(() => {
                    applyMultiFilterUnscheduledSection();
                }, 250);
            });
        });
    }
    // 未排约页面特定的JavaScript
    document.addEventListener('DOMContentLoaded', function() {
        initSearch();

        // 导出PO功能
        document.querySelectorAll('.export-group-po').forEach(btn => {
            btn.addEventListener('click', function () {
                const suggestionId = this.getAttribute('data-suggestion-id');
                const groupRows = document.querySelectorAll(`tr[data-suggestion-id="${suggestionId}"]`);

                if (!groupRows.length) {
                    alert('未找到对应的PO数据');
                    return;
                }

                const tbody = document.getElementById('exportPoTableBody');
                tbody.innerHTML = ''; // 清空旧内容

                const cargoIds = [];
                const pltIds = [];

                groupRows.forEach(row => {
                    const ref = row.querySelector('.ref-ids-col')?.textContent.trim() || '-';
                    const fba = row.querySelector('.fba-ids-col')?.textContent.trim() || '-';
                    const cn = row.querySelector('.container-no-col')?.textContent.trim() || '-';
                    const offload = row.querySelector('.offload-time-col')?.textContent.trim() || '-';
                    const pallets = row.querySelector('.pallet-col')?.textContent.trim() || '-';
                    const cbm = row.querySelector('.cbm-col')?.textContent.trim() || '-';
                    const isdropped = row.querySelector('.is-dropped')?.textContent.trim() || '-';
                    if (row.dataset.cargoId) {
                        cargoIds.push(...row.dataset.cargoId.split(',').filter(Boolean));
                    }
                    if (row.dataset.pltId) {
                        pltIds.push(...row.dataset.pltId.split(',').filter(Boolean));
                    }

                    tbody.insertAdjacentHTML('beforeend', `
                        <tr>
                            <td><input type="checkbox" class="export-po-checkbox" 
                                data-cargo-id="${row.dataset.cargoId}" 
                                data-plt-id="${row.dataset.pltId}" checked></td>
                            <td style="max-width: 120px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${ref}</td>
                            <td style="max-width: 120px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${fba}</td>
                            <td>${cn}</td>
                            <td>${offload}</td>
                            <td>${pallets}</td>
                            <td>${cbm}</td>
                            <td>${isdropped}</td>
                        </tr>
                    `);
                });
                document.getElementById('exportSuggestionId').value = suggestionId;
                document.getElementById('exportCargoIds').value = cargoIds.join(',');
                document.getElementById('exportPltIds').value = pltIds.join(',');

                openExportPoModal();
            });
        });
        const checkAllBox = document.getElementById('checkAllExportPo');
        checkAllBox.addEventListener('change', function() {
            const checkboxes = document.querySelectorAll('.export-po-checkbox');
            checkboxes.forEach(cb => cb.checked = this.checked);
        });
        

        document.getElementById('closeExportPoModal').addEventListener('click', closeExportPoModal);
        document.getElementById('cancelExportPo').addEventListener('click', closeExportPoModal);

        // 确认导出逻辑
        document.getElementById('confirmExportPo').addEventListener('click', function() {
            const suggestionId = document.getElementById('exportSuggestionId').value;

            const checkedBoxes = document.querySelectorAll('.export-po-checkbox:checked');
            if (!checkedBoxes.length) {
                alert('请至少选择一个PO导出！');
                return;
            }

            const cargoIds = Array.from(checkedBoxes).map(cb => cb.dataset.cargoId);
            const pltIds = Array.from(checkedBoxes).map(cb => cb.dataset.pltId);

            document.getElementById('formStep').value = 'export_virtual_fleet_pos';
            document.getElementById('formCargoIds').value = cargoIds.join(',');
            document.getElementById('formPltIds').value = pltIds.join(',');
            document.getElementById('formSuggestionId').value = suggestionId;

            closeExportPoModal();
            document.getElementById('actionForm').submit();
        });
    });
    
</script>