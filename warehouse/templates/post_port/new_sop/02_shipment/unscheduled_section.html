{% load custom_filters %}
<style>
    .modal-table th:first-child,
    .modal-table td:first-child {
        width: 40px !important;
        min-width: 40px;
        max-width: 40px;
        text-align: center;
        padding: 8px 4px !important;
    }

    .modal-table th:nth-child(6), /* 板数列 */
    .modal-table td:nth-child(6),
    .modal-table th:nth-child(7), /* CBM列 */
    .modal-table td:nth-child(7) {
        width: 80px !important;
        min-width: 80px;
        max-width: 80px;
        text-align: center;
    }

    /* 其他列均分剩余宽度 */
    .modal-table th:nth-child(2), /* REF ID */
    .modal-table td:nth-child(2),
    .modal-table th:nth-child(3), /* FBA ID */
    .modal-table td:nth-child(3),
    .modal-table th:nth-child(4), /* 柜号 */
    .modal-table td:nth-child(4),
    .modal-table th:nth-child(5), /* 入仓时间 */
    .modal-table td:nth-child(5) {
        width: auto;
        min-width: 100px;
    }

    .modal-table .export-po-checkbox {
        width: 16px;
        height: 16px;
        margin: 0;
    }
</style>
<!-- 未排约标签页 -->
<div class="content-section" id="unscheduled-section">
    <div class="search-box">
        <div style="display: flex; gap: 10px; flex: 1; align-items: center;">
            <input type="text" class="search-input" placeholder="搜索目的地、REF ID、FBA ID..." id="unscheduledSearch">
            <button class="search-btn" id="searchUnscheduledBtn">
                <i class="fas fa-search"></i> 搜索
            </button>
            <div style="display: flex; align-items: center; gap: 8px; margin-left: 10px;">
                <small style="color: #666; white-space: nowrap;">容量限制:</small>
                <span style="font-size: 0.85rem; color: var(--primary-color); font-weight: 600;">
                    {{ max_pallet }}板 / {{ max_cbm }}CBM
                </span>
            </div>
        </div>
        
        <div class="sort-options" style="margin-bottom: 0;">
            <button class="sort-btn active" data-sort="destination">目的地</button>
            <button class="sort-btn" data-sort="pallets">板数</button>
            <button class="sort-btn" data-sort="delivery_window">派送窗口</button>
        </div>
    </div>

    <!-- 智能匹配建议表格 -->
    {% if matching_suggestions %}
    <div style="margin-top: 20px;">
        <h4 style="margin-bottom: 15px; color: var(--secondary-color);">
            <i class="fas fa-robot"></i> 智能匹配建议 ({{ matching_suggestions|length }}个分组)
        </h4>
        
        <div class="table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>仓点</th>
                        <th>建议预约号</th>
                        <th>REF ID</th>
                        <th>FBA ID</th>
                        <th>柜号</th>
                        <th>入仓时间</th>
                        <th>派送时间</th>
                        <th>板数</th>
                        <th>CBM</th>
                        <th>匹配度</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- 先显示有匹配预约的分组 -->
                    {% for suggestion in matching_suggestions %}
                        {% if suggestion.primary_group.matched_shipment %}
                        <!-- 添加组间隔行 - 每个组都添加 -->
                        <tr class="group-separator">
                            <td colspan="11" style="background: linear-gradient(90deg, #3498db, #6c8bc7); 
                                                height: 2px; padding: 0;"></td>
                        </tr>
                        
                        {% for cargo in suggestion.cargos %}
                        <tr data-suggestion-id="{{ suggestion.suggestion_id }}"
                            data-cargo-id="{{ cargo.ids|default:'' }}"
                            data-plt-id="{{ cargo.plt_ids|default:'' }}">
                            <!-- 仓点列 -->
                            {% if forloop.first %}
                            <td rowspan="{{ suggestion.cargos|length }}" style="vertical-align: middle; background-color: #f8f9fa;">
                                <!-- 添加组标识 -->
                                <div style="position: absolute; top: 8px; left: 8px; width: 8px; height: 8px; 
                                            background: #28a745; border-radius: 50%;"></div>
                                <div style="margin-left: 15px;">
                                <div style="font-size: 16px; font-weight: bold; margin-bottom: 5px;">
                                    {{ suggestion.primary_group.destination }}
                                </div>
                                <div style="font-size: 12px; color: #666;">
                                    {{ suggestion.primary_group.delivery_method }}
                                </div>
                            </td>
                            {% endif %}
                            
                            <!-- 建议预约号 -->
                            {% if forloop.first %}
                            <td rowspan="{{ suggestion.cargos|length }}" style="vertical-align: middle; background-color: #f8f9fa;">
                                <div style="font-weight: bold; color: #28a745; margin-bottom: 5px;">
                                    {{ suggestion.primary_group.matched_shipment.appointment_id|default:"未分配预约号" }}
                                </div>
                                {% if suggestion.primary_group.matched_shipment.shipment_cargo_id %}
                                <div style="font-size: 12px; color: #666;">
                                    shipment: {{ suggestion.primary_group.matched_shipment.shipment_cargo_id }}
                                </div>
                                {% endif %}
                                {% if suggestion.primary_group.matched_shipment.shipment_appointment %}
                                <div style="font-size: 12px; color: #666;">
                                    {{ suggestion.primary_group.matched_shipment.shipment_appointment|date:"Y-m-d H:i" }}
                                </div>
                                {% endif %}
                            </td>
                            {% endif %}
                            
                            <!-- 货物详细信息 -->
                            <td class="ref-ids-col" data-full="{{ cargo.ref_ids|default:'' }}">{{ cargo.ref_ids|default:"-"|truncatechars:20 }}</td>
                            <td class="fba-ids-col" data-full="{{ cargo.fba_ids|default:'' }}">{{ cargo.fba_ids|default:"-"|truncatechars:20 }}</td>
                            <td class="container-no-col" style="max-width: 150px; white-space: pre-line; font-size: 0.8rem;">
                                {{ cargo.cns|linebreaks_cn }}
                            </td>
                            <td class="offload-time-col">
                                {{ cargo.offload_time }}
                            </td>
                            <td>
                                {% if cargo.delivery_window_start or cargo.delivery_window_end %}
                                    {{ cargo.delivery_window_start|date:"M. j" }} ~ {{ cargo.delivery_window_end|date:"M. j" }}
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            <td class="pallet-col">
                                {% if cargo.label == 'ACT' %}
                                    {{ cargo.total_n_pallet_act|default:0|floatformat:2 }}
                                {% else %}
                                    {{ cargo.total_n_pallet_est|default:0|floatformat:2 }}
                                {% endif %}
                            </td>
                            <td class="cbm-col">{{ cargo.total_cbm|default:0|floatformat:3 }}</td>
                            
                            <!-- 匹配度 -->
                            {% if forloop.first %}
                            <td rowspan="{{ suggestion.cargos|length }}" style="vertical-align: middle;">
                                <div style="display: flex; flex-direction: column; gap: 6px; min-width: 100px;">
                                    <!-- 板数进度条 -->
                                    <div style="display: flex; align-items: center; gap: 6px;">
                                        <div class="progress-container" style="flex: 0.6; background: #e9ecef; border-radius: 4px; height: 8px;">
                                            <div class="progress-bar-pallets" style="width: {{ suggestion.primary_group.pallets_percentage }}%; height: 100%; background: #28a745; border-radius: 4px;"></div>
                                        </div>
                                        <span style="font-size: 0.9rem; font-weight: bold; white-space: nowrap; min-width: 50px;">
                                            {{ suggestion.primary_group.total_pallets|floatformat:0 }}/{{ max_pallet }}
                                        </span>
                                    </div>
                                    <!-- CBM进度条 -->
                                    <div style="display: flex; align-items: center; gap: 6px;">
                                        <div class="progress-container" style="flex: 0.6; background: #e9ecef; border-radius: 4px; height: 8px;">
                                            <div class="progress-bar-cbm" style="width: {{ suggestion.primary_group.cbm_percentage }}%; height: 100%; background: #007bff; border-radius: 4px;"></div>
                                        </div>
                                        <span style="font-size: 0.9rem; font-weight: bold; white-space: nowrap; min-width: 50px;">
                                            {{ suggestion.primary_group.total_cbm|floatformat:1 }}/{{ max_cbm }}
                                        </span>
                                    </div>
                                </div>
                            </td>
                            {% endif %}
                            
                            <!-- 操作按钮 -->
                            {% if forloop.first %}
                            <td rowspan="{{ suggestion.cargos|length }}" style="vertical-align: middle;">
                                <button class="action-btn btn-success open-bind-modal"
                                        data-suggestion-id="{{ suggestion.suggestion_id }}"
                                        data-has-appointment="1"
                                        data-shipment-type="{{ suggestion.primary_group.matched_shipment.shipment_type }}"
                                        data-appointment-id="{{ suggestion.primary_group.matched_shipment.appointment_id }}"
                                        data-load-type="{{ suggestion.primary_group.matched_shipment.load_type }}"
                                        data-destination="{{ suggestion.primary_group.destination }}"
                                        data-delivery-method="{{ suggestion.primary_group.delivery_method }}"
                                        data-scheduled-time="{{ suggestion.primary_group.matched_shipment.shipment_appointment|date:'Y-m-d H:i' }}"
                                        data-shipment-account="{{ suggestion.primary_group.matched_shipment.shipment_account }}"
                                        data-origin="{{ warehouse }}"
                                        data-note="{{ suggestion.primary_group.matched_shipment.note }}"
                                        data-address-detail="{{ suggestion.primary_group.matched_shipment.address_detail }}"
                                        data-shipment-cargo-id="{{ suggestion.primary_group.matched_shipment.shipment_cargo_id }}">
                                    <i class="fas fa-link"></i> 绑定
                                </button>
                                <button class="action-btn btn-success export-group-po" 
                                        data-suggestion-id="{{ suggestion.suggestion_id }}"
                                        style="margin-top: 5px;">
                                    <i class="fas fa-file-export"></i> 导出PO
                                </button>
                                {% with sid="suggestion_"|add:suggestion.suggestion_id %}
                                    <div class="intelligent-po-action">
                                        <button type="button"
                                                class="action-btn btn-primary open-intelligent-modal"
                                                data-script-id="{{ sid }}">
                                            <i class="fas fa-plus"></i> 智能找PO
                                        </button>

                                        {{ suggestion|json_script:sid }}
                                    </div>
                                {% endwith %}
                                {% with sid="suggestion_"|add:suggestion.suggestion_id %}
                                    <div class="intelligent-po-action">
                                        <button type="button" class="action-btn btn-primary" 
                                                onclick="openVirtualFleetModal('{{ suggestion.suggestion_id }}')">
                                            <i class="fas fa-truck-loading"></i> 一提多卸
                                        </button>

                                        {{ suggestion|json_script:sid }}
                                    </div>
                                {% endwith %}
                                
                            </td>
                            {% endif %}
                        </tr>
                        {% endfor %}
                        {% endif %}
                    {% endfor %}
                    
                    <!-- 再显示没有匹配预约的分组 -->
                    {% for suggestion in matching_suggestions %}
                        {% if not suggestion.primary_group.matched_shipment %}
                        <!-- 添加组间隔行 -->
                        <tr class="group-separator">
                            <td colspan="11" style="background: linear-gradient(90deg, #f39c12, #e67e22); 
                                                height: 2px; padding: 0;"></td>
                        </tr>
                        {% for cargo in suggestion.cargos %}
                        <tr data-suggestion-id="{{ suggestion.suggestion_id }}"
                            data-cargo-id="{{ cargo.ids|default:'' }}"
                            data-plt-id="{{ cargo.plt_ids|default:'' }}">
                            <!-- 仓点列 -->
                            {% if forloop.first %}
                            <td rowspan="{{ suggestion.cargos|length }}" style="vertical-align: middle; background-color: #f8f9fa;">
                                <!-- 添加组标识 -->
                                <div style="position: absolute; top: 8px; left: 8px; width: 8px; height: 3px; 
                                            background: #f39c12; border-radius: 50%;"></div>
                                <div style="margin-left: 15px;">
                                <div style="font-size: 16px; font-weight: bold; margin-bottom: 5px;">
                                    {{ suggestion.primary_group.destination }}
                                </div>
                                <div style="font-size: 12px; color: #666;">
                                    {{ suggestion.primary_group.delivery_method }}
                                </div>
                            </td>
                            {% endif %}
                            
                            <!-- 建议预约号 -->
                            {% if forloop.first %}
                            <td rowspan="{{ suggestion.cargos|length }}" style="vertical-align: middle; background-color: #f8f9fa;">
                                <div style="font-weight: bold; color: #6c757d;">
                                    未匹配到预约
                                </div>
                            </td>
                            {% endif %}
                            
                            <!-- 货物详细信息 -->
                            <td class="ref-ids-col" data-full="{{ cargo.ref_ids|default:'' }}">{{ cargo.ref_ids|default:"-"|truncatechars:20 }}</td>
                            <td class="fba-ids-col" data-full="{{ cargo.fba_ids|default:'' }}">{{ cargo.fba_ids|default:"-"|truncatechars:20 }}</td>
                            <td class="container-no-col" style="max-width: 150px; white-space: pre-line; font-size: 0.8rem;">
                                {{ cargo.cns|linebreaks_cn }}
                            </td>
                            <td class="offload-time-col">
                                {{ cargo.offload_time }}
                            </td>
                            <td>
                                {% if cargo.delivery_window_start or cargo.delivery_window_end %}
                                    {{ cargo.delivery_window_start|date:"M. j" }} ~ {{ cargo.delivery_window_end|date:"M. j" }}
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            <td class="pallet-col">
                                {% if cargo.label == 'ACT' %}
                                    {{ cargo.total_n_pallet_act|default:0|floatformat:2 }}
                                {% else %}
                                    {{ cargo.total_n_pallet_est|default:0|floatformat:2 }}
                                {% endif %}
                            </td>
                            <td class="cbm-col">{{ cargo.total_cbm|default:0|floatformat:3 }}</td>
                            
                            <!-- 匹配度 -->
                            {% if forloop.first %}
                            <td rowspan="{{ suggestion.cargos|length }}" style="vertical-align: middle;">
                                <div style="display: flex; flex-direction: column; gap: 6px; min-width: 100px;">
                                    <!-- 板数进度条 -->
                                    <div style="display: flex; align-items: center; gap: 6px;">
                                        <div class="progress-container" style="flex: 0.6; background: #e9ecef; border-radius: 4px; height: 8px;">
                                            <div class="progress-bar-pallets" style="width: {{ suggestion.primary_group.pallets_percentage }}%; height: 100%; background: #28a745; border-radius: 4px;"></div>
                                        </div>
                                        <span style="font-size: 0.9rem; font-weight: bold; white-space: nowrap; min-width: 50px;">
                                            {{ suggestion.primary_group.total_pallets|floatformat:0 }}/{{ max_pallet }}
                                        </span>
                                    </div>
                                    <!-- CBM进度条 -->
                                    <div style="display: flex; align-items: center; gap: 6px;">
                                        <div class="progress-container" style="flex: 0.6; background: #e9ecef; border-radius: 4px; height: 8px;">
                                            <div class="progress-bar-cbm" style="width: {{ suggestion.primary_group.cbm_percentage }}%; height: 100%; background: #007bff; border-radius: 4px;"></div>
                                        </div>
                                        <span style="font-size: 0.9rem; font-weight: bold; white-space: nowrap; min-width: 50px;">
                                            {{ suggestion.primary_group.total_cbm|floatformat:1 }}/{{ max_cbm }}
                                        </span>
                                    </div>
                                </div>
                            </td>
                            {% endif %}
                            
                            <!-- 操作按钮 -->
                            {% if forloop.first %}
                            <td rowspan="{{ suggestion.cargos|length }}" style="vertical-align: middle;">
                                <button class="action-btn btn-primary open-bind-modal"
                                        data-suggestion-id="{{ suggestion.suggestion_id }}"
                                        data-has-appointment="0"
                                        data-destination="{{ suggestion.primary_group.destination }}"
                                        data-delivery-method="{{ suggestion.primary_group.delivery_method }}"
                                        data-origin="{{ warehouse }}">
                                    <i class="fas fa-calendar-plus"></i> 预约
                                </button>
                                <button class="action-btn btn-success export-group-po" 
                                        data-suggestion-id="{{ suggestion.suggestion_id }}"
                                        style="margin-top: 5px;">
                                    <i class="fas fa-file-export"></i> 导出PO
                                </button>
                                {% with sid="suggestion_"|add:suggestion.suggestion_id %}
                                    <div class="intelligent-po-action">
                                        <button type="button"
                                                class="action-btn btn-primary open-intelligent-modal"
                                                data-script-id="{{ sid }}">
                                            <i class="fas fa-plus"></i> 智能找PO
                                        </button>

                                        {{ suggestion|json_script:sid }}
                                    </div>
                                {% endwith %}
                                {% with sid="suggestion_"|add:suggestion.suggestion_id %}
                                    <div class="intelligent-po-action">
                                        <button type="button" class="action-btn btn-primary" 
                                                onclick="openVirtualFleetModal('{{ suggestion.suggestion_id }}')">
                                            <i class="fas fa-truck-loading"></i> 一提多卸
                                        </button>

                                        {{ suggestion|json_script:sid }}
                                    </div>
                                {% endwith %}
                            </td>
                            {% endif %}
                        </tr>
                        {% endfor %}
                        {% endif %}
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% else %}
    <div style="text-align: center; padding: 40px; color: #6c757d;">
        <i class="fas fa-robot" style="font-size: 3rem; margin-bottom: 15px;"></i>
        <p>暂无智能匹配建议</p>
    </div>
    {% endif %}
</div>
<!-- 导出PO模态框 -->
<div id="exportPoModal" class="modal">
    <div class="modal-content" style="width: 85%; max-width: 900px;">
        <div class="modal-header">
            <h3><i class="fas fa-file-export"></i> 导出PO预览</h3>
            <span class="close" id="closeExportPoModal">&times;</span>
        </div>
        <div class="modal-body">
            <input type="hidden" id="exportSuggestionId">
            <input type="hidden" id="exportCargoIds">
            <input type="hidden" id="exportPltIds">

            <h4><i class="fas fa-box"></i> 当前PO列表</h4>
            <table class="modal-table">
                <thead>
                    <tr>
                        <th style="width: 30px;"><input type="checkbox" id="checkAllExportPo"></th>
                        <th style="max-width: 120px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">REF ID</th>
                        <th style="max-width: 120px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">FBA ID</th>
                        <th>柜号</th>
                        <th>入仓时间</th>
                        <th>板数</th>
                        <th>CBM</th>
                    </tr>
                </thead>
                <tbody id="exportPoTableBody">
                    <!-- JS 动态填充 -->
                </tbody>
            </table>

            <div class="modal-actions">
                <button class="modal-btn modal-btn-success" id="confirmExportPo">
                    <i class="fas fa-file-export"></i> 确认导出
                </button>
                <button class="modal-btn modal-btn-danger" id="cancelExportPo">
                    <i class="fas fa-times"></i> 取消
                </button>
            </div>
        </div>
    </div>
</div>
<script>
// 未排约页面特定的JavaScript
document.addEventListener('DOMContentLoaded', function() {
    // 导出PO功能
    document.querySelectorAll('.export-group-po').forEach(btn => {
        btn.addEventListener('click', function () {
            const suggestionId = this.getAttribute('data-suggestion-id');
            const groupRows = document.querySelectorAll(`tr[data-suggestion-id="${suggestionId}"]`);

            if (!groupRows.length) {
                alert('未找到对应的PO数据');
                return;
            }

            const tbody = document.getElementById('exportPoTableBody');
            tbody.innerHTML = ''; // 清空旧内容

            const cargoIds = [];
            const pltIds = [];

            groupRows.forEach(row => {
                const ref = row.querySelector('.ref-ids-col')?.textContent.trim() || '-';
                const fba = row.querySelector('.fba-ids-col')?.textContent.trim() || '-';
                const cn = row.querySelector('.container-no-col')?.textContent.trim() || '-';
                const offload = row.querySelector('.offload-time-col')?.textContent.trim() || '-';
                const pallets = row.querySelector('.pallet-col')?.textContent.trim() || '-';
                const cbm = row.querySelector('.cbm-col')?.textContent.trim() || '-';

                if (row.dataset.cargoId) {
                    cargoIds.push(...row.dataset.cargoId.split(',').filter(Boolean));
                }
                if (row.dataset.pltId) {
                    pltIds.push(...row.dataset.pltId.split(',').filter(Boolean));
                }

                tbody.insertAdjacentHTML('beforeend', `
                    <tr>
                        <td><input type="checkbox" class="export-po-checkbox" 
                            data-cargo-id="${row.dataset.cargoId}" 
                            data-plt-id="${row.dataset.pltId}" checked></td>
                        <td style="max-width: 120px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${ref}</td>
                        <td style="max-width: 120px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${fba}</td>
                        <td>${cn}</td>
                        <td>${offload}</td>
                        <td>${pallets}</td>
                        <td>${cbm}</td>
                    </tr>
                `);
            });
            document.getElementById('exportSuggestionId').value = suggestionId;
            document.getElementById('exportCargoIds').value = cargoIds.join(',');
            document.getElementById('exportPltIds').value = pltIds.join(',');

            openExportPoModal();
        });
    });
    const checkAllBox = document.getElementById('checkAllExportPo');
    checkAllBox.addEventListener('change', function() {
        const checkboxes = document.querySelectorAll('.export-po-checkbox');
        checkboxes.forEach(cb => cb.checked = this.checked);
    });
    function openExportPoModal() {
        const modal = document.getElementById('exportPoModal');
        modal.style.display = 'block';
    }

    document.getElementById('closeExportPoModal').addEventListener('click', closeExportPoModal);
    document.getElementById('cancelExportPo').addEventListener('click', closeExportPoModal);

    function closeExportPoModal() {
        document.getElementById('exportPoModal').style.display = 'none';
    }

    // 确认导出逻辑
    document.getElementById('confirmExportPo').addEventListener('click', function() {
        const suggestionId = document.getElementById('exportSuggestionId').value;

        const checkedBoxes = document.querySelectorAll('.export-po-checkbox:checked');
        if (!checkedBoxes.length) {
            alert('请至少选择一个PO导出！');
            return;
        }

        const cargoIds = Array.from(checkedBoxes).map(cb => cb.dataset.cargoId);
        const pltIds = Array.from(checkedBoxes).map(cb => cb.dataset.pltId);

        document.getElementById('formStep').value = 'export_virtual_fleet_pos';
        document.getElementById('formCargoIds').value = cargoIds.join(',');
        document.getElementById('formPltIds').value = pltIds.join(',');
        document.getElementById('formSuggestionId').value = suggestionId;

        closeExportPoModal();
        document.getElementById('actionForm').submit();
    });

    // 排序功能
    const sortButtons = document.querySelectorAll('.sort-btn');
    sortButtons.forEach(btn => {
        btn.addEventListener('click', function() {
            sortButtons.forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            
            const sortBy = this.dataset.sort;
            sortUnscheduledTable(sortBy);
        });
    });

    function sortUnscheduledTable(sortBy) {
        // 实现排序逻辑
        console.log('按', sortBy, '排序');
        // 这里可以添加具体的排序实现
    }
});
</script>