{% load custom_filters %}

<!-- 未排车批次标签页 -->
<div class="content-section" id="unscheduled-fleet-section">
    <div class="search-box">
        <div style="display: flex; gap: 10px; flex: 1; align-items: center;">
            <input type="text" class="search-input" placeholder="搜索预约批次、目的仓库、预约号..." id="unscheduledFleetSearch">
            <button class="search-btn" id="searchUnscheduledFleetBtn">
                <i class="fas fa-search"></i> 搜索
            </button>
            <button class="btn btn-primary" id="confirmScheduleBtn" style="margin-left: auto;">
                <i class="fas fa-truck"></i> 确认排车
            </button>
        </div>
    </div>

    {% if unschedule_fleet %}
    <div style="margin-top: 20px;">             
        <div class="table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th style="min-width: 40px; text-align: center;"></th>
                        <th>预约批次</th>
                        <th>目的仓库</th>
                        <th>预约号</th>
                        <th>Scheduled Time</th>
                        <th>总重lbs</th>
                        <th>总CBM</th>
                        <th>总卡板数</th>
                        <th>备注</th>
                    </tr>
                </thead>
                <tbody>
                    {% for s in unschedule_fleet %}
                    <tr>
                        <td style="min-width: 40px; text-align: center;">
                            <input type='checkbox' name='is_appointment_added' onclick="toggleRowBackground(this)" {% if s.id in shipment_ids %}checked{% endif %} {% if s.abnormal_palletization or s.po_expired %}disabled{% endif %}>
                            <input type="hidden" name="is_appointment_added", value='off'>
                            <input type="hidden" name="shipment_ids", value='{{ s.id }}'>
                        </td>
                        <td style="max-width: 200px; word-break: break-all;">
                            {% if s.batch > 0 %}
                            <span class="status-span-red">甩板</span>
                            {% endif %}
                            {{ s.shipment_batch_number }}
                        </td>
                        <td>
                            {{ s.destination }}
                            {% if s.abnormal_palletization %}
                            <span class="status-span-red" style="padding-top: 0; padding-bottom: 0;">未解决拆柜异常</span>
                            {% endif %}
                            {% if s.po_expired %}
                            <span class="status-span-yellow" style="padding-top: 0; padding-bottom: 0;">PO失效</span>
                            {% endif %}
                        </td>
                        <td>{{ s.appointment_id }}</td>
                        <td style="max-width: 150px; word-break: break-all;">
                            {% if s.shipping_status == "past_due" %}
                            <span class="status-span-red">{{ s.shipment_appointment|date:"Y-m-d" }} {{ s.shipment_appointment|time:"H:i" }}</span>
                            {% elif s.shipping_status == "need_attention" %}
                            <span class="status-span-yellow">{{ s.shipment_appointment|date:"Y-m-d" }} {{ s.shipment_appointment|time:"H:i" }}</span>
                            {% else %}
                            {{ s.shipment_appointment|date:"Y-m-d" }} {{ s.shipment_appointment|time:"H:i" }}
                            {% endif %}
                        </td>
                        <td>{{ s.total_weight|floatformat:2 }}</td>
                        <td>{{ s.total_cbm|floatformat:2 }}</td>
                        <td>{{ s.total_pallet }}</td>
                        <td style="max-width: 150px; word-break: break-all;">{% if s.note %}{{ s.note }}{% endif %}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% else %}
    <div style="text-align: center; padding: 40px; color: #6c757d;">
        <i class="fas fa-robot" style="font-size: 3rem; margin-bottom: 15px;"></i>
        <p>暂无待排车批次</p>
    </div>
    {% endif %}
</div>

<!-- 排车模态框 -->
<div id="fleetModal" class="modal">
  <div class="modal-content" style="width: 90%; max-width: 1200px; min-width: 800px;">
    <span class="close-btn" onclick="closeFleetModal()" style="
        font-size: 28px;
        font-weight: bold;
        color: #2c3e50;
        background: #f8f9fa;
        width: 44px;
        height: 44px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
        position: absolute;
        top: 20px;
        left: 20px;  /* 改为 left */
        z-index: 1000;
        border: 2px solid #e9ecef;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        line-height: 1;
    ">&times;</span>

    <div id="fleetModalBody" style="padding-top: 10px;">
        <div style="border-radius: 12px; padding: 20px; margin-top: 10px;">
            <form method="post" action="" style="width: 100%;" onsubmit="showLoadingBar()">
                {% csrf_token %}
                <!-- 添加隐藏字段 -->
                <input type="hidden" name="step" id="fleetModalStep" value="fleet_confirmation">
                <input type="hidden" name="fleet_number" id="fleetModalFleetNumber">
                <input type="hidden" name="selected_ids" id="fleetModalSelectedIds">
                <input type="hidden" name="warehouse" value="{{ warehouse }}">
                
                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 20px; margin-bottom: 20px;">
                    <h4 style="color: var(--secondary-color); margin: 0;">
                        <i class="fas fa-truck-loading"></i> 出库批次信息
                    </h4>
                    <div>
                        <button type="submit" class="action-btn btn-success" id="fleetModalConfirmBtn">
                            <i class="fas fa-check"></i> 确认出库
                        </button>
                    </div>
                </div>

                <!-- 合并所有表单字段到一个表格 -->
                <div class="table-container" style="margin-bottom: 20px;">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th colspan="3" style="text-align: center;">车辆信息</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td style="width: 33%;">
                                    <label style="font-size: 0.8rem; font-weight: 600; color: var(--secondary-color); display: block; margin-bottom: 5px;">carrier</label>
                                    <select name="carrier" id="fleetModalCarrier" style="font-size: 13px; width: 100%; padding: 5px;">
                                        {% for k, v in carrier_options.items %}
                                        <option value="{{ v }}">{{ k }}</option>
                                        {% endfor %}
                                    </select>
                                </td>
                                <td style="width: 33%;">
                                    <label style="font-size: 0.8rem; font-weight: 600; color: var(--secondary-color); display: block; margin-bottom: 5px;">3rd Party Address</label>
                                    <input type="text" name="third_party_address" id="fleetModalThirdPartyAddress" class="table-input" style="width: 100%;">
                                </td>
                                <td style="width: 33%;">
                                    <label style="font-size: 0.8rem; font-weight: 600; color: var(--secondary-color); display: block; margin-bottom: 5px;">PickUp Number</label>
                                    <input type="text" name="pickup_number" id="fleetModalPickupNumber" class="table-input" style="width: 100%;">
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    <label style="font-size: 0.8rem; font-weight: 600; color: var(--secondary-color); display: block; margin-bottom: 5px;">车牌号</label>
                                    <input type="text" name="license_plate" id="fleetModalLicensePlate" class="table-input" style="width: 100%;">
                                </td>
                                <td>
                                    <label style="font-size: 0.8rem; font-weight: 600; color: var(--secondary-color); display: block; margin-bottom: 5px;">MC Number</label>
                                    <input type="text" name="motor_carrier_number" id="fleetModalMotorCarrierNumber" class="table-input" style="width: 100%;">
                                </td>
                                <td>
                                    <label style="font-size: 0.8rem; font-weight: 600; color: var(--secondary-color); display: block; margin-bottom: 5px;">DOT Number</label>
                                    <input type="text" name="dot_number" id="fleetModalDotNumber" class="table-input" style="width: 100%;">
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    <label style="font-size: 0.8rem; font-weight: 600; color: var(--secondary-color); display: block; margin-bottom: 5px;">提货时间</label>
                                    <input type="datetime-local" name="appointment_datetime" id="fleetModalAppointmentDatetime" class="table-input" style="width: 100%;" required>
                                </td>
                                <td colspan="2">
                                    <label style="font-size: 0.8rem; font-weight: 600; color: var(--secondary-color); display: block; margin-bottom: 5px;">备注</label>
                                    <input type="text" name="note" id="fleetModalNote" class="table-input" style="width: 100%;">
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </form>

            <div style="display: flex; justify-content: space-between; align-items: center; margin: 25px 0 15px 0;">
                <h4 style="color: var(--secondary-color); margin: 0;">
                    <i class="fas fa-list-alt"></i> 预约批次
                </h4>
            </div>

            <div class="table-container" style="max-height: 300px;">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>预约批次</th>
                            <th>目的地</th>
                            <th>预约号</th>
                            <th>Scheduled Time</th>
                            <th>备注</th>
                            <th>总重lbs</th>
                            <th>总CBM</th>
                            <th>总卡板数</th>
                        </tr>
                    </thead>
                    <tbody id="fleetShipmentTableBody">
                        <!-- 这里用JS动态插入选中的批次 -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
  </div>
</div>

<script>
// 未排车页面特定的JavaScript
document.addEventListener('DOMContentLoaded', function() {
    // 搜索功能
    document.getElementById('searchUnscheduledFleetBtn').addEventListener('click', function() {
        applyFleetSearch('unscheduled-fleet');
    });

    // 确认排车按钮
    document.getElementById("confirmScheduleBtn").addEventListener("click", function() {
        const checkboxes = document.querySelectorAll('#unscheduled-fleet-section input[name="is_appointment_added"]:checked');
        if (checkboxes.length === 0) {
            alert("请先选择至少一条待排车批次！");
            return;
        }

        const selectedIds = [];
        checkboxes.forEach(cb => {
            const hiddenInput = cb.closest('tr').querySelector('input[name="shipment_ids"]');
            if (hiddenInput && hiddenInput.value) {
                selectedIds.push(hiddenInput.value);
            }
        });

        // 设置选中的ID到隐藏字段
        document.getElementById('fleetModalSelectedIds').value = JSON.stringify(selectedIds);
        
        // 将选中的记录信息填入弹窗表格
        const tbody = document.getElementById("fleetShipmentTableBody");
        tbody.innerHTML = ""; // 清空旧内容

        checkboxes.forEach(cb => {
            const tr = cb.closest("tr");
            const cells = tr.querySelectorAll("td");
            const newRow = document.createElement("tr");
            newRow.innerHTML = `
                <td style="max-width: 120px; word-break: break-all;">${cells[1].innerText}</td>
                <td>${cells[2].innerText}</td>
                <td>${cells[3].innerText}</td>
                <td style="max-width: 150px; word-break: break-all;">${cells[4].innerText}</td>
                <td style="max-width: 120px; word-break: break-all;">${cells[8].innerText}</td>
                <td>${cells[5].innerText}</td>
                <td>${cells[6].innerText}</td>
                <td>${cells[7].innerText}</td>
            `;
            tbody.appendChild(newRow);
        });
        
        document.getElementById('fleetModalStep').value = 'fleet_confirmation';
        document.getElementById('fleetModalFleetNumber').value = '';
        
        // 清空其他表单字段
        const form = document.querySelector('#fleetModal form');
        form.reset();
        
        // 显示弹窗
        document.getElementById("fleetModal").style.display = "block";
    });

    // 时间标记功能
    markUnscheduledFleetRows();
    
    // 绑定回车键搜索
    const unscheduledFleetSearch = document.getElementById('unscheduledFleetSearch');
    if (unscheduledFleetSearch) {
        unscheduledFleetSearch.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                applyFleetSearch('unscheduled-fleet');
            }
        });
    }
});

// 未排车批次标记
function markUnscheduledFleetRows() {
    const rows = document.querySelectorAll('#unscheduled-fleet-section .data-table tbody tr');
    
    rows.forEach((row, index) => {
        const timeCell = row.cells[4]; // Scheduled Time在第5列
        let timeText = timeCell.textContent.trim();
        
        // 如果有状态span，获取span内的文本
        const statusSpan = timeCell.querySelector('.status-span-red, .status-span-yellow');
        if (statusSpan) {
            timeText = statusSpan.textContent.trim();
        }
        
        if (timeText) {
            const scheduledTime = parseDateTime(timeText);
            
            if (scheduledTime) {
                const diffDays = getDayDiff(CURRENT_TIME, scheduledTime);
                
                // 时间标记逻辑
                if (scheduledTime < CURRENT_TIME) {
                    // 早于当前时间 - 深红色
                    row.style.backgroundColor = '#ffcccc';
                } else if (diffDays <= 1) {
                    // 未来一天内 - 浅红色
                    row.style.backgroundColor = '#ffe6e6';
                } else if (diffDays <= 2) {
                    // 未来一天到两天内 - 黄色
                    row.style.backgroundColor = '#fff9e6';
                } else {
                    row.style.backgroundColor = ''; // 清除背景色
                }
            }
        }
    });
}

// 搜索功能
function applyFleetSearch(section) {
    const searchTerm = document.getElementById(section + 'Search').value.trim().toLowerCase();
    const rows = document.querySelectorAll('#' + section + '-section .data-table tbody tr');
    
    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(searchTerm) ? '' : 'none';
    });
    
    // 重新添加时间标记
    setTimeout(() => {
        markUnscheduledFleetRows();
    }, 100);
}

// 行背景切换
function toggleRowBackground(checkbox) {
    const row = checkbox.closest('tr');
    if (checkbox.checked) {
        row.style.backgroundColor = '#e8f5e9';
    } else {
        row.style.backgroundColor = '';
    }
}

// 关闭模态框
function closeFleetModal() {
    document.getElementById("fleetModal").style.display = "none";
}

// 点击模态框外部关闭
window.addEventListener('click', function(event) {
    const modal = document.getElementById("fleetModal");
    if (event.target === modal) {
        closeFleetModal();
    }
});

// 加载状态显示
function showLoadingBar() {
    const buttons = document.querySelectorAll('button');
    buttons.forEach(btn => {
        if (btn.innerHTML.includes('fa-check')) {
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 处理中...';
            btn.disabled = true;
        }
    });
}

// 日期时间解析函数
function parseDateTime(dateTimeStr) {
    if (!dateTimeStr) return null;
    
    const standardFormat = /^(\d{4})-(\d{2})-(\d{2})\s+(\d{1,2}):(\d{2})/;
    const monthFormat = /^(\w{3})-(\d{1,2})\s+(\d{1,2}):(\d{2})/;
    const monthDateOnly = /^(\w{3})-(\d{1,2})$/;
    
    let match;
    
    // 尝试标准格式 "2024-07-04 14:30"
    match = dateTimeStr.match(standardFormat);
    if (match) {
        const year = parseInt(match[1]);
        const month = parseInt(match[2]) - 1;
        const day = parseInt(match[3]);
        const hour = parseInt(match[4]);
        const minute = parseInt(match[5]);
        return new Date(year, month, day, hour, minute);
    }
    
    // 尝试月份格式 "Jul-4 14:30"
    match = dateTimeStr.match(monthFormat);
    if (match) {
        const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 
                        'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        const month = monthNames.indexOf(match[1]);
        const day = parseInt(match[2]);
        const hour = parseInt(match[3]);
        const minute = parseInt(match[4]);
        const year = CURRENT_TIME.getFullYear();
        
        if (month === -1) return null;
        return new Date(year, month, day, hour, minute);
    }
    
    // 尝试只有日期的格式 "Jul-4"
    match = dateTimeStr.match(monthDateOnly);
    if (match) {
        const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 
                        'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        const month = monthNames.indexOf(match[1]);
        const day = parseInt(match[2]);
        const year = CURRENT_TIME.getFullYear();
        
        if (month === -1) return null;
        return new Date(year, month, day, 0, 0);
    }
    
    return null;
}

// 计算天数差
function getDayDiff(date1, date2) {
    const d1 = new Date(date1.getFullYear(), date1.getMonth(), date1.getDate());
    const d2 = new Date(date2.getFullYear(), date2.getMonth(), date2.getDate());
    return Math.floor((d2 - d1) / (1000 * 60 * 60 * 24));
}

// 全局变量
const CURRENT_TIME = new Date('{{ current_time|date:"Y-m-d H:i" }}' || new Date());
</script>