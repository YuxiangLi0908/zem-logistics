<!-- 已排约标签页 -->
 {% load custom_filters %}
 
<div class="content-section" id="scheduled-section">
    <div class="search-box">
        <div style="display: flex; gap: 10px; flex: 1; align-items: center;">
            <input type="text" class="search-input" placeholder="搜索预约号、目的地..." id="scheduledSearch">
            <button class="search-btn" id="searchScheduledBtn">
                <i class="fas fa-search"></i> 搜索
            </button>
        </div>
    </div>

    <div class="table-container">
        <table class="data-table">
            <thead>
                <tr>
                    <th>预约批次</th>
                    <th>预约号</th>
                    <th>目的地</th>
                    <th>预约时间</th>
                    <th>装车类型</th>
                    <th>柜号</th>
                    <th>REF ID</th>
                    <th>FBA ID</th>
                    <th>板数</th>
                    <th>CBM</th>
                    <th>备注</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody>
                {% for shipment_group in scheduled_data %}
                {% for cargo in shipment_group.cargos %}
                <tr data-suggestion-id="{{ suggestion.suggestion_id }}"
                            data-cargo-id="{{ cargo.ids|default:'' }}"
                            data-plt-id="{{ cargo.plt_ids|default:'' }}">
                    {% if forloop.first %}
                    <td rowspan="{{ shipment_group.cargos|length }}" style="vertical-align: middle; background-color: #f8f9fa;">
                        {{ shipment_group.shipment_batch_number|default_if_none:'' }}
                    </td>
                    <td rowspan="{{ shipment_group.cargos|length }}" style="vertical-align: middle; background-color: #f8f9fa;">
                        <strong>{{ shipment_group.appointment_id|default_if_none:'' }}</strong>
                        {% if shipment_group.shipment_cargo_id %}
                        <div style="font-size: 12px; color: #666;">
                            shipment: {{ shipment_group.shipment_cargo_id }}
                        </div>
                        {% endif %}
                    </td>
                    <td rowspan="{{ shipment_group.cargos|length }}" style="vertical-align: middle; background-color: #f8f9fa;">
                        {{ shipment_group.destination }}
                    </td>
                    <td rowspan="{{ shipment_group.cargos|length }}" style="vertical-align: middle; background-color: #f8f9fa;">
                        {{ shipment_group.shipment_appointment|date:"Y-m-d H:i" }}
                    </td>
                    <td rowspan="{{ shipment_group.cargos|length }}" style="vertical-align: middle; background-color: #f8f9fa;">
                        {{ shipment_group.load_type }}
                    </td>
                    {% endif %}
                    <td class="container-no-col" style="max-width: 150px; white-space: pre-line; font-size: 0.8rem;">
                        {{ cargo.cns|linebreaks_cn }}
                    </td>
                    <td class="ref-ids-col" data-full="{{ cargo.ref_ids|default:'' }}">{{ cargo.ref_ids|default:"-"|truncatechars:20 }}</td>
                    <td class="fba-ids-col" data-full="{{ cargo.fba_ids|default:'' }}">{{ cargo.fba_ids|default:"-"|truncatechars:20 }}</td>
                    <td>
                        {% if cargo.label == 'ACT' %}
                            {{ cargo.total_n_pallet_act|default:0 }} ACT
                        {% else %}
                            {{ cargo.total_n_pallet_est|default:0 }} EST
                        {% endif %}
                    </td>
                    <td>{{ cargo.total_cbm|default:0 }}</td>
                    <td>
                        <form method="post">
                            {% csrf_token %}
                            <input type="hidden" name="step" value="edit_note_sp">
                            <input type="hidden" name="warehouse" value="{{ warehouse }}">
                            <input type="hidden" name="cargo_ids" value="{{ cargo.ids|default:'' }}">
                            <input type="hidden" name="plt_ids" value="{{ cargo.plt_ids|default:'' }}">
                            <div style="margin-bottom: 5px;">
                                <input type="text" name="note_sp" class="form-input" value="{{ cargo.note_sp|default:'' }}" style="width: 80px;">
                            </div>
                            <button type="submit" class="btn btn-sm btn-primary" style="margin-top: 2px;">保存</button>
                        </form>
                    </td>
                    {% if forloop.first %}
                    <td rowspan="{{ shipment_group.cargos|length }}" style="vertical-align: middle;">
                        
                        <button class="action-btn btn-danger" onclick="unassignShipment('{{ shipment_group.appointment_id }}')">
                            <i class="fas fa-unlink"></i> 取消排约
                        </button>
                        
                        <form method="post" action="">
                            {% csrf_token %}
                            <input type="hidden" name="appointment_id" value="{{ shipment_group.appointment_id }}">                                  
                            <input type="hidden" name="warehouse" value="{{ warehouse }}">
                            <input type="hidden" name="destination" value="{{ shipment_group.destination }}">
                            <input type="hidden" name="step" value="search_addable_po">
                            <input type="hidden" name="tab" value="{{ current_tab }}"> 

                            <button class="action-btn btn-success" onclick="">
                                <i class="fas fa-square-plus"></i> 添加PO
                            </button>
                        </form>
      
                        <button class="action-btn btn-warning open-bind-modal"
                                data-has-appointment="1"
                                data-appointment-id="{{ shipment_group.appointment_id }}"
                                data-load-type="{{ shipment_group.load_type }}"
                                data-destination="{{ shipment_group.destination }}"
                                data-delivery-method="{{ shipment_group.load_type }}"
                                data-scheduled-time="{{ shipment_group.shipment_appointment|date:'Y-m-d H:i' }}"
                                data-shipment-account="{{ shipment_group.shipment_account }}"
                                data-origin="{{ warehouse }}"
                                data-note=""
                                data-address-detail="{{ shipment_group.address_detail }}"
                                data-operation-type="remove_po">
                            <i class="fas fa-square-minus"></i> 删除PO
                        </button>
                        <button class="action-btn btn-primary open-edit-modal"
                                data-appointment-id="{{ shipment_group.appointment_id }}"
                                data-destination="{{ shipment_group.destination }}"
                                data-scheduled-time="{{ shipment_group.shipment_appointment|date:'Y-m-d H:i' }}"
                                data-load-type="{{ shipment_group.load_type }}"
                                data-origin="{{ warehouse }}">
                            <i class="fas fa-edit"></i> 修改约
                        </button>
                    </td>
                    {% endif %}
                </tr>
                {% endfor %}
                {% empty %}
                <tr>
                    <td colspan="9" style="text-align: center; padding: 20px;">
                        暂无已排约货物
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
<div id="editAppointmentModal" class="modal">
    <div class="modal-content" style="width: 600px; max-width: 90%;">
        <div class="modal-header">
            <h3><i class="fas fa-edit"></i> 修改预约</h3>
            <span class="close">&times;</span>
        </div>
        <div class="modal-body">
            <form id="editAppointmentForm" method="post">
                {% csrf_token %}
                <input type="hidden" name="step" value="edit_appointment">
                <input type="hidden" name="appointment_id" id="editModalAppointmentId">
                <input type="hidden" name="warehouse" value="{{ warehouse }}">
                <input type="hidden" name="st_type" value="{{ st_type }}">

                <table class="modal-table">
                    <tbody>
                        <tr>
                            <th>预约号</th>
                            <td><input type="text" name="appointment_id_input" id="editModalAppointmentInput" class="form-input" required></td>
                        </tr>
                        <tr>
                            <th>Scheduled Time</th>
                            <td><input type="datetime-local" name="shipment_appointment" id="editModalScheduledTime" class="form-input" required></td>
                        </tr>
                        <tr>
                            <th>目的地</th>
                            <td><input type="text" name="destination" id="editModalDestination" class="form-input" required></td>
                        </tr>
                        <tr>
                            <th>装车类型</th>
                            <td>
                                <select name="load_type" id="editModalLoadType" class="form-select">
                                    {% for k, v in load_type_options %}
                                    <option value="{{ v }}">{{ k }}</option>
                                    {% endfor %}
                                </select>
                            </td>
                        </tr>
                        <tr>
                            <th>发货仓库</th>
                            <td>
                                <select name="origin" id="editModalOrigin" class="form-select">
                                    {% for k, v in warehouse_options.items %}
                                    <option value="{{ v }}">{{ k }}</option>
                                    {% endfor %}
                                </select>
                            </td>
                        </tr>
                    </tbody>
                </table>

                <div class="modal-actions">
                    <button type="submit" class="modal-btn modal-btn-success">
                        <i class="fas fa-check"></i> 保存修改
                    </button>
                    <button type="button" class="modal-btn modal-btn-danger" onclick="closeEditModal()">
                        <i class="fas fa-times"></i> 取消
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
<script>
// 已排约页面特定的JavaScript
document.addEventListener('DOMContentLoaded', function() {
    // 已排约页面的特定功能可以在这里添加
});
// 打开修改约模态框
document.querySelectorAll('.open-edit-modal').forEach(btn => {
    btn.addEventListener('click', function() {
        const appointmentId = this.dataset.appointmentId;
        const scheduledTime = this.dataset.scheduledTime.replace(' ', 'T');
        const destination = this.dataset.destination;
        const loadType = this.dataset.loadType;
        const origin = this.dataset.origin;

        document.getElementById('editModalAppointmentId').value = appointmentId;
        document.getElementById('editModalAppointmentInput').value = appointmentId;
        document.getElementById('editModalScheduledTime').value = scheduledTime;
        document.getElementById('editModalDestination').value = destination;
        document.getElementById('editModalLoadType').value = loadType;
        document.getElementById('editModalOrigin').value = origin;

        document.getElementById('editAppointmentModal').style.display = 'block';
    });
});

// 关闭弹框
function closeEditModal() {
    document.getElementById('editAppointmentModal').style.display = 'none';
}

// 点击空白区域关闭
window.addEventListener('click', function(event) {
    const modal = document.getElementById('editAppointmentModal');
    if (event.target === modal) {
        closeEditModal();
    }
});

// 提交表单
document.getElementById('editAppointmentForm').addEventListener('submit', function(e) {
    if (!confirm('确定保存修改吗？')) {
        e.preventDefault();
        return;
    }
});


</script>