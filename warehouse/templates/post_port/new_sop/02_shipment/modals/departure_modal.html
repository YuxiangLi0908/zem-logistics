<!--确认出库的弹框-->
<div id="confirmDepartureModal" class="modal">
    <div class="modal-content" style="width: 95%; max-width: 1200px; max-height: 700px;">
        <div class="modal-header">
            <h3><i class="fas fa-truck-loading"></i> 确认出库 - <span id="modalFleetNumber"></span></h3>
            <span class="close close-departure">&times;</span>
        </div>
        <div class="modal-body">
            <form id="confirmDepartureForm" method="post">
                {% csrf_token %}
                <input type="hidden" name="step" value="fleet_departure">
                <input type="hidden" name="fleet_number" id="fleetNumber">
                <input type="hidden" name="warehouse" value="{{ warehouse }}">
                <input type="hidden" name="debug_info" id="debugInfo">
                <input type="hidden" name="scheduled_pallet" id="formScheduledPallet">
                <input type="hidden" name="actual_shipped_pallet" id="formActualShippedPallet">
                <input type="hidden" name="plt_ids" id="formPltIds">
                <div id="cargoDataContainer" style="display: none;"></div>
                
                <!-- 出库时间选择 -->
                <div class="modal-form-section" style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                    <label style="font-weight: bold; margin-right: 15px;">
                        <i class="fas fa-calendar-alt"></i> 出库时间:
                    </label>
                    <input type="datetime-local" name="departured_at" id="departuredAt" class="form-input" required>
                </div>

                <!-- 货物信息表格 -->
                <div class="modal-form-section">
                    <h4><i class="fas fa-list"></i> 货物信息</h4>
                    <div style="max-height: 400px; overflow-y: auto;">
                        <table class="modal-table">
                            <thead>
                                <tr>
                                    <th>预约号</th>
                                    <th>目的地</th>
                                    <th>REF ID</th>
                                    <th>FBA ID</th>
                                    <th>柜号</th>
                                    <th>计划板数</th>
                                    <th>实际出库板数</th>
                                    <th>状态</th>
                                </tr>
                            </thead>
                            <tbody id="departureCargoBody">
                                <!-- JS动态填充 -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- 统计信息 -->
                <div style="background: #e9f7ef; padding: 15px; border-radius: 8px; border-left: 4px solid #28a745;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong>板数统计:</strong>
                            <span id="totalScheduledPallets" style="margin: 0 10px;"></span>
                            <i class="fas fa-arrow-right" style="color: #6c757d;"></i>
                            <span id="totalActualPallets" style="margin: 0 10px; font-weight: bold; color: #28a745;"></span>
                        </div>
                        <div id="estWarning" style="display: none; color: #dc3545; font-weight: bold;">
                            <i class="fas fa-exclamation-triangle"></i> 存在未打板货物，请核实！
                        </div>
                    </div>
                </div>

                <div class="modal-actions">
                    <!--
                    <button type="button" class="modal-btn modal-btn-success" onclick="submitFleetDepartureSimple()">
                        <i class="fas fa-check-circle"></i> 确认出库
                    </button>-->
                    <button type="button" class="modal-btn modal-btn-danger" onclick="closeDepartureModal()">
                        <i class="fas fa-times"></i> 取消
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
<style>
#confirmDepartureModal .modal-table td:nth-child(3),
#confirmDepartureModal .modal-table td:nth-child(4) {
    max-width: 160px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}
#confirmDepartureModal .modal-table th:nth-child(5) {
    max-width: 120px;
    min-width: 160px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

/* 可选：表头宽度也保持一致 */
#confirmDepartureModal .modal-table th:nth-child(3),
#confirmDepartureModal .modal-table th:nth-child(4) {
    max-width: 160px;
    min-width: 160px;
}
</style>
<script>
// 出库确认模态框的JavaScript
function openDepartureModal(fleetNumber, fleetData) {
    const modal = document.getElementById('confirmDepartureModal');
    const tbody = document.getElementById('departureCargoBody');
    const fleetNumberInput = document.getElementById('fleetNumber');
    const modalFleetSpan = document.getElementById('modalFleetNumber');

    if (!modal || !tbody) return console.error('Modal elements not found');
    
    if (fleetNumberInput) fleetNumberInput.value = fleetNumber;
    if (modalFleetSpan) modalFleetSpan.textContent = fleetNumber;

    tbody.innerHTML = '';

    let totalPlanned = 0;
    let totalActual = 0;
    let hasEst = false;
    let hasUnfilled = false;
    let hasAnomaly = false; // 标记异常行

    fleetData.shipments.forEach(shipment => {
        const appointment = shipment.appointmentId || '-';
        const destination = shipment.destination || '-';
        (shipment.cargos || []).forEach(cargo => {
            const tr = document.createElement('tr');

            // 预约号
            const apptTd = document.createElement('td');
            apptTd.textContent = appointment;
            tr.appendChild(apptTd);

            // 目的地
            const destTd = document.createElement('td');
            destTd.textContent = destination;
            tr.appendChild(destTd);

            // REF ID
            const refTd = document.createElement('td');
            refTd.textContent = cargo.refIds || '-';
            refTd.title = cargo.refIds || '';
            tr.appendChild(refTd);

            // FBA ID
            const fbaTd = document.createElement('td');
            fbaTd.textContent = cargo.fbaIds || '-';
            fbaTd.title = cargo.fbaIds || '';
            tr.appendChild(fbaTd);

            // 柜号
            const contTd = document.createElement('td');
            contTd.textContent = cargo.containerNo || '-';
            tr.appendChild(contTd);

            // 计划板数
            const planned = (typeof cargo.plannedPallets === 'number') ? cargo.plannedPallets : (parseFloat(cargo.plannedPallets) || 0);
            const labelPart = cargo.palletLabel ? (' ' + cargo.palletLabel) : '';
            const planTd = document.createElement('td');
            planTd.textContent = (planned || planned === 0) ? (planned + labelPart) : '-';
            tr.appendChild(planTd);

            // 实际出库板数（可编辑）
            const actualTd = document.createElement('td');
            const actualInput = document.createElement('input');
            actualInput.type = 'number';
            actualInput.min = 0;
            actualInput.step = 1;
            actualInput.value = (typeof cargo.actualPallets !== 'undefined') ? cargo.actualPallets : planned;
            actualInput.style.width = '70px';
            actualInput.addEventListener('input', () => {
                updateTotalsAndWarning();
            });
            actualTd.appendChild(actualInput);
            tr.appendChild(actualTd);

            // 状态列（根据 pltId / cargoId 决定）
            const statusTd = document.createElement('td');

            // **关键：明确设置两个 dataset 字段**
            tr.dataset.pltId = (cargo.pltId || '').toString();
            tr.dataset.cargoId = (cargo.cargoId || '').toString();
            tr.dataset.planned = (cargo.plannedPallets || 0).toString();
            tr.dataset.palletLabel = (cargo.palletLabel || '').toString();

            // 决定状态：只有 cargoId -> 未打板；只有 pltId -> 已打板；两者都有/都没有 -> 异常
            const hasPlt = Boolean((tr.dataset.pltId || '').trim());
            console.log('hasPlt',hasPlt,tr.dataset.pltId);
            const hasCargoId = Boolean((tr.dataset.cargoId || '').trim());
            console.log('hasCargoId',hasCargoId,tr.dataset.cargoId);

            let statusText = '';
            if (hasPlt && !hasCargoId) {
                statusText = '已打板';
                statusTd.classList.add('status-ok');
            } else if (!hasPlt && hasCargoId) {
                statusText = '未打板';
                statusTd.classList.add('status-warning');
            } else if (hasPlt && hasCargoId) {
                statusText = '异常（双ID）';
                statusTd.classList.add('status-error');
                hasAnomaly = true;
            } else { // !hasPlt && !hasCargoId
                statusText = '异常（无ID）';
                statusTd.classList.add('status-error');
                hasAnomaly = true;
            }
            statusTd.textContent = statusText;
            tr.appendChild(statusTd);

            // 处理 EST 警告
            if (String(cargo.palletLabel || '').toUpperCase() === 'EST') hasEst = true;

            // 统计
            totalPlanned += planned;
            const actualVal = parseFloat(actualInput.value || 0) || 0;
            totalActual += actualVal;
            if (actualVal < planned) hasUnfilled = true;

            tbody.appendChild(tr);
        });
    });

    const totalScheduledElem = document.getElementById('totalScheduledPallets');
    const totalActualElem = document.getElementById('totalActualPallets');
    const estWarning = document.getElementById('estWarning');

    if (totalScheduledElem) totalScheduledElem.textContent = totalPlanned;
    if (totalActualElem) totalActualElem.textContent = totalActual;
    if (estWarning) {
        estWarning.style.display = (hasEst || hasUnfilled) ? 'block' : 'none';
        // 如果存在异常也高亮提示
        if (hasAnomaly) {
            estWarning.style.display = 'block';
            estWarning.textContent = '存在异常 ID 配置（双ID或无ID），请核实！';
        } else {
            estWarning.textContent = '存在未打板货物，请核实！';
        }
    }

    function updateTotalsAndWarning() {
        let tp = 0;
        let ta = 0;
        let anyEst = false;
        let anyUnfilledLocal = false;
        let anyAnomaly = false;
        Array.from(tbody.children).forEach(tr => {
            const plannedNum = parseFloat(tr.dataset.planned || 0) || 0;
            const input = tr.querySelector('input[type="number"]');
            const actualNum = input ? (parseFloat(input.value || 0) || 0) : 0;
            tp += plannedNum;
            ta += actualNum;
            if ((tr.dataset.palletLabel || '').toUpperCase() === 'EST') anyEst = true;
            if (actualNum < plannedNum) anyUnfilledLocal = true;

            // 重新计算状态文字（如果你希望状态随实际板数变化）
            const hasPlt = Boolean((tr.dataset.pltId || '').trim());
            const hasCargoId = Boolean((tr.dataset.cargoId || '').trim());
            console.log('板数内容1是',tr.dataset.pltId);
            console.log('板数内容2是',tr.dataset.cargoId);
            const statusTd = tr.children[tr.children.length - 1];
            if (statusTd) {
                let newStatus = '';
                if (hasPlt && !hasCargoId) newStatus = '已打板';
                
                else if (!hasPlt && hasCargoId) newStatus = '未打板';
                else if (hasPlt && hasCargoId) { newStatus = '异常（双ID）'; anyAnomaly = true; }
                else { newStatus = '异常（无ID）'; anyAnomaly = true; }
                statusTd.textContent = newStatus;
                console.log('newStatus',newStatus);
            }
        });
        if (totalScheduledElem) totalScheduledElem.textContent = tp;
        if (totalActualElem) totalActualElem.textContent = ta;
        if (estWarning) {
            if (anyAnomaly) {
                estWarning.style.display = 'block';
                estWarning.textContent = '存在异常 ID 配置（双ID或无ID），请核实！';
            } else {
                estWarning.style.display = (anyEst || anyUnfilledLocal) ? 'block' : 'none';
                estWarning.textContent = '存在未打板货物，请核实！';
            }
        }
    }

    const closeBtns = modal.querySelectorAll('.close-departure');
    closeBtns.forEach(btn => {
        btn.onclick = function() { modal.style.display = 'none'; };
    });

    modal.addEventListener('click', function(e) {
        if (e.target === modal) modal.style.display = 'none';
    });

    modal.style.display = 'block';
    updateTotalsAndWarning();
}
function closeDepartureModal() {
    const modal = document.getElementById('confirmDepartureModal');
    if (modal) modal.style.display = 'none';
}

function submitFleetDepartureSimple() {
    console.log('submitFleetDepartureSimple called');
    
    const tbody = document.getElementById('departureCargoBody');
    if (!tbody) {
        console.error('找不到出库表格 tbody');
        return alert('找不到出库表格');
    }

    const rows = Array.from(tbody.querySelectorAll('tr'));
    console.log('找到的行数:', rows.length);

    const pltIdsArr = [];
    const scheduledArr = [];
    const actualArr = [];

    rows.forEach((row, index) => {
        console.log(`处理第 ${index} 行:`, row.dataset);
        
        const pltId = (row.dataset.pltId || '').trim();
        console.log(`行 ${index} 的 pltId:`, pltId);
        
        if (pltId) {
            pltIdsArr.push(pltId);
        } else {
            console.warn(`行 ${index} 没有 pltId`);
        }

        const planned = parseFloat(row.dataset.planned || 0);
        scheduledArr.push(planned);

        const actualInput = row.querySelector('input[type="number"]');
        const actual = actualInput ? parseFloat(actualInput.value || 0) : 0;
        actualArr.push(actual);

        console.log(`行 ${index}: pltId=${pltId}, planned=${planned}, actual=${actual}`);
    });

    console.log('收集的数据:', {
        pltIds: pltIdsArr,
        scheduled: scheduledArr,
        actual: actualArr
    });

    const form = document.getElementById('confirmDepartureForm');
    if (!form) {
        console.error('找不到确认出库表单');
        return alert('系统错误：找不到表单');
    }

    const existingInputs = form.querySelectorAll('input[name="plt_ids"], input[name="scheduled_pallet"], input[name="actual_shipped_pallet"]');
    existingInputs.forEach(input => input.remove());

    if (pltIdsArr.length > 0) {
        const pltInput = document.createElement('input');
        pltInput.type = 'hidden';
        pltInput.name = 'plt_ids';
        pltInput.value = pltIdsArr.join(',');
        form.appendChild(pltInput);
        console.log('添加 plt_ids:', pltIdsArr.join(','));
    }

    if (scheduledArr.length > 0) {
        const scheduledInput = document.createElement('input');
        scheduledInput.type = 'hidden';
        scheduledInput.name = 'scheduled_pallet';
        scheduledInput.value = scheduledArr.join(',');
        form.appendChild(scheduledInput);
        console.log('添加 scheduled_pallet:', scheduledArr.join(','));
    }

    if (actualArr.length > 0) {
        const actualInput = document.createElement('input');
        actualInput.type = 'hidden';
        actualInput.name = 'actual_shipped_pallet';
        actualInput.value = actualArr.join(',');
        form.appendChild(actualInput);
        console.log('添加 actual_shipped_pallet:', actualArr.join(','));
    }

    if (pltIdsArr.length === 0) {
        alert('没有找到货物数据，无法出库');
        return;
    }

    console.log('提交表单...');
    form.submit();
}
</script>