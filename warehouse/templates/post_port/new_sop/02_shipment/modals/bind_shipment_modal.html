<!-- 绑定预约模态框 -->
<div id="bindShipmentModal" class="modal">
    <div class="modal-content" style="width: 90%; max-width: 1000px; max-height: 700px;">
        <div class="modal-header">
            <h3><i class="fas fa-link"></i> 绑定预约信息</h3>
            <span class="close">&times;</span>
        </div>
        <div class="modal-body">
            <form id="bindShipmentForm" method="post">
                {% csrf_token %}
                <input type="hidden" name="step" value="bind_group_shipment">
                <input type="hidden" name="suggestion_id" id="modalSuggestionId">
                <input type="hidden" name="cargo_ids" id="modalCargoIds">
                <input type="hidden" name="plt_ids" id="modalPltIds">
                <input type="hidden" name="warehouse" value="{{ warehouse }}">
                <input type="hidden" name="st_type" value="{{ st_type }}">
                <input type="hidden" name="operation_type" id="operationType" value="bind">

                <!-- FTL 表单 -->
                <div class="modal-form-section">
                    <h4><i class="fas fa-truck"></i> 预约信息</h4>
                    <table class="modal-table">
                        <thead>
                            <tr>
                                <th>预约类型</th>
                                <th>预约账号</th>
                                <th>预约号</th>
                                <th>Scheduled Time</th>
                                <th>发货仓库</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>
                                    <select name="shipment_type" id="shipment-type-select" class="form-select">
                                        {% for k, v in shipment_type_options.items %}
                                            <option value="{{ v }}">{{ k }}</option>
                                        {% endfor %}
                                    </select>
                                </td>
                                <td>
                                    <select name="shipment_account" id="shipment-account-select" class="form-select">
                                        {% for k, v in account_options.items %}
                                            <option value="{{ v }}">{{ k }}</option>
                                        {% endfor %}
                                    </select>
                                </td>
                                <td>
                                    <input type="text" name="appointment_id" id="appointment_id" class="form-input" required>
                                </td>
                                <td>
                                    <input type="datetime-local" id="scheduled-time-input" name="shipment_appointment" class="form-input" required>
                                </td>
                                <td>
                                    <select name="origin" id="origin-select-1" class="form-select">
                                        {% for k, v in warehouse_options.items %}
                                            <option value="{{ v }}">{{ k }}</option>
                                        {% endfor %}
                                    </select>
                                </td>
                            </tr>
                            <tr>
                                <th>装车类型</th>
                                <th>备注</th>
                                <th>目的地</th>
                                <th>地址</th>
                                <th>shipment ID</th>
                            </tr>
                            <tr>
                                <td>
                                    <select name="load_type" id="load-type-select" class="form-select">
                                        {% for k, v in load_type_options %}
                                            <option value="{{ v }}">{{ k }}</option>
                                        {% endfor %}
                                    </select>
                                </td>
                                <td>
                                    <input type="text" name="note" id="note" class="form-input">
                                </td>
                                <td>
                                    <input type="text" name="destination" id="ftl-destination" class="form-input" required>
                                </td>
                                <td>
                                    <input type="text" name="address" id="address_detail" class="form-input">
                                </td>
                                <td>
                                    <input type="text" name="shipment_cargo_id" id="shipment_cargo_id" class="form-input">
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <div id="cargoSelectionArea" class="modal-form-section">
                    <h4><i class="fas fa-box"></i> 选择要绑定/预约的货物</h4>
                    <table class="modal-table">
                        <thead>
                            <tr>
                                <th style="width: 50px;">
                                    <input type="checkbox" id="selectAllCargos">
                                </th>
                                <th>REF ID</th>
                                <th>FBA ID</th>
                                <th>柜号</th>
                                <th>入仓时间</th>
                            </tr>
                        </thead>
                        <tbody id="cargoSelectionBody">
                            <!-- JS 动态生成 -->
                        </tbody>
                    </table>
                </div>

                <div class="modal-actions">
                    <button type="submit" class="modal-btn modal-btn-success">
                        <i class="fas fa-check"></i> 确认绑定
                    </button>
                    <button type="button" class="modal-btn modal-btn-danger" onclick="closeBindModal()">
                        <i class="fas fa-times"></i> 取消
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
    backdrop-filter: blur(2px);
}

.modal-content {
    background-color: #fefefe;
    margin: auto;
    padding: 0;
    border: none;
    border-radius: 12px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    max-height: 85vh;
    overflow-y: auto;
    animation: modalSlideIn 0.3s ease-out;
}

@keyframes modalSlideIn {
    from {
        opacity: 0;
        transform: translate(-50%, -60%);
    }
    to {
        opacity: 1;
        transform: translate(-50%, -50%);
    }
}

.modal-header {
    background: linear-gradient(135deg, var(--secondary-color), #4a6491);
    color: white;
    padding: 20px 25px;
    border-radius: 12px 12px 0 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-header h3 {
    margin: 0;
    font-size: 1.3rem;
    font-weight: 600;
}

.modal-header .close {
    color: white;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
    opacity: 0.8;
    transition: opacity 0.3s;
}

.modal-header .close:hover {
    opacity: 1;
}

.modal-body {
    padding: 25px;
}

.modal-form-section {
    margin-bottom: 20px;
}

.modal-form-section h4 {
    color: var(--secondary-color);
    margin-bottom: 15px;
    font-size: 1.1rem;
    border-bottom: 2px solid var(--light-color);
    padding-bottom: 8px;
}

.modal-table {
    width: 100%;
    border-collapse: collapse;
    margin: 15px 0;
    font-size: 0.9rem;
}

.modal-table th {
    background-color: #f8f9fa;
    padding: 12px 8px;
    text-align: left;
    font-weight: 600;
    color: var(--secondary-color);
    border-bottom: 2px solid #e9ecef;
}

.modal-table td {
    padding: 10px 8px;
    border-bottom: 1px solid #f1f3f4;
}

.modal-table tr:hover {
    background-color: #f8f9fa;
}

.modal-actions {
    display: flex;
    justify-content: center;
    gap: 15px;
    margin-top: 25px;
    padding-top: 20px;
    border-top: 1px solid #e9ecef;
}

.modal-btn {
    padding: 12px 25px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
    font-size: 0.95rem;
    transition: all 0.3s ease;
    min-width: 120px;
}

.modal-btn-success {
    background: var(--success-color);
    color: white;
}

.modal-btn-success:hover {
    background: #27ae60;
    transform: translateY(-1px);
}

.modal-btn-danger {
    background: var(--danger-color);
    color: white;
}

.modal-btn-danger:hover {
    background: #c0392b;
    transform: translateY(-1px);
}

.modal-btn-primary {
    background: var(--primary-color);
    color: white;
}

.modal-btn-primary:hover {
    background: #2980b9;
    transform: translateY(-1px);
}

.form-select, .form-input {
    width: 100%;
    padding: 8px 12px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 0.9rem;
}

.form-select:focus, .form-input:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
}
</style>

<script>
// 绑定预约模态框的JavaScript
document.querySelectorAll('.open-bind-modal').forEach(btn => {
    btn.addEventListener('click', function() {
        const suggestionId = this.dataset.suggestionId;
        const hasAppointment = this.dataset.hasAppointment === '1';
        const appointmentId = this.dataset.appointmentId || '';
        const shipmentType = this.dataset.shipmentType || '';
        const loadType = this.dataset.loadType || '';
        const destination = this.dataset.destination || '';
        const deliveryMethod = this.dataset.deliveryMethod || '';
        const scheduledTime = this.dataset.scheduledTime || '';
        const shipmentAccount = this.dataset.shipmentAccount || '';
        const origin = this.dataset.origin || '';
        const note = this.dataset.note || '';
        const addressDetail = this.dataset.addressDetail || '';
        const shipmentCargoId = this.dataset.shipmentCargoId || '';
        const operationType = this.dataset.operationType || 'bind';

        let groupRows;
        if (suggestionId) {
            groupRows = document.querySelectorAll(`tr[data-suggestion-id="${suggestionId}"]`);
        } else {
            const appointmentRow = this.closest('tr');
            groupRows = getRowsByAppointment(appointmentRow, appointmentId);
        }

        const cargos = [];
        groupRows.forEach(row => {
            const containerTd = row.querySelector('td.container-no-col') || row.querySelector('.cns-col');
            const offload_timeTd = row.querySelector('td.offload-time-col');
            
            cargos.push({
                cargo_id: row.dataset.cargoId || '',
                plt_ids: row.dataset.pltId || '',
                ref_ids: row.querySelector('.ref-ids-col')?.innerText.trim() || '-',
                fba_ids: row.querySelector('.fba-ids-col')?.innerText.trim() || '-',
                container_no: containerTd?.textContent.trim().replace(/\s+/g, '\n') || '-',
                offload_time: offload_timeTd ? offload_timeTd.textContent.trim() : '无入仓时间',
            });
        });

        openBindModal({
            suggestionId,
            cargos,
            hasAppointment,
            appointmentId,
            loadType,
            destination,
            deliveryMethod,
            scheduledTime,
            shipmentAccount,
            origin,
            note,
            shipmentType,
            addressDetail,
            shipmentCargoId,
            operationType
        });
    });
});

function getRowsByAppointment(startRow, appointmentId) {
    const rows = [startRow];
    
    let headerRow = startRow;
    while (headerRow && !headerRow.querySelector('td:first-child[rowspan]')) {
        headerRow = headerRow.previousElementSibling;
    }
    
    if (!headerRow) {
        headerRow = startRow;
    }
    
    const firstTd = headerRow.querySelector('td:first-child');
    const rowspan = firstTd ? parseInt(firstTd.getAttribute('rowspan')) || 1 : 1;
    
    let currentIndex = Array.from(headerRow.parentNode.children).indexOf(headerRow);
    const allRows = Array.from(headerRow.parentNode.children);
    
    for (let i = 1; i < rowspan; i++) {
        const nextRow = allRows[currentIndex + i];
        if (nextRow) {
            rows.push(nextRow);
        }
    }
    
    return rows;
}

function openBindModal(data) {
    const {
        suggestionId, cargos, hasAppointment,
        appointmentId, loadType, destination, deliveryMethod,
        scheduledTime, shipmentAccount, origin, note, addressDetail,shipmentCargoId,shipmentType,
        operationType = 'bind'
    } = data;
    
    document.getElementById('modalSuggestionId').value = suggestionId || '';
    document.getElementById('operationType').value = operationType;

    const modalHeader = document.querySelector('#bindShipmentModal .modal-header h3');
    const submitButton = document.querySelector('#bindShipmentModal .modal-btn-success');
    const cargoSelectionTitle = document.querySelector('#cargoSelectionArea h4');
    
    if (operationType === 'remove_po') {
        modalHeader.innerHTML = '<i class="fas fa-minus-circle"></i> 删除PO';
        submitButton.innerHTML = '<i class="fas fa-check"></i> 确认减掉';
        cargoSelectionTitle.innerHTML = '<i class="fas fa-box"></i> 选择要删除的PO'; 
    } else {
        modalHeader.innerHTML = '<i class="fas fa-link"></i> 绑定预约信息';
        submitButton.innerHTML = '<i class="fas fa-check"></i> 确认绑定';
        cargoSelectionTitle.innerHTML = '<i class="fas fa-box"></i> 选择要绑定/预约的PO';
    }

    const shipmentTypeSelect = document.getElementById('shipment-type-select');
    if (shipmentTypeSelect && shipmentType) {
        shipmentTypeSelect.value = shipmentType;
    }

    document.getElementById('ftl-destination').value = destination;
    document.getElementById('address_detail').value = addressDetail;
    document.getElementById('shipment_cargo_id').value = shipmentCargoId;
    document.getElementById('note').value = note;
    document.getElementById('origin-select-1').value = origin;

    if (loadType) {
        document.getElementById('load-type-select').value = loadType;
    } else {
        document.getElementById('load-type-select').value = deliveryMethod;
    }

    if (hasAppointment) {
        document.getElementById('appointment_id').value = appointmentId;
        if (scheduledTime) {
            document.getElementById('scheduled-time-input').value = scheduledTime.replace(' ', 'T');
        }
    } else {
        document.getElementById('appointment_id').value = '';
        document.getElementById('scheduled-time-input').value = '';
    }

    if (shipmentAccount) {
        const select = document.getElementById('shipment-account-select');
        for (let i = 0; i < select.options.length; i++) {
            if (select.options[i].value === shipmentAccount) {
                select.selectedIndex = i;
                break;
            }
        }
    }

    const tbody = document.getElementById('cargoSelectionBody');
    tbody.innerHTML = '';

    let allCargoIds = [];
    let allPltIds = [];
    cargos.forEach(c => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td><input type="checkbox" class="cargo-checkbox" data-cargo-id="${c.cargo_id}" data-plt-id="${c.plt_ids}" checked></td>
            <td>${c.ref_ids}</td>
            <td>${c.fba_ids}</td>
            <td>${c.container_no}</td>
            <td>${c.offload_time}</td>
        `;
        tbody.appendChild(tr);
        if (c.cargo_id && c.cargo_id.trim() !== '') allCargoIds.push(c.cargo_id);
        if (c.plt_ids && c.plt_ids.trim() !== '') allPltIds.push(c.plt_ids);
    });

    document.getElementById('modalCargoIds').value = allCargoIds.join(',');
    document.getElementById('modalPltIds').value = allPltIds.join(',');

    initializeCargoSelection();

    document.getElementById('bindShipmentModal').style.display = 'block';
}

function initializeCargoSelection() {
    const selectAll = document.getElementById('selectAllCargos');
    const checkboxes = document.querySelectorAll('.cargo-checkbox');
    
    const newSelectAll = selectAll.cloneNode(true);
    selectAll.parentNode.replaceChild(newSelectAll, selectAll);
    
    newSelectAll.checked = checkboxes.length > 0 && Array.from(checkboxes).every(cb => cb.checked);
    
    newSelectAll.addEventListener('click', function() {
        const allCheckboxes = document.querySelectorAll('.cargo-checkbox');
        allCheckboxes.forEach(cb => cb.checked = this.checked);
        updateHiddenIds();
    });

    checkboxes.forEach(checkbox => {
        const newCheckbox = checkbox.cloneNode(true);
        checkbox.parentNode.replaceChild(newCheckbox, checkbox);
        
        newCheckbox.addEventListener('change', function() {
            updateHiddenIds();
            const allCheckboxes = document.querySelectorAll('.cargo-checkbox');
            const allChecked = Array.from(allCheckboxes).every(cb => cb.checked);
            const someChecked = Array.from(allCheckboxes).some(cb => cb.checked);
            
            newSelectAll.checked = allChecked;
            newSelectAll.indeterminate = !allChecked && someChecked;
        });
    });
    
    updateHiddenIds();
}

function updateHiddenIds() {
    const selected = Array.from(document.querySelectorAll('.cargo-checkbox:checked'));
    const cargoIds = selected.map(cb => cb.dataset.cargoId).filter(id => id && id.trim() !== '');
    const pltIds = selected.map(cb => cb.dataset.pltId).filter(id => id && id.trim() !== '');
    
    document.getElementById('modalCargoIds').value = cargoIds.join(',');
    document.getElementById('modalPltIds').value = pltIds.join(',');
}

function closeBindModal() {
    document.getElementById('bindShipmentModal').style.display = 'none';
}

document.querySelector('#bindShipmentModal .close').addEventListener('click', closeBindModal);

window.addEventListener('click', function (event) {
    const modal = document.getElementById('bindShipmentModal');
    if (event.target === modal) {
        closeBindModal();
    }
});

document.getElementById('bindShipmentForm').addEventListener('submit', function(e) {
    e.preventDefault();

    const selected = Array.from(document.querySelectorAll('.cargo-checkbox:checked'));
    if (selected.length === 0) {
        alert('请至少选择一个PO！');
        return;
    }

    const cargoIds = selected.map(cb => cb.dataset.cargoId).filter(id => id && id.trim() !== '');
    const pltIds = selected.map(cb => cb.dataset.pltId).filter(id => id && id.trim() !== '');

    document.getElementById('modalCargoIds').value = cargoIds.join(',');
    document.getElementById('modalPltIds').value = pltIds.join(',');

    const shipmentCargoId = document.getElementById('shipment_cargo_id').value;
    const operationType = document.getElementById('modalSuggestionId').value;
    const confirmMessage = operationType === 'remove_po' ? '确定要减掉选中的PO吗？' : '确定提交所选PO吗？';

    if (confirm(confirmMessage)) {
        const btn = this.querySelector('button[type="submit"]');
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 处理中...';
        btn.disabled = true;
        this.submit();
    }
});
</script>