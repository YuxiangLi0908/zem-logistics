<!-- 待出库标签页 -->
 <style>
    .fleet-number-cell:hover {
        background-color: #e8f4fd !important;
    }

    .fleet-number-cell:hover strong {
        color: #2980b9 !important;
    }
 </style>
<div class="content-section" id="ready-section">
    <div class="search-box">
        <div style="display: flex; gap: 10px; flex: 1; align-items: center;">
            <input type="text" class="search-input" placeholder="搜索车次号、预约号..." id="readySearch">
            <button class="search-btn" id="searchReadyBtn">
                <i class="fas fa-search"></i> 搜索
            </button>
        </div>
    </div>

    <div class="table-container">
        <table class="data-table">
            <thead>
                <tr>
                    <th>车次号</th>
                    <th>提货时间</th>
                    <th>预约号</th>
                    <th>目的地</th>
                    <th>柜号</th>
                    <th>REF ID</th>
                    <th>FBA ID</th>
                    <th>板数</th>
                    <th>CBM</th>
                    <th>加塞</th>
                    <th>出库</th>
                </tr>
            </thead>
            <tbody>
                {% for fleet_group in ready_to_ship_data %}
                    {% with fleet_rowspan=fleet_group.total_cargos %}
                        {% for shipment_id, shipment in fleet_group.shipments.items %}
                            {% with shipment_rowspan=shipment.cargos|length|default:0 %}
                                {% if shipment_rowspan == 0 %}
                                    {% with shipment_rowspan=1 %}
                                        <tr>
                                            {% if forloop.parentloop.first and forloop.first or fleet_rowspan == 1 %}
                                                <td rowspan="{{ fleet_rowspan }}" style="vertical-align: middle; background-color: #f8f9fa; cursor: pointer;" 
                                                    class="fleet-number-cell" 
                                                    data-fleet-number="{{ fleet_group.fleet_number }}"
                                                    data-third-party-address="{{ fleet_group.third_party_address }}"
                                                    data-pickup-number="{{ fleet_group.pickup_number }}"
                                                    data-motor-carrier-number="{{ fleet_group.motor_carrier_number }}"
                                                    data-license-plate="{{ fleet_group.license_plate }}"
                                                    data-dot-number="{{ fleet_group.dot_number }}"
                                                    data-appointment-datetime="{{ fleet_group.appointment_datetime }}">
                                                    <strong style="color: #3498db; text-decoration: underline;">{{ fleet_group.fleet_number }}</strong>
                                                    <br>
                                                    {% if fleet_group.is_virtual %}
                                                    <small style="color: #7f8c8d; font-size: 10px;">虚拟车次待编辑</small>
                                                    {% endif %}
                                                </td>
                                                <td rowspan="{{ fleet_rowspan }}" style="vertical-align: middle; background-color: #f8f9fa;">
                                                    {{ fleet_group.appointment_datetime|date:"Y-m-d" }}
                                                </td>                                        
                                            {% endif %}
                                            
                                            <td rowspan="{{ shipment_rowspan }}" style="vertical-align: middle; background-color: #f8f9fa;">
                                                {{ shipment.appointment_id }}
                                            </td>
                                            <td rowspan="{{ shipment_rowspan }}" style="vertical-align: middle; background-color: #f8f9fa;">
                                                {{ shipment.destination }}
                                            </td>
                                            <td colspan="5" style="text-align:center; color:#999;">暂无货物</td>
                                            <td rowspan="{{ shipment_rowspan }}" style="vertical-align: middle;">
                                                <form method="post" action="">
                                                    {% csrf_token %}
                                                    <input type="hidden" name="destination" value="{{ shipment.destination }}">
                                                    <input type="hidden" name="add_pallet_ISA" value="{{ shipment.appointment_id }}">
                                                    <input type="hidden" name="warehouse" value="{{ warehouse }}">
                                                    <input type="hidden" name="step" value="add_pallet">
                                                    <input type="hidden" name="tab" value="{{ current_tab }}"> 

                                                    <button type="submit" class="action-btn btn-primary">
                                                        <i class="fas fa-plus"></i> 加塞
                                                    </button>
                                                </form>
                                            </td>
                                            {% if forloop.parentloop.first and forloop.first %}
                                                <td rowspan="{{ fleet_rowspan }}">
                                                    <button class="action-btn btn-success" onclick="confirmFleetDeparture('{{ fleet_group.fleet_number }}')">出库</button>
                                                </td>
                                            {% endif %}
                                        </tr>
                                    {% endwith %}
                                {% else %}
                                    {% for cargo in shipment.cargos %}
                                        <tr data-plt-id="{{ cargo.plt_ids }}" data-cargo-id="{{ cargo.cargo_ids }}">
                                            {% if forloop.first and forloop.parentloop.first %}
                                                <td rowspan="{{ fleet_rowspan }}" style="vertical-align: middle; background-color: #f8f9fa; cursor: pointer;" 
                                                    class="fleet-number-cell" 
                                                    data-fleet-number="{{ fleet_group.fleet_number }}"
                                                    data-third-party-address="{{ fleet_group.third_party_address }}"
                                                    data-pickup-number="{{ fleet_group.pickup_number }}"
                                                    data-motor-carrier-number="{{ fleet_group.motor_carrier_number }}"
                                                    data-license-plate="{{ fleet_group.license_plate }}"
                                                    data-dot-number="{{ fleet_group.dot_number }}"
                                                    data-appointment-datetime="{{ fleet_group.appointment_datetime }}">
                                                    <strong style="color: #3498db; text-decoration: underline;">{{ fleet_group.fleet_number }}</strong>
                                                    <br>
                                                    {% if fleet_group.is_virtual%}
                                                    <small style="color: #7f8c8d; font-size: 10px;">虚拟车次待编辑</small>
                                                    {% endif %}
                                                </td> 
                                                <td rowspan="{{ fleet_rowspan }}" style="vertical-align: middle; background-color: #f8f9fa;">
                                                    {{ fleet_group.appointment_datetime|date:"Y-m-d" }}
                                                </td> 
                                            {% endif %}

                                            {% if forloop.first %}
                                                <td rowspan="{{ shipment_rowspan }}" style="vertical-align: middle; background-color: #f8f9fa;">
                                                    {{ shipment.appointment_id }}
                                                </td>
                                                <td rowspan="{{ shipment_rowspan }}" style="vertical-align: middle; background-color: #f8f9fa;">
                                                    {{ shipment.destination }}
                                                </td>
                                            {% endif %}

                                            <td class="cns-col">{{ cargo.cns|linebreaksbr }}</td>
                                            <td class="ref-ids-col" data-full="{{ cargo.ref_ids|default:'' }}">{{ cargo.ref_ids|default:"-"|truncatechars:20 }}</td>
                                            <td class="fba-ids-col" data-full="{{ cargo.fba_ids|default:'' }}">{{ cargo.fba_ids|default:"-"|truncatechars:20 }}</td>
                                            <td>
                                                {% if cargo.label == "ACT" %}
                                                    {{ cargo.total_n_pallet_act|default:0 }}
                                                {% elif cargo.label == "EST" %}
                                                    {{ cargo.total_n_pallet_est|default:0 }}
                                                {% else %}
                                                    0
                                                {% endif %}
                                            </td>
                                            <td>{{ cargo.total_cbm|default:0 }}</td>

                                            {% if forloop.first %}
                                                <td rowspan="{{ shipment_rowspan }}" style="vertical-align: middle;">
                                                    <form method="post" action="">
                                                        {% csrf_token %}
                                                        <input type="hidden" name="destination" value="{{ shipment.destination }}">
                                                        <input type="hidden" name="add_pallet_ISA" value="{{ shipment.appointment_id }}">
                                                        <input type="hidden" name="warehouse" value="{{ warehouse }}">
                                                        <input type="hidden" name="step" value="add_pallet">
                                                        <input type="hidden" name="tab" value="{{ current_tab }}"> 

                                                        <button type="submit" class="action-btn btn-primary">
                                                            <i class="fas fa-plus"></i> 加塞
                                                        </button>
                                                    </form>
                                                </td>
                                            {% endif %}

                                            {% if forloop.first and forloop.parentloop.first %}
                                                <td rowspan="{{ fleet_rowspan }}">
                                                    <button class="action-btn btn-success" onclick="confirmFleetDeparture('{{ fleet_group.fleet_number }}')">出库</button>
                                                </td>
                                            {% endif %}
                                        </tr>
                                    {% endfor %}
                                {% endif %}
                            {% endwith %}
                        {% endfor %}
                    {% endwith %}
                {% empty %}
                    <tr>
                        <td colspan="10" style="text-align:center; padding:20px;">暂无待出库货物</td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
// 待出库页面特定的JavaScript
function confirmFleetDeparture(fleetNumber) {
    const fleetData = collectFleetData(fleetNumber);
    if (!fleetData || !fleetData.shipments || fleetData.shipments.length === 0) {
        alert('未找到车次数据或车次下没有货物');
        return;
    }
    openDepartureModal(fleetNumber, fleetData);
}

function collectFleetData(fleetNumber) {
    const fleetData = { fleetNumber, shipments: [] };
    const allRows = Array.from(document.querySelectorAll('#ready-section tbody tr'));

    let collecting = false;
    let currentShipment = null;
    let currentAppointmentId = null;

    allRows.forEach((row, i) => {
        const tds = Array.from(row.querySelectorAll('td'));
        const tcount = tds.length;
        const firstText = (tds[0]?.textContent || '').trim();

        if (firstText === fleetNumber) {
            collecting = true;
        } else if (collecting && firstText && firstText.startsWith('F') && firstText !== fleetNumber && /^[A-Z]{1,3}\d{4,}$/.test(firstText)) {
            collecting = false;
        }

        if (!collecting) return;
        if (tcount === 0) return;

        let appointmentId = null;
        let destination = null;
        let containerNo = null;
        let refIds = null;
        let fbaIds = null;
        let rawPalletText = '';
        let cbmText = '0';

        if (tcount >= 8) {
            appointmentId = (tds[2]?.textContent || '').trim() || currentAppointmentId || '-';
            destination = (tds[3]?.textContent || '').trim() || (currentShipment?.destination ?? '-');
            containerNo = (tds[4]?.textContent || '').trim() || '-';
            refIds = (tds[5]?.textContent || '').trim() || '-';
            fbaIds = (tds[6]?.textContent || '').trim() || '-';
            rawPalletText = (tds[7]?.textContent || '').trim() || '';
            cbmText = (tds[8]?.textContent || '').trim() || '0';
        } else if (tcount >= 5) {
            appointmentId = currentAppointmentId || '-';
            destination = (currentShipment?.destination) || '-';
            containerNo = (tds[0]?.textContent || '').trim() || '-';
            refIds = (tds[1]?.textContent || '').trim() || '-';
            fbaIds = (tds[2]?.textContent || '').trim() || '-';
            rawPalletText = (tds[3]?.textContent || '').trim() || '';
            cbmText = (tds[4]?.textContent || '').trim() || '0';
        } else {
            return;
        }

        let plannedPallets = 0;
        if (rawPalletText) {
            const cleaned = rawPalletText.replace(/[^\d.\-]/g, '');
            const num = parseFloat(cleaned);
            plannedPallets = isNaN(num) ? 0 : num;
        }
        let palletLabel = '';
        if (/ACT/i.test(rawPalletText)) palletLabel = 'ACT';
        else if (/EST/i.test(rawPalletText)) palletLabel = 'EST';

        if (appointmentId && appointmentId !== currentAppointmentId) {
            if (currentShipment) fleetData.shipments.push(currentShipment);
            currentShipment = { appointmentId, destination, cargos: [] };
            currentAppointmentId = appointmentId;
        }

        if (!currentShipment) {
            currentShipment = { appointmentId: (appointmentId || '-'), destination: (destination || '-'), cargos: [] };
            currentAppointmentId = appointmentId || '-';
        }

        const pltId = (row.dataset.pltId || '').trim();
        const cargoIdRaw = (row.dataset.cargoId || '').trim();

        if (!pltId && !cargoIdRaw) {
            console.warn(`row ${i} has no pltId and no cargoId — will still push but consider fixing template to include data-cargo-id/data-plt-id`);
        }

        const unifiedId = pltId || cargoIdRaw || '';

        currentShipment.cargos.push({
            containerNo: containerNo,
            refIds: refIds,
            fbaIds: fbaIds,
            plannedPallets: plannedPallets,
            palletLabel: palletLabel,
            actualPallets: plannedPallets,
            cbm: cbmText || '0',
            cargoId: unifiedId,
            pltId: pltId,
            rawCargoId: cargoIdRaw
        });
    });

    if (currentShipment) fleetData.shipments.push(currentShipment);
    return fleetData;
}
</script>