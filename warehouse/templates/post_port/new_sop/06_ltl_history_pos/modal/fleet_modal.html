<!-- fleet_modal.html -->
<div id="fleetModal" class="modal">
  <div class="modal-content" style="width: 90%; max-width: 1200px; min-width: 800px;">

    <div id="fleetModalBody" style="padding-top: 10px;">
        <div style="border-radius: 12px; padding: 20px; margin-top: 10px;">
            <form method="post" action="" style="width: 100%;" onsubmit="showLoadingBar()">
                {% csrf_token %}
                <!-- 添加隐藏字段 -->
                <input type="hidden" name="step" id="fleetModalStep" value="fleet_confirmation">
                <input type="hidden" name="fleet_number" id="fleetModalFleetNumber">
                <input type="hidden" name="selected_ids" id="fleetModalSelectedAppointments">
                <input type="hidden" name="warehouse" value="{{ warehouse }}">
                <input type="hidden" name="page" value="arm_appointment">
                <input type="hidden" name="active_tab" value="scheduled">
                
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h4 style="color: var(--secondary-color); margin: 0;">
                        <i class="fas fa-truck-loading"></i> 出库批次信息
                    </h4>
                    <div>
                        <span class="close-btn" onclick="closeFleetModal()" style="width: 35px; height: 35px; background: #e74c3c; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 22px; font-weight: bold; cursor: pointer; box-shadow: 0 3px 10px rgba(231, 76, 60, 0.3); transition: all 0.3s ease;">&times;</span>
                    </div>
                </div>

                <!-- 车辆信息表格 -->
                <div class="table-container" style="margin-bottom: 20px;">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th colspan="3" style="text-align: center;">车辆信息</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td style="width: 33%;">
                                    <label style="font-size: 0.8rem; font-weight: 600; color: var(--secondary-color); display: block; margin-bottom: 5px;">carrier</label>
                                    <select name="carrier" id="fleetModalCarrier" style="font-size: 13px; width: 100%; padding: 5px;">
                                        {% for k, v in carrier_options.items %}
                                        <option value="{{ v }}">{{ k }}</option>
                                        {% endfor %}
                                    </select>
                                </td>
                                <td style="width: 33%;">
                                    <label style="font-size: 0.8rem; font-weight: 600; color: var(--secondary-color); display: block; margin-bottom: 5px;">3rd Party Address</label>
                                    <input type="text" name="third_party_address" id="fleetModalThirdPartyAddress" class="table-input" style="width: 100%;">
                                </td>
                                <td style="width: 33%;">
                                    <label style="font-size: 0.8rem; font-weight: 600; color: var(--secondary-color); display: block; margin-bottom: 5px;">PickUp Number</label>
                                    <input type="text" name="pickup_number" id="fleetModalPickupNumber" class="table-input" style="width: 100%;">
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    <label style="font-size: 0.8rem; font-weight: 600; color: var(--secondary-color); display: block; margin-bottom: 5px;">车牌号</label>
                                    <input type="text" name="license_plate" id="fleetModalLicensePlate" class="table-input" style="width: 100%;">
                                </td>
                                <td>
                                    <label style="font-size: 0.8rem; font-weight: 600; color: var(--secondary-color); display: block; margin-bottom: 5px;">MC Number</label>
                                    <input type="text" name="motor_carrier_number" id="fleetModalMotorCarrierNumber" class="table-input" style="width: 100%;">
                                </td>
                                <td>
                                    <label style="font-size: 0.8rem; font-weight: 600; color: var(--secondary-color); display: block; margin-bottom: 5px;">DOT Number</label>
                                    <input type="text" name="dot_number" id="fleetModalDotNumber" class="table-input" style="width: 100%;">
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    <label style="font-size: 0.8rem; font-weight: 600; color: var(--secondary-color); display: block; margin-bottom: 5px;">提货时间</label>
                                    <input type="datetime-local" name="appointment_datetime" id="fleetModalAppointmentDatetime" class="table-input" style="width: 100%;">
                                </td>
                                <td>
                                    <label style="font-size: 0.8rem; font-weight: 600; color: var(--secondary-color); display: block; margin-bottom: 5px;">备注</label>
                                    <input type="text" name="note" id="fleetModalNote" class="table-input" style="width: 100%;">
                                </td>
                                <td>
                                    <label style="font-size: 0.8rem; font-weight: 600; color: var(--secondary-color); display: block; margin-bottom: 5px;">费用</label>
                                    <input type="number" name="fleet_cost" id="fleetCost" class="table-input" style="width: 100%;" step="0.01" min="0">
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            
                <div style="display: flex; justify-content: space-between; align-items: center; margin: 25px 0 15px 0;">
                    <h4 style="color: var(--secondary-color); margin: 0;">
                        <i class="fas fa-list-alt"></i> 预约批次
                    </h4>
                    <button type="submit" class="action-btn btn-success" id="fleetModalConfirmBtn">
                        <i class="fas fa-check"></i> 确认排车
                    </button>
                </div>
            </form>

            <div class="table-container" style="max-height: 300px;">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>预约批次</th>
                            <th>唛头</th>
                            <th>柜号</th>
                            <th>目的地</th>                           
                            <th>Scheduled Time</th>                          
                            <th>总CBM</th>
                            <th>总卡板数</th>
                            <th>备注</th>
                        </tr>
                    </thead>
                    <tbody id="fleetShipmentTableBody">
                        <!-- 这里用JS动态插入选中的批次 -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
  </div>
</div>

<script>
    // 排车弹框相关的JavaScript函数
    function closeFleetModal() {
        document.getElementById("fleetModal").style.display = "none";
    }

    function showLoadingBar() {
        const buttons = document.querySelectorAll('button');
        buttons.forEach(btn => {
            if (btn.innerHTML.includes('fa-check')) {
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 处理中...';
                btn.disabled = true;
            }
        });
    }

    // 行背景切换
    function toggleRowBackground(checkbox) {
        const row = checkbox.closest('tr');
        if (checkbox.checked) {
            row.style.backgroundColor = '#e8f5e9';
        } else {
            row.style.backgroundColor = '';
        }
    }

    // 辅助函数：处理None和空值
    function formatValue(value) {
        if (!value || value === 'None' || value === 'null' || value === 'undefined') {
            return '';
        }
        return value;
    }

    // 确认排车功能（保持原有逻辑，但不使用）
    function openFleetModal() {
        // 这个函数现在不会被待出库页面调用，保持原样
        const checkboxes = document.querySelectorAll('#scheduled-section input[name="is_appointment_added"]:checked');
        if (checkboxes.length === 0) {
            alert("请先选择至少一条待排车批次！");
            return;
        }
        
        // ... 原有逻辑保持不变 ...
    }
    
    // 为待出库页面定制的打开弹框函数
    function openFleetModalForReadyShip(clickedElement) {
        // 从点击的元素获取车次信息
        const fleetNumber = clickedElement.dataset.fleetNumber || '';
        const thirdPartyAddress = formatValue(clickedElement.dataset.thirdPartyAddress);
        const pickupNumber = formatValue(clickedElement.dataset.pickupNumber);
        const motorCarrierNumber = formatValue(clickedElement.dataset.motorCarrierNumber);
        const licensePlate = formatValue(clickedElement.dataset.licensePlate);
        const dotNumber = formatValue(clickedElement.dataset.dotNumber);
        const appointmentDatetime = formatValue(clickedElement.dataset.appointmentDatetime);
        const carrier = formatValue(clickedElement.dataset.carrier);
        const fleetType = formatValue(clickedElement.dataset.fleetType);
        const fleetCostValue = clickedElement.dataset.fleetCost;
        const fleetCost = (fleetCostValue && parseFloat(fleetCostValue) > 0) ? parseFloat(fleetCostValue) : '';
        
        console.log('打开弹框，车次号:', fleetNumber);
        
        // 获取fleetModal元素
        const fleetModal = document.getElementById('fleetModal');
        if (!fleetModal) {
            console.error('找不到fleetModal元素');
            alert('弹框元素未找到，请检查页面是否引用了fleet_modal.html');
            return;
        }
        
        // 设置表单字段，使用formatValue处理空值
        document.getElementById('fleetModalThirdPartyAddress').value = thirdPartyAddress;
        document.getElementById('fleetModalPickupNumber').value = pickupNumber;
        document.getElementById('fleetModalMotorCarrierNumber').value = motorCarrierNumber;
        document.getElementById('fleetModalLicensePlate').value = licensePlate;
        document.getElementById('fleetModalDotNumber').value = dotNumber;
        document.getElementById('fleetModalAppointmentDatetime').value = appointmentDatetime;
        document.getElementById('fleetModalCarrier').value = carrier;
        document.getElementById('fleetModalFleetNumber').value = fleetNumber;
        document.getElementById('fleetCost').value = fleetCost;
        
        // 设置费用输入框的占位符
        const fleetCostInput = document.getElementById('fleetCost');
        if (fleetCostInput) {
            fleetCostInput.placeholder = fleetType.includes('自提') ? '出库费' : '自发费';
        }
        
        // 设置隐藏字段
        document.getElementById('fleetModalStep').value = 'fleet_confirmation';
        document.getElementById('fleetModalSelectedAppointments').value = JSON.stringify([]);
        
        // 获取该车次下的所有预约信息
        const fleetData = collectFleetData(fleetNumber);
        if (fleetData && fleetData.shipments && fleetData.shipments.length > 0) {
            // 将选中的记录信息填入弹窗表格
            const tbody = document.getElementById("fleetShipmentTableBody");
            if (!tbody) {
                console.error('找不到fleetShipmentTableBody元素');
            } else {
                tbody.innerHTML = ""; // 清空旧内容
                
                fleetData.shipments.forEach(shipment => {
                    // 计算总卡板数和总CBM，收集唛头和柜号
                    let totalPallets = 0;
                    let totalCbm = 0;
                    let hasCbmData = false;
                    let containerNumbers = new Set();
                    let allMarkings = new Set();
                    
                    shipment.cargos.forEach(cargo => {
                        totalPallets += parseFloat(cargo.plannedPallets) || 0;
                        
                        // 检查cbm是否有值
                        if (cargo.cbm && cargo.cbm !== '' && cargo.cbm !== '-') {
                            const cbm = parseFloat(cargo.cbm) || 0;
                            totalCbm += cbm;
                            hasCbmData = true;
                        }
                        
                        // 收集柜号
                        if (cargo.containerNo && cargo.containerNo !== '-') {
                            containerNumbers.add(cargo.containerNo);
                        }
                        
                        // 收集唛头
                        if (cargo.markings && cargo.markings !== '' && cargo.markings !== '-') {
                            allMarkings.add(formatValue(cargo.markings));
                        }
                    });
                    
                    const containerNos = Array.from(containerNumbers).join(', ');
                    const markings = Array.from(allMarkings).join(', ');
                    
                    // CBM显示逻辑：有数据则显示格式化后的数字，否则显示空
                    const cbmDisplay = hasCbmData && totalCbm > 0 ? Number(totalCbm).toFixed(2) : '';
                    
                    const newRow = document.createElement("tr");
                    newRow.innerHTML = `
                        <td style="max-width: 120px; word-break: break-all;">${formatValue(shipment.appointmentId)}</td>
                        <td style="max-width: 120px; word-break: break-all;" title="${markings}">${markings || ''}</td>
                        <td style="max-width: 100px; word-break: break-all;">${containerNos || ''}</td>
                        <td>${formatValue(shipment.destination)}</td>              
                        <td style="max-width: 150px; word-break: break-all;"></td>              
                        <td>${cbmDisplay}</td>
                        <td>${totalPallets}</td>
                        <td style="max-width: 120px; word-break: break-all;"></td>
                    `;
                    tbody.appendChild(newRow);
                });
            }
        } else {
            // 如果没有数据，清空表格
            const tbody = document.getElementById("fleetShipmentTableBody");
            if (tbody) {
                tbody.innerHTML = "";
            }
        }
        
        // 显示弹窗
        fleetModal.style.display = "block";
        console.log('弹框已显示');
    }

    //错误提示框
    function showNoPOPrompt(appointmentIds) {
        // 创建模态框
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.style.display = 'block';
        modal.innerHTML = `
            <div class="modal-content" style="width: 500px; max-width: 90%;">
                <div style="padding: 30px; text-align: center;">
                    <div style="font-size: 48px; color: #ff6b6b; margin-bottom: 20px;">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <h3 style="color: #2c3e50; margin-bottom: 15px;">无法排车</h3>
                    <p style="color: #7f8c8d; margin-bottom: 20px; line-height: 1.5;">
                        以下预约批次没有PO，不能进行排车：
                    </p>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 25px; max-height: 200px; overflow-y: auto;">
                        ${appointmentIds.map(id => `<div style="padding: 5px 0; color: #e74c3c; font-weight: 500;">${id}</div>`).join('')}
                    </div>
                    <button onclick="closeNoPOPrompt()" class="action-btn btn-primary" style="padding: 10px 30px;">
                        <i class="fas fa-check"></i> 确定
                    </button>
                </div>
            </div>
        `;
        
        modal.id = 'noPOPromptModal';
        document.body.appendChild(modal);
        
        // 点击背景关闭
        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                closeNoPOPrompt();
            }
        });
    }

    // 关闭提示框
    function closeNoPOPrompt() {
        const modal = document.getElementById('noPOPromptModal');
        if (modal) {
            document.body.removeChild(modal);
        }
    }
</script>