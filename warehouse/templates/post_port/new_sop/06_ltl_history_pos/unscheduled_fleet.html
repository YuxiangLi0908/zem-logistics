{% load custom_filters %}
<style>
    /* 状态样式 */
    .status-pod {
        background-color: #d4edda !important;
        color: #155724 !important;
        border: 1px solid #c3e6cb;
    }
    
    .status-arrived {
        background-color: #cce5ff !important;
        color: #004085 !important;
        border: 1px solid #b8daff;
    }
    
    .status-shipped {
        background-color: #fff3cd !important;
        color: #856404 !important;
        border: 1px solid #ffeaa7;
    }
    
    .status-pending {
        background-color: #f8f9fa !important;
        color: #6c757d !important;
        border: 1px solid #e9ecef;
    }
    
    .status-badge {
        display: inline-block;
        padding: 3px 8px;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 600;
        text-align: center;
        min-width: 80px;
        white-space: nowrap;
    }
    
    /* 保持原有样式，调整列宽 */
    .shipping-mark-container {
        max-width: 200px;
        max-height: 100px;
        overflow-y: auto;
        padding: 5px;
        background: #f8f9fa;
        border-radius: 4px;
        font-size: 0.75rem;
    }
    
    .shipping-mark-item {
        display: inline-block;
        background: #e9ecef;
        padding: 2px 6px;
        margin: 2px;
        border-radius: 3px;
        border-left: 3px solid #6c757d;
    }
    
    .search-row {
        background-color: #f8f9fa !important;
    }

    .search-row td, 
    .search-row th {
        padding: 5px !important;
        border-bottom: 1px solid #dee2e6 !important;
    }

    .col-search-input {
        width: 100%;
        padding: 4px 8px;
        border: 1px solid #ced4da;
        border-radius: 4px;
        font-size: 0.8rem;
        background: white;
    }
    
    .filter-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        flex-wrap: wrap;
        gap: 15px;
    }
    
    .filter-info {
        flex: 1;
        background-color: #f8f9fa;
        border-left: 4px solid #6c757d;
        padding: 10px 15px;
        border-radius: 4px;
        font-size: 14px;
        color: #495057;
        min-width: 300px;
    }
    
    /* 表格样式调整 */
    .data-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
        font-size: 0.85rem;
    }
    
    .data-table th,
    .data-table td {
        padding: 8px 6px;
        border: 1px solid #dee2e6;
        vertical-align: middle;
    }
    
    .data-table th {
        background-color: #f8f9fa;
        font-weight: 600;
        text-align: left;
        white-space: nowrap;
    }
    
    .table-container {
        overflow-x: auto;
        border-radius: 6px;
        border: 1px solid #dee2e6;
        background: white;
    }
    
    /* 高亮样式 */
    .highlight-color-1 { background-color: #ffd700; color: black; }
    .highlight-color-2 { background-color: #87ceeb; color: black; }
    .highlight-color-3 { background-color: #98fb98; color: black; }
    .highlight-color-4 { background-color: #ffb6c1; color: black; }
</style>

<!-- 未排车批次标签页 -->
<div class="filter-header">
    <div class="filter-info">
        <i class="fas fa-filter"></i> 
        当前显示 <strong>{{ warehouse }}</strong> 仓库的历史排约货物，筛选条件：          
        <strong>约的提货时间在 <u>{{ start_date }}</u> 和 <u>{{ end_date }}</u> 中</strong>、
        <strong>约类型为LTL/客户自提</strong>
    </div>
</div>

{% if unschedule_fleet %}
<div class="table-container">
    <table class="data-table">
        <thead>
            <tr>
                <th style="width: 40px; text-align: center;">选择</th>
                <th style="min-width: 120px;">车次号</th>
                <th style="min-width: 150px;">预约批次</th>
                <th style="min-width: 120px;">目的仓库</th>
                <th style="min-width: 100px;">状态</th>
                <th style="min-width: 200px;">唛头</th>
                <th style="min-width: 150px;">Scheduled Time</th>
                <th style="min-width: 150px;">Pickup Time</th>
                <th style="min-width: 80px;">总重(lbs)</th>
                <th style="min-width: 80px;">总CBM</th>
                <th style="min-width: 80px;">总卡板数</th>
                <th style="min-width: 150px;">备注</th>
            </tr>
            <tr class="search-row">
                <td></td>
                <td><input data-col="1" class="col-search-input" placeholder="搜索车次号"></td>
                <td><input data-col="2" class="col-search-input" placeholder="搜索预约批次"></td>
                <td><input data-col="3" class="col-search-input" placeholder="搜索目的仓库"></td>
                <td><input data-col="4" class="col-search-input" placeholder="搜索状态"></td>
                <td><input data-col="5" class="col-search-input" placeholder="搜索唛头"></td>
                <td><input data-col="6" class="col-search-input" placeholder="搜索送仓时间"></td>
                <td><input data-col="7" class="col-search-input" placeholder="搜索提货时间"></td>
                <td><input data-col="8" class="col-search-input" placeholder="搜索重量"></td>
                <td><input data-col="9" class="col-search-input" placeholder="搜索CBM"></td>
                <td><input data-col="10" class="col-search-input" placeholder="搜索板数"></td>
                <td><input data-col="11" class="col-search-input" placeholder="搜索备注"></td>
            </tr>
        </thead>
        <tbody>
            {% for s in fleet_cargos %}
            <tr>
                <td style="text-align: center;">
                    <input type='checkbox' name='is_appointment_added' 
                           onclick="toggleRowBackground(this)" 
                           {% if s.id in shipment_ids %}checked{% endif %}>
                    <input type="hidden" name="shipment_ids" value='{{ s.id }}'>
                </td>
                <td style="word-break: break-word;">
                    {{ s.fleet_number_display|default:"" }}
                </td>
                <td style="word-break: break-word;">
                    {% if s.batch > 0 %}
                    <span class="status-span-red">甩板</span>
                    {% endif %}
                    {{ s.shipment_batch_number|default:"" }}
                </td>
                <td style="word-break: break-word;">
                    {{ s.destination|default:"" }}
                </td>
                <td style="text-align: center;">
                    <span class="status-badge {{ s.status_class }}">
                        {{ s.status_display }}
                    </span>
                </td>
                <td>
                    <div class="shipping-mark-container">
                        {% if s.shipping_marks %}
                            {% for mark in s.shipping_marks %}
                                <div class="shipping-mark-item" title="{{ mark }}">
                                    {{ mark|truncatechars:15 }}
                                </div>
                            {% endfor %}
                        {% else %}
                            <span style="color: #6c757d; font-style: italic;">无唛头</span>
                        {% endif %}
                    </div>
                </td>
                <td style="word-break: break-word;" data-original-time="{{ s.shipment_appointment|date:'Y-m-d H:i:s' }}">
                    {{ s.shipment_appointment|date:"Y-m-d H:i" }}
                </td>
                <td data-pickup-time="{{ s.pickup_time|date:'Y-m-d\TH:i' }}">
                    {{ s.pickup_time|date:"Y-m-d H:i" }}
                </td>
                <td>{{ s.total_weight|floatformat:2|default:"0.00" }}</td>
                <td>{{ s.total_cbm|floatformat:2|default:"0.00" }}</td>
                <td>{{ s.total_pallet|default:"0" }}</td>
                <td style="word-break: break-word;" title="{% if s.note %}{{ s.note }}{% endif %}">
                    {% if s.note %}
                        {{ s.note|truncatechars:30 }}
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% else %}
<div style="text-align: center; padding: 40px; color: #6c757d; background: white; border-radius: 6px; margin-top: 15px;">
    <i class="fas fa-robot" style="font-size: 3rem; margin-bottom: 15px;"></i>
    <p>暂无待排车批次</p>
</div>
{% endif %}

<script>
    // 定义初始化函数
    function initializeUnscheduledFleetSection() {
        console.log('未排车页面初始化');
        
        const container = document.getElementById("unscheduledFleet-section");
        if (!container) {
            console.error('未找到unscheduledFleet-section容器');
            return;
        }
        
        // 绑定搜索框事件
        container.querySelectorAll('.col-search-input')
            .forEach(input => {
                input.addEventListener('input', applyUnscheduledColumnSearch);
            });
    }

    // 时间标记功能
    function markUnscheduledFleetRows() {
        const container = document.getElementById("unscheduledFleet-section");
        if (!container) return;
        
        const rows = container.querySelectorAll('.data-table tbody tr:not(.search-row)');
        const now = new Date();
        
        rows.forEach(row => {
            // 跳过搜索行
            if (row.classList.contains('search-row')) return;
            
            const timeCell = row.cells[6]; // Scheduled Time在第7列（索引6）
            if (!timeCell) return;
            
            const timeAttr = timeCell.getAttribute('data-original-time');
            const timeText = timeCell.textContent.trim();
            
            let scheduledTime = null;
            
            if (timeAttr) {
                scheduledTime = new Date(timeAttr);
            } else if (timeText) {
                const match = timeText.match(/(\d{4})-(\d{2})-(\d{2}) (\d{2}):(\d{2})/);
                if (match) {
                    scheduledTime = new Date(
                        parseInt(match[1]),
                        parseInt(match[2]) - 1,
                        parseInt(match[3]),
                        parseInt(match[4]),
                        parseInt(match[5])
                    );
                }
            }
            
            if (scheduledTime && !isNaN(scheduledTime.getTime())) {
                const diffHours = Math.floor((scheduledTime - now) / (1000 * 60 * 60));
                
                if (scheduledTime < now) {
                    // 已过期 - 深红色
                    timeCell.style.backgroundColor = '#ffcccc';
                } else if (diffHours <= 24) {
                    // 未来24小时内 - 浅红色
                    timeCell.style.backgroundColor = '#ffe6e6';
                } else if (diffHours <= 48) {
                    // 未来24-48小时 - 黄色
                    timeCell.style.backgroundColor = '#fff9e6';
                } else {
                    timeCell.style.backgroundColor = '';
                }
            }
        });
    }

    // 搜索功能
    function applyUnscheduledColumnSearch() {
        const container = document.getElementById("unscheduledFleet-section");
        if (!container) return;
        
        const inputs = container.querySelectorAll('.col-search-input');
        const rows = container.querySelectorAll('.data-table tbody tr:not(.search-row)');

        // 收集每一列输入的搜索词
        const columnKeywords = {};
        inputs.forEach(input => {
            const col = input.dataset.col;
            const kw = input.value.trim().toLowerCase();
            if (kw) columnKeywords[col] = kw.split(/\s+/);
        });

        rows.forEach(row => {
            removeHighlights(row);

            let visible = true;

            // 逐列检查
            for (const col in columnKeywords) {
                const cell = row.cells[col];
                if (!cell) continue;
                
                let cellText = '';
                
                // 对于状态列（第5列，索引4），获取状态文本
                if (col === '4') {
                    const statusBadge = cell.querySelector('.status-badge');
                    if (statusBadge) {
                        cellText = statusBadge.textContent.toLowerCase();
                    } else {
                        cellText = cell.textContent.toLowerCase();
                    }
                }
                // 对于唛头列（第6列，索引5），需要特殊处理
                else if (col === '5') {
                    const markItems = cell.querySelectorAll('.shipping-mark-item');
                    if (markItems.length > 0) {
                        cellText = Array.from(markItems).map(item => {
                            const title = item.getAttribute('title');
                            return (title || item.textContent).toLowerCase();
                        }).join(' ');
                    } else {
                        const noMarkSpan = cell.querySelector('span');
                        if (noMarkSpan) {
                            cellText = noMarkSpan.textContent.toLowerCase();
                        } else {
                            cellText = cell.textContent.toLowerCase();
                        }
                    }
                } else {
                    cellText = cell.textContent.toLowerCase();
                }
                
                const keywords = columnKeywords[col];
                const match = keywords.every(kw => cellText.includes(kw));

                if (!match) {
                    visible = false;
                    break;
                }
            }

            row.style.display = visible ? "" : "none";

            // 高亮显示匹配的文本
            if (visible && Object.keys(columnKeywords).length > 0) {
                for (const col in columnKeywords) {
                    highlightMatches(row.cells[col], columnKeywords[col]);
                }
            }
        });
        
        // 重新标记时间行
        setTimeout(markUnscheduledFleetRows, 100);
    }

    // 移除旧高亮
    function removeHighlights(row) {
        if (!row) return;
        
        const highlights = row.querySelectorAll('[class^="highlight-color-"]');
        highlights.forEach(span => {
            const parent = span.parentNode;
            if (parent) {
                parent.replaceChild(document.createTextNode(span.textContent), span);
                parent.normalize();
            }
        });
    }

    // 对单元格内容添加关键词高亮
    function highlightMatches(element, keywords) {
        if (!element || !keywords || keywords.length === 0) return;

        let html = element.innerHTML;
        
        if (typeof html !== 'string') return;

        keywords.forEach((kw, index) => {
            if (!kw || kw.trim() === '') return;
            
            const escapedKw = kw.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            const cls = `highlight-color-${(index % 4) + 1}`;
            
            const regex = new RegExp(`(?![^<]*>)(${escapedKw})`, "gi");
            
            html = html.replace(regex, `<span class="${cls}">$1</span>`);
        });

        element.innerHTML = html;
    }

    // 行背景切换
    function toggleRowBackground(checkbox) {
        if (!checkbox) return;
        
        const row = checkbox.closest('tr');
        if (!row) return;
        
        if (checkbox.checked) {
            row.style.backgroundColor = '#e8f5e9';
        } else {
            row.style.backgroundColor = '';
            
            // 恢复时间单元格的颜色
            const timeCell = row.cells[6];
            if (timeCell) {
                const timeAttr = timeCell.getAttribute('data-original-time');
                const timeText = timeCell.textContent.trim();
                
                let scheduledTime = null;
                const now = new Date();
                
                if (timeAttr) {
                    scheduledTime = new Date(timeAttr);
                } else if (timeText) {
                    const match = timeText.match(/(\d{4})-(\d{2})-(\d{2}) (\d{2}):(\d{2})/);
                    if (match) {
                        scheduledTime = new Date(
                            parseInt(match[1]),
                            parseInt(match[2]) - 1,
                            parseInt(match[3]),
                            parseInt(match[4]),
                            parseInt(match[5])
                        );
                    }
                }
                
                if (scheduledTime && !isNaN(scheduledTime.getTime())) {
                    const diffHours = Math.floor((scheduledTime - now) / (1000 * 60 * 60));
                    
                    if (scheduledTime < now) {
                        timeCell.style.backgroundColor = '#ffcccc';
                    } else if (diffHours <= 24) {
                        timeCell.style.backgroundColor = '#ffe6e6';
                    } else if (diffHours <= 48) {
                        timeCell.style.backgroundColor = '#fff9e6';
                    } else {
                        timeCell.style.backgroundColor = '';
                    }
                } else {
                    timeCell.style.backgroundColor = '';
                }
            }
        }
    }

    // DOM加载完成后初始化
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM加载完成');
        
        const container = document.getElementById("unscheduledFleet-section");
        if (container) {
            container.querySelectorAll('.col-search-input')
                .forEach(input => {
                    input.addEventListener('input', applyUnscheduledColumnSearch);
                });
            
            // 初始化时间标记
            setTimeout(markUnscheduledFleetRows, 100);
        }
    });
</script>