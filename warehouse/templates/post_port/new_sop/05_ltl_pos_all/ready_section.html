<!-- 待出库标签页 -->
<style>
    .fleet-number-cell:hover {
        background-color: #e8f4fd !important;
        cursor: pointer;
    }

    .fleet-number-cell:hover strong {
        color: #2980b9 !important;
    }
    .search-row {
        background-color: #f8f9fa;
    }
    .search-row td {
        padding: 5px !important;
        border-bottom: 1px solid #dee2e6;
    }
    .header-search {
        width: 100%;
        padding: 4px 8px;
        border: 1px solid #ced4da;
        border-radius: 4px;
        font-size: 0.8rem;
    }
    .upload-btn {
        background: linear-gradient(135deg, #9c27b0, #673ab7);
        border: none;
        color: white;
        padding: 6px 12px;
        border-radius: 6px;
        font-size: 0.8rem;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 2px 4px rgba(156, 39, 176, 0.3);
        display: flex;
        align-items: center;
        gap: 5px;
    }
    
    .upload-btn:hover {
        background: linear-gradient(135deg, #8e24aa, #5e35b1);
    }
    
    .file-input {
        display: none;
    }
    .date-filter {
        width: 100%;
        padding: 4px 8px;
        border: 1px solid #ced4da;
        border-radius: 4px;
        font-size: 0.8rem;
        background-color: white;
    }
    
    /* 高亮样式 */
    .highlight-color-1 {
        background: yellow;
        font-weight: bold;
    }
    .highlight-color-2 {
        background: #8ef5a6;
        font-weight: bold;
    }
    .highlight-color-3 {
        background: #ffb4b4;
        font-weight: bold;
    }
    .highlight-color-4 {
        background: #b4c9ff;
        font-weight: bold;
    }
    
    .cost-input {
        width: 80px;
        padding: 2px 4px;
        border: 1px solid #ced4da;
        border-radius: 3px;
        font-size: 0.8rem;
        text-align: right;
    }
    
    .cost-input.save-btn {
        background-color: #28a745;
        color: white;
        border: none;
        cursor: pointer;
        margin-left: 5px;
        padding: 2px 4px;  /* 减少内边距 */
        width: 24px;       /* 固定宽度 */
        height: 24px;      /* 固定高度 */
        border-radius: 3px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 0.7rem; /* 减小字体大小 */
    }
    
    .cost-input.save-btn:hover {
        background-color: #218838;
    }

    .cost-input.save-btn i {
        margin: 0; /* 移除图标边距 */
    }
    .markings-col {
        white-space: normal !important;  /* 允许换行 */
        word-break: break-word !important;  /* 允许在单词内换行 */
        word-wrap: break-word !important;  /* 长单词换行 */
        max-width: 250px !important;  /* 设置最大宽度 */
        min-width: 200px !important;  /* 设置最小宽度 */
        padding: 8px !important;  /* 增加内边距使换行后内容更清晰 */
        vertical-align: top !important;  /* 内容顶部对齐 */
        line-height: 1.4 !important;  /* 增加行高提高可读性 */
    }
</style>

<div class="table-container">
    <table class="data-table">
        <thead>
            <tr>
                <th>车次号</th>
                <th>提货时间</th>
                <th>预约批次</th>
                <th>目的地</th>
                <th>柜号</th>
                <th>唛头</th>
                <th>板数</th>
                <th>件数</th>
                <th>出库</th>
                <th>拣货单</th> 
                <th>下载</th>
                <th style="min-width: 100px;">操作</th>
            </tr>
            <tr class="search-row">
                <td><input type="text" class="header-search" placeholder="搜索车次号" data-column="0"></td>
                <td>
                    <div style="display: flex; gap: 5px; align-items: center;">
                        <input type="date" class="date-filter" id="pickupDateFilter" placeholder="筛选日期">
                        <button class="search-btn" id="clearDateFilter" style="padding: 4px 8px; min-width: auto; font-size: 0.7rem;">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </td>
                <td><input type="text" class="header-search" placeholder="搜索预约批次" data-column="2"></td>
                <td><input type="text" class="header-search" placeholder="搜索目的地" data-column="3"></td>
                <td><input type="text" class="header-search" placeholder="搜索柜号" data-column="4"></td>
                <td><input type="text" class="header-search" placeholder="搜索唛头" data-column="5"></td>
                <td><input type="text" class="header-search" placeholder="搜索板数" data-column="6"></td>
                <td><input type="text" class="header-search" placeholder="搜索件数" data-column="7"></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
        </thead>
        <tbody>
            {% for fleet_group in ready_to_ship_data %}
                {% with fleet_rowspan=fleet_group.total_cargos %}
                    <tr class="group-separator">
                        <td colspan="11" style="background: linear-gradient(90deg, #3498db, #6c8bc7); 
                                            height: 2px; padding: 0;"></td>
                    </tr>
                    {% if not fleet_group.shipments %}
                        <tr>
                            <td class="fleet-number-cell" style="vertical-align: middle; background-color: #f8f9fa;"
                                data-fleet-number="{{ fleet_group.fleet_number }}"
                                data-third-party-address="{{ fleet_group.third_party_address }}"
                                data-pickup-number="{{ fleet_group.pickup_number }}"
                                data-motor-carrier-number="{{ fleet_group.motor_carrier_number }}"
                                data-license-plate="{{ fleet_group.license_plate }}"
                                data-dot-number="{{ fleet_group.dot_number }}"
                                data-appointment-datetime="{{ fleet_group.appointment_datetime }}"
                                data-carrier="{{ fleet_group.carrier }}"
                                data-fleet-type="{{ fleet_group.fleet_type }}"
                                onclick="openFleetModalForReadyShip(this)">
                                <strong style="color: #3498db; text-decoration: underline;">{{ fleet_group.fleet_number }}</strong>
                                <br>
                                <span style="color: #7f8c8d; font-size: 0.85em;">{{ fleet_group.pickup_number|default_if_none:'' }}</span>
                                {% if fleet_group.is_virtual %}
                                    <br><small style="color:#7f8c8d;font-size:10px;">虚拟车次待编辑</small>
                                {% endif %}
                            </td>
                            <td style="vertical-align: middle; background-color: #f8f9fa;">
                                {{ fleet_group.appointment_datetime|date:"Y-m-d" }}
                            </td>
                            <td style="vertical-align: middle; background-color: #f8f9fa;">-</td>
                            <td style="vertical-align: middle; background-color: #f8f9fa;">-</td>
                            <td colspan="4" style="text-align:center; color:#aaa;">无可出库货物</td>
                            <td colspan="3"></td> <!-- 占位：出库、拣货单、下载 -->
                            <td style="vertical-align: middle;">
                                {% if fleet_group.carrier == 'Maersk' %}
                                    <button type="button" class="btn btn-danger btn-sm" onclick="cancelMaerskShipment('{{ fleet_group.fleet_number }}', this)">
                                        取消下单
                                    </button>
                                {% else %}
                                    <form method="post" action="" class="notify-customer-form" style="display: inline-block;">
                                        {% csrf_token %}
                                        <input type="hidden" name="fleet_number" value="{{ fleet_group.fleet_number }}">
                                        <input type="hidden" name="warehouse" value="{{ warehouse }}">
                                        <input type="hidden" name="step" value="cancel_fleet">
                                        <input type="hidden" name="active_tab" value="readyShip">
                                        <input type="hidden" name="page" value="ltl_readyShip">
                                        <button type="submit" class="btn btn-danger btn-sm">
                                            删除车次
                                        </button>
                                    </form>
                                {% endif %}
                            </td>
                        </tr>
                    {% endif %}
                    {% for shipment_batch_number, shipment in fleet_group.shipments.items %}
                        {% with shipment_rowspan=shipment.cargos|length|default:0 %}
                            {% with is_first_shipment=forloop.first %}
                                {% if shipment_rowspan == 0 %}
                                    <tr data-shipment-batch="{{ shipment.shipment_batch_number }}"
                                        data-destination="{{ shipment.destination }}">
                                        {% if is_first_shipment %}
                                            <td rowspan="{{ fleet_rowspan }}" class="fleet-number-cell" style="vertical-align: middle; background-color: #f8f9fa;"
                                                data-fleet-number="{{ fleet_group.fleet_number }}"
                                                data-third-party-address="{{ fleet_group.third_party_address }}"
                                                data-pickup-number="{{ fleet_group.pickup_number }}"
                                                data-motor-carrier-number="{{ fleet_group.motor_carrier_number }}"
                                                data-license-plate="{{ fleet_group.license_plate }}"
                                                data-dot-number="{{ fleet_group.dot_number }}"
                                                data-appointment-datetime="{{ fleet_group.appointment_datetime }}"
                                                data-carrier="{{ fleet_group.carrier }}"
                                                data-fleet-type="{{ fleet_group.fleet_type }}"
                                                onclick="openFleetModalForReadyShip(this)">
                                                <strong style="color: #3498db; text-decoration: underline;">{{ fleet_group.fleet_number }}</strong>
                                                <br>
                                                <span style="color: #7f8c8d; font-size: 0.85em;">{{ fleet_group.pickup_number|default_if_none:'' }}</span>
                                                {% if fleet_group.is_virtual %}
                                                    <br><small style="color:#7f8c8d;font-size:10px;">虚拟车次待编辑</small>
                                                {% endif %}
                                            </td>
                                            <td rowspan="{{ fleet_rowspan }}" style="vertical-align: middle; background-color: #f8f9fa;">
                                                {{ fleet_group.appointment_datetime|date:"Y-m-d" }}
                                            </td>
                                        {% endif %}

                                        <td style="vertical-align: middle; background-color: #f8f9fa;">
                                            {{ shipment.shipment_batch_number }}<br>
                                            <span style="color: #3498db; font-size: 0.85em;">预计送仓 {{ shipment.shipment_appointment|date:"Y-m-d"}}</span>
                                        </td>
                                        <td style="vertical-align: middle; background-color: #f8f9fa;">{{ shipment.destination }}</td>

                                        <td colspan="4" style="text-align:center; color:#aaa;">无可出库货物</td>

                                        {% if is_first_shipment %}
                                            <td rowspan="{{ fleet_rowspan }}" colspan="3"></td> <!-- 占位：出库、拣货单、下载 -->
                                            <td rowspan="{{ fleet_rowspan }}" style="vertical-align: middle;">
                                                {% if fleet_group.carrier == 'Maersk' %}
                                                    <button type="button" class="btn btn-danger btn-sm" onclick="cancelMaerskShipment('{{ fleet_group.fleet_number }}', this)">
                                                        取消下单
                                                    </button>
                                                {% else %}
                                                    <form method="post" action="" class="notify-customer-form" style="display: inline-block;">
                                                        {% csrf_token %}
                                                        <input type="hidden" name="fleet_number" value="{{ fleet_group.fleet_number }}">
                                                        <input type="hidden" name="warehouse" value="{{ warehouse }}">
                                                        <input type="hidden" name="step" value="cancel_fleet">
                                                        <input type="hidden" name="active_tab" value="readyShip">
                                                        <input type="hidden" name="page" value="ltl_readyShip">
                                                        <button type="submit" class="btn btn-danger btn-sm">
                                                            删除车次
                                                        </button>
                                                    </form>
                                                {% endif %}
                                            </td>
                                        {% endif %}
                                    </tr>
                                {% else %}
                                    {% for cargo in shipment.cargos %}
                                        <tr data-plt-id="{{ cargo.plt_ids }}"
                                            data-cargo-id="{{ cargo.cargo_ids }}"
                                            data-shipment-batch="{{ shipment.shipment_batch_number }}"
                                            data-destination="{{ shipment.destination }}"
                                            data-container-no="{{ cargo.cns }}"
                                            data-markings="{{ cargo.shipping_marks|default:'' }}"
                                            data-planned="{{ cargo.total_n_pallet_act|default:0 }}"
                                            data-label="{{ cargo.label|default:'' }}"
                                            data-pcs="{{ cargo.total_pcs|default:0 }}">
                                            {% if forloop.first and forloop.parentloop.first %}
                                                <td rowspan="{{ fleet_rowspan }}" style="vertical-align: middle; background-color: #f8f9fa; cursor: pointer;" 
                                                    class="fleet-number-cell" 
                                                    data-fleet-number="{{ fleet_group.fleet_number }}"
                                                    data-third-party-address="{{ fleet_group.third_party_address }}"
                                                    data-pickup-number="{{ fleet_group.pickup_number }}"
                                                    data-motor-carrier-number="{{ fleet_group.motor_carrier_number }}"
                                                    data-license-plate="{{ fleet_group.license_plate }}"
                                                    data-dot-number="{{ fleet_group.dot_number }}"
                                                    data-appointment-datetime="{{ fleet_group.appointment_datetime }}"
                                                    data-carrier="{{ fleet_group.carrier }}"
                                                    data-fleet-type="{{ fleet_group.fleet_type }}"
                                                    onclick="openFleetModalForReadyShip(this)">
                                                    <strong style="color: #3498db; text-decoration: underline;">{{ fleet_group.fleet_number }}</strong>
                                                    
                                                    <br><span style="color: #7f8c8d; font-size: 0.85em;">{{ fleet_group.pickup_number }}</span>
                                                    {% if fleet_group.is_virtual%}
                                                    <br><small style="color: #7f8c8d; font-size: 10px;">虚拟车次待编辑</small>
                                                    {% endif %}
                                                </td> 
                                                <td rowspan="{{ fleet_rowspan }}" style="vertical-align: middle; background-color: #f8f9fa;">
                                                    {{ fleet_group.appointment_datetime|date:"Y-m-d" }}
                                                </td> 
                                            {% endif %}

                                            {% if forloop.first %}
                                                <td rowspan="{{ shipment_rowspan }}" style="vertical-align: middle; background-color: #f8f9fa;">
                                                    {{ shipment.shipment_batch_number }}<br>
                                                    <span style="color: #3498db; font-size: 0.85em;">预计送仓 {{ shipment.shipment_appointment|date:"Y-m-d"}}</span>
                                                </td>
                                                <td rowspan="{{ shipment_rowspan }}" style="vertical-align: middle; background-color: #f8f9fa;">
                                                    {{ shipment.destination }}
                                                </td>
                                            {% endif %}

                                            <td class="cns-col">{{ cargo.cns|linebreaksbr }}</td>
                                            <td class="markings-col" data-full="{{ cargo.shipping_marks|default:'' }}" 
                                                style="white-space: normal; word-break: break-word; word-wrap: break-word; max-width: 250px; min-width: 200px; padding: 8px; vertical-align: top;">
                                                {{ cargo.shipping_marks|default:"-" }}
                                            </td>
                                            <td>
                                                {% if cargo.label == "ACT" %}
                                                    {{ cargo.total_n_pallet_act|default:0 }}
                                                {% elif cargo.label == "EST" %}
                                                    {{ cargo.total_n_pallet_est|default:0 }}
                                                {% else %}
                                                    0
                                                {% endif %}
                                            </td>
                                            <td>{{ cargo.total_pcs|default:0 }}</td>

                                            {% if forloop.first and forloop.parentloop.first %}
                                                <td rowspan="{{ fleet_rowspan }}" style="vertical-align: middle;">
                                                    <button class="action-btn btn-success" onclick="confirmFleetDeparture('{{ fleet_group.fleet_number }}')">出库</button>
                                                </td>
                                                <td rowspan="{{ fleet_rowspan }}" style="vertical-align: middle;">
                                                    <button class="action-btn"
                                                            data-fleet-number="{{ fleet_group.fleet_number }}"
                                                            data-fleet-type="{{ fleet_group.fleet_type }}"
                                                            data-arm-pickup='{{ fleet_group.arm_pickup|safe }}'
                                                            onclick="handleArmPickupClick(this)"
                                                            style="background: linear-gradient(135deg, #ff9800, #f57c00);
                                                                color: white;
                                                                border: none;
                                                                padding: 6px 12px;
                                                                border-radius: 6px;
                                                                font-size: 0.8rem;
                                                                cursor: pointer;
                                                                transition: all 0.3s ease;
                                                                box-shadow: 0 2px 4px rgba(255, 152, 0, 0.3);">
                                                        拣货单
                                                    </button>
                                                </td>
                                                <td rowspan="{{ fleet_rowspan }}">
                                                    {% if fleet_group.fleet_type == '客户自提' %}
                                                        <div style="margin-top: 5px;">
                                                            <form method="post" action="" enctype="multipart/form-data" class="upload-form" style="display: inline-block;">
                                                                {% csrf_token %}
                                                                <input type="hidden" name="fleet_number" value="{{ fleet_group.fleet_number }}">
                                                                <input type="hidden" name="warehouse" value="{{ warehouse }}">
                                                                <input type="hidden" name="step" value="upload_self_pickup_file">
                                                                <input type="hidden" name="active_tab" value="readyShip">
                                                                <input type="hidden" name="arm_pickup_data" class="arm-pickup-data">
                                                                
                                                                <input type="file" 
                                                                    name="files" 
                                                                    id="uploadFile_{{ fleet_group.fleet_number }}_{{ forloop.parentloop.counter0 }}_{{ forloop.counter0 }}" 
                                                                    class="file-input" 
                                                                    onchange="handleFileChange(this)"
                                                                    accept=".pdf,application/pdf">
                                                                
                                                                <button type="button" class="upload-btn" 
                                                                        onclick="prepareUpload('{{ fleet_group.fleet_number }}', this)" style="vertical-align: middle;">
                                                                    <i class="fas fa-upload"></i>
                                                                    上传文件
                                                                </button>
                                                            </form>
                                                        </div>
                                                    {% else %}
                                                        <div style="margin-top: 5px;">
                                                            <form method="post" action="" class="notify-customer-form" style="display: inline-block;">
                                                                {% csrf_token %}
                                                                <input type="hidden" name="fleet_number" value="{{ fleet_group.fleet_number }}">                                        
                                                                <input type="hidden" name="warehouse" value="{{ warehouse }}">
                                                                <input type="hidden" name="step" value="export_ltl_label">
                                                                <input type="hidden" name="active_tab" value="readyShip"> 
                                                                <input type="hidden" name="arm_pickup_data" class="arm-pickup-data">
                                                                <button class="action-btn" style="
                                                                    background: linear-gradient(135deg, #28a745, #1e7e34);
                                                                    border: none;
                                                                    color: white;
                                                                    padding: 6px 12px;
                                                                    border-radius: 6px;
                                                                    font-size: 0.8rem;
                                                                    cursor: pointer;
                                                                    transition: all 0.3s ease;
                                                                    box-shadow: 0 2px 4px rgba(40, 167, 69, 0.3);
                                                                    display: flex;
                                                                    align-items: center;
                                                                    gap: 5px;
                                                                ">
                                                                    <i class="fas fa-file-word" style="font-size: 0.9rem; color: white;"></i>
                                                                    LABEL下载
                                                                </button>
                                                            </form>
                                                        <div style="margin-top: 5px;">
                                                            <form method="post" action="" class="notify-customer-form" style="display: inline-block;">
                                                                {% csrf_token %}
                                                                <input type="hidden" name="fleet_number" value="{{ fleet_group.fleet_number }}">                                  
                                                                <input type="hidden" name="warehouse" value="{{ warehouse }}">
                                                                <input type="hidden" name="step" value="export_ltl_bol">
                                                                <input type="hidden" name="active_tab" value="readyShip"> 
                                                                <input type="hidden" name="arm_pickup_data" class="arm-pickup-data">
                                                                <button class="action-btn" style="
                                                                    background: linear-gradient(135deg, #3498db, #2980b9);
                                                                    border: none;
                                                                    color: white;
                                                                    padding: 6px 12px;
                                                                    border-radius: 6px;
                                                                    font-size: 0.8rem;
                                                                    cursor: pointer;
                                                                    transition: all 0.3s ease;
                                                                    box-shadow: 0 2px 4px rgba(52, 152, 219, 0.3);
                                                                    display: flex;
                                                                    align-items: center;
                                                                    gap: 5px;
                                                                ">
                                                                    <i class="fas fa-file-word" style="font-size: 0.9rem;"></i>
                                                                    BOL下载
                                                                </button>
                                                            </form>
                                                        </div>
                                                    {% endif %}
                                                </td>
                                                <td rowspan="{{ fleet_rowspan }}" style="vertical-align: middle;">
                                                    {% if fleet_group.carrier == 'Maersk' %}
                                                        <button type="button" class="btn btn-danger btn-sm" onclick="cancelMaerskShipment('{{ fleet_group.fleet_number }}', this)">
                                                            取消下单
                                                        </button>
                                                    {% else %}
                                                        <form method="post" action="" class="notify-customer-form" style="display: inline-block;">
                                                            {% csrf_token %}
                                                            <input type="hidden" name="fleet_number" value="{{ fleet_group.fleet_number }}">
                                                            <input type="hidden" name="warehouse" value="{{ warehouse }}">
                                                            <input type="hidden" name="step" value="cancel_fleet">
                                                            <input type="hidden" name="active_tab" value="readyShip">
                                                            <input type="hidden" name="page" value="ltl_readyShip">
                                                            <button type="submit" class="btn btn-danger btn-sm">
                                                                删除车次
                                                            </button>
                                                        </form>
                                                    {% endif %}
                                                </td>
                                            {% endif %}
                                        </tr>
                                    {% endfor %}
                                {% endif %}
                            {% endwith %}
                        {% endwith %}
                    {% endfor %}
                {% endwith %}
            {% empty %}
                <tr>
                    <td colspan="11" style="text-align:center; padding:20px;">暂无待出库货物</td>
                </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- 拣货单模态框 -->
<div id="armPickupModal" class="modal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);">
    <div class="modal-content" style="background-color: #fefefe; margin: 5% auto; padding: 20px; border: 1px solid #888; width: 95%; max-width: 1600px; border-radius: 8px; max-height: 85vh; display: flex; flex-direction: column;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-shrink: 0;">
            <h3 style="margin: 0;">拣货单 - <span id="armPickupFleetNumber"></span></h3>
            <div>
                <button id="addArmPickupRow" style="background-color: #4CAF50; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; margin-right: 10px;">
                    <i class="fas fa-plus"></i> 增加一行
                </button>
                <button onclick="saveArmPickupData()" style="background-color: #2196F3; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; margin-right: 10px;">
                    <i class="fas fa-save"></i> 临时保存
                </button>
                <span onclick="closeArmPickupModal()" style="cursor: pointer; font-size: 24px; color: #aaa;">&times;</span>
            </div>
        </div>
        
        <div id="armPickupContent" style="flex: 1; overflow: auto; min-height: 100px;">
            <!-- 内容根据fleet_type动态加载 -->
        </div>
    </div>
</div>

<!-- Maersk 取消下单成功模态框 -->
<div class="modal fade" id="fleet_maerskCancelSuccessModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static" style="z-index: 1090;">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title"><i class="fas fa-check-circle me-2"></i>取消成功</h5>
            </div>
            <div class="modal-body text-center py-4">
                <div class="mb-3">
                    <i class="fas fa-check-circle text-success" style="font-size: 4rem;"></i>
                </div>
                <h4 class="mb-4">Maersk 订单已取消！</h4>
                
                <div class="card bg-light border-0">
                    <div class="card-body text-start">
                        <div class="row mb-2">
                            <div class="col-5 text-muted">PRO 号码:</div>
                            <div class="col-7 fw-bold" id="maersk_cancel_pro"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer justify-content-center">
                <button type="button" class="btn btn-success px-5" onclick="window.location.reload()">确定</button>
            </div>
        </div>
    </div>
</div>

<script>
    // Maersk 取消下单函数
    function cancelMaerskShipment(fleetNumber, btnElement) {
        if (!confirm('确定要取消该 Maersk 下单吗？\n这将调用 API 取消订单并删除本地车次。')) {
            return;
        }

        // 显示加载状态
        const originalText = btnElement.innerHTML;
        btnElement.disabled = true;
        btnElement.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 取消中...';

        const formData = new FormData();
        formData.append('step', 'cancel_maersk_shipment');
        formData.append('fleet_number', fleetNumber);
        formData.append('warehouse', '{{ warehouse }}');
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        formData.append('csrfmiddlewaretoken', csrfToken);

        fetch(window.location.href, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('maersk_cancel_pro').innerText = data.pro_number || 'N/A';
                const modal = new bootstrap.Modal(document.getElementById('fleet_maerskCancelSuccessModal'));
                modal.show();
            } else {
                alert('取消失败: ' + (data.message || '未知错误'));
                // 恢复按钮状态
                btnElement.disabled = false;
                btnElement.innerHTML = originalText;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('请求出错，请检查网络');
            // 恢复按钮状态
            btnElement.disabled = false;
            btnElement.innerHTML = originalText;
        });
    }

    // 首先定义collectFleetData函数
    function collectFleetData(fleetNumber) {
        const fleetCell = document.querySelector(`#readyShip-section td.fleet-number-cell[data-fleet-number="${fleetNumber}"]`);
        if (!fleetCell) {
            console.error(`未找到车次 ${fleetNumber}`);
            return null;
        }
        const fleetRow = fleetCell.closest('tr');
        const allRows = Array.from(document.querySelectorAll('#readyShip-section tbody tr'));
        const startIndex = allRows.indexOf(fleetRow);
        if (startIndex === -1) return null;

        let endIndex = allRows.length;
        for (let i = startIndex + 1; i < allRows.length; i++) {
            if (allRows[i].querySelector('.fleet-number-cell')) { 
                endIndex = i; 
                break; 
            }
        }
        const rows = allRows.slice(startIndex, endIndex);

        const fleetData = { 
            fleetNumber, 
            shipments: [] 
        };
        const shipmentsMap = {};

        rows.forEach((row, idx) => {
            // Read raw dataset values (may be mixed)
            const shipmentBatch = row.dataset.shipmentBatch || '';
            // If appointment id not in dataset, skip (非货物行或占位行)
            if (!shipmentBatch) return;
            const rawPlt = (row.dataset.pltId || '').toString().trim();
            const rawCargo = (row.dataset.cargoId || '').toString().trim();
            const dest = row.dataset.destination || '';
            const containerNo = row.dataset.containerNo || '';
            const markings = row.dataset.markings || '';
            const planned = parseFloat(row.dataset.planned || 0) || 0;
            const label = row.dataset.label || '';
            const pcs = parseFloat(row.dataset.pcs || 0) || 0;

            let pltId = '';
            let cargoId = '';

            if (rawCargo) {
                cargoId = rawCargo;
            }
            if (rawPlt) {
                if (/^cargo_/i.test(rawPlt)) {
                    if (!cargoId) cargoId = rawPlt;
                } else {
                    pltId = rawPlt;
                }
            }

            // Assemble into shipments map
            if (!shipmentsMap[shipmentBatch]) {
                shipmentsMap[shipmentBatch] = { 
                    shipment_batch_number: shipmentBatch, 
                    destination: dest, 
                    cargos: [] 
                };
            }
            shipmentsMap[shipmentBatch].cargos.push({
                containerNo,
                markings,  // 添加唛头信息
                plannedPallets: planned,
                palletLabel: label,
                actualPallets: planned,
                pcs,
                // keep separate fields
                pltId: pltId || '',
                cargoId: cargoId || ''
            });
        });

        fleetData.shipments = Object.values(shipmentsMap);
        return fleetData;
    }

    // 保存费用函数
    function saveFleetCost(fleetNumber, cost) {
        if (!cost || isNaN(cost) || parseFloat(cost) < 0) {
            alert('请输入有效的费用金额');
            return;
        }
        
        const form = document.createElement('form');
        form.method = 'POST';
        form.style.display = 'none';
        
        // 添加CSRF token
        const csrfInput = document.createElement('input');
        csrfInput.type = 'hidden';
        csrfInput.name = 'csrfmiddlewaretoken';
        csrfInput.value = '{{ csrf_token }}';
        form.appendChild(csrfInput);
        
        // 添加步骡标识
        const stepInput = document.createElement('input');
        stepInput.type = 'hidden';
        stepInput.name = 'step';
        stepInput.value = 'save_fleet_cost';
        form.appendChild(stepInput);
        
        // 添加车次号
        const fleetInput = document.createElement('input');
        fleetInput.type = 'hidden';
        fleetInput.name = 'fleet_number';
        fleetInput.value = fleetNumber;
        form.appendChild(fleetInput);
        
        // 添加费用
        const costInput = document.createElement('input');
        costInput.type = 'hidden';
        costInput.name = 'fleet_cost';
        costInput.value = cost;
        form.appendChild(costInput);
        
        // 添加上下文
        const warehouseInput = document.createElement('input');
        warehouseInput.type = 'hidden';
        warehouseInput.name = 'warehouse';
        warehouseInput.value = '{{ warehouse }}';
        form.appendChild(warehouseInput);
        
        // 添加激活标签页
        const activeTabInput = document.createElement('input');
        activeTabInput.type = 'hidden';
        activeTabInput.name = 'active_tab';
        activeTabInput.value = 'readyShip';
        form.appendChild(activeTabInput);
        
        document.body.appendChild(form);
        form.submit();
    }

    // 修改弹框函数，用于待出库页面的车次号点击
    function openFleetModalForReadyShip(clickedElement) {
        // 从点击的元素获取车次信息
        const fleetNumber = clickedElement.dataset.fleetNumber || '';
        const thirdPartyAddress = clickedElement.dataset.thirdPartyAddress || '';
        const pickupNumber = clickedElement.dataset.pickupNumber || '';
        const motorCarrierNumber = clickedElement.dataset.motorCarrierNumber || '';
        const licensePlate = clickedElement.dataset.licensePlate || '';
        const dotNumber = clickedElement.dataset.dotNumber || '';
        const appointmentDatetime = clickedElement.dataset.appointmentDatetime || '';
        const carrier = clickedElement.dataset.carrier || '';
        const fleetType = clickedElement.dataset.fleetType || '';
        
        // 获取fleetModal元素
        const fleetModal = document.getElementById('fleetModal');
        if (!fleetModal) {
            console.error('找不到fleetModal元素');
            alert('弹框元素未找到，请检查页面是否引用了fleet_modal.html');
            return;
        }
        
        // 设置表单字段
        document.getElementById('fleetModalThirdPartyAddress').value = thirdPartyAddress;
        document.getElementById('fleetModalPickupNumber').value = pickupNumber;
        document.getElementById('fleetModalMotorCarrierNumber').value = motorCarrierNumber;
        document.getElementById('fleetModalLicensePlate').value = licensePlate;
        document.getElementById('fleetModalDotNumber').value = dotNumber;
        document.getElementById('fleetModalAppointmentDatetime').value = appointmentDatetime;
        document.getElementById('fleetModalCarrier').value = carrier;
        document.getElementById('fleetModalFleetNumber').value = fleetNumber;
        
        // 设置隐藏字段
        document.getElementById('fleetModalStep').value = 'fleet_confirmation';
        document.getElementById('fleetModalSelectedAppointments').value = JSON.stringify([]);
        
        // 获取该车次下的所有预约信息
        const fleetData = collectFleetData(fleetNumber);
        if (fleetData && fleetData.shipments && fleetData.shipments.length > 0) {
            // 将选中的记录信息填入弹窗表格
            const tbody = document.getElementById("fleetShipmentTableBody");
            if (!tbody) {
                console.error('找不到fleetShipmentTableBody元素');
            } else {
                tbody.innerHTML = ""; // 清空旧内容
                
                fleetData.shipments.forEach(shipment => {
                    // 计算总卡板数和总CBM
                    let totalPallets = 0;
                    let totalCbm = 0;
                    let hasCbmData = false;
                    let containerNumbers = new Set();
                    
                    shipment.cargos.forEach(cargo => {
                        // 确保转换为数字
                        const pallets = parseFloat(cargo.plannedPallets) || 0;
                        totalPallets += pallets;
                        
                        // 检查cbm是否有值
                        if (cargo.cbm && cargo.cbm !== '' && cargo.cbm !== '-') {
                            const cbm = parseFloat(cargo.cbm) || 0;
                            totalCbm += cbm;
                            hasCbmData = true;
                        }
                        
                        if (cargo.containerNo && cargo.containerNo !== '-') {
                            containerNumbers.add(cargo.containerNo);
                        }
                    });
                    
                    const containerNos = Array.from(containerNumbers).join(', ');
                    
                    // 如果有CBM数据则显示，否则显示空
                    let cbmDisplay = '';
                    if (hasCbmData && totalCbm > 0) {
                        cbmDisplay = Number(totalCbm).toFixed(2);
                    }
                    
                    const newRow = document.createElement("tr");
                    newRow.innerHTML = `
                        <td style="max-width: 120px; word-break: break-all;">${shipment.appointmentId || ''}</td>
                        <td>${shipment.appointmentId || ''}</td>
                        <td>${containerNos}</td>
                        <td>${shipment.destination || ''}</td>              
                        <td style="max-width: 150px; word-break: break-all;"></td>              
                        <td>${cbmDisplay}</td>
                        <td>${totalPallets}</td>
                        <td style="max-width: 120px; word-break: break-all;"></td>
                    `;
                    tbody.appendChild(newRow);
                });
            }
        }
        
        // 显示弹窗
        fleetModal.style.display = "block";
        console.log('弹框已显示');
    }

    document.addEventListener('DOMContentLoaded', function() {
        initReadyShipSearch();
    });

    // 搜索相关变量
    let readyShipSearchTimer;
    let readyShipSearchState = {};

    // 初始化搜索功能
    function initReadyShipSearch() {
        const searchInputs = document.querySelectorAll('#readyShip-section .header-search');
        const dateFilter = document.getElementById('pickupDateFilter');
        const clearDateBtn = document.getElementById('clearDateFilter');
        
        // 文本搜索框事件
        searchInputs.forEach(input => {
            input.addEventListener('input', function() {
                clearTimeout(readyShipSearchTimer);
                readyShipSearchTimer = setTimeout(applyReadyShipMultiFilter, 250);
            });
        });
        
        // 日期筛选事件
        if (dateFilter) {
            dateFilter.addEventListener('change', function() {
                clearTimeout(readyShipSearchTimer);
                readyShipSearchTimer = setTimeout(applyReadyShipMultiFilter, 250);
            });
        }
        
        // 清除日期按钮事件
        if (clearDateBtn) {
            clearDateBtn.addEventListener('click', function() {
                if (dateFilter) {
                    dateFilter.value = '';
                    applyReadyShipMultiFilter();
                }
            });
        }
    }

    // 多列搜索函数 - 支持文本搜索和日期筛选的AND关系
    function applyReadyShipMultiFilter() {      
        // 先清除高亮
        clearReadyShipHighlights();
        
        const searchInputs = document.querySelectorAll('#readyShip-section .header-search');
        const dateFilter = document.getElementById('pickupDateFilter');
        const sectionElement = document.getElementById('readyShip-section');
        if (!sectionElement) return;
        
        const rows = sectionElement.querySelectorAll('.data-table tbody tr');
        
        // 收集每一列的筛选条件
        const columnFilters = {};
        let hasSearchTerm = false;
        
        searchInputs.forEach(input => {
            const colIndex = input.dataset.column;
            const value = input.value.trim().toLowerCase();
            if (value) {
                columnFilters[colIndex] = value;
                hasSearchTerm = true;
            }
        });

        // 获取日期筛选值
        const filterDate = dateFilter ? dateFilter.value : '';

        // 先显示所有行
        rows.forEach(row => {
            row.style.display = '';
            row.querySelectorAll('td[rowspan]').forEach(td => {
                td.style.display = '';
            });
        });
        
        // 没有搜索条件时显示所有行
        if (!hasSearchTerm && !filterDate) {
            return;
        }

        // 使用新的多列筛选逻辑
        handleReadyShipMultiColumnFilter(rows, columnFilters, filterDate);
        
        // 应用高亮
        applyReadyShipColumnHighlights(columnFilters);
    }

    function handleReadyShipMultiColumnFilter(rows, columnFilters, filterDate) {
        const groupMap = new Map();
        let currentGroupId = null;
        let currentGroupRows = [];
        
        // 构建组映射
        rows.forEach((row, index) => {
            if (row.classList.contains('group-separator')) {
                if (currentGroupId && currentGroupRows.length > 0) {
                    groupMap.set(currentGroupId, [...currentGroupRows]);
                }
                currentGroupId = `group-${index}`;
                currentGroupRows = [row];
                return;
            }
            
            const fleetCell = row.querySelector('.fleet-number-cell');
            if (fleetCell && currentGroupId) {
                groupMap.set(currentGroupId, [...currentGroupRows]);
                currentGroupId = `group-${index}`;
                currentGroupRows = [];
            }
            
            if (currentGroupId) {
                currentGroupRows.push(row);
            }
        });
        
        if (currentGroupId && currentGroupRows.length > 0) {
            groupMap.set(currentGroupId, [...currentGroupRows]);
        }
        
        // 隐藏所有行
        rows.forEach(row => {
            row.style.display = 'none';
        });
        
        // 查找匹配的组
        const matchingGroups = new Set();
        
        groupMap.forEach((groupRows, groupId) => {
            let groupMatched = false;
            
            // 检查组内是否有任何行匹配搜索条件
            for (const row of groupRows) {
                if (isReadyShipRowMatchMultiColumn(row, columnFilters, filterDate)) {
                    groupMatched = true;
                    break;
                }
            }
            
            if (groupMatched) {
                matchingGroups.add(groupId);
            }
        });
        
        // 显示匹配的组的所有行
        matchingGroups.forEach(groupId => {
            const groupRows = groupMap.get(groupId);
            if (groupRows) {
                groupRows.forEach(row => {
                    row.style.display = '';
                    // 确保合并的单元格也显示
                    row.querySelectorAll('td[rowspan]').forEach(td => {
                        td.style.display = '';
                    });
                });
            }
        });
        
        // 如果没有匹配的组，尝试单独匹配（处理没有组结构的情况）
        if (matchingGroups.size === 0) {
            rows.forEach(row => {
                if (isReadyShipRowMatchMultiColumn(row, columnFilters, filterDate)) {
                    row.style.display = '';
                    row.querySelectorAll('td[rowspan]').forEach(td => {
                        td.style.display = '';
                    });
                }
            });
        }
    }

    // 改进的匹配函数 - 支持多列AND筛选
    function isReadyShipRowMatchMultiColumn(row, columnFilters, filterDate) {
        // 跳过分隔行
        if (row.classList.contains('group-separator')) {
            return false;
        }
        
        let allColumnsMatch = true;
        
        // 检查每一列的筛选条件（AND关系）
        Object.keys(columnFilters).forEach(colIndex => {
            const searchValue = columnFilters[colIndex];
            if (!searchValue) return;
            
            const cell = getCellByColumnIndex(row, parseInt(colIndex));
            if (!cell) {
                allColumnsMatch = false;
                return;
            }
            
            let cellText = cell.textContent.toLowerCase();
            
            // 处理特殊列（唛头有完整数据在data-full属性中）
            if (colIndex === '5') { // 唛头列
                const fullMarkings = cell.getAttribute('data-full') || cellText;
                cellText = fullMarkings.toLowerCase();
            }
                       
            if (!cellText.includes(searchValue)) {
                allColumnsMatch = false;
            }
        });
        
        // 检查日期筛选
        let dateMatch = !filterDate;
        if (filterDate) {
            const pickupTimeCell = getCellByColumnIndex(row, 1); // 第2列是提货时间
            if (pickupTimeCell) {
                const pickupDate = pickupTimeCell.textContent.trim();
                dateMatch = pickupDate === filterDate;
            } else {
                dateMatch = false;
            }
        }
        
        const finalMatch = allColumnsMatch && dateMatch;
        
        return finalMatch;
    }

    // 辅助函数：根据列索引获取单元格（考虑rowspan/colspan）
    function getCellByColumnIndex(row, targetColIndex) {
        const cells = row.querySelectorAll('td');
        let currentColIndex = 0;
        
        for (let i = 0; i < cells.length; i++) {
            const cell = cells[i];
            const rowspan = parseInt(cell.getAttribute('rowspan') || '1');
            const colspan = parseInt(cell.getAttribute('colspan') || '1');
            
            // 如果目标列在当前单元格的列范围内
            if (currentColIndex <= targetColIndex && targetColIndex < currentColIndex + colspan) {
                return cell;
            }
            
            currentColIndex += colspan;
        }
        
        console.warn(`未找到列 ${targetColIndex} 的单元格`);
        return null;
    }

    // 改进的高亮函数 - 按列高亮
    function applyReadyShipColumnHighlights(columnFilters) {
        if (Object.keys(columnFilters).length === 0) return;
        
        const rows = document.querySelectorAll('#readyShip-section tbody tr');
        
        rows.forEach(row => {
            if (row.style.display === 'none' || row.classList.contains('group-separator')) return;
            
            Object.keys(columnFilters).forEach((colIndex, termIndex) => {
                const searchTerm = columnFilters[colIndex];
                const cell = getCellByColumnIndex(row, parseInt(colIndex));
                
                if (!cell) return;
                
                let cellText = cell.textContent;
                
                // 保存原始文本
                if (!cell.hasAttribute('data-original-text')) {
                    cell.setAttribute('data-original-text', cellText);
                }
                
                // 对于唛头列，使用完整数据进行高亮
                if (colIndex === '5') {
                    const fullData = cell.getAttribute('data-full') || cellText;
                    cellText = fullData;
                }
                
                const colorClass = `highlight-color-${(termIndex % 4) + 1}`;
                const regex = new RegExp(`(${escapeRegExp(searchTerm)})`, 'gi');
                
                const highlightedHtml = cellText.replace(regex, `<span class="${colorClass}">$1</span>`);
                cell.innerHTML = highlightedHtml;
            });
        });
    }
    // 高亮功能
    function clearReadyShipHighlights() {
        document.querySelectorAll('#readyShip-section tbody tr td').forEach(td => {
            const originalText = td.getAttribute('data-original-text');
            if (originalText) {
                td.textContent = originalText;
                td.removeAttribute('data-original-text');
            }
        });
    }

    // 转义正则表达式特殊字符
    function escapeRegExp(string) {
        return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }

    // 待出库页面特定的JavaScript
    function confirmFleetDeparture(fleetNumber) {
        const fleetData = collectFleetData(fleetNumber);
        if (!fleetData || !fleetData.shipments || fleetData.shipments.length === 0) {
            alert('未找到车次数据或车次下没有货物');
            return;
        }
        openDepartureModal(fleetNumber, fleetData);
    }
    // 存储拣货单数据
    let currentArmPickupData = {
        fleet_number: '',
        fleet_type: '',
        data: []
    };

    // 存储当前编辑的拣货单数据
    let editedArmPickupData = [];
    let armPickupDataCache = {};

    function getLatestArmPickupData(fleetNumber) {
        const savedData = localStorage.getItem(`arm_pickup_${fleetNumber}`);
        if (savedData) {
            try {
                const data = JSON.parse(savedData);
                if (data && Array.isArray(data.data)) {
                    return data.data;
                }
            } catch (e) {}
        }
        if (armPickupDataCache[fleetNumber] && Array.isArray(armPickupDataCache[fleetNumber])) {
            return armPickupDataCache[fleetNumber];
        }
        return null;
    }

    function compressImageToDataUrl(file, orientation = 'horizontal', maxWidth = 900, maxHeight = 900, quality = 0.75) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onerror = () => reject(new Error('file read failed'));
            reader.onload = () => {
                const img = new Image();
                img.onerror = () => reject(new Error('image load failed'));
                img.onload = () => {
                    let width = img.width;
                    let height = img.height;
                    const ratio = Math.min(maxWidth / width, maxHeight / height, 1);
                    width = Math.round(width * ratio);
                    height = Math.round(height * ratio);
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    if (orientation === 'vertical') {
                        canvas.width = height;
                        canvas.height = width;
                        ctx.translate(canvas.width / 2, canvas.height / 2);
                        ctx.rotate(Math.PI / 2);
                        ctx.drawImage(img, -width / 2, -height / 2, width, height);
                    } else {
                        canvas.width = width;
                        canvas.height = height;
                        ctx.drawImage(img, 0, 0, width, height);
                    }
                    try {
                        const dataUrl = canvas.toDataURL('image/jpeg', quality);
                        resolve(dataUrl);
                    } catch (err) {
                        reject(err);
                    }
                };
                img.src = reader.result;
            };
            reader.readAsDataURL(file);
        });
    }

    async function handleArmPickupImageChange(input) {
        const row = input.closest('tr');
        if (!row) return;
        const statusEl = row.querySelector('.arm-image-status');
        const orientationSelect = row.querySelector('select[data-field="pickup_image_orientation"]');
        const orientation = orientationSelect ? orientationSelect.value : 'horizontal';
        const fileContentEl = row.querySelector('textarea[data-field="pickup_file_content"]');
        if (!input.files || input.files.length === 0) {
            input.dataset.base64 = '';
            if (fileContentEl) fileContentEl.value = '';
            if (orientationSelect) orientationSelect.disabled = false;
            if (statusEl) statusEl.textContent = '未上传';
            updateArmPickupData();
            return;
        }
        const file = input.files[0];
        try {
            if (statusEl) statusEl.textContent = '处理中...';
            if (file.type && file.type.startsWith('image/')) {
                if (orientationSelect) orientationSelect.disabled = false;
                const dataUrl = await compressImageToDataUrl(file, orientation);
                input.dataset.base64 = dataUrl;
                if (fileContentEl) fileContentEl.value = '';
                if (statusEl) statusEl.textContent = '已上传(图片)';
                updateArmPickupData();
            } else {
                if (orientationSelect) {
                    orientationSelect.value = 'horizontal';
                    orientationSelect.disabled = true;
                }
                const isPdf = file.type === 'application/pdf' || (file.name || '').toLowerCase().endsWith('.pdf');
                if (isPdf) {
                    if (file.size > 3 * 1024 * 1024) {
                        alert('PDF太大（>3MB），请压缩后再上传');
                        input.value = '';
                        input.dataset.base64 = '';
                        if (fileContentEl) fileContentEl.value = '';
                        if (statusEl) statusEl.textContent = '未上传';
                        updateArmPickupData();
                        return;
                    }
                    const dataUrl = await new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onerror = () => reject(new Error('file read failed'));
                        reader.onload = () => resolve(reader.result || '');
                        reader.readAsDataURL(file);
                    });
                    input.dataset.base64 = '';
                    if (fileContentEl) fileContentEl.value = String(dataUrl || '');
                    if (statusEl) statusEl.textContent = '已上传(PDF)';
                    updateArmPickupData();
                } else {
                    if (file.size > 200 * 1024) {
                        alert('文件太大（>200KB），请缩小后再上传');
                        input.value = '';
                        input.dataset.base64 = '';
                        if (fileContentEl) fileContentEl.value = '';
                        if (statusEl) statusEl.textContent = '未上传';
                        updateArmPickupData();
                        return;
                    }
                    const text = await new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onerror = () => reject(new Error('file read failed'));
                        reader.onload = () => resolve(reader.result || '');
                        reader.readAsText(file);
                    });
                    input.dataset.base64 = '';
                    if (fileContentEl) fileContentEl.value = String(text || '');
                    if (statusEl) statusEl.textContent = '已上传(文件)';
                    updateArmPickupData();
                }
            }
        } catch (e) {
            alert('文件处理失败');
            input.value = '';
            input.dataset.base64 = '';
            if (fileContentEl) fileContentEl.value = '';
            if (orientationSelect) orientationSelect.disabled = false;
            if (statusEl) statusEl.textContent = '未上传';
            updateArmPickupData();
        }
    }

    // 显示拣货单模态框
    function showArmPickupModal(fleetNumber, fleetType, armPickupData = null) {
        currentArmPickupData.fleet_number = fleetNumber;
        currentArmPickupData.fleet_type = fleetType;
        
        // 设置模态框标题
        document.getElementById('armPickupFleetNumber').textContent = fleetNumber;
        
        // 清空内容
        const contentDiv = document.getElementById('armPickupContent');
        
        // 显示模态框
        document.getElementById('armPickupModal').style.display = 'block';
        
        // 优先使用传入的arm_pickup数据
        if (armPickupData && Array.isArray(armPickupData) && armPickupData.length > 0) {
            renderArmPickupTable(armPickupData, fleetType);
            return;
        }
        
        // 其次尝试从localStorage获取编辑过的数据
        const savedData = localStorage.getItem(`arm_pickup_${fleetNumber}`);
        
        if (savedData) {
            try {
                const data = JSON.parse(savedData);
                renderArmPickupTable(data.data, fleetType);
                return;
            } catch (e) {
                console.error('解析保存的拣货单数据失败:', e);
            }
        }
        
        // 如果都没有数据，显示空表格
        renderArmPickupTable([], fleetType);
    }

    function renderArmPickupTable(data, fleetType) {
        const contentDiv = document.getElementById('armPickupContent');
        
        if (fleetType === '客户自提') {
            renderSelfPickupTable(data);
        } else if (fleetType === 'LTL') {
            renderLTLPickupTable(data);
        } else {
            contentDiv.innerHTML = '<div style="text-align:center; padding:20px;">未知的车次类型</div>';
        }
    }
    // 渲染客户自提表格
    function renderSelfPickupTable(data) {
        const contentDiv = document.getElementById('armPickupContent');
        let html = `
            <table style="width:100%; border-collapse:collapse; font-size:13px; min-width: 1200px;" 
                cellpadding="8" 
                id="armPickupTable">
                <thead style="background:#f6f8fa; font-weight:600; position: sticky; top: 0;">                       
                    <th style="text-align: center; border: 1px solid #ddd; padding: 8px; width: 150px;">柜号</th>
                    <th style="text-align: center; border: 1px solid #ddd; padding: 8px; width: 100px;">邮编</th>
                    <th style="text-align: center; border: 1px solid #ddd; padding: 8px; width: 250px;">唛头</th>
                    <th style="text-align: center; border: 1px solid #ddd; padding: 8px; width: 80px;">板数</th> 
                    <th style="text-align: center; border: 1px solid #ddd; padding: 8px; width: 80px;">箱数</th>   
                    <th style="text-align: center; border: 1px solid #ddd; padding: 8px; width: 120px;">Carrier</th>  
                    <th style="text-align: center; border: 1px solid #ddd; padding: 8px; width: 180px;">提货时间</th>
                    <th style="text-align: center; border: 1px solid #ddd; padding: 8px; width: 140px;">图片</th>
                    <th style="text-align: center; border: 1px solid #ddd; padding: 8px; width: 100px;">操作</th>
                </thead>
                <tbody id="armPickupTableBody">
        `;
        
        data.forEach((item, index) => {
            const cleanData = {
                container_number: item.container_number || '',
                zipcode: item.zipcode || '',
                shipping_mark: item.shipping_mark || '',
                total_pallet: item.total_pallet || '',
                total_pcs: item.total_pcs || '',
                carrier: item.carrier || '',
                appointment_datetime: item.appointment_datetime || ''
            };
            if (cleanData.total_pallet === 0) cleanData.total_pallet = 0;
            if (cleanData.total_pcs === 0) cleanData.total_pcs = 0;
            html += `
                <tr id="arm-row-${index}" style="border-bottom: 1px solid #eee;">
                    <td style="border: 1px solid #ddd; padding: 8px;">
                        <input type="text" class="arm-input" 
                            data-field="container_number" 
                            value="${cleanData.container_number || ''}" 
                            style="width: 100%; border: none; background: transparent;">
                    </td>
                    <td style="border: 1px solid #ddd; padding: 8px;">
                        <input type="text" class="arm-input" 
                            data-field="zipcode" 
                            value="${cleanData.zipcode || ''}" 
                            style="width: 100%; border: none; background: transparent;">
                    </td>
                    <td style="border: 1px solid #ddd; padding: 8px;">
                        <textarea class="arm-textarea" 
                                data-field="shipping_mark" 
                                style="width: 100%; border: none; background: transparent; resize: vertical; min-height: 60px;">${item.shipping_mark || ''}</textarea>
                    </td>
                    <td style="border: 1px solid #ddd; padding: 8px;">
                        <input type="number" class="arm-input" 
                            data-field="total_pallet" 
                            value="${cleanData.total_pallet || ''}" 
                            style="width: 100%; border: none; background: transparent;">
                    </td>
                    <td style="border: 1px solid #ddd; padding: 8px;">
                        <input type="number" class="arm-input" 
                            data-field="total_pcs" 
                            value="${cleanData.total_pcs || ''}" 
                            style="width: 100%; border: none; background: transparent;">
                    </td>
                    <td style="border: 1px solid #ddd; padding: 8px;">
                        <input type="text" class="arm-input" 
                            data-field="carrier" 
                            value="${cleanData.carrier || ''}" 
                            style="width: 100%; border: none; background: transparent;">
                    </td>
                    <td style="border: 1px solid #ddd; padding: 8px;">
                        <input type="datetime-local" class="arm-input" 
                            data-field="appointment_datetime" 
                            value="${formatDateTimeForInput(cleanData.appointment_datetime)}" 
                            style="width: 100%; border: none; background: transparent;">
                    </td>
                    <td style="border: 1px solid #ddd; padding: 8px; text-align: center;">
                        <input type="file" accept="image/*,application/pdf,.pdf,.txt,.csv,.log,.json" class="arm-file" data-field="pickup_image" data-base64="${(item.pickup_image || '').toString().replace(/"/g,'&quot;')}"
                            onchange="handleArmPickupImageChange(this)"
                            style="width: 100%;">
                        <select class="arm-select" data-field="pickup_image_orientation"
                            style="width: 100%; margin-top: 6px; border: 1px solid #ddd; padding: 4px; font-size: 12px; background: #fff;">
                            <option value="horizontal" ${(item.pickup_image_orientation || 'horizontal') === 'horizontal' ? 'selected' : ''}>横向</option>
                            <option value="vertical" ${(item.pickup_image_orientation || 'horizontal') === 'vertical' ? 'selected' : ''}>竖向</option>
                        </select>
                        <textarea class="arm-textarea" data-field="pickup_file_content" style="display:none;">${(item.pickup_file_content || '').toString()}</textarea>
                        <div class="arm-image-status" style="font-size: 12px; color: #666; padding-top: 4px;">${(item.pickup_file_content || '').toString().startsWith('data:application/pdf') ? '已上传(PDF)' : (item.pickup_file_content ? '已上传(文件)' : (item.pickup_image ? '已上传(图片)' : '未上传'))}</div>
                    </td>
                    <td style="border: 1px solid #ddd; padding: 8px; text-align: center;">
                        <button onclick="removeArmPickupRow(${index})" 
                                style="background: #dc3545; color: white; border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer;">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `;
        });
        
        html += `</tbody></table>`;
        contentDiv.innerHTML = html;
        
        // 添加事件监听
        addArmPickupEventListeners();
        editedArmPickupData = [...data];
    }

    // 渲染LTL表格
    function renderLTLPickupTable(data) {
        console.log('数据详情',data);
        const contentDiv = document.getElementById('armPickupContent');
        let html = `
            <div style="overflow-x: auto;">
            <table style="min-width: 1600px; border-collapse:collapse; font-size:13px;" 
                cellpadding="6" 
                id="armPickupTable">
                <thead style="background:#f6f8fa; font-weight:600; position: sticky; top: 0;">                       
                    <th style="text-align: center; border: 1px solid #ddd; padding: 8px; width: 150px; min-width: 150px;">柜号</th>
                    <th style="text-align: center; border: 1px solid #ddd; padding: 8px; width: 200px; min-width: 200px;">目的地</th>
                    <th style="text-align: center; border: 1px solid #ddd; padding: 8px; width: 300px; min-width: 300px;">唛头</th>
                    <th style="text-align: center; border: 1px solid #ddd; padding: 8px; width: 120px; min-width: 120px;">PRO</th>
                    <th style="text-align: center; border: 1px solid #ddd; padding: 8px; width: 80px; min-width: 80px;">板数</th> 
                    <th style="text-align: center; border: 1px solid #ddd; padding: 8px; width: 80px; min-width: 80px;">箱数</th>  
                    <th style="text-align: center; border: 1px solid #ddd; padding: 8px; width: 120px; min-width: 120px;">Carrier</th>  
                    <th style="text-align: center; border: 1px solid #ddd; padding: 8px; width: 150px; min-width: 150px;">Company</th>
                    <th style="text-align: center; border: 1px solid #ddd; padding: 8px; width: 120px; min-width: 120px;">Road</th>
                    <th style="text-align: center; border: 1px solid #ddd; padding: 8px; width: 100px; min-width: 100px;">City</th>
                    <th style="text-align: center; border: 1px solid #ddd; padding: 8px; width: 120px; min-width: 120px;">Name</th>
                    <th style="text-align: center; border: 1px solid #ddd; padding: 8px; width: 120px; min-width: 120px;">Phone</th>
                    <th style="text-align: center; border: 1px solid #ddd; padding: 8px; width: 150px; min-width: 150px;">备注</th>
                    <th style="text-align: center; border: 1px solid #ddd; padding: 8px; width: 100px; min-width: 100px;">库位</th>
                    <th style="text-align: center; border: 1px solid #ddd; padding: 8px; width: 160px; min-width: 160px;">图片</th>
                    <th style="text-align: center; border: 1px solid #ddd; padding: 8px; width: 100px; min-width: 100px;">操作</th>
                </thead>
                <tbody id="armPickupTableBody">
        `;
        
        data.forEach((item, index) => {
            // 清理数据，将undefined、null、'None'转换为空字符串
            const cleanData = {
                container_number: (item.container_number__container_number || item.container_number || '').toString().replace('None', ''),
                destination: (item.destination || '').toString().replace('None', ''),
                shipping_mark: (item.shipping_mark || '').toString().replace('None', ''),
                arm_pro: (item.shipment_batch_number__ARM_PRO || item.arm_pro || '').toString().replace('None', ''),
                total_pallet: item.total_pallet || '',
                total_pcs: item.total_pcs || '',
                carrier: (item.shipment_batch_number__fleet_number__carrier || item.carrier || '').toString().replace('None', ''),
                address: (item.address || '').toString().replace('None', ''),
                note: (item.shipment_batch_number__note || '').toString().replace('None', ''),
                slot: (item.slot || '').toString().replace('None', ''),
                pickup_image: (item.pickup_image || '').toString()
            };
            
            // 特别处理数值字段，如果是数字0就显示0
            if (cleanData.total_pallet === 0) cleanData.total_pallet = 0;
            if (cleanData.total_pcs === 0) cleanData.total_pcs = 0;
            
            // 在前端解析address字段
            let addressParts = {
                company: '', road: '', city: '', name: '', phone: ''
            };
            
            if (cleanData.address && cleanData.address !== '') {
                const parts = cleanData.address.split(";");
                addressParts = {
                    company: parts[0] || '',
                    road: parts[1] || '',
                    city: parts[2] || '',
                    name: parts[3] || '',
                    phone: parts[4] || ''
                };
            }
            
            html += `
                <tr id="arm-row-${index}" style="border-bottom: 1px solid #eee;">
                    <td style="border: 1px solid #ddd; padding: 8px; width: 150px; min-width: 150px;">
                        <input type="text" class="arm-input" 
                            data-field="container_number__container_number" 
                            value="${cleanData.container_number}" 
                            style="width: 100%; border: 1px solid #ddd; background: #fff; padding: 6px; font-size: 13px;">
                    </td>
                    <td style="border: 1px solid #ddd; padding: 8px; width: 200px; min-width: 200px;">
                        <input type="text" class="arm-input" 
                            data-field="destination" 
                            value="${cleanData.destination}" 
                            style="width: 100%; border: 1px solid #ddd; background: #fff; padding: 6px; font-size: 13px;">
                    </td>
                    <td style="border: 1px solid #ddd; padding: 8px; width: 300px; min-width: 300px;">
                        <textarea class="arm-textarea" 
                                data-field="shipping_mark" 
                                style="width: 100%; border: 1px solid #ddd; background: #fff; resize: vertical; min-height: 80px; padding: 6px; font-size: 13px;">${cleanData.shipping_mark}</textarea>
                    </td>
                    <td style="border: 1px solid #ddd; padding: 8px; width: 120px; min-width: 120px;">
                        <input type="text" class="arm-input" 
                            data-field="shipment_batch_number__ARM_PRO" 
                            value="${cleanData.arm_pro}" 
                            style="width: 100%; border: 1px solid #ddd; background: #fff; padding: 6px; font-size: 13px;">
                    </td>
                    <td style="border: 1px solid #ddd; padding: 8px; width: 80px; min-width: 80px;">
                        <input type="number" class="arm-input" 
                            data-field="total_pallet" 
                            value="${cleanData.total_pallet}" 
                            style="width: 100%; border: 1px solid #ddd; background: #fff; padding: 6px; font-size: 13px;">
                    </td>
                    <td style="border: 1px solid #ddd; padding: 8px; width: 80px; min-width: 80px;">
                        <input type="number" class="arm-input" 
                            data-field="total_pcs" 
                            value="${cleanData.total_pcs}" 
                            style="width: 100%; border: 1px solid #ddd; background: #fff; padding: 6px; font-size: 13px;">
                    </td>
                    <td style="border: 1px solid #ddd; padding: 8px; width: 120px; min-width: 120px;">
                        <input type="text" class="arm-input" 
                            data-field="shipment_batch_number__fleet_number__carrier" 
                            value="${cleanData.carrier}" 
                            style="width: 100%; border: 1px solid #ddd; background: #fff; padding: 6px; font-size: 13px;">
                    </td>
                    <td style="border: 1px solid #ddd; padding: 8px; width: 150px; min-width: 150px;">
                        <input type="text" class="arm-input address-part" 
                            data-field="address_company" 
                            value="${addressParts.company}" 
                            style="width: 100%; border: 1px solid #ddd; background: #fff; padding: 6px; font-size: 13px;">
                    </td>
                    <td style="border: 1px solid #ddd; padding: 8px; width: 120px; min-width: 120px;">
                        <input type="text" class="arm-input address-part" 
                            data-field="address_road" 
                            value="${addressParts.road}" 
                            style="width: 100%; border: 1px solid #ddd; background: #fff; padding: 6px; font-size: 13px;">
                    </td>
                    <td style="border: 1px solid #ddd; padding: 8px; width: 100px; min-width: 100px;">
                        <input type="text" class="arm-input address-part" 
                            data-field="address_city" 
                            value="${addressParts.city}" 
                            style="width: 100%; border: 1px solid #ddd; background: #fff; padding: 6px; font-size: 13px;">
                    </td>
                    <td style="border: 1px solid #ddd; padding: 8px; width: 120px; min-width: 120px;">
                        <input type="text" class="arm-input address-part" 
                            data-field="address_name" 
                            value="${addressParts.name}" 
                            style="width: 100%; border: 1px solid #ddd; background: #fff; padding: 6px; font-size: 13px;">
                    </td>
                    <td style="border: 1px solid #ddd; padding: 8px; width: 120px; min-width: 120px;">
                        <input type="text" class="arm-input address-part" 
                            data-field="address_phone" 
                            value="${addressParts.phone}" 
                            style="width: 100%; border: 1px solid #ddd; background: #fff; padding: 6px; font-size: 13px;">
                    </td>
                    <td style="border: 1px solid #ddd; padding: 8px; width: 150px; min-width: 150px;">
                        <textarea class="arm-textarea" 
                                data-field="shipment_batch_number__note" 
                                style="width: 100%; border: 1px solid #ddd; background: #fff; resize: vertical; min-height: 80px; padding: 6px; font-size: 13px;">${cleanData.note}</textarea>
                    </td>
                    <td style="border: 1px solid #ddd; padding: 8px; width: 100px; min-width: 100px;">
                        <input type="text" class="arm-input" 
                            data-field="slot" 
                            value="${cleanData.slot}" 
                            style="width: 100%; border: 1px solid #ddd; background: #fff; padding: 6px; font-size: 13px;">
                    </td>
                    <td style="border: 1px solid #ddd; padding: 8px; width: 160px; min-width: 160px; text-align: center;">
                        <input type="file" accept="image/*,application/pdf,.pdf,.txt,.csv,.log,.json" class="arm-file" data-field="pickup_image" data-base64="${cleanData.pickup_image.replace(/"/g,'&quot;')}"
                            onchange="handleArmPickupImageChange(this)"
                            style="width: 100%;">
                        <select class="arm-select" data-field="pickup_image_orientation"
                            style="width: 100%; margin-top: 6px; border: 1px solid #ddd; padding: 4px; font-size: 12px; background: #fff;">
                            <option value="horizontal" ${(item.pickup_image_orientation || 'horizontal') === 'horizontal' ? 'selected' : ''}>横向</option>
                            <option value="vertical" ${(item.pickup_image_orientation || 'horizontal') === 'vertical' ? 'selected' : ''}>竖向</option>
                        </select>
                        <textarea class="arm-textarea" data-field="pickup_file_content" style="display:none;">${(item.pickup_file_content || '').toString()}</textarea>
                        <div class="arm-image-status" style="font-size: 12px; color: #666; padding-top: 4px;">${(item.pickup_file_content || '').toString().startsWith('data:application/pdf') ? '已上传(PDF)' : (item.pickup_file_content ? '已上传(文件)' : (cleanData.pickup_image ? '已上传(图片)' : '未上传'))}</div>
                    </td>
                    <td style="border: 1px solid #ddd; padding: 8px; width: 80px; min-width: 80px; text-align: center;">
                        <button onclick="removeArmPickupRow(${index})" 
                                style="background: #dc3545; color: white; border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer;">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `;
        });
        
        html += `</tbody></table></div>`;
        
        if (data.length === 0) {
            html = '<div style="text-align:center; padding:20px; color:#666;">暂无拣货单数据</div>';
        }
        
        contentDiv.innerHTML = html;
        
        addArmPickupEventListeners();
        editedArmPickupData = [...data];
    }

    function cleanDataValue(value) {
        if (value === undefined || value === null) {
            return '';
        }
        
        // 如果是字符串，检查是否是'None'或'null'
        if (typeof value === 'string') {
            if (value.toLowerCase() === 'none' || value.toLowerCase() === 'null') {
                return '';
            }
            return value;
        }
        
        // 如果是数字0，保留0
        if (typeof value === 'number' && value === 0) {
            return 0;
        }
        
        // 其他情况转换为字符串
        return value.toString();
    }
    // 添加事件监听器
    function addArmPickupEventListeners() {
        const inputs = document.querySelectorAll('.arm-input, .arm-textarea, .arm-file, .arm-select');
        inputs.forEach(input => {
            input.addEventListener('change', function() {
                if (input.classList.contains('arm-file')) {
                    handleArmPickupImageChange(input);
                    return;
                }
                if (input.classList.contains('arm-select') && input.getAttribute('data-field') === 'pickup_image_orientation') {
                    const row = input.closest('tr');
                    const fileInput = row ? row.querySelector('.arm-file[data-field="pickup_image"]') : null;
                    if (fileInput && fileInput.files && fileInput.files.length > 0) {
                        handleArmPickupImageChange(fileInput);
                        return;
                    }
                }
                updateArmPickupData();
            });
            input.addEventListener('input', function() {
                updateArmPickupData();
            });
        });
    }

    // 更新拣货单数据
    function updateArmPickupData() {
        const rows = document.querySelectorAll('#armPickupTable tbody tr[id^="arm-row-"]');
        editedArmPickupData = [];
        
        rows.forEach((row, index) => {
            const inputs = row.querySelectorAll('.arm-input, .arm-textarea, .arm-file, .arm-select');
            const rowData = {};
            
            inputs.forEach(input => {
                const field = input.getAttribute('data-field');
                const value = input.classList.contains('arm-file') ? (input.dataset.base64 || '') : input.value;
                
                // 处理地址字段
                if (field.startsWith('address_')) {
                    // address字段会在最后合并
                    if (!rowData.address_parts) {
                        rowData.address_parts = {};
                    }
                    const addressField = field.replace('address_', '');
                    rowData.address_parts[addressField] = value;
                } else {
                    rowData[field] = value;
                }
            });
            
            // 如果是LTL类型，合并地址字段到address
            if (currentArmPickupData.fleet_type === 'LTL' && rowData.address_parts) {
                const parts = rowData.address_parts;
                rowData.address = `${parts.company || ''};${parts.road || ''};${parts.city || ''};${parts.name || ''};${parts.phone || ''}`;
                // 删除临时的address_parts，只保留address
                delete rowData.address_parts;
            }
            
            editedArmPickupData.push(rowData);
        });
        armPickupDataCache[currentArmPickupData.fleet_number] = editedArmPickupData;
    }

    // 添加新行
    document.getElementById('addArmPickupRow').addEventListener('click', function() {
        const tbody = document.getElementById('armPickupTableBody');
        const newIndex = editedArmPickupData.length;
        
        let newRowHtml = '';
        if (currentArmPickupData.fleet_type === '客户自提') {
            newRowHtml = `
                <tr id="arm-row-${newIndex}" style="border-bottom: 1px solid #eee;">
                    <td style="border: 1px solid #ddd; padding: 8px;">
                        <input type="text" class="arm-input" 
                            data-field="container_number__container_number" 
                            value="" 
                            style="width: 100%; border: 1px solid #ccc; background: #fff;">
                    </td>
                    <td style="border: 1px solid #ddd; padding: 8px;">
                        <input type="text" class="arm-input" 
                            data-field="zipcode" 
                            value="" 
                            style="width: 100%; border: 1px solid #ccc; background: #fff;">
                    </td>
                    <td style="border: 1px solid #ddd; padding: 8px;">
                        <textarea class="arm-textarea" 
                                data-field="shipping_mark" 
                                style="width: 100%; border: 1px solid #ccc; background: #fff; resize: vertical; min-height: 60px;"></textarea>
                    </td>
                    <td style="border: 1px solid #ddd; padding: 8px;">
                        <input type="number" class="arm-input" 
                            data-field="total_pallet" 
                            value="" 
                            style="width: 100%; border: 1px solid #ccc; background: #fff;">
                    </td>
                    <td style="border: 1px solid #ddd; padding: 8px;">
                        <input type="number" class="arm-input" 
                            data-field="total_pcs" 
                            value="" 
                            style="width: 100%; border: 1px solid #ccc; background: #fff;">
                    </td>
                    <td style="border: 1px solid #ddd; padding: 8px;">
                        <input type="text" class="arm-input" 
                            data-field="shipment_batch_number__fleet_number__carrier" 
                            value="" 
                            style="width: 100%; border: 1px solid #ccc; background: #fff;">
                    </td>
                    <td style="border: 1px solid #ddd; padding: 8px;">
                        <input type="datetime-local" class="arm-input" 
                            data-field="shipment_batch_number__fleet_number__appointment_datetime" 
                            value="" 
                            style="width: 100%; border: 1px solid #ccc; background: #fff;">
                    </td>
                    <td style="border: 1px solid #ddd; padding: 8px; text-align: center;">
                        <input type="file" accept="image/*,application/pdf,.pdf,.txt,.csv,.log,.json" class="arm-file" data-field="pickup_image" data-base64=""
                            onchange="handleArmPickupImageChange(this)"
                            style="width: 100%;">
                        <select class="arm-select" data-field="pickup_image_orientation"
                            style="width: 100%; margin-top: 6px; border: 1px solid #ddd; padding: 4px; font-size: 12px; background: #fff;">
                            <option value="horizontal" selected>横向</option>
                            <option value="vertical">竖向</option>
                        </select>
                        <textarea class="arm-textarea" data-field="pickup_file_content" style="display:none;"></textarea>
                        <div class="arm-image-status" style="font-size: 12px; color: #666; padding-top: 4px;">未上传</div>
                    </td>
                    <td style="border: 1px solid #ddd; padding: 8px; text-align: center;">
                        <button onclick="removeArmPickupRow(${newIndex})" 
                                style="background: #dc3545; color: white; border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer;">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `;
        } else {
            // LTL类型的新行
            newRowHtml = `
                <tr id="arm-row-${newIndex}" style="border-bottom: 1px solid #eee;">
                    <td style="border: 1px solid #ddd; padding: 8px;">
                        <input type="text" class="arm-input" 
                            data-field="container_number__container_number" 
                            value="" 
                            style="width: 100%; border: 1px solid #ccc; background: #fff; padding: 4px;">
                    </td>
                    <td style="border: 1px solid #ddd; padding: 8px;">
                        <input type="text" class="arm-input" 
                            data-field="destination" 
                            value="" 
                            style="width: 100%; border: 1px solid #ccc; background: #fff; padding: 4px;">
                    </td>
                    <td style="border: 1px solid #ddd; padding: 8px;">
                        <textarea class="arm-textarea" 
                                data-field="shipping_mark" 
                                style="width: 100%; border: 1px solid #ccc; background: #fff; resize: vertical; min-height: 60px; padding: 4px;"></textarea>
                    </td>
                    <td style="border: 1px solid #ddd; padding: 8px;">
                        <input type="text" class="arm-input" 
                            data-field="shipment_batch_number__ARM_PRO" 
                            value="" 
                            style="width: 100%; border: 1px solid #ccc; background: #fff; padding: 4px;">
                    </td>
                    <td style="border: 1px solid #ddd; padding: 8px;">
                        <input type="number" class="arm-input" 
                            data-field="total_pallet" 
                            value="" 
                            style="width: 100%; border: 1px solid #ccc; background: #fff; padding: 4px;">
                    </td>
                    <td style="border: 1px solid #ddd; padding: 8px;">
                        <input type="number" class="arm-input" 
                            data-field="total_pcs" 
                            value="" 
                            style="width: 100%; border: 1px solid #ccc; background: #fff; padding: 4px;">
                    </td>
                    <td style="border: 1px solid #ddd; padding: 8px;">
                        <input type="text" class="arm-input" 
                            data-field="shipment_batch_number__fleet_number__carrier" 
                            value="" 
                            style="width: 100%; border: 1px solid #ccc; background: #fff; padding: 4px;">
                    </td>
                    <td style="border: 1px solid #ddd; padding: 8px;">
                        <input type="text" class="arm-input address-part" 
                            data-field="address_company" 
                            value="" 
                            style="width: 100%; border: 1px solid #ccc; background: #fff; padding: 4px;">
                    </td>
                    <td style="border: 1px solid #ddd; padding: 8px;">
                        <input type="text" class="arm-input address-part" 
                            data-field="address_road" 
                            value="" 
                            style="width: 100%; border: 1px solid #ccc; background: #fff; padding: 4px;">
                    </td>
                    <td style="border: 1px solid #ddd; padding: 8px;">
                        <input type="text" class="arm-input address-part" 
                            data-field="address_city" 
                            value="" 
                            style="width: 100%; border: 1px solid #ccc; background: #fff; padding: 4px;">
                    </td>
                    <td style="border: 1px solid #ddd; padding: 8px;">
                        <input type="text" class="arm-input address-part" 
                            data-field="address_name" 
                            value="" 
                            style="width: 100%; border: 1px solid #ccc; background: #fff; padding: 4px;">
                    </td>
                    <td style="border: 1px solid #ddd; padding: 8px;">
                        <input type="text" class="arm-input address-part" 
                            data-field="address_phone" 
                            value="" 
                            style="width: 100%; border: 1px solid #ccc; background: #fff; padding: 4px;">
                    </td>
                    <td style="border: 1px solid #ddd; padding: 8px;">
                        <textarea class="arm-textarea" 
                                data-field="shipment_batch_number__note" 
                                style="width: 100%; border: 1px solid #ccc; background: #fff; resize: vertical; min-height: 60px; padding: 4px;"></textarea>
                    </td>
                    <td style="border: 1px solid #ddd; padding: 8px;">
                        <input type="text" class="arm-input" 
                            data-field="slot" 
                            value="" 
                            style="width: 100%; border: 1px solid #ccc; background: #fff; padding: 4px;">
                    </td>
                    <td style="border: 1px solid #ddd; padding: 8px; text-align: center;">
                        <input type="file" accept="image/*,application/pdf,.pdf,.txt,.csv,.log,.json" class="arm-file" data-field="pickup_image" data-base64=""
                            onchange="handleArmPickupImageChange(this)"
                            style="width: 100%;">
                        <select class="arm-select" data-field="pickup_image_orientation"
                            style="width: 100%; margin-top: 6px; border: 1px solid #ddd; padding: 4px; font-size: 12px; background: #fff;">
                            <option value="horizontal" selected>横向</option>
                            <option value="vertical">竖向</option>
                        </select>
                        <textarea class="arm-textarea" data-field="pickup_file_content" style="display:none;"></textarea>
                        <div class="arm-image-status" style="font-size: 12px; color: #666; padding-top: 4px;">未上传</div>
                    </td>
                    <td style="border: 1px solid #ddd; padding: 8px; text-align: center;">
                        <button onclick="removeArmPickupRow(${newIndex})" 
                                style="background: #dc3545; color: white; border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer;">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `;

        }
        
        tbody.insertAdjacentHTML('beforeend', newRowHtml);
        
        // 重新绑定事件
        const newRow = document.getElementById(`arm-row-${newIndex}`);
        const inputs = newRow.querySelectorAll('.arm-input, .arm-textarea, .arm-file, .arm-select');
        inputs.forEach(input => {
            input.addEventListener('change', function() {
                if (input.classList.contains('arm-file')) {
                    handleArmPickupImageChange(input);
                    return;
                }
                if (input.classList.contains('arm-select') && input.getAttribute('data-field') === 'pickup_image_orientation') {
                    const row = input.closest('tr');
                    const fileInput = row ? row.querySelector('.arm-file[data-field="pickup_image"]') : null;
                    if (fileInput && fileInput.files && fileInput.files.length > 0) {
                        handleArmPickupImageChange(fileInput);
                        return;
                    }
                }
                updateArmPickupData();
            });
            input.addEventListener('input', function() {
                updateArmPickupData();
            });
        });
        
        // 添加到数据数组
        const emptyData = {
            container_number__container_number: '',
            destination: '',
            shipping_mark: '',
            shipment_batch_number__ARM_PRO: '',
            total_pallet: '',
            total_pcs: '',
            shipment_batch_number__fleet_number__carrier: '',
            address: ';;;;',  // 空地址用5个分号
            shipment_batch_number__note: '',
            slot: '',
            pickup_image: ''
            ,pickup_image_orientation: 'horizontal'
            ,pickup_file_content: ''
        };
        
        editedArmPickupData.push(emptyData);
    });

    // 删除行
    function removeArmPickupRow(index) {
        if (!confirm('确定要删除这一行吗？')) return;
        
        const row = document.getElementById(`arm-row-${index}`);
        if (row) {
            row.remove();
            editedArmPickupData.splice(index, 1);
            
            // 重新索引所有行
            const rows = document.querySelectorAll('#armPickupTable tbody tr[id^="arm-row-"]');
            rows.forEach((row, newIndex) => {
                row.id = `arm-row-${newIndex}`;
                const deleteBtn = row.querySelector('button');
                if (deleteBtn) {
                    deleteBtn.setAttribute('onclick', `removeArmPickupRow(${newIndex})`);
                }
            });
        }
    }
    function handleArmPickupClick(btn) {
        try {
            const armPickupData = JSON.parse(btn.dataset.armPickup);
            showArmPickupModal(
                btn.dataset.fleetNumber,
                btn.dataset.fleetType,
                armPickupData
            );
        } catch (e) {
            console.error('armPickup JSON parse failed:', btn.dataset.armPickup);
            console.error(e);
            alert('拣货单数据异常，请联系开发');
        }
    }
    // 临时保存拣货单数据
    function saveArmPickupData() {
        updateArmPickupData();
        
        // 保存到localStorage
        try {
            localStorage.setItem(`arm_pickup_${currentArmPickupData.fleet_number}`, JSON.stringify({
                fleet_number: currentArmPickupData.fleet_number,
                fleet_type: currentArmPickupData.fleet_type,
                data: editedArmPickupData,
                saved_at: new Date().toISOString()
            }));
        } catch (e) {}
        
        // 更新页面中的隐藏输入框
        const fleetElements = document.querySelectorAll(`[data-fleet-number="${currentArmPickupData.fleet_number}"]`);
        fleetElements.forEach(element => {
            const downloadForms = element.closest('tr').querySelectorAll('.arm-pickup-data');
            downloadForms.forEach(formInput => {
                formInput.value = JSON.stringify(editedArmPickupData);
            });
        });
        
        alert('拣货单数据已临时保存！');
        closeArmPickupModal();
    }

    // 关闭模态框
    function closeArmPickupModal() {
        document.getElementById('armPickupModal').style.display = 'none';
    }

    // 工具函数：格式化日期时间
    function formatDateTimeForInput(datetimeStr) {
        if (!datetimeStr) return '';
        const date = new Date(datetimeStr);
        if (isNaN(date.getTime())) return '';
        
        const pad = (num) => num.toString().padStart(2, '0');
        return `${date.getFullYear()}-${pad(date.getMonth() + 1)}-${pad(date.getDate())}T${pad(date.getHours())}:${pad(date.getMinutes())}`;
    }

    // 修改下载表单提交事件
    document.addEventListener('DOMContentLoaded', function() {
        // 为下载按钮添加点击事件
        document.querySelectorAll('#readyShip-section .notify-customer-form button').forEach(button => {
            button.addEventListener('click', function(e) {
                const form = this.closest('form');
                const fleetNumber = this.closest('tr').querySelector('.fleet-number-cell')?.dataset?.fleetNumber;
                
                if (fleetNumber) {
                    const latest = getLatestArmPickupData(fleetNumber);
                    if (latest) {
                        const armPickupInput = form.querySelector('.arm-pickup-data');
                        if (armPickupInput) {
                            armPickupInput.value = JSON.stringify(latest);
                        }
                    }
                }
                
                // 正常提交表单
                form.submit();
            });
        });
        
    });
    // 准备上传文件
    function prepareUpload(fleetNumber, button) {       
        const form = button.closest('form');
        const fileInput = form.querySelector('input[type="file"]');
        fileInput.value = '';
        const latest = getLatestArmPickupData(fleetNumber);
        if (latest) {
            const armPickupInput = form.querySelector('.arm-pickup-data');
            if (armPickupInput) {
                armPickupInput.value = JSON.stringify(latest);
            }
        }
        
        // 触发文件选择
        fileInput.click();
    }

    function handleFileChange(input) {
        const form = input.closest('form');

        if (!input.files || input.files.length === 0) {
            alert('请选择要上传的文件');
            return;
        }

        const file = input.files[0];

        // ✅ 严格校验 PDF
        const isPdf =
            file.type === 'application/pdf' ||
            file.name.toLowerCase().endsWith('.pdf');

        if (!isPdf) {
            alert('❌ 仅支持上传 PDF 文件');
            input.value = ''; // 清空已选文件
            return;
        }

        // ===== 原有逻辑，保持不变 =====
        const fleetNumber = form.querySelector(
            'input[name="fleet_number"]'
        )?.value;

        if (fleetNumber) {
            const latest = getLatestArmPickupData(fleetNumber);
            if (latest) {
                const armPickupInput = form.querySelector('.arm-pickup-data');
                if (armPickupInput) {
                    armPickupInput.value = JSON.stringify(latest);
                }
            }
        }

        // 提交
        form.submit();
    }
</script>
