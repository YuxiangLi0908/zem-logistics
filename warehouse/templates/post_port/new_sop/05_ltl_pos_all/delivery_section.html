<!-- post_port/new_sop/03_fleet_schedule/delivery_section.html -->
<style>
    .table-container {
        overflow-x: auto;
        overflow-y: auto;
        max-height: 600px;
        border-radius: 8px;
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
        margin-bottom: 20px;
    }

    .data-table {
        width: 100%;
        border-collapse: collapse;
    }

    .data-table th {
        position: sticky;
        top: 0;
        background: var(--secondary-color);
        color: white;
        padding: 12px;
        text-align: left;
        font-weight: 600;
        font-size: 0.9rem;
    }

    .data-table td {
        padding: 12px;
        border-bottom: 1px solid #eaecef;
        font-size: 0.85rem;
    }

    .data-table tr:nth-child(even) {
        background-color: #f9fafb;
    }

    .data-table tr:hover {
        background-color: #edf2f7;
    }

    .search-row input {
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 0.8rem;
    }

    .table-input {
        padding: 6px 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 0.8rem;
    }

    /* 物流跟踪输入框样式 */
    .tracking-input {
        width: 100%;
        min-width: 200px;
        padding: 6px 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 0.8rem;
        resize: vertical;
        min-height: 60px;
        font-family: inherit;
        line-height: 1.4;
        box-sizing: border-box;
    }

    .tracking-input:focus {
        outline: none;
        border-color: #4a90e2;
        box-shadow: 0 0 0 2px rgba(74, 144, 226, 0.2);
    }

    /* 物流跟踪表单 */
    .tracking-form {
        margin: 0;
        display: flex;
        flex-direction: column;
        gap: 5px;
    }

    .table-btn {
        padding: 6px 12px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.8rem;
        font-weight: 500;
        transition: all 0.3s;
    }

    .btn-success-small {
        background: var(--success-color);
        color: white;
    }

    .btn-success-small:hover {
        background: #27ae60;
    }

    .btn-danger-small {
        background: var(--danger-color);
        color: white;
    }

    .btn-danger-small:hover {
        background: #c0392b;
    }

    .btn-primary-small {
        background: #4a90e2;
        color: white;
    }

    .btn-primary-small:hover {
        background: #3a7bc8;
    }

    .status-span-red {
        background-color: #ff4444; 
        color: #ffffff !important; 
        padding: 2px 6px;
        border-radius: 3px;
        font-weight: bold;
        display: inline-block;
    }

    .status-span-yellow {
        background-color: #ffcc00;
        color: #000000; 
        padding: 2px 6px;
        border-radius: 3px;
        font-weight: bold;
        display: inline-block;
    }
</style>

<table class="data-table">
    <thead>
        <tr>
            <th style="width:160px;">出库批次</th>
            <th style="width:150px;">预约批次</th>
            <th>预约发车日期</th>
            <th style="width:140px;">实际发车日期</th>
            <th style="width:80px;">板数</th> 
            <th style="width:80px;">件数</th> 
            <th style="width:120px;">柜号</th>
            <th style="width:160px;">唛头</th>
            <th style="min-width:200px;">物流跟踪</th> 
            <th>备注</th>
            <th>车次成本</th>
            <th>实际送达时间</th>
            <th>车次异常</th>
        </tr>
        <tr class="search-row">
            <td><input type="text" class="header-search" placeholder="搜索出库批次" data-column="0"></td>
            <td><input type="text" class="header-search" placeholder="搜索预约批次" data-column="1"></td>
            <td><input type="text" class="header-search" placeholder="搜索预约发车日期" data-column="2"></td>
            <td><input type="text" class="header-search" placeholder="搜索实际发车日期" data-column="3"></td>
            <td><input type="text" class="header-search" placeholder="搜索板数" data-column="4"></td>
            <td><input type="text" class="header-search" placeholder="搜索件数" data-column="5"></td>
            <td><input type="text" class="header-search" placeholder="搜索柜号" data-column="6"></td>
            <td><input type="text" class="header-search" placeholder="搜索唛头" data-column="7"></td>
            <td><input type="text" class="header-search" placeholder="搜索物流跟踪" data-column="8"></td>
            <td><input type="text" class="header-search" placeholder="搜索备注" data-column="9"></td>
            <td><input type="text" class="header-search" placeholder="搜索成本" data-column="10"></td>
            <td></td>
            <td></td>
        </tr>
    </thead>
    <tbody>
        {% for s in delivery_data %}
            {% with pairs=s.container_mark_pairs %}
                {% if pairs and pairs|length > 0 %}
                    {% for p in pairs %}
                    <tr data-shipment="{{ s.shipment_batch_number }}" {% if forloop.first %}data-group-first="1"{% endif %}>
                        {% if forloop.first %}
                        <td rowspan="{{ pairs|length }}" style="max-width: 120px; word-break: break-all;">
                            {{ s.fleet_number.fleet_number }}<br>
                            <span style="color: #7f8c8d; font-size: 0.8em;">{{ s.fleet_number.pickup_number|default_if_none:'' }}</span>
                        </td>
                        <td rowspan="{{ pairs|length }}" style="max-width: 120px; word-break: break-all;">{{ s.shipment_batch_number }}</td>
                        <td rowspan="{{ pairs|length }}">{{ s.fleet_number.appointment_datetime|date:"M-j H:i" }}</td>
                        <td rowspan="{{ pairs|length }}">
                            {% if s.fleet_number.arrival_status == "past_due" %}
                            <span class="status-span-red">{{ s.fleet_number.departured_at|date:"M-j H:i" }}</span>
                            {% elif s.fleet_number.arrival_status == "need_attention" %}
                            <span class="status-span-yellow">{{ s.fleet_number.departured_at|date:"M-j H:i" }}</span>
                            {% else %}
                            {{ s.fleet_number.departured_at|date:"M-j H:i" }}
                            {% endif %}
                        </td>
                        <td rowspan="{{ pairs|length }}">{{ s.total_pallet|floatformat:0 }}</td>
                        <td rowspan="{{ pairs|length }}">{{ s.total_pcs|default:0|floatformat:0 }}</td> 
                        {% endif %}
                        <td>{{ p.container_number }}</td>
                        <td style="word-break: break-all;">{{ p.shipping_mark }}</td>
                        {% if forloop.first %}
                        <td rowspan="{{ pairs|length }}" style="min-width: 200px;">
                            <form method="post" class="tracking-form" action="">
                                {% csrf_token %}
                                <textarea class="tracking-input" 
                                          name="ltl_shipping_tracking" 
                                          placeholder="输入物流跟踪信息..."
                                          oninput="autoResizeTextarea(this)">{{ s.fleet_number.ltl_shipping_tracking|default:"" }}</textarea>
                                <input type="hidden" name="step" value="save_shipping_tracking">
                                <input type="hidden" name="fleet_number" value="{{ s.fleet_number.fleet_number }}">
                                <input type="hidden" name="active_tab" value="ready">
                                <input type="hidden" name="warehouse" value="{{ warehouse }}">
                                <button type="submit" class="table-btn btn-primary-small">保存跟踪</button>
                            </form>
                        </td>
                        <td rowspan="{{ pairs|length }}" style="max-width: 120px; word-break: break-all;">{{ s.fleet_number.note|default_if_none:"" }}</td>
                        <td rowspan="{{ pairs|length }}" style="max-width: 120px; word-break: break-all;">
                            {% if s.fleet_number.fleet_cost %}
                                {{ s.fleet_number.fleet_cost }}
                            {% else %}
                                <span style="color: #6c757d; font-style: italic;">未录入</span>
                            {% endif %}
                        </td>
                        <td rowspan="{{ pairs|length }}">
                            <form method="post" enctype="multipart/form-data" action="" style="display: flex; gap: 5px; align-items: center;">
                                {% csrf_token %}
                                <input type="datetime-local" name="arrived_at" class="table-input" style="font-size: 0.8rem;" required>
                                <input type="hidden" name="step" value="confirm_delivery">
                                <input type="hidden" name="fleet_number" value="{{ s.fleet_number.fleet_number }}">
                                <input type="hidden" name="shipment_batch_number" value="{{ s.shipment_batch_number }}">
                                <input type="hidden" name="page" value="ltl_delivery_section">
                                <input type="hidden" name="active_tab" value="ready">
                                <input type="hidden" name="warehouse" value="{{ warehouse }}">
                                <button type="submit" class="table-btn btn-success-small">确认送达</button>
                            </form>
                        </td>
                        <td rowspan="{{ pairs|length }}">
                            <button type="button" class="table-btn btn-danger-small" onclick="abnormalPopUp('{{ s.fleet_number.fleet_number }}','{{ s.shipment_batch_number }}','{{ s.fleet_number.fleet_cost }}')">异常</button>
                        </td>
                        {% endif %}
                    </tr>
                    {% endfor %}
                {% else %}
                    <tr data-shipment="{{ s.shipment_batch_number }}" data-group-first="1">
                        <td style="max-width: 120px; word-break: break-all;">
                            {{ s.fleet_number.fleet_number }}<br>
                            <span style="color: #7f8c8d; font-size: 0.8em;">{{ s.fleet_number.pickup_number|default_if_none:'' }}</span>
                        </td>
                        <td style="max-width: 120px; word-break: break-all;">{{ s.shipment_batch_number }}</td>
                        <td>{{ s.fleet_number.appointment_datetime|date:"M-j H:i" }}</td>
                        <td>
                            {% if s.fleet_number.arrival_status == "past_due" %}
                            <span class="status-span-red">{{ s.fleet_number.departured_at|date:"M-j H:i" }}</span>
                            {% elif s.fleet_number.arrival_status == "need_attention" %}
                            <span class="status-span-yellow">{{ s.fleet_number.departured_at|date:"M-j H:i" }}</span>
                            {% else %}
                            {{ s.fleet_number.departured_at|date:"M-j H:i" }}
                            {% endif %}
                        </td>
                        <td>{{ s.total_pallet|floatformat:0 }}</td>
                        <td>{{ s.total_pcs|default:0|floatformat:0 }}</td> 
                        <td></td>
                        <td></td>
                        <td style="min-width: 200px;">
                            <form method="post" class="tracking-form" action="">
                                {% csrf_token %}
                                <textarea class="tracking-input" 
                                          name="ltl_shipping_tracking" 
                                          placeholder="输入物流跟踪信息..."
                                          oninput="autoResizeTextarea(this)">{{ s.fleet_number.ltl_shipping_tracking|default:"" }}</textarea>
                                <input type="hidden" name="step" value="save_shipping_tracking">
                                <input type="hidden" name="fleet_number" value="{{ s.fleet_number.fleet_number }}">
                                <input type="hidden" name="active_tab" value="ready">
                                <input type="hidden" name="warehouse" value="{{ warehouse }}">
                                <button type="submit" class="table-btn btn-primary-small">保存跟踪</button>
                            </form>
                        </td>
                        <td style="max-width: 120px; word-break: break-all;">{{ s.fleet_number.note|default_if_none:"" }}</td>
                        <td style="max-width: 120px; word-break: break-all;">
                            {% if s.fleet_number.fleet_cost %}
                                {{ s.fleet_number.fleet_cost }}
                            {% else %}
                                <span style="color: #6c757d; font-style: italic;">未录入</span>
                            {% endif %}
                        </td>
                        <td>
                            <form method="post" enctype="multipart/form-data" action="" style="display: flex; gap: 5px; align-items: center;">
                                {% csrf_token %}
                                <input type="datetime-local" name="arrived_at" class="table-input" style="font-size: 0.8rem;" required>
                                <input type="hidden" name="step" value="confirm_delivery">
                                <input type="hidden" name="fleet_number" value="{{ s.fleet_number.fleet_number }}">
                                <input type="hidden" name="shipment_batch_number" value="{{ s.shipment_batch_number }}">
                                <input type="hidden" name="page" value="ltl_delivery_section">
                                <input type="hidden" name="active_tab" value="ready">
                                <input type="hidden" name="warehouse" value="{{ warehouse }}">
                                <button type="submit" class="table-btn btn-success-small">确认送达</button>
                            </form>
                        </td>
                        <td>
                            <button type="button" class="table-btn btn-danger-small" onclick="abnormalPopUp('{{ s.fleet_number.fleet_number }}','{{ s.shipment_batch_number }}','{{ s.fleet_number.fleet_cost }}')">异常</button>
                        </td>
                    </tr>
                {% endif %}
            {% endwith %}
        {% endfor %}
    </tbody>
</table>

<script>
    function initializeDeliverySection() {
        // 为搜索框添加事件监听
        const searchInputs = document.querySelectorAll('#ready-section .header-search');
        searchInputs.forEach(input => {
            ['input', 'keyup', 'change'].forEach(evt => {
                input.addEventListener(evt, function() {
                    filterDeliveryTable();
                });
            });
        });

        // 初始化所有物流跟踪输入框的高度
        document.querySelectorAll('.tracking-input').forEach(autoResizeTextarea);
    }

    // 自动调整textarea高度
    function autoResizeTextarea(textarea) {
        // 重置高度以计算准确的高度
        textarea.style.height = 'auto';
        // 设置最小高度为60px，然后根据内容增加
        const newHeight = Math.max(60, textarea.scrollHeight);
        textarea.style.height = newHeight + 'px';
    }

    function filterDeliveryTable() {
        const table = document.querySelector('#ready-section table');
        const tbody = table.getElementsByTagName('tbody')[0];
        const rows = Array.from(tbody.getElementsByTagName('tr'));
        const inputs = Array.from(document.querySelectorAll('#ready-section .header-search'));
        function normalize(str) {
            return (str || '').toString().toUpperCase().replace(/\s+/g, '');
        }
        const filters = inputs
            .map(inp => ({ idx: parseInt(inp.getAttribute('data-column')), val: normalize(inp.value || '') }))
            .filter(f => f.val.length > 0);

        const groupMap = {};
        rows.forEach(r => {
            const key = r.getAttribute('data-shipment') || '';
            if (!key) return;
            if (!groupMap[key]) groupMap[key] = [];
            groupMap[key].push(r);
        });

        function getFirstRow(groupRows) {
            for (const r of groupRows) {
                if (r.getAttribute('data-group-first') === '1') return r;
            }
            return groupRows[0];
        }

        function getText(row, colIdx, firstRow) {
            if (colIdx === 8) {
                const cell = firstRow.getElementsByTagName('td')[8];
                if (!cell) return '';
                const ta = cell.querySelector('.tracking-input');
                return normalize(ta ? ta.value : (cell.textContent || ''));
            }
            if (colIdx === 6 || colIdx === 7) {
                const isFirst = row === firstRow;
                const realIdx = isFirst ? colIdx : (colIdx === 6 ? 0 : 1);
                const cells = row.getElementsByTagName('td');
                const cell = cells[realIdx];
                return normalize((cell ? (cell.textContent || cell.innerText) : '') || '');
            }
            const cells = firstRow.getElementsByTagName('td');
            const cell = cells[colIdx];
            return normalize((cell ? (cell.textContent || cell.innerText) : '') || '');
        }

        Object.keys(groupMap).forEach(key => {
            const grp = groupMap[key];
            const firstRow = getFirstRow(grp);
            let visible = true;
            for (const f of filters) {
                if (f.idx === 6 || f.idx === 7) {
                    let anyMatch = false;
                    for (const r of grp) {
                        const txt = getText(r, f.idx, firstRow);
                        if (txt.indexOf(f.val) > -1) {
                            anyMatch = true;
                            break;
                        }
                    }
                    if (!anyMatch) {
                        visible = false;
                        break;
                    }
                } else {
                    const txt = getText(firstRow, f.idx, firstRow);
                    if (txt.indexOf(f.val) === -1) {
                        visible = false;
                        break;
                    }
                }
            }
            grp.forEach(r => {
                r.style.display = visible ? '' : 'none';
            });
        });
    }

    function abnormalPopUp(fleetNumber, batchNumber,fleet_cost) {
        // 设置隐藏字段的值
        document.getElementById('abnormalFleetNumber').value = fleetNumber;
        document.getElementById('abnormalShipmentNumber').value = batchNumber;
        document.getElementById('abnormalFleetCost').value = fleet_cost;
        
        // 显示弹框
        document.getElementById('abnormalModal').style.display = 'block';
    }

    // 关闭异常弹框函数
    function closeAbnormalModal() {
        document.getElementById('abnormalModal').style.display = 'none';
    }

    // 页面加载完成后初始化
    document.addEventListener('DOMContentLoaded', function() {
        initializeDeliverySection();
    });
</script>
