{% load custom_filters %}
<style>
    /* 已放行客提货物页面样式 */
    .batch-actions {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 8px;
        align-items: center;
        border: 1px solid #e9ecef;
        flex-wrap: wrap;
    }
    .bol-input, .pickup-date-input {
        width: 100%;
        padding: 4px 6px;
        border: 1px solid #ced4da;
        border-radius: 4px;
        font-size: 0.85rem;
        box-sizing: border-box;
    }
    .mark-col {
        min-width: 140px;
        max-width: 160px;
        word-wrap: break-word;
        word-break: break-word;
        white-space: normal;
        line-height: 1.5;
    }

    .pickup-date-input {
        width: 100%;
        padding: 4px 6px;
        border: 1px solid #ced4da;
        border-radius: 4px;
        font-size: 0.85rem;
        box-sizing: border-box;
        font-family: inherit;
    }
    
    .pickup-date-input:focus {
        outline: none;
        border-color: #80bdff;
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
    }
    .pickup-date-input::-webkit-datetime-edit-fields-wrapper {
        padding: 0 !important;
        margin: 0 !important;
    }
    .bol-input:focus {
        outline: none;
        border-color: #80bdff;
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
    }
    .selected-count {
        font-weight: 600;
        color: var(--secondary-color);
    }
    .pallet-size-container {
        position: relative;
    }
    
    .editable-textarea {
        width: 100%;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        padding: 6px 8px;
        font-size: 0.85rem;
        resize: vertical;
        min-height: 60px;
        box-sizing: border-box;
        font-family: inherit;
    }
    
    .editable-textarea:focus {
        outline: none;
        border-color: #80bdff;
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
    }
    .help-tooltip {
        position: absolute;
        top: 2px;
        right: 2px;
        cursor: help;
        color: #6c757d;
        font-size: 12px;
        width: 16px;
        height: 16px;
        text-align: center;
        line-height: 16px;
        border-radius: 50%;
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        z-index: 10;
    }

    /* 工具提示内容 - 默认隐藏 */
    .tooltip-content {
        display: none;
        position: absolute;
        top: 100%;
        right: 0;
        width: 320px;
        padding: 12px;
        background: white;
        border: 1px solid #ddd;
        border-radius: 4px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        z-index: 1000;
        font-size: 12px;
        white-space: normal;
        line-height: 1.5;
        text-align: left;
    }

    /* 悬停时显示工具提示 */
    .help-tooltip:hover .tooltip-content {
        display: block;
    }

    /* 工具提示内的样式 */
    .tooltip-content strong {
        color: #2c3e50;
        font-weight: 600;
    }

    .tooltip-content br {
        margin-bottom: 4px;
    }
    /* 表格样式 */
    .table-container {
        overflow-x: auto;
        overflow-y: visible;
        max-height: 75vh;
        border-radius: 8px;
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
        margin-bottom: 20px;
    }

    .data-table {
        width: 100%;
        border-collapse: collapse;
    }

    .data-table th {
        position: sticky;
        top: 0;
        background: #2c3e50;
        color: white;
        padding: 12px;
        text-align: left;
        font-weight: 600;
        font-size: 0.9rem;
        z-index: 102 !important;
    }

    .data-table td {
        padding: 10px 12px;
        border-bottom: 1px solid #eaecef;
        font-size: 0.85rem;
        vertical-align: top; /* 顶部对齐 */
    }

    /* 筛选行样式 */
    .filter-row {
        background-color: #f8f9fa !important;
        position: sticky;
        top: 48px;
        z-index: 5;
    }

    .filter-row td {
        padding: 8px 12px;
        background-color: #f8f9fa;
        border-bottom: 2px solid #dee2e6;
    }

    .filter-input, .filter-select {
        width: 100%;
        padding: 6px 10px;
        border: 1px solid #ced4da;
        border-radius: 4px;
        font-size: 0.85rem;
        box-sizing: border-box;
        background-color: white;
    }

    .filter-input:focus, .filter-select:focus {
        outline: none;
        border-color: #80bdff;
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
    }

    .follow-col {
        min-width: 200px;
        max-width: 300px;
    }

    .data-table tr:nth-child(even):not(.filter-row) {
        background-color: #f9fafb;
    }

    .data-table tr:hover:not(.filter-row) {
        background-color: #edf2f7;
    }

    .checkbox-cell {
        width: 20px;
        text-align: center;
    }
    .customer-col {
        min-width: 120px;
        max-width: 200px;
        word-wrap: break-word;
        word-break: break-word;
        white-space: normal;
        line-height: 1.5;
    }
    /* 操作按钮样式 */
    .action-btn {
        padding: 6px 12px;
        border: none;
        border-radius: 4px;
        font-size: 0.85rem;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 5px;
        transition: all 0.2s;
    }

    .btn-schedule {
        background-color: #27ae60 !important;
        color: white !important;
    }
    .btn-schedule:hover {
        background-color: #219150 !important;
    }
    
    .btn-success {
        background-color: #28a745;
        color: white;
    }

    .btn-success:hover {
        background-color: #218838;
    }

    .btn-copy-alt {
        background-color: #3498db !important;
        color: white !important;
    }
    .btn-copy-alt:hover {
        background-color: #2980b9 !important;
    }

    .btn-save-batch {
        background-color: #5f27cd !important;
        color: white !important;
    }
    .btn-save-batch:hover {
        background-color: #48dbfb !important; /* 悬停时稍微变亮 */
    }

    .btn-delivery-batch {
        background-color: #f39c12 !important;
        color: white !important;
    }
    .btn-delivery-batch:hover {
        background-color: #e67e22 !important;
    }

    .btn-clear-filter {
        background-color: #95a5a6 !important;
        color: white !important;
    }
    .selected-stats {
        display: flex; 
        align-items: center;
        gap: 15px;
        padding: 8px 15px;
        background: #e8f5e9;
        border-radius: 6px;
        border: 1px solid #c8e6c9;
        font-size: 0.9rem;
    }

    /* 列宽度调整 */
    .pallet-col {
        min-width: 80px;
        max-width: 100px;
        text-align: center;
    }
    
    /* 板数标记样式 */
    .pallet-count {
        font-weight: bold;
    }
    
    .pallet-tag {
        display: inline-block;
        font-size: 10px;
        padding: 2px 6px;
        border-radius: 3px;
        margin-left: 5px;
        font-weight: bold;
        text-transform: uppercase;
    }
    
    .pallet-tag-act {
        background-color: #28a745;
        color: white;
    }
    
    .pallet-tag-est {
        background-color: #ffc107;
        color: #212529;
    }

    .quote-col {
        min-width: 100px;
        max-width: 120px;
    }

    .quote-note-col {
        min-width: 150px;
        max-width: 200px;
    }
    .delivery-method-col {
        min-width: 140px;
    }
    .note-col {
        min-width: 160px;
        max-width: 200px;
    }
    .note-input {
        width: 100%;
        border: 1px solid #ced4da;
        border-radius: 4px;
        padding: 4px 8px;
        font-size: 0.85rem;
        resize: vertical;
        min-height: 32px;
        line-height: 1.4;
    }
    .command-col {
        min-width: 180px;
        max-width: 250px;
    }
    /* 派送方式下拉框样式 */
    .method-select {
        width: 100%;
        padding: 4px;
        border: 1px solid #ced4da;
        border-radius: 4px;
        font-size: 0.85rem;
    }
    .qty-input, .outbound-fee-input, .unit-quote-input, .outbound-fee-note-input {
        width: 100%;
        padding: 6px 8px;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        font-size: 0.85rem;
        box-sizing: border-box;
        font-family: inherit;
    }

    /* BOL号列宽度 */
    .bol-col {
        min-width: 120px;
        max-width: 150px;
    }
    .company-col {
        min-width: 130px;
        max-width: 160px;
    }

    /* 托盘尺寸列 */
    .pallet-size-col {
        min-width: 180px;
        max-width: 250px;
    }

    /* 地址列样式 */
    .address-col {
        min-width: 160px;
        max-width: 250px;
    }

    .address-col:hover, .pallet-size-col:hover {
        overflow: visible;
        white-space: normal;
        position: relative;
        z-index: 10;
        background: white;
        box-shadow: 0 0 10px rgba(0,0,0,0.1);
        border-radius: 4px;
        padding: 8px;
    }

    .action-col {
        min-width: 120px;
        text-align: center;
    }

    .small-btn {
        padding: 4px 8px;
        font-size: 0.8rem;
    }

    .pallet-size-input {
        width: 100%;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        padding: 6px 8px;
        font-size: 0.85rem;
        resize: vertical;
        min-height: 60px; 
        box-sizing: border-box;
        font-family: inherit;
        line-height: 1.4;
    }

    .carrier-input, .address-input, .bol-input {
        width: 100%;
        padding: 4px 8px;
        border: 1px solid #ced4da;
        border-radius: 4px;
        font-size: 0.85rem;
        box-sizing: border-box;
        font-family: inherit;
        resize: vertical; /* 允许垂直调整大小 */
        min-height: 32px; /* 最小高度 */
        line-height: 1.4;
    }

    .carrier-input:focus, .address-input:focus, .pallet-size-input:focus,
    .bol-input:focus {
        outline: none;
        border-color: #80bdff;
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
    }

    /* 多行文本显示 */
    .pallet-size-display, .address-display {
        white-space: pre-line; /* 保留换行 */
        line-height: 1.4;
        max-height: none;
        overflow: visible;
    }

    /* 隐藏表单 */
    .hidden-form {
        display: none;
    }
    
    /* 日期列样式 */
    .date-col {
        min-width: 100px;
        max-width: 120px;
    }

    .editable-textarea, .follow-input, .address-input, 
    .pallet-size-input, .bol-input, .pro-input {
        overflow-y: hidden; /* 关键：交给 JS 处理高度，避免滚动条 */
        resize: vertical;   /* 保留手动调整功能 */
        min-height: 32px;
        line-height: 1.5;
        box-sizing: border-box; /* 确保宽度包含内边距 */
    }
    /* 针对 is_pickup_priority == 0 的行添加背景色 */
    .data-table tbody tr.priority-highlight {
        background-color: #e7f5ff !important; /* 极浅的黄色 */
    }

    /* 如果你希望鼠标悬停时颜色加深一点，可以加这个 */
    .data-table tbody tr.priority-highlight:hover {
        background-color: #d0ebff !important;
    }

    /* 确保行内的输入框背景色透明，以便透出底色 */
    .priority-highlight td {
        background-color: transparent !important;
    }
</style>

<div id="selfpick-page">
    <!-- 批量操作区域 -->
    <div class="batch-actions">
        <span class="selected-count">已选择 <span id="selfpick_selectedSelfPickCount">0</span> 条</span>

        <div id="selfpick_selectedStats" class="selected-stats">
            <span style="font-weight: 600; color: #2e7d32;">
                选中总板数: <span id="selfpick_selectedSelfPickPalletsCount">0</span>
            </span>
            <span style="font-weight: 600; color: #1565c0;">
                选中总CBM: <span id="selfpick_selectedSelfPickCbmCount">0.00</span>
            </span>
            <span style="font-weight: 600; color: #7b1fa2;">
                选中总重量: <span id="selfpick_selectedSelfPickWeightLbsCount">0.00</span> lbs
            </span>
        </div>
        
        <button class="action-btn btn-schedule" onclick="scheduleShipment()">
            <i class="fas fa-calendar-check"></i> 预约出库
        </button>
        <button class="action-btn btn-copy-alt" onclick="copySelectedRows()" title="复制选中行的柜号、目的地、唛头">
            <i class="fas fa-copy"></i> 复制选中行
        </button>
        <button class="action-btn btn-save-batch" onclick="selfpick_batchSaveRows()">
            <i class="fas fa-save"></i> 批量保存参数
        </button>
        <button class="action-btn btn-delivery-batch" onclick="batchUpdateDeliveryMethod()">
            <i class="fas fa-truck-loading"></i> 批量修改派送方式
        </button>
        <button class="action-btn btn-clear-filter" onclick="clearSelfPickAllFilters()">
            <i class="fas fa-times"></i> 清空筛选
        </button>
        <div class="filter-notice" style="font-size: 14px; padding: 8px 12px;">
            <i class="fas fa-filter"></i> 
            当前显示 <strong>{{ warehouse }}</strong> 入库仓库的货物，筛选条件：
            <strong>未预约出库</strong>、
            <strong><u>私仓</u></strong>、
            <strong>柜子未取消</strong>、
            <strong>柜子非直送</strong>、
            <strong>柜子已放行</strong>、
            <strong>派送方式为自提</strong>
        </div>
        <span style="display: inline-block; color: white; background-color: #3498db; padding: 2px 10px; border-radius: 12px; font-size: 0.85em; margin-left: 8px; border: 2px solid #2980b9; font-weight: bold; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">
            <span id="selfpick_filteredCount">{{ selfpick_cargos|length }}</span>
        </span>
    </div>

    <!-- 数据表格 -->
    <div class="table-container">
        <table class="data-table" id="selfpick_cargoTable">
            <thead>
                <tr>
                    <th class="checkbox-cell">
                        <input type="checkbox" id="selfpick_selectAllCargos">
                    </th>
                    <th>跟进状态</th>
                    <th class="customer-col">客户</th>
                    <th class="date-col">拆柜日期</th>
                    <th class="delivery-method-col">派送方式</th>
                    <th>柜号</th>
                    <th>目的地</th>
                    <th class="mark-col">唛头</th>
                    <th class="note-col">备注</th> 
                    <th class="command-col">指令</th>
                    <th>CBM</th>
                    <th>件数</th>
                    <th>重量kg</th>
                    <th>重量lbs</th>
                    <th class="pallet-col">板数</th>
                    <th class="pallet-size-col">托盘尺寸</th>
                    <th class="quote-col">出库数量</th> 
                    <th class="quote-col">单板费</th> 
                    <th class="quote-col">出库费</th> 
                    <th class="quote-note-col">出库费备注</th> 
                    <th class="bol-col">BOL号</th>                   
                    <th>承运公司</th>
                    <th class="address-col">地址</th>
                    <th class="date-col">预计提货日期</th>
                    <th class="action-col">操作</th>
                </tr>
            </thead>
            <tbody>
                <!-- 筛选行 -->
                <tr class="filter-row">
                    <td class="checkbox-cell"></td>
                    <td>
                        <input type="text" class="filter-input" placeholder="筛选跟进状态..." data-column="0" onkeyup="applySelfPickColumnFilter(this)">
                    </td>
                    <td>
                        <input type="text" class="filter-input" placeholder="筛选客户..." data-column="1" onkeyup="applySelfPickColumnFilter(this)">
                    </td>
                    <td>
                        <input type="text" class="filter-input" placeholder="筛选拆柜日期..." data-column="2" onkeyup="applySelfPickColumnFilter(this)">
                    </td>
                    <td>
                        <input type="text" class="filter-input" placeholder="筛选方式..." data-column="3" onkeyup="applySelfPickColumnFilter(this)">
                    </td>
                    <td>
                        <input type="text" class="filter-input" placeholder="筛选柜号..." data-column="4" onkeyup="applySelfPickColumnFilter(this)">
                    </td>
                    <td>
                        <input type="text" class="filter-input" placeholder="筛选目的地..." data-column="5" onkeyup="applySelfPickColumnFilter(this)">
                    </td>
                    <td class="mark-col">
                        <input type="text" class="filter-input" placeholder="筛选唛头..." data-column="6" onkeyup="applySelfPickColumnFilter(this)">
                    </td>
                    <td>
                        <input type="text" class="filter-input" placeholder="筛选备注..." data-column="7" onkeyup="applySelfPickColumnFilter(this)">
                    </td>
                    <td>
                        <input type="text" class="filter-input" placeholder="筛选指令..." data-column="8" onkeyup="applySelfPickColumnFilter(this)">
                    </td> 
                    <td>
                        <input type="text" class="filter-input" placeholder="筛选CBM..." data-column="9" onkeyup="applySelfPickColumnFilter(this)">
                    </td>
                    <td>
                        <input type="text" class="filter-input" placeholder="筛选件数..." data-column="10" onkeyup="applySelfPickColumnFilter(this)">
                    </td>
                    <td>
                        <input type="text" class="fleet-filter-input" placeholder="筛选重量..." data-column="11" onkeyup="applySelfPickColumnFilter(this)">
                    </td>
                    <td>
                        <input type="text" class="fleet-filter-input" placeholder="筛选重量..." data-column="12" onkeyup="applySelfPickColumnFilter(this)">
                    </td>
                    <td>
                        <input type="text" class="filter-input" placeholder="筛选板数..." data-column="13" onkeyup="applySelfPickColumnFilter(this)">
                    </td>
                    <td>
                        {% comment %}
                        托盘尺寸筛选只对PALLET数据有效
                        {% endcomment %}
                        <input type="text" class="filter-input" placeholder="筛选托盘尺寸..." data-column="14" onkeyup="applySelfPickColumnFilter(this)">
                    </td>
                    <td>
                        <input type="text" class="filter-input" placeholder="筛选出库数量..." data-column="15" onkeyup="applySelfPickColumnFilter(this)">
                    </td> 
                    <td>
                        <input type="text" class="filter-input" placeholder="筛选单板费..." data-column="16" onkeyup="applySelfPickColumnFilter(this)">
                    </td> 
                    <td>
                        <input type="text" class="filter-input" placeholder="筛选出库费..." data-column="17" onkeyup="applySelfPickColumnFilter(this)">
                    </td> 
                    <td>
                        <input type="text" class="filter-input" placeholder="筛选出库费备注..." data-column="18" onkeyup="applySelfPickColumnFilter(this)">
                    </td> 
                    <td>
                        <input type="text" class="filter-input" placeholder="筛选BOL号..." data-column="19" onkeyup="applySelfPickColumnFilter(this)">
                    </td>                  
                    <td>
                        <input type="text" class="filter-input" placeholder="筛选承运公司..." data-column="20" onkeyup="applySelfPickColumnFilter(this)">
                    </td>
                    <td>
                        <input type="text" class="filter-input" placeholder="筛选地址..." data-column="21" onkeyup="applySelfPickColumnFilter(this)">
                    </td>
                    <td>
                        <input type="text" class="filter-input" placeholder="筛选提货日期..." data-column="22" onkeyup="applySelfPickColumnFilter(this)">
                    </td>
                    <td class="action-col">
                        <!-- 操作列不需要筛选 -->
                    </td>
                </tr>

                <!-- 数据行 -->
                {% for cargo in selfpick_cargos %}
                <tr class="data-row {% if cargo.is_pickup_priority == 0 %}priority-highlight{% endif %}"
                    data-cargo-id="{% if cargo.plt_ids %}plt_{{ cargo.plt_ids }}{% else %}{{ cargo.ids }}{% endif %}"
                    data-customer="{{ cargo.customer_name|default:'' }}"
                    data-follow-status="{{ cargo.ltl_follow_status|default:'' }}"
                    data-offload-date="{{ cargo.offload_at|date:'Y-m-d'|default:'' }}"
                    data-container-number="{{ cargo.container_numbers|default:'' }}"
                    data-destination="{{ cargo.destination|default:'' }}"
                    data-shipping-mark="{{ cargo.shipping_marks|default:'' }}"
                    data-cbm="{{ cargo.total_cbm|default:0 }}"
                    data-pcs="{{ cargo.total_pcs|default:0 }}"
                    {% if cargo.total_n_pallet_act %}
                        data-pallets="{{ cargo.total_n_pallet_act }}"
                    {% elif cargo.total_n_pallet_est %}
                        data-pallets="{{ cargo.total_n_pallet_est }}"
                    {% else %}
                        data-pallets="0"
                    {% endif %}
                    data-pallet-size="{{ cargo.pallet_size_formatted|default:'' }}"
                    data-bol="{{ cargo.ltl_bol_num|default:'' }}"
                    data-pickup-time="{{ cargo.est_pickup_time|default:'' }}"
                    data-carrier="{{ cargo.carrier_company|default:'' }}"
                    data-address="{{ cargo.address|default:'' }}"
                    data-weight-lbs="{{ cargo.total_weight_lbs|default:0 }}"
                    data-pallet-items='{{ cargo.pallet_items_json|safe }}'>
                    <td class="checkbox-cell">
                        <input type="checkbox" class="self-cargo-checkbox" 
                            value="{% if cargo.plt_ids %}plt_{{ cargo.plt_ids }}{% else %}{{ cargo.ids }}{% endif %}"
                            onchange="updateSelfPickSelectedCount()">
                    </td>
                    <td class="follow-col">
                        <textarea class="editable-textarea follow-input"
                            data-id="{% if cargo.plt_ids %}plt_{{ cargo.plt_ids }}{% else %}{{ cargo.ids }}{% endif %}"
                            placeholder="输入跟进状态"
                            oninput="autoResizeTextarea(this)"                  
                            >{{ cargo.ltl_follow_status|default:'' }}</textarea>
                    </td>
                    <td class="customer-col">{{ cargo.customer_name|default:"-" }}</td>                   
                    <td class="date-col">
                        {% if cargo.offload_at %}
                            <span class="fleet-month-day">
                                {{ cargo.offload_at }}
                                {% if cargo.offload_tag == "实际" %}
                                    <span style="color:#e53935">{{ cargo.offload_tag }}</span>
                                {% elif cargo.offload_tag == "预计" %}
                                    <span style="color:#fb8c00">{{ cargo.offload_tag }}</span>
                                {% else %}
                                    <span style="color:#757575">{{ cargo.offload_tag }}</span>
                                {% endif %}
                            </span>
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td class="delivery-method-col">
                        <select class="method-select delivery-method-input" data-id="{% if cargo.plt_ids %}plt_{{ cargo.plt_ids }}{% else %}{{ cargo.ids }}{% endif %}">
                            <option value="" {% if not cargo.delivery_method %}selected{% endif %}></option>
                            <option value="卡车派送" {% if cargo.delivery_method == "卡车派送" %}selected{% endif %}>卡车派送</option>
                            <option value="客户自提" {% if cargo.delivery_method == "客户自提" %}selected{% endif %}>客户自提</option>
                            <option value="暂扣留仓(HOLD)" {% if cargo.delivery_method == "暂扣留仓(HOLD)" %}selected{% endif %}>暂扣留仓(HOLD)</option>
                            <option value="整柜直送" {% if cargo.delivery_method == "整柜直送" %}selected{% endif %}>整柜直送</option>
                            <option value="UPS" {% if cargo.delivery_method == "UPS" %}selected{% endif %}>UPS</option>
                            <option value="FEDEX" {% if cargo.delivery_method == "FEDEX" %}selected{% endif %}>FEDEX</option>
                            <option value="DHL" {% if cargo.delivery_method == "DHL" %}selected{% endif %}>DHL</option>
                            <option value="DPD" {% if cargo.delivery_method == "DPD" %}selected{% endif %}>DPD</option>
                            <option value="TNT" {% if cargo.delivery_method == "TNT" %}selected{% endif %}>TNT</option>
                        </select>
                    </td>
                    <td class="container-col" title="{{ cargo.container_numbers|default:'' }}">
                        {{ cargo.container_numbers|default:"-" }}
                    </td>
                    <td>{{ cargo.destination|default:"-" }}</td>
                    <td class="mark-col">{{ cargo.shipping_marks|default:"-" }}</td>
                    <td class="note-col">
                        <textarea class="editable-textarea note-input" 
                            data-id="{% if cargo.plt_ids %}plt_{{ cargo.plt_ids }}{% else %}{{ cargo.ids }}{% endif %}"
                            placeholder="输入备注..."
                            oninput="autoResizeTextarea(this)"
                            style="min-height: 32px; width: 100%;">{{ cargo.note|default:'' }}
                        </textarea>
                    </td>
                    <td class="command-col">
                        <textarea class="editable-textarea command-input" 
                            data-id="{% if cargo.plt_ids %}plt_{{ cargo.plt_ids }}{% else %}{{ cargo.ids }}{% endif %}"
                            oninput="autoResizeTextarea(this)"
                            style="min-height: 32px; width: 100%;">{{ cargo.ltl_release_command|default:'' }}
                        </textarea>
                    </td>
                    <td>{{ cargo.total_cbm|floatformat:3|default:"0.000" }}</td>
                    <td>{{ cargo.total_pcs|default:0 }}</td>
                    <td>{{ cargo.total_weight_kg|default:0 }}</td>
                    <td>{{ cargo.total_weight_lbs|default:0 }}</td>
                    <td class="pallet-col">
                        {% if cargo.total_n_pallet_act %}
                            <span class="pallet-count">{{ cargo.total_n_pallet_act }}</span>
                            <span class="pallet-tag pallet-tag-act">ACT</span>
                        {% elif cargo.total_n_pallet_est %}
                            <span class="pallet-count">{{ cargo.total_n_pallet_est|floatformat:"0" }}</span>
                            <span class="pallet-tag pallet-tag-est">EST</span>
                        {% else %}
                            <span class="pallet-count">0</span>
                        {% endif %}
                    </td>
                    <td class="pallet-size-col">
                        {% if cargo.data_source == "PALLET" %}
                            <div style="position: relative;">
                                <textarea class="pallet-size-input"
                                    data-id="{% if cargo.plt_ids %}plt_{{ cargo.plt_ids }}{% else %}{{ cargo.ids }}{% endif %}"
                                    placeholder="输入托盘尺寸，如：32*35*60*3板 x件 xkg"
                                    oninput="autoResizeTextarea(this)"
                                    >{{ cargo.pallet_size_formatted|default_if_none:'' }}</textarea>
                                <span class="help-tooltip" title="尺寸分配规则：
                    1. 单行格式：长*宽*高 x件 xkg（所有托盘按此尺寸）
                    2. 多行格式：长*宽*高*数量板 x件 xkg（换行分隔）
                    3. 板数总和必须等于托盘总数
                    示例：
                    32*35*60*3板 23件 320kg
                    30*30*50*2板 23件 320kg">❓</span>
                            </div>
                        {% else %}
                            <!-- PackingList 数据没有托盘尺寸字段 -->
                            <span style="color: #999; font-style: italic;">-</span>
                        {% endif %}
                    </td>
                    <td class="quote-col">
                        {% if cargo.data_source == "PALLET" and not cargo.delivery_method|default:""|contains:"暂扣" %}
                            <input type="number" class="qty-input" 
                                data-id="{% if cargo.plt_ids %}plt_{{ cargo.plt_ids }}{% else %}{{ cargo.ids }}{% endif %}"
                                value="{% if cargo.del_qty %}{{ cargo.del_qty }}{% endif %}"
                                placeholder="0.00"
                                step="0.01"
                                min="0">
                        {% elif cargo.delivery_method|default:""|contains:"暂扣" %}
                            <span style="color: #999; font-style: italic;">暂扣不可编辑</span>
                        {% elif cargo.data_source != "PALLET" %}
                            <span style="color: #999; font-style: italic;">未打板不可录</span>
                        {% else %}
                            <span style="color: #999; font-style: italic;">-</span>
                        {% endif %}
                    </td>
                    <td class="quote-col">
                        {% if cargo.data_source == "PALLET" and not cargo.delivery_method|default:""|contains:"暂扣" %}
                            <input type="number" class="unit-quote-input" 
                                data-id="{% if cargo.plt_ids %}plt_{{ cargo.plt_ids }}{% else %}{{ cargo.ids }}{% endif %}"
                                value="{% if cargo.ltl_unit_quote %}{{ cargo.ltl_unit_quote }}{% endif %}"
                                placeholder="0.00"
                                step="0.01"
                                min="0">
                        {% elif cargo.delivery_method|default:""|contains:"暂扣" %}
                            <span style="color: #999; font-style: italic;">暂扣不可编辑</span>
                        {% elif cargo.data_source != "PALLET" %}
                            <span style="color: #999; font-style: italic;">未打板不可录</span>
                        {% else %}
                            <span style="color: #999; font-style: italic;">-</span>
                        {% endif %}
                    </td>
                    <td class="quote-col">
                        {% if cargo.data_source == "PALLET" and not cargo.delivery_method|default:""|contains:"暂扣" %}
                            <input type="number" class="outbound-fee-input" 
                                data-id="{% if cargo.plt_ids %}plt_{{ cargo.plt_ids }}{% else %}{{ cargo.ids }}{% endif %}"
                                value="{% if cargo.ltl_quote %}{{ cargo.ltl_quote }}{% endif %}"
                                placeholder="0.00"
                                step="0.01"
                                min="0">
                        {% elif cargo.delivery_method|default:""|contains:"暂扣" %}
                            <span style="color: #999; font-style: italic;">暂扣不可编辑</span>
                        {% elif cargo.data_source != "PALLET" %}
                            <span style="color: #999; font-style: italic;">未打板不可录</span>
                        {% else %}
                            <span style="color: #999; font-style: italic;">-</span>
                        {% endif %}
                    </td>
                    <td class="quote-note-col">
                        {% if cargo.data_source == "PALLET" and not cargo.delivery_method|default:""|contains:"暂扣" %}
                            <input type="text" class="outbound-fee-note-input" 
                                data-id="{% if cargo.plt_ids %}plt_{{ cargo.plt_ids }}{% else %}{{ cargo.ids }}{% endif %}"
                                value="{{ cargo.ltl_quote_note|default:'' }}"
                                placeholder="出库费备注"
                                maxlength="200">
                        {% elif cargo.delivery_method|default:""|contains:"暂扣" %}
                            <span style="color: #999; font-style: italic;">暂扣不可编辑</span>
                        {% elif cargo.data_source != "PALLET" %}
                            <span style="color: #999; font-style: italic;">未打板不可录</span>
                        {% else %}
                            <span style="color: #999; font-style: italic;">-</span>
                        {% endif %}
                    </td>
                    <td class="bol-col">
                        <textarea class="bol-input" 
                            data-id="{% if cargo.plt_ids %}plt_{{ cargo.plt_ids }}{% else %}{{ cargo.ids }}{% endif %}"
                            placeholder="输入BOL号"
                            oninput="autoResizeTextarea(this)"
                            >{{ cargo.ltl_bol_num|default:'' }}</textarea>
                    </td>
                    <td class="company-col">
                        <input type="text" class="carrier-input" 
                            data-id="{% if cargo.plt_ids %}plt_{{ cargo.plt_ids }}{% else %}{{ cargo.ids }}{% endif %}"
                            value="{{ cargo.carrier_company|default:'' }}"
                            placeholder="输入承运公司">
                    </td>
                    <td class="address-col">
                        <textarea class="address-input"
                            data-id="{% if cargo.plt_ids %}plt_{{ cargo.plt_ids }}{% else %}{{ cargo.ids }}{% endif %}"
                            placeholder="输入详细地址"
                            oninput="autoResizeTextarea(this)"
                            >{{ cargo.address|default:'' }}</textarea>
                    </td>
                    <td>
                        <input type="date" class="pickup-date-input" 
                            data-id="{% if cargo.plt_ids %}plt_{{ cargo.plt_ids }}{% else %}{{ cargo.ids }}{% endif %}"
                            value="{% if cargo.est_pickup_time %}{{ cargo.est_pickup_time|date:'Y-m-d' }}{% endif %}" 
                            placeholder="选择预计提货日期">
                    </td>
                    <td class="action-col">
                        <div class="action-buttons">
                            <button class="action-btn btn-success small-btn" onclick="saveRowData(this)">
                                <i class="fas fa-save"></i> 保存
                            </button>
                        </div>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="27" style="text-align: center; padding: 20px;">
                        暂无已放行客提货物
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- 保存承运公司、地址和托盘尺寸的表单 -->
<form method="post" action="" id="saveForm" style="display: none;">
    {% csrf_token %}
    <input type="hidden" name="step" value="save_selfpick_cargo">
    <input type="hidden" name="cargo_id" id="cargoIdInput">
    <input type="hidden" name="carrier_company" id="carrierInput">
    <input type="hidden" name="address" id="addressInput">
    <input type="hidden" name="bol_number" id="bolNumberInput">
    <input type="hidden" name="pickup_date" id="pickupTimeInput">
    <input type="hidden" name="pallet_size" id="palletSizeInput">
    <input type="hidden" name="ltl_plt_size_note" id="pltSizeNoteInput">
    <input type="hidden" name="follow_status" id="followStatusInput">
    <input type="hidden" name="del_qty" id="delQtyInput">
    <input type="hidden" name="ltl_unit_quote" id="unitQuoteInput">
    <input type="hidden" name="ltl_quote" id="ltlQuoteInput">
    <input type="hidden" name="ltl_quote_note" id="ltlQuoteNoteInput">
    <input type="hidden" name="batch_data" id="batchDataInput">
    <input type="hidden" name="warehouse" value="{{ warehouse }}">
    <input type="hidden" name="active_tab" value="scheduled">
    <input type="hidden" name="delivery_method" id="deliveryMethodInput">
    <input type="hidden" name="note" id="noteInput">
    <input type="hidden" name="ltl_release_command" id="ltlReleaseCommandInput">
    <input type="hidden" name="batch_methods" id="batchMethodsInput">
</form>

<script>
    // 使用IIFE避免变量污染
    (function() {
        // 自动调整textarea高度
        function autoResizeTextarea(textarea) {
            if (!textarea || textarea.offsetParent === null) return; // 如果元素隐藏，跳过计算

            textarea.style.height = 'auto'; // 先重置
            const style = window.getComputedStyle(textarea);
            const borderHeight = parseFloat(style.borderTopWidth) + parseFloat(style.borderBottomWidth) || 0;
            
            // 使用 scrollHeight + 边框 + 4px 容错
            const finalHeight = textarea.scrollHeight + borderHeight + 4;
            textarea.style.height = finalHeight + 'px';
        }
        function selfpick_resizeAll() {
            // 延时 50ms 确保 Tab 的 display: block 已经完全生效
            setTimeout(() => {
                const tas = document.querySelectorAll('#selfpick-page textarea');
                tas.forEach(t => autoResizeTextarea(t));
                console.log('客提页面高度初始化完成');
            }, 50);
        }
        window.initializeScheduledSection = selfpick_resizeAll;
        // 已放行客提页面JavaScript
        document.addEventListener('DOMContentLoaded', function() {
            initializeSelfpickPage();
            if (document.getElementById('selfpick-page').offsetParent !== null) {
                selfpick_resizeAll();
            }
           
            // 获取所有的 textarea (包含你新加的备注列)
            document.querySelector('#selfpick-page').addEventListener('input', function(e) {
                if (e.target.tagName.toLowerCase() === 'textarea') {
                    autoResizeTextarea(e.target);
                }
            });
            window.addEventListener('resize', selfpick_resizeAll);
        });

        // 全局变量
        let columnFilters = {};
        let pendingChanges = {}; // 保存待处理的更改

        function initializeSelfpickPage() {
            // 确保页面加载时更新统计数据
            updateSelfPickSelectedCount();
            
            // 全选/取消全选
            const selectAllCheckbox = document.getElementById('selfpick_selectAllCargos');
            if (selectAllCheckbox) {
                selectAllCheckbox.addEventListener('change', selfpick_toggleSelectAll);
            }

            // 单个选择框变化
            document.querySelectorAll('.self-cargo-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    updateSelfPickSelectedCount();
                });
            });

        }

        // 新增：复制选中行数据到剪贴板
        function copySelectedRows() {
            const selectedCheckboxes = Array.from(document.querySelectorAll('.self-cargo-checkbox:checked'))
                .filter(checkbox => {
                    const row = checkbox.closest('tr');
                    return row.style.display !== 'none' && !row.classList.contains('filter-row');
                });

            if (selectedCheckboxes.length === 0) {
                alert('请先选择要复制的行');
                return;
            }

            // 收集选中的柜号、目的地、唛头数据
            const rowsData = [];
            
            selectedCheckboxes.forEach(checkbox => {
                const row = checkbox.closest('tr');
                
                // 获取柜号（从第5个td开始，索引从0开始）
                const containerTd = row.cells[5]; // 柜号列
                const destinationTd = row.cells[6]; // 目的地列
                const shippingMarkTd = row.cells[7]; // 唛头列
                const palletSizeTd = row.cells[15];
                
                // 提取文本内容（移除可能存在的HTML标签）
                const containerNumber = containerTd ? containerTd.textContent.trim() : '';
                const destination = destinationTd ? destinationTd.textContent.trim() : '';
                const shippingMark = shippingMarkTd ? shippingMarkTd.textContent.trim() : '';
                let palletSize = '';

                if (palletSizeTd) {
                    // 先尝试从textarea获取
                    const palletSizeInput = palletSizeTd.querySelector('.pallet-size-input');
                    if (palletSizeInput && palletSizeInput.value.trim()) {
                        // 从textarea获取用户输入的值
                        palletSize = palletSizeInput.value.trim();
                    } else {
                        // 如果没有输入框或值为空，检查是否显示"-"
                        const displaySpan = palletSizeTd.querySelector('span[style*="color: #999"]');
                        if (displaySpan) {
                            // 这是PackingList数据显示的"-"
                            palletSize = '';
                        } else {
                            // 否则获取单元格文本
                            palletSize = palletSizeTd.textContent.trim();
                        }
                    }
                }
                if (palletSize === '-' || palletSize.includes('font-style: italic')) {
                    palletSize = '';
                }

                // 添加到数据数组
                rowsData.push([containerNumber, destination, shippingMark, palletSize]);
            });

            // 将数据转换为制表符分隔的字符串（兼容Excel粘贴）
            const csvData = rowsData.map(row => row.join('\t')).join('\n');
            
            // 复制到剪贴板
            navigator.clipboard.writeText(csvData)
                .then(() => {
                    // 显示成功提示
                    showCopyNotification(`已复制 ${selectedCheckboxes.length} 行数据到剪贴板<br>（柜号、目的地、唛头、托盘尺寸)`);
                })
                .catch(err => {
                    console.error('复制失败:', err);
                    
                    // 降级方案：使用传统方法复制
                    try {
                        const textarea = document.createElement('textarea');
                        textarea.value = csvData;
                        textarea.style.position = 'fixed';
                        textarea.style.opacity = '0';
                        document.body.appendChild(textarea);
                        textarea.select();
                        
                        const successful = document.execCommand('copy');
                        document.body.removeChild(textarea);
                        
                        if (successful) {
                            showCopyNotification(`已复制 ${selectedCheckboxes.length} 行数据到剪贴板<br>（柜号、目的地、唛头、托盘尺寸)`);
                        } else {
                            alert('复制失败，请手动选择并复制数据');
                        }
                    } catch (fallbackErr) {
                        console.error('降级复制失败:', fallbackErr);
                        alert('复制失败，请检查浏览器权限或手动复制');
                    }
                });
        }

        // 显示复制成功的通知
        function showCopyNotification(message) {
            // 先移除可能存在的旧通知
            const oldNotifications = document.querySelectorAll('.selfpick-copy-notification');
            oldNotifications.forEach(notification => notification.remove());
            
            // 创建通知元素
            const notification = document.createElement('div');
            notification.className = 'selfpick-copy-notification';
            
            // 极简清新样式
            notification.style.cssText = `
                position: fixed !important;
                top: 50% !important;
                left: 50% !important;
                transform: translate(-50%, -50%) !important;
                background: white !important;
                color: #2c3e50 !important;
                padding: 18px 25px !important;
                border-radius: 10px !important;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08),
                            0 0 0 1px #e9ecef !important;
                z-index: 99999 !important;
                animation: selfpickMinimalFade 0.25s ease !important;
                font-size: 14px !important;
                font-weight: 500 !important;
                text-align: center !important;
                max-width: 280px !important;
                backdrop-filter: blur(5px) !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
                gap: 10px !important;
                border: 1px solid #e0e6ed !important;
                line-height: 1.5 !important;
            `;
            
            notification.innerHTML = `
                <span style="color: #4a90e2; font-size: 18px;">
                    <i class="fas fa-check"></i>
                </span>
                <span>${message}</span>
            `;
            
            // 添加到body
            document.body.appendChild(notification);
            
            // 添加动画样式
            if (!document.querySelector('#selfpick-minimal-styles')) {
                const style = document.createElement('style');
                style.id = 'selfpick-minimal-styles';
                style.textContent = `
                    @keyframes selfpickMinimalFade {
                        0% { 
                            opacity: 0;
                            transform: translate(-50%, -50%) translateY(10px);
                        }
                        100% { 
                            opacity: 1;
                            transform: translate(-50%, -50%) translateY(0);
                        }
                    }
                    
                    .selfpick-copy-notification:hover {
                        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1) !important;
                        transform: translate(-50%, -50%) translateY(-1px) !important;
                    }
                `;
                document.head.appendChild(style);
            }
            
            // 悬停效果
            notification.addEventListener('mouseenter', function() {
                this.style.boxShadow = '0 6px 20px rgba(0, 0, 0, 0.1) !important';
                this.style.transform = 'translate(-50%, -50%) translateY(-1px) !important';
            });
            
            notification.addEventListener('mouseleave', function() {
                this.style.boxShadow = '0 4px 15px rgba(0, 0, 0, 0.08) !important';
                this.style.transform = 'translate(-50%, -50%) translateY(0) !important';
            });
            
            // 点击关闭
            notification.addEventListener('click', function() {
                this.style.opacity = '0';
                this.style.transform = 'translate(-50%, -50%) translateY(-5px)';
                setTimeout(() => {
                    if (this.parentNode) {
                        this.parentNode.removeChild(this);
                    }
                }, 200);
            });
            
            // 2秒后自动淡出
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translate(-50%, -50%) translateY(-5px)';
                notification.style.transition = 'all 0.3s ease !important';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 2000);
        }

        // 保存行数据到服务器
        function saveRowData(button) {
            const row = button.closest('tr');
            const id = row.querySelector('.self-cargo-checkbox').value;
            const cargo = {
                id: row.dataset.cargoId || '',
                customer: row.dataset.customer || '',
                containerNumber: row.dataset.containerNumber || '',
                shippingMark: row.dataset.shippingMark || '',
                cbm: parseFloat(row.dataset.cbm || 0),
                weight_lbs: parseFloat(row.dataset.weightLbs || 0),
                pallet_items: []
            };
            
            // 获取当前行的数据
            const followStatusInput = row.querySelector('.follow-input');
            const carrierInput = row.querySelector('.carrier-input');
            const addressInput = row.querySelector('.address-input');
            const bolInput = row.querySelector('.bol-input');
            const pickupDateInput = row.querySelector('.pickup-date-input');
            const palletSizeInput = row.querySelector('.pallet-size-input');
            const delQtyInput = row.querySelector('.qty-input');
            const unitQuoteInput = row.querySelector('.unit-quote-input');
            const ltlQuoteInput = row.querySelector('.outbound-fee-input');
            const ltlQuoteNoteInput = row.querySelector('.outbound-fee-note-input');
            const deliveryMethodInput = row.querySelector('.delivery-method-input');
            const noteInput = row.querySelector('.note-input');
            const releaseCommandInput = row.querySelector('.command-input');

            const followStatusValue = followStatusInput ? followStatusInput.value.trim() : '';
            const carrierValue = carrierInput ? carrierInput.value.trim() : '';
            const addressValue = addressInput ? addressInput.value.trim() : '';
            const bolValue = bolInput ? bolInput.value.trim() : '';
            const pickupDateValue = pickupDateInput ? pickupDateInput.value.trim() : '';
            const palletSizeValue = palletSizeInput ? palletSizeInput.value.trim() : '';
            const delQtyValue = delQtyInput ? delQtyInput.value.trim() : '';
            const unitQuoteValue = unitQuoteInput ? unitQuoteInput.value.trim() : '';
            const ltlQuoteValue = ltlQuoteInput ? ltlQuoteInput.value.trim() : '';
            const ltlQuoteNoteValue = ltlQuoteNoteInput ? ltlQuoteNoteInput.value.trim() : '';
            const deliveryMethodValue = deliveryMethodInput ? deliveryMethodInput.value : '';
            const noteValue = noteInput ? noteInput.value.trim() : '';
            const releaseCommandValue = releaseCommandInput ? releaseCommandInput.value.trim() : '';
            
            /* const tbody = document.querySelector('#selfpick_cargoTable tbody');
            // 只有PALLET数据才有托盘尺寸输入框
            if (cargo.id.startsWith('plt_')) {
                const originalPltIds = cargo.id.replace('plt_', '');
                const pltIdArray = originalPltIds.split(',');

                // 从 cargo.pallet_items 中按 id 建索引
                const palletMap = {};
                if (Array.isArray(cargo.pallet_items)) {
                    cargo.pallet_items.forEach(p => {
                        palletMap[String(p.id)] = p;
                    });
                }

                pltIdArray.forEach(pltId => {
                    const pallet = palletMap[pltId] || {};

                    const sizeText = (pallet.length && pallet.width && pallet.height)
                        ? `${pallet.length}*${pallet.width}*${pallet.height}`
                        : '-';

                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td class="checkbox-col">
                            <input type="checkbox"
                                class="self-cargo-checkbox"
                                data-cargo-type="pallet"
                                data-cargo-id="${pltId}"
                                data-original-id="${cargo.id}"
                                checked>
                        </td>
                        <td>${cargo.customer || '-'}</td>
                        <td>${cargo.containerNumber || '-'}</td>
                        <td>${cargo.shippingMark || '-'}</td>
                        <td class="pallet-size-cell">${sizeText}</td>
                        <td>1</td>
                        <td>${(pallet.cbm ?? (cargo.cbm / pltIdArray.length)).toFixed(3)}</td>
                        <td>${(pallet.weight_lbs ?? (cargo.weight_lbs / pltIdArray.length)).toFixed(2)}</td>
                    `;
                    tbody.appendChild(tr);
                });
            } */
            
            // 设置表单数据
            const cargoIdInput = document.getElementById('cargoIdInput');
            const carrierInputField = document.getElementById('carrierInput');
            const addressInputField = document.getElementById('addressInput');
            const bolNumberInputField = document.getElementById('bolNumberInput');
            const pickupTimeInputField = document.getElementById('pickupTimeInput'); 
            const palletSizeInputField = document.getElementById('palletSizeInput');
            const followStatusInputField = document.getElementById('followStatusInput');
            const delQtyInputField = document.getElementById('delQtyInput');
            const unitQuoteInputField = document.getElementById('unitQuoteInput');
            const ltlQuoteInputField = document.getElementById('ltlQuoteInput');
            const ltlQuoteNoteInputField = document.getElementById('ltlQuoteNoteInput');
            const deliveryMethodInputField = document.getElementById('deliveryMethodInput');
            const noteInputField = document.getElementById('noteInput');
            const ltlReleaseCommandInputField = document.getElementById('ltlReleaseCommandInput');
            const saveForm = document.getElementById('saveForm');

            if (cargoIdInput && carrierInputField && addressInputField && 
                bolNumberInputField && pickupTimeInputField && followStatusInputField 
                && palletSizeInputField && delQtyInputField && ltlQuoteInputField 
                && ltlQuoteNoteInputField && unitQuoteInputField &&
                deliveryMethodInputField && noteInputField && ltlReleaseCommandInputField 
                && saveForm) {
                cargoIdInput.value = id;
                carrierInputField.value = carrierValue;
                addressInputField.value = addressValue;
                bolNumberInputField.value = bolValue;
                pickupTimeInputField.value = pickupDateValue;
                palletSizeInputField.value = palletSizeValue;
                followStatusInputField.value = followStatusValue;
                delQtyInputField.value = delQtyValue;
                unitQuoteInputField.value = unitQuoteValue;
                ltlQuoteInputField.value = ltlQuoteValue;
                ltlQuoteNoteInputField.value = ltlQuoteNoteValue; 
                deliveryMethodInputField.value = deliveryMethodValue;
                noteInputField.value = noteValue;
                ltlReleaseCommandInputField.value = releaseCommandValue;
                saveForm.submit();
            } else {
                console.error('保存表单元素未找到',ltlQuoteInputField,ltlQuoteNoteInputField,unitQuoteInputField);
            }
        }

        // 显示保存通知
        function showSaveNotification(message) {
            // 创建通知元素
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #28a745;
                color: white;
                padding: 12px 20px;
                border-radius: 4px;
                box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                z-index: 1000;
                animation: slideIn 0.3s ease-out;
                font-size: 0.9rem;
            `;
            
            notification.innerHTML = `
                <i class="fas fa-check-circle" style="margin-right: 8px;"></i>
                ${message}
            `;
            
            document.body.appendChild(notification);
            
            // 3秒后移除通知
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease-out';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
            
            // 添加动画关键帧
            if (!document.querySelector('#save-notification-styles')) {
                const style = document.createElement('style');
                style.id = 'save-notification-styles';
                style.textContent = `
                    @keyframes slideIn {
                        from { transform: translateX(100%); opacity: 0; }
                        to { transform: translateX(0); opacity: 1; }
                    }
                    @keyframes slideOut {
                        from { transform: translateX(0); opacity: 1; }
                        to { transform: translateX(100%); opacity: 0; }
                    }
                `;
                document.head.appendChild(style);
            }
        }

        // 预约出库功能 - 只负责收集数据和调用弹框
        function scheduleShipment() {
            const selectedCheckboxes = Array.from(document.querySelectorAll('.self-cargo-checkbox:checked'))
                .filter(checkbox => {
                    const row = checkbox.closest('tr');
                    return row.style.display !== 'none' && !row.classList.contains('filter-row');
                });

            if (selectedCheckboxes.length === 0) {
                alert('请先选择要预约出库的货物');
                return;
            }

            // 获取选中的货物信息
            const selectedCargos = selectedCheckboxes.map(checkbox => {
                const row = checkbox.closest('tr');
                const palletSizeInput = row.querySelector('.pallet-size-input');
                const carrierInput = row.querySelector('.carrier-input');
                const addressInput = row.querySelector('.address-input');
                const pickupDateInput = row.querySelector('.pickup-date-input');
                const bolInput = row.querySelector('.bol-input');

                // 生成 pallet_items，从 data-pallet-items 直接取
                let pallet_items = [];
                const palletItemsRaw = row.getAttribute('data-pallet-items');

                if (palletItemsRaw) {
                    try {
                        pallet_items = JSON.parse(palletItemsRaw);
                    } catch (err) {
                        console.error('解析 pallet_items 失败:', err, palletItemsRaw);
                        pallet_items = [];
                    }
                }

                let pickupTime = '';
                if (pickupDateInput && pickupDateInput.value.trim()) {
                    // 将日期格式转换为完整的时间格式，默认00:00
                    pickupTime = pickupDateInput.value.trim() + 'T00:00';
                }
                return {
                    id: checkbox.value,
                    customer: row.dataset.customer,
                    containerNumber: row.dataset.containerNumber,
                    destination: row.dataset.destination,
                    shippingMark: row.dataset.shippingMark,
                    cbm: parseFloat(row.dataset.cbm) || 0,
                    pcs: parseInt(row.dataset.pcs) || 0,
                    pallets: parseInt(row.dataset.pallets) || 0,
                    palletSize: palletSizeInput ? palletSizeInput.value.trim() : '',
                    bol: bolInput ? bolInput.value.trim() : '',
                    carrier: carrierInput ? carrierInput.value.trim() : '',
                    address: addressInput ? addressInput.value.trim() : '',
                    pickupTime: pickupTime,
                    weight_lbs: parseFloat(row.dataset.weightLbs) || 0,
                    pallet_items // 直接使用后端传过来的数组
                };
            });

            // 调用弹框的open函数
            if (window.ShipmentModal && window.ShipmentModal.open) {
                window.ShipmentModal.open(selectedCargos, {
                    active_tab: 'scheduled'  // 可以传递其他配置选项
                });
            } else {
                alert('预约出库功能暂不可用，请刷新页面重试');
                console.error('ShipmentModal 未初始化');
            }
        }

        // 全选功能
        function selfpick_toggleSelectAll() {
            const selectAllCheckbox = document.getElementById('selfpick_selectAllCargos');
            if (!selectAllCheckbox) return;
            
            const isChecked = selectAllCheckbox.checked;
            
            // 获取所有可见的数据行（不包括筛选行）
            const visibleRows = Array.from(document.querySelectorAll('.data-row:not(.filter-row)'))
                .filter(row => row.style.display !== 'none');
            
            // 更新所有可见行的复选框
            visibleRows.forEach(row => {
                const checkbox = row.querySelector('.self-cargo-checkbox');
                if (checkbox) {
                    checkbox.checked = isChecked;
                }
            });
            
            updateSelfPickSelectedCount();
        }

        // 列筛选函数
        function applySelfPickColumnFilter(input) {
            const columnIndex = parseInt(input.getAttribute('data-column'));
            const filterValue = input.value.trim().toLowerCase();
            
            if (filterValue) {
                columnFilters[columnIndex] = filterValue;
            } else {
                delete columnFilters[columnIndex];
            }
            
            selfpick_applyCombinedFilter();
        }

        // 清空所有筛选
        function clearSelfPickAllFilters() {
            // 清空输入框
            document.querySelectorAll('.filter-input, .filter-select').forEach(input => {
                input.value = '';
            });
            
            // 清空筛选状态对象
            columnFilters = {};
            
            // 显示所有数据行
            const allRows = document.querySelectorAll('#selfpick_cargoTable .data-row:not(.filter-row)');
            allRows.forEach(row => {
                row.style.display = '';
            });
            
            // 取消所有选中状态
            document.querySelectorAll('.self-cargo-checkbox').forEach(checkbox => {
                checkbox.checked = false;
            });
            
            // 更新全选复选框状态
            const selectAllCheckbox = document.getElementById('selfpick_selectAllCargos');
            if (selectAllCheckbox) {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = false;
            }
            
            // 更新计数（这会重置统计数据显示为0）
            selfpick_updateFilteredCount(allRows.length);
            updateSelfPickSelectedCount();
        }

        // 组合筛选函数
        function selfpick_applyCombinedFilter() {
            const rows = document.querySelectorAll('#selfpick_cargoTable .data-row');
            let visibleCount = 0;

            rows.forEach(row => {
                if (row.classList.contains('filter-row')) return;
                
                // 检查是否匹配所有筛选条件
                let match = true;
                
                for (const [columnIndex, filterValue] of Object.entries(columnFilters)) {
                    if (filterValue.trim() === '') {
                        continue;
                    }
                    
                    const idx = parseInt(columnIndex);
                    const cell = row.cells[idx + 1]; // +1 因为有复选框列
                    let cellValue = '';
                    
                    if (cell) {
                        // 获取单元格文本（排除input/textarea元素的值）
                        const inputElement = cell.querySelector('input, textarea, select');
                        if (inputElement) {
                            cellValue = inputElement.value.toLowerCase().trim();
                        } else {
                            cellValue = cell.textContent.toLowerCase().trim();
                        }
                        
                        // 特殊处理日期列
                        if (idx === 2 || idx === 12) { // 拆柜日期和预计提货时间
                            cellValue = cell.getAttribute('title') || cell.textContent;
                            cellValue = cellValue.toLowerCase().trim();
                        }
                        
                        // 处理板数列（包含ACT/EST标记）
                        if (idx === 8) { // 板数列
                            // 获取板数文本（包含标记）
                            cellValue = cell.textContent.toLowerCase().trim();
                        }
                        
                        if (!cellValue.includes(filterValue.toLowerCase())) {
                            match = false;
                            break;
                        }
                    }
                }
                
                if (match) {
                    row.style.display = '';
                    visibleCount++;
                } else {
                    row.style.display = 'none';
                    
                    // 隐藏行时取消选中该行的复选框
                    const checkbox = row.querySelector('.self-cargo-checkbox');
                    if (checkbox && checkbox.checked) {
                        checkbox.checked = false;
                    }
                }
            });

            selfpick_updateFilteredCount(visibleCount);
            updateSelfPickSelectedCount();
        }

        // 更新筛选后数量的函数
        function selfpick_updateFilteredCount(count) {
            const filteredCountEl = document.getElementById('selfpick_filteredCount');
            if (filteredCountEl) {
                filteredCountEl.textContent = count;
            }
        }
        // 更新选中数量
        function updateSelfPickSelectedCount() {
            const selectedSelfPickCountEl = document.getElementById('selfpick_selectedSelfPickCount');
            if (!selectedSelfPickCountEl) return;
            
            const selectedCheckboxes = Array.from(document.querySelectorAll('.self-cargo-checkbox:checked'))
                .filter(checkbox => {
                    const row = checkbox.closest('tr');
                    return row.style.display !== 'none' && !row.classList.contains('filter-row');
                });
            
            const selectedSelfPickCount = selectedCheckboxes.length;
            selectedSelfPickCountEl.textContent = selectedSelfPickCount;

            // 计算选中货物的统计数据
            let totalSelectedPallets = 0;
            let totalSelectedCbm = 0;
            let totalSelectedWeightLbs = 0;
            
            selectedCheckboxes.forEach(checkbox => {
                const row = checkbox.closest('tr');
                const pallets = parseFloat(row.dataset.pallets) || 0;
                const cbm = parseFloat(row.dataset.cbm) || 0;
                const weightLbs = parseFloat(row.dataset.weightLbs) || 0;
                
                totalSelectedPallets += pallets;
                totalSelectedCbm += cbm;
                totalSelectedWeightLbs += weightLbs;
            });
            // 使用带前缀的ID
            const selectedSelfPickPalletsCountEl = document.getElementById('selfpick_selectedSelfPickPalletsCount');
            const selectedSelfPickCbmCountEl = document.getElementById('selfpick_selectedSelfPickCbmCount');
            
            const selectedSelfPickWeightLbsCountEl = document.getElementById('selfpick_selectedSelfPickWeightLbsCount');
            
            if (selectedSelfPickPalletsCountEl) {
                selectedSelfPickPalletsCountEl.textContent = Math.floor(totalSelectedPallets);
            }
            if (selectedSelfPickCbmCountEl) {
                selectedSelfPickCbmCountEl.textContent = totalSelectedCbm.toFixed(2);
            }
            if (selectedSelfPickWeightLbsCountEl) {
                selectedSelfPickWeightLbsCountEl.textContent = totalSelectedWeightLbs.toFixed(2);
            }
            
            // 更新全选框的状态
            updateSelfPickSelectAllCheckbox();
        }

        function updateSelfPickSelectAllCheckbox() {
            const selectAllCheckbox = document.getElementById('selfpick_selectAllCargos');
            if (!selectAllCheckbox) return;
            
            // 获取所有可见的复选框（不包括隐藏行和筛选行）
            const visibleCheckboxes = Array.from(document.querySelectorAll('.self-cargo-checkbox'))
                .filter(checkbox => {
                    const row = checkbox.closest('tr');
                    return !row.classList.contains('filter-row') && row.style.display !== 'none';
                });
            
            if (visibleCheckboxes.length === 0) {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = false;
                return;
            }
            
            const checkedCount = visibleCheckboxes.filter(checkbox => checkbox.checked).length;
            
            // 更新全选复选框状态
            if (checkedCount === 0) {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = false;
            } else if (checkedCount === visibleCheckboxes.length) {
                selectAllCheckbox.checked = true;
                selectAllCheckbox.indeterminate = false;
            } else {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = true;
            }
        }
        function selfpick_batchSaveRows() {
            // 1. 获取所有选中且可见的行
            const selectedCheckboxes = Array.from(document.querySelectorAll('.self-cargo-checkbox:checked'))
                .filter(checkbox => {
                    const row = checkbox.closest('tr');
                    return row.style.display !== 'none' && !row.classList.contains('filter-row');
                });

            if (selectedCheckboxes.length === 0) {
                alert('请先选择要批量保存的行');
                return;
            }

            if (!confirm(`确定要批量保存选中的 ${selectedCheckboxes.length} 组参数吗？`)) {
                return;
            }

            // 2. 遍历提取每一行的数据
            const batchData = selectedCheckboxes.map(checkbox => {
                const row = checkbox.closest('tr');
                
                // 这里的类名选择器要与你 HTML 中的 input/textarea 一一对应
                return {
                    cargo_id: checkbox.value,
                    follow_status: row.querySelector('.follow-input')?.value.trim() || '',
                    pallet_size: row.querySelector('.pallet-size-input')?.value.trim() || '',
                    del_qty: row.querySelector('.qty-input')?.value.trim() || '',
                    ltl_unit_quote: row.querySelector('.unit-quote-input')?.value.trim() || '',
                    ltl_quote: row.querySelector('.outbound-fee-input')?.value.trim() || '',
                    ltl_quote_note: row.querySelector('.outbound-fee-note-input')?.value.trim() || '',
                    bol_number: row.querySelector('.bol-input')?.value.trim() || '',
                    carrier_company: row.querySelector('.carrier-input')?.value.trim() || '',
                    address: row.querySelector('.address-input')?.value.trim() || '',
                    pickup_date: row.querySelector('.pickup-date-input')?.value.trim() || '',
                    delivery_method: row.querySelector('.delivery-method-input')?.value || '',
                    note: row.querySelector('.note-input')?.value.trim() || '', // 如果备注也是input的话
                    ltl_release_command: row.querySelector('.command-input')?.value || '',
                };
            });

            // 3. 填入隐藏表单并提交
            const batchDataInput = document.getElementById('batchDataInput');
            const saveForm = document.getElementById('saveForm');

            if (batchDataInput && saveForm) {
                // 清空单条保存用的 ID 字段，防止后端逻辑干扰
                document.getElementById('cargoIdInput').value = '';
                
                // 将数组序列化为 JSON
                batchDataInput.value = JSON.stringify(batchData);
                saveForm.submit();
            }
        }
        function batchUpdateDeliveryMethod() {
            const selectedCheckboxes = Array.from(document.querySelectorAll('.self-cargo-checkbox:checked'))
                .filter(checkbox => {
                    const row = checkbox.closest('tr');
                    return row.style.display !== 'none' && !row.classList.contains('filter-row');
                });

            if (selectedCheckboxes.length === 0) {
                alert('请先选择要修改派送方式的行');
                return;
            }

            if (!confirm(`确定要批量修改选中的 ${selectedCheckboxes.length} 项派送方式吗？`)) {
                return;
            }

            const methodData = selectedCheckboxes.map(checkbox => {
                const row = checkbox.closest('tr');
                return {
                    cargo_id: checkbox.value,
                    delivery_method: row.querySelector('.delivery-method-input').value
                };
            });

            const batchMethodsInput = document.getElementById('batchMethodsInput');
            const saveForm = document.getElementById('saveForm');

            if (batchMethodsInput && saveForm) {
                // 清空单行保存用的 ID，防止后端混淆
                document.getElementById('cargoIdInput').value = '';
                // 关键：修改 step 告诉后端这是一个批量修改派送方式的操作
                const stepInput = saveForm.querySelector('input[name="step"]');
                stepInput.value = "batch_update_delivery_method"; 
                
                batchMethodsInput.value = JSON.stringify(methodData);
                saveForm.submit();
            }
        }
        // 将函数暴露到全局作用域
        window.selfpick_toggleSelectAll = selfpick_toggleSelectAll;
        window.scheduleShipment = scheduleShipment;
        window.clearSelfPickAllFilters = clearSelfPickAllFilters;
        window.applySelfPickColumnFilter = applySelfPickColumnFilter;
        window.updateSelfPickSelectedCount = updateSelfPickSelectedCount;
        window.saveRowData = saveRowData;
        window.autoResizeTextarea = autoResizeTextarea;
        window.copySelectedRows = copySelectedRows;
        window.showCopyNotification = showCopyNotification;
        window.selfpick_batchSaveRows = selfpick_batchSaveRows;
        window.batchUpdateDeliveryMethod = batchUpdateDeliveryMethod;
    })(); // 立即执行
</script>