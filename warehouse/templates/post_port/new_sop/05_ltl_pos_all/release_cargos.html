{% load custom_filters %}
<style>
    /* 未放行页面精简样式 */
    .search-box {
        display: flex;
        gap: 15px;
        margin-bottom: 20px;
        align-items: center;
        flex-wrap: wrap;
        padding: 0;
    }

    .search-input {
        padding: 10px 15px;
        border: 1px solid #dce1e6;
        border-radius: 5px;
        font-size: 0.9rem;
        min-width: 300px;
        margin: 0;
    }

    .search-btn {
        padding: 10px 20px;
        background: var(--primary-color);
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-weight: 600;
    }

    .batch-actions {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 8px;
        align-items: center;
        border: 1px solid #e9ecef;
        flex-wrap: wrap;
    }

    .selected-count {
        font-weight: 600;
        color: var(--secondary-color);
    }

    /* 表格样式 */
    .table-container {
        overflow-x: auto;
        overflow-y: auto;
        max-height: 600px;
        border-radius: 8px;
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
        margin-bottom: 20px;
    }

    .data-table {
        width: 100%;
        border-collapse: collapse;
    }

    .data-table th {
        position: sticky;
        top: 0;
        background: var(--secondary-color);
        color: white;
        padding: 12px;
        text-align: left;
        font-weight: 600;
        font-size: 0.9rem;
    }

    .data-table td {
        padding: 10px 12px;
        border-bottom: 1px solid #eaecef;
        font-size: 0.85rem;
    }

    .data-table tr:nth-child(even) {
        background-color: #f9fafb;
    }

    .data-table tr:hover {
        background-color: #edf2f7;
    }

    .checkbox-cell {
        width: 40px;
        text-align: center;
    }

    /* 状态标签样式 */
    .pallet-badge {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.8rem;
        font-weight: 600;
    }

    .pallet-actual {
        background-color: #e8f5e9;
        color: #2e7d32;
        border: 1px solid #c8e6c9;
    }

    .pallet-estimated {
        background-color: #fff3e0;
        color: #ef6c00;
        border: 1px solid #ffe0b2;
    }

    .status-badge {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.8rem;
        font-weight: 600;
    }

    .status-expired {
        background-color: #ffebee;
        color: #c62828;
        border: 1px solid #ffcdd2;
    }

    .selected-stats {
        display: flex; 
        align-items: center;
        gap: 15px;
        padding: 8px 15px;
        background: #e8f5e9;
        border-radius: 6px;
        border: 1px solid #c8e6c9;
        font-size: 0.9rem;
    }

    /* 重量显示样式 */
    .weight-display {
        display: flex;
        flex-direction: column;
        gap: 2px;
    }

    .weight-lbs {
        color: #7b1fa2;
        font-weight: 600;
    }

    .weight-kg {
        color: #388e3c;
        font-size: 0.75rem;
    }
</style>

<!-- 搜索区域 -->
<div class="search-box">
    <div style="display: flex; gap: 10px; align-items: center; flex: 1;">
        <input type="text" class="search-input" placeholder="搜索客户、目的地、唛头、柜号..." id="cargoSearch">
        <button class="search-btn" id="searchCargoBtn">
            <i class="fas fa-search"></i> 搜索
        </button>
    </div>
</div>

<!-- 批量操作区域 -->
<div class="batch-actions">
    <span class="selected-count">已选择 <span id="selectedCount">0</span> 组货物</span>

    <div id="selectedStats" class="selected-stats">
        <span style="font-weight: 600; color: #2e7d32;">
            选中总板数: <span id="selectedPalletsCount">0</span>
        </span>
        <span style="font-weight: 600; color: #1565c0;">
            选中总CBM: <span id="selectedCbmCount">0.00</span>
        </span>
        <span style="font-weight: 600; color: #7b1fa2;">
            选中总重量: <span id="selectedWeightLbsCount">0.00</span> lbs
        </span>
    </div>
    <button class="action-btn btn-primary" onclick="exportSelectedCargos()">
        <i class="fas fa-file-export"></i> 导出选PO
    </button>
</div>

<!-- 数据表格 -->
<div class="table-container">
    <table class="data-table" id="cargoTable">
        <thead>
            <tr>
                <th class="checkbox-cell">
                    <input type="checkbox" id="selectAllCargos" onclick="toggleSelectAll()">
                </th>
                <th>客户</th>
                <th>柜号</th>
                <th>目的地</th>
                <th>唛头</th>
                <th>详细地址</th>
                <th>备注</th>
                <th>CBM</th>
                <th>件数</th>
                <th>重量</th>
                <th>板数</th>
            </tr>
        </thead>
        <tbody>
            {% for cargo in release_cargos %}
            <tr data-cargo-id="{{ cargo.ids }}" 
                data-customer="{{ cargo.customer_name|default:'' }}"
                data-destination="{{ cargo.destination|default:'' }}" 
                data-shipping-mark="{{ cargo.shipping_marks|default:'' }}"
                data-container-number="{{ cargo.container_numbers|default:'' }}"
                data-pallets="{% if cargo.label == 'ACT' %}{{ cargo.total_n_pallet_act|default:0 }}{% else %}{{ cargo.total_n_pallet_est|default:0 }}{% endif %}" 
                data-cbm="{{ cargo.total_cbm|default:0 }}"
                data-weight-lbs="{{ cargo.total_weight_lbs|default:0 }}"
                data-weight-kg="{{ cargo.total_weight_kg|default:0 }}"
                data-pcs="{{ cargo.total_pcs|default:0 }}">
                <td class="checkbox-cell">
                    <input type="checkbox" class="cargo-checkbox" 
                        value="{% if cargo.plt_ids %}plt_{{ cargo.plt_ids }}{% else %}{{ cargo.ids }}{% endif %}"
                        onchange="updateSelectedCount()">
                </td>
                <td>{{ cargo.customer_name|default:"-" }}</td>
                <td class="container-col" title="{{ cargo.container_numbers|default:'' }}">
                    {{ cargo.container_numbers|default:"-" }}
                </td>
                <td>{{ cargo.destination|default:"-" }}</td>
                <td>{{ cargo.shipping_marks|default:"-" }}</td>
                <td>{{ cargo.address|default:"-" }}</td>
                <td>{{ cargo.note|default_if_none:"-" }}</td>
                <td>
                    <span class="status-badge status-expired">{{ cargo.total_cbm|floatformat:3 }}</span>
                </td>
                <td>{{ cargo.total_pcs|default:0 }}</td>
                <td>
                    <div class="weight-display">
                        <span class="weight-lbs">{{ cargo.total_weight_lbs|floatformat:2 }} lbs</span>
                        <span class="weight-kg">{{ cargo.total_weight_kg|floatformat:2 }} kg</span>
                    </div>
                </td>
                <td class="pallet-col">
                    {% if cargo.label == 'ACT' %}
                        <span class="pallet-badge pallet-actual">
                            <span style="font-size: 16px; font-weight: bold;">{{ cargo.total_n_pallet_act|default:0 }}</span> ACT
                        </span>
                    {% else %}
                        <span class="pallet-badge pallet-estimated">
                            <span style="font-size: 16px; font-weight: bold;">{{ cargo.total_n_pallet_est|default:0 }}</span> EST
                        </span>
                    {% endif %}
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="11" style="text-align: center; padding: 20px;">
                    暂无未放行货物
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
<!-- 导PO的表单 -->
<form method="post" action="" id="exportForm" style="display: none;">
    {% csrf_token %}
    <input type="hidden" name="step" value="export_ltl_pos">
    <input type="hidden" name="cargo_ids" id="cargoIdsInput">
    <input type="hidden" name="plt_ids" id="pltIdsInput">
    <input type="hidden" name="warehouse" value="{{ warehouse }}">
</form>

<script>
    // 未放行页面JavaScript - 精简版
    document.addEventListener('DOMContentLoaded', function() {
        initializeUnscheduledPage();
    });

    function initializeUnscheduledPage() {
        updateSelectedCount();
        
        // 全选/取消全选
        const selectAllCheckbox = document.getElementById('selectAllCargos');
        if (selectAllCheckbox) {
            selectAllCheckbox.addEventListener('change', toggleSelectAll);
        }

        // 单个选择框变化
        document.querySelectorAll('.cargo-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                updateSelectedCount();
            });
        });

        // 搜索功能
        const searchCargoBtn = document.getElementById('searchCargoBtn');
        if (searchCargoBtn) {
            searchCargoBtn.addEventListener('click', applySearchFilter);
        }

        const cargoSearch = document.getElementById('cargoSearch');
        if (cargoSearch) {
            cargoSearch.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    applySearchFilter();
                }
            });
        }
    }

    // 全选功能
    function toggleSelectAll() {
        const selectAllCheckbox = document.getElementById('selectAllCargos');
        const cargoCheckboxes = document.querySelectorAll('.cargo-checkbox');
        const isChecked = selectAllCheckbox.checked;
        
        cargoCheckboxes.forEach(checkbox => {
            const row = checkbox.closest('tr');
            if (row.style.display !== 'none') {
                checkbox.checked = isChecked;
            }
        });
        updateSelectedCount();
    }

    function exportSelectedCargos() {
        const selectedCheckboxes = Array.from(document.querySelectorAll('.cargo-checkbox:checked'))
        .filter(checkbox => checkbox.closest('tr').style.display !== 'none');
        
        if (selectedCheckboxes.length === 0) {
            alert('请先选择要导出的货物');
            return;
        }

        const cargoIds = [];
        const pltIds = [];

        selectedCheckboxes.forEach(checkbox => {
            const value = checkbox.value.trim();
            if (value.startsWith('plt_')) {
                pltIds.push(value.replace(/^plt_/, ''));
            } else {
                cargoIds.push(value);
            }
        });

        // 设置隐藏表单字段并提交
        const cargoIdsInput = document.getElementById('cargoIdsInput');
        const pltIdsInput = document.getElementById('pltIdsInput');
        const exportForm = document.getElementById('exportForm');
        
        if (cargoIdsInput && pltIdsInput && exportForm) {
            cargoIdsInput.value = cargoIds.join(',');
            pltIdsInput.value = pltIds.join(',');
            exportForm.submit();
        }
    }

    // 搜索功能
    function applySearchFilter() {
        const searchTerm = document.getElementById('cargoSearch');
        if (!searchTerm) return;
        
        const searchValue = searchTerm.value.trim().toLowerCase();
        const rows = document.querySelectorAll('#cargoTable tbody tr');
        
        // 将搜索词按空格分割成多个关键词
        const searchKeywords = searchValue.split(/\s+/).filter(keyword => keyword.length > 0);

        rows.forEach(row => {
            const customer = (row.dataset.customer || '').toLowerCase();
            const destination = (row.dataset.destination || '').toLowerCase();
            const shippingMark = (row.dataset.shippingMark || '').toLowerCase();
            const containerNumber = (row.dataset.containerNumber || '').toLowerCase();
            const address = row.cells[5].textContent.toLowerCase();
            const note = row.cells[6].textContent.toLowerCase();

            let match = true;
            if (searchKeywords.length > 0) {
                // 检查任一关键词是否匹配任一字段
                match = searchKeywords.some(keyword => {
                    return customer.includes(keyword) ||
                           destination.includes(keyword) ||
                           shippingMark.includes(keyword) ||
                           containerNumber.includes(keyword) ||
                           address.includes(keyword) ||
                           note.includes(keyword);
                });
            }

            if (match) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
                // 隐藏行时取消选中
                const checkbox = row.querySelector('.cargo-checkbox');
                if (checkbox) {
                    checkbox.checked = false;
                }
            }
        });

        updateSelectedCount();
    }

    // 更新选中数量
    function updateSelectedCount() {
        const selectedCountEl = document.getElementById('selectedCount');
        if (!selectedCountEl) return;
        
        const selectedCheckboxes = Array.from(document.querySelectorAll('.cargo-checkbox:checked'))
            .filter(checkbox => checkbox.closest('tr').style.display !== 'none');
        
        const selectedCount = selectedCheckboxes.length;
        selectedCountEl.textContent = selectedCount;

        // 计算选中货物的统计数据
        let totalSelectedPallets = 0;
        let totalSelectedCbm = 0;
        let totalSelectedWeightLbs = 0;
        
        selectedCheckboxes.forEach(checkbox => {
            const row = checkbox.closest('tr');
            const pallets = parseFloat(row.dataset.pallets) || 0;
            const cbm = parseFloat(row.dataset.cbm) || 0;
            const weightLbs = parseFloat(row.dataset.weightLbs) || 0;
            
            totalSelectedPallets += pallets;
            totalSelectedCbm += cbm;
            totalSelectedWeightLbs += weightLbs;
        });
        
        // 更新选中统计显示
        const selectedPalletsCountEl = document.getElementById('selectedPalletsCount');
        const selectedCbmCountEl = document.getElementById('selectedCbmCount');
        const selectedWeightLbsCountEl = document.getElementById('selectedWeightLbsCount');
        
        if (selectedPalletsCountEl) {
            selectedPalletsCountEl.textContent = Math.round(totalSelectedPallets);
        }
        if (selectedCbmCountEl) {
            selectedCbmCountEl.textContent = totalSelectedCbm.toFixed(2);
        }
        if (selectedWeightLbsCountEl) {
            selectedWeightLbsCountEl.textContent = totalSelectedWeightLbs.toFixed(2);
        }
        
        // 更新全选框的状态
        updateSelectAllCheckbox();
    }

    function updateSelectAllCheckbox() {
        const selectAllCheckbox = document.getElementById('selectAllCargos');
        if (!selectAllCheckbox) return;
        
        const visibleCheckboxes = Array.from(document.querySelectorAll('.cargo-checkbox'))
            .filter(checkbox => checkbox.closest('tr').style.display !== 'none');
        
        if (visibleCheckboxes.length === 0) {
            selectAllCheckbox.checked = false;
            selectAllCheckbox.indeterminate = false;
            return;
        }
        
        const checkedCount = visibleCheckboxes.filter(checkbox => checkbox.checked).length;
        
        if (checkedCount === 0) {
            selectAllCheckbox.checked = false;
            selectAllCheckbox.indeterminate = false;
        } else if (checkedCount === visibleCheckboxes.length) {
            selectAllCheckbox.checked = true;
            selectAllCheckbox.indeterminate = false;
        } else {
            selectAllCheckbox.checked = false;
            selectAllCheckbox.indeterminate = true;
        }
    }
</script>