{% load custom_filters %}
<style>
    /* 保持原有样式，新增唛头列样式 */
    .shipping-mark-container {
        max-width: 200px;
        max-height: 100px;
        overflow-y: auto;
        padding: 5px;
        background: #f8f9fa;
        border-radius: 4px;
        font-size: 0.75rem;
    }
    
    .shipping-mark-item {
        display: inline-block;
        background: #e9ecef;
        padding: 2px 6px;
        margin: 2px;
        border-radius: 3px;
        border-left: 3px solid #6c757d;
    }
    
    .search-row {
        background-color: #f8f9fa !important;
    }

    .search-row td, 
    .search-row th {
        padding: 5px !important;
        border-bottom: 1px solid #dee2e6 !important;
    }

    .col-search-input {
        width: 100%;
        padding: 4px 8px;
        border: 1px solid #ced4da;
        border-radius: 4px;
        font-size: 0.8rem;
        background: white;
    }
    
    .filter-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        flex-wrap: wrap;
        gap: 15px;
    }
    
    .filter-info {
        flex: 1;
        background-color: #f8f9fa;
        border-left: 4px solid #6c757d;
        padding: 10px 15px;
        border-radius: 4px;
        font-size: 14px;
        color: #495057;
        min-width: 300px;
    }
    
    .action-buttons {
        display: flex;
        gap: 10px;
        align-items: center;
    }
    
    /* 表格样式 */
    .data-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
    }
    
    .data-table th,
    .data-table td {
        padding: 10px 8px;
        border: 1px solid #dee2e6;
        vertical-align: top;
    }
    
    .data-table th {
        background-color: #f8f9fa;
        font-weight: 600;
        text-align: left;
        white-space: nowrap;
    }
    
    .table-container {
        overflow-x: auto;
        border-radius: 6px;
        border: 1px solid #dee2e6;
        background: white;
    }
    
    .status-span-red {
        background-color: #ffcccc;
        color: #990000;
        padding: 2px 6px;
        border-radius: 3px;
        font-size: 0.75rem;
        margin-right: 5px;
    }
    
    .status-span-yellow {
        background-color: #fff3cd;
        color: #856404;
        padding: 2px 6px;
        border-radius: 3px;
        font-size: 0.75rem;
        margin-right: 5px;
    }
    
    /* 高亮样式 */
    .highlight-color-1 { background-color: #ffd700; color: black; }
    .highlight-color-2 { background-color: #87ceeb; color: black; }
    .highlight-color-3 { background-color: #98fb98; color: black; }
    .highlight-color-4 { background-color: #ffb6c1; color: black; }
</style>

<!-- 未排车批次标签页 -->
<div class="filter-header">
    <div class="filter-info">
        <i class="fas fa-filter"></i> 
        当前显示 <strong>{{ warehouse }}</strong> 仓库的未排车货物，筛选条件：          
        <strong>未排车</strong>、
        <strong>约在使用中</strong>、
        <strong>约未取消</strong>、
        <strong>约类型为LTL/客户自提</strong>
    </div>
    <div class="action-buttons">
        <button class="action-btn btn-primary" id="confirmScheduleBtn">
            <i class="fas fa-truck"></i> 确认排车
        </button>
    </div>
</div>

{% if unschedule_fleet %}
<div class="table-container">
    <table class="data-table">
        <thead>
            <tr>
                <th style="width: 40px; text-align: center;">选择</th>
                <th style="min-width: 150px;">预约批次</th>
                <th style="min-width: 120px;">目的仓库</th>
                <th style="min-width: 200px;">唛头</th>  <!-- 新增唛头列，替换预约号 -->
                <th style="min-width: 150px;">Scheduled Time</th>
                <th style="min-width: 150px;">Pickup Time</th>
                <th style="min-width: 80px;">总重(lbs)</th>
                <th style="min-width: 80px;">总CBM</th>
                <th style="min-width: 80px;">总卡板数</th>
                <th style="min-width: 150px;">备注</th>
            </tr>
            <tr class="search-row">
                <td></td>
                <td><input data-col="1" class="col-search-input" placeholder="搜索预约批次"></td>
                <td><input data-col="2" class="col-search-input" placeholder="搜索目的仓库"></td>
                <td><input data-col="3" class="col-search-input" placeholder="搜索唛头"></td>  <!-- 唛头搜索 -->
                <td><input data-col="4" class="col-search-input" placeholder="搜索送仓时间"></td>
                <td><input data-col="5" class="col-search-input" placeholder="搜索提货时间"></td>
                <td><input data-col="6" class="col-search-input" placeholder="搜索重量"></td>
                <td><input data-col="7" class="col-search-input" placeholder="搜索CBM"></td>
                <td><input data-col="8" class="col-search-input" placeholder="搜索板数"></td>
                <td><input data-col="9" class="col-search-input" placeholder="搜索备注"></td>
            </tr>
        </thead>
        <tbody>
            {% for s in unschedule_fleet %}
            <tr>
                <td style="text-align: center;">
                    <input type='checkbox' name='is_appointment_added' 
                            onclick="toggleRowBackground(this)" 
                            {% if s.id in shipment_ids %}checked{% endif %} 
                            {% if s.abnormal_palletization or s.po_expired %}disabled{% endif %}>
                    <input type="hidden" name="shipment_ids" value='{{ s.id }}'>
                </td>
                <td style="word-break: break-word;">
                    {% if s.batch > 0 %}
                    <span class="status-span-red">甩板</span>
                    {% endif %}
                    {{ s.shipment_batch_number|default:"" }}
                </td>
                <td style="word-break: break-word;">
                    {{ s.destination|default:"" }}
                    {% if s.abnormal_palletization %}
                    <span class="status-span-red" style="display: block; margin-top: 3px;">未解决拆柜异常</span>
                    {% endif %}
                    {% if s.po_expired %}
                    <span class="status-span-yellow" style="display: block; margin-top: 3px;">PO失效</span>
                    {% endif %}
                </td>
                <td>
                    <div class="shipping-mark-container">
                        {% if s.shipping_marks %}
                            {% for mark in s.shipping_marks %}
                                <div class="shipping-mark-item" title="{{ mark }}">
                                    {{ mark|truncatechars:15 }}
                                </div>
                            {% endfor %}
                        {% else %}
                            <span style="color: #6c757d; font-style: italic;">无唛头</span>
                        {% endif %}
                    </div>
                </td>
                <td style="word-break: break-word;" data-original-time="{{ s.shipment_appointment|date:'Y-m-d H:i:s' }}">
                    {% if s.shipping_status == "past_due" %}
                    <span class="status-span-red">{{ s.shipment_appointment|date:"Y-m-d H:i" }}</span>
                    {% elif s.shipping_status == "need_attention" %}
                    <span class="status-span-yellow">{{ s.shipment_appointment|date:"Y-m-d H:i" }}</span>
                    {% else %}
                    {{ s.shipment_appointment|date:"Y-m-d H:i" }}
                    {% endif %}
                </td>
                <td data-pickup-time="{{ s.pickup_time|date:'Y-m-d\TH:i' }}">
                    {{ s.pickup_time|date:"Y-m-d H:i" }}
                </td>
                <td>{{ s.total_weight|floatformat:2|default:"0.00" }}</td>
                <td>{{ s.total_cbm|floatformat:2|default:"0.00" }}</td>
                <td>{{ s.total_pallet|default:"0" }}</td>
                <td style="word-break: break-word;" title="{% if s.note %}{{ s.note }}{% endif %}">
                    {% if s.note %}
                        {{ s.note|truncatechars:30 }}
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% else %}
<div style="text-align: center; padding: 40px; color: #6c757d; background: white; border-radius: 6px; margin-top: 15px;">
    <i class="fas fa-robot" style="font-size: 3rem; margin-bottom: 15px;"></i>
    <p>暂无待排车批次</p>
</div>
{% endif %}

<!-- 排车模态框需要相应更新 -->
<div id="fleetModal" class="modal">
  <div class="modal-content" style="width: 90%; max-width: 1200px; min-width: 800px;">
    <div id="fleetModalBody" style="padding-top: 10px;">
        <div style="border-radius: 12px; padding: 20px; margin-top: 10px;">
            <form method="post" action="" style="width: 100%;" onsubmit="showLoadingBar()">
                {% csrf_token %}
                <input type="hidden" name="step" id="fleetModalStep" value="fleet_confirmation">
                <input type="hidden" name="fleet_number" id="fleetModalFleetNumber">
                <input type="hidden" name="selected_ids" id="fleetModalSelectedIds">
                <input type="hidden" name="warehouse" value="{{ warehouse }}">
                <input type="hidden" name="page" value="ltl_unscheduledFleet">
                <input type="hidden" name="active_tab" value="unscheduledFleet">
                
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h4 style="color: var(--secondary-color); margin: 0;">
                        <i class="fas fa-truck-loading"></i> 出库批次信息
                    </h4>
                    <div>
                        <span class="close-btn" onclick="closeUnscheduledFleetModal()" style="width: 35px; height: 35px; background: #e74c3c; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 22px; font-weight: bold; cursor: pointer; transition: all 0.3s ease;">&times;</span>
                    </div>
                </div>

                <!-- 合并所有表单字段到一个表格 -->
                <div class="table-container" style="margin-bottom: 20px;">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th colspan="3" style="text-align: center;">车辆信息</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td style="width: 33%;">
                                    <label style="font-size: 0.8rem; font-weight: 600; color: var(--secondary-color); display: block; margin-bottom: 5px;">carrier</label>
                                    <select name="carrier" id="fleetModalCarrier" style="font-size: 13px; width: 100%; padding: 5px;">
                                        {% for k, v in carrier_options.items %}
                                        <option value="{{ v }}">{{ k }}</option>
                                        {% endfor %}
                                    </select>
                                </td>
                                <td style="width: 33%;">
                                    <label style="font-size: 0.8rem; font-weight: 600; color: var(--secondary-color); display: block; margin-bottom: 5px;">3rd Party Address</label>
                                    <input type="text" name="third_party_address" id="fleetModalThirdPartyAddress" class="table-input" style="width: 100%;">
                                </td>
                                <td style="width: 33%;">
                                    <label style="font-size: 0.8rem; font-weight: 600; color: var(--secondary-color); display: block; margin-bottom: 5px;">PickUp Number</label>
                                    <input type="text" name="pickup_number" id="fleetModalPickupNumber" class="table-input" style="width: 100%;">
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    <label style="font-size: 0.8rem; font-weight: 600; color: var(--secondary-color); display: block; margin-bottom: 5px;">车牌号</label>
                                    <input type="text" name="license_plate" id="fleetModalLicensePlate" class="table-input" style="width: 100%;">
                                </td>
                                <td>
                                    <label style="font-size: 0.8rem; font-weight: 600; color: var(--secondary-color); display: block; margin-bottom: 5px;">MC Number</label>
                                    <input type="text" name="motor_carrier_number" id="fleetModalMotorCarrierNumber" class="table-input" style="width: 100%;">
                                </td>
                                <td>
                                    <label style="font-size: 0.8rem; font-weight: 600; color: var(--secondary-color); display: block; margin-bottom: 5px;">DOT Number</label>
                                    <input type="text" name="dot_number" id="fleetModalDotNumber" class="table-input" style="width: 100%;">
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    <label style="font-size: 0.8rem; font-weight: 600; color: var(--secondary-color); display: block; margin-bottom: 5px;">提货时间</label>
                                    <input type="datetime-local" name="appointment_datetime" id="fleetModalAppointmentDatetime" class="table-input" style="width: 100%;" required>
                                </td>
                                <td>
                                    <label style="font-size: 0.8rem; font-weight: 600; color: var(--secondary-color); display: block; margin-bottom: 5px;">备注</label>
                                    <input type="text" name="note" id="fleetModalNote" class="table-input" style="width: 100%;">
                                </td>
                                <td>
                                    <label style="font-size: 0.8rem; font-weight: 600; color: var(--secondary-color); display: block; margin-bottom: 5px;">费用</label>
                                    <input type="number" name="fleet_cost" id="fleetCost" class="table-input" style="width: 100%;" step="0.01">
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>          

                <div style="display: flex; justify-content: space-between; align-items: center; margin: 25px 0 15px 0;">
                    <h4 style="color: var(--secondary-color); margin: 0;">
                        <i class="fas fa-list-alt"></i> 预约批次信息
                    </h4>
                    <button type="submit" class="action-btn btn-success" id="fleetModalConfirmBtn">
                        <i class="fas fa-check"></i> 确认排车
                    </button>
                </div>
            </form>

            <div class="table-container" style="max-height: 300px;">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>预约批次</th>
                            <th>目的地</th>
                            <th>唛头</th>  <!-- 添加唛头列 -->
                            <th>Scheduled Time</th>                         
                            <th>总重(lbs)</th>
                            <th>总CBM</th>
                            <th>总卡板数</th>
                            <th>备注</th>
                        </tr>
                    </thead>
                    <tbody id="fleetShipmentTableBody">
                        <!-- 这里用JS动态插入选中的批次 -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
  </div>
</div>

<script>
    // 定义初始化函数
    function initializeUnscheduledFleetSection() {
        console.log('未排车页面初始化');
        
        // 修改选择器：使用主页面中的容器ID
        const container = document.getElementById("unscheduledFleet-section");
        if (!container) {
            console.error('未找到unscheduledFleet-section容器');
            return;
        }
        
        // 绑定搜索框事件 - 在容器内查找
        container.querySelectorAll('.col-search-input')
            .forEach(input => {
                input.addEventListener('input', applyUnscheduledColumnSearch);
            });
        
        // 绑定确认排车按钮
        const confirmBtn = container.querySelector("#confirmScheduleBtn");
        if (confirmBtn) {
            console.log('找到确认排车按钮');
            // 使用事件委托，避免重复绑定
            confirmBtn.onclick = handleConfirmSchedule;
        } else {
            console.error('在容器内未找到确认排车按钮');
        }
        
        // 标记时间行
        markUnscheduledFleetRows();
    }

    // 处理确认排车
    function handleConfirmSchedule() {
        console.log('handleConfirmSchedule函数被调用');
        
        // 在整个页面中查找复选框（不限定范围）
        const allCheckboxes = document.querySelectorAll('input[type="checkbox"][name="is_appointment_added"]');
        console.log('找到所有复选框数量:', allCheckboxes.length);
        
        const checkedCheckboxes = Array.from(allCheckboxes).filter(cb => {
            return cb.checked && !cb.disabled;
        });
        
        console.log('选中的复选框数量:', checkedCheckboxes.length);
        
        // 调试：打印每个复选框的状态
        checkedCheckboxes.forEach((cb, index) => {
            console.log(`选中的复选框 ${index}:`, {
                checked: cb.checked,
                disabled: cb.disabled,
                parentRow: cb.closest('tr') ? '找到行' : '未找到行',
                shipmentId: cb.closest('tr')?.querySelector('input[name="shipment_ids"]')?.value || '无ID'
            });
        });
        
        if (checkedCheckboxes.length === 0) {
            alert("请先选择至少一条待排车批次！");
            return;
        }

        const selectedIds = [];
        let pickupTime = '';

        checkedCheckboxes.forEach(cb => {
            const tr = cb.closest('tr');
            if (!tr) return;
            
            const hiddenInput = tr.querySelector('input[name="shipment_ids"]');
            if (hiddenInput && hiddenInput.value) {
                selectedIds.push(hiddenInput.value);
                console.log('找到shipment_id:', hiddenInput.value);
                
                // 获取第一条选中记录的Pickup Time
                if (!pickupTime) {
                    const pickupTimeCell = tr.querySelector('td[data-pickup-time]');
                    if (pickupTimeCell && pickupTimeCell.dataset.pickupTime) {
                        pickupTime = pickupTimeCell.dataset.pickupTime;
                        console.log('找到pickup时间:', pickupTime);
                    }
                }
            }
        });

        if (selectedIds.length === 0) {
            alert("未找到有效的批次ID");
            return;
        }

        console.log('准备打开模态框，选中的ID:', selectedIds);
        
        // 设置选中的ID到隐藏字段
        const selectedIdsInput = document.getElementById('fleetModalSelectedIds');
        if (selectedIdsInput) {
            selectedIdsInput.value = JSON.stringify(selectedIds);
        }
        
        // 将选中的记录信息填入弹窗表格
        const tbody = document.getElementById("fleetShipmentTableBody");
        if (tbody) {
            tbody.innerHTML = ""; // 清空旧内容

            checkedCheckboxes.forEach(cb => {
                const tr = cb.closest("tr");
                if (!tr) return;
                
                const cells = tr.querySelectorAll("td");
                
                // 获取唛头信息
                let shippingMarks = "无唛头";
                const markCell = cells[3];
                if (markCell) {
                    const markItems = markCell.querySelectorAll('.shipping-mark-item');
                    if (markItems.length > 0) {
                        shippingMarks = Array.from(markItems).map(item => {
                            const title = item.getAttribute('title');
                            return title || item.textContent.trim();
                        }).join(", ");
                    }
                }
                
                const newRow = document.createElement("tr");
                newRow.innerHTML = `
                    <td style="word-break: break-word;">${cells[1]?.innerText?.trim() || ''}</td>
                    <td>${cells[2]?.innerText?.trim() || ''}</td>
                    <td style="word-break: break-word;" title="${shippingMarks}">
                        ${shippingMarks.length > 50 ? shippingMarks.substring(0, 50) + '...' : shippingMarks}
                    </td>
                    <td style="word-break: break-word;">${cells[4]?.innerText?.trim() || ''}</td>
                    <td>${cells[6]?.innerText?.trim() || '0.00'}</td>
                    <td>${cells[7]?.innerText?.trim() || '0.00'}</td>
                    <td>${cells[8]?.innerText?.trim() || '0'}</td>
                    <td style="word-break: break-word;">${cells[9]?.innerText?.trim() || ''}</td>
                `;
                tbody.appendChild(newRow);
            });
        }
        
        // 设置提货时间到弹框
        const datetimeInput = document.getElementById('fleetModalAppointmentDatetime');
        if (datetimeInput) {
            if (pickupTime) {
                datetimeInput.value = pickupTime;
            } else {
                // 默认使用当前时间
                const now = new Date();
                const formattedNow = now.toISOString().slice(0, 16);
                datetimeInput.value = formattedNow;
            }
        }
        
        // 显示弹窗
        const modal = document.getElementById("fleetModal");
        if (modal) {
            modal.style.display = "block";
            console.log('模态框已显示');
        } else {
            console.error('未找到模态框元素');
        }
    }

    // 时间标记功能 - 修改选择器
    function markUnscheduledFleetRows() {
        const container = document.getElementById("unscheduledFleet-section");
        if (!container) return;
        
        const rows = container.querySelectorAll('.data-table tbody tr');
        const now = new Date();
        
        rows.forEach(row => {
            // 跳过搜索行
            if (row.classList.contains('search-row')) return;
            
            const timeCell = row.cells[4]; // Scheduled Time在第5列
            if (!timeCell) return;
            
            const timeAttr = timeCell.getAttribute('data-original-time');
            const timeText = timeCell.textContent.trim();
            
            let scheduledTime = null;
            
            // 优先使用data属性
            if (timeAttr) {
                scheduledTime = new Date(timeAttr);
            } 
            // 否则尝试解析文本
            else if (timeText) {
                // 尝试解析日期时间格式
                const match = timeText.match(/(\d{4})-(\d{2})-(\d{2}) (\d{2}):(\d{2})/);
                if (match) {
                    scheduledTime = new Date(
                        parseInt(match[1]),
                        parseInt(match[2]) - 1,
                        parseInt(match[3]),
                        parseInt(match[4]),
                        parseInt(match[5])
                    );
                }
            }
            
            if (scheduledTime && !isNaN(scheduledTime.getTime())) {
                const diffHours = Math.floor((scheduledTime - now) / (1000 * 60 * 60));
                
                if (scheduledTime < now) {
                    // 已过期 - 深红色
                    row.style.backgroundColor = '#ffcccc';
                } else if (diffHours <= 24) {
                    // 未来24小时内 - 浅红色
                    row.style.backgroundColor = '#ffe6e6';
                } else if (diffHours <= 48) {
                    // 未来24-48小时 - 黄色
                    row.style.backgroundColor = '#fff9e6';
                } else {
                    row.style.backgroundColor = '';
                }
            }
        });
    }

    // 搜索功能 - 修改选择器
    function applyUnscheduledColumnSearch() {
        const container = document.getElementById("unscheduledFleet-section");
        if (!container) return;
        
        const inputs = container.querySelectorAll('.col-search-input');
        const rows = container.querySelectorAll('.data-table tbody tr:not(.search-row)');

        // 收集每一列输入的搜索词
        const columnKeywords = {};
        inputs.forEach(input => {
            const col = input.dataset.col;
            const kw = input.value.trim().toLowerCase();
            if (kw) columnKeywords[col] = kw.split(/\s+/);
        });

        rows.forEach(row => {
            removeHighlights(row);

            let visible = true;

            // 逐列检查
            for (const col in columnKeywords) {
                const cell = row.cells[col];
                if (!cell) continue;
                
                let cellText = '';
                
                // 对于唛头列（第4列，索引3），需要特殊处理
                if (col === '3') {
                    const markItems = cell.querySelectorAll('.shipping-mark-item');
                    if (markItems.length > 0) {
                        cellText = Array.from(markItems).map(item => {
                            const title = item.getAttribute('title');
                            return (title || item.textContent).toLowerCase();
                        }).join(' ');
                    } else {
                        // 如果没有唛头，检查"无唛头"文本
                        const noMarkSpan = cell.querySelector('span');
                        if (noMarkSpan) {
                            cellText = noMarkSpan.textContent.toLowerCase();
                        } else {
                            cellText = cell.textContent.toLowerCase();
                        }
                    }
                } else {
                    cellText = cell.textContent.toLowerCase();
                }
                
                const keywords = columnKeywords[col];
                const match = keywords.every(kw => cellText.includes(kw));

                if (!match) {
                    visible = false;
                    break;
                }
            }

            row.style.display = visible ? "" : "none";

            // 高亮显示匹配的文本
            if (visible && Object.keys(columnKeywords).length > 0) {
                for (const col in columnKeywords) {
                    highlightMatches(row.cells[col], columnKeywords[col]);
                }
            }
        });
        
        // 重新标记时间行
        setTimeout(markUnscheduledFleetRows, 100);
    }

    // 移除旧高亮
    function removeHighlights(row) {
        if (!row) return;
        
        const highlights = row.querySelectorAll('[class^="highlight-color-"]');
        highlights.forEach(span => {
            const parent = span.parentNode;
            if (parent) {
                parent.replaceChild(document.createTextNode(span.textContent), span);
                // 合并相邻的文本节点
                parent.normalize();
            }
        });
    }

    // 对单元格内容添加关键词高亮
    function highlightMatches(element, keywords) {
        if (!element || !keywords || keywords.length === 0) return;

        let html = element.innerHTML;
        
        // 安全检查
        if (typeof html !== 'string') return;

        // 每个搜索词有独立颜色
        keywords.forEach((kw, index) => {
            if (!kw || kw.trim() === '') return;
            
            const escapedKw = kw.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            const cls = `highlight-color-${(index % 4) + 1}`;
            
            // 创建正则表达式，忽略HTML标签
            const regex = new RegExp(`(?![^<]*>)(${escapedKw})`, "gi");
            
            html = html.replace(regex, `<span class="${cls}">$1</span>`);
        });

        element.innerHTML = html;
    }

    // 行背景切换
    function toggleRowBackground(checkbox) {
        if (!checkbox) return;
        
        const row = checkbox.closest('tr');
        if (!row) return;
        
        if (checkbox.checked) {
            row.style.backgroundColor = '#e8f5e9';
        } else {
            // 恢复原来的时间标记颜色
            const timeCell = row.cells[4];
            if (timeCell) {
                const timeAttr = timeCell.getAttribute('data-original-time');
                const timeText = timeCell.textContent.trim();
                
                let scheduledTime = null;
                const now = new Date();
                
                if (timeAttr) {
                    scheduledTime = new Date(timeAttr);
                } else if (timeText) {
                    const match = timeText.match(/(\d{4})-(\d{2})-(\d{2}) (\d{2}):(\d{2})/);
                    if (match) {
                        scheduledTime = new Date(
                            parseInt(match[1]),
                            parseInt(match[2]) - 1,
                            parseInt(match[3]),
                            parseInt(match[4]),
                            parseInt(match[5])
                        );
                    }
                }
                
                if (scheduledTime && !isNaN(scheduledTime.getTime())) {
                    const diffHours = Math.floor((scheduledTime - now) / (1000 * 60 * 60));
                    
                    if (scheduledTime < now) {
                        row.style.backgroundColor = '#ffcccc';
                    } else if (diffHours <= 24) {
                        row.style.backgroundColor = '#ffe6e6';
                    } else if (diffHours <= 48) {
                        row.style.backgroundColor = '#fff9e6';
                    } else {
                        row.style.backgroundColor = '';
                    }
                } else {
                    row.style.backgroundColor = '';
                }
            } else {
                row.style.backgroundColor = '';
            }
        }
    }

    // 关闭模态框
    function closeUnscheduledFleetModal() {
        const modal = document.getElementById("fleetModal");
        if (modal) {
            modal.style.display = "none";
            
            // 重置弹窗内容
            const tbody = document.getElementById("fleetShipmentTableBody");
            if (tbody) tbody.innerHTML = "";
            
            // 重置表单
            const form = modal.querySelector('form');
            if (form) form.reset();
        }
    }

    // 加载状态显示
    function showLoadingBar() {
        const buttons = document.querySelectorAll('button');
        buttons.forEach(btn => {
            if (btn && btn.innerHTML && btn.innerHTML.includes('fa-check')) {
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 处理中...';
                btn.disabled = true;
            }
        });
    }

    // 全局变量
    const CURRENT_TIME = new Date('{{ current_time|date:"Y-m-d H:i" }}' || new Date());

    // 添加直接的事件绑定作为备用
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM加载完成');
        
        // 直接绑定按钮事件
        const confirmBtn = document.getElementById("confirmScheduleBtn");
        if (confirmBtn) {
            console.log('直接绑定确认排车按钮');
            confirmBtn.addEventListener("click", handleConfirmSchedule);
        }
        
        // 初始化搜索框事件
        const container = document.getElementById("unscheduledFleet-section");
        if (container) {
            container.querySelectorAll('.col-search-input')
                .forEach(input => {
                    input.addEventListener('input', applyUnscheduledColumnSearch);
                });
        }
    });
</script>