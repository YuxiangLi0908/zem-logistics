{% extends 'base.html' %}

{% block content %}
<style>
    body {
        background: #f5f6fa;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        color: #343a40;
    }

    .inventory-container { 
        padding: 25px; 
        background: #fff; 
        border-radius: 12px; 
        margin: 20px auto; 
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        width: 90%;
    }

    .header-section {
        display: flex;
        align-items: center;
        justify-content: space-between; /* 左右分开 */
        margin-bottom: 20px;
        padding: 15px 20px;
        background: #f8f9fa;
        border-radius: 8px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.06);
        flex-wrap: wrap;
    }

    .search-container input {
        width: 300px;
        padding: 6px 10px 6px 30px;
        border-radius: 6px;
        border: 1px solid #ced4da;
        font-size: 13px;
        background: url("data:image/svg+xml;charset=UTF-8,%3Csvg width='14' height='14' viewBox='0 0 24 24' fill='none' stroke='%23808e9b' stroke-width='2' stroke-linecap='round' stroke-linejoin='round' class='feather feather-search'%3E%3Ccircle cx='11' cy='11' r='8'/%3E%3Cline x1='21' y1='21' x2='16.65' y2='16.65'/%3E%3C/svg%3E") no-repeat 8px center;
        background-size: 14px 14px;
    }

    .table-container { 
        max-height: 65vh; 
        overflow-y: auto; 
        background: #fff; 
        border-radius: 8px; 
        box-shadow: 0 2px 8px rgba(0,0,0,0.06); 
        margin-bottom: 30px; 
    }

    .table { 
        width: 100%; 
        border-collapse: separate; 
        border-spacing: 0; 
        font-size: 13px; 
    }

    .table thead th { 
        background: #e9ecef; 
        padding: 12px; 
        border-bottom: 2px solid #dee2e6; 
        position: sticky; 
        top: 0; 
        z-index: 5; 
        text-align: center;
        color: #495057;
    }

    .table tbody td { 
        padding: 10px; 
        border-bottom: 1px solid #f1f3f5; 
        text-align: center; 
        vertical-align: middle; 
    }

    .table tbody tr:nth-child(even) { 
        background: #fdfdfd; 
    }

    .table tbody tr:hover { 
        background: #f1f3f5; 
    }

    .table td:first-child { 
        text-align: left; 
        font-family: monospace; 
        white-space: pre-line; 
        line-height: 1.5; 
        font-size: 13px; 
        background: #f8f9fa; 
        border-right: 1px solid #e9ecef;
        width: 280px; 
    }

    .table td:nth-child(3),
    .table td:nth-child(4),
    .table td:nth-child(5) {
        width: 90px;
    }

    .action-btn { 
        padding: 5px 12px; 
        border-radius: 20px; 
        border: none; 
        cursor: pointer; 
        font-size: 12px; 
        transition: 0.2s; 
    }
    .download-btn { background: #28a745; color: white; }
    .confirm-btn { background: #007bff; color: white; }
    .cancel-btn { background: #dc3545; color: white; }
    .action-btn:hover { opacity: 0.85; }

    .date-input { 
        font-size: 12px; 
        padding: 4px 6px; 
        border: 1px solid #ced4da; 
        border-radius: 5px; 
        margin-bottom: 4px; 
    }

    .pairs-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 4px 12px;
        text-align: left;
        white-space: nowrap;
    }

    .pairs-grid div {
        padding: 3px 5px;
        border-radius: 4px;
        background: #f1f3f5;
    }

    h4 {
        font-size: 18px;
        color: #495057;
        font-weight: 600;
        border-left: 5px solid #007bff;
        padding-left: 10px;
        margin-bottom: 12px;
    }
    .left-header {
        display: flex;
        align-items: center;
        gap: 20px;
    }
    .warehouse-selector {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .title-section b {
        font-size: 18px;
        color: #007bff;
    }

    .search-container {
        display: flex;
        justify-content: flex-end;
        flex: 1;
    }
</style>

<div class="inventory-container">
    <div class="header-section">
        <div class="left-header">
            <div class="title-section">
                <b>转仓历史记录</b>
            </div>
            <form method="post" action="" onsubmit="showLoadingBar()" class="warehouse-selector">
                {% csrf_token %}
                <b>目的仓库:</b>
                <select name="warehouse">
                    {% for k, v in warehouse_options.items %}
                    <option value="{{ v }}" {% if k == warehouse %}selected{% endif %}>{{ k }}</option>
                    {% endfor %}
                </select>
                <input type="hidden" name="step" value="history_warehouse">
                <button type="submit">确认</button>
            </form>            
        </div>
        <div class="search-container">
            <input type="text" id="searchInput" placeholder="输入关键字搜索..." onkeyup="filterTables()">
        </div>
    </div>

    {% if not_arrived %}
    <h4>未确认到达</h4>
    <div class="table-container">
        <table class="table" id="notArrivedTable">
            <thead>
                <tr>
                    <th>批次号</th>                 
                    <th>柜号</th>
                    <th>PickupNumber</th>
                    <th>卡板数</th>
                    <th>重量</th>
                    <th>体积</th>
                    <th>备注</th>
                    <th>下载BOL</th>
                    <th>确认送达</th>
                </tr>
            </thead>
            <tbody>
                {% for t in not_arrived %}
                <tr>
                    <td style="width:120px;">{{ t.transfer }}</td>
                    <td>
                        <div class="pairs-grid">
                            {% for pair in t.pairs %}
                                <div>{{ pair }}</div>
                            {% endfor %}
                        </div>
                    </td>
                    <td>{{ t.pickup_number }}</td>
                    <td>{{ t.transfer.total_pallet }}</td>
                    <td>{{ t.transfer.total_weight|floatformat:2 }}</td>
                    <td>{{ t.transfer.total_cbm|floatformat:2 }}</td>
                    <td>{{ t.transfer.note|default_if_none:'' }}</td>
                    <td>
                        <form method="post">
                            {% csrf_token %}
                            <input type="hidden" name="step" value="export_bol_transfer">
                            <input type="hidden" name="warehouse" value="{{ warehouse }}">
                            <input type="hidden" name="transfer_id" value="{{ t.transfer.id }}">
                            <button type="submit" class="action-btn download-btn">下载</button>
                        </form>
                    </td>
                    <td>
                        <form method="post">
                            {% csrf_token %}
                            <input type="hidden" name="step" value="confirm_arrived">
                            <input type="hidden" name="warehouse" value="{{ warehouse }}">
                            <input type="hidden" name="transfer_id" value="{{ t.transfer.id }}">
                            <input type="date" name="arrival_date" class="date-input" required>
                            <button type="submit" class="action-btn confirm-btn">确认</button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}

    {% if arrived %}
    <h4>已确认到达</h4>
    <div class="table-container">
        <table class="table" id="arrivedTable">
            <thead>
                <tr>
                    <th>批次号</th>                  
                    <th>柜号</th>
                    <th>PickupNumber</th>
                    <th>卡板数</th>
                    <th>重量</th>
                    <th>体积</th>
                    <th>备注</th>
                    <th>下载BOL</th>
                </tr>
            </thead>
            <tbody>
                {% for t in arrived %}
                <tr>
                    <td style="width:120px;">{{ t.transfer }}</td>
                    <td>
                        <div class="pairs-grid">
                            {% for pair in t.pairs %}
                                <div>{{ pair }}</div>
                            {% endfor %}
                        </div>
                    </td>
                    <td>{{ t.pickup_number }}</td>
                    <td>{{ t.transfer.total_pallet }}</td>
                    <td>{{ t.transfer.total_weight|floatformat:2 }}</td>
                    <td>{{ t.transfer.total_cbm|floatformat:2 }}</td>
                    <td>{{ t.transfer.note|default_if_none:'' }}</td>
                    <td>
                        <form method="post">
                            {% csrf_token %}
                            <input type="hidden" name="step" value="export_bol_transfer">
                            <input type="hidden" name="warehouse" value="{{ warehouse }}">
                            <input type="hidden" name="transfer_id" value="{{ t.transfer.id }}">
                            <button type="submit" class="action-btn download-btn">下载</button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}
</div>

<script>
    // 全局搜索功能
    function filterTables() {
        const filter = document.getElementById('searchInput').value.toLowerCase();
        
        // 搜索两个表格
        const tables = ['notArrivedTable', 'arrivedTable'];
        
        tables.forEach(tableId => {
            const table = document.getElementById(tableId);
            if (!table) return;
            
            const rows = table.getElementsByTagName('tbody')[0].getElementsByTagName('tr');
            
            for (let i = 0; i < rows.length; i++) {
                const row = rows[i];
                const rowText = row.textContent.toLowerCase();
                
                // 显示或隐藏行
                row.style.display = rowText.includes(filter) ? '' : 'none';
                
                // 高亮匹配的文本
                if (filter && rowText.includes(filter)) {
                    highlightText(row, filter);
                } else {
                    removeHighlights(row);
                }
            }
        });
    }
    
    // 高亮匹配文本
    function highlightText(element, filter) {
        // 先移除之前的高亮
        removeHighlights(element);
        
        // 遍历所有文本节点
        const walker = document.createTreeWalker(element, NodeFilter.SHOW_TEXT, null, false);
        const nodes = [];
        let node;
        
        while (node = walker.nextNode()) {
            if (node.nodeValue.toLowerCase().includes(filter)) {
                nodes.push(node);
            }
        }
        
        // 高亮匹配的文本
        nodes.forEach(node => {
            const span = document.createElement('span');
            span.className = 'highlight';
            span.textContent = node.nodeValue;
            node.parentNode.replaceChild(span, node);
        });
    }
    
    // 移除高亮
    function removeHighlights(element) {
        const highlights = element.querySelectorAll('.highlight');
        highlights.forEach(highlight => {
            const text = document.createTextNode(highlight.textContent);
            highlight.parentNode.replaceChild(text, highlight);
        });
    }
    
    // 页面加载完成后初始化
    document.addEventListener('DOMContentLoaded', function() {
        // 添加搜索输入框的清除功能
        const searchInput = document.getElementById('searchInput');
        searchInput.addEventListener('keyup', filterTables);
        
        // 添加清除按钮
        const clearSearch = document.createElement('span');
        clearSearch.innerHTML = '&times;';
        clearSearch.style.cssText = 'position:absolute; right:10px; top:50%; transform:translateY(-50%); cursor:pointer; color:#999;';
        clearSearch.onclick = function() {
            searchInput.value = '';
            filterTables();
        };
        searchInput.parentNode.style.position = 'relative';
        searchInput.parentNode.appendChild(clearSearch);
    });
</script>
{% endblock %}
