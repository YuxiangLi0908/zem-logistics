{% extends 'base.html' %}

{% block content %}
<style>
    .inventory-container {
        padding: 15px;
        background: #f8f9fa;
        border-radius: 8px;
        margin: 10px 0;
    }
    
    .header-section {
        display: flex;
        align-items: center;
        justify-content: flex-start; /* Êîπ‰∏∫Â∑¶ÂØπÈΩê */
        gap: 20px; /* Ê∑ªÂä†Èó¥Ë∑ù */
        margin-bottom: 15px;
        padding: 10px;
        background: white;
        border-radius: 6px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        flex-wrap: wrap; /* ÂÖÅËÆ∏Êç¢Ë°å */
    }
    
    .title-section {
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 16px;
    }
    
    .warehouse-selector {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .transfer-btn-container {
        margin: 10px 0;
        text-align: right;
    }
    
    .btn-transfer {
        background: #28a745;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 11px;
    }
    
    .btn-transfer:hover {
        background: #218838;
    }

    .table-container {
        max-height: 70vh;
        overflow-y: auto;
        background: white;
        border-radius: 6px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .table {
        width: 100%;
        border-collapse: collapse;
        font-size: 11px;
    }
    
    .th, .td {
        padding: 6px 8px;
        border: 1px solid #dee2e6;
        text-align: left;
    }
    
    .th {
        background: #e9ecef;
        position: sticky;
        top: 0;
        z-index: 10;
    }
    
    .filter-row th {
        background: #f8f9fa;
        padding: 4px;
    }
    
    .filter-input {
        width: 100%;
        padding: 3px;
        font-size: 11px;
        border: 1px solid #ced4da;
        border-radius: 3px;
    }
    
    /* ÂºπÂá∫Á™óÂè£Ê†∑Âºè */
    .transfer-popup {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        border: 1px solid #ccc;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        z-index: 1000;
        min-width: 400px;
    }
    
    .popup-header {
        text-align: center;
        margin-bottom: 15px;
        font-weight: bold;
        color: #333;
    }
    
    .popup-buttons {
        display: flex;
        justify-content: space-between;
        margin-top: 15px;
    }
    
    /* ÈÄâ‰∏≠Ë°åÈ´ò‰∫Æ */
    .selected-row {
        background-color: #e3f2fd !important;
    }
    .transfer-info-table {
        font-size: 14px;        
        width: 100%;
        border-collapse: collapse;
    }

    .transfer-info-table td {
        padding: 10px;         
        vertical-align: middle;
    }

    .transfer-info-table input,
    .transfer-info-table select {
        font-size: 14px;        
        padding: 6px 8px;       
        width: 100%;
        border: 1px solid #ced4da;
        border-radius: 4px;
    }
</style>

<div class="inventory-container">
    <div class="header-section">
        <div class="title-section">
            <b>Â∫ìÂ≠òÁÆ°ÁêÜ</b>
            <form method="post" action="" onsubmit="showLoadingBar()" class="warehouse-selector">
                {% csrf_token %}
                <b style="margin-right: 5px;">‰ªìÂ∫ì:</b>
                <select name="warehouse" style="padding: 5px; border-radius: 4px; border: 1px solid #ced4da;">
                    {% for k, v in warehouse_options.items %}
                    <option value="{{ v }}" {% if k == warehouse %}selected{% endif %}>{{ k }}</option>
                    {% endfor %}
                </select>
                <input type="hidden" name="step" value="warehouse">
                <button type="submit" style="padding: 5px 10px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">
                    Á°ÆËÆ§
                </button>
            </form>
        </div>
    </div>

    {% if pallet %}
    <div class="transfer-btn-container">
        <button type="button" id="transfer-btn" class="btn-transfer" onclick="editTransfer()">
            üì¶ ËΩ¨‰ªìÊìç‰Ωú
        </button>
    </div>

    <div class="table-container">
        <table class="table" id="inventory-summary-table">
            <thead>
                <tr>
                    <th class="th" style="width: 30px; text-align: center;">
                        <input type="checkbox" id="selectAll" onclick="toggleAllSelection()">
                    </th>
                    <th class="th">ÂÆ¢Êà∑</th>
                    <th class="th">ÊüúÂè∑</th>
                    <th class="th">ÁõÆÁöÑÂú∞</th>
                    <th class="th">Ê¥æÈÄÅÊñπÂºè</th>
                    <th class="th" style="min-width: 200px;">ÂîõÂ§¥</th>
                    <th class="th" style="min-width: 200px;">FBA</th>
                    <th class="th" style="min-width: 200px;">REF</th>
                    <th class="th">ÈáçÈáè(lbs)</th>
                    <th class="th">Êï∞Èáè</th>
                    <th class="th">‰ΩìÁßØ(CBM)</th>
                    <th class="th">Âç°ÊùøÊï∞</th>
                    <th class="th" style="min-width: 150px;">Â§áÊ≥®</th>
                    <th class="th">È¢ÑÁ∫¶ÊâπÊ¨°</th>
                    <th class="th">È¢ÑÁ∫¶Âè∑</th>
                </tr>
                <tr class="filter-row">
                    <th class="th"></th>
                    <th class="th"></th>
                    <th class="th"><input type="text" class="filter-input" placeholder="ÊêúÁ¥¢ÊüúÂè∑..." oninput="filterTable(this, 2)"></th>
                    <th class="th"><input type="text" class="filter-input" placeholder="ÁõÆÁöÑÂú∞..." oninput="filterTable(this, 3)"></th>
                    <th class="th"><input type="text" class="filter-input" placeholder="Ê¥æÈÄÅÊñπÂºè..." oninput="filterTable(this, 4)"></th>
                    <th class="th"><input type="text" class="filter-input" placeholder="ÊêúÁ¥¢ÂîõÂ§¥..." oninput="filterTable(this, 5)"></th>
                    <th class="th"><input type="text" class="filter-input" placeholder="ÊêúÁ¥¢FBA..." oninput="filterTable(this, 6)"></th>
                    <th class="th"><input type="text" class="filter-input" placeholder="ÊêúÁ¥¢REF..." oninput="filterTable(this, 7)"></th>
                    <th class="th"></th>
                    <th class="th"></th>
                    <th class="th"></th>
                    <th class="th"></th>
                    <th class="th"></th>
                    <th class="th"></th>
                    <th class="th"></th>
                </tr>
            </thead>
            <tbody id="warehouse-trans">
                {% for p in pallet %}
                <tr id="row-{{ forloop.counter }}">
                    <td class="td" style="text-align: center;">
                        <input type='checkbox' name='is_pallet_selected' onclick="toggleRowSelection(this, {{ forloop.counter }})">
                        <input type="hidden" name="plt_ids" value='{{ p.plt_ids }}'>
                        <input type="hidden" name="orders" value='{{ p.container }}'>
                    </td>
                    <td class="td">{{ p.customer_name }}</td>
                    <td class="td">{{ p.container }}</td>
                    <td class="td">{{ p.destination }}</td>
                    <td class="td">{{ p.delivery_method }}</td>
                    <td class="td" style="word-break: break-all;">{{ p.shipping_mark }}</td>
                    <td class="td" style="word-break: break-all;">{{ p.fba_id|default_if_none:"" }}</td>
                    <td class="td" style="word-break: break-all;">{{ p.ref_id|default_if_none:"" }}</td>
                    <td class="td">{{ p.weight|floatformat:2 }}</td>
                    <td class="td">{{ p.pcs|floatformat:0 }}</td>
                    <td class="td">{{ p.cbm|floatformat:2 }}</td>
                    <td class="td">{{ p.n_pallet|floatformat:0 }}</td>
                    <td class="td" style="word-break: break-all;">{{ p.note|default_if_none:"" }}</td>
                    <td class="td">{{ p.shipment|default_if_none:"" }}</td>
                    <td class="td">{{ p.appointment_id|default_if_none:"" }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}
</div>

<!-- ËΩ¨‰ªìÂºπÂá∫Á™óÂè£ -->
<div class="transfer-popup" id="transferPopup">
    <div class="popup-header">ËΩ¨‰ªì‰ø°ÊÅØ</div>
    <form method="post" action="" id="transferForm">
        {% csrf_token %}
        <input type="hidden" name="step" value="transfer_warehouse">
        <input type="hidden" name="warehouse" value="{{ warehouse }}">
        
        <table class="transfer-info-table" style="width: 100%; margin-bottom: 15px;">
            <tr>
                <td><strong>ÂèëË¥ß‰ªìÂ∫ì:</strong></td>
                <td>
                    <select name="shipping_warehouse" style="width: 100%; padding: 5px; border-radius: 4px; border: 1px solid #ced4da;">
                        {% for k, v in warehouse_options.items %}
                            <option value="{{ v }}" {% if k == warehouse %}selected{% endif %}>{{ k }}</option>
                        {% endfor %}
                    </select>
                </td>
            </tr>
            <tr>
                <td><strong>Êî∂Ë¥ß‰ªìÂ∫ì:</strong></td>
                <td>
                    <select name="receiving_warehouse" style="width: 100%; padding: 5px; border-radius: 4px; border: 1px solid #ced4da;">
                        {% for k, v in warehouse_options.items %}
                            <option value="{{ v }}">{{ k }}</option>
                        {% endfor %}
                    </select>
                </td>
            </tr>
            <tr>
                <td><strong>pickupNumber:</strong></td>
                <td><input type="text" name="pickup_number" placeholder="Ê≤°ÊúâÂèØ‰ª•‰∏çËæìÂÖ•" style="width: 100%; padding: 5px; border-radius: 4px; border: 1px solid #ced4da;"></td>
            </tr>
            <tr>
                <td><strong>carrier:</strong></td>
                <td><input type="text" name="carrier" style="width: 100%; padding: 5px; border-radius: 4px; border: 1px solid #ced4da;"></td>
            </tr>
            <tr>
                <td><strong>Â§áÊ≥®:</strong></td>
                <td><input type="text" name="note" style="width: 100%; padding: 5px; border-radius: 4px; border: 1px solid #ced4da;"></td>
            </tr>
            <tr>
                <td><strong>ÂèëË¥ßÊó∂Èó¥:</strong></td>
                <td><input type="datetime-local" name="shipping_time" style="width: 100%; padding: 5px; border-radius: 4px; border: 1px solid #ced4da;" required></td>
            </tr>
            <tr>
                <td><strong>È¢ÑËÆ°Âà∞Ëææ:</strong></td>
                <td><input type="datetime-local" name="ETA" style="width: 100%; padding: 5px; border-radius: 4px; border: 1px solid #ced4da;" required></td>
            </tr>
        </table>
        
        <div class="popup-buttons">
            <button type="button" class="btn btn-secondary" onclick="closeTransferPopup()" style="padding: 5px 15px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">
                ÂèñÊ∂à
            </button>
            <button type="submit" class="btn btn-primary" style="padding: 5px 15px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">
                Á°ÆËÆ§ËΩ¨‰ªì
            </button>
        </div>
    </form>
</div>

<script>
    // ÊòæÁ§∫/ÈöêËóèËΩ¨‰ªìÂºπÂá∫Á™óÂè£ÔºåÂπ∂ÊääÈÄâ‰∏≠ÁöÑ plt_ids Â°ûÂà∞ form Èáå
    function editTransfer() {
        const popup = document.getElementById('transferPopup');
        const form = document.getElementById('transferForm');

        const checkboxes = document.querySelectorAll('input[name="is_pallet_selected"]:checked');
        if (checkboxes.length === 0) {
            alert('ËØ∑Ëá≥Â∞ëÈÄâÊã©‰∏Ä‰∏™ÊâòÁõòËøõË°åËΩ¨‰ªìÊìç‰Ωú');
            return;
        }

        // ÂÖàÊ∏ÖÈô§ÊóßÁöÑ hidden inputsÔºåÈÅøÂÖçÈáçÂ§ç
        form.querySelectorAll('input[name="plt_ids"]').forEach(el => el.remove());

        // ÈÅçÂéÜÂãæÈÄâÁöÑË°åÔºåÊää plt_ids Âä®ÊÄÅÊ∑ªÂä†Âà∞ form
        checkboxes.forEach(checkbox => {
            const row = checkbox.closest('tr');
            const pltId = row.querySelector('input[name="plt_ids"]').value;

            const hidden = document.createElement('input');
            hidden.type = 'hidden';
            hidden.name = 'plt_ids';
            hidden.value = pltId;
            form.appendChild(hidden);
        });

        popup.style.display = 'block';
    }

    
    function closeTransferPopup() {
        document.getElementById('transferPopup').style.display = 'none';
    }
    
    // ÂÖ®ÈÄâ/ÂèñÊ∂àÂÖ®ÈÄâ
    function toggleAllSelection() {
        const selectAll = document.getElementById('selectAll');
        const checkboxes = document.querySelectorAll('input[name="is_pallet_selected"]');
        
        checkboxes.forEach(checkbox => {
            checkbox.checked = selectAll.checked;
            toggleRowSelection(checkbox, checkbox.closest('tr').id.replace('row-', ''));
        });
    }
    
    // Ë°åÈÄâÊã©È´ò‰∫Æ
    function toggleRowSelection(checkbox, rowId) {
        const row = document.getElementById('row-' + rowId);
        if (checkbox.checked) {
            row.classList.add('selected-row');
        } else {
            row.classList.remove('selected-row');
        }
    }
    
    // Ë°®Ê†ºÁ≠õÈÄâ
    function filterTable(input, columnIndex) {
        const filter = input.value.toLowerCase();
        const rows = document.querySelectorAll('#warehouse-trans tr');
        
        rows.forEach(row => {
            const cell = row.cells[columnIndex];
            if (cell) {
                const text = cell.textContent.toLowerCase();
                row.style.display = text.includes(filter) ? '' : 'none';
            }
        });
    }
    
    // ÁÇπÂáªÂ§ñÈÉ®ÂÖ≥Èó≠ÂºπÂá∫Á™óÂè£
    document.addEventListener('click', function(e) {
        const popup = document.getElementById('transferPopup');
        if (popup.style.display === 'block' && !popup.contains(e.target) && e.target.id !== 'transfer-btn') {
            closeTransferPopup();
        }
    });
</script>
{% endblock %}