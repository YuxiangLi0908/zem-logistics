{% extends 'base.html' %}
{% load static %}
{% load static custom_tags %}
{% load static custom_filters %}
{% load static custom_mod %}
{% load static custom_floor_division %}

{% block content %}
<div><b>报表汇总</b></div>

<form id="warehouse-form" method="post" action="">
    {% csrf_token %}
    <div style="display: flex; flex-wrap: wrap; align-items: center; gap: 8px; margin-bottom: 10px;">
        <label><b>所属仓:</b></label>
        <select name="area" style="width: 120px;">
            {% for k, v in area_options.items %}
            <option value="{{ v }}" {% if k == selected_area %}selected{% endif %}>{{ k }}</option>
            {% endfor %}
        </select>

        <label><b>ETA:</b></label>
        <input type="date" name="start_date" value="{{ start_date }}" style="width: 140px;">
        <input type="date" name="end_date" value="{{ end_date }}" style="width: 140px;">

        <label><b>柜号:</b></label>
        <input type="text" name="container_number" value="{{ container_number }}" style="width: 120px;">

        <label><b>批次号:</b></label>
        <input type="text" name="shipment_batch_number" value="{{ shipment_batch_number }}" style="width: 120px;">

        <label><b>预报的仓点:</b></label>
        <input type="text" name="destination" value="{{ destination }}" style="width: 120px;">

        <label><b>唛头:</b></label>
        <input type="text" name="shipping_marks" value="{{ shipping_marks }}" style="width: 120px;">

        <label><b>FBA:</b></label>
        <input type="text" name="fba_ids" value="{{ fba_ids }}" style="width: 120px;">

        <label><b>REF:</b></label>
        <input type="text" name="ref_ids" value="{{ ref_ids }}" style="width: 120px;">

        <input type="hidden" name="step" value="summary_warehouse">
        <button type="submit" style="padding: 5px 12px;">确认</button>
    </div>
</form>

<style>
    .table-container {
        width: 100%;
        overflow-x: auto;
        position: relative;
        border: 1px solid #ddd;
        border-radius: 5px;
        margin-top: 10px;
        max-height: 70vh;
    }
    
    #packing-list-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 11px;
        table-layout: fixed;
        min-width: 1800px;
    }
    
    #packing-list-table th, 
    #packing-list-table td {
        padding: 4px 6px;
        border: 1px solid #ddd;
        text-align: left;
        vertical-align: top;
        overflow: hidden;
        text-overflow: ellipsis;
        position: relative;
        word-break: break-all;
    }
    
    #packing-list-table td:hover {
        overflow: visible;
        white-space: normal;
        z-index: 100;
        background-color: #fff;
        box-shadow: 0 0 10px rgba(0,0,0,0.1);
        min-width: auto;
        max-width: none;
        width: auto;
    }
    
    #packing-list-table th {
        background-color: #f8f9fa;
        font-weight: bold;
        position: sticky;
        z-index: 10;
    }
    
    #packing-list-table thead tr:first-child th {
        top: 0;
        z-index: 20;
    }
    
    #packing-list-table thead tr:nth-child(2) th {
        top: 30px;
        z-index: 15;
    }
    
    #packing-list-table th:nth-child(1),
    #packing-list-table td:nth-child(1) {
        width: 40px !important;
        min-width: 40px !important;
        max-width: 40px !important;
        text-align: center;
    }
    
    #packing-list-table th:nth-child(2),
    #packing-list-table td:nth-child(2) {
        width: 80px !important;
        min-width: 80px !important;
    }
    
    #packing-list-table th:nth-child(3),
    #packing-list-table td:nth-child(3) {
        width: 100px !important;
        min-width: 100px !important;
    }
    
    #packing-list-table th:nth-child(4),
    #packing-list-table td:nth-child(4) {
        width: 90px !important;
        min-width: 90px !important;
    }
    
    #packing-list-table th:nth-child(5),
    #packing-list-table td:nth-child(5) {
        width: 120px !important;
        min-width: 120px !important;
    }
    
    #packing-list-table th:nth-child(6),
    #packing-list-table td:nth-child(6) {
        width: 100px !important;
        min-width: 100px !important;
    }
    
    #packing-list-table th:nth-child(7),
    #packing-list-table td:nth-child(7) {
        width: 100px !important;
        min-width: 100px !important;
    }
    
    #packing-list-table th:nth-child(8),
    #packing-list-table td:nth-child(8) {
        width: 100px !important;
        min-width: 100px !important;
    }
    
    #packing-list-table th:nth-child(9),
    #packing-list-table td:nth-child(9) {
        width: 100px !important;
        min-width: 100px !important;
    }
    
    #packing-list-table th:nth-child(10),
    #packing-list-table td:nth-child(10) {
        width: 60px !important;
        min-width: 60px !important;
    }
    
    #packing-list-table th:nth-child(11),
    #packing-list-table td:nth-child(11) {
        width: 70px !important;
        min-width: 70px !important;
    }
    
    #packing-list-table th:nth-child(12),
    #packing-list-table td:nth-child(12) {
        width: 60px !important;
        min-width: 60px !important;
    }
    
    #packing-list-table th:nth-child(13),
    #packing-list-table td:nth-child(13) {
        width: 80px !important;
        min-width: 80px !important;
    }
    
    #packing-list-table th:nth-child(14),
    #packing-list-table td:nth-child(14),
    #packing-list-table th:nth-child(15),
    #packing-list-table td:nth-child(15),
    #packing-list-table th:nth-child(16),
    #packing-list-table td:nth-child(16) {
        width: 70px !important;
        min-width: 70px !important;
    }
    
    #packing-list-table th:nth-child(17),
    #packing-list-table td:nth-child(17) {
        width: 90px !important;
        min-width: 90px !important;
    }
    
    #packing-list-table th:nth-child(18),
    #packing-list-table td:nth-child(18) {
        width: 100px !important;
        min-width: 100px !important;
    }
    
    #packing-list-table th:nth-child(19),
    #packing-list-table td:nth-child(19),
    #packing-list-table th:nth-child(20),
    #packing-list-table td:nth-child(20),
    #packing-list-table th:nth-child(21),
    #packing-list-table td:nth-child(21) {
        width: 130px !important;
        min-width: 130px !important;
    }
    
    #packing-list-table th:nth-child(22),
    #packing-list-table td:nth-child(22) {
        width: 90px !important;
        min-width: 90px !important;
    }
    
    .status-span-red, .status-span-yellow, 
    .status-span-green-100, .status-span-blue-100 {
        display: inline-block;
        padding: 1px 4px;
        border-radius: 3px;
        font-size: 10px;
        margin-right: 2px;
    }
    
    .status-span-red { background-color: #ffcccc; color: #d00; }
    .status-span-yellow { background-color: #fff3cd; color: #856404; }
    .status-span-green-100 { background-color: #d4edda; color: #155724; }
    .status-span-blue-100 { background-color: #cce5ff; color: #004085; }
    
    input[type="text"], input[type="number"] {
        width: 100%;
        box-sizing: border-box;
        font-size: 11px;
        padding: 2px 4px;
    }
    
    .summary-row {
        background-color: #f0f8ff;
        font-weight: bold;
    }
    
    .summary-row input[disabled] {
        background-color: #e9ecef;
        font-weight: bold;
    }
    
    .table-container::after {
        content: "→";
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
        font-size: 20px;
        color: #999;
        opacity: 0.7;
        pointer-events: none;
    }
</style>

<form method="post" style="width: 100%;">
    {% if packing_list %}
    {% csrf_token %}
        <div style="margin-bottom: 10px; text-align: right;">
            <input type="hidden" name="step" value="export_report">
            <button type="submit" onclick="confirmSubmit()" class="btn btn-primary" style="width: 100px; height: 35px;">导出报表</button>
        </div>
    
    <div class="table-container">   
        <table id="packing-list-table" class="table" style="width:100%; border-collapse: collapse;">
            <thead>
                <tr>
                    <th style="text-align: center;"></th>
                    <th>仓库</th>
                    <th>客户</th>
                    <th>货柜号</th>
                    <th>仓点</th>
                    <th>派送方式</th>
                    <th>唛头</th>
                    <th>FBA</th>
                    <th>REF</th>
                    <th>CBM</th>
                    <th>卡板数</th>
                    <th>箱数</th>
                    <th>总重lbs</th>
                    <th>ETA</th>
                    <th>提柜时间</th>
                    <th>入仓时间</th>
                    <th>预约批次</th>
                    <th>预约号</th>
                    <th>预约时间</th>
                    <th>出库时间</th>
                    <th>送达时间</th>
                    <th>是否有POD</th>
                </tr>
                <tr id="packing-list-table-filter">                  
                    <th style="text-align: center;">
                        <input type="checkbox" id="selectAllCheckbox" onchange="toggleAllCheckboxes()">
                    </th>
                    <th><input type="text" placeholder="搜索仓库..." oninput="filterTable(this, 1)" size="8"></th>
                    <th><input type="text" placeholder="搜索客户..." oninput="filterTable(this, 2)" size="8"></th>
                    <th><input type="text" placeholder="搜索柜号..." oninput="filterTable(this, 3)" size="8"></th>
                    <th><input type="text" placeholder="搜索仓点..." oninput="filterTable(this, 4)" size="8"></th>
                    <th><input type="text" placeholder="搜索派送..." oninput="filterTable(this, 5)" size="8"></th>
                    <th><input type="text" placeholder="搜索唛头..." oninput="filterTable(this, 6)" size="8"></th>
                    <th><input type="text" placeholder="搜索FBA..." oninput="filterTable(this, 7)" size="8"></th>
                    <th><input type="text" placeholder="搜索REF..." oninput="filterTable(this, 8)" size="8"></th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th><input type="text" placeholder="搜索批次..." oninput="filterTable(this, 17)" size="8"></th>
                    <th><input type="text" placeholder="搜索预约号..." oninput="filterTable(this, 18)" size="8"></th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                {% for c in packing_list %}
                <tr>
                    <td style="text-align: center;">
                        <input type='checkbox' name='is_selected' onclick="toggleRowBackground(this)">
                        <input type="hidden" name="is_selected" value='off'>
                        <input type="hidden" name="pl_ids" value='{{ c.ids }}'>
                        <input type="hidden" name="plt_ids" value='{{ c.plt_ids }}'>
                    </td>
                    <td title="{{ c.container_number__order__warehouse__name }}">{{ c.container_number__order__warehouse__name }}</td>
                    <td title="{{ c.container_number__order__customer_name__zem_name }}">{{ c.container_number__order__customer_name__zem_name }}</td>
                    <td title="{{ c.container_number__container_number }}">{{ c.container_number__container_number }}</td>
                    <td name="po-destination" title="{{ c.destination }}">
                        {{ c.destination }}
                        {% if c.abnormal_palletization %}
                            <span class="status-span-red">未解决拆柜异常</span>
                        {% endif %}
                        {% if c.po_expired %}
                            <span class="status-span-yellow">PO失效</span>
                        {% endif %}
                    </td>
                    <td title="{% with first_value=c.custom_delivery_method|default:""|split_and_get_first %}{% if first_value == '客户自提' %}{{ first_value }} - {{ c.shipping_marks }}{% else %}{{ first_value }}{% endif %}{% endwith %}">
                        {% with first_value=c.custom_delivery_method|default:""|split_and_get_first %}
                            {% if first_value == '客户自提' %}
                            {{ first_value }} - {{ c.shipping_marks }}
                            {% else %}
                            {{ first_value }}
                            {% endif %}
                        {% endwith %}
                    </td>
                    <td title="{{ c.shipping_marks }}">{{ c.shipping_marks }}</td>
                    <td title="{{ c.fba_ids }}">{{ c.fba_ids }}</td>
                    <td title="{{ c.ref_ids }}">{{ c.ref_ids }}</td>
                    <td>{{ c.total_cbm|floatformat:2 }}</td>
                    <td>
                        {% if c.label == "ACT" %}
                            <span class="status-span-green-100">ACT</span>
                            {{ c.total_n_pallet_act }}
                        {% else %}
                            <span class="status-span-blue-100">EST</span>
                            {% if c.total_n_pallet_est < 1 %}
                                {{ 1 }}
                            {% elif c.total_n_pallet_est|modulo:1 >= 0.45 %}
                                {{ c.total_n_pallet_est|floor_division:1|add:1|floatformat:0 }}
                            {% else %}
                                {{ c.total_n_pallet_est|floor_division:1|floatformat:0 }}
                            {% endif %}
                        {% endif %}
                    </td>
                    <td>{{ c.total_pcs }}</td>
                    <td>{{ c.total_weight_lbs|floatformat:2 }}</td>
                    <td>{{ c.container_number__order__vessel_id__vessel_eta|date:"M-j" }}</td>
                    <td>
                        {% if c.container_number__order__retrieval_id__actual_retrieval_timestamp %}
                        {{ c.container_number__order__retrieval_id__actual_retrieval_timestamp|date:"M-j" }}
                        {% elif c.container_number__order__retrieval_id__target_retrieval_timestamp %}
                        <span class="status-span-blue-100">EST</span>
                        {{ c.container_number__order__retrieval_id__target_retrieval_timestamp|date:"M-j" }}
                        {% endif %}
                    </td>
                    <td>{{ c.container_number__order__offload_id__offload_at|date:"M-j" }}</td>
                    <td title="{{ c.shipment_batch_number__shipment_batch_number|default_if_none:'' }}">
                        <a href="javascript:void(0)" onclick="exportShipmentBol('{{ c.shipment_batch_number__shipment_batch_number }}')">
                            {{ c.shipment_batch_number__shipment_batch_number|default_if_none:"" }}
                        </a>
                    </td>
                    <td title="{{ c.shipment_batch_number__appointment_id|default_if_none:'' }}">{{ c.shipment_batch_number__appointment_id|default_if_none:"" }}</td>
                    <td>
                        {{ c.shipment_batch_number__shipment_appointment|date:"Y-m-d" }} {{ c.shipment_batch_number__shipment_appointment|time:"H:i" }}
                    </td>
                    <td>
                        {{ c.shipment_batch_number__shipped_at|date:"Y-m-d" }} {{ c.shipment_batch_number__shipped_at|time:"H:i" }}
                    </td>
                    <td>
                        {{ c.shipment_batch_number__arrived_at|date:"Y-m-d" }} {{ c.shipment_batch_number__arrived_at|time:"H:i" }}
                    </td>
                    <td>
                        {% if c.shipment_batch_number__pod_link %}
                        YES 
                        {% else %}
                        FALSE 
                        {% endif %}
                    </td>
                </tr>               
                {% endfor %}
                <tr class="summary-row">
                    <td colspan="9" style="text-align: right;">总计:</td>
                    <td><input type="number" id="cbm-total" disabled></td>
                    <td><input type="number" id="pallet-total" disabled></td>
                    <td><input type="number" id="pcs-total" disabled></td>
                    <td><input type="number" id="weight-total" disabled></td>
                    <td colspan="9"></td>       
                </tr>
            </tbody>
        </table>
    </div>
    {% endif %}
</form>

<script>
    window.onload = function () {
        updateTotals();   
    };
    
    function updateTotals(){
        let cbmTotal = 0;
        let palletTotal = 0;
        let pcsTotal = 0;
        let weightTotal = 0;
        const table = document.getElementById('packing-list-table');
        const rows = table.getElementsByTagName('tr');
        
        for (let i = 2; i < rows.length-1; i++) {
            const row = rows[i];
            if (row.style.display!== 'none') {
                const cells = row.getElementsByTagName('td');

                const cbmValue = parseFloat(cells[9].innerText);
                const palletText = cells[10].innerText;
                const palletValue = parseFloat(palletText.replace("ACT", "").replace("EST", "").trim());
                const pcsValue = parseFloat(cells[11].innerText);
                const weightValue = parseFloat(cells[12].innerText);
                
                if (!isNaN(cbmValue)) {
                    cbmTotal += cbmValue;
                }
                if (!isNaN(palletValue)) {
                    palletTotal += palletValue;
                }
                if (!isNaN(pcsValue)) {
                    pcsTotal += pcsValue;
                }
                if (!isNaN(weightValue)) {
                    weightTotal += weightValue;
                }
            }
        }
        
        document.getElementById('cbm-total').value = cbmTotal.toFixed(2);
        document.getElementById('pallet-total').value = palletTotal.toFixed(2);
        document.getElementById('pcs-total').value = pcsTotal.toFixed(2);
        document.getElementById('weight-total').value = weightTotal.toFixed(2);
    };
    
    function confirmSubmit() {
        const checkBoxes = document.getElementsByName('is_selected');
        for (let i = 0; i < checkBoxes.length; i+=2) {
            if (checkBoxes[i].checked) {
                checkBoxes[i+1].disabled = true;
            }
        }
    };
    
    function toggleAllCheckboxes() {
        var selectAllCheckbox = document.getElementById('selectAllCheckbox');
        var checkboxes = document.querySelectorAll('tbody input[type="checkbox"][name="is_selected"]');
        
        checkboxes.forEach(function(checkbox) {
            var tr = checkbox.closest('tr');
            if (tr.style.display !== 'none') {
                checkbox.checked = selectAllCheckbox.checked;
                if (checkbox.checked) {
                    tr.style.backgroundColor = '#ADD8E6';
                } else {
                    tr.style.backgroundColor = '';
                }
            }
        });
    };

    function toggleRowBackground(checkbox) {
        var row = checkbox.closest('tr');
        if (checkbox.checked) {
            row.style.backgroundColor = '#ADD8E6'; 
        } else {
            row.style.backgroundColor = ''; 
        }
    };

    function filterTable(filterInput, colIdx) {
        var table = filterInput.closest('table');
        var tbody = table.getElementsByTagName("tbody")[0];
        var tr = tbody.getElementsByTagName("tr");

        var filters = document.querySelectorAll('thead input[type="text"]');
        var filterValues = Array.from(filters).map(function(filter) {
            return filter.value.toUpperCase().trim();
        });  
        
        const filterRow = document.getElementById("packing-list-table-filter");
        const filterIndices = [];
        for (let i = 0; i < filterRow.children.length; i++) {
            const inputElement = filterRow.children[i].querySelector("input:not(#selectAllCheckbox)");
            if (inputElement) {
                filterIndices.push(i);
            }
        };
        
        for (var i = 0; i < tr.length-1; i++) {
            var row = tr[i];
            var showRow = true;
            
            for (var j = 0; j < filterIndices.length; j++) {
                var filterValue = filterValues[j];
                if (!filterValue) continue;
                
                var cell = row.getElementsByTagName("td")[filterIndices[j]];
                if (cell) {
                    var cellText = cell.textContent || cell.innerText;
                    var cellValue = cellText.toUpperCase();
                    
                    if (cellValue.indexOf(filterValue) === -1) {
                        showRow = false;
                        break;
                    }
                }
            }
            
            row.style.display = showRow ? "" : "none";
        };
        
        updateTotals();
    };
    function exportShipmentBol(batchId) {
        const form = document.querySelector("form"); 
        form.querySelector("input[name='step']").value = "export_bol";
        
        let hidden = document.createElement("input");
        hidden.type = "hidden";
        hidden.name = "shipment_batch_numbers";
        hidden.value = batchId;
        console.log('batchId',batchId);
        form.appendChild(hidden);

        form.submit();
    }
</script>
{% endblock %}