{% extends 'base.html' %}
{% load custom_filters %}
{% block content %}

<div style="max-height: 100%; max-width: 100%;">
    <div><b>拆柜入库</b></div>
</div>

<form method="post" action="" onsubmit="showLoadingBar()">
    {% csrf_token %}
    <div>
        <b style="margin-right: 5px;">选择仓库:</b>
        <input type="hidden" name="step" value="warehouse">
        {{ warehouse_form.name }}
        <button type="submit">确认</button>
    </div>
</form>

<div id="loading-bar">
    <div class="spinner"></div>
    <p>Loading, please wait...</p>
</div>

<div style="display: flex; max-height: 800px">
    <div style="max-height: 100%; width: 50%; border: 2px solid rgb(180, 180, 180); border-radius: 12px; padding: 1%; margin-top: 1%;">
        <div>
            <b style="background-color: rgb(208, 208, 208); border-radius: 20px; font-size: 11px; display:inline-flex; color: rgb(100, 100, 100); padding: 5px;">
                待拆柜 - {{ order_not_palletized|length }}
            </b>
        </div>
        <div style="overflow-y: scroll; max-height: 90%;">
            <table id="container-table" class="table" style="font-size: 11px; max-height: 90%;">
                <thead>
                    <tr>
                        <th class="th">货柜</th>
                        <th class="th">客户</th>
                        <th class="th">柜型</th>
                        <th class="th">到仓时间</th>
                        <th class="th">预约情况</th>
                        <th class="th">导出</th>
                    </tr>
                    <tr style="position: sticky; top: 28px;">
                        <th class="th"><input type="text" id="containerSearchInput" placeholder="搜索柜号..." oninput="filterTable()" size="13" style="font-size: 11px;"></th>
                        <th class="th"><input type="text" id="customerSearchInput" placeholder="搜索客户..." oninput="filterTable()" size="13" style="font-size: 11px;"></th>
                        <th class="th"></th>
                        <th class="th"></th>
                        <th class="th"></th>
                        <th class="th"></th>
                    </tr>
                </thead>
                <tbody>
                    {% for c in order_not_palletized %}
                    <form method="post" action="">
                        {% csrf_token %}
                        {% if c.batch_number %}
                        <tr>
                            <td class="td" style="width:100px;">
                                {{ c.container_number }}
                            </td>
                            <td class="td">{{ c.batch_number }}</td>
                            <td class="td">{{ c.total_pallet }}板</td>
                            <td class="td">
                                <span class="status-span-red">{{ c.ETA|date:"M-j" }}</span>
                            </td>
                            <td class="td">
                                
                            </td>
                            <td class="td">
                                <form method="post">
                                    {% csrf_token %}
                                    <input type="hidden" name="step" value="trans_arrival">
                                    <input type="hidden" name="batch_id" value="{{ c.id }}">
                                    <input type="hidden" name="warehouse" value="{{ warehouse }}">
                                    <button type="submit" class="btn btn-success" style="font-size: 13px;">
                                        <small>确认送达</small>
                                    </button>
                                </form>
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td class="td">
                                <a href="/palletize/{{c.id}}/?step=container_palletization&warehouse={{ warehouse }}">{{ c.container_number }}</a>
                            </td>
                            <td class="td">{{ c.customer_name }}</td>
                            <td class="td">{{ c.container_number.container_type }}</td>
                            <td class="td">
                                {% if c.retrieval_id.offload_status == "past_due" %}
                                <span class="status-span-red">{{ c.retrieval_id.arrive_at|date:"M-j" }}</span>
                                {% elif c.retrieval_id.offload_status == "need_attention" %}
                                <span class="status-span-yellow">{{ c.retrieval_id.arrive_at|date:"M-j" }}</span>
                                {% else %}
                                {{ c.retrieval_id.arrive_at|date:"M-j" }}
                                {% endif %}
                            </td>
                            <td class="td">
                                {% if c.container_number.container_number in order_with_shipment %}
                                <span class="status-span-red">
                                    {{ order_with_shipment|get:c.container_number.container_number|date:"M-j" }}
                                </span>
                                {% endif %}
                            </td>
                            <td class="td">
                                <div>
                                    <form method="post" action="" style="display: inline-block;">
                                        {% csrf_token %}
                                        <input type="hidden" name="step" value="export_pallet_label">
                                        <input type="hidden" name="status" value="non_palletized">
                                        <input type="hidden" name="customer_name" value="{{ c.customer_name.zem_code }}">
                                        <input type="hidden" name="container_number" value="{{ c.container_number }}">
                                        <input type="hidden" name="n_label" value="3">
                                        <button type="submit" class="btn btn-success" style="font-size: 13px;">
                                            <small>托盘标(3张)</small>
                                            <i class="bi bi-cloud-arrow-down-fill"></i>
                                        </button>
                                    </form>
                                    <form method="post" action="" style="display: inline-block;">
                                        {% csrf_token %}
                                        <input type="hidden" name="step" value="export_pallet_label">
                                        <input type="hidden" name="status" value="non_palletized">
                                        <input type="hidden" name="customer_name" value="{{ c.customer_name.zem_code }}">
                                        <input type="hidden" name="container_number" value="{{ c.container_number }}">
                                        <input type="hidden" name="n_label" value="4">
                                        <button type="submit" class="btn btn-success" style="font-size: 13px;">
                                            <small>托盘标(4张)</small>
                                            <i class="bi bi-cloud-arrow-down-fill"></i>
                                        </button>
                                    </form>
                                </div>
                                <form method="post" action="" style="display: inline-block;">
                                    {% csrf_token %}
                                    <input type="hidden" name="step" value="export_palletization_list">
                                    <input type="hidden" name="status" value="non_palletized">
                                    <input type="hidden" name="container_number" value="{{ c.container_number }}">
                                    <button type="submit" class="btn btn-success" style="font-size: 13px;">
                                        <small>拆柜单</small>
                                        <i class="bi bi-cloud-arrow-down-fill"></i>
                                    </button>
                                </form>
                                <form method="post" action="" style="display: inline-block;">
                                    {% csrf_token %}
                                    <input type="hidden" name="step" value="new_export_palletization_list">
                                    <input type="hidden" name="status" value="non_palletized">
                                    <input type="hidden" name="warehouse" value="{{ warehouse }}">
                                    <input type="hidden" name="first_time_download" value="{% now 'Y-m-d H:i:s' %}">
                                    <input type="hidden" name="container_number" value="{{ c.container_number }}">
                                    <button type="submit" class="btn btn-success" style="font-size: 13px;">
                                        <small>(新)拆柜单</small>
                                        <i class="bi bi-cloud-arrow-down-fill"></i>
                                    </button>
                                </form>
                                <form method="post" action="" style="display: inline-block;" id="semi_auto_label">
                                    {% csrf_token %}
                                    <input type="hidden" name="step" value="export_pallet_label">
                                    <button id="editButton" type="button" class="btn btn-primary" onclick="print_label(this, '{{ c.container_number }}', '{{ c.customer_name.zem_code }}')" style="font-size: 11px;">托盘标手动打印</button>
                                    <div class="popup" style="display: none; z-index: 9999; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: white; border: 2px solid #4a90e2; border-radius: 12px; padding: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); width: 90%; max-width: 1200px; max-height: 85vh; overflow: hidden;">
                                        <!-- 标题栏和关闭按钮 -->
                                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #f0f0f0;">
                                            <h4 style="margin: 0; color: #2c3e50; font-weight: bold;">
                                                <i class="fas fa-print"></i> 托盘标手动打印编辑
                                            </h4>
                                            <button type="button" class="btn-close" onclick="closePopup()" style="background: none; border: none; font-size: 24px; color: #888; cursor: pointer; padding: 0; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center;">
                                                &times;
                                            </button>
                                        </div>
                                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                            <div>
                                                <button type="button" id="add-more-btn" class="btn btn-success" style="height: 35px; font-size: 12px; margin-right: 10px;" onclick="addRowBelow()">
                                                    <i class="bi bi-plus-lg"></i> 添加行
                                                </button>
                                                <button type="button" class="btn btn-warning" style="height: 35px; font-size: 12px;" onclick="editTable(true)">
                                                    <i class="bi bi-pencil"></i> 编辑模式
                                                </button>
                                            </div>
                                            <div>
                                                <button type="button" class="btn btn-secondary" style="height: 35px; font-size: 12px; margin-right: 10px;" onclick="clearAllRows()">
                                                    <i class="bi bi-trash"></i> 清空
                                                </button>
                                                <button id="confirmButton" type="button" class="btn btn-primary" style="height: 35px; font-size: 12px;" onclick="editTable(false)">
                                                    <i class="bi bi-check-lg"></i> 确认打印
                                                </button>
                                            </div>
                                        </div>
                                        
                                        <!-- 表格容器 -->
                                        <div style="max-height: 60vh; overflow-y: auto; border: 1px solid #e0e0e0; border-radius: 8px; padding: 10px;">
                                            <table style="width: 100%; border-collapse: collapse; font-size: 12px;" id="edit_pallet_label">
                                                <thead style="position: sticky; top: 0; background: #f8f9fa; z-index: 10;">                       
                                                    <th style="text-align: center; border: 1px solid #dee2e6; padding: 12px 8px; background: #4a90e2; color: white; font-weight: bold; min-width: 100px;">柜号</th>
                                                    <th style="text-align: center; border: 1px solid #dee2e6; padding: 12px 8px; background: #4a90e2; color: white; font-weight: bold; min-width: 100px;">客户</th>
                                                    <th style="text-align: center; border: 1px solid #dee2e6; padding: 12px 8px; background: #4a90e2; color: white; font-weight: bold; min-width: 120px;">唛头</th>
                                                    <th style="text-align: center; border: 1px solid #dee2e6; padding: 12px 8px; background: #4a90e2; color: white; font-weight: bold; min-width: 120px;">FBA</th>
                                                    <th style="text-align: center; border: 1px solid #dee2e6; padding: 12px 8px; background: #4a90e2; color: white; font-weight: bold; min-width: 120px;">目的地</th>
                                                    <th style="text-align: center; border: 1px solid #dee2e6; padding: 12px 8px; background: #4a90e2; color: white; font-weight: bold; min-width: 130px;">派送方式</th>                                                
                                                    <th style="text-align: center; border: 1px solid #dee2e6; padding: 12px 8px; background: #4a90e2; color: white; font-weight: bold; min-width: 80px;">板号</th>
                                                    <th style="text-align: center; border: 1px solid #dee2e6; padding: 12px 8px; background: #4a90e2; color: white; font-weight: bold; min-width: 140px;">日期</th>
                                                    <th style="text-align: center; border: 1px solid #dee2e6; padding: 12px 8px; background: #4a90e2; color: white; font-weight: bold; min-width: 100px;">是否扣货</th>
                                                    <th style="text-align: center; border: 1px solid #dee2e6; padding: 12px 8px; background: #4a90e2; color: white; font-weight: bold; min-width: 80px;">操作</th>   
                                                </thead>
                                                <tbody>
                                                    <tr id="lable-row">
                                                        <td style="text-align: center; border: 1px solid #dee2e6; padding: 10px; background: #f8f9fa;">
                                                            <input type="text" style="width: 100%; border: 1px solid #ced4da; border-radius: 4px; padding: 6px; font-size: 12px; box-sizing: border-box;" placeholder="输入柜号">
                                                        </td>
                                                        <td style="text-align: center; border: 1px solid #dee2e6; padding: 10px; background: #f8f9fa;">
                                                            <input type="text" style="width: 100%; border: 1px solid #ced4da; border-radius: 4px; padding: 6px; font-size: 12px; box-sizing: border-box;" placeholder="输入客户">
                                                        </td>
                                                        <td style="text-align: center; border: 1px solid #dee2e6; padding: 10px; background: #f8f9fa;">
                                                            <input type="text" style="width: 100%; border: 1px solid #ced4da; border-radius: 4px; padding: 6px; font-size: 12px; box-sizing: border-box;" placeholder="输入唛头">
                                                        </td>
                                                        <td style="text-align: center; border: 1px solid #dee2e6; padding: 10px; background: #f8f9fa;">
                                                            <input type="text" style="width: 100%; border: 1px solid #ced4da; border-radius: 4px; padding: 6px; font-size: 12px; box-sizing: border-box;" placeholder="输入FBA">
                                                        </td>
                                                        <td style="text-align: center; border: 1px solid #dee2e6; padding: 10px; background: #f8f9fa;">
                                                            <input type="text" style="width: 100%; border: 1px solid #ced4da; border-radius: 4px; padding: 6px; font-size: 12px; box-sizing: border-box;" placeholder="输入目的地">
                                                        </td>
                                                        <td style="text-align: center; border: 1px solid #dee2e6; padding: 10px; background: #f8f9fa;">
                                                            <select style="width: 100%; border: 1px solid #ced4da; border-radius: 4px; padding: 6px; font-size: 12px; box-sizing: border-box;">
                                                                <option value="卡车派送">卡车派送</option>
                                                                <option value="客户自提">客户自提</option>
                                                                <option value="暂扣留仓">暂扣留仓</option>
                                                            </select>
                                                        </td>         
                                                        <td style="text-align: center; border: 1px solid #dee2e6; padding: 10px; background: #f8f9fa;">
                                                            <input type="text" style="width: 100%; border: 1px solid #ced4da; border-radius: 4px; padding: 6px; font-size: 12px; box-sizing: border-box;" placeholder="板号">
                                                        </td>
                                                        <td style="text-align: center; border: 1px solid #dee2e6; padding: 10px; background: #f8f9fa;">
                                                            <input type="date" style="width: 100%; border: 1px solid #ced4da; border-radius: 4px; padding: 6px; font-size: 12px; box-sizing: border-box;">
                                                        </td>
                                                        <td style="text-align: center; border: 1px solid #dee2e6; padding: 10px; background: #f8f9fa;">
                                                            <select style="width: 100%; border: 1px solid #ced4da; border-radius: 4px; padding: 6px; font-size: 12px; box-sizing: border-box;">
                                                                <option value="否">否</option>
                                                                <option value="是">是</option>
                                                            </select>
                                                        </td>
                                                        <td style="text-align: center; border: 1px solid #dee2e6; padding: 10px; background: #f8f9fa;">
                                                            <button type="button" class="btn btn-danger btn-sm" onclick="removeRow(this)" style="font-size: 10px; padding: 4px 8px;">
                                                                <i class="bi bi-trash"></i>
                                                            </button>
                                                        </td>                                      
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                        
                                        <!-- 底部提示 -->
                                        <div style="margin-top: 15px; padding: 10px; background: #e7f3ff; border-radius: 6px; border-left: 4px solid #4a90e2;">
                                            <small style="color: #2c3e50;">
                                                <i class="bi bi-info-circle"></i> 提示：点击"编辑模式"可修改所有字段，添加多行数据后确认打印
                                            </small>
                                        </div>
                                    </div>
                                    {% comment %} <script src="script.js"></script> {% endcomment %}
                                </form> 
                            </td>
                        </tr>
                        {% endif %}
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    <div style="max-height: 100%; width: 50%; border: 2px solid rgb(180, 180, 180); border-radius: 12px; padding: 1%; margin-top: 1%; margin-left: .5%;">
        <div>
            <b style="background-color: rgb(208, 208, 208); border-radius: 20px; font-size: 11px; display:inline-flex; color: rgb(100, 100, 100); padding: 5px;">
                拆柜完成 - {{ order_palletized|length }}
            </b>
        </div>
        <div style="overflow-y: scroll; max-height: 90%;">
            <table class="table" id="_container-table" style="font-size: 11px; max-height: 90%;">
                <thead>
                    <tr>
                        <th class="th">货柜</th>
                        <th class="th">客户</th>
                        <th class="th">柜型</th>
                        <th class="th">拆柜时间</th>
                        <th class="th">打板数</th>
                        <th class="th">导出</th>
                        <th class="th">撤销拆柜</th>
                    </tr>
                    <tr style="position: sticky; top: 28px;">
                        <th class="th"><input type="text" id="_containerSearchInput" placeholder="搜索柜号..." oninput="filterTable2()" size="13" style="font-size: 11px;"></th>
                        <th class="th"><input type="text" id="_customerSearchInput" placeholder="搜索客户..." oninput="filterTable2()" size="13" style="font-size: 11px;"></th>
                        <th class="th"></th>
                        <th class="th"></th>
                        <th class="th"></th>
                        <th class="th"></th>
                        <th class="th"></th>
                    </tr>
                </thead>
                <tbody>
                    {% for c in order_palletized %}
                        <tr>
                            <td class="td">
                                <a href="/palletize/{{c.id}}/?step=container_palletization&warehouse={{ warehouse }}">{{ c.container_number }}</a>
                            </td>
                            <td class="td">{{ c.customer_name }}</td>
                            <td class="td">{{ c.container_number.container_type }}</td>
                            <td class="td">{{ c.offload_id.offload_at|date:"M-j" }}</td>
                            <td class="td">{{ c.offload_id.total_pallet }}</td>
                            <td class="td">
                                <form method="post" action="" style="display: inline-block;">
                                    {% csrf_token %}
                                    <input type="hidden" name="step" value="export_palletization_list">
                                    <input type="hidden" name="status" value="palletized">
                                    <input type="hidden" name="container_number" value="{{ c.container_number }}">
                                    <button type="submit" class="btn btn-success" style="font-size: 13px;">
                                        <small>拆柜单</small>
                                        <i class="bi bi-cloud-arrow-down-fill"></i>
                                    </button>
                                </form>
                                <form method="post" action="" style="display: inline-block;">
                                    {% csrf_token %}
                                    <input type="hidden" name="step" value="export_pallet_label">
                                    <input type="hidden" name="status" value="palletized">
                                    <input type="hidden" name="customer_name" value="{{ c.customer_name.zem_code }}">
                                    <input type="hidden" name="container_number" value="{{ c.container_number }}">
                                    <button type="submit" class="btn btn-success" style="font-size: 13px;">
                                        <small>托盘标</small>
                                        <i class="bi bi-cloud-arrow-down-fill"></i>
                                    </button>
                                </form>
                                 <form method="post" action="" style="display: inline-block;" id="semi_auto_label">
                                    {% csrf_token %}
                                    <input type="hidden" name="step" value="export_pallet_label">
                                    <button id="editButton" type="button" class="btn btn-primary" onclick="print_label(this, '{{ c.container_number }}', '{{ c.customer_name.zem_code }}')" style="font-size: 11px;">托盘标手动打印</button>
                                    <div class="popup" style="display: none; z-index: 9999; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: white; border: 2px solid #4a90e2; border-radius: 12px; padding: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); width: 90%; max-width: 1200px; max-height: 85vh; overflow: hidden;">
                                        <!-- 标题栏和关闭按钮 -->
                                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #f0f0f0;">
                                            <h4 style="margin: 0; color: #2c3e50; font-weight: bold;">
                                                <i class="fas fa-print"></i> 托盘标手动打印编辑
                                            </h4>
                                            <button type="button" class="btn-close" onclick="closePopup()" style="background: none; border: none; font-size: 24px; color: #888; cursor: pointer; padding: 0; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center;">
                                                &times;
                                            </button>
                                        </div>
                                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                            <div>
                                                <button type="button" id="add-more-btn" class="btn btn-success" style="height: 35px; font-size: 12px; margin-right: 10px;" onclick="addRowBelow()">
                                                    <i class="bi bi-plus-lg"></i> 添加行
                                                </button>
                                                <button type="button" class="btn btn-warning" style="height: 35px; font-size: 12px;" onclick="editTable(true)">
                                                    <i class="bi bi-pencil"></i> 编辑模式
                                                </button>
                                            </div>
                                            <div>
                                                <button type="button" class="btn btn-secondary" style="height: 35px; font-size: 12px; margin-right: 10px;" onclick="clearAllRows()">
                                                    <i class="bi bi-trash"></i> 清空
                                                </button>
                                                <button id="confirmButton" type="button" class="btn btn-primary" style="height: 35px; font-size: 12px;" onclick="editTable(false)">
                                                    <i class="bi bi-check-lg"></i> 确认打印
                                                </button>
                                            </div>
                                        </div>
                                        
                                        <!-- 表格容器 -->
                                        <div style="max-height: 60vh; overflow-y: auto; border: 1px solid #e0e0e0; border-radius: 8px; padding: 10px;">
                                            <table style="width: 100%; border-collapse: collapse; font-size: 12px;" id="edit_pallet_label">
                                                <thead style="position: sticky; top: 0; background: #f8f9fa; z-index: 10;">                       
                                                    <th style="text-align: center; border: 1px solid #dee2e6; padding: 12px 8px; background: #4a90e2; color: white; font-weight: bold; min-width: 100px;">柜号</th>
                                                    <th style="text-align: center; border: 1px solid #dee2e6; padding: 12px 8px; background: #4a90e2; color: white; font-weight: bold; min-width: 100px;">客户</th>
                                                    <th style="text-align: center; border: 1px solid #dee2e6; padding: 12px 8px; background: #4a90e2; color: white; font-weight: bold; min-width: 120px;">唛头</th>
                                                    <th style="text-align: center; border: 1px solid #dee2e6; padding: 12px 8px; background: #4a90e2; color: white; font-weight: bold; min-width: 120px;">FBA</th>
                                                    <th style="text-align: center; border: 1px solid #dee2e6; padding: 12px 8px; background: #4a90e2; color: white; font-weight: bold; min-width: 120px;">目的地</th>
                                                    <th style="text-align: center; border: 1px solid #dee2e6; padding: 12px 8px; background: #4a90e2; color: white; font-weight: bold; min-width: 130px;">派送方式</th>                                                
                                                    <th style="text-align: center; border: 1px solid #dee2e6; padding: 12px 8px; background: #4a90e2; color: white; font-weight: bold; min-width: 80px;">板号</th>
                                                    <th style="text-align: center; border: 1px solid #dee2e6; padding: 12px 8px; background: #4a90e2; color: white; font-weight: bold; min-width: 140px;">日期</th>
                                                    <th style="text-align: center; border: 1px solid #dee2e6; padding: 12px 8px; background: #4a90e2; color: white; font-weight: bold; min-width: 100px;">是否扣货</th>
                                                    <th style="text-align: center; border: 1px solid #dee2e6; padding: 12px 8px; background: #4a90e2; color: white; font-weight: bold; min-width: 80px;">操作</th>   
                                                </thead>
                                                <tbody>
                                                    <tr id="lable-row">
                                                        <td style="text-align: center; border: 1px solid #dee2e6; padding: 10px; background: #f8f9fa;">
                                                            <input type="text" style="width: 100%; border: 1px solid #ced4da; border-radius: 4px; padding: 6px; font-size: 12px; box-sizing: border-box;" placeholder="输入柜号">
                                                        </td>
                                                        <td style="text-align: center; border: 1px solid #dee2e6; padding: 10px; background: #f8f9fa;">
                                                            <input type="text" style="width: 100%; border: 1px solid #ced4da; border-radius: 4px; padding: 6px; font-size: 12px; box-sizing: border-box;" placeholder="输入客户">
                                                        </td>
                                                        <td style="text-align: center; border: 1px solid #dee2e6; padding: 10px; background: #f8f9fa;">
                                                            <input type="text" style="width: 100%; border: 1px solid #ced4da; border-radius: 4px; padding: 6px; font-size: 12px; box-sizing: border-box;" placeholder="输入唛头">
                                                        </td>
                                                        <td style="text-align: center; border: 1px solid #dee2e6; padding: 10px; background: #f8f9fa;">
                                                            <input type="text" style="width: 100%; border: 1px solid #ced4da; border-radius: 4px; padding: 6px; font-size: 12px; box-sizing: border-box;" placeholder="输入FBA">
                                                        </td>
                                                        <td style="text-align: center; border: 1px solid #dee2e6; padding: 10px; background: #f8f9fa;">
                                                            <input type="text" style="width: 100%; border: 1px solid #ced4da; border-radius: 4px; padding: 6px; font-size: 12px; box-sizing: border-box;" placeholder="输入目的地">
                                                        </td>
                                                        <td style="text-align: center; border: 1px solid #dee2e6; padding: 10px; background: #f8f9fa;">
                                                            <select style="width: 100%; border: 1px solid #ced4da; border-radius: 4px; padding: 6px; font-size: 12px; box-sizing: border-box;">
                                                                <option value="卡车派送">卡车派送</option>
                                                                <option value="客户自提">客户自提</option>
                                                                <option value="暂扣留仓">暂扣留仓</option>
                                                            </select>
                                                        </td>         
                                                        <td style="text-align: center; border: 1px solid #dee2e6; padding: 10px; background: #f8f9fa;">
                                                            <input type="text" style="width: 100%; border: 1px solid #ced4da; border-radius: 4px; padding: 6px; font-size: 12px; box-sizing: border-box;" placeholder="板号">
                                                        </td>
                                                        <td style="text-align: center; border: 1px solid #dee2e6; padding: 10px; background: #f8f9fa;">
                                                            <input type="date" style="width: 100%; border: 1px solid #ced4da; border-radius: 4px; padding: 6px; font-size: 12px; box-sizing: border-box;">
                                                        </td>
                                                        <td style="text-align: center; border: 1px solid #dee2e6; padding: 10px; background: #f8f9fa;">
                                                            <select style="width: 100%; border: 1px solid #ced4da; border-radius: 4px; padding: 6px; font-size: 12px; box-sizing: border-box;">
                                                                <option value="否">否</option>
                                                                <option value="是">是</option>
                                                            </select>
                                                        </td>
                                                        <td style="text-align: center; border: 1px solid #dee2e6; padding: 10px; background: #f8f9fa;">
                                                            <button type="button" class="btn btn-danger btn-sm" onclick="removeRow(this)" style="font-size: 10px; padding: 4px 8px;">
                                                                <i class="bi bi-trash"></i>
                                                            </button>
                                                        </td>                                      
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                        
                                        <!-- 底部提示 -->
                                        <div style="margin-top: 15px; padding: 10px; background: #e7f3ff; border-radius: 6px; border-left: 4px solid #4a90e2;">
                                            <small style="color: #2c3e50;">
                                                <i class="bi bi-info-circle"></i> 提示：点击"编辑模式"可修改所有字段，添加多行数据后确认打印
                                            </small>
                                        </div>
                                    </div>
                                    {% comment %} <script src="script.js"></script> {% endcomment %}
                                </form> 
                            </td>
                            <td class="td">
                                <form method="post" action="">
                                    {% csrf_token %}
                                    <input type="hidden" name="step" value="cancel">
                                    <input type="hidden" name="container_number" value="{{ c.container_number }}">
                                    <button type="submit" class="btn btn-danger" style="font-size: 13px;">
                                        <i class="bi bi-x-octagon"></i>
                                    </button>
                                </form>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    function filterTable() {
        var containerInput, customerInput, containerFilter, customerFilter, table, tbody, tr, containerTd, customerTd, i, containerTxtValue, customerTxtValue;
        containerInput = document.getElementById("containerSearchInput");
        customerInput = document.getElementById("customerSearchInput");
        containerFilter = containerInput.value.toUpperCase();
        customerFilter = customerInput.value.toUpperCase();
        table = document.getElementById("container-table");
        tbody = table.getElementsByTagName("tbody")[0];
        tr = tbody.getElementsByTagName("tr");

        for (i = 0; i < tr.length; i++) {
            containerTd = tr[i].getElementsByTagName("td")[0]; // Index 1 corresponds to the container_number__container_number column
            customerTd = tr[i].getElementsByTagName("td")[1]; // Index 2 corresponds to the customer column
            if (containerTd && customerTd) {
                containerTxtValue = containerTd.textContent || containerTd.innerText;
                customerTxtValue = customerTd.textContent || customerTd.innerText;
                var containerDisplayStyle = containerTxtValue.toUpperCase().indexOf(containerFilter) > -1 ? "" : "none";
                var customerDisplayStyle = customerTxtValue.toUpperCase().indexOf(customerFilter) > -1 ? "" : "none";

                // Set display style based on both container and customer filters
                tr[i].style.display = containerDisplayStyle === "" && customerDisplayStyle === "" ? "" : "none";
            }
        }
    }

    function filterTable2() {
        var containerInput, customerInput, containerFilter, customerFilter, table, tbody, tr, containerTd, customerTd, i, containerTxtValue, customerTxtValue;
        containerInput = document.getElementById("_containerSearchInput");
        customerInput = document.getElementById("_customerSearchInput");
        containerFilter = containerInput.value.toUpperCase();
        customerFilter = customerInput.value.toUpperCase();
        table = document.getElementById("_container-table");
        tbody = table.getElementsByTagName("tbody")[0];
        tr = tbody.getElementsByTagName("tr");

        for (i = 0; i < tr.length; i++) {
            containerTd = tr[i].getElementsByTagName("td")[0]; // Index 1 corresponds to the container_number__container_number column
            customerTd = tr[i].getElementsByTagName("td")[1]; // Index 2 corresponds to the customer column
            if (containerTd && customerTd) {
                containerTxtValue = containerTd.textContent || containerTd.innerText;
                customerTxtValue = customerTd.textContent || customerTd.innerText;
                var containerDisplayStyle = containerTxtValue.toUpperCase().indexOf(containerFilter) > -1 ? "" : "none";
                var customerDisplayStyle = customerTxtValue.toUpperCase().indexOf(customerFilter) > -1 ? "" : "none";

                // Set display style based on both container and customer filters
                tr[i].style.display = containerDisplayStyle === "" && customerDisplayStyle === "" ? "" : "none";
            }
        }
    }

    function showLoadingBar() {
        document.getElementById('loading-bar').style.display = 'block';
    }

    // Hide loading bar when page is fully loaded
    window.onload = function() {
        document.getElementById('loading-bar').style.display = 'none';
    };

    // Attach the showLoadingBar function to form submit events
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.querySelector('form');
        if (form) {
            form.addEventListener('submit', function() {
                showLoadingBar();
            });
        }
    });

    function closePopup() {
        var popup = document.querySelector('.popup');
        if (popup) {
            popup.style.display = 'none';
        }
    }

    // 删除行函数
    function removeRow(button) {
        var row = button.closest('tr');
        if (row) {
            var table = document.getElementById('edit_pallet_label');
            var rows = table.getElementsByTagName('tr');
            // 确保至少保留一行
            if (rows.length > 2) {
                row.remove();
            } else {
                alert('至少需要保留一行数据');
            }
        }
    }

    // 清空所有行函数
    function clearAllRows() {
        if (confirm('确定要清空所有数据吗？')) {
            var table = document.getElementById('edit_pallet_label');
            var tbody = table.querySelector('tbody');
            // 清空tbody
            tbody.innerHTML = '';
            // 重新添加一行
            var newRow = document.createElement('tr');
            newRow.id = 'lable-row';
            newRow.innerHTML = `
                <td style="text-align: center; border: 1px solid #dee2e6; padding: 10px; background: #f8f9fa;">
                    <input type="text" style="width: 100%; border: 1px solid #ced4da; border-radius: 4px; padding: 6px; font-size: 12px; box-sizing: border-box;" placeholder="输入柜号">
                </td>
                <td style="text-align: center; border: 1px solid #dee2e6; padding: 10px; background: #f8f9fa;">
                    <input type="text" style="width: 100%; border: 1px solid #ced4da; border-radius: 4px; padding: 6px; font-size: 12px; box-sizing: border-box;" placeholder="输入客户">
                </td>
                <td style="text-align: center; border: 1px solid #dee2e6; padding: 10px; background: #f8f9fa;">
                    <input type="text" style="width: 100%; border: 1px solid #ced4da; border-radius: 4px; padding: 6px; font-size: 12px; box-sizing: border-box;" placeholder="输入唛头">
                </td>
                <td style="text-align: center; border: 1px solid #dee2e6; padding: 10px; background: #f8f9fa;">
                    <input type="text" style="width: 100%; border: 1px solid #ced4da; border-radius: 4px; padding: 6px; font-size: 12px; box-sizing: border-box;" placeholder="输入FBA">
                </td>
                <td style="text-align: center; border: 1px solid #dee2e6; padding: 10px; background: #f8f9fa;">
                    <input type="text" style="width: 100%; border: 1px solid #ced4da; border-radius: 4px; padding: 6px; font-size: 12px; box-sizing: border-box;" placeholder="输入目的地">
                </td>
                <td style="text-align: center; border: 1px solid #dee2e6; padding: 10px; background: #f8f9fa;">
                    <select style="width: 100%; border: 1px solid #ced4da; border-radius: 4px; padding: 6px; font-size: 12px; box-sizing: border-box;">
                        <option value="卡车派送">卡车派送</option>
                        <option value="客户自提">客户自提</option>
                        <option value="暂扣留仓">暂扣留仓</option>
                    </select>
                </td>         
                <td style="text-align: center; border: 1px solid #dee2e6; padding: 10px; background: #f8f9fa;">
                    <input type="text" style="width: 100%; border: 1px solid #ced4da; border-radius: 4px; padding: 6px; font-size: 12px; box-sizing: border-box;" placeholder="板号">
                </td>
                <td style="text-align: center; border: 1px solid #dee2e6; padding: 10px; background: #f8f9fa;">
                    <input type="date" style="width: 100%; border: 1px solid #ced4da; border-radius: 4px; padding: 6px; font-size: 12px; box-sizing: border-box;">
                </td>
                <td style="text-align: center; border: 1px solid #dee2e6; padding: 10px; background: #f8f9fa;">
                    <select style="width: 100%; border: 1px solid #ced4da; border-radius: 4px; padding: 6px; font-size: 12px; box-sizing: border-box;">
                        <option value="否">否</option>
                        <option value="是">是</option>
                    </select>
                </td>
                <td style="text-align: center; border: 1px solid #dee2e6; padding: 10px; background: #f8f9fa;">
                    <button type="button" class="btn btn-danger btn-sm" onclick="removeRow(this)" style="font-size: 10px; padding: 4px 8px;">
                        <i class="bi bi-trash"></i>
                    </button>
                </td>
            `;
            tbody.appendChild(newRow);
        }
    }
    function print_label(button, containerNumber, customerCode) {
        var popup = document.querySelector('.popup');
        
        // 填充柜号和客户信息到第一行
        var firstRow = document.querySelector('#lable-row');
        if (firstRow) {
            var containerInput = firstRow.cells[0].querySelector('input');
            var customerInput = firstRow.cells[1].querySelector('input');
            
            if (containerInput) containerInput.value = containerNumber;
            if (customerInput) customerInput.value = customerCode;
        }
        
        if (popup.style.display === 'none' || popup.style.display === '') {
            popup.style.display = 'block';
        } else {
            popup.style.display = 'none';
        }
    }
    function editTable(flag) {
        customerInfo = []
        var table = document.getElementById('edit_pallet_label');              
        var rows = table.getElementsByTagName('tr');
        
        for (var i = 1; i < rows.length; i++) {      
            var cells = rows[i].getElementsByTagName('td');
            var rowData = [];
            
            for (var j = 0; j < cells.length - 1; j++) { // 减1是为了跳过最后一列的操作按钮
                var input = cells[j].querySelector('input');
                var select = cells[j].querySelector('select');
                
                if (flag) {
                    // 编辑模式：确保所有字段都是可编辑的
                    // 在新的界面中，所有字段默认就是可编辑的，所以不需要特殊处理
                } else {
                    // 确认模式：收集数据
                    if (input) {
                        if (input.type === 'date' || input.type === 'text') {
                            rowData.push(input.value);
                        }
                    } else if (select) {
                        rowData.push(select.value);
                    }
                }
            }
            
            if (rowData.length > 0) {
                customerInfo.push(rowData);
            }
        };
        
        if (!flag) {  
            var jsonCustomerInfo = JSON.stringify(customerInfo);
            var form = document.getElementById('semi_auto_label');
            
            // 移除可能已存在的customerInfo输入
            var existingInput = form.querySelector('input[name="customerInfo"]');
            if (existingInput) {
                existingInput.remove();
            }
            
            var newInput = document.createElement('input');
            newInput.value = jsonCustomerInfo;
            newInput.name = 'customerInfo';
            newInput.type = 'hidden';
            form.appendChild(newInput);

            console.log('提交的数据:', customerInfo); // 调试用
            
            var popup = document.querySelector('.popup');
            popup.style.display = 'none';
            form.submit();
        };
    };
    function addRowBelow() {   //添加行的操作
        var table = document.getElementById('edit_pallet_label');
        var newRow = document.querySelector('#lable-row').cloneNode(true);
        var newId = 'lable-row'+ Date.now();        
        newRow.style.display = '';        
        newRow.id = newId;
        table.appendChild(newRow);
    };
</script>
{% endblock %}