{% extends 'base.html' %}
{% load static custom_filters %}
{% block content %}

    <form method="post" style="width: 100%;" id="palletForm">  <!-- 表单ID -->
        {% csrf_token %}
        <div class="container mt-3" style="max-width: 100%;">
            <h4 class="mb-4">拆柜录入</h4>
            {% if status == 'non_palletized' %}
            <div class="text-right">
                {% if warehouse == "LA-91761" %}
                <button type="button" class="btn btn-secondary" style="width: 130px; height: 35px; margin-right: 10px;"
                        onclick="showBatchLocationDialog()">批量设置库位</button>
                {% endif %}
                <button id="addRowButton" type="button" class="btn btn-primary" style="width: 100px; height: 35px;" onclick="addRowBelow()">添加行</button>
                <button id="addRowButton" type="button" class="btn btn-primary" style="width: 100px; height: 35px;" onclick="rmLastRow()">删除行</button>
            </div>
            {% endif %}
            <div style="overflow-x: auto; max-width: 100%; overflow-y: auto; max-height: 800px;">
                <table class="table" style="font-size: 11px">
                    <thead>
                        <tr>
                            <th class="th">货柜</th>
                            <th class="th">目的仓库</th>
                            <th class="th">派送类型</th>
                            <th class="th">派送方式</th>
                            {% if status == 'non_palletized' %}
                            <th class="th">唛头</th>
                            <th class="th">FBA ID</th>
                            <th class="th">REF ID</th>
                            <th class="th">预报箱数</th>
                            {% endif %}
                            <th class="th">入库箱数</th>
                            <th class="th">CBM</th>
                            <th class="th">打板数</th>
                            <th class="th">PO_ID</th>
                            {% if warehouse == "LA-91761" %}
                            <th class="th">库位</th>
                            {% endif %}
                            <th class="th">最早派送时间</th>
                            <th class="th">最晚派送时间</th>
                            <th class="th">备注</th>
                        </tr>
                    </thead>
                    <tbody id="palletization-container">
                        {% for pl, pl_form in order_packing_list %}
                        <tr id="palletization-row">
                            <td class="td">{{ pl.container_number__container_number }}</td>
                            {% if status == 'non_palletized' %}
                            <td class="td">{{ pl.destination }}</td>
                            {% elif status == 'palletized' %}
                                {% if " " in pl.destination or "自提" in pl.destination %}
                                <td id="destination - {{ pl.id }}" class="td">
                                    <a href="#"
                                        onclick="showPalletFromLink(this)"
                                        data-destination="{{ pl.destination }}"
                                        data-ids="{{ pl.ids }}"
                                        data-length="{{ pl.length|default_if_none:'' }}"
                                        data-width="{{ pl.width|default_if_none:'' }}"
                                        data-height="{{ pl.height|default_if_none:'' }}"
                                        data-npcs="{{ pl.n_pcs }}"
                                        data-number="{{ pl.number|default_if_none:'' }}"
                                        data-weight="{{ pl.weight }}">
                                        {{ pl.destination }}
                                    </a>
                                </td>
                                {% else %}
                                <td class="td">{{ pl.destination }}</td>
                                {% endif%}
                            {% endif %}
                            <td class="td">
                                {{ pl.delivery_type }}
                                <input type="hidden" name="delivery_type" value="{{pl.delivery_type}}">
                            </td>
                            <td class="td">
                                {% if status == 'non_palletized' %}
                                    {% with first_value=pl.custom_delivery_method|split_and_get_first %}
                                        {{ first_value }}
                                        <input type="hidden" name="delivery_method" value="{{first_value}}">
                                    {% endwith %}
                                {% else %}
                                    {{pl.delivery_method}}
                                    <input type="hidden" name="delivery_method" value="{{pl.delivery_method}}">
                                {% endif %}
                            </td>
                            {% if status == 'non_palletized' %}
                            <td class="td" style="max-width: 400px; word-break: break-all;"><small>{{ pl.shipping_marks }}</small></td>
                            <td class="td" style="max-width: 400px; word-break: break-all;"><small>{{ pl.fba_ids }}</small></td>
                            <td class="td" style="max-width: 400px; word-break: break-all;"><small>{{ pl.ref_ids }}</small></td>
                            <td class="td">{{ pl.pcs }}</td>
                            <td class="td"><input type="number" step="1" name="pcs_actul" style="width:50px;" value="{{ pl.pcs }}" required></td>
                            {% else %}
                            <td class="td">{{ pl.pcs }}</td>
                            {% endif %}
                            <td class="td">{{ pl.cbm|floatformat:2 }}</td>
                            {% if status == 'palletized' %}
                            <td class="td">{{ pl.n_pallet }}</td>
                            {% else %}
                                <td class="td">
                                    <div style="position: relative;">
                                        {{ pl_form.n_pallet }}
                                        <!-- 改为空容器，由JS动态填充 -->
                                        <div class="pallet-tip" data-cbm="{{ pl.cbm|floatformat:2 }}"
                                             style="font-size: 9px; color: #666; margin-top: 2px;">
                                            建议范围：计算中...
                                        </div>
                                    </div>
                                </td>
                            {% endif %}
                            <td class="td">{{ pl.PO_ID }}</td>
                            {% if warehouse == "LA-91761" %}
                                {% if status == 'non_palletized' %}
                                <td class="td">
                                    <input type="text" name="slots" value="{{ pl.slot|default_if_none:'' }}"
                                        style="width: 80px; font-size: 11px;">
                                </td>
                                {% else %}
                                <td class="td">{{ pl.slot  }}</td>
                                {% endif %}
                            {% endif %}
                            <td class="td">{{ pl.delivery_window_start  }}</td>
                            <td class="td">{{ pl.delivery_window_end  }}</td>
                            <td class="td">{{ pl.note|default_if_none:"" }}</td>
                            <input type="hidden" name="ids" value="{{pl.ids}}">
                            <input type="hidden" name="shipping_marks" value="{{pl.shipping_marks}}">
                            <input type="hidden" name="fba_ids" value="{{pl.fba_ids}}">
                            <input type="hidden" name="ref_ids" value="{{pl.ref_ids}}">
                            <input type="hidden" name="address" value="{{pl.address}}">
                            <input type="hidden" name="zipcode" value="{{pl.zipcode}}">
                            <input type="hidden" name="contact_name" value="{{pl.contact_name}}">
                            <input type="hidden" name="pcs_reported" value="{{pl.pcs}}">
                            <input type="hidden" name="cbms" value="{{pl.cbm}}">
                            <input type="hidden" name="notes" value="{{pl.note}}">
                            <input type="hidden" name="weights" value="{{pl.weight_lbs}}">
                            <input type="hidden" name="destinations" value="{{pl.destination}}">
                            <input type="hidden" name="delivery_window_starts" value="{{pl.delivery_window_start}}">
                            <input type="hidden" name="delivery_window_ends" value="{{pl.delivery_window_end}}">
                            <input type="hidden" name="container_number" value="{{pl.container_number__container_number}}">
                            <input type="hidden" name="shipment_batch_number" value="{{pl.shipment_batch_number__shipment_batch_number}}">
                            <input type="hidden" name="master_shipment_batch_number" value="{{pl.master_shipment_batch_number__shipment_batch_number}}">
                            <input type="hidden" name="po_ids" value="{{pl.PO_ID}}">
                        </tr>
                        {% endfor %}
                        {% if status == 'non_palletized' %}
                        <tr id="palletization-row-empty" class="abnormal-palletization-row" style="display: none;">
                            <td class="td"><input type="text" name="container_numer" value="{{ container_number }}" disabled></td>
                            <td class="td"><input type="text" name="new_destinations" required></td>
                            <td class="td">
                                <select name="delivery_type" class="new-delivery-method" style="font-size: 13px;">
                                    <option value="public">public</option>
                                    <option value="other">other</option>
                                </select>
                            </td>
                            <td class="td">
                                <select name="new_delivery_method" class="new-delivery-method" style="font-size: 13px;">
                                    {% for k, v in delivery_method_options %}
                                    <option value="{{ v }}">{{ k }}</option>
                                    {% endfor %}
                                </select>
                            </td>
                            {% if status == 'non_palletized' %}
                            <td class="td"><input type="text" name="new_shipping_marks" placeholder="optional"></td>
                            <td class="td"><input type="text" name="new_fba_ids" placeholder="optional"></td>
                            <td class="td"><input type="text" name="new_ref_ids" placeholder="optional"></td>
                            <td class="td"><input type="text" name="new_pcs_reported" value="0" disabled></td>
                            <td class="td"><input type="number" step="1" name="new_pcs_actul" required></td>
                            {% else %}
                            <td class="td"><input type="text" style="width:50px;" name="new_pcs_actul"></td>
                            {% endif %}
                            <td class="td"><input type="number" name="new_cbms" step="0.01" placeholder="optional"></td>
                            <td class="td"><input type="number" step="1" name="new_pallets" required></td>
                            <td class="td"><input type="text" name="po_ids" disabled></td>
                            {% if warehouse == "LA-91761" %}
                            <td class="td">
                                <input type="text" name="new_slots" style="width: 80px; font-size: 11px;">
                            </td>
                            {% endif %}
                            <td class="td"><input type="date" name="new_delivery_window_starts"></td>
                            <td class="td"><input type="date" name="new_delivery_window_ends"></td>
                            <td class="td"><input type="text" name="new_notes"></td>
                        </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
            <div class="text-left">
                {% if status == 'palletized' %}
                    <input type="hidden" name="step" value="back">
                    <input type="hidden" name="name" value="{{ warehouse }}">
                    <button type="submit" class="btn btn-primary" style="width: 100px; height: 35px;">返回</button>
                {% else %}
                    <input type="hidden" name="step" value="palletize">
                    <input type="datetime-local" name="offload_time" class="form-input" style="height: 35px; padding: 0 8px;">
                    <!-- 修改：按钮为type=button，触发processForm -->
                    <button type="button" class="btn btn-primary" style="width: 100px; height: 35px;" onclick="processForm()">确认</button>
                {% endif %}
            </div>
        </div>
    </form>

    <!-- 新增：违规确认弹窗（仅打板数超范围时显示） -->
    <div id="palletWarningDialog" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 25px; border: 1px solid #ddd; border-radius: 12px; z-index: 1000; box-shadow: 0 5px 20px rgba(0,0,0,0.15); width: 400px; text-align: center;">
        <h3 style="margin-top: 0; margin-bottom: 20px; font-size: 16px; color: #dc3545;">打板数超出合理范围</h3>
        <p style="font-size: 14px; line-height: 1.5; margin-bottom: 20px;">部分打板数超出合理范围！请参考每行的建议范围修改（基于系统CBM计算）。</p>
        <div style="display: flex; justify-content: center; gap: 15px;">
            <button type="button" onclick="forceSubmitPalletForm()" style="padding: 10px 25px; background: #4CAF50; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;">确认无误完成打板</button>
            <button type="button" onclick="closeWarningDialog()" style="padding: 10px 25px; background: #6c757d; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;">再次核查打板数</button>
        </div>
    </div>
    <!-- 弹窗遮罩层 -->
    <div id="dialogOverlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 999;"></div>

    <div id="batchLocationDialog" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 25px; border: 1px solid #ddd; border-radius: 12px; z-index: 1000; box-shadow: 0 5px 20px rgba(0,0,0,0.15); width: 320px;">
        <h3 style="margin-top: 0; margin-bottom: 20px; font-size: 18px; color: #333;">批量设置库位</h3>
        <input type="text" id="batchLocationValue" placeholder="输入库位，如: NJS-3" style="width: 100%; padding: 12px; margin-bottom: 20px; border: 1px solid #ccc; border-radius: 6px; font-size: 14px; box-sizing: border-box;">
        <div style="display: flex; justify-content: space-between; gap: 10px;">
            <button type="button" onclick="applyBatchLocation()" style="padding: 10px 20px; background: #4CAF50; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; flex: 1;">确认</button>
            <button type="button" onclick="closeBatchDialog('batchLocationDialog')" style="padding: 10px 20px; background: #f44336; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; flex: 1;">取消</button>
        </div>
    </div>
    <form method="post" action="" style="display: inline-block; float: right;" id="exportPallet-add">
        {% csrf_token %}
        <div class="popup-editPallet" style="display: none; z-index:999; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: white; border: 1px solid gray; padding: 20px; max-height: 50%; overflow-y: scroll;">
            <div style="display: flex; align-items: center; margin-top:10px; margin: 20px 0;">
                <div style="flex-grow: 1;"></div>
                <div style="display: flex;">
                    <input type="hidden" name="step" value="edit_pallet">
                    <input type="hidden" name="warehouse" value="{{ warehouse }}">
                    <input type="hidden" name="container_number" value="{{ container_number }}">
                    <input type="hidden" name="pk" value="{{ pk }}">
                    <button type="submit" class="btn btn-primary" onclick="edit_add_payload(this)" style="font-size: 13px; margin-right: 5px;">确认添加</button>
                    <button id="editButton" type="button" class="btn btn-danger" onclick="showPallet(this)" style="font-size: 13px;">返回</button>
                </div>
            </div>

            <table id="edit-pallet-table" class="table" style="font-size: 11px; max-height: 50%;">
                <thead>
                    <tr style="position: sticky; top: 0px;">
                        <th class="th" style="text-align: center; border: 1px solid #141414">pallet_id</th>
                        <th class="th" style="text-align: center; border: 1px solid #141414">板号</th>
                        <th class="th" style="text-align: center; border: 1px solid #141414">长</th>
                        <th class="th" style="text-align: center; border: 1px solid #141414">宽</th>
                        <th class="th" style="text-align: center; border: 1px solid #141414">高</th>
                        <th class="th" style="text-align: center; border: 1px solid #141414">箱数</th>
                        <th class="th" style="text-align: center; border: 1px solid #141414">重量</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><input type="number" name="id" value=''></td>
                        <td><input type="text" name="number" value=''></td>
                        <td><input type="number" name="length" value=''></td>
                        <td><input type="number" name="width" value=''></td>
                        <td><input type="number" name="height" value=''></td>
                        <td><input type="number" name="pcs" value=''></td>
                    </tr>
                </tbody>
            </table>
        </div>
    </form>

<script>
// 标记：是否强制提交（用户确认忽略违规）
let forceSubmit = false;
// 新增：记录超范围的打板数输入框，避免关闭弹窗后样式丢失
let invalidPalletInputs = [];

document.addEventListener('DOMContentLoaded', function() {
    initPalletTips();
});

// 初始化原有行的打板数提示（仅显示建议范围，不标红）
function initPalletTips() {
    const rows = document.querySelectorAll('#palletization-container tr:not(.abnormal-palletization-row)');
    rows.forEach(row => {
        const tipElement = row.querySelector('.pallet-tip');
        const cbm = parseFloat(tipElement?.dataset.cbm) || 0;
        const deliveryMethod = row.querySelector('input[name="delivery_method"]')?.value || '';

        if (deliveryMethod.includes('直送')) {
            if (tipElement) tipElement.style.display = 'none';
            return;
        }

        if (cbm > 0 && tipElement) {
            const minPallet = Math.ceil(cbm / 2.5);
            const maxPallet = Math.ceil(cbm / 1.5);
            tipElement.textContent = `建议范围：${minPallet} - ${maxPallet}`;
        } else if (tipElement) {
            tipElement.textContent = '建议范围：无CBM数据';
        }
    });
}

// 打开违规提示弹窗
function openWarningDialog() {
    document.getElementById('palletWarningDialog').style.display = 'block';
    document.getElementById('dialogOverlay').style.display = 'block';
}

// 关闭违规提示弹窗（核心：保留超范围输入框的红色边框）
function closeWarningDialog() {
    document.getElementById('palletWarningDialog').style.display = 'none';
    document.getElementById('dialogOverlay').style.display = 'none';
    forceSubmit = false;

    // 重新给超范围的输入框标红（确保样式不丢失）
    invalidPalletInputs.forEach(input => {
        if (input) input.style.border = '2px solid #dc3545';
    });
}

// 强制提交（用户确认忽略违规）
function forceSubmitPalletForm() {
    forceSubmit = true;
    closeWarningDialog();
    document.getElementById('palletForm').submit();
}

function showPalletFromLink(el) {
    const d = el.dataset;
    const payload = {
        destination: d.destination || '',
        ids: d.ids || '',
        length: d.length || '',
        width: d.width || '',
        height: d.height || '',
        n_pcs: d.npcs || '',
        number: d.number || '',
        weight: d.weight || ''
    };
    showPallet(payload);
}

function edit_add_payload(button){
    var tbody = document.getElementById('edit-pallet-table').getElementsByTagName('tbody')[0];
    var rows = tbody.getElementsByTagName('tr');
    var idArray = [];
    if (tbody.rows[0].cells.length === 7){
        var numberArray = [];
    }
    for (var i = 0; i < rows.length; i++) {
        var cells = rows[i].getElementsByTagName('td');
        var inputElement1 = cells[0].getElementsByTagName('input')[0];
        idArray.push(inputElement1.value);
        if (tbody.rows[0].cells.length === 7){
            var inputElement2 = cells[1].getElementsByTagName('input')[0];
            numberArray.push(inputElement2.value);
        };
        for (var j = 0; j < cells.length; j++) {
            var input = cells[j].getElementsByTagName('input')[0];
            if (input.value === '') {
                input.focus();
                event.preventDefault();
                alert('不能为空！');
                return true;
            };
            if (input.name === 'weight') {
                var value = parseFloat(input.value);
                if (isNaN(value)) {
                    input.focus();
                    event.preventDefault();
                    alert('请输入有效的数字');
                    return true;
                }
            };
        };
    };
    var form = button.closest('form');
    var hiddenInput = document.createElement('input');
    hiddenInput.type = 'hidden';
    hiddenInput.name = 'id';
    hiddenInput.value = idArray;
    form.appendChild(hiddenInput);
    if (tbody.rows[0].cells.length === 6){
        var hiddenInput2 = document.createElement('input');
        hiddenInput2.type = 'hidden';
        hiddenInput2.name = 'number';
        hiddenInput2.value = numberArray;
        form.appendChild(hiddenInput2);
    };
};

function showPallet(button) {
    var popup = document.querySelector('.popup-editPallet');
    if (popup.style.display === 'none') {
        popup.style.display = 'block';
    } else {
        popup.style.display = 'none';
    }
    const plt_ids = button.ids;
    const lengths = button.length;
    const width = button.width;
    var idsArray = plt_ids.split(',');
    var lengthArray = lengths.split(',');
    var widthArray = width.split(',');
    var heightArray = button.height.split(',');

    var pcsArray = button.n_pcs.split(',');
    var weightArray = button.weight.split(',');

    var tableBody = document.getElementById('edit-pallet-table').getElementsByTagName('tbody')[0];
    tableBody.innerHTML = '';
    if (button.destination.includes('自提')) {
        var theadTr = document.getElementById('edit-pallet-table').getElementsByTagName('thead')[0].getElementsByTagName('tr')[0];
        var secondTh = theadTr.getElementsByTagName('th')[1];
        secondTh.style.display = 'none';
        for (var i = 0; i < idsArray.length; i++) {
            var row = document.createElement('tr');
            for (var j = 0; j < 6; j++) {
                var cell = document.createElement('td');
                var input = document.createElement('input');
                input.type = 'number';
                input.name = ['id','length','width','height','pcs','weight'][j];
                if ( j === 0 ) {
                    input.value = idsArray[i];
                    input.disabled = true;
                }else if (j === 1) {
                    input.value = lengthArray[i];
                }else if (j === 2){
                    input.value = widthArray[i];
                }else if (j === 3){
                    input.value = heightArray[i];
                }else if (j === 4){
                    input.value = pcsArray[i];
                }else if (j === 5){
                    input.type = 'text';
                    input.value = parseFloat(weightArray[i]).toFixed(2);
                }
                cell.appendChild(input);
                row.appendChild(cell);
            }
            tableBody.appendChild(row);
        };

    }else{
        const form = document.getElementById('exportPallet-add');
        const newInput = document.createElement('input');
        newInput.type = 'hidden';
        newInput.name = 'destination';
        newInput.value = button.destination;
        form.appendChild(newInput);
        var numberArray = button.number.split(',');
        if (numberArray.length === 1){
            numberArray = [];
            for (var i = 0; i < idsArray.length; i++) {
                numberArray.push(i + 1);
            }
        }
        var theadTr = document.getElementById('edit-pallet-table').getElementsByTagName('thead')[0].getElementsByTagName('tr')[0];
        var secondTh = theadTr.getElementsByTagName('th')[1];
        secondTh.style.display = '';
        for (var i = 0; i < idsArray.length; i++) {
            var row = document.createElement('tr');
            for (var j = 0; j < 7; j++) {
                var cell = document.createElement('td');
                var input = document.createElement('input');
                input.type = 'number';
                input.name = ['id','number','length','width','height','pcs','weight'][j];
                if ( j === 0 ) {
                    input.value = idsArray[i];
                    input.disabled = true;
                }else if (j === 1) {
                    input.value = numberArray[i];
                    input.disabled = true;
                }else if (j === 2) {
                    input.value = lengthArray[i];
                }else if (j === 3){
                    input.value = widthArray[i];
                }else if (j === 4){
                    input.value = heightArray[i];
                }else if (j === 5){
                    input.value = pcsArray[i];
                }else if (j === 6){
                    input.type = 'text';
                    input.value = parseFloat(weightArray[i]).toFixed(2);
                }
                cell.appendChild(input);
                row.appendChild(cell);
            }
            tableBody.appendChild(row);
        };
    }
};

function addRowBelow(){
    var table = document.getElementById('palletization-container');
    var newRow = document.querySelector('#palletization-row-empty').cloneNode(true);
    newRow.style.display = '';
    newRow.id = 'palletization-row';
    table.appendChild(newRow);
    const deliveryMethodSelect = newRow.querySelector('select[name="new_delivery_method"]');
    const tipElement = newRow.querySelector('.pallet-tip');
    if (deliveryMethodSelect && tipElement) {
        deliveryMethodSelect.addEventListener('change', function () {
            if (this.value.includes('直送')) {
                tipElement.style.display = 'none';
            } else {
                tipElement.style.display = 'block';
                tipElement.textContent = '建议范围：无CBM数据（新增行需后端补充）';
            }
        });
    }
};

function rmLastRow() {
    var table = document.getElementById('palletization-container');
    var rows = document.querySelectorAll('tr.abnormal-palletization-row');
    if (rows.length > 1) {
        table.removeChild(rows[rows.length - 1]);
    };
};

function processForm() {
    event.preventDefault();
    forceSubmit = false;
    // 清空之前记录的超范围输入框
    invalidPalletInputs = [];

    // 1. 处理空行
    var firstEmptyRow = document.getElementById('palletization-row-empty');
    if (firstEmptyRow && firstEmptyRow.style.display === 'none') {
        var inputs = firstEmptyRow.querySelectorAll('input, select');
        inputs.forEach(function(input) {
            if (input.hasAttribute('required')) {
                input.removeAttribute('required');
            };
            input.disabled = true;
        });
    };

    // 2. 校验派送方式
    var deliveryMethodSelects = document.querySelectorAll('select.new-delivery-method');
    var isValid = true;
    deliveryMethodSelects.forEach(function(select) {
        if (!select.disabled) {
            if (select.value.trim() === '') {
                isValid = false;
                select.style.border = '2px solid red';
            } else {
                select.style.border = '';
            };
        };
    });
    if (!isValid) {
        alert("请选择'派送方式'!");
        return;
    };

    // 3. 校验打板数范围（核心）
    var allRows = document.querySelectorAll('#palletization-container tr');
    var palletRangeValid = true;

    allRows.forEach(row => {
        if (row.id === 'palletization-row-empty' && row.style.display === 'none') return;

        const cbm = parseFloat(row.querySelector('input[name="cbms"]')?.value) || 0;
        const palletInput = row.querySelector('input[name="n_pallet"]') || row.querySelector('input[name="new_pallets"]');
        const deliveryMethod = row.querySelector('input[name="delivery_method"]')?.value || row.querySelector('select[name="new_delivery_method"]')?.value || '';
        const pcsInput = row.querySelector('input[name="pcs_actul"]') || row.querySelector('input[name="new_pcs_actul"]');
        const pcsValue = parseInt(pcsInput?.value) || 0;
        const palletValue = parseInt(palletInput?.value) || 0;

        if (deliveryMethod.includes('直送') || pcsValue === 0 || cbm === 0) {
            if (palletInput) palletInput.style.border = '';
            return;
        }

        const minPallet = Math.ceil(cbm / 2.5);
        const maxPallet = Math.ceil(cbm / 1.5);

        if (palletValue < minPallet || palletValue > maxPallet) {
            palletInput.style.border = '2px solid #dc3545';
            palletRangeValid = false;
            palletInput.title = `打板数应在${minPallet}-${maxPallet}之间（基于系统CBM=${cbm}）`;
            // 记录超范围的输入框
            invalidPalletInputs.push(palletInput);
        } else {
            palletInput.style.border = '';
            palletInput.title = '';
        }
    });

    // 4. 校验打板数非空
    var palletCount = document.querySelectorAll('input[name="n_pallet"]');
    var pcsCount = document.querySelectorAll('input[name="pcs_actul"]');
    var deliveryMethods = document.querySelectorAll('input[name="delivery_method"], select[name="new_delivery_method"]');
    var palletValid = true;

    for (var i = 0; i < palletCount.length; i++){
        const p = palletCount[i].value;
        const pcs = pcsCount[i].value;
        let deliveryMethod = '';
        if (deliveryMethods[i]) {
            deliveryMethod = deliveryMethods[i].value || '';
        }

        if (!deliveryMethod.includes('直送')) {
            if (p == 0 && pcs != 0) {
                palletCount[i].style.border = '2px solid red';
                palletValid = false;
                // 记录空值的输入框
                invalidPalletInputs.push(palletCount[i]);
            } else {
                palletCount[i].style.border = '';
            };
        } else {
            palletCount[i].style.border = '';
        };
    };

    if (!palletValid) {
        alert("请核对打板数!");
        return;
    };

    // 5. 核心逻辑：根据打板数是否合规决定流程
    if (!palletRangeValid) {
        openWarningDialog();
    } else {
        document.getElementById('palletForm').submit();
    }
};

function showBatchLocationDialog() {
    document.getElementById('batchLocationDialog').style.display = 'block';
}

function closeBatchDialog(dialogId) {
    document.getElementById(dialogId).style.display = 'none';
}

function applyBatchLocation() {
    var slotValue = document.getElementById('batchLocationValue').value;
    if (slotValue) {
        var slotInputs = document.querySelectorAll('input[name="slots"], input[name="new_slots"]');
        slotInputs.forEach(function(input) {
            input.value = slotValue;
        });
        closeBatchDialog('batchLocationDialog');
    } else {
        alert('请输入库位信息');
    }
}
</script>
{% endblock %}