{% extends 'base.html' %}
{% block content %}
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">

    <style type="text/tailwindcss">
        :root {
            --primary-color: #3498db;
            --secondary-color: #2c3e50;
            --success-color: #2ecc71;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --light-color: #f8f9fa;
            --dark-color: #343a40;
            --status1-color: #e3f2fd;
            --status2-color: #e8f5e9;
            --status3-color: #fff3e0;
        }
        
        @layer utilities {
            .table-shadow {
                box-shadow: 0 2px 12px 0 rgba(0, 0, 0, 0.08);
            }

            .cell-transition {
                transition: all 0.2s ease;
            }

            .tag-shadow {
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
            }

            .header-gradient {
                background: linear-gradient(135deg, var(--secondary-color), #4a6491);
            }

            .compact-tag {
                display: inline-flex;
                align-items: center;
                padding: 0.125rem 0.5rem; /* py-0.5 px-2 */
                border-radius: 9999px; /* rounded-full */
                font-size: 10px;
                font-weight: 500; /* medium */
                box-shadow: 0 1px 2px rgba(0,0,0,0.1); /* tag-shadow */
            }

            .compact-btn {
                display: inline-flex;
                align-items: center;
                padding: 0.25rem 0.5rem; /* py-1 px-2 */
                font-size: 12px;
                border-radius: 0.5rem; /* rounded-lg */
                font-weight: 500;
                transition: color 0.2s, background-color 0.2s;
            }

            .fixed-width-cell {
                min-width: 180px;
            }
            
            .search-input {
                width: 100%;
                padding: 0.25rem 0.5rem; /* py-1 px-2 */
                border: 1px solid #d1d5db; /* gray-300 */
                border-radius: 0.25rem; /* rounded */
                font-size: 0.75rem; /* text-xs */
                outline: none;
            }
            .search-input:focus {
                outline: none;
                border-color: #165DFF; /* 你的 primary 色 */
                box-shadow: 0 0 0 1px #165DFF; /* focus:ring */
            }
            
            /* 超时记录样式：红色背景+文字，hover时加深 */
            .bg-red-50 {
                background-color: #fff2f0;
            }
            .text-red-700 {
                color: #c02626;
            }
            .hover\:bg-accent:hover {
                background-color: #e8f3ff;
            }
            /* 超时记录hover时样式调整（避免与红色冲突） */
            .bg-red-50:hover {
                background-color: #ffebe6;
            }
            
            .warehouse-header {
                background: linear-gradient(135deg, var(--secondary-color), #4a6491);
                color: white;
                padding: 16px 24px;
                border-radius: 8px;
                margin-bottom: 20px;
                display: flex;
                justify-content: space-between;
                align-items: center;
                flex-wrap: wrap;
            }
            
            .warehouse-title {
                display: flex;
                align-items: center;
                font-size: 1.25rem;
                font-weight: bold;
            }
            
            .warehouse-title i {
                margin-right: 10px;
                font-size: 1.5rem;
            }
            
            .filter-container {
                display: flex;
                align-items: center;
                gap: 12px;
                background: rgba(255, 255, 255, 0.15);
                padding: 10px 16px;
                border-radius: 6px;
            }
            
            .filter-container label {
                font-weight: 600;
                font-size: 0.9rem;
                white-space: nowrap;
            }
            
            .filter-container select {
                padding: 6px 12px;
                border: none;
                border-radius: 4px;
                background: white;
                font-size: 0.9rem;
                min-width: 160px;
                color: #000;
            }
            
            .filter-container button {
                padding: 6px 14px;
                background: var(--success-color);
                color: white;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                font-weight: 600;
                transition: background 0.3s ease;
                display: flex;
                align-items: center;
            }
            
            .filter-container button:hover {
                background: #218838;
            }
            
            .filter-container button i {
                margin-right: 5px;
            }
            .record-stats {
                display: flex;               /* 水平排列 */
                align-items: center;         /* 垂直居中 */
                justify-content: flex-end;   /* 内容靠右 */
                gap: 8px;                    /* 子元素之间间距，可根据需要调整 */
                white-space: nowrap;         /* 禁止换行，保持同一行 */
                background: white;
                padding: 12px 16px;
                border-radius: 8px;
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
                border: 1px solid #e5e7eb;
                margin-bottom: 20px;
                transition: all 0.3s ease;
            }
            
            .record-stats:hover {
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
                transform: translateY(-1px);
            }
            
            .stats-icon {
                display: flex;
                align-items: center;
                justify-content: center;
                width: 40px;
                height: 40px;
                background: linear-gradient(135deg, var(--primary-color), #2980b9);
                color: white;
                border-radius: 8px;
                margin-right: 12px;
                font-size: 18px;
            }
            
            .stats-content {
                display: flex;
                flex-direction: column;
            }
            
            .stats-main {
                display: flex;
                align-items: baseline;
                margin-bottom: 4px;
                margin-left: 8px;
            }
            
            .stats-label {
                font-size: 14px;
                color: #6b7280;
                margin-right: 8px;
            }
            
            .stats-count {
                font-size: 20px;
                font-weight: 700;
                color: var(--primary-color);
                margin-right: 8px;
            }
            
            .stats-unit {
                font-size: 14px;
                color: #6b7280;
            }
            
            .stats-filtered {
                font-size: 13px;
                color: #9ca3af;
                display: flex;
                align-items: center;
            }
            
            .stats-filtered.active {
                color: var(--success-color);
                font-weight: 500;
            }
            
            .stats-filtered::before {
                content: "•";
                margin-right: 6px;
                font-size: 16px;
            }
        }
    </style>

    <div class="bg-gray-50 font-inter text-textDark p-4 md:p-6" style="margin-top: 85px; position: relative;">
        <!-- 更新后的顶部导航栏 -->
        <div class="warehouse-header">
            <div class="warehouse-title">
                <i class="fas fa-warehouse"></i>
                <span>仓库入库管理</span>
            </div>
            
            <form action="" method="post" class="filter-container">
                {% csrf_token %}
                <label for="warehouse_filter">选择仓点区域:</label>
                <input type="hidden" name="step" value="warehouse_daily_get">
                <select name="warehouse_filter" id="warehouse_filter">
                    {% for value, display_text in warehouse_options.items %}
                        <option value="{{ value }}" {% if warehouse == value %}selected{% endif %}>
                            {{ display_text }}
                        </option>
                    {% endfor %}
                </select>

                <button type="submit">
                    <i class="fas fa-check"></i>确认
                </button>
            </form>
            
        </div>

        <div class="record-stats">
            <div class="stats-icon">
                <i class="bi bi-clipboard-data"></i>
            </div>
            <div class="stats-content">
                <div class="stats-main">
                    <span class="stats-label">共</span>
                    <span class="stats-count" id="total-records">{{ total_count|default:0 }}</span>
                    <span class="stats-unit">条记录</span>
                </div>
                <div class="stats-filtered" id="filtered-records">显示全部</div>
            </div>
        </div>

        <!-- 添加加载指示器 -->
        <div id="table-loader" class="hidden absolute inset-0 bg-white bg-opacity-70 flex items-center justify-center">
            <div class="flex flex-col items-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <span class="mt-2 text-sm text-gray-600">加载中...</span>
            </div>
        </div>

        <div class="overflow-x-auto rounded-lg table-shadow bg-white" style="position: relative">
            <table class="w-full border-collapse">
                <thead>
                <tr class="header-gradient text-white">
                    <th class="px-4 py-2.5 text-left text-sm font-bold tracking-wide" style="font-size: 12px">柜号</th>
                    <th class="px-4 py-2.5 text-left text-sm font-bold tracking-wide" style="font-size: 12px">优先级</th>
                    <th class="px-4 py-2.5 text-left text-sm font-bold tracking-wide" style="font-size: 12px">到仓位置</th>
                    <th class="px-4 py-2.5 text-left text-sm font-bold tracking-wide" style="font-size: 12px">拆柜状态</th>
                    <th class="px-4 py-2.5 text-left text-sm font-bold tracking-wide" style="font-size: 12px">实际提柜实际</th>
                    <th class="px-4 py-2.5 text-left text-sm font-bold tracking-wide" style="font-size: 12px">拆柜开始时间</th>
                    <th class="px-4 py-2.5 text-left text-sm font-bold tracking-wide" style="font-size: 12px">拆柜完成时间</th>
                    <th class="px-4 py-2.5 text-left text-sm font-bold tracking-wide" style="font-size: 12px">导出</th>
                    <th class="px-4 py-2.5 text-left text-sm font-bold tracking-wide" style="font-size: 12px">操作</th>
                    <th class="px-4 py-2.5 text-left text-sm font-bold tracking-wide" style="font-size: 12px">回传拆柜数据</th>
                    <th class="px-4 py-2.5 text-left text-sm font-bold tracking-wide" style="font-size: 12px">回传时间</th>
                </tr>
                <!-- 搜索行 -->
                <tr class="bg-gray-50 border-b border-gray-200">
                    <th class="px-4 py-2">
                        <input type="text"
                               id="container-search"
                               placeholder="搜索柜号..."
                               class="search-input"
                               autocomplete="off">
                    </th>
                    <th class="px-4 py-2"></th>
                    <th class="px-4 py-2">
                        <input type="text"
                               id="location-search"
                               placeholder="搜索到仓位置..."
                               class="search-input"
                               autocomplete="off">
                    </th>
                    <th class="px-4 py-2"></th>
                    <th class="px-4 py-2"></th>
                    <th class="px-4 py-2"></th>
                    <th class="px-4 py-2"></th>
                    <th class="px-4 py-2"></th>
                    <th class="px-4 py-2"></th>
                    <th class="px-4 py-2"></th>
                    <th class="px-4 py-2"></th>
                </tr>
                </thead>
                <tbody class="divide-y divide-gray-200" id="table-body" style="font-size: 12px;">
                {% for ret in retrieval %}
                    {% for order in ret.filtered_orders %}
                        {% with record_id="ret_"|add:ret.id|stringformat:"i" %}
                            <tr class="cell-transition hover:bg-accent
                      {% if order.is_overtime_unpacked %}bg-red-50 text-red-700 font-medium{% endif %}"
                                data-record-id="{{ record_id }}"
                                data-container="{{ order.container_number|default:''|upper }}"
                                data-location="{{ ret.arrival_location|default:''|upper }}"
                                data-is-overtime="{{ order.is_overtime_unpacked }}">
                                <!-- 1. 柜号 -->
                                <td class="px-4 py-2 text-xs text-gray-700">
                                    {{ order.container_number|default:"-" }}
                                </td>

                                <!-- 2. 优先级 -->
                                <td class="px-4 py-2">
                                    {% with priority=order.unpacking_priority|default:0 %}
                                        {% if priority == "P1" %}
                                            <span class="compact-tag bg-red-50 text-red-700">
                                            <i class="bi bi-exclamation-circle mr-0.5 text-[10px]"></i>P1
                                        </span>
                                        {% elif priority == "P2" %}
                                            <span class="compact-tag bg-yellow-50 text-yellow-700">
                                            <i class="bi bi-info-circle mr-0.5 text-[10px]"></i>P2
                                        </span>
                                        {% elif priority == "P3" %}
                                            <span class="compact-tag bg-green-50 text-green-700">
                                            <i class="bi bi-check-circle mr-0.5 text-[10px]"></i>P3
                                        </span>
                                        {% else %}
                                            <span class="compact-tag bg-gray-50 text-gray-600">
                                            <i class="bi bi-dash-circle mr-0.5 text-[10px]"></i>P4
                                        </span>
                                        {% endif %}
                                    {% endwith %}
                                </td>

                                <!-- 3. 到仓位置 -->
                                <td class="px-4 py-2 fixed-width-cell">
                                    {% if order.offload_id.unpacking_status != "1" %}
                                        <input type="text"
                                               id="arrival_location_{{ record_id }}"
                                               value="{{ ret.arrival_location|default:''|upper }}"
                                               oninput="this.value = this.value.toUpperCase();
                                                        // 更新数据属性用于搜索
                                                        this.closest('tr').setAttribute('data-location', this.value.toUpperCase())"
                                               placeholder="请输入到仓位置"
                                               >
                                    {% else %}
                                        <span class="text-xs text-gray-500"></span>
                                    {% endif %}
                                </td>


                                <!-- 4. 拆柜状态 -->
                                <td class="px-4 py-2">
                                    <div class="flex items-center space-x-3" id="status_group_{{ record_id }}">
                                        <!-- 已拆柜 -->
                                        <div class="flex items-center">
                                            <input type="checkbox"
                                                   id="unpack_1_{{ record_id }}"
                                                   name="unpacking_status_{{ record_id }}"
                                                   value="1"
                                                   {% if ret.unpacking_status|stringformat:"s" == "1" %}checked{% endif %}
                                                   class="h-3.5 w-3.5 text-primary border-gray-300 rounded focus:ring-primary/50">
                                            <label for="unpack_1_{{ record_id }}" class="ml-1 inline-flex items-center px-1.5 py-0.5 rounded-lg text-xs font-medium bg-green-50 text-success tag-shadow cursor-pointer">
                                                <i class="bi bi-check-circle-fill mr-0.5 text-[10px]"></i>已拆
                                            </label>
                                        </div>
                                        <!-- 未拆柜 -->
                                        <div class="flex items-center">
                                            <input type="checkbox"
                                                   id="unpack_0_{{ record_id }}"
                                                   name="unpacking_status_{{ record_id }}"
                                                   value="0"
                                                   {% if ret.unpacking_status|stringformat:"s" == "0" or not ret.unpacking_status %}checked{% endif %}
                                                   class="h-3.5 w-3.5 text-primary border-gray-300 rounded focus:ring-primary/50" disabled>
                                            <label for="unpack_0_{{ record_id }}" class="ml-1 inline-flex items-center px-1.5 py-0.5 rounded-lg text-xs font-medium bg-gray-50 text-neutral tag-shadow cursor-pointer">
                                                <i class="bi bi-hourglass-start mr-0.5 text-[10px]"></i>未拆
                                            </label>
                                        </div>
                                        <!-- 拆柜中 -->
                                        <div class="flex items-center">
                                            <input type="checkbox"
                                                   id="unpack_2_{{ record_id }}"
                                                   name="unpacking_status_{{ record_id }}"
                                                   value="2"
                                                   disabled
                                                   {% if ret.unpacking_status|stringformat:"s" == "2" %}checked{% endif %}
                                                   class="h-3.5 w-3.5 text-primary border-gray-300 rounded focus:ring-primary/50">
                                            <label for="unpack_2_{{ record_id }}" class="ml-1 inline-flex items-center px-1.5 py-0.5 rounded-lg text-xs font-medium bg-blue-50 text-blue-600 tag-shadow cursor-pointer">
                                                <i class="bi bi-hourglass-half mr-0.5 text-[10px]"></i>拆中
                                            </label>
                                        </div>
                                    </div>
                                </td>

                                <!-- 实际提柜实际-->
                                <td class="px-4 py-2">
                                    {% if order.retrieval_id.actual_retrieval_timestamp %}
                                        {{ order.retrieval_id.actual_retrieval_timestamp |date:"Y-m-d H:i:s" }}
                                    {% else %}
                                        {{ order.retrieval_id.actual_retrieval_timestamp|date:"Y-m-d H:i:s"|default:"-" }}
                                    {% endif %}
                                </td>

                                <!-- 拆柜开始时间 -->
                                <td class="px-4 py-2">
                                    {% with unpacking_time=order.offload_id.warehouse_unpacking_time %}
                                        {% if unpacking_time and order.offload_id.unpacking_status == "2" %}
                                            <span class="unpacking-time"
                                                  data-unpacking-time="{{ unpacking_time|date:"Y-m-d H:i:s" }}"
                                                  data-status="{{ order.offload_id.unpacking_status }}">
                                                {{ unpacking_time|date:"Y-m-d H:i:s" }}
                                            </span>
                                        {% else %}
                                            {{ unpacking_time|date:"Y-m-d H:i:s"|default:"-" }}
                                        {% endif %}
                                    {% endwith %}
                                </td>

                                <!-- 拆柜完成时间-->
                                <td class="px-4 py-2">
                                    {{ order.offload_id.warehouse_unpacked_time|date:"Y-m-d H:i:s"|default:"-" }}
                                </td>

                                <!-- 5. 导出功能 -->
                                <td class="px-4 py-2 text-xs">
                                    <div class="flex space-x-1">
                                        <form method="post" action="" style="display: inline-block;"
                                              class="download-form" onsubmit="return handleDownloadAndUpdate(this)">
                                            {% csrf_token %}
                                            <input type="hidden" name="step" value="export_palletization_list">
                                            <input type="hidden" name="status" value="palletized">
                                            <input type="hidden" name="warehouse_filter" value="{{ warehouse }}">
                                            <input type="hidden" name="offload_id" value="{{ ret.offload_id }}">
                                            <input type="hidden" name="arrival_location"
                                                   value="{{ ret.arrival_location|default:''|upper }}">
                                            <input type="hidden" name="unpacking_status"
                                                   value="{{ ret.unpacking_status }}">
                                            <input type="hidden" name="first_time_download" class="first-time-input"
                                                   value="">
                                            <input type="hidden" name="container_number"
                                                   value="{{ order.container_number|default:'' }}">
                                            <input type="hidden" name="action_type" value="export">

                                            <button type="submit"
                                                    class="compact-btn bg-success text-white hover:bg-success/90"
                                                    {% if not order.container_number %}disabled
                                                    title="柜号为空"{% endif %}>
                                                <i class="bi bi-cloud-arrow-down-fill mr-0.5 text-[11px]"></i>拆柜单
                                            </button>
                                        </form>
                                        <form method="post" action="" style="display: inline-block;">
                                            {% csrf_token %}
                                            <input type="hidden" name="step" value="export_pallet_label">
                                            <input type="hidden" name="status" value="palletized">
                                            <input type="hidden" name="customer_name" value="{{ order.customer_name.zem_code|default:'' }}">
                                            <input type="hidden" name="container_number" value="{{ order.container_number|default:'' }}">
                                            <button type="submit" class="compact-btn bg-primary text-white hover:bg-primary/90" {% if not order.container_number or not order.customer_name.zem_code %}disabled title="信息不全"{% endif %}>
                                                <i class="bi bi-cloud-arrow-down-fill mr-0.5 text-[11px]"></i>托盘标
                                            </button>
                                        </form>
                                    </div>
                                </td>

                                <!-- 6. 操作 -->
                                <td class="px-4 py-2">
                                    <form method="post" action="" class="update-single-form" data-record-id="{{ record_id }}">
                                        {% csrf_token %}
                                        <input type="hidden" name="step" value="update_warehouse">
                                        <input type="hidden" name="warehouse_filter" value="{{ warehouse }}">
                                        <input type="hidden" name="offload_id" value="{{ ret.offload_id }}">
                                        <input type="hidden" name="arrival_location" id="arrival_location_hidden_{{ record_id }}">
                                        <input type="hidden" name="unpacking_status" id="unpacking_status_hidden_{{ record_id }}">
                                        <button type="submit" class="btn btn-outline-primary px-3 py-1 text-[12px] bg-white hover:bg-gray-50">
                                            更新
                                        </button>
                                    </form>
                                </td>

                                <!-- 7. 回传拆柜数据 -->
                                <td class="px-4 py-2">
                                    <form method="post" action="">
                                        {% csrf_token %}
                                        <input type="hidden" name="step" value="warehousing_complete_loading">
                                        <input type="hidden" name="offload_id" value="{{ ret.offload_id }}">
                                        <input type="hidden" name="warehouse_filter" value="{{ warehouse }}">
                                        <input type="file"
                                               id="unpacking_data_{{ record_id }}"
                                               name="unpacking_data"
                                               class="text-[12px] w-full">
                                            <button type="submit" class="btn btn-outline-primary px-3 py-1 text-[12px] bg-white hover:bg-gray-50">
                                                确认提交
                                            </button>
                                    </form>
                                </td>

                                <!-- 回传拆柜数据的时间 -->
                                <td class="px-4 py-2">
                                    {% if order.offload_id.uploaded_at  %}
                                        {{ order.offload_id.uploaded_at|date:"Y-m-d H:i:s" }}
                                    {% else %}
                                        {{ order.offload_id.uploaded_at|date:"Y-m-d H:i:s"|default:"-" }}
                                    {% endif %}

                                </td>
                            </tr>
                        {% endwith %}
                    {% endfor %}
                {% endfor %}
                <!-- 无搜索结果提示行 -->
                <tr id="no-results" class="hidden">
                    <td colspan="9" class="px-4 py-8 text-center text-gray-500 text-sm">
                        <i class="bi bi-search mr-1"></i>没有找到匹配的记录
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // 只执行一次的配置
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#165DFF',
                        secondary: '#F5F7FA',
                        accent: '#E8F3FF',
                        success: '#00B42A',
                        neutral: '#6B7280',
                        textDark: '#1D2129',
                        textLight: '#86909C',
                    },
                    fontFamily: {
                        inter: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }

        // 页面加载完成后执行初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 显示加载指示器
            const loader = document.getElementById('table-loader');
            loader.classList.remove('hidden');

            // 初始化搜索功能
            initSearchFunctionality();

            // 使用requestIdleCallback延迟非关键初始化，提高感知性能
            requestIdleCallback(() => {
                // 处理拆柜时间显示逻辑
                handleUnpackingTimeDisplay();

                // 初始化Checkbox互斥逻辑（事件委托方式）
                initCheckboxLogic();

                // 初始化更新表单提交逻辑（事件委托方式）
                initFormSubmission();

                // 初始化下载表单
                initDownloadForms();

                // 隐藏加载指示器
                loader.classList.add('hidden');
            }, { timeout: 1000 });
        });

        // 初始化搜索功能
        function initSearchFunctionality() {
            const containerInput = document.getElementById('container-search');
            const locationInput = document.getElementById('location-search');
            const rows = Array.from(document.querySelectorAll('#table-body tr[data-record-id]')); // 转为数组，便于排序
            const noResultsRow = document.getElementById('no-results');
            const filteredCountEl = document.getElementById('filtered-records');
            const totalRecords = parseInt(document.getElementById('total-records').textContent) || 0;

            // 搜索处理函数
            function handleSearch() {
                const containerQuery = containerInput.value.trim().toUpperCase();
                const locationQuery = locationInput.value.trim().toUpperCase();
                let visibleRows = [];

                // 1. 筛选匹配的行
                rows.forEach(row => {
                    const container = row.getAttribute('data-container') || '';
                    const location = row.getAttribute('data-location') || '';
                    const isOvertime = row.getAttribute('data-is-overtime') === '1'; // 获取超时状态

                    const matchesContainer = container.includes(containerQuery);
                    const matchesLocation = location.includes(locationQuery);

                    if (matchesContainer && matchesLocation) {
                        visibleRows.push({row, isOvertime}); // 存储行和超时状态
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                });

                // 2. 对匹配的行排序：先按"是否超时"（true在前），再按原顺序
                visibleRows.sort((a, b) => {
                    if (a.isOvertime && !b.isOvertime) return -1; // 超时的在前
                    if (!a.isOvertime && b.isOvertime) return 1;
                    return 0; // 非超时行保持原顺序
                });

                // 3. 重新排列DOM，确保超时行置顶
                const tableBody = document.getElementById('table-body');
                visibleRows.forEach(item => {
                    tableBody.appendChild(item.row); // 追加到末尾=移动到当前排序位置
                });

                // 4. 显示无结果提示
                noResultsRow.style.display = visibleRows.length === 0 ? '' : 'none';

                // 5. 更新筛选计数
                if (containerQuery || locationQuery) {
                    filteredCountEl.textContent = `(筛选后: ${visibleRows.length}/${totalRecords}条)`;
                } else {
                    filteredCountEl.textContent = '(显示全部)';
                }
            }

            // 原有事件监听保留...
            containerInput.addEventListener('input', handleSearch);
            locationInput.addEventListener('input', handleSearch);
            containerInput.addEventListener('keyup', e => e.key === 'Enter' && e.target.blur());
            locationInput.addEventListener('keyup', e => e.key === 'Enter' && e.target.blur());
        }
        // 1. 处理拆柜开始时间显示和超时警告
        function handleUnpackingTimeDisplay() {
            // 使用DocumentFragment减少DOM重绘
            const fragment = document.createDocumentFragment();

            document.querySelectorAll('.unpacking-time').forEach(element => {
                const unpackingTimeStr = element.getAttribute('data-unpacking-time');
                const status = element.getAttribute('data-status');

                if (!unpackingTimeStr || status !== "2") {
                    return;
                }

                const unpackingTime = new Date(unpackingTimeStr);
                const currentTime = new Date();

                if (isNaN(unpackingTime.getTime())) {
                    console.error('无效的拆柜时间:', unpackingTimeStr);
                    return;
                }

                const timeDiffMs = currentTime - unpackingTime;
                const daysDiff = timeDiffMs / 86400000;

                if (daysDiff > 2) {
                    element.classList.add('text-red-600', 'font-medium');
                    // 创建警告元素并添加到片段
                    const warningSpan = document.createElement('span');
                    warningSpan.className = 'ml-1 text-xs bg-red-100 px-1 rounded';
                    warningSpan.textContent = '(已超2天)';
                    fragment.appendChild(warningSpan);
                    element.appendChild(warningSpan);
                }
            });
        }

        // 2. Checkbox互斥逻辑（事件委托 - 只绑定一个事件监听器）
        function initCheckboxLogic() {
            document.addEventListener('change', function(e) {
                if (e.target.type === 'checkbox' && e.target.name.startsWith('unpacking_status_')) {
                    const group = e.target.closest('[id^="status_group_"]');
                    if (!group) return;

                    const checkboxes = group.querySelectorAll('input[type="checkbox"]:not(:disabled)');
                    checkboxes.forEach(checkbox => {
                        if (checkbox !== e.target) {
                            checkbox.checked = false;
                        }
                    });

                    // 处理取消选中情况
                    if (!e.target.checked) {
                        const defaultStatus = group.querySelector('input[value="0"]');
                        if (defaultStatus && !Array.from(checkboxes).some(c => c.checked)) {
                            defaultStatus.checked = true;
                        }
                    }
                }
            });
        }

        // 3. 表单提交处理（事件委托 - 只绑定一个事件监听器）
        function initFormSubmission() {
            document.addEventListener('submit', function(e) {
                if (e.target.classList.contains('update-single-form')) {
                    e.preventDefault();
                    const form = e.target;
                    const recordId = form.getAttribute('data-record-id');
                    const currentRow = form.closest('tr[data-record-id="' + recordId + '"]');

                    // 填充"到仓位置"
                    const arrivalInput = currentRow.querySelector(`#arrival_location_${recordId}`);
                    const arrivalValue = arrivalInput.value.trim();
                    const arrivalHidden = form.querySelector(`#arrival_location_hidden_${recordId}`);
                    arrivalHidden.value = arrivalValue;

                    // 填充"拆柜状态"
                    const checkedStatus = currentRow.querySelector(`input[name="unpacking_status_${recordId}"]:checked`);
                    const statusValue = checkedStatus ? checkedStatus.value : '0';
                    const statusHidden = form.querySelector(`#unpacking_status_hidden_${recordId}`);
                    statusHidden.value = statusValue;

                    // 提交表单
                    form.submit();
                }
            });
        }

        // 4. 初始化下载表单
        function initDownloadForms() {
            // 使用事件委托代替循环绑定
            document.addEventListener('click', function(e) {
                const submitButton = e.target.closest('.download-form button[type="submit"]');
                if (!submitButton) return;

                const form = submitButton.closest('.download-form');
                const timeInput = form.querySelector('.first-time-input');
                if (!timeInput) return;

                // 获取当前时间并格式化
                const now = new Date();
                const formattedTime = `${now.getFullYear()}-${
                    String(now.getMonth() + 1).padStart(2, '0')}-${
                    String(now.getDate()).padStart(2, '0')} ${
                    String(now.getHours()).padStart(2, '0')}:${
                    String(now.getMinutes()).padStart(2, '0')}:${
                    String(now.getSeconds()).padStart(2, '0')}`;

                timeInput.value = formattedTime;
                console.log('点击时间已设置:', formattedTime);
            });

            // 表单提交事件委托
            document.addEventListener('submit', function(e) {
                if (!e.target.classList.contains('download-form')) return;

                const timeInput = e.target.querySelector('.first-time-input');
                if (!timeInput || timeInput.value) return;

                // 补充设置时间
                const now = new Date();
                timeInput.value = `${now.getFullYear()}-${
                    String(now.getMonth() + 1).padStart(2, '0')}-${
                    String(now.getDate()).padStart(2, '0')} ${
                    String(now.getHours()).padStart(2, '0')}:${
                    String(now.getMinutes()).padStart(2, '0')}:${
                    String(now.getSeconds()).padStart(2, '0')}`;
                console.log('通过提交事件补充设置时间:', timeInput.value);
            });
        }

        // 5. 处理下载并更新页面数据
        function handleDownloadAndUpdate(form) {
            const timeInput = form.querySelector('.first-time-input');
            const containerNumber = form.querySelector('input[name="container_number"]').value || '未知柜号';
            if (timeInput) {
                timeInput.value = new Date().toISOString();
            }

            // 使用requestIdleCallback延迟非关键操作
            requestIdleCallback(() => {
                performDownload(form, containerNumber);
            }, { timeout: 1000 });

            return false;
        }

        // 分离下载逻辑，便于优化
        function performDownload(form, containerNumber) {
            fetch(form.action, {
                method: form.method,
                body: new FormData(form),
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => {
                const contentType = response.headers.get('content-type');
                if (contentType && contentType.includes('application/vnd.openxmlformats-officedocument.spreadsheetml.sheet')) {
                    return response.blob();
                }
                throw new Error('未收到文件响应');
            })
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${containerNumber}.xlsx`;
                document.body.appendChild(a);
                a.click();

                // 延迟清理以确保下载完成
                setTimeout(() => {
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                }, 100);

                // 发送更新请求
                const formData = new FormData(form);
                formData.set('action_type', 'render');

                return fetch(form.action, {
                    method: form.method,
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });
            })
            .then(renderResponse => {
                if (renderResponse.ok) {
                    window.location.reload();
                } else {
                    throw new Error('更新页面数据失败');
                }
            })
            .catch(error => {
                console.error('操作失败:', error);
                alert('下载或更新数据失败，请重试');
            });
        }
    </script>
{% endblock %}