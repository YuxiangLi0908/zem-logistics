{% extends 'base.html' %}
{% block content %}
<h3 class="mb-3">创建新订单</h3>

{% if step == 1 %}
<form method="post">
    {% csrf_token %}
    <div class="container mt-3">
        <h4 class="mb-3">订单信息</h4>
        <div class="form-row" >
            <div class="form-group col-md-4">
                <label class="col-form-label" style="font-size: 15px; width: 100px; height: 40px;">订单类型</label>
                {{ order_type }}
                <style>
                    #{{ order_type.id_for_label }} {
                        width: 150px;
                        height: 30px;
                        font-size: 15px;
                    }
                </style>
            </div>
            <div class="form-group col-md-4">
                <label class="col-form-label" style="font-size: 15px; width: 100px; height: 40px;">客户</label>
                {{ order_form.customer_name }}
                <style>
                    #{{ order_form.customer_name.id_for_label }} {
                        width: 150px;
                        height: 30px;
                        font-size: 15px;
                    }
                </style>
            </div>
            <div class="form-group col-md-4">
                <label class="col-form-label" style="font-size: 15px; width: 100px; height: 40px;">仓库</label>
                {% if order_type == "转运" %}
                    {{ warehouse_form.name }}
                {% else %}
                    N/A
                    <input type="hidden" name="name" value="N/A">
                {% endif %}
                <style>
                    #{{ warehouse_form.name.id_for_label }} {
                        width: 150px;
                        height: 30px;
                        font-size: 15px;
                    }
                </style>
            </div>
            <div class="form-group col-md-4">
                <label class="col-form-label" style="font-size: 15px; width: 100px; height: 40px;">ETA</label>
                {{ order_form.eta }}
                <style>
                    #{{ order_form.eta.id_for_label }} {
                        width: 150px;
                        height: 30px;
                        font-size: 15px;
                    }
                </style>
            </div>
            <div class="form-group col-md-4">
                <label class="col-form-label" style="font-size: 15px; width: 100px; height: 40px;">清关方式</label>
                {{ clearance_select_form.clearance_option }}
                <style>
                    #{{ clearance_select_form.clearance_option.id_for_label }} {
                        width: 150px;
                        height: 30px;
                        font-size: 15px;
                    }
                </style>
            </div>
            <div class="form-group col-md-4">
                <label class="col-form-label" style="font-size: 15px; width: 100px; height: 40px;">提柜方式</label>
                {% if order_type == "转运" %}
                    {{ retrieval_select_form.retrieval_option }}
                {% else %}
                    代理卡车
                    <input type="hidden" name="retrieval_option" value="代理卡车">
                {% endif %}
                <style>
                    #{{ retrieval_select_form.retrieval_option.id_for_label }} {
                        width: 150px;
                        height: 30px;
                        font-size: 15px;
                    }
                </style>
            </div>
        </div>
    </div>
    <input type="hidden" name="order_type" value="{{ order_type }}">
    <input type="hidden" name="step" value="container_info">
    <div class="text-right">
        <button type="submit" class="btn btn-primary" style="width: 100px; height: 35px;">下一步</button>
    </div>
</form>

{% elif step == 2 %}
<form method="post" class="needs-validation" id="orderForm" novalidate>
    {% csrf_token %}
    <div class="container mt-3">
        <h4 class="mb-3">货柜信息</h4>
        <div class="form-row" >
            <div class="form-group col-md-4">
                <label class="col-form-label" style="font-size: 15px; width: 100px; height: 40px;">货柜号(#Ref)</label>
                {{ container_form.container_number }}
                <style>
                    #{{ container_form.container_number.id_for_label }} {
                        width: 150px;
                        height: 30px;
                        font-size: 15px;
                    }
                </style>
            </div>
            <div class="form-group col-md-4">
                <label class="col-form-label" style="font-size: 15px; width: 100px; height: 40px;">柜型</label>
                {{ container_form.container_type }}
                <style>
                    #{{ container_form.container_type.id_for_label }} {
                        width: 150px;
                        height: 30px;
                        font-size: 15px;
                    }
                </style>
            </div>
            <div class="form-group col-md-4">
                <label class="col-form-label" style="font-size: 15px; width: 100px; height: 40px;">船/航空公司</label>
                {{ retrieval_form.shipping_line }}
                <style>
                    #{{ retrieval_form.shipping_line.id_for_label }} {
                        width: 150px;
                        height: 30px;
                        font-size: 15px;
                    }
                </style>
            </div>
            <div class="form-group col-md-4">
                <label class="col-form-label" style="font-size: 15px; width: 100px; height: 40px;">始发港</label>
                {{ retrieval_form.origin }}
                <style>
                    #{{ retrieval_form.origin.id_for_label }} {
                        width: 150px;
                        height: 30px;
                        font-size: 15px;
                    }
                </style>
            </div>
            <div class="form-group col-md-4">
                <label class="col-form-label" style="font-size: 15px; width: 100px; height: 40px;">到达港</label>
                {{ retrieval_form.destination }}
                <style>
                    #{{ retrieval_form.destination.id_for_label }} {
                        width: 150px;
                        height: 30px;
                        font-size: 15px;
                    }
                </style>
            </div>
            {% if order_type == "直送" %}
            <div class="form-group col-md-4">
                <label class="col-form-label" style="font-size: 15px; width: 100px; height: 40px;">目的仓库地址</label>
                {{ shipment_form.address }}
                <style>
                    #{{ shipment_form.address.id_for_label }} {
                        width: 150px;
                        height: 30px;
                        font-size: 15px;
                    }
                </style>
            </div>
            {% endif %}
            <div class="form-group col-md-4">
                <label class="col-form-label" style="font-size: 15px; width: 100px; height: 40px;">提货地点</label>
                {{ retrieval_form.retrieval_location }}
                <style>
                    #{{ retrieval_form.retrieval_location.id_for_label }} {
                        width: 150px;
                        height: 30px;
                        font-size: 15px;
                    }
                </style>
            </div>
            <div class="form-group col-md-4">
                <label class="col-form-label" style="font-size: 15px; width: 100px; height: 40px;">提单号</label>
                {{ retrieval_form.shipping_order_number }}
                <style>
                    #{{ retrieval_form.shipping_order_number.id_for_label }} {
                        width: 150px;
                        height: 30px;
                        font-size: 15px;
                    }
                </style>
            </div>
        </div>
    </div>
    <input type="hidden" name="order_type" value="{{ order_type }}">
    <input type="hidden" name="step" value="packing_list">
    <input type="hidden" name="order_data" value="{{ order_data }}">
    <div class="text-right">
    {% if order_type == "直送" %}
        <button type="button" onclick="confirmSubmit()" class="btn btn-primary" style="width: 100px; height: 35px;">创建订单</button>
        <script>
            function confirmSubmit() {
            var confirmation = window.confirm("确认创建订单?");
            if (confirmation) {
                document.getElementById("orderForm").submit();
            }
            }
        </script>
    {% else %}
        <button type="submit" class="btn btn-primary" style="width: 100px; height: 35px;">下一步</button>
    {% endif %}
    </div>
    
</form>

{% elif step == 3 %}
<form method="post" enctype="multipart/form-data">
    {% csrf_token %}
    导入模版
    {{ upload_file_form.file }}
    <input type="hidden" name="step" value="upload_template">
    <input type="hidden" name="order_data" value="{{ order_data }}">
    <input type="hidden" name="container_data" value="{{ container_data }}">
    <button type="submit" class="btn btn-success" style="width: 100px; height: 35px;">上传清单</button>
    <a href="{% url 'create_order' %}?step=download_template" class="btn btn-success" style="width: 100px; height: 35px;">下载模版</a>
</form>

<form method="post" class="needs-validation" id="orderForm" novalidate>
    {% csrf_token %}
    <div class="container mt-3">
        <div class="row" style="margin-top: 30px;">
            <div class="col-8">
                <h4 class="mb-3">物品清单</h4>
            </div>
            <div class="col-4 text-right">
                <button type="button" id="add-more-btn" class="btn btn-success" style="width: 100px; height: 35px;">
                    添加
                </button>
                <button type="button" id="remove-last-btn" class="btn btn-danger" style="width: 100px; height: 35px;">
                    删除
                </button>
            </div>
        </div>
        {{ packing_list_form.management_form }}
        <div style="overflow-x: auto; max-width: 1200px;">
            <table>
                <thead>
                    <tr>
                        <th style="border: 1px solid #dddddd; min-width: 100px;">物品名</th>
                        <th style="border: 1px solid #dddddd; min-width: 100px;">派送方式</th>
                        <th style="border: 1px solid #dddddd; min-width: 100px;">唛头</th>
                        <th style="border: 1px solid #dddddd; min-width: 100px;">FBA号</th>
                        <th style="border: 1px solid #dddddd; min-width: 100px;">目的地</th>
                        <th style="border: 1px solid #dddddd; min-width: 100px;">地址</th>
                        <th style="border: 1px solid #dddddd; min-width: 100px;">邮编</th>
                        <th style="border: 1px solid #dddddd; min-width: 100px;">refid</th>
                        <th style="border: 1px solid #dddddd; min-width: 100px;">箱数</th>
                        <th style="border: 1px solid #dddddd; min-width: 100px;">单箱重量-lbs</th>
                        <th style="border: 1px solid #dddddd; min-width: 100px;">总重量-lbs</th>
                        <th style="border: 1px solid #dddddd; min-width: 100px;">CBM</th>
                    </tr>
                </thead>
                <tbody id="formsets-container">
                    <tr id="formset-row" style="display: none;">
                        <td style="border: 1px solid #dddddd; min-width: 100px;">{{ packing_list_form.empty_form.product_name }}</td>
                        <td style="border: 1px solid #dddddd; min-width: 100px;">{{ packing_list_form.empty_form.delivery_method }}</td>
                        <td style="border: 1px solid #dddddd; min-width: 100px;">{{ packing_list_form.empty_form.shipping_mark }}</td>
                        <td style="border: 1px solid #dddddd; min-width: 100px;">{{ packing_list_form.empty_form.fba_id }}</td>
                        <td style="border: 1px solid #dddddd; min-width: 100px;">{{ packing_list_form.empty_form.destination }}</td>
                        <td style="border: 1px solid #dddddd; min-width: 100px;">{{ packing_list_form.empty_form.address }}</td>
                        <td style="border: 1px solid #dddddd; min-width: 100px;">{{ packing_list_form.empty_form.zipcode }}</td>
                        <td style="border: 1px solid #dddddd; min-width: 100px;">{{ packing_list_form.empty_form.ref_id }}</td>
                        <td style="border: 1px solid #dddddd; min-width: 100px;">{{ packing_list_form.empty_form.pcs }}</td>
                        <td style="border: 1px solid #dddddd; min-width: 100px;">{{ packing_list_form.empty_form.unit_weight_lbs }}</td>
                        <td style="border: 1px solid #dddddd; min-width: 100px;">{{ packing_list_form.empty_form.total_weight_lbs }}</td>
                        <td style="border: 1px solid #dddddd; min-width: 100px;">{{ packing_list_form.empty_form.cbm }}</td>
                    </tr>
                    {% for pl in packing_list_form.forms %}
                        <tr id="formset-row">
                            <td style="border: 1px solid #dddddd; min-width: 100px;">{{ pl.product_name }}</td>
                            <td style="border: 1px solid #dddddd; min-width: 100px;">{{ pl.delivery_method }}</td>
                            <td style="border: 1px solid #dddddd; min-width: 100px;">{{ pl.shipping_mark }}</td>
                            <td style="border: 1px solid #dddddd; min-width: 100px;">{{ pl.fba_id }}</td>
                            <td style="border: 1px solid #dddddd; min-width: 100px;">{{ pl.destination }}</td>
                            <td style="border: 1px solid #dddddd; min-width: 100px;">{{ pl.address }}</td>
                            <td style="border: 1px solid #dddddd; min-width: 100px;">{{ pl.zipcode }}</td>
                            <td style="border: 1px solid #dddddd; min-width: 100px;">{{ pl.ref_id }}</td>
                            <td style="border: 1px solid #dddddd; min-width: 100px;">{{ pl.pcs }}</td>
                            <td style="border: 1px solid #dddddd; min-width: 100px;">{{ pl.unit_weight_lbs }}</td>
                            <td style="border: 1px solid #dddddd; min-width: 100px;">{{ pl.total_weight_lbs }}</td>
                            <td style="border: 1px solid #dddddd; min-width: 100px;">{{ pl.cbm }}</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <input type="hidden" name="step" value="place_order">
        <input type="hidden" name="order_data" value="{{ order_data }}">
        <input type="hidden" name="container_data" value="{{ container_data }}">
        <div class="text-right">
            <button type="submit" class="btn btn-primary" style="width: 100px; height: 35px;">创建订单</button>
        </div>
    </div>
</form>
{% endif %}
<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.0.7/dist/umd/popper.min.js" integrity="sha384-P8HR+EjhI6LKcmPhZGtFuWm4s8o8QI6pL47rytP88SS7VOLvEZkYpB/QCyIgsA" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js" integrity="sha384-B4gt1jrGC7Jh4AgTPSdUtOBvfO8sh+WyL/JWu8f1B8Ehq82vQpsTl2aDmYD5I6S" crossorigin="anonymous"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const formsetsContainer = document.getElementById('formsets-container');
        const addMoreBtn = document.getElementById('add-more-btn');
        const removeLastBtn = document.getElementById('remove-last-btn');

        addMoreBtn.addEventListener('click', function () {
            const newFormset = document.createElement('tr');
            const formsetCount = formsetsContainer.getElementsByTagName('tr').length;
            newFormset.setAttribute('id', `id_order-${formsetCount}-container_id`)

            // Clone the first formset and update the form indexes
            const firstFormset = formsetsContainer.querySelector('#formset-row');
            const newFormsetHtml = firstFormset.innerHTML.replace(/__prefix__/g, formsetCount);

            newFormset.innerHTML = newFormsetHtml;
            formsetsContainer.appendChild(newFormset);
            for (let i = 0; i < newFormset.getElementsByTagName('input').length; i++) {
                const inputField = newFormset.getElementsByTagName('input')[i]
                inputField.id = inputField.id.replace('-0-', `-${formsetCount}-`)
                inputField.name = inputField.name.replace('-0-', `-${formsetCount}-`)
            }
            for (let i = 0; i < newFormset.getElementsByTagName('select').length; i++) {
                const inputField = newFormset.getElementsByTagName('select')[i]
                inputField.id = inputField.id.replace('-0-', `-${formsetCount}-`)
                inputField.name = inputField.name.replace('-0-', `-${formsetCount}-`)
            }
            // Increment the form count
            document.getElementById('id_form-TOTAL_FORMS').value++;
        });

        removeLastBtn.addEventListener('click', removeLastFormset);
        function removeLastFormset() {
            const formsetCount = formsetsContainer.getElementsByTagName('tr').length;
            const formsetRows = formsetsContainer.children;

            if (formsetCount > 1) {
                // Remove the last formset
                // formsetsContainer.removeChild(formsetsContainer.lastChild);
                formsetsContainer.removeChild(formsetRows[formsetCount - 1]);
                // Decrement the form count
                document.getElementById('id_form-TOTAL_FORMS').value--;
            }
        }
    });
    (function () {
            'use strict';

            window.addEventListener('load', function () {
                // Fetch all the forms we want to apply custom Bootstrap validation styles to
                var forms = document.getElementsByClassName('needs-validation');

                // Loop over them and prevent submission
                var validation = Array.prototype.filter.call(forms, function (form) {
                    form.addEventListener('submit', function (event) {
                        if (form.checkValidity() === false) {
                            event.preventDefault();
                            event.stopPropagation();
                        }
                        form.classList.add('was-validated');
                    }, false);
                });
            }, false);
        })();
</script>
{% endblock %}