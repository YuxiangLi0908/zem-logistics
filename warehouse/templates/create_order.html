{% extends 'base.html' %}
{% block content %}
<h3 class="mb-3">创建新订单</h3>

{% if step == 1 %}
<form method="post">
    {% csrf_token %}
    <div class="container mt-3">
        <h4 class="mb-3">订单信息</h4>
        <div class="form-row" >
            <div class="form-group col-md-4">
                <label class="col-form-label" style="font-size: 15px; width: 100px; height: 40px;">订单类型</label>
                {{ order_type }}
                <style>
                    #{{ order_type.id_for_label }} {
                        width: 150px;
                        height: 30px;
                        font-size: 15px;
                    }
                </style>
            </div>
            <div class="form-group col-md-4">
                <label class="col-form-label" style="font-size: 15px; width: 100px; height: 40px;">客户</label>
                {{ order_form.customer_name }}
                <style>
                    #{{ order_form.customer_name.id_for_label }} {
                        width: 150px;
                        height: 30px;
                        font-size: 15px;
                    }
                </style>
            </div>
            <div class="form-group col-md-4">
                <label class="col-form-label" style="font-size: 15px; width: 100px; height: 40px;">仓库</label>
                {% if order_type == "转运" %}
                    {{ warehouse_form.name }}
                {% else %}
                    N/A
                    <input type="hidden" name="name" value="N/A">
                {% endif %}
                <style>
                    #{{ warehouse_form.name.id_for_label }} {
                        width: 150px;
                        height: 30px;
                        font-size: 15px;
                    }
                </style>
            </div>
            <div class="form-group col-md-4">
                <label class="col-form-label" style="font-size: 15px; width: 100px; height: 40px;">ETA</label>
                {{ order_form.eta }}
                <style>
                    #{{ order_form.eta.id_for_label }} {
                        width: 150px;
                        height: 30px;
                        font-size: 15px;
                    }
                </style>
            </div>
            <div class="form-group col-md-4">
                <label class="col-form-label" style="font-size: 15px; width: 100px; height: 40px;">清关方式</label>
                {{ clearance_select_form.clearance_option }}
                <style>
                    #{{ clearance_select_form.clearance_option.id_for_label }} {
                        width: 150px;
                        height: 30px;
                        font-size: 15px;
                    }
                </style>
            </div>
            <div class="form-group col-md-4">
                <label class="col-form-label" style="font-size: 15px; width: 100px; height: 40px;">提柜方式</label>
                {% if order_type == "转运" %}
                    {{ retrieval_select_form.retrieval_option }}
                {% else %}
                    代理卡车
                    <input type="hidden" name="retrieval_option" value="代理卡车">
                {% endif %}
                <style>
                    #{{ retrieval_select_form.retrieval_option.id_for_label }} {
                        width: 150px;
                        height: 30px;
                        font-size: 15px;
                    }
                </style>
            </div>
        </div>
    </div>
    <input type="hidden" name="order_type" value="{{ order_type }}">
    <input type="hidden" name="step" value="container_info">
    <div class="text-right">
        <button type="submit" class="btn btn-primary" style="width: 100px; height: 35px;">下一步</button>
    </div>
</form>

{% elif step == 2 %}
<form method="post" class="needs-validation" id="orderForm" novalidate>
    {% csrf_token %}
    <div class="container mt-3">
        <h4 class="mb-3">货柜信息</h4>
        <div class="form-row" >
            <div class="form-group col-md-4">
                <label class="col-form-label" style="font-size: 15px; width: 100px; height: 40px;">货柜号(#Ref)</label>
                {{ container_form.container_number }}
                <style>
                    #{{ container_form.container_number.id_for_label }} {
                        width: 150px;
                        height: 30px;
                        font-size: 15px;
                    }
                </style>
            </div>
            <div class="form-group col-md-4">
                <label class="col-form-label" style="font-size: 15px; width: 100px; height: 40px;">柜型</label>
                {{ container_form.container_type }}
                <style>
                    #{{ container_form.container_type.id_for_label }} {
                        width: 150px;
                        height: 30px;
                        font-size: 15px;
                    }
                </style>
            </div>
            <div class="form-group col-md-4">
                <label class="col-form-label" style="font-size: 15px; width: 100px; height: 40px;">船/航空公司</label>
                {{ retrieval_form.shipping_line }}
                <style>
                    #{{ retrieval_form.shipping_line.id_for_label }} {
                        width: 150px;
                        height: 30px;
                        font-size: 15px;
                    }
                </style>
            </div>
            <div class="form-group col-md-4">
                <label class="col-form-label" style="font-size: 15px; width: 100px; height: 40px;">始发港</label>
                {{ retrieval_form.origin }}
                <style>
                    #{{ retrieval_form.origin.id_for_label }} {
                        width: 150px;
                        height: 30px;
                        font-size: 15px;
                    }
                </style>
            </div>
            <div class="form-group col-md-4">
                <label class="col-form-label" style="font-size: 15px; width: 100px; height: 40px;">到达港</label>
                {{ retrieval_form.destination }}
                <style>
                    #{{ retrieval_form.destination.id_for_label }} {
                        width: 150px;
                        height: 30px;
                        font-size: 15px;
                    }
                </style>
            </div>
            {% if order_type == "直送" %}
            <div class="form-group col-md-4">
                <label class="col-form-label" style="font-size: 15px; width: 100px; height: 40px;">目的仓库地址</label>
                {{ shipment_form.address }}
                <style>
                    #{{ shipment_form.address.id_for_label }} {
                        width: 150px;
                        height: 30px;
                        font-size: 15px;
                    }
                </style>
            </div>
            {% endif %}
            <div class="form-group col-md-4">
                <label class="col-form-label" style="font-size: 15px; width: 100px; height: 40px;">提货地点</label>
                {{ retrieval_form.retrieval_location }}
                <style>
                    #{{ retrieval_form.retrieval_location.id_for_label }} {
                        width: 150px;
                        height: 30px;
                        font-size: 15px;
                    }
                </style>
            </div>
            <div class="form-group col-md-4">
                <label class="col-form-label" style="font-size: 15px; width: 100px; height: 40px;">提单号</label>
                {{ retrieval_form.shipping_order_number }}
                <style>
                    #{{ retrieval_form.shipping_order_number.id_for_label }} {
                        width: 150px;
                        height: 30px;
                        font-size: 15px;
                    }
                </style>
            </div>
        </div>
    </div>
    <input type="hidden" name="order_type" value="{{ order_type }}">
    <input type="hidden" name="step" value="packing_list">
    <input type="hidden" name="order_data" value="{{ order_data }}">
    <div class="text-right">
    {% if order_type == "直送" %}
        <button type="button" onclick="confirmSubmit()" class="btn btn-primary" style="width: 100px; height: 35px;">创建订单</button>
        <script>
            function confirmSubmit() {
            var confirmation = window.confirm("确认创建订单?");
            if (confirmation) {
                document.getElementById("orderForm").submit();
            }
            }
        </script>
    {% else %}
        <button type="submit" class="btn btn-primary" style="width: 100px; height: 35px;">下一步</button>
    {% endif %}
    </div>
    
</form>

{% elif step == 3 %}
<form method="post" class="needs-validation" id="orderForm" novalidate>
    {% csrf_token %}
    <div class="container mt-3">
        <div class="row" style="margin-top: 30px;">
            <div class="col-8">
                <h4 class="mb-3">物品清单</h4>
            </div>
            <div class="col-4 text-right">
                <button type="button" id="add-more-btn" class="btn btn-success" style="width: 100px; height: 35px;">
                    添加
                </button>
            </div>
        </div>
        {{ packing_list_form.management_form }}
        <div id="formsets-container">
            {% for pl in packing_list_form.forms %}
                <div class="formset-row"  style="margin-bottom: 30px;">
                    <div class="row">
                        <div class="form-group col-md-2"  style="margin-bottom: 0px;">
                            <label style="font-size: 13px; width: 80px; margin-bottom: -10px;">物品名</label>
                            {{ pl.product_name }}
                        </div>
                        <div class="form-group col-md-2"  style="margin-bottom: 0px;">
                            <label style="font-size: 13px; width: 80px; margin-bottom: -10px;">派送方式</label>
                            {{ pl.delivery_method }}
                        </div>
                        <div class="form-group col-md-2"  style="margin-bottom: 0px;">
                            <label style="font-size: 13px; width: 80px; margin-bottom: -10px;">唛头</label>
                            {{ pl.shipping_mark }}
                        </div>
                        <div class="form-group col-md-2"  style="margin-bottom: 0px;">
                            <label style="font-size: 13px; width: 80px; margin-bottom: -10px;">FBA号</label>
                            {{ pl.fba_id }}
                        </div>
                        <div class="form-group col-md-2"  style="margin-bottom: 0px;">
                            <label style="font-size: 13px; width: 80px; margin-bottom: -10px;">目的地</label>
                            {{ pl.destination }}
                        </div>
                        <div class="form-group col-md-2"  style="margin-bottom: 0px;">
                            <label style="font-size: 13px; width: 80px; margin-bottom: -10px;">地址</label>
                            {{ pl.address }}
                        </div>
                        <div class="form-group col-md-2"  style="margin-bottom: 0px;">
                            <label style="font-size: 13px; width: 80px; margin-bottom: -10px;">邮编</label>
                            {{ pl.zipcode }}
                        </div>
                        <div class="form-group col-md-2"  style="margin-bottom: 0px;">
                            <label style="font-size: 13px; width: 80px; margin-bottom: -10px;">refid</label>
                            {{ pl.ref_id }}
                        </div>
                        <div class="form-group col-md-2"  style="margin-bottom: 0px;">
                            <label style="font-size: 13px; width: 80px; margin-bottom: -10px;">箱数</label>
                            {{ pl.pcs }}
                        </div>
                        <div class="form-group col-md-2"  style="margin-bottom: 0px;">
                            <label style="font-size: 13px; width: 80px; margin-bottom: -10px;">单箱重量-lbs</label>
                            {{ pl.unit_weight_lbs }}
                        </div>
                        <div class="form-group col-md-2"  style="margin-bottom: 0px;">
                            <label style="font-size: 13px; width: 80px; margin-bottom: -10px;">总重量-lbs</label>
                            {{ pl.total_weight_lbs }}
                        </div>
                        <div class="form-group col-md-2"  style="margin-bottom: 0px;">
                            <label style="font-size: 13px; width: 80px; margin-bottom: -10px;">CBM</label>
                            {{ pl.cbm }}
                        </div>
                    </div>
                    <hr class="Dashed">
                </div>
            {% endfor %}
        </div>
    </div>
    <input type="hidden" name="step" value="place_order">
    <input type="hidden" name="order_data" value="{{ order_data }}">
    <input type="hidden" name="container_data" value="{{ container_data }}">
    <div class="text-right">
        <button type="button" onclick="confirmSubmit()" class="btn btn-primary" style="width: 100px; height: 35px;">创建订单</button>
        <script>
            function confirmSubmit() {
              var confirmation = window.confirm("确认创建订单?");
              if (confirmation) {
                document.getElementById("orderForm").submit();
              }
            }
        </script>
    </div>
</form>
{% endif %}
    <script>
        // Add Bootstrap validation styles
        (function () {
            'use strict';

            window.addEventListener('load', function () {
                // Fetch all the forms we want to apply custom Bootstrap validation styles to
                var forms = document.getElementsByClassName('needs-validation');

                // Loop over them and prevent submission
                var validation = Array.prototype.filter.call(forms, function (form) {
                    form.addEventListener('submit', function (event) {
                        if (form.checkValidity() === false) {
                            event.preventDefault();
                            event.stopPropagation();
                        }
                        form.classList.add('was-validated');
                    }, false);
                });
            }, false);
        })();
    </script>

    <!-- Bootstrap JS and Popper.js -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.0.7/dist/umd/popper.min.js" integrity="sha384-P8HR+EjhI6LKcmPhZGtFuWm4s8o8QI6pL47rytP88SS7VOLvEZkYpB/QCyIgsA" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js" integrity="sha384-B4gt1jrGC7Jh4AgTPSdUtOBvfO8sh+WyL/JWu8f1B8Ehq82vQpsTl2aDmYD5I6S" crossorigin="anonymous"></script>

    <!-- Your custom JavaScript code -->
    <script>
        // Add your custom JavaScript here
        document.getElementById('saveButton').addEventListener('click', function () {
        // Add logic to save data to models (to be implemented later)
        // ...
        // Close the modal
        $('#myModal').modal('hide');
        });
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const formsetsContainer = document.getElementById('formsets-container');
            const addMoreBtn = document.getElementById('add-more-btn');
            
            addMoreBtn.addEventListener('click', function () {
                const newFormset = document.createElement('div');
                const formsetCount = document.getElementsByClassName('formset-row').length;
                newFormset.className = 'formset-row';
                newFormset.setAttribute('style', "margin-bottom: 30px;");
                newFormset.setAttribute('id', `id_order-${formsetCount}-container_id`)
                // Clone the first formset and update the form indexes
                const firstFormset = formsetsContainer.querySelector('.formset-row');
                const newFormsetHtml = firstFormset.innerHTML.replace(/__prefix__/g, formsetCount);

                newFormset.innerHTML = newFormsetHtml;
                formsetsContainer.appendChild(newFormset);
                for (let i = 0; i < newFormset.getElementsByTagName('input').length; i++) {
                    const inputField = newFormset.getElementsByTagName('input')[i]
                    inputField.id = inputField.id.replace('-0-', `-${formsetCount}-`)
                    inputField.name = inputField.name.replace('-0-', `-${formsetCount}-`)
                }
                for (let i = 0; i < newFormset.getElementsByTagName('select').length; i++) {
                    const inputField = newFormset.getElementsByTagName('select')[i]
                    inputField.id = inputField.id.replace('-0-', `-${formsetCount}-`)
                    inputField.name = inputField.name.replace('-0-', `-${formsetCount}-`)
                }
                // Increment the form count
                document.getElementById('id_form-TOTAL_FORMS').value++;
            });
        });
    </script>
{% endblock %}