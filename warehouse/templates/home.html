{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="trajectory-header">
    <h2>è´§ç‰©è½¨è¿¹è¿½è¸ª</h2>
    <div class="search-info">
        {% if query_params.container_number %}æŸœå·: {{ query_params.container_number }}{% endif %}
        {% if query_params.shipping_marks %}å”›å¤´: {{ query_params.shipping_marks }}{% endif %}
        {% if query_params.fba_ids %}FBA: {{ query_params.fba_ids }}{% endif %}
    </div>
</div>

<!-- æœç´¢è¡¨å• -->
<form id="trajectory-form" method="post" action="">
    {% csrf_token %}
    <div class="search-panel">
        <div class="search-row">
            <div class="search-group">
                <label>æŸœå·:</label>
                <input type="text" name="container_number" value="{{ query_params.container_number|default:'' }}" placeholder="è¾“å…¥æŸœå·">
            </div>
            <div class="search-group">
                <label>æ‰¹æ¬¡å·:</label>
                <input type="text" name="shipment_batch_number" value="{{ query_params.shipment_batch_number|default:'' }}" placeholder="è¾“å…¥æ‰¹æ¬¡å·">
            </div>
            <div class="search-group">
                <label>ISA:</label>
                <input type="text" name="appointment_id" value="{{ query_params.appointment_id|default:'' }}" placeholder="è¾“å…¥ISA">
            </div>
        </div>
        <div class="search-row">
            <div class="search-group">
                <label>ä»“ç‚¹:</label>
                <input type="text" name="act_destination" value="{{ query_params.destination|default:'' }}" placeholder="è¾“å…¥ä»“ç‚¹">
            </div>
            <div class="search-group">
                <label>å”›å¤´:</label>
                <input type="text" name="shipping_marks" value="{{ query_params.shipping_marks|default:'' }}" placeholder="è¾“å…¥å”›å¤´">
            </div>
            <div class="search-group">
                <label>FBA:</label>
                <input type="text" name="fba_ids" value="{{ query_params.fba_ids|default:'' }}" placeholder="è¾“å…¥FBA">
            </div>
            <div class="search-group">
                <label>REF:</label>
                <input type="text" name="ref_ids" value="{{ query_params.ref_ids|default:'' }}" placeholder="è¾“å…¥REF">
            </div>
        </div>
        <div class="search-actions">
            <input type="hidden" name="step" value="trajectory_query">
            <button type="submit" class="btn-primary">æŸ¥è¯¢è½¨è¿¹</button>
        </div>
    </div>
</form>

<!-- å¤šæŸœå­æç¤º -->
{% if pre_port_data and pre_port_data|length > 1 %}
<div class="multi-container-alert">
    <i class="alert-icon">âš </i>
    <span>æŸ¥è¯¢ç»“æœåŒ…å« {{ pre_port_data|length }} ä¸ªæŸœå­ï¼Œè¯·é€‰æ‹©æŸ¥çœ‹ï¼š</span>
    <div class="container-tabs">
        {% for container in pre_port_data %}
        <button class="container-tab {% if forloop.first %}active{% endif %}" 
                onclick="switchContainer('{{ container.container_number }}')">
            {{ container.container_number }}
        </button>
        {% endfor %}
    </div>
</div>
{% endif %}

<!-- æ¸¯å‰è½¨è¿¹ -->
{% if pre_port_data %}
<div class="timeline-section">
    <div class="section-header">
        <h3>æ¸¯å‰è½¨è¿¹ - é›†è£…ç®±è¿è¾“</h3>
        <span class="section-badge">{{ pre_port_data|length }} ä¸ªæŸœå­</span>
    </div>
    
    {% for container in pre_port_data %}
    <div class="container-timeline {% if not forloop.first %}hidden{% endif %}" id="container-{{ container.container_number }}">
        <div class="container-info-card">
            <div class="container-basic">
                <div class="container-number">{{ container.container_number }}</div>
                <div class="container-details">
                    <span>å®¢æˆ·: {{ container.customer_name }}</span>
                    <span>ä»“åº“: {{ container.warehouse_name }}</span>
                    <span class="status-badge status-{{ container.status }}">{{ container.status|upper }}</span>
                </div>
            </div>
        </div>
        
        <div class="timeline-progress">
            <div class="timeline-track">
                <div class="timeline-progress-bar" style="width: {{ container.progress }}%"></div>
            </div>
            <div class="timeline-steps">
                <div class="timeline-step {% if container.order_created %}completed{% endif %}">
                    <div class="step-marker"></div>
                    <div class="step-label">åˆ›å»ºè®¢å•</div>
                    <div class="step-date">{{ container.order_created|date:"M j"|default:"-" }}</div>
                </div>
                
                <div class="timeline-step {% if container.port_arrival %}completed{% endif %}">
                    <div class="step-marker"></div>
                    <div class="step-label">åˆ°è¾¾æ¸¯å£</div>
                    <div class="step-date">{{ container.port_arrival|date:"M j"|default:"-" }}</div>
                </div>
                
                <div class="timeline-step {% if container.actual_retrieval or container.target_retrieval %}completed{% endif %}">
                    <div class="step-marker"></div>
                    <div class="step-label">
                        {% if container.actual_retrieval %}å®é™…ææŸœ{% else %}é¢„è®¡ææŸœ{% endif %}
                    </div>
                    <div class="step-date">
                        {% if container.actual_retrieval %}
                            {{ container.actual_retrieval|date:"M j" }}
                        {% elif container.target_retrieval %}
                            {{ container.target_retrieval|date:"M j" }}
                            <span class="est-badge">EST</span>
                        {% else %}
                            -
                        {% endif %}
                    </div>
                </div>
                
                <div class="timeline-step {% if container.warehouse_arrival %}completed{% endif %}">
                    <div class="step-marker"></div>
                    <div class="step-label">åˆ°è¾¾ä»“åº“</div>
                    <div class="step-date">{{ container.warehouse_arrival|date:"M j"|default:"-" }}</div>
                </div>
                
                <div class="timeline-step {% if container.unloading_completed %}completed{% endif %}">
                    <div class="step-marker"></div>
                    <div class="step-label">æ‹†æŸœå®Œæˆ</div>
                    <div class="step-date">
                        {% if container.unloading_completed %}
                            {{ container.unloading_completed|date:"M j" }}
                        {% else %}
                            è¿›è¡Œä¸­
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
</div>
{% endif %}

<!-- æ¸¯åè½¨è¿¹ -->
{% if post_port_data %}
<div class="timeline-section">
    <div class="section-header">
      <div>
        <h3>æ¸¯åè½¨è¿¹ - ä»“ç‚¹é…é€</h3>
        <div class="status-summary">
          {% for status, count in status_summary.items %}  
            <span class="status-count status-{{ status }}">  
              <span class="status-label">  
                {% if status == 'pending' %}å¾…é¢„çº¦  
                {% elif status == 'scheduled' %}å·²é¢„çº¦  
                {% elif status == 'in_transit' %}è¿è¾“ä¸­  
                {% elif status == 'delivered' %}å·²é€è¾¾  
                {% elif status == 'completed' %}å·²å®Œæˆ  
                {% endif %}  
              </span>  
              <span class="status-number">{{ count }}</span>  
            </span>  
          {% endfor %}
        </div>
      </div>
      <span class="section-badge">{{ post_port_data|length }} ä¸ªä»“ç‚¹</span>
    </div>
    
    <div class="warehouse-timelines">
        {% for warehouse in post_port_data %}
        <div class="warehouse-card">
            <div class="warehouse-header">
                <div class="warehouse-title">
                    <h4>{{ warehouse.destination }}</h4>
                    {% if warehouse.abnormal_palletization %}
                    <span class="alert-badge abnormal">æ‹†æŸœå¼‚å¸¸</span>
                    {% endif %}
                    {% if warehouse.po_expired %}
                    <span class="alert-badge expired">POå¤±æ•ˆ</span>
                    {% endif %}
                </div>
                <div class="warehouse-meta">
                    <span class="status-tag status-{{ warehouse.status }}">{{ warehouse.status_display }}</span>
                </div>
            </div>
            
            <div class="warehouse-details">
              <div class="detail-item">
                  <label>å”›å¤´:</label>
                  <span class="detail-value">{{ warehouse.shipping_marks|default:"-" }}</span>
              </div>
              <div class="detail-item">
                  <label>FBA:</label>
                  <span class="detail-value">{{ warehouse.fba_ids|default:"-" }}</span>
              </div>
              <div class="detail-item">
                  <label>REF:</label>
                  <span class="detail-value">{{ warehouse.ref_ids|default:"-" }}</span>
              </div>
              <div class="detail-item">
                  <label>ç®±æ•°:</label>
                  <span class="detail-value">{{ warehouse.total_pcs }}</span>
              </div>
              <div class="detail-item">
                  <label>æ¿æ•°:</label>
                  <span class="detail-value">
                      {{ warehouse.pallet_count }}
                      {% if warehouse.pallet_type == 'ACT' %}
                      <span class="pallet-badge act">å®é™…</span>
                      {% elif warehouse.pallet_type == 'EST' %}
                      <span class="pallet-badge est">é¢„ä¼°</span>
                      {% else %}
                      <span class="pallet-badge mixed">æ··åˆ</span>
                      {% endif %}
                  </span>
              </div>
          </div>
            
            <div class="delivery-timeline">
                <div class="delivery-step {% if warehouse.status != 'pending' %}active{% endif %}">
                    <div class="step-icon">ğŸ“‹</div>
                    <div class="step-content">
                        <div class="step-title">å¾…é¢„çº¦</div>
                        <div class="step-status">ç­‰å¾…å®‰æ’</div>
                    </div>
                </div>
                
                <div class="delivery-step {% if warehouse.status == 'scheduled' or warehouse.status == 'in_transit' or warehouse.status == 'delivered' or warehouse.status == 'completed' %}active{% endif %}">
                    <div class="step-icon">ğŸ“…</div>
                    <div class="step-content">
                        <div class="step-title">å·²é¢„çº¦</div>
                        <div class="step-date">{{ warehouse.appointment_time|date:"M j H:i"|default:"-" }}</div>
                        {% if warehouse.appointment_id %}
                        <div class="step-meta">ISA: {{ warehouse.appointment_id }}</div>
                        {% endif %}
                    </div>
                </div>
                
                <div class="delivery-step {% if warehouse.status == 'in_transit' or warehouse.status == 'delivered' or warehouse.status == 'completed' %}active{% endif %}">
                    <div class="step-icon">ğŸšš</div>
                    <div class="step-content">
                        <div class="step-title">è¿è¾“ä¸­</div>
                        <div class="step-date">{{ warehouse.shipped_time|date:"M j H:i"|default:"-" }}</div>
                    </div>
                </div>
                
                <div class="delivery-step {% if warehouse.status == 'delivered' or warehouse.status == 'completed' %}active{% endif %}">
                    <div class="step-icon">ğŸ“</div>
                    <div class="step-content">
                        <div class="step-title">å·²é€è¾¾</div>
                        <div class="step-date">{{ warehouse.delivered_time|date:"M j H:i"|default:"-" }}</div>
                    </div>
                </div>
                
                <div class="delivery-step {% if warehouse.status == 'completed' %}active{% endif %}">
                    <div class="step-icon">âœ…</div>
                    <div class="step-content">
                        <div class="step-title">å·²å®Œæˆ</div>
                        <div class="step-date">{{ warehouse.completed_time|date:"M j H:i"|default:"-" }}</div>
                        {% if warehouse.pod_link %}
                        <a href="{{ warehouse.pod_link }}" class="pod-link" target="_blank">æŸ¥çœ‹POD</a>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

<!-- æ— æ•°æ®æç¤º -->
{% if not pre_port_data and not post_port_data %}
<div class="no-data">
    <div class="no-data-icon">ğŸ“Š</div>
    <h3>æš‚æ— è½¨è¿¹æ•°æ®</h3>
    <p>è¯·ä¿®æ”¹æŸ¥è¯¢æ¡ä»¶åé‡è¯•</p>
</div>
{% endif %}

<style>
  :root {
    --primary-color: #2563eb;
    --primary-light: #dbeafe;
    --secondary-color: #64748b;
    --success-color: #10b981;
    --warning-color: #f59e0b;
    --error-color: #ef4444;
    
    /* å¢å¼ºä¸­æ€§è‰² */
    --gray-50: #f8fafc;
    --gray-100: #f1f5f9;
    --gray-200: #e2e8f0;
    --gray-300: #cbd5e1;
    --gray-400: #94a3b8;
    --gray-500: #64748b;
    --gray-600: #475569;
    --gray-700: #334155;
    --gray-800: #1e293b;
    --gray-900: #0f172a;
    
    /* é—´è·ç³»ç»Ÿ */
    --space-1: 0.5rem;
    --space-2: 1rem;
    --space-3: 1.5rem;
    --space-4: 2rem;
    --space-5: 3rem;
    
    /* åœ†è§’ */
    --radius-sm: 0.375rem;
    --radius-md: 0.5rem;
    --radius-lg: 0.75rem;
    --radius-xl: 1rem;
    --radius-full: 9999px;
    
    /* é˜´å½± */
    --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
    --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
    --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
    
    /* æ¸å˜ */
    --gradient-primary: linear-gradient(135deg, var(--primary-color) 0%, #1e40af 100%);
    --gradient-success: linear-gradient(135deg, #14b8a6 0%, #0d9488 100%);
    --gradient-surface: linear-gradient(145deg, #ffffff 0%, #f8fafc 100%);
    
    /* è¿‡æ¸¡æ•ˆæœ */
    --transition-fast: all 0.2s ease;
    --transition-normal: all 0.3s ease;
    --transition-slow: all 0.5s ease;
  }
 
  .trajectory-container {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    line-height: 1.6;
    color: var(--gray-700);
    background-color: var(--gray-50);
    min-height: 100vh;
    padding: var(--space-4);
  }
 
  /* å¤´éƒ¨æ ·å¼å¢å¼º */
  .trajectory-header {
    background: var(--gradient-primary);
    color: white;
    padding: var(--space-4);
    margin: -var(--space-4) -var(--space-4) var(--space-4) -var(--space-4);
    border-radius: var(--radius-xl);
    position: relative;
    overflow: hidden;
    box-shadow: var(--shadow-md);
  }
 
  .trajectory-header::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" opacity="0.15"><circle cx="50" cy="50" r="2" fill="white"/></svg>') repeat;
    animation: float 30s infinite linear;
  }
 
  @keyframes float {
    0% { transform: translate(0, 0); }
    100% { transform: translate(-100px, -100px); }
  }
 
  .trajectory-header h2 {
    font-size: 2rem;
    font-weight: 700;
    margin-bottom: var(--space-1);
    position: relative;
    z-index: 2;
  }
 
  .search-info {
    font-size: 1.1rem;
    opacity: 0.9;
    position: relative;
    z-index: 2;
    display: flex;
    gap: 1.5rem;
    flex-wrap: wrap;
  }
 
  /* æœç´¢é¢æ¿ - ç»ç’ƒæ€è®¾è®¡å¢å¼º */
  .search-panel {
    background: rgba(255, 255, 255, 0.9);
    border-radius: var(--radius-xl);
    padding: var(--space-4);
    margin-bottom: var(--space-5);
    box-shadow: var(--shadow-lg);
    border: 1px solid rgba(255, 255, 255, 0.8);
    backdrop-filter: blur(10px);
    position: relative;
    overflow: hidden;
  }
 
  .search-panel::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 4px;
    background: var(--gradient-primary);
  }
 
  .search-panel:hover {
    box-shadow: var(--shadow-xl);
    transform: translateY(-3px);
  }
 
  .search-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    gap: var(--space-3);
    margin-bottom: var(--space-3);
  }
 
  .search-group {
    display: flex;
    flex-direction: column;
    gap: var(--space-1);
  }
 
  .search-group label {
    font-weight: 600;
    color: var(--gray-600);
    font-size: 0.9rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }
 
  .search-group input {
    padding: 0.875rem;
    border: 1px solid var(--gray-300);
    border-radius: var(--radius-md);
    font-size: 1rem;
    transition: var(--transition-normal);
    background: rgba(255, 255, 255, 0.9);
  }
 
  .search-group input:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.15);
    background: white;
  }
 
  .search-actions {
    text-align: right;
    padding-top: var(--space-2);
  }
 
  .btn-primary {
    background: var(--gradient-primary);
    color: white;
    padding: 0.875rem 1.75rem;
    border: none;
    border-radius: var(--radius-full);
    font-weight: 600;
    cursor: pointer;
    transition: var(--transition-normal);
    position: relative;
    overflow: hidden;
    font-size: 1rem;
    letter-spacing: 0.05em;
    box-shadow: var(--shadow-md);
  }
 
  .btn-primary:hover {
    background: #1e40af;
    transform: translateY(-3px);
    box-shadow: var(--shadow-lg);
  }
 
  .btn-primary::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
    transition: var(--transition-slow);
  }
 
  .btn-primary:hover::before {
    left: 100%;
  }
 
  /* å¤šæŸœå­æç¤ºæ ·å¼ç»Ÿä¸€ */
  .multi-container-alert {
    background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
    border: 1px solid #fcd34d;
    border-radius: var(--radius-xl);
    padding: 1.5rem;
    margin-bottom: 2rem;
    box-shadow: var(--shadow-md);
    position: relative;
    overflow: hidden;
  }
 
  .alert-content {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1rem;
  }
 
  .alert-icon {
    width: 3.5rem;
    height: 3.5rem;
    background: #f59e0b;
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    flex-shrink: 0;
    box-shadow: var(--shadow-sm);
  }
 
  .alert-text {
    flex: 1;
  }
 
  .alert-title {
    font-weight: 700;
    color: #d97706;
    font-size: 1.1rem;
    display: block;
    margin-bottom: 0.25rem;
  }
 
  .alert-desc {
    color: #92400e;
    font-size: 0.95rem;
  }
 
  .container-tabs {
    display: flex;
    gap: var(--space-2);
    margin-top: var(--space-2);
    flex-wrap: wrap;
  }
 
  .container-tab {
    padding: 0.75rem 1.25rem;
    border: 1px solid var(--primary-color);
    border-radius: var(--radius-full);
    background: rgba(255, 255, 255, 0.8);
    color: var(--primary-color);
    cursor: pointer;
    transition: var(--transition-normal);
    position: relative;
    overflow: hidden;
    font-weight: 600;
    backdrop-filter: blur(5px);
  }
 
  .container-tab.active {
    color: white;
    border-color: transparent;
    background: var(--gradient-primary);
    box-shadow: 0 4px 8px rgba(37, 99, 235, 0.2);
  }
 
  .container-tab:hover:not(.active) {
    background: rgba(219, 234, 254, 0.8);
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
  }
 
  /* æ—¶é—´çº¿éƒ¨åˆ† */
  .timeline-section {
    margin-bottom: 4rem;
  }
 
  .section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2.5rem;
    padding-bottom: 1rem;
    border-bottom: 2px solid var(--gray-200);
  }
 
  .section-title h3 {
    margin: 0;
    color: var(--gray-900);
    font-size: 1.6rem;
    font-weight: 700;
  }
 
  .section-subtitle {
    color: var(--gray-600);
    font-size: 0.95rem;
    font-weight: 500;
    margin-top: 0.25rem;
  }
 
  .section-badge {
    background: var(--gradient-primary);
    color: white;
    padding: 0.625rem 1.25rem;
    border-radius: var(--radius-full);
    font-size: 0.85rem;
    font-weight: 700;
    box-shadow: var(--shadow-md);
    letter-spacing: 0.05em;
  }
 
  /* æ¸¯å‰æ—¶é—´çº¿ - ç°ä»£åŒ–è®¾è®¡ */
  .container-timeline {
    background: var(--gradient-surface);
    border-radius: var(--radius-xl);
    padding: 2.5rem;
    margin-bottom: 1.75rem;
    box-shadow: var(--shadow-lg);
    transition: var(--transition-normal);
    position: relative;
    overflow: hidden;
    border: 1px solid rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(10px);
  }
 
  .container-timeline::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 0.375rem;
    height: 100%;
    background: var(--gradient-primary);
  }
 
  .container-timeline:hover {
    box-shadow: var(--shadow-xl);
    transform: translateY(-4px);
  }
 
  .container-info-card {
    margin-bottom: 2.5rem;
    position: relative;
    z-index: 2;
  }
 
  .container-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
    flex-wrap: wrap;
    gap: 1rem;
  }
 
  .container-number {
    font-size: 1.6rem;
    font-weight: 800;
    color: var(--gray-900);
    background: var(--gradient-primary);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    letter-spacing: 0.02em;
  }
 
  .container-details {
    display: flex;
    gap: 1.25rem;
    flex-wrap: wrap;
  }
 
  .container-basic {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }
 
  .status-badge {
    padding: 0.375rem 0.875rem;
    border-radius: var(--radius-full);
    font-size: 0.75rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    position: relative;
    overflow: hidden;
    backdrop-filter: blur(5px);
    border: 1px solid;
  }
 
  .status-badge.status-IN_TRANSIT {
    background: linear-gradient(135deg, rgba(16, 185, 129, 0.15) 0%, rgba(5, 150, 105, 0.15) 100%);
    color: #059669;
    border-color: #a7f3d0;
  }
 
  .status-badge.status-DELIVERED {
    background: linear-gradient(135deg, rgba(34, 197, 94, 0.15) 0%, rgba(21, 128, 61, 0.15) 100%);
    color: #15803d;
    border-color: #bbf7d0;
  }
 
  /* æ—¶é—´çº¿è¿›åº¦æ¡ */
  .timeline-progress {
    position: relative;
    padding: 3rem 0;
  }
 
  .timeline-track {
    height: 0.5rem;
    background: var(--gray-200);
    position: absolute;
    top: 3.25rem;
    left: 0;
    right: 0;
    z-index: 1;
    border-radius: var(--radius-lg);
    overflow: hidden;
  }
 
  .timeline-progress-bar {
    height: 100%;
    background: var(--gradient-success);
    border-radius: var(--radius-lg);
    transition: width 1.2s cubic-bezier(0.25, 0.1, 0.25, 1);
    position: relative;
  }
 
  .timeline-progress-bar::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.6), transparent);
    animation: shimmer 2.5s infinite;
  }
 
  @keyframes shimmer {
    0% { transform: translateX(-100%); }
    100% { transform: translateX(100%); }
  }
 
  .timeline-steps {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 1.5rem;
    position: relative;
    z-index: 2;
  }
 
  .timeline-step {
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
    position: relative;
    transition: var(--transition-normal);
  }
 
  .step-marker {
    width: 4.5rem;
    height: 4.5rem;
    border-radius: 50%;
    background: white;
    border: 4px solid var(--gray-200);
    margin-bottom: 1.25rem;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
    transition: var(--transition-normal);
    box-shadow: var(--shadow-md);
    position: relative;
    z-index: 2;
  }
 
  .timeline-step.completed .step-marker {
    border-color: var(--success-color);
    transform: scale(1.08);
    box-shadow: 0 10px 15px -3px rgba(16, 185, 129, 0.15);
  }
 
  .marker-inner {
    width: 2.5rem;
    height: 2.5rem;
    border-radius: 50%;
    background: var(--gray-200);
    display: flex;
    align-items: center;
    justify-content: center;
    transition: var(--transition-normal);
    font-size: 1.25rem;
  }
 
  .timeline-step.completed .marker-inner {
    background: var(--gradient-success);
    color: white;
  }
 
  .step-content {
    flex: 1;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
  }
 
  .step-label {
    font-weight: 700;
    margin-bottom: 0.625rem;
    color: var(--gray-800);
    font-size: 0.95rem;
    line-height: 1.4;
  }
 
  .step-date {
    font-size: 0.875rem;
    color: var(--gray-600);
    font-weight: 500;
    line-height: 1.4;
    min-height: 1.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-wrap: wrap;
    gap: 0.25rem;
  }
 
  .est-badge {
    background: var(--primary-color);
    color: white;
    padding: 0.125rem 0.625rem;
    border-radius: var(--radius-sm);
    font-size: 0.7rem;
    margin-left: 0.25rem;
    font-weight: 700;
  }
 
  /* æ¸¯åè½¨è¿¹ - ä»“ç‚¹é…é€ */
  .warehouse-timelines {
    display: grid;
    gap: 2rem;
    grid-template-columns: repeat(auto-fit, minmax(480px, 1fr));
  }
 
  .warehouse-card {
    background: var(--gradient-surface);
    border-radius: var(--radius-xl);
    padding: 2rem;
    box-shadow: var(--shadow-lg);
    transition: var(--transition-normal);
    border: 1px solid rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(10px);
    position: relative;
    overflow: hidden;
  }
 
  .warehouse-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 4px;
    background: var(--gradient-primary);
  }
 
  .warehouse-card:hover {
    transform: translateY(-5px);
    box-shadow: var(--shadow-xl);
    border-color: rgba(59, 130, 246, 0.2);
  }
 
  .warehouse-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 2rem;
    gap: 1.5rem;
  }
 
  .warehouse-title {
    flex: 1;
  }
 
  .warehouse-title h4 {
    margin: 0 0 0.875rem 0;
    color: var(--gray-900);
    font-size: 1.35rem;
    font-weight: 700;
    display: flex;
    align-items: center;
    gap: 0.875rem;
    flex-wrap: wrap;
  }
 
  .warehouse-meta {
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }
 
  .status-tag {
    padding: 0.625rem 1.25rem;
    border-radius: var(--radius-full);
    font-size: 0.8rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    position: relative;
    overflow: hidden;
    backdrop-filter: blur(5px);
    border: 1px solid;
    min-width: 100px;
    text-align: center;
    transition: var(--transition-normal);
  }
 
  .status-tag:hover {
    transform: scale(1.05);
  }
 
  .status-pending {
    background: linear-gradient(135deg, rgba(107, 114, 128, 0.1) 0%, rgba(75, 85, 99, 0.1) 100%);
    color: #6b7280;
    border-color: #d1d5db;
  }
 
  .status-scheduled {
    background: linear-gradient(135deg, rgba(6, 182, 212, 0.15) 0%, rgba(8, 145, 178, 0.15) 100%);
    color: #0891b2;
    border-color: #a5f3fc;
  }
 
  .status-in_transit {
    background: linear-gradient(135deg, rgba(245, 158, 11, 0.15) 0%, rgba(217, 119, 6, 0.15) 100%);
    color: #d97706;
    border-color: #fed7aa;
  }
 
  .status-delivered {
    background: linear-gradient(135deg, rgba(16, 185, 129, 0.15) 0%, rgba(5, 150, 105, 0.15) 100%);
    color: #059669;
    border-color: #a7f3d0;
  }
 
  .status-completed {
    background: linear-gradient(135deg, rgba(34, 197, 94, 0.15) 0%, rgba(21, 128, 61, 0.15) 100%);
    color: #15803d;
    border-color: #bbf7d0;
  }
 
  /* ä»“åº“è¯¦æƒ…ç½‘æ ¼ */
  .warehouse-details {
    margin-bottom: 2rem;
  }
 
  .detail-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1.25rem;
    background: rgba(255, 255, 255, 0.8);
    padding: 1.5rem;
    border-radius: var(--radius-lg);
    border: 1px solid rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(5px);
  }
 
  .detail-item {
    display: flex;
    flex-direction: column;
    gap: 0.375rem;
  }
 
  .detail-item label {
    font-weight: 600;
    color: var(--gray-600);
    font-size: 0.85rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }
 
  .detail-value {
    color: var(--gray-800);
    font-weight: 500;
    font-size: 1rem;
    word-break: break-word;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    flex-wrap: wrap;
  }
 
  .pallet-badge {
    padding: 0.375rem 0.75rem;
    border-radius: var(--radius-sm);
    font-size: 0.7rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    transition: var(--transition-normal);
  }
 
  .pallet-badge.act {
    background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
    color: #065f46;
    border: 1px solid #a7f3d0;
  }
 
  .pallet-badge.est {
    background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
    color: #92400e;
    border: 1px solid #fde68a;
  }
 
  .pallet-badge.mixed {
    background: linear-gradient(135deg, #e0f2fe 0%, #bae6fd 100%);
    color: #0c4a6e;
    border: 1px solid #bae6fd;
  }
 
  .pallet-badge:hover {
    transform: scale(1.05);
    box-shadow: var(--shadow-sm);
  }
 
  /* é…é€æ—¶é—´çº¿ - ç°ä»£åŒ–è®¾è®¡ */
  .delivery-timeline {
    position: relative;
    padding: 1.5rem 0;
  }
 
  .delivery-timeline::before {
    content: '';
    position: absolute;
    left: 2.5rem;
    top: 0;
    bottom: 0;
    width: 2px;
    background: linear-gradient(to bottom, var(--gray-300) 0%, transparent 100%);
    z-index: 1;
  }
 
  .delivery-step {
    display: flex;
    align-items: flex-start;
    gap: 1.25rem;
    padding: 1.5rem;
    margin-bottom: 0.75rem;
    border-radius: var(--radius-lg);
    transition: var(--transition-normal);
    position: relative;
    z-index: 2;
    background: rgba(255, 255, 255, 0.8);
    border: 1px solid rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(5px);
  }
 
  .delivery-step:last-child {
    margin-bottom: 0;
  }
 
  .delivery-step::before {
    content: '';
    position: absolute;
    left: 2.5rem;
    top: 50%;
    transform: translateY(-50%);
    width: 1.25rem;
    height: 1.25rem;
    border-radius: 50%;
    background: var(--gray-300);
    border: 3px solid white;
    z-index: 2;
    transition: var(--transition-normal);
  }
 
  .delivery-step.active::before {
    background: var(--gradient-success);
    box-shadow: 0 0 0 5px rgba(16, 185, 129, 0.25);
    animation: pulse 2s infinite;
  }
 
  .delivery-step.active {
    background: linear-gradient(135deg, rgba(16, 185, 129, 0.08) 0%, rgba(5, 150, 105, 0.08) 100%);
    border: 1px solid rgba(16, 185, 129, 0.15);
    transform: translateX(8px);
    box-shadow: var(--shadow-md);
  }
 
  .step-icon {
    width: 3.5rem;
    height: 3.5rem;
    border-radius: 50%;
    background: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.375rem;
    flex-shrink: 0;
    box-shadow: var(--shadow-md);
    border: 2px solid var(--gray-100);
    transition: var(--transition-normal);
    position: relative;
    z-index: 3;
  }
 
  .delivery-step.active .step-icon {
    border-color: var(--success-color);
    transform: scale(1.05);
    background: linear-gradient(135deg, white 0%, var(--gray-100) 100%);
    box-shadow: 0 10px 15px -3px rgba(16, 185, 129, 0.15);
  }
 
  .step-content {
    flex: 1;
    min-width: 0;
  }
 
  .step-title {
    font-weight: 700;
    color: var(--gray-800);
    margin-bottom: 0.375rem;
    font-size: 1rem;
    line-height: 1.4;
  }
 
  .step-date {
    font-size: 0.95rem;
    color: var(--gray-600);
    font-weight: 500;
    margin-bottom: 0.375rem;
    line-height: 1.4;
  }
 
  .step-status {
    font-size: 0.85rem;
    color: var(--gray-500);
    font-style: italic;
    line-height: 1.4;
  }
 
  .step-meta {
    font-size: 0.8rem;
    color: var(--gray-600);
    background: rgba(59, 130, 246, 0.08);
    padding: 0.375rem 0.75rem;
    border-radius: var(--radius-sm);
    display: inline-block;
    margin-top: 0.375rem;
    border: 1px solid rgba(59, 130, 246, 0.15);
    font-weight: 500;
  }
 
  .pod-link {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    color: var(--primary-600);
    text-decoration: none;
    font-size: 0.9rem;
    -: 600;
    padding: 0.625rem 1rem;
    borderradius: var(--radius-md);
    background: rgba(59, 130, 246, 0.08);
    border: 1px solid rgba(59, 130, 246, 0.15);
    transition: var(--transition-normal);
    margin-top: 0.5rem;
  }
 
  .pod-link:hover {
    background: rgba(59, 130, 246, 0.12);
    transform: translateY(-2px);
    box-shadow: var(--shadow-sm);
  }
 
  .link-icon {
    font-size: 1rem;
  }
 
  /* æ— æ•°æ®çŠ¶æ€ */
  .no-data {
    text-align: center;
    padding: 5rem 2rem;
    color: var(--gray-500);
    background: rgba(255, 255, 255, 0.8);
    border-radius: var(--radius-xl);
    box-shadow: var(--shadow-md);
    border: 1px solid rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(5px);
    margin: 2rem 0;
  }
 
  .no-data-icon {
    font-size: 5rem;
    margin-bottom: 1.5rem;
    opacity: 0.7;
  }
 
  .no-data h3 {
    margin: 0 0 0.75rem 0;
    color: var(--gray-600);
    font-weight: 700;
    font-size: 1.5rem;
  }
 
  .no-data p {
    margin: 0;
    font-size: 1.05rem;
    max-width: 500px;
    margin: 0 auto;
  }
  .status-summary {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
    margin-top: 0.75rem;
  }
  
  .status-count {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.375rem 0.75rem;
    border-radius: var(--radius-full);
    font-size: 0.8rem;
    font-weight: 600;
    background: rgba(255, 255, 255, 0.9);
    border: 1px solid rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(5px);
    box-shadow: var(--shadow-sm);
  }
  
  .status-label {
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }
  
  .status-number {
    font-weight: 700;
    background: var(--gray-200);
    padding: 0.125rem 0.5rem;
    border-radius: var(--radius-md);
  }
  
  /* çŠ¶æ€é¢œè‰²å¯¹åº” */
  .status-count.status-pending {
    border-color: var(--pending-border, #94a3b8);
    color: var(--pending-text, #64748b);
  }
  
  .status-count.status-scheduled {
    border-color: var(--scheduled-border, #a5f3fc);
    color: var(--scheduled-text, #0891b2);
  }
  
  .status-count.status-in_transit {
    border-color: var(--intransit-border, #fed7aa);
    color: var(--intransit-text, #d97706);
  }
  
  .status-count.status-delivered {
    border-color: var(--delivered-border, #a7f3d0);
    color: var(--delivered-text, #059669);
  }
  
  .status-count.status-completed {
    border-color: var(--completed-border, #bbf7d0);
    color: var(--completed-text, #15803d);
  }
  
  @media (max-width: 1024px) {
    .warehouse-timelines {
      grid-template-columns: 1fr;
    }
    
    .detail-grid {
      grid-template-columns: repeat(2, 1fr);
    }
    
    .search-row {
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    }
  }
 
  @media (max-width: 768px) {
    .trajectory-header {
      margin: -var(--space-4) -var(--space-4) var(--space-3) -var(--space-4);
      padding: var(--space-3);
    }
    
    .trajectory-header h2 {
      font-size: 1.8rem;
    }
    
    .search-panel {
      padding: var(--space-3);
    }
    
    .search-row {
      grid-template-columns: 1fr;
    }
    
    .container-timeline {
      padding: 2rem;
    }
    
    .warehouse-header {
      flex-direction: column;
      align-items: flex-start;
      gap: 1rem;
    }
    
    .warehouse-meta {
      align-self: flex-start;
      margin-top: 0.5rem;
    }
    
    .detail-grid {
      grid-template-columns: 1fr;
    }
    
    .delivery-step {
      padding: 1.25rem 1rem;
    }
    
    .step-icon {
      width: 3rem;
      height: 3rem;
      font-size: 1.25rem;
    }
    
    .delivery-timeline::before {
      left: 2rem;
    }
    
    .delivery-step::before {
      left: 2rem;
    }

    .status-summary {
      gap: 0.5rem;
      margin-top: 0.5rem;
    }
    
    .status-count {
      font-size: 0.75rem;
      padding: 0.25rem 0.5rem;
    }
  }
 
  @media (max-width: 480px) {
    .trajectory-container {
      padding: var(--space-3) var(--space-3) 0 var(--space-3);
    }
    
    .trajectory-header {
      margin: -var(--space-3) -var(--space-3) var(--space-3) -var(--space-3);
      border-radius: var(--radius-lg);
    }
    
    .search-info {
      flex-direction: column;
      gap: 0.75rem;
    }
    
    .warehouse-card {
      padding: 1.5rem;
    }
    
    .delivery-timeline::before {
      left: 1.75rem;
    }
    
    .delivery-step::before {
      left: 1.75rem;
    }
    
    .delivery-step {
      gap: 1rem;
    }
    
    .step-icon {
      width: 2.75rem;
      height: 2.75rem;
      font-size: 1.1rem;
    }
    
    .section-header {
      flex-direction: column;
      align-items: flex-start;
      gap: 1rem;
      margin-bottom: 2rem;
    }
  }
 
  /* åŠ¨ç”»ä¼˜åŒ– */
  @keyframes slideIn {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
 
  .container-timeline {
    animation: slideIn 0.6s ease-out;
  }
 
  .warehouse-card {
    animation: slideIn 0.6s ease-out;
  }
 
  .delivery-step {
    animation: slideIn 0.4s ease-out;
  }
 
  /* æ‚¬åœæ•ˆæœå¢å¼º */
  .warehouse-card:hover .status-tag {
    transform: scale(1.05);
    box-shadow: var(--shadow-sm);
  }
 
  .warehouse-card:hover .alert-badge {
    transform: translateY(-1px);
    box-shadow: var(--shadow-sm);
  }
 
  /* åŠ è½½çŠ¶æ€ */
  .delivery-step:not(.active) {
    opacity: 0.7;
  }
 
  .delivery-step:not(.active):hover {
    opacity: 0.9;
    background: rgba(243, 244, 246, 0.9);
    box-shadow: var(--shadow-sm);
  }
 
  /* çŠ¶æ€å¾½ç« åŠ¨ç”» */
  .status-tag:hover::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
    animation: glow 3s infinite;
  }
 
  @keyframes glow {
    0% { transform: translateX(-100%); }
    100% { transform: translateX(100%); }
  }
 
  /* æ»šåŠ¨ä¼˜åŒ– */
  ::-webkit-scrollbar {
    width: 8px;
  }
 
  ::-webkit-scrollbar-track {
    background: var(--gray-100);
    border-radius: var(--radius-full);
  }
 
  ::-webkit-scrollbar-thumb {
    background: var(--gray-400);
    border-radius: var(--radius-full);
  }
 
  ::-webkit-scrollbar-thumb:hover {
    background: var(--gray-500);
  }
</style>

<script>
function switchContainer(containerNumber) {
    // éšè—æ‰€æœ‰æŸœå­æ—¶é—´çº¿
    document.querySelectorAll('.container-timeline').forEach(timeline => {
        timeline.classList.add('hidden');
    });
    
    // æ˜¾ç¤ºé€‰ä¸­çš„æŸœå­æ—¶é—´çº¿
    const selectedTimeline = document.getElementById(`container-${containerNumber}`);
    if (selectedTimeline) {
        selectedTimeline.classList.remove('hidden');
    }
    
    // æ›´æ–°æ ‡ç­¾çŠ¶æ€
    document.querySelectorAll('.container-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    event.target.classList.add('active');
}

// é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    // å¦‚æœæœ‰å¤šä¸ªæŸœå­ï¼Œé»˜è®¤æ˜¾ç¤ºç¬¬ä¸€ä¸ª
    const containerTabs = document.querySelectorAll('.container-tab');
    if (containerTabs.length > 0) {
        containerTabs[0].click();
    }
});
</script>
{% endblock %}