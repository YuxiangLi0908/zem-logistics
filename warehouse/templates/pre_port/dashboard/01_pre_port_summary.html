{% extends 'base.html' %}
{% block content %}
    <style>
        /* 全局样式调整 */
        body {
            background-color: #f5f7fa;
            font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
            line-height: 1.5;
        }

        /* 主容器 */
        .main-container {
            width: 102%;
            padding: 15px;
            box-sizing: border-box;
            max-width: 1920px;
            margin: 0 auto;
            margin-left: -1%;
        }

        /* 按钮样式优化 */
        .custom-btn {
            padding: 4px 12px;
            border: none;
            border-radius: 4px;
            background-color: #4096ff;
            color: #fff;
            font-size: 13px;
            cursor: pointer;
            vertical-align: middle;
            margin-left: 8px;
            transition: all 0.2s ease;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .custom-btn:hover {
            background-color: #69b1ff;
            box-shadow: 0 2px 8px rgba(64, 150, 255, 0.3);
            transform: translateY(-1px);
        }

        .custom-btn:active {
            background-color: #3385ff;
            transform: translateY(0);
            box-shadow: none;
        }

        .custom-btn:disabled {
            background-color: #c9c9c9;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* 导航栏样式 */
        .nav-tabs {
            border-bottom: 1px solid #e5e6eb;
            margin-bottom: 15px;
            background-color: #fff;
            padding: 0 15px;
            border-radius: 4px 4px 0 0;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
            display: flex;
            flex-wrap: wrap;
        }

        .nav-item {
            margin-bottom: -1px; /* 解决底部边框重叠问题 */
        }

        .nav-item .nav-link {
            color: #4e5969;
            border: none;
            margin-right: 5px;
            border-radius: 4px 4px 0 0;
            font-weight: 500;
            transition: all 0.2s ease;
            display: block;
            text-decoration: none;
        }

        .nav-item .nav-link.active {
            color: #4096ff;
            background-color: #f5f7fa;
            border-bottom: 2px solid #4096ff;
        }

        .nav-item .nav-link:hover:not(.active) {
            background-color: #f2f3f5;
            color: #4096ff;
        }

        /* 内容区域容器 */
        #order-info-sec {
            background-color: #fff;
            border-radius: 4px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
            overflow: hidden;
        }

        /* 搜索和批量操作区域 */
        .search-bar {
            padding: 15px;
            border-bottom: 1px solid #e5e6eb;
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
            background-color: #fafbfc;
        }

        .search-group {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .search-group b {
            color: #4e5969;
            font-size: 14px;
            white-space: nowrap;
        }

        .search-group input[type="date"] {
            padding: 6px 8px;
            border: 1px solid #dcdfe6;
            border-radius: 4px;
            font-size: 13px;
            min-width: 140px;
        }

        /* 批量操作按钮区域 */
        .batch-actions {
            margin: 0;
            padding: 0;
            background-color: transparent;
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .batch-actions .btn {
            padding: 6px 12px;
            font-size: 13px;
            transition: all 0.2s ease;
            text-decoration: none;
            border-radius: 4px;
            border: 1px solid transparent;
            cursor: pointer;
        }

        .batch-actions .btn-primary {
            background-color: #4096ff;
            border-color: #4096ff;
            color: white;
        }

        .batch-actions .btn-primary:hover {
            background-color: #69b1ff;
            border-color: #69b1ff;
        }

        .batch-actions .btn-success {
            background-color: #52c41a;
            border-color: #52c41a;
            color: white;
        }

        .batch-actions .btn-success:hover {
            background-color: #73d13d;
            border-color: #73d13d;
        }

        .batch-actions .btn-secondary {
            background-color: #f0f2f5;
            border-color: #f0f2f5;
            color: #4e5969;
        }

        .batch-actions .btn-secondary:hover {
            background-color: #e5e6eb;
        }

        .batch-actions .btn-warning {
            background-color: #faad14;
            border-color: #faad14;
            color: white;
        }

        .batch-actions .btn-warning:hover {
            background-color: #ffc53d;
            border-color: #ffc53d;
        }

        /* 表格样式优化 */
        .table {
            min-width: 1600px; /* 确保表格宽度足够触发横向滚动 */
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            font-size: 12px;
            margin-bottom: 0;
        }

        .table thead {
            background-color: #f5f7fa;
        }

        .table th, .table td {
            padding: 12px 10px;
            text-align: left;
            border-bottom: 1px solid #e5e6eb;
            word-break: break-all;
        }

        .table th {
            color: #4e5969;
            font-weight: 500;
            white-space: nowrap;
            position: relative;
        }

        .table th:after {
            content: '';
            position: absolute;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            height: 12px;
            width: 1px;
            background-color: #e5e6eb;
        }

        .table th:last-child:after {
            display: none;
        }

        .table tbody tr {
            transition: background-color 0.2s ease;
        }

        .table tbody tr:hover {
            background-color: #fafbfc;
        }

        /* 表格行高亮效果 */
        .table tbody tr.highlight {
            background-color: #fff7e6;
        }

        /* 复选框样式 */
        .checkbox-cell {
            text-align: center !important;
            vertical-align: middle;
            width: 50px;
        }

        .checkbox-cell input {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }

        /* 搜索输入框样式 */
        .table th input, .table th select {
            width: 100%;
            padding: 5px 8px;
            border: 1px solid #dcdfe6;
            border-radius: 3px;
            font-size: 11px;
            transition: border-color 0.2s ease;
        }

        .table th input:focus, .table th select:focus {
            border-color: #4096ff;
            outline: none;
            box-shadow: 0 0 0 2px rgba(64, 150, 255, 0.2);
        }

        /* 状态标签样式 */
        .status-span {
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 11px;
            display: inline-block;
            min-width: 60px;
            text-align: center;
        }

        .status-span-green {
            color: #52c41a;
            background-color: rgba(82, 196, 26, 0.1);
        }

        .status-span-red {
            color: #f5222d;
            background-color: rgba(245, 34, 45, 0.1);
        }

        .status-span-blue {
            color: #1890ff;
            background-color: rgba(24, 144, 255, 0.1);
        }

        .status-span-gray {
            color: #86909c;
            background-color: rgba(134, 144, 156, 0.1);
        }

        /* 链接样式 */
        .table a {
            color: #4096ff;
            text-decoration: none;
            transition: color 0.2s ease;
        }

        .table a:hover {
            color: #69b1ff;
            text-decoration: underline;
        }

        /* 备注输入框样式 */
        textarea[name="note_preport_dispatch"] {
            width: 100%;
            min-height: 50px;
            padding: 5px 8px;
            border: 1px solid #dcdfe6;
            border-radius: 3px;
            font-size: 12px;
            resize: vertical;
            transition: border-color 0.2s ease;
        }

        textarea[name="note_preport_dispatch"]:focus {
            border-color: #4096ff;
            outline: none;
            box-shadow: 0 0 0 2px rgba(64, 150, 255, 0.2);
        }

        /* 时间输入框样式 */
        .datetime-input {
            padding: 5px 8px;
            border: 1px solid #dcdfe6;
            border-radius: 3px;
            font-size: 12px;
            transition: all 0.2s;
            width: 160px;
        }

        .datetime-input:focus {
            border-color: #4096ff;
            box-shadow: 0 0 0 2px rgba(64, 150, 255, 0.1);
            outline: none;
        }

        .time-input-container {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
            width: 200px;
        }

        /* 复制成功提示 */
        .copy-toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #52c41a;
            color: white;
            padding: 8px 16px;
            border-radius: 4px;
            font-size: 13px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
            z-index: 1000;
        }

        .copy-toast.show {
            opacity: 1;
        }

        .copy-toast.error {
            background-color: #f5222d;
        }

        /* 批量操作弹窗样式 */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .modal-container {
            background-color: #fff;
            border-radius: 6px;
            width: 500px;
            max-width: 90%;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            transform: translateY(-20px);
            transition: transform 0.3s ease;
        }

        .modal-overlay.show .modal-container {
            transform: translateY(0);
        }

        .modal-header {
            padding: 15px 20px;
            border-bottom: 1px solid #e5e6eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 16px;
            font-weight: 500;
            color: #1f2329;
            margin: 0;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #86909c;
            transition: color 0.2s ease;
            padding: 0 5px;
        }

        .modal-close:hover {
            color: #1f2329;
        }

        .modal-body {
            padding: 20px;
        }

        .modal-footer {
            padding: 15px 20px;
            border-top: 1px solid #e5e6eb;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .modal-footer .btn {
            padding: 6px 16px;
            font-size: 13px;
        }

        /* 空状态样式 */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #86909c;
        }

        .empty-state i {
            font-size: 48px;
            margin-bottom: 15px;
            color: #d9d9d9;
        }

        .empty-state p {
            margin: 0;
            font-size: 14px;
        }

        /* 加载状态 */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .loading-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(64, 150, 255, 0.2);
            border-radius: 50%;
            border-top-color: #4096ff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* 响应式调整 */
        @media (max-width: 768px) {
            .search-bar {
                flex-direction: column;
                align-items: stretch;
            }

            .search-group {
                width: 100%;
            }

            .batch-actions {
                width: 100%;
                justify-content: flex-start;
            }

            .table th, .table td {
                padding: 8px 5px;
                font-size: 11px;
            }

            .datetime-input {
                width: 130px;
            }

            .custom-btn {
                padding: 3px 8px;
                font-size: 12px;
                margin-left: 4px;
            }
        }

        /* 表格容器样式 - 核心滚动区域 */
        .table-container {
            width: 100%;
            max-height: calc(100vh - 180px); /* 调整此值控制表格高度 */
            overflow: auto; /* 同时启用横向和纵向滚动 */
            -webkit-overflow-scrolling: touch;
            position: relative;
            height: 640px;
        }

        /* 表头固定 */
        .table thead tr:first-child {
            position: sticky;
            top: 0;
            z-index: 3;
        }

        .table thead tr:nth-child(2) {
            position: sticky;
            top: 42px; /* 与第一个表头行高度匹配 */
            z-index: 2;
        }

        /* 滚动条样式优化 */
        .table-container::-webkit-scrollbar {
            height: 8px;
            width: 8px;
        }

        .table-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .table-container::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }

        .table-container::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        /* 状态区域样式 */
        #status-summary-sec {
            padding-bottom: 10px;
            overflow: hidden; /* 避免与表格容器滚动冲突 */
        }

        /* 列宽调整 */
        .table th:nth-child(2), /* 柜号列 */
        .table td:nth-child(2) {
            min-width: 120px;
        }

        .table th:nth-child(3), /* 客户列 */
        .table td:nth-child(3) {
            min-width: 100px;
        }

        .table th:nth-child(4), /* 订单类型列 */
        .table td:nth-child(4) {
            min-width: 90px;
        }

        .table th:nth-child(5), /* 所属仓列 */
        .table td:nth-child(5) {
            min-width: 150px;
        }

        .table th:nth-child(6), /* T49状态列 */
        .table td:nth-child(6) {
            min-width: 140px;
        }

        .table th:nth-child(13), /* 货柜备注列 */
        .table td:nth-child(13) {
            min-width: 180px;
        }

        .table th:nth-child(14), /* 异常状态列 */
        .table td:nth-child(14) {
            min-width: 130px;
        }
    </style>
    <div class="main-container">
        <ul class="nav nav-tabs">
            <li class="nav-item">
                <a {% if tab == "summary" %}class="nav-link active"{% else %}class="nav-link"{% endif %}
                   href="javascript:showSection(this, 'status-summary-sec')">
                    货柜进度汇总
                </a>
            </li>
        </ul>

        <div id="order-info-sec">
            <div id="status-summary-sec">
                <!-- 搜索和批量操作区域 -->
                <div class="search-bar">
                    <form method="post" action="" id="searchForm">
                        {% csrf_token %}
                        <div class="search-group">
                            <b>ETA: </b>
                            <input type="date" name="start_date_eta" value="{{ start_date_eta }}"
                                   title="开始日期">
                            <span style="color: #86909c;">至</span>
                            <input type="date" name="end_date_eta" value="{{ end_date_eta }}"
                                   title="结束日期">
                            <button type="submit" name="step" value="search_orders" class="btn btn-primary"
                                    title="查询数据">查询
                            </button>
                            <button type="submit" name="step" value="download_eta_file" class="btn btn-secondary"
                                    title="导出当前数据">导出
                            </button>
                        </div>
                    </form>

                    <form action="" method="post" style="display: inline; margin-left:-500px;">
                        {% csrf_token %}
                        <input type="hidden" name="start_date" value="{{ start_date|default:'' }}">
                        <input type="hidden" name="end_date" value="{{ end_date|default:'' }}">
                        <button type="submit" name="step" value="get_is_abnormal_state"
                                class="btn btn-warning"
                                style="transition: all 0.2s ease;"
                                title="筛选所有标记为异常的数据">
                            <i class="bi bi-exclamation-triangle"></i> 筛选所有异常数据
                        </button>
                    </form>

                    <!-- 批量操作按钮区域 -->
                    <div class="batch-actions">
                        <button id="batchActionBtn" class="btn btn-primary" disabled
                                title="查看已选项详情">
                            批量操作（已选 <span id="selectedCount">0</span> 项）
                        </button>
                        <button id="copyContainersBtn" class="btn btn-success" disabled
                                title="复制选中的柜号">
                            复制柜号到剪贴板
                        </button>
                        <button id="exportSelectedBtn" class="btn btn-secondary" disabled
                                title="跳转到港口提柜页面">
                            批量跳转港口提柜
                        </button>
                        <button id="batchSetOffloadBtn" class="btn btn-warning" disabled
                                title="统一设置拆柜时间">
                            批量设置拆柜时间
                        </button>
                    </div>
                </div>

                <!-- 表格内容 - 包裹在滚动容器中 -->
                <div class="table-container">
                    <table class="table">
                        <thead>
                        <tr>
                            <th class="th checkbox-cell">
                                <input type="checkbox" id="selectAll"
                                       style="width: 16px; height: 16px; vertical-align: middle;"
                                       title="全选/取消全选">
                            </th>
                            <th class="th">柜号</th>
                            <th class="th">客户</th>
                            <th class="th">订单类型</th>
                            <th class="th">所属仓/直送地址</th>
                            <th class="th">T49参考状态</th>
                            <th class="th">实际放行时间</th>
                            <th class="th">预计提柜时间</th>
                            <th class="th">实际提柜</th>
                            <th class="th">提柜安排</th>
                            <th class="th">拆柜时间</th>
                            <th class="th">还空状态</th>
                            <th class="th">港前完结</th>
                            <th class="th">货柜备注</th>
                            <th class="th">异常状态</th>
                            <th class="th">LFD</th>
                        </tr>
                        <tr style="background-color: #f9fafb;">
                            <th class="th checkbox-cell"></th>
                            <th class="th">
                                <input type="text" placeholder="搜索柜号..."
                                       oninput="filterTable(this)"
                                       size="13" style="font-size: 11px;"
                                       data-col="1"
                                       title="输入柜号关键词搜索">
                            </th>
                            <th class="th">
                                <select name="customer" onchange="filterTable(this)" data-col="2"
                                        title="选择客户筛选">
                                    <option value="" selected></option>
                                    {% for k, v in customers.items %}
                                        <option value="{{ v }}">{{ k }}</option>
                                    {% endfor %}
                                </select>
                            </th>
                            <th class="th">
                                <input type="text" placeholder="搜索订单类型..."
                                       oninput="filterTable(this)"
                                       size="13" style="font-size: 11px;"
                                       data-col="3"
                                       title="输入订单类型关键词搜索">
                            </th>
                            <th class="th">
                                <input type="text" placeholder="搜索仓库..."
                                       oninput="filterTable(this)"
                                       size="13" style="font-size: 11px;"
                                       data-col="4"
                                       title="输入仓库关键词搜索">
                            </th>
                            <th class="th">
                                <input type="text" placeholder="搜索T49状态参考..."
                                       oninput="filterTable(this)"
                                       size="13" style="font-size: 11px; width: 200px;"
                                       data-col="5"
                                       title="输入T49状态参考关键词搜索">
                            </th>
                            <th class="th">
                                <input type="text" placeholder="搜索计划放行时间..."
                                       oninput="filterTable(this)"
                                       size="13" style="font-size: 11px; width: 150px;"
                                       data-col="6"
                                       title="输入计划放行时间关键词搜索">
                            </th>
                            <th class="th">
                                <input type="text" placeholder="搜索预计提柜时间..."
                                       oninput="filterTable(this)"
                                       size="13" style="font-size: 11px; width: 90px;"
                                       data-col="7"
                                       title="输入预计提柜时间关键词搜索">
                            </th>

                            <th class="th">
                                <input type="text" placeholder="搜索实际提柜..."
                                       oninput="filterTable(this)"
                                       size="13" style="font-size: 11px;"
                                       data-col="8"
                                       title="输入实际提柜时间关键词搜索">
                            </th>
                            <th class="th">
                                <input type="text" placeholder="搜索提柜安排..."
                                       oninput="filterTable(this)"
                                       size="13" style="font-size: 11px;"
                                       data-col="9"
                                       title="输入提柜安排关键词搜索">
                            </th>
                            <th class="th">
                                <input type="text" placeholder="搜索拆柜时间..."
                                       oninput="filterTable(this)"
                                       size="13" style="font-size: 11px;"
                                       data-col="10"
                                       title="输入拆柜时间关键词搜索">
                            </th>
                            <th class="th">
                                <input type="text" placeholder="搜索还空状态..."
                                       oninput="filterTable(this)"
                                       size="13" style="font-size: 11px;"
                                       data-col="11"
                                       title="输入还空状态关键词搜索">
                            </th>
                            <th class="th">
                                <input type="text" placeholder="搜索港前完结..."
                                       oninput="filterTable(this)"
                                       size="13" style="font-size: 11px;"
                                       data-col="12"
                                       title="输入港前完结状态关键词搜索">
                            </th>
                            <th class="th">
                                <input type="text" placeholder="搜索货柜备注..."
                                       oninput="filterTable(this)"
                                       size="13" style="font-size: 11px; width: 200px;"
                                       data-col="13"
                                       title="输入货柜备注关键词搜索">
                            </th>
                            <th>
                                <input type="text" style="width: 100px;">
                            </th>
                            <th class="th">
                                <input type="text" placeholder="搜索LFD..."
                                       oninput="filterTable(this)"
                                       size="13" style="font-size: 11px; width: 100px;"
                                       data-col="15"
                                       title="输入LFD关键词搜索">
                            </th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for o in orders %}
                            <tr {% if o.container_number.is_abnormal_state %}class="highlight"{% endif %}>
                                <td class="td checkbox-cell">
                                    <input type="checkbox" class="rowCheckbox"
                                           style="width: 16px; height: 16px; vertical-align: middle;"
                                           data-container="{{ o.container_number.container_number }}"
                                           data-id="{{ o.id }}"
                                           data-offload-id="{{ o.offload_id.offload_id }}"
                                           title="选择此项">
                                </td>
                                <td class="td">
                                    <a href="/create_order/?step=order_management_container&container_number={{ o.container_number.container_number }}"
                                       target="_blank"
                                       title="点击查看详情: {{ o.container_number.container_number }}">
                                        {{ o.container_number.container_number }}
                                    </a>
                                </td>
                                <td class="td">{{ o.customer_name.zem_name }}</td>
                                <td class="td">{{ o.order_type }}</td>
                                <td class="td">{{ o.retrieval_id.retrieval_destination_area }}</td>
                                <td data-column="reference_status_t49">
                                    {% if o.retrieval_id.t49_empty_returned_at %}
                                        <!-- 存储UTC时间戳到data属性，用于前端转换 -->
                                        <span class="utc-time"
                                              data-utc="{{ o.retrieval_id.t49_empty_returned_at|date:'c' }}">
                                            T49还空 {{ o.retrieval_id.t49_empty_returned_at|date:'Y-m-d H:i:s' }}
                                        </span>
                                    {% elif o.retrieval_id.t49_pod_full_out_at %}
                                        <span class="utc-time"
                                              data-utc="{{ o.retrieval_id.t49_pod_full_out_at|date:'c' }}">
                                            T49提柜 {{ o.retrieval_id.t49_pod_full_out_at|date:'Y-m-d H:i:s' }}
                                        </span>
                                    {% elif o.retrieval_id.temp_t49_available_for_pickup %}
                                        放行状态 {{ o.retrieval_id.temp_t49_available_for_pickup }}
                                    {% else %}
                                        <span style="color: #dc3545;">放行状态 ×</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if o.retrieval_id.planned_release_time %}
                                        <span class="status-span status-span-green">
                                        {{ o.retrieval_id.planned_release_time|date:"Y-m-d" }}
                                    </span>
                                    {% else %}
                                        <span class="status-span status-span-red">无计划放行时间</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if o.retrieval_id.target_retrieval_timestamp_lower or o.retrieval_id.target_retrieval_timestamp %}
                                        <span class="status-span status-span-green">
                                        {{ o.retrieval_id.target_retrieval_timestamp_lower|date:"M-j" }} - {{ o.retrieval_id.target_retrieval_timestamp|date:"M-j" }}
                                    </span>
                                    {% else %}
                                        <span class="status-span status-span-red">无提柜计划</span>
                                    {% endif %}
                                </td>

                                <td>
                                    {% if o.retrieval_id.actual_retrieval_timestamp %}
                                        <span class="status-span status-span-green">{{ o.retrieval_id.actual_retrieval_timestamp|date:"M-j" }}</span>
                                    {% else %}
                                        <span class="status-span status-span-gray">未提柜</span>
                                    {% endif %}
                                </td>
                                <td class="td">
                                    <form action="" method="post" class="inline-form">
                                        {% csrf_token %}
                                        <div class="time-input-container">
                                            <input type="hidden" name="step"
                                                   value="get_retrieval_cabinet_arrangement_time">
                                            <input type="hidden" name="start_date" value="{{ start_date|default:'' }}">
                                            <input type="hidden" name="end_date" value="{{ end_date|default:'' }}">
                                            <input type="hidden" name="start_date_eta"
                                                   value="{{ start_date_eta|default:'' }}">
                                            <input type="hidden" name="end_date_eta"
                                                   value="{{ end_date_eta|default:'' }}">
                                            <input type="hidden" name="retrieval_id"
                                                   value="{{ o.retrieval_id.retrieval_id }}">
                                            <input type="datetime-local"
                                                   value=" {% if o.retrieval_id.generous_and_wide_target_retrieval_timestamp%}
                                                            {{ o.retrieval_id.generous_and_wide_target_retrieval_timestamp|date:'Y-m-d\TH:i' }}
                                                            {% elif o.retrieval_id.retrieval_cabinet_arrangement_time %}
                                                            {{ o.retrieval_id.retrieval_cabinet_arrangement_time|date:'Y-m-d\TH:i' }}
                                                            {% endif %}"
                                                   class="datetime-input"
                                                   name="retrieval_cabinet_arrangement_time"
                                                   placeholder="选择日期时间"
                                                   title="设置提柜安排时间">
                                            <button type="submit" class="custom-btn"
                                                    style="padding: 4px;margin-top: -45px;margin-left: 166px;font-size: 13px"
                                                    title="确认提柜安排时间">
                                                确认
                                            </button>
                                        </div>
                                    </form>
                                </td>
                                <td class="td">
                                    <form action="" method="post" class="inline-form">
                                        {% csrf_token %}
                                        <div class="time-input-container">
                                            <input type="hidden" name="step" value="get_offload_at">
                                            <input type="hidden" name="start_date" value="{{ start_date|default:'' }}">
                                            <input type="hidden" name="end_date" value="{{ end_date|default:'' }}">
                                            <input type="hidden" name="start_date_eta"
                                                   value="{{ start_date_eta|default:'' }}">
                                            <input type="hidden" name="end_date_eta"
                                                   value="{{ end_date_eta|default:'' }}">
                                            <input type="hidden" name="offload_id"
                                                   value="{{ o.offload_id.offload_id }}">
                                            <input type="datetime-local"
                                                   value="

                                                           {% if o.offload_id.offload_at %}{{ o.offload_id.offload_at|date:'Y-m-d\TH:i' }}{% endif %}"
                                                   class="datetime-input"
                                                   name="offload_at"
                                                   placeholder="选择日期时间"
                                                   title="设置拆柜时间">
                                            <button type="submit" class="custom-btn"
                                                    style="padding: 4px;margin-top: -45px;margin-left: 166px;font-size: 13px"
                                                    title="确认拆柜时间">
                                                确认
                                            </button>
                                        </div>
                                    </form>
                                </td>
                                <td>
                                    {% if o.retrieval_id.empty_returned %}
                                        <span class="status-span status-span-green">{{ o.retrieval_id.empty_returned_at|date:"M-j" }}</span>
                                    {% else %}
                                        <span class="status-span status-span-gray">未还空</span>
                                    {% endif %}
                                </td>
                                <td class="td">
                                    {% if o.retrieval_id.empty_returned %}
                                        <span class="status-span status-span-green"><i class="bi bi-check-square"></i> 已完结</span>
                                    {% else %}
                                        <span class="status-span status-span-red"><i class="bi bi-x-square"></i> 未完结</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <form action="" method="post" class="inline-form">
                                        {% csrf_token %}
                                        <input type="hidden" name="step" value="get_note_preport_dispatch">
                                        <input type="hidden" name="start_date" value="{{ start_date|default:'' }}">
                                        <input type="hidden" name="end_date" value="{{ end_date|default:'' }}">
                                        <input type="hidden" name="start_date_eta"
                                               value="{{ start_date_eta|default:'' }}">
                                        <input type="hidden" name="end_date_eta" value="{{ end_date_eta|default:'' }}">
                                        <input type="hidden" name="retrieval_id"
                                               value="{{ o.retrieval_id|default:'' }}">
                                        <div style="display: flex; gap: 8px; align-items: flex-end;">
                                        <textarea
                                                name="note_preport_dispatch"
                                                style="flex: 1; min-height: 50px;"
                                                title="输入货柜备注信息"
                                        >{{ o.retrieval_id.note_preport_dispatch|default:'' }}</textarea>
                                            <button type="submit" class="custom-btn"
                                                    style="font-size: 13px;padding: 4px;"
                                                    title="保存货柜备注">
                                                确认
                                            </button>
                                        </div>
                                    </form>
                                </td>
                                <td>
                                    <form action="" method="post" class="inline-form">
                                        {% csrf_token %}
                                        <input type="hidden" name="container_number"
                                               value="{{ o.container_number.container_number }}">
                                        <input type="hidden" name="step" value="save_is_abnormal_state">
                                        <input type="hidden" name="start_date_eta"
                                               value="{{ start_date_eta|default:'' }}">
                                        <input type="hidden" name="end_date_eta" value="{{ end_date_eta|default:'' }}">
                                        <!-- 异常状态单选框：当 is_abnormal_state 为 True 时选中 -->
                                        <label>
                                            <input type="radio" name="is_abnormal_state" value="True"
                                                   {% if o.container_number.is_abnormal_state %}checked{% endif %}
                                                   title="标记为异常状态">
                                            异常
                                        </label>
                                        <!-- 正常状态单选框：当 is_abnormal_state 为 False 时选中 -->
                                        <label style="margin-left: 10px;">
                                            <input type="radio" name="is_abnormal_state" value="False"
                                                   {% if not o.container_number.is_abnormal_state %}checked{% endif %}
                                                   title="标记为正常状态">
                                            正常
                                        </label>
                                        <button type="submit" class="custom-btn" style="margin-left: 10px;"
                                                title="确认状态设置">
                                            确认
                                        </button>
                                    </form>
                                </td>
                                <td>
                                    {% if o.retrieval_id.temp_t49_lfd %}
                                        <!-- 添加utc-time类和data-utc属性存储原始UTC时间 -->
                                        <span class="status-span status-span-green utc-time"
                                              data-utc="{{ o.retrieval_id.temp_t49_lfd|date:'c' }}">
                                            {{ o.retrieval_id.temp_t49_lfd|date:'Y-m-d H:i:s' }}
                                        </span>
                                    {% else %}
                                        <span class="status-span status-span-gray">-</span>
                                    {% endif %}
                                </td>
                            </tr>
                        {% empty %}
                            <tr>
                                <td colspan="15" class="empty-state">
                                    <i class="bi bi-box-seam"></i>
                                    <p>暂无符合条件的数据</p>
                                    <p style="margin-top: 10px;">请尝试调整筛选条件或日期范围</p>
                                </td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            <div id="dispatch-summary-sec" style="display: none;">

            </div>
        </div>
    </div>

    <!-- 复制成功提示框 -->
    <div class="copy-toast" id="copyToast">复制成功！</div>

    <!-- 批量设置拆柜时间弹窗 -->
    <div class="modal-overlay" id="batchOffloadModal">
        <div class="modal-container">
            <div class="modal-header">
                <h3 class="modal-title">批量设置拆柜时间</h3>
                <button class="modal-close" id="closeModal">&times;</button>
            </div>
            <div class="modal-body">
                <div id="batchOffloadForm">
                    <!-- 时间输入框 -->
                    <div class="form-group">
                        <label style="display: block; margin-bottom: 8px; color: #4e5969; font-size: 14px;">
                            拆柜时间：
                        </label>
                        <input type="datetime-local"
                               class="datetime-input"
                               id="batchOffloadTime"
                               required
                               style="width: 100%; padding: 8px; font-size: 13px;"
                               title="选择拆柜时间">
                    </div>

                    <div style="margin-top: 15px; color: #86909c; font-size: 12px;">
                        <span id="selectedContainersCount">0</span> 个柜号将被设置为该拆柜时间
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="cancelBatchOffload">取消</button>
                <button type="button" class="btn btn-primary" id="confirmBatchOffload">确认设置</button>
            </div>
        </div>
    </div>

    <!-- 加载状态指示器 -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
    </div>

    <script>
        // 显示加载状态
        function showLoading() {
            document.getElementById('loadingOverlay').classList.add('show');
        }

        // 隐藏加载状态
        function hideLoading() {
            document.getElementById('loadingOverlay').classList.remove('show');
        }

        // 页面加载和表单提交时显示加载状态
        document.addEventListener('DOMContentLoaded', function () {
            // 为所有表单添加加载状态
            const forms = document.querySelectorAll('form');
            forms.forEach(form => {
                form.addEventListener('submit', function () {
                    showLoading();
                });
            });
        });

        function showSection(navItem, secId) {
            const navLinks = document.querySelectorAll('.nav-link');
            navLinks.forEach(link => {
                link.classList.remove('active')
            });
            navItem.classList.add('active');

            const sections = document.querySelectorAll('#order-info-sec > div');
            sections.forEach(section => {
                section.style.display = section.id === secId ? "" : "none";
            });
        };

        function filterTable(filterInput) {
            var table = filterInput.closest('table');
            var tbody = table.getElementsByTagName("tbody")[0];
            var tr = tbody.getElementsByTagName("tr");

            var filters = document.querySelectorAll('thead input[type="text"], thead select');
            var filterValues = Array.from(filters).map(function (filter) {
                var colIdx = parseInt(filter.dataset.col, 10);
                if (colIdx === 1) {  // 柜号列
                    return filter.value.toUpperCase().split(/\s+/).filter(Boolean);
                } else {
                    return [filter.value.toUpperCase().trim()];
                }
            });

            let visibleCount = 0;
            for (var i = 0; i < tr.length; i++) {
                var row = tr[i];
                var showRow = true;

                filters.forEach(function (filter, idx) {
                    var colIdx = parseInt(filter.dataset.col, 10);
                    var filterValueList = filterValues[idx];
                    var cell = row.getElementsByTagName("td")[colIdx];

                    if (cell && filterValueList.length > 0 && filterValueList[0] !== "") {
                        var cellText = cell.textContent || cell.innerText;
                        var cellValue = cellText.toUpperCase().trim();

                        if (colIdx === 1) {  // 柜号列特殊处理
                            var matchFound = filterValueList.some(function (filterValue) {
                                return cellValue.includes(filterValue) || filterValue.includes(cellValue);
                            });
                            if (!matchFound) showRow = false;
                        } else {
                            if (cellValue.indexOf(filterValueList[0]) === -1) showRow = false;
                        }
                    }
                });

                row.style.display = showRow ? "" : "none";
                if (showRow) visibleCount++;
            }

            // 处理空状态显示
            const emptyState = document.querySelector('.empty-state').parentNode.parentNode;
            if (visibleCount === 0 && tr.length > 0) {
                emptyState.style.display = "";
            } else {
                emptyState.style.display = "none";
            }

            updateSelectAllStatus();
        };

        document.addEventListener('DOMContentLoaded', function () {
            const selectAllCheckbox = document.getElementById('selectAll');
            const rowCheckboxes = document.querySelectorAll('.rowCheckbox');
            const selectedCountElement = document.getElementById('selectedCount');
            const batchActionBtn = document.getElementById('batchActionBtn');
            const exportSelectedBtn = document.getElementById('exportSelectedBtn');
            const copyContainersBtn = document.getElementById('copyContainersBtn');
            const copyToast = document.getElementById('copyToast');

            // 批量设置拆柜时间相关元素
            const batchSetOffloadBtn = document.getElementById('batchSetOffloadBtn');
            const batchOffloadModal = document.getElementById('batchOffloadModal');
            const closeModal = document.getElementById('closeModal');
            const cancelBatchOffload = document.getElementById('cancelBatchOffload');
            const confirmBatchOffload = document.getElementById('confirmBatchOffload');
            const batchOffloadTime = document.getElementById('batchOffloadTime');
            const selectedContainersCount = document.getElementById('selectedContainersCount');
            let selectedOffloadIds = []; // 存储选中的offload_id

            // 全选/取消全选
            selectAllCheckbox.addEventListener('change', function () {
                const isChecked = this.checked;
                document.querySelectorAll('tr:not([style="display: none;"]) .rowCheckbox').forEach(checkbox => {
                    checkbox.checked = isChecked;
                });
                updateSelectedCount();
            });

            // 行复选框变化
            rowCheckboxes.forEach(checkbox => {
                checkbox.addEventListener('change', function () {
                    updateSelectAllStatus();
                    updateSelectedCount();
                });
            });

            // 更新已选数量和按钮状态
            function updateSelectedCount() {
                const selectedItems = Array.from(document.querySelectorAll('.rowCheckbox:checked'));
                const selectedCount = selectedItems.length;
                selectedCountElement.textContent = selectedCount;

                // 存储选中的offload_id
                selectedOffloadIds = selectedItems.map(checkbox => checkbox.getAttribute('data-offload-id')).filter(Boolean);

                // 更新所有批量按钮状态
                batchActionBtn.disabled = selectedCount === 0;
                exportSelectedBtn.disabled = selectedCount === 0;
                copyContainersBtn.disabled = selectedCount === 0;
                batchSetOffloadBtn.disabled = selectedCount === 0;
            }

            // 更新全选状态
            function updateSelectAllStatus() {
                const visibleCheckboxes = document.querySelectorAll('tr:not([style="display: none;"]) .rowCheckbox');
                const checkedCheckboxes = document.querySelectorAll('tr:not([style="display: none;"]) .rowCheckbox:checked');
                selectAllCheckbox.checked = visibleCheckboxes.length > 0 &&
                    visibleCheckboxes.length === checkedCheckboxes.length;
            }

            // 批量操作按钮
            batchActionBtn.addEventListener('click', function () {
                const selectedItems = Array.from(document.querySelectorAll('.rowCheckbox:checked'))
                    .map(checkbox => checkbox.getAttribute('data-container'));
                if (selectedItems.length > 0) {
                    alert(`已选择 ${selectedItems.length} 个柜号：\n${selectedItems.join(', ')}`);
                }
            });

            // 复制柜号到剪贴板功能
            copyContainersBtn.addEventListener('click', function () {
                const selectedContainers = Array.from(document.querySelectorAll('.rowCheckbox:checked'))
                    .map(checkbox => checkbox.getAttribute('data-container'));

                if (selectedContainers.length === 0) {
                    showToast('请先选择要复制的柜号', 'error');
                    return;
                }

                const textToCopy = selectedContainers.join('\n');
                navigator.clipboard.writeText(textToCopy).then(() => {
                    showToast('复制成功！');
                }).catch(err => {
                    console.error('复制失败:', err);
                    showToast('复制失败，请手动复制', 'error');
                });
            });

            // 显示提示消息
            function showToast(message, type = 'success') {
                const toast = document.getElementById('copyToast');
                toast.textContent = message;
                toast.className = 'copy-toast';
                if (type === 'error') {
                    toast.classList.add('error');
                }
                toast.classList.add('show');

                setTimeout(() => {
                    toast.classList.remove('show');
                }, 2000);
            }

            // 批量跳转港口提柜
            exportSelectedBtn.addEventListener('click', function () {
                const selectedContainers = Array.from(document.querySelectorAll('.rowCheckbox:checked'))
                    .map(checkbox => checkbox.getAttribute('data-container'));

                if (selectedContainers.length === 0) {
                    showToast('请先选择要操作的柜号', 'error');
                    return;
                }

                const form = document.createElement('form');
                form.method = 'GET';
                form.action = '/terminal_dispatch/';

                const stepInput = document.createElement('input');
                stepInput.type = 'hidden';
                stepInput.name = 'step';
                stepInput.value = 'batch_confirm_pickup_v1';
                form.appendChild(stepInput);

                selectedContainers.forEach(container => {
                    const containerInput = document.createElement('input');
                    containerInput.type = 'hidden';
                    containerInput.name = 'containers[]';
                    containerInput.value = container;
                    form.appendChild(containerInput);
                });

                const dateParams = ['start_date_eta', 'end_date_eta'];
                dateParams.forEach(param => {
                    const dateInput = document.createElement('input');
                    dateInput.type = 'hidden';
                    dateInput.name = param;
                    dateInput.value = document.querySelector(`[name="${param}"]`)?.value || '';
                    form.appendChild(dateInput);
                });

                document.body.appendChild(form);
                showLoading(); // 显示加载状态
                form.submit();
            });

            // 批量设置拆柜时间 - 打开弹窗
            batchSetOffloadBtn.addEventListener('click', function () {
                // 显示选中数量
                selectedContainersCount.textContent = selectedOffloadIds.length;
                // 清空之前的时间输入
                batchOffloadTime.value = '';
                // 显示弹窗
                batchOffloadModal.classList.add('show');
                // 设置焦点
                batchOffloadTime.focus();
            });

            // 批量设置拆柜时间 - 关闭弹窗
            function closeBatchOffloadModal() {
                batchOffloadModal.classList.remove('show');
            }

            closeModal.addEventListener('click', closeBatchOffloadModal);
            cancelBatchOffload.addEventListener('click', closeBatchOffloadModal);

            // 点击弹窗外部关闭
            batchOffloadModal.addEventListener('click', function (e) {
                if (e.target === batchOffloadModal) {
                    closeBatchOffloadModal();
                }
            });

            // 批量设置拆柜时间 - 确认提交（POST方式）
            confirmBatchOffload.addEventListener('click', function () {
                // 验证时间是否选择
                const offloadTime = batchOffloadTime.value;
                if (!offloadTime) {
                    showToast('请选择拆柜时间', 'error');
                    return;
                }

                // 验证是否有选中的offload_id
                if (selectedOffloadIds.length === 0) {
                    showToast('未选择任何货柜，请先选择', 'error');
                    return;
                }

                // 创建表单元素
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = '/contaier_pre_port_summary_dash/';

                // 添加CSRF令牌（POST请求必须）
                const csrfInput = document.createElement('input');
                csrfInput.type = 'hidden';
                csrfInput.name = 'csrfmiddlewaretoken';
                csrfInput.value = document.querySelector('[name="csrfmiddlewaretoken"]').value;
                form.appendChild(csrfInput);

                // 添加操作标识
                const stepInput = document.createElement('input');
                stepInput.type = 'hidden';
                stepInput.name = 'step';
                stepInput.value = 'batch_get_offload_at';
                form.appendChild(stepInput);

                // 添加拆柜时间
                const timeInput = document.createElement('input');
                timeInput.type = 'hidden';
                timeInput.name = 'offload_at';
                timeInput.value = offloadTime;
                form.appendChild(timeInput);

                // 添加所有选中的offload_id（数组形式）
                selectedOffloadIds.forEach(id => {
                    const idInput = document.createElement('input');
                    idInput.type = 'hidden';
                    idInput.name = 'offload_ids[]';
                    idInput.value = id;
                    form.appendChild(idInput);
                });

                // 添加筛选条件参数（保持页面状态）
                const dateParams = ['start_date', 'end_date', 'start_date_eta', 'end_date_eta'];
                dateParams.forEach(param => {
                    const value = document.querySelector(`[name="${param}"]`)?.value || '';
                    if (value) {
                        const paramInput = document.createElement('input');
                        paramInput.type = 'hidden';
                        paramInput.name = param;
                        paramInput.value = value;
                        form.appendChild(paramInput);
                    }
                });

                // 提交表单
                document.body.appendChild(form);
                showLoading(); // 显示加载状态
                form.submit();
            });

            // 初始化计数
            updateSelectedCount();

            // 为所有输入框添加回车键提交功能
            const inputs = document.querySelectorAll('input, select');
            inputs.forEach(input => {
                input.addEventListener('keydown', function (e) {
                    if (e.key === 'Enter') {
                        // 阻止默认行为避免表单重复提交
                        e.preventDefault();
                        // 触发筛选
                        if (this.hasAttribute('data-col')) {
                            filterTable(this);
                        }
                    }
                });
            });
        });
        // 页面加载完成后执行时间转换
        document.addEventListener('DOMContentLoaded', function () {
            // 转换所有带utc-time类的元素
            document.querySelectorAll('.utc-time').forEach(function (element) {
                const utcTimeStr = element.getAttribute('data-utc');
                if (utcTimeStr) {
                    // 解析UTC时间
                    const utcDate = new Date(utcTimeStr);
                    // 转换为本地时间并格式化
                    const localTimeStr = formatLocalTime(utcDate);
                    // 更新显示内容（保留前缀，只替换时间部分）
                    const originalText = element.textContent;
                    const prefix = originalText.replace(/\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}/, '');
                    element.textContent = prefix + localTimeStr;
                }
            });
        });

        // 格式化本地时间为 "YYYY-MM-DD HH:MM:SS"
        function formatLocalTime(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0'); // 月份从0开始
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            const seconds = String(date.getSeconds()).padStart(2, '0');
            return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
        }
    </script>
{% endblock %}