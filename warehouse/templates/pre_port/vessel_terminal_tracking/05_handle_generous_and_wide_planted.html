{% extends "base.html" %}
{% block content %}
<div class="container_main" style="padding: 20px; max-width: 1200px; margin: 60px auto;">
    <div class="page-header" style="margin-bottom: 30px; padding-bottom: 15px; border-bottom: 1px solid #f0f0f0;">
        <h3 style="margin: 0 0 20px; color: #333; font-weight: 600;">
            <i class="layui-icon layui-icon-clock" style="margin-right: 8px; color: #1E9FFF;"></i>
            大方广提柜时间管理
        </h3>
        <p style="margin: 8px 0 15px; color: #666; font-size: 14px;">
            管理LA区域柜号的预计提柜时间，精确到秒级
        </p>

        <div style="display: flex; align-items: center; max-width: 600px;">
            <input type="text"
                   id="containerSearch"
                   placeholder="搜索柜号（多个柜号用空格分隔）"
                   style="flex: 1; padding: 10px 15px; height: 38px; border-radius: 4px 0 0 4px; border: 1px solid #e6e6e6; outline: none; transition: border-color 0.2s;">
            <button id="searchBtn"
                    style="background-color: #1E9FFF; color: white; border: none; padding: 0 20px; height: 38px; border-radius: 0 4px 4px 0; cursor: pointer; transition: background-color 0.2s;">
                <i class="layui-icon layui-icon-search"></i> 搜索
            </button>
            <button id="resetBtn"
                    style="margin-left: 10px; background-color: #f5f5f5; color: #666; border: 1px solid #e6e6e6; padding: 0 15px; height: 38px; border-radius: 4px; cursor: pointer; transition: all 0.2s;">
                <i class="layui-icon layui-icon-refresh"></i> 重置
            </button>
        </div>
        <p style="margin: 8px 0 0; color: #999; font-size: 12px;">
            示例：输入 "CSNU8205429 MSCU1234567" 可同时搜索多个柜号
        </p>
    </div>

    {% if messages %}
    {% for message in messages %}
    <div style="
        margin-bottom: 20px;
        padding: 12px 15px;
        border-radius: 4px;
        {% if message.tags == 'success' %}
            background-color: #f6ffed;
            border: 1px solid #b7eb8f;
            color: #52c41a;
        {% else %}
            background-color: #fff2f0;
            border: 1px solid #ffccc7;
            color: #f5222d;
        {% endif %}
    ">
        <i class="layui-icon {% if message.tags == 'success' %}layui-icon-ok-circle{% else %}layui-icon-error-circle{% endif %}"></i>
        {{ message }}
    </div>
    {% endfor %}
    {% endif %}

    <div id="searchStats" style="margin-bottom: 15px; color: #666; font-size: 13px; display: none;">
        找到 <span id="matchCount" style="color: #1E9FFF; font-weight: 600;">0</span> 个匹配结果（共 <span id="totalCount">0</span> 个柜号）
    </div>

    <div class="table-container" style="background: #fff; border-radius: 4px; box-shadow: 0 2px 12px rgba(0, 0, 0, 0.05); overflow: hidden;">
        <table class="layui-table" lay-size="sm" style="margin: 0; border: none;">
            <thead>
                <tr style="background-color: #f5f7fa; color: #333;">
                    <th style="width: 30%; padding: 12px 15px; border-bottom: 1px solid #eee; text-align: center;">
                        柜号
                    </th>
                    <th style="width: 70%; padding: 12px 15px; border-bottom: 1px solid #eee; text-align: center;">
                        大方广预计提柜时间
                    </th>
                </tr>
            </thead>
            <tbody id="containerTableBody">
                {% for order in orders %}
                <tr class="container-row" style="transition: background-color 0.2s;" onmouseover="this.style.backgroundColor='#fafafa'" onmouseout="this.style.backgroundColor=''">
                    <td style="padding: 15px; border-bottom: 1px solid #f0f0f0; text-align: center; vertical-align: middle;">
                        <div class="container-number" style="font-weight: 500; color: #333;">
                            {{ order.container_number.container_number }}
                        </div>
                    </td>
                    <td style="padding: 15px; border-bottom: 1px solid #f0f0f0; vertical-align: middle;">
                        <form method="post" action="" class="layui-form" style="margin: 0; display: flex; align-items: center; gap: 10px; flex-wrap: wrap; justify-content: center;">
                            {% csrf_token %}
                            <input type="hidden" name="order_id" value="{{ order.id }}">
                            <input type="hidden" name="container_number" value="{{ order.container_number.container_number }}">
                            <input type="hidden" name="retrieval_id" value="{{ order.retrieval_id.retrieval_id }}">
                            <input type="hidden" name="step" value="generous_and_wide_target_retrieval_timestamp_save">

                            <div style="flex: 1; min-width: 220px;">
                                <input type="datetime-local"
                                       name="generous_and_wide_target_retrieval_timestamp"
                                       class="layui-input"
                                       step="1"
                                       {% if order.retrieval_id.generous_and_wide_target_retrieval_timestamp %}
                                       value="{{ order.retrieval_id.generous_and_wide_target_retrieval_timestamp|date:'Y-m-d\TH:i:s' }}"
                                       {% endif %}
                                       required
                                       style="padding: 10px; height: 38px; border-radius: 4px; border: 1px solid #e6e6e6; transition: border-color 0.2s; width: 100%;">
                            </div>

                            <button type="submit" class="layui-btn layui-btn-sm"
                                    style="background-color: #1E9FFF; border-color: #1E9FFF; padding: 0 15px; height: 38px; line-height: 38px; border-radius: 4px; transition: all 0.2s; cursor: pointer;">
                                <i class="layui-icon layui-icon-ok" style="margin-right: 5px;"></i> 确认
                            </button>

                            {% if order.retrieval_id.generous_and_wide_target_retrieval_timestamp %}
                            <div style="margin-left: 10px; color: #52c41a; font-size: 13px; white-space: nowrap;">
                                已设置: {{ order.retrieval_id.generous_and_wide_target_retrieval_timestamp|date:'Y-m-d H:i:s' }}
                            </div>
                            {% else %}
                            <div style="margin-left: 10px; color: #999; font-size: 13px;">
                                未设置时间
                            </div>
                            {% endif %}
                        </form>
                    </td>
                </tr>
                {% empty %}
                <tr id="emptyRow">
                    <td colspan="2" style="text-align: center; padding: 60px 20px; color: #666; background-color: #fafafa;">
                        <div style="display: flex; flex-direction: column; align-items: center;">
                            <i class="layui-icon layui-icon-empty" style="font-size: 48px; margin-bottom: 15px; color: #ddd;"></i>
                            <p>暂无LA区域的柜号数据</p>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div id="noResult" style="display: none; text-align: center; padding: 60px 20px; color: #666; background-color: #fafafa; border-radius: 4px; margin-top: 10px;">
        <div style="display: flex; flex-direction: column; align-items: center;">
            <i class="layui-icon layui-icon-search" style="font-size: 48px; margin-bottom: 15px; color: #ddd;"></i>
            <p>未找到匹配的柜号</p>
            <p style="font-size: 13px; margin-top: 5px; color: #999;">请尝试其他搜索关键词</p>
        </div>
    </div>

    <div style="margin-top: 20px; padding: 15px; background-color: #f5f7fa; border-radius: 4px; font-size: 13px; color: #666;">
        <i class="layui-icon layui-icon-info-circle" style="color: #1E9FFF; margin-right: 5px;"></i>
        提示：时间格式为YYYY-MM-DD HH:MM:SS，点击"确认"后将保存设置
    </div>
</div>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/layui-src/dist/css/layui.css">

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // 获取元素
        const searchInput = document.getElementById('containerSearch');
        const searchBtn = document.getElementById('searchBtn');
        const resetBtn = document.getElementById('resetBtn');
        const tableRows = document.querySelectorAll('.container-row');
        const emptyRow = document.getElementById('emptyRow');
        const noResult = document.getElementById('noResult');
        const searchStats = document.getElementById('searchStats');
        const matchCountEl = document.getElementById('matchCount');
        const totalCountEl = document.getElementById('totalCount');

        // 统计总柜号数量（排除空数据行）
        const totalCount = emptyRow ? tableRows.length : tableRows.length;
        totalCountEl.textContent = totalCount;

        // 搜索功能
        function performSearch() {
            const searchText = searchInput.value.trim();
            // 多个柜号用空格分隔，分割后去重并过滤空值
            const searchTerms = searchText ? [...new Set(searchText.split(/\s+/).filter(t => t))] : [];
            let matchCount = 0;

            // 隐藏空数据行和无结果提示
            if (emptyRow) emptyRow.style.display = 'none';
            noResult.style.display = 'none';

            // 遍历所有柜号行进行匹配
            tableRows.forEach(row => {
                const containerNumber = row.querySelector('.container-number').textContent.trim();
                let isMatch = false;

                if (searchTerms.length === 0) {
                    // 无搜索条件时显示所有行
                    isMatch = true;
                } else {
                    // 匹配任何一个搜索词即视为匹配
                    isMatch = searchTerms.some(term =>
                        containerNumber.includes(term)
                    );
                }

                // 显示或隐藏行
                row.style.display = isMatch ? '' : 'none';
                if (isMatch) matchCount++;
            });

            // 显示统计信息
            searchStats.style.display = searchTerms.length > 0 ? 'block' : 'none';
            matchCountEl.textContent = matchCount;

            // 无匹配结果时显示提示
            if (searchTerms.length > 0 && matchCount === 0) {
                noResult.style.display = 'block';
            }
        }

        // 绑定事件
        searchBtn.addEventListener('click', performSearch);
        resetBtn.addEventListener('click', function() {
            searchInput.value = '';
            performSearch(); // 重置后显示所有
        });
        // 支持回车键搜索
        searchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                performSearch();
            }
        });
        // 输入框焦点样式
        searchInput.addEventListener('focus', function() {
            this.style.borderColor = '#1E9FFF';
        });
        searchInput.addEventListener('blur', function() {
            this.style.borderColor = '#e6e6e6';
        });
    });
</script>
{% endblock %}