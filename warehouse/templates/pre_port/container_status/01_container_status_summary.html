{% extends 'base.html' %}
{% block content %}
<div style="max-height: 100%; max-width: 100%;">
    <div><b>货柜状态追踪</b></div>
</div>
<div style="height: 400px; max-height: 400px; width: 100%; border: 2px solid rgb(180, 180, 180); border-radius: 12px; padding: 1%; margin-top: .5%; margin-right: .5%;">
    <div style="display: flex;">
        <div style="width: 60%;">
            <b style="background-color: rgb(208, 208, 208); border-radius: 20px; font-size: 11px; display:inline-flex; color: rgb(100, 100, 100); padding: 5px;">
                确认到仓 - {{ orders_pickup_scheduled|length }}
            </b>
        </div>
    </div>
    <div style="overflow-x: scroll; overflow-y: scroll; max-height: 90%;">
    <!-- 批量操作区域：全选 + 统一时间 + 批量按钮 -->
    <div style="margin-bottom: 10px; padding: 5px; background: #f5f5f5;">
        <label style="font-size: 11px; margin-right: 15px;">
            <input type="checkbox" id="selectAll" style="vertical-align: middle;"> 全选
        </label>
        <!-- 统一时间输入框（批量更新时用） -->
        <input type="datetime-local" id="batchArriveAt" style="font-size: 13px; margin-right: 15px;" required>
        <!-- 批量提交按钮 -->
        <button id="batchSubmitBtn" class="btn btn-success" style="height: 30px; font-size: 13px;">
            批量确认到仓时间
        </button>
    </div>

    <!-- 表格主体 -->
    <table class="table" id="pickup-schedule-table" style="font-size: 11px; overflow-y: scroll; max-height: 90%;">
        <thead>
            <tr style="position: sticky; top: 0;">
                <!-- 新增：选择列 -->
                <th class="th" style="width: 60px;">选择</th>
                <th class="th">柜号</th>
                <th class="th">订单类型</th>
                <th class="th">目的地</th>
                <th class="th">提柜时间</th>
                <th class="th">供应商</th>
                <th class="th">提柜备注</th>
                <th class="th">到仓时间</th>
                <th class="th">优先级</th>
            </tr>
            <tr style="position: sticky; top: 20px;">
                <!-- 新增：选择列的搜索占位（保持表头对齐） -->
                <th class="th"></th>
                <th class="th">
                    <input type="text" id="ctnSearch" placeholder="搜索柜号..." oninput="filterTable(this, 0, true)" size="13" style="font-size: 11px;">
                </th>
                <th class="th"></th>
                <th class="th"></th>
                <th class="th"></th>
                <th class="th"></th>
                <th class="th"></th>
                <th class="th"></th>
                <th class="th"></th>
            </tr>
        </thead>
        <tbody>
            {% for o in orders_pickup_scheduled%}
            <!-- 单行表单：保留原有单行提交功能 -->
            <form method="post" action="" style="width: 100%;" class="single-form">
                {% csrf_token %}
                <tr {% if o.retrieval_id.arrive_at_warehouse_status == "past_due" %}class="tr-status-red"{% endif %}>
                    <!-- 新增：单行选择框（name统一为containerNumbers，值为柜号） -->
                    <td class="td">
                        <input type="checkbox" name="containerNumbers" value="{{ o.container_number.container_number }}" style="vertical-align: middle;">
                    </td>
                    <td class="td">{{ o.container_number.container_number }}</td>
                    <td class="td">{{ o.order_type }}</td>
                    <td class="td">{{ o.retrieval_id.retrieval_destination_precise }}</td>
                    <td class="td">{{ o.retrieval_id.actual_retrieval_timestamp|date:'M-j' }}</td>
                    <td class="td">{{ o.retrieval_id.retrieval_carrier }}</td>
                    <td class="td">{{ o.retrieval_id.note }}</td>
                    <td class="td">
                        <input type="datetime-local" name="arrive_at" style="font-size: 13px;" required>
                        <input type="hidden" name="step" value="arrive_at_destination">
                        <input type="hidden" name="container_number" value="{{ o.container_number.container_number }}">
                        <button type="submit" class="btn btn-primary" style="height: 30px; margin-left: 20px; font-size: 13px;">
                            确认
                        </button>
                    </td>
                    <td class="td">{{ o.unpacking_priority }}</td>
                </tr>
            </form>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- 批量提交表单（隐藏，用于提交批量数据） -->
<form id="batchForm" method="post" action="" style="display: none;">
    {% csrf_token %}
    <input type="hidden" name="step" value="batch_arrive_at_destination">
    <input type="hidden" name="batch_arrive_at" id="batchArriveAtInput"> <!-- 批量时间 -->
    <input type="hidden" name="batch_container_numbers" id="batchContainerNumbersInput"> <!-- 选中的柜号列表 -->
</form>
</div>  
<div style="display: flex;">
    <div style="height: 350px; max-height: 350px; width: 30%; border: 2px solid rgb(180, 180, 180); border-radius: 12px; padding: 1%; margin-top: .5%; margin-right: .5%">
        <div style="display: flex;">
            <div style="width: 60%;">
                <b style="background-color: rgb(208, 208, 208); border-radius: 20px; font-size: 11px; display:inline-flex; color: rgb(100, 100, 100); padding: 5px;">
                    确认拆柜 - {{ orders_at_warehouse|length }}
                </b>
            </div>
        </div>
        <div style="overflow-x: scroll; overflow-y: scroll; max-height: 90%;">
            <table class="table" id="orders-at-warehouse-table" style="font-size: 11px; max-height: 90%;">
                <thead>
                    <tr style="position: sticky; top: 0;">
                        <th class="th">柜号</th>
                        <th class="th">仓库</th>
                        <th class="th">到仓时间</th>
                    </tr>
                    <tr style="position: sticky; top: 28px;">
                        <th class="th">
                            <input type="text" id="ctnSearch" placeholder="搜索柜号..." oninput="filterTable(this, 0, true)" size="13" style="font-size: 11px;">
                        </th>
                        <th class="th"></th>
                        <th class="th"></th>
                    </tr>
                </thead>
                <tbody>
                    {% for o in orders_at_warehouse%}
                    <tr {% if o.retrieval_id.offload_status == "past_due" %}class="tr-status-red"{% elif o.retrieval_id.offload_status == "past_due" %}class="tr-status-yellow"{% endif %}>
                        <td class="td">{{ o.container_number.container_number }}</td>
                        <td class="td">{{ o.warehouse.name }}</td>
                        <td class="td">{{ o.retrieval_id.arrive_at|date:'M-j' }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
<div style="height: 350px; max-height: 350px; width: 70%; border: 2px solid rgb(180, 180, 180); border-radius: 12px; padding: 1%; margin-top: .5%; margin-right: .5%">
    <div style="display: flex;">
        <div style="width: 60%;">
            <b style="background-color: rgb(208, 208, 208); border-radius: 20px; font-size: 11px; display:inline-flex; color: rgb(100, 100, 100); padding: 5px;">
                确认还空 - {{ orders_palletized|length }}
            </b>
        </div>
        <!-- 新增批量操作区域 -->
        <div style="width: 40%; text-align: right;">
            <label style="font-size: 11px; margin-right: 10px;">
                <input type="checkbox" id="selectAllEmptyReturn" style="vertical-align: middle;"> 全选
            </label>
            <input type="datetime-local" id="batchEmptyReturnedAt" style="font-size: 11px; margin-right: 10px;" required>
            <button id="batchEmptyReturnBtn" class="btn btn-success" style="height: 25px; font-size: 11px; padding: 0 10px;">
                批量确认
            </button>
        </div>
    </div>
    <div style="overflow-x: scroll; overflow-y: scroll; max-height: 90%;">
        <table class="table" id="palletized-order-table" style="font-size: 11px; max-height: 90%;">
            <thead>
                <tr style="position: sticky; top: 0;">
                    <!-- 新增选择列 -->
                    <th class="th" style="width: 50px;">选择</th>
                    <th class="th">柜号</th>
                    <th class="th">目的地</th>
                    <th class="th">到仓时间</th>
                    <th class="th">拆柜时间</th>
                    <th class="th">供应商</th>
                    <th class="th">还柜时间</th>
                    <th class="th">优先级</th>
                </tr>
                <tr style="position: sticky; top: 28px;">
                    <!-- 新增选择列的占位 -->
                    <th class="th"></th>
                    <th class="th">
                        <input type="text" id="ctnSearch" placeholder="搜索柜号..." oninput="filterTable(this, 0, true)" size="13" style="font-size: 11px;">
                    </th>
                    <th class="th"></th>
                    <th class="th"></th>
                    <th class="th"></th>
                    <th class="th"></th>
                    <th class="th"></th>
                    <th class="th"></th>
                </tr>
            </thead>
            <tbody>
                {% for o in orders_palletized%}
                <form method="post" action="" style="width: 100%;" class="single-form">
                    {% csrf_token %}
                    <tr {% if o.offload_id.offload_status == "past_due" %}class="tr-status-red"{% endif %}>
                        <!-- 新增单行选择框 -->
                        <td class="td">
                            <input type="checkbox" name="emptyReturnContainerNumbers" value="{{ o.container_number.container_number }}" style="vertical-align: middle;">
                        </td>
                        <td class="td">{{ o.container_number.container_number }}</td>
                        <td class="td">{{ o.retrieval_id.retrieval_destination_precise }}</td>
                        <td class="td">{{ o.retrieval_id.arrive_at|date:'M-j' }}</td>
                        <td class="td">{{ o.offload_id.offload_at|date:'M-j' }}</td>
                        <td class="td">{{ o.retrieval_id.retrieval_carrier }}</td>
                        <td class="td">
                            <input type="datetime-local" name="empty_returned_at" style="font-size: 13px;" required>
                            <input type="hidden" name="step" value="empty_return">
                            <input type="hidden" name="container_number" value="{{ o.container_number.container_number }}">
                            <button id="empty-return-btn" type="submit" class="btn btn-primary" style="height: 30px; margin-left: 20px; font-size: 13px;">
                                确认
                            </button>
                        </td>
                        <td class="td">
                            {{ o.unpacking_priority }}
                        </td>
                    </tr>
                </form>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- 批量提交表单（隐藏） -->
<form id="batchEmptyReturnForm" method="post" action="" style="display: none;">
    {% csrf_token %}
    <input type="hidden" name="step" value="batch_empty_return">
    <input type="hidden" name="batch_empty_returned_at" id="batchEmptyReturnedAtInput">
    <input type="hidden" name="batch_container_numbers" id="batchEmptyReturnContainerNumbersInput">
</form>
</div>
<script>
    function filterTable(filterInput, col_idx, trim) {
        var containerInput, containerFilter, table, tbody, tr, containerTd, i, containerTxtValue;
        containerFilter = filterInput.value.toUpperCase();
        var table = filterInput.closest('table');
        tbody = table.getElementsByTagName("tbody")[0];
        tr = tbody.getElementsByTagName("tr");

        for (i = 0; i < tr.length; i++) {
            containerTd = tr[i].getElementsByTagName("td")[col_idx];
            if (containerTd) {
                containerTxtValue = containerTd.textContent || containerTd.innerText;
                containerTxtValue = trim ? containerTxtValue.toUpperCase().trim() : containerTxtValue.toUpperCase()
                var containerDisplayStyle_1 = containerTxtValue.indexOf(containerFilter) > -1 ? "" : "none";
                var containerDisplayStyle_2 = containerFilter.indexOf(containerTxtValue) > -1 ? "" : "none";
                // Set display style based on both container and customer filters
                tr[i].style.display = containerDisplayStyle_1 === "" || containerDisplayStyle_2 === "" ? "" : "none";
            }
        }
    };
    // 1. 全选/取消全选功能
    document.getElementById('selectAll').addEventListener('change', function (e) {
        // 获取所有单行选择框
        const checkboxes = document.querySelectorAll('input[name="containerNumbers"]');
        checkboxes.forEach(checkbox => {
            checkbox.checked = e.target.checked;
        });
    });

    // 2. 批量提交功能
    document.getElementById('batchSubmitBtn').addEventListener('click', function () {
        // ① 获取选中的柜号
        const checkedBoxes = document.querySelectorAll('input[name="containerNumbers"]:checked');
        if (checkedBoxes.length === 0) {
            alert('请先选择需要批量更新的柜号！');
            return;
        }
        // 提取柜号为数组（如：["CTN001", "CTN002"]）
        const containerNumbers = Array.from(checkedBoxes).map(box => box.value);

        // ② 获取统一的到仓时间
        const batchArriveAt = document.getElementById('batchArriveAt').value;
        if (!batchArriveAt) {
            alert('请选择批量更新的到仓时间！');
            return;
        }

        // ③ 填充批量表单并提交
        const batchForm = document.getElementById('batchForm');
        document.getElementById('batchArriveAtInput').value = batchArriveAt;
        document.getElementById('batchContainerNumbersInput').value = containerNumbers.join(','); // 用逗号分隔柜号
        batchForm.submit();
    });

    // 3. （可选）优化：点击行时自动选中/取消选择框
    document.querySelectorAll('#pickup-schedule-table tbody tr').forEach(tr => {
        tr.addEventListener('click', function (e) {
            // 点击选择框本身时不重复触发
            if (e.target.tagName !== 'INPUT' || e.target.name !== 'containerNumbers') {
                const checkbox = this.querySelector('input[name="containerNumbers"]');
                if (checkbox) checkbox.checked = !checkbox.checked;
            }
        });
    });
    // 全选/取消全选功能
document.getElementById('selectAllEmptyReturn').addEventListener('change', function(e) {
    const checkboxes = document.querySelectorAll('input[name="emptyReturnContainerNumbers"]');
    checkboxes.forEach(checkbox => {
        checkbox.checked = e.target.checked;
    });
});

// 批量提交还空时间
document.getElementById('batchEmptyReturnBtn').addEventListener('click', function() {
    // 获取选中的柜号
    const checkedBoxes = document.querySelectorAll('input[name="emptyReturnContainerNumbers"]:checked');
    if (checkedBoxes.length === 0) {
        alert('请先选择需要批量更新的柜号！');
        return;
    }

    // 提取柜号列表
    const containerNumbers = Array.from(checkedBoxes).map(box => box.value);

    // 获取统一的还柜时间
    const batchEmptyReturnedAt = document.getElementById('batchEmptyReturnedAt').value;
    if (!batchEmptyReturnedAt) {
        alert('请选择批量更新的还柜时间！');
        return;
    }

    // 填充批量表单并提交
    const batchForm = document.getElementById('batchEmptyReturnForm');
    document.getElementById('batchEmptyReturnedAtInput').value = batchEmptyReturnedAt;
    document.getElementById('batchEmptyReturnContainerNumbersInput').value = containerNumbers.join(',');
    batchForm.submit();
});

// 点击行选中/取消选择框（可选优化）
document.querySelectorAll('#palletized-order-table tbody tr').forEach(tr => {
    tr.addEventListener('click', function(e) {
        if (e.target.tagName !== 'INPUT' || e.target.name !== 'emptyReturnContainerNumbers') {
            const checkbox = this.querySelector('input[name="emptyReturnContainerNumbers"]');
            if (checkbox) checkbox.checked = !checkbox.checked;
        }
    });
});
</script>
{% endblock %}