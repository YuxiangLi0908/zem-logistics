{% extends 'base.html' %}
{% block content %}
<div class="container-fluid" style="padding: 20px; margin: 0 auto;">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h5 style="font-weight: 600; color: #333; margin: 0; font-size: 16px;">港前订单管理</h5>
    </div>

    <form method="post" action="" class="bg-white rounded rounded-lg shadow-sm p-4">
        {% csrf_token %}
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <span class="badge bg-secondary text-dark px-3 py-1" style="font-size: 13px; font-weight: 500; border-radius: 20px;">
                    创建订单 - 基本信息
                </span>
            </div>
            <div>
                <input type="hidden" name="step" value="create_order_basic">
                <button id="submit-btn-create-order" type="submit" class="btn btn-primary btn-sm"
                        style="width: 90px; height: 30px; font-size: 13px; border-radius: 4px;"
                        onclick="checkOrderTypeInput(event)">
                    创建订单
                </button>
            </div>
        </div>

        <!-- 单行布局，无滚动条 -->
        <div style="display: flex; flex-wrap: nowrap; gap: 15px; width: 100%;">
            <!-- 客户 -->
            <div style="flex: 0 0 120px;">
                <label class="form-label" style="font-size: 12px; color: #555; display: block; margin-bottom: 5px; font-weight: 500;">客户</label>
                <select name="customer" class="form-select form-select-sm" style="width: 100%; height: 30px; font-size: 12px; padding: 4px 8px; border-radius: 3px;" id="customer">
                    {% for k, v in customers.items %}
                        <option value="{{ v }}">{{ k }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- 订单类型 -->
            <div style="flex: 0 0 120px;">
                <label class="form-label" style="font-size: 12px; color: #555; display: block; margin-bottom: 5px; font-weight: 500;">订单类型</label>
                <select name="order_type" id="order_type" class="form-select form-select-sm"
                        style="width: 100%; height: 30px; font-size: 12px; padding: 4px 8px; border-radius: 3px;" onchange="changeFollowingInput(this)">
                    {% for k, v in order_type.items %}
                        <option value="{{ v }}">{{ k }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- 所属仓 (默认隐藏) -->
            <div style="flex: 0 0 120px; display: none;" id="area">
                <label class="form-label" style="font-size: 12px; color: #555; display: block; margin-bottom: 5px; font-weight: 500;">所属仓</label>
                <select name="area" class="form-select form-select-sm" style="width: 100%; height: 30px; font-size: 12px; padding: 4px 8px; border-radius: 3px;">
                    {% for k, v in area.items %}
                        <option value="{{ v }}">{{ k }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- 直送地址 (默认隐藏) -->
            <div style="flex: 0 0 140px; display: none;" id="destination">
                <label class="form-label" style="font-size: 12px; color: #555; display: block; margin-bottom: 5px; font-weight: 500;">直送地址</label>
                <input type="text" name="destination" id="orderDestination"
                       class="form-control form-control-sm" style="width: 100%; height: 30px; font-size: 12px; padding: 4px 8px; border-radius: 3px;">
            </div>

            <!-- 柜号 -->
            <div style="flex: 0 0 120px;">
                <label class="form-label" style="font-size: 12px; color: #555; display: block; margin-bottom: 5px; font-weight: 500;">柜号</label>
                <input type="text" name="container_number" id="containerNumber"
                       class="form-control form-control-sm" style="width: 100%; height: 30px; font-size: 12px; padding: 4px 8px; border-radius: 3px;" required>
            </div>

            <!-- MBL -->
            <div style="flex: 0 0 120px;">
                <label class="form-label" style="font-size: 12px; color: #555; display: block; margin-bottom: 5px; font-weight: 500;">MBL</label>
                <input type="text" name="mbl" id="mbl"
                       class="form-control form-control-sm" style="width: 100%; height: 30px; font-size: 12px; padding: 4px 8px; border-radius: 3px;" required>
            </div>

            <!-- ETD -->
            <div style="flex: 0 0 120px;">
                <label class="form-label" style="font-size: 12px; color: #555; display: block; margin-bottom: 5px; font-weight: 500;">ETD</label>
                <input type="date" name="etd" class="form-control form-control-sm" style="width: 100%; height: 30px; font-size: 12px; padding: 4px 8px; border-radius: 3px;">
            </div>

            <!-- ETA -->
            <div style="flex: 0 0 120px;">
                <label class="form-label" style="font-size: 12px; color: #555; display: block; margin-bottom: 5px; font-weight: 500;">ETA</label>
                <input type="date" name="eta" class="form-control form-control-sm" style="width: 100%; height: 30px; font-size: 12px; padding: 4px 8px; border-radius: 3px;" required>
            </div>

            <!-- 保时效 -->
            <div style="flex: 0 0 100px;">
                <label class="form-label" style="font-size: 12px; color: #555; display: block; margin-bottom: 5px; font-weight: 500;">保时效</label>
                <div style="padding-top: 5px; padding-left: 28px;">
                    <input type="checkbox" name="is_expiry_guaranteed" value="true"
                           class="form-check-input" id="expiryCheck" style="width: 16px; height: 16px; cursor: pointer;">
                </div>
            </div>

            <!-- 备注 -->
            <div style="flex: 0 0 140px;" id="containerNote">
                <label class="form-label" style="font-size: 12px; color: #555; display: block; margin-bottom: 5px; font-weight: 500;">备注</label>
                <input type="text" name="note" class="form-control form-control-sm" style="width: 100%; height: 30px; font-size: 12px; padding: 4px 8px; border-radius: 3px;">
            </div>

            <!-- 下单日期 -->
            <div style="flex: 0 0 120px;">
                <label class="form-label" style="font-size: 12px; color: #555; display: block; margin-bottom: 5px; font-weight: 500;">下单日期</label>
                <input type="date" name="created_at" class="form-control form-control-sm" style="width: 100%; height: 30px; font-size: 12px; padding: 4px 8px; border-radius: 3px;" required>
            </div>
        </div>
    </form>

    {% block order_status %}
    {% endblock %}
</div>

<script>
    // 页面加载时初始化
    document.addEventListener('DOMContentLoaded', function() {
        changeFollowingInput(document.getElementById('order_type'));
    });

    // 根据订单类型显示/隐藏字段
    function changeFollowingInput(select) {
        const selectedValue = select.value;
        const areaDiv = document.getElementById("area");
        const destinationDiv = document.getElementById("destination");
        const orderDestinationInput = document.getElementById('orderDestination');

        if (selectedValue === "直送") {
            areaDiv.style.display = 'block';
            destinationDiv.style.display = 'block';
            orderDestinationInput.required = true;
        } else if (selectedValue === "转运" || selectedValue === "转运组合") {
            areaDiv.style.display = 'block';
            destinationDiv.style.display = 'none';
            orderDestinationInput.required = false;
        } else {
            areaDiv.style.display = 'none';
            destinationDiv.style.display = 'none';
            orderDestinationInput.required = false;
        }
    }

    // 表单提交验证
    function checkOrderTypeInput(event) {
        const selectedValue = document.getElementById('order_type').value;
        const selectedCustomer = document.getElementById('customer').value;
        let isValid = true;

        if (!selectedCustomer) {
            alert('请选择客户！');
            isValid = false;
        }
        if (!selectedValue) {
            alert('请选择订单类型！');
            isValid = false;
        }

        if (!isValid && event) {
            event.preventDefault();
        }
    }

    // 防止页面缓存导致的状态问题
    window.addEventListener('pageshow', function(event) {
        if (event.persisted || (window.performance && window.performance.navigation.type === 2)) {
            window.location.reload();
        }
    });
</script>
{% endblock %}