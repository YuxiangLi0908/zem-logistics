{% extends 'pre_port/create_order/01_base_order_creation_and_management.html' %}
{% block order_status %}
<style>
    /* 主容器 */
    .order-dashboard {
        display: flex;
        gap: 20px;
        padding-top: 15px;
        box-sizing: border-box;
    }

    /* 左侧订单列表容器 */
    .order-list-panel {
        width: 40%;
        background: #ffffff;
        border-radius: 10px;
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
        overflow: hidden;
        border: 1px solid #e0e0e0;
    }

    /* 面板标题栏 */
    .panel-header {
        background: #f8f9fa;
        padding: 12px 15px;
        border-bottom: 1px solid #e0e0e0;
        position: relative;
        z-index: 10; /* 最高层级 */
    }

    .panel-title {
        font-size: 13px;
        font-weight: 600;
        color: #333;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .order-count {
        background: #e9ecef;
        color: #666;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 11px;
    }

    /* 表格容器与滚动区域 - 关键优化 */
    .table-scroll {
        max-height: 500px;
        overflow-y: auto;
        position: relative; /* 确保内容在容器内滚动 */
    }

    /* 表格样式 - 关键优化 */
    .order-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 11px;
        table-layout: fixed; /* 固定列宽防止错位 */
    }

    /* 表头容器 - 核心层级控制 */
    .order-table thead {
        position: sticky;
        top: 0;
        z-index: 5; /* 表头和搜索框在内容上方 */
        background: #f1f3f5;
    }

    /* 主表头样式 */
    .order-table th {
        padding: 8px 10px;
        text-align: center;
        font-weight: 600;
        color: #495057;
        border-bottom: 1px solid #e0e0e0;
    }

    /* 搜索行样式 - 固定在主表头下方 */
    .search-row {
        display: table-row;
        background: #f8f9fa;
    }

    .search-row th {
        padding: 6px 8px;
        border-bottom: 1px solid #e0e0e0;
    }

    /* 表格内容区域 - 确保在搜索框下方 */
    .order-table tbody {
        position: relative;
        z-index: 1; /* 内容层级最低 */
    }

    .order-table td {
        padding: 8px 10px;
        text-align: center;
        border-bottom: 1px solid #f1f3f5;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .order-table tr:hover {
        background: #f8fafc;
        transition: background 0.2s ease;
    }

    /* 搜索框样式 */
    .table-filter {
        width: 100%;
        padding: 4px 8px;
        border: 1px solid #ced4da;
        border-radius: 4px;
        font-size: 11px;
        box-sizing: border-box;
    }

    .table-filter:focus {
        outline: none;
        border-color: #80bdff;
        box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.1);
    }

    /* 链接样式 */
    .container-link {
        color: #2c7be5;
        text-decoration: none;
        font-weight: 500;
    }

    .container-link:hover {
        color: #1a56db;
        text-decoration: underline;
    }

    /* 状态图标样式 */
    .status-icon {
        font-size: 16px !important;
    }

    .status-complete {
        color: #28a745;
    }

    .status-pending {
        color: #dc3545;
    }

    /* 右侧补充信息区域 */
    .order-detail-panel {
        flex: 1;
        max-width: 72%;
        background: #ffffff;
        border-radius: 10px;
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
        padding: 15px;
        border: 1px solid #e0e0e0;
    }

    /* 滚动条美化 */
    .table-scroll::-webkit-scrollbar {
        width: 6px;
    }

    .table-scroll::-webkit-scrollbar-track {
        background: #f1f3f5;
        border-radius: 3px;
    }

    .table-scroll::-webkit-scrollbar-thumb {
        background: #ced4da;
        border-radius: 3px;
    }
</style>

<div class="order-dashboard">
    <!-- 左侧未完成订单列表 -->
    <div class="order-list-panel">
        <div class="panel-header">
            <div class="panel-title">
                未完成订单
                <span class="order-count">{{ unfinished_orders|length }}</span>
            </div>
        </div>
        <div class="table-scroll">
            <table class="order-table" id="unfinished-order-table">
                <thead>
                    <!-- 主表头 -->
                    <tr>
                        <th>仓库/地址</th>
                        <th>柜号</th>
                        <th>基础信息</th>
                        <th>航运信息</th>
                        <th>Packing List</th>
                    </tr>
                    <!-- 搜索行（单独作为表头行，确保固定） -->
                    <tr class="search-row">
                        <th>
                            <input type="text" id="warehouseSearch"
                                   placeholder="搜索仓库/地址..."
                                   oninput="filterTable(this, 0, true)"
                                   class="table-filter">
                        </th>
                        <th>
                            <input type="text" id="ctnSearch"
                                   placeholder="搜索柜号..."
                                   oninput="filterTable(this, 1, true)"
                                   class="table-filter">
                        </th>
                        <th></th>
                        <th></th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    {% for o in unfinished_orders %}
                        <tr>
                            <td>{{ o.retrieval_id__retrieval_destination_area }}</td>
                            <td>
                                <a href="/create_order/?step=container_info_supplement&container_number={{ o.container_number__container_number }}"
                                   class="container-link">
                                    {{ o.container_number__container_number }}
                                </a>
                            </td>
                            <td>
                                {% if o.container_number__container_number and o.vessel_id__master_bill_of_lading %}
                                <i class="bi bi-file-check-fill status-icon status-complete"></i>
                                {% else %}
                                <i class="bi bi-heartbreak-fill status-icon status-pending"></i>
                                {% endif %}
                            </td>
                            <td>
                                {% if o.vessel_id and o.vessel_id__vessel and o.vessel_id__shipping_line and o.vessel_id__destination_port and o.vessel_id__master_bill_of_lading and o.container_number__container_type%}
                                    <i class="bi bi-file-check-fill status-icon status-complete"></i>
                                {% else %}
                                    <i class="bi bi-heartbreak-fill status-icon status-pending"></i>
                                {% endif %}
                            </td>
                            <td>
                                {% if o.packing_list_updloaded or o.order_type == "直送" %}
                                    <i class="bi bi-file-check-fill status-icon status-complete"></i>
                                {% else %}
                                    <i class="bi bi-heartbreak-fill status-icon status-pending"></i>
                                {% endif %}
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- 右侧补充信息区域 -->
    <div class="order-detail-panel">
        {% block order_supplement %}

        {% endblock %}
    </div>
</div>

<script>
    function filterTable(filterInput, col_idx, trim) {
        const filterValue = filterInput.value.toUpperCase();
        const table = filterInput.closest('table');
        const tbody = table.querySelector('tbody');
        const rows = tbody.querySelectorAll('tr');

        rows.forEach(row => {
            const cell = row.querySelectorAll('td')[col_idx];
            if (cell) {
                let cellText = cell.textContent || cell.innerText;
                cellText = trim ? cellText.toUpperCase().trim() : cellText.toUpperCase();

                const isMatch = cellText.includes(filterValue) || filterValue.includes(cellText);
                row.style.display = isMatch ? '' : 'none';
            }
        });
    }
</script>
{% endblock %}