{% extends 'base.html' %}
{% load static %}
{% load custom_filters %}

{% block content %}
<style>
    :root {
        --primary-color: #166534;
        --secondary-color: #0f3e1e;
        --success-color: #15803d;
        --warning-color: #ea580c;
        --danger-color: #b91c1c;
        --light-bg: #f1f5f9;
        --text-dark: #0f172a;
        --radius: 14px;
        --shadow-strong: 0 10px 40px rgba(0,0,0,0.12);
        --shadow-soft: 0 4px 18px rgba(0,0,0,0.06);

        --page-padding: 40px;
        --content-max-width: 1800px;
        --font-large: 1.1rem;
        --font-xl: 1.4rem;
    }
    body {
        
        transform-origin: top center;
        background: #eef2f7;
        padding: var(--page-padding);
        font-size: var(--font-large);
    }
    .invoice-container {
        zoom: 0.8; 
        width: 100%;
        max-width: var(--content-max-width);
        margin: auto;
        background: white;
        border-radius: var(--radius);
        box-shadow: var(--shadow-strong);
        overflow: hidden;
    }

    .invoice-header {
        background: linear-gradient(135deg, #0f3e1e, #166534);
        padding: 40px 50px;
        color: white;
    }

    .header-main {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
    }

    .header-title {
        font-size: 2.4rem;
        font-weight: 700;
        letter-spacing: 1px;
    }

    .header-badges {
        margin-top: 12px;
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
    }
    .badge {
        display: flex; 
        padding: 8px 18px;
        font-size: 1rem;
        background: rgba(255,255,255,0.18);
        border-radius: 999px;
        backdrop-filter: blur(4px);
        align-items: center;
    }


    .quotation-info {
        margin-top: 22px;
        padding: 16px 20px;
        background: rgba(255,255,255,0.16);
        border-radius: var(--radius);
        font-size: var(--font-large);
    }

    .quotation-text {
        font-size: 0.9rem;
        margin: 0;
    }

    .invoice-content {
        padding: 40px 50px;
    }

    .fee-section {
        margin-bottom: 30px;
    }
    .amount-zero {
        color: #94a3b8 !important;  /* æµ…ç°è‰² */
        font-style: italic;
        opacity: 0.7;
        font-weight: 400;
    }

    .amount-zero-row .fee-cell:not(:first-child):not(:last-child) {
        opacity: 0.8;
    }
    .section-title {
        font-size: 1.8rem;
        margin: 0;
        color: var(--text-dark);
        font-weight: 700;
        border-left: 6px solid var(--primary-color);
        padding-left: 14px;
    }
    .fee-section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 25px;
    }
    .fee-table {
        width: 100%;
        background: white;
        overflow: hidden;
        border-radius: var(--radius);
        box-shadow: var(--shadow-soft);
        margin-top: 20px;
    }

    .table-header {
        display: grid;
        grid-template-columns: 2.2fr 1.5fr 1.2fr 1.2fr 1.2fr 1.4fr 2fr 80px; 
        background: #f8fafc;
        font-size: 1.5rem;
    }

    .table-header-cell {
        padding: 22px 10px;
        font-weight: 700;
        text-align: center;
        color: #000000; 
        font-size: 1.3rem;
        text-shadow: 0 1px 0 rgba(255, 255, 255, 0.5); /* å¯é€‰ï¼šå¢åŠ æ–‡å­—é˜´å½±æå‡å¯è¯»æ€§ */
        letter-spacing: 0.5px; /* å¯é€‰ï¼šå¢åŠ å­—é—´è· */
    }

    .table-header-cell:first-child {
        text-align: center !important;  /* è´¹ç”¨åç§°å±…ä¸­ */
        font-size: 1.3rem;  /* å­—ä½“å˜å¤§ */
        color: #000000; 
    }

    .fee-row {
        display: grid;
        grid-template-columns: 2.2fr 1.5fr 1.2fr 1.2fr 1.2fr 1.4fr 2fr 80px; 
        padding: 8px 0;
        border-bottom: 1px solid #e2e8f0;
        font-size: 1.3rem;
        transition: background 0.15s;
    }
    .fee-row:hover {
        background: #f9fafb;
    }

    .fee-cell {
        padding: 14px 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        text-align: center;
        font-size: inherit;
    }

    .fee-name {
        font-weight: 500;
        color: var(--secondary-color);
    }

    .reference-price {
        color: #718096;
        font-size: 1rem;
        text-align: center;
    }
    .surcharge-input {
        background-color: #fff8e1 !important; /* æµ…é»„è‰²èƒŒæ™¯ */
        border-color: #ffd54f !important;
    }

    .surcharge-input:focus {
        border-color: #ffb300 !important;
        box-shadow: 0 0 0 3px rgba(255, 179, 0, 0.2) !important;
    }

    /* æ­£æ•°é™„åŠ è´¹æ˜¾ç¤ºç»¿è‰² */
    .surcharge-input.positive {
        background-color: #e8f5e9 !important;
        border-color: #66bb6a !important;
    }

    /* è´Ÿæ•°é™„åŠ è´¹æ˜¾ç¤ºç²‰è‰² */
    .surcharge-input.negative {
        background-color: #fce4ec !important;
        border-color: #f48fb1 !important;
    }
    .input-field {
        padding: 12px 10px;
        font-size: 1.2rem;
        border-radius: 8px;
        border: 1px solid #cbd5e1;
        width: 100%;
    }

    .input-field:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(27, 94, 32, 0.1);
    }

    .amount-display {
        font-size: 1.4rem;
        font-weight: 700;
        color: var(--text-dark);
    }

    .note-input {
        text-align: left !important;
    }

    .remove-btn {
        width: 42px;
        height: 42px;
        font-size: 1.4rem;
        border-radius: 8px;
    }

    .remove-btn:hover {
        background: #c62828;
        transform: scale(1.05);
    }

    .action-buttons {
        margin-top: 40px;
        display: flex;
        flex-wrap: wrap;
        gap: 18px;
        justify-content: center;
    }

    .btn {
        padding: 14px 30px;
        font-size: 1.1rem;
        font-weight: 700;
        border-radius: 10px;
        box-shadow: var(--shadow-soft);
    }

    .btn-primary {
        background: var(--primary-color);
        color: white;
    }

    .btn-primary:hover {
        background: #1b5e20;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(27, 94, 32, 0.3);
    }

    .btn-success {
        background: var(--success-color);
        color: white;
    }

    .btn-success:hover {
        background: #2e7d32;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(46, 125, 50, 0.3);
    }

    .btn-warning {
        background: var(--warning-color);
        color: white;
    }

    .btn-warning:hover {
        background: #f57c00;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(255, 111, 0, 0.3);
    }

    .btn-danger {
        background: var(--danger-color);
        color: white;
    }

    .btn-danger:hover {
        background: #c62828;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(183, 28, 28, 0.3);
    }

    .total-section {
        margin-top: 40px;
        padding: 25px;
        border-radius: var(--radius);
        background: #f1f5f9;
        border: 1px solid #e2e8f0;
        text-align: center;
    }

    .total-amount {
        font-size: 2.4rem;
        font-weight: 800;
        color: var(--secondary-color);
    }

    .add-fee-btn {
        background: var(--primary-color);
        color: white;
        border-radius: 10px;
        padding: 12px 26px;
        font-size: 1.05rem;
        font-weight: 700;
        border: none;
        box-shadow: var(--shadow-soft);
        transition: 0.25s;
        margin: 0;
    }
    .info-card {
        background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
        border: 1px solid #bae6fd;
        border-radius: var(--radius);
        padding: 20px 25px;
        box-shadow: var(--shadow-soft);
        height: fit-content;
    }
    .info-cards-container {
        display: grid;
        grid-template-columns: 3fr 2fr;
        gap: 20px;
        margin-bottom: 25px;
    }
    .quotation-card {
        background: linear-gradient(135deg, #f8fff8, #f0f9f0);
        border: 1px solid #d1fae5;
        border-radius: var(--radius);
        padding: 20px 25px;
        box-shadow: var(--shadow-soft);
        height: fit-content;
    }
    .quotation-title, .info-title {
        font-size: 1.1rem;
        font-weight: 700;
        color: var(--primary-color);
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .quotation-details, .info-details {
        font-size: 1rem;
        color: var(--text-dark);
        line-height: 1.5;
    }
    .quotation-details {
        margin-top: 18px;
    }

    .quotation-highlight {
        color: var(--primary-color);
        font-weight: 600;
    }
    .info-highlight {
        color: #0369a1;
        font-weight: 600;
    }
    .add-fee-btn:hover {
        background: #14532d;
        transform: translateY(-2px);
        box-shadow: var(--shadow-strong);
    }
    @media (max-width: 1200px) {
        .info-cards-container {
            grid-template-columns: 1fr;
        }
    }
    .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        backdrop-filter: blur(5px);
    }

    .modal-content {
        position: absolute;
        top: 55%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        padding: 30px;
        border-radius: var(--border-radius);
        width: 90%;
        max-width: 600px;
        max-height: 80vh;
        overflow-y: auto;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
    }

    .modal-title {
        font-size: 1.4rem;
        font-weight: 600;
        margin-bottom: 20px;
        color: var(--secondary-color);
    }

    .fee-option {
        padding: 12px 16px;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        margin-bottom: 10px;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .fee-option:hover {
        border-color: var(--primary-color);
        background: #f1f8e9;
    }

    .fee-option-name {
        font-weight: 500;
        color: var(--secondary-color);
    }

    .fee-option-price {
        color: #718096;
        font-size: 0.9rem;
    }

    .custom-fee-input {
        width: 100%;
        padding: 12px;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        font-size: 1rem;
        margin-top: 15px;
    }
    .fee-cell:first-child {
        justify-content: flex-start;
        font-weight: 600;
    }
    .system-calculated {
        background: #f1f8e9;
        border-left: 4px solid var(--success-color);
    }

    .system-calculated .fee-cell:first-child {
        color: var(--success-color);
        font-weight: 600;
    }

    .status-badge {
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
        background: var(--light-bg);
        color: var(--secondary-color);
    }
    .btn-change-order-type {
        margin-left: 10px;
        padding: 6px 16px;
        font-size: 0.9rem;
        font-weight: 600;
        border-radius: 6px;
        border: 1px solid transparent;
        cursor: pointer;
        transition: all 0.2s ease;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        background: linear-gradient(135deg, #1e40af, #3b82f6);
        color: white;
        box-shadow: 0 2px 8px rgba(59, 130, 246, 0.2);
    }

    .btn-change-order-type:hover {
        background: linear-gradient(135deg, #1d4ed8, #2563eb);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }

    .btn-change-order-type:active {
        transform: translateY(0);
    }
    
    input[name="actual_non_combina_reason"] {
        margin-left: 10px;
        padding: 8px 12px;
        font-size: 0.9rem;
        border-radius: 6px;
        border: 1px solid #cbd5e1;
        min-width: 200px;
    }

    input[name="actual_non_combina_reason"]:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .order-type-form {
        display: inline;
    }
    .rules-icon {
        cursor: pointer;
        color: #2563eb;   /* è“è‰² */
        font-weight: 600;
        text-decoration: underline; /* åƒé“¾æ¥ */
    }

    .rules-icon:hover {
        color: #1e40af;
    }
    .rules-modal {
        
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.55);
        z-index: 9999;
        justify-content: center;
        align-items: center;
    }

    .rules-content {
        
        width: 650px;
        background: white;
        padding: 25px 30px;
        border-radius: 12px;
        max-height: 80vh;
        overflow: auto;
    }

    .modal-title {
        margin-bottom: 20px;
        font-size: 1.4rem;
        color: #0f3e1e;
        font-weight: 700;
    }

    .stipulate-section-title {
        background: #f0fdf4;
        border-left: 4px solid #16a34a;
        padding: 10px 12px;
        margin-bottom: 10px;
        font-weight: 600;
        color: #14532d;
        border-radius: 6px;
    }

    .rules-text {
        background: #f7f7f7;
        padding: 14px;
        border-radius: 6px;
        white-space: pre-line;
        font-size: 0.95rem;
        line-height: 1.6;
    }

    .divider {
        width: 100%;
        height: 1px;
        background: #e5e7eb;
        margin: 25px 0;
    }

    .close-btn {
        margin-top: 15px;
        padding: 10px 20px;
        background: #14532d;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
    }
    @media (max-width: 768px) {
        .btn-change-order-type {
            margin-top: 8px;
            margin-left: 0;
            display: block;
            width: 100%;
            justify-content: center;
        }
        
        input[name="actual_non_combina_reason"] {
            margin-top: 8px;
            margin-left: 0;
            width: 100%;
        }
    }
</style>
<div id="rules-modal" class="rules-modal">
    <div class="rules-content">
        <h3 class="modal-title">ç»„åˆæŸœè§„åˆ™è¯¦æƒ…</h3>

        <div class="rules-section">
            <div class="stipulate-section-title">ğŸ“Œ åŸºç¡€è§„åˆ™ï¼ˆGlobal Rulesï¼‰</div>
            <pre class="rules-text">{{ combina_rules_text.global_rules }}</pre>
        </div>

        <div class="divider"></div>

        <div class="rules-section">
            <div class="stipulate-section-title">âš–ï¸ é‡é‡è®¡è´¹ï¼ˆWeight Rulesï¼‰</div>
            <pre class="rules-text">{{ combina_rules_text.weight_rules }}</pre>
        </div>

        <div class="divider"></div>

        <div class="rules-section">
            <div class="stipulate-section-title">ğŸ¬ éç»„åˆæŸœææ‹†è®¡è´¹ï¼ˆWarehouse Rulesï¼‰</div>
            <pre class="rules-text">{{ combina_rules_text.warehouse_rules }}</pre>
        </div>

        <div class="divider"></div>

        <div class="rules-section">
            <div class="stipulate-section-title">ğŸ’² è¶…å‡ºä»“ç‚¹é˜¶æ¢¯è®¡è´¹ï¼ˆTiered Pricingï¼‰</div>
            <pre class="rules-text">{{ combina_rules_text.tiered_pricing }}</pre>
        </div>

        <button class="close-btn" onclick="closeRulesModal()">å…³é—­</button>
    </div>
</div>
<div class="invoice-container">
    <!-- å¤´éƒ¨ä¿¡æ¯ -->
    <div class="invoice-header">
        <div class="header-main">
            <h1 class="header-title">æ¸¯å‰è´¦å•ç¼–è¾‘ - {{ container_number }}</h1>
            <div class="header-badges">
                <span class="badge">ä»“åº“: {{ warehouse }}</span>
                <span class="badge">è®¢å•ç±»å‹: {{ order_type }}</span>
                <span class="badge">æŸœå‹: {{ container_type }}</span>
                <button onclick="window.history.back()" style="background: linear-gradient(135deg, #9ca3af, #6b7280);
                           border: 1px solid rgba(255,255,255,0.3);
                           color: white;
                           padding: 10px 20px;
                           border-radius: 8px;
                           cursor: pointer;
                           display: flex;
                           align-items: center;
                           gap: 8px;
                           transition: all 0.2s ease;">
                    <i class="fas fa-arrow-left"></i>
                    è¿”å›
                </button>
            </div>
                        
        </div>
        <div class="header-back-btn">
        
    </div>
    </div>
    <div class="invoice-content">
        <!-- ä¿¡æ¯å¡ç‰‡å®¹å™¨ -->
        <div class="info-cards-container">
            <!-- æŠ¥ä»·è¡¨ä¿¡æ¯å¡ç‰‡ -->
            <div class="quotation-card">
                <div class="quotation-title">
                    <i class="fas fa-file-invoice-dollar"></i>
                    å‚è€ƒæŠ¥ä»·è¡¨
                </div>
                <div class="quotation-details">
                    <strong>æ–‡ä»¶:</strong> <span class="quotation-highlight">{{ quotation_info.filename }}</span> 
                    <span class="divider-line"></span>
                    <strong>ç‰ˆæœ¬:</strong> {{ quotation_info.version }}
                    <span class="divider-line"></span>
                    <strong>ç”Ÿæ•ˆæ—¥æœŸ:</strong> {{ quotation_info.effective_date }}
                    {% if quotation_info.is_user_exclusive %}
                    <span class="divider-line"></span>
                    <strong style="color: #dc2626;">ä¸“å±ç”¨æˆ·:</strong> {{ quotation_info.exclusive_user }}
                    {% else %}
                    <span class="divider-line"></span>
                    <strong style="color: #16a34a;">é€šç”¨æŠ¥ä»·</strong>
                    {% endif %}
                    <span class="divider-line"></span>
                    <strong>çŠ¶æ€:</strong> 
                    <span style="color: {% if preport_status == 'completed' %}#16a34a{% elif preport_status == 'in_progress' %}#ea580c{% else %}#dc2626{% endif %};">
                        {% if preport_status == 'completed' %}å·²å®Œæˆ
                        {% elif preport_status == 'in_progress' %}å½•å…¥ä¸­
                        {% elif preport_status == 'rejected' %}å·²é©³å›
                        {% elif preport_status == 'pending_review' %}å¾…å®¡æ ¸
                        {% else %}æœªå¼€å§‹
                        {% endif %}
                    </span>
                </div>
            </div>

            <!-- ç»„åˆæŸœä¿¡æ¯å¡ç‰‡ -->
            <div class="info-card">
                <div class="info-title">
                    <i class="fas fa-boxes"></i>
                    ç»„åˆæŸœä¿¡æ¯
                </div>
                <div class="info-details">
                    {% if order_type == 'è½¬è¿' %}
                        <!-- åŸæœ¬å°±æ˜¯è½¬è¿å• -->
                        <strong>ç±»å‹:</strong> <span class="info-highlight">è½¬è¿</span>

                    {% elif order_type == 'è½¬è¿ç»„åˆ' %}
                        <form method="post" action="" class="order-type-form">
                            {% csrf_token %}
                            <input type="hidden" name="step" value="modify_order_type">
                            <input type="hidden" name="new_order_type" id="new_order_type" value="">
                            <input type="hidden" name="container_number" value="{{ container_number }}">
                            <input type="hidden" name="invoice_id" value="{{ invoice.id }}">
                            <input type="hidden" name="start_date" value="{{ start_date }}">
                            <input type="hidden" name="end_date" value="{{ end_date }}">
                            <!-- æ˜¯ç»„åˆæŸœç±»å‹ -->
                            <strong>ç»„åˆæŸœçŠ¶æ€:</strong>
                            {% if is_combina %}
                                <span class="info-highlight" style="color: #16a34a;">ç¬¦åˆç»„åˆæŸœ</span>
                                <button type="submit" class="btn-change-order-type" 
                                        onclick="setOrderType('è½¬è¿')">
                                    <i class="fas fa-exchange-alt"></i>
                                    æ”¹ä¸ºè½¬è¿
                                </button> &nbsp;&nbsp; 
                                <input type="text" name="actual_non_combina_reason" placeholder="ä¸ç¬¦åˆåŸå› ">
                                <span class="divider-line"></span>
                                <span class="rules-icon" onclick="openRulesModal()">ğŸ“˜ ç»„åˆæŸœè§„åˆ™æŸ¥çœ‹</span>
                            {% else %}
                                <span class="info-highlight" style="color: #dc2626;">ä¸ç¬¦åˆç»„åˆæŸœ</span>
                                {% if non_combina_reason %}
                                    <span class="divider-line"></span>
                                    <strong style="color:#dc2626;">åŸå› :</strong> 
                                    <span class="badge" style="background: rgba(255, 193, 7, 0.2); color: #ffa000;">
                                        âš ï¸{{ non_combina_reason }}
                                    </span>
                                {% endif %}
                                <button type="submit" class="btn-change-order-type" 
                                        onclick="setOrderType('è½¬è¿ç»„åˆ')">
                                    <i class="fas fa-exchange-alt"></i>
                                    æ”¹ä¸ºç»„åˆæŸœ
                                </button>
                                <span class="divider-line"></span>
                                <span class="rules-icon" onclick="openRulesModal()">ğŸ“˜ ç»„åˆæŸœè§„åˆ™æŸ¥çœ‹</span>
                            {% endif %}
                            </form>
                    {% else %}
                        <!-- å…¶ä»–ç±»å‹ï¼ˆéè½¬è¿ / éè½¬è¿ç»„åˆï¼‰ -->
                        <strong>ç±»å‹:</strong> <span class="info-highlight">{{ order_type }}</span>
                    {% endif %}
                </div>
            </div>
        </div>

        {% if receivable_is_locked %}
        <div style="background: #ffebee; color: #c62828; padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: center; border: 1px solid #ffcdd2;">
            <i class="fas fa-lock"></i> è´¦å•å·²ç¡®è®¤ï¼Œä¸å¯ç¼–è¾‘
        </div>
        {% endif %}

        <form method="post" action="" id="invoice-form">
            {% csrf_token %}
            <!-- è´¹ç”¨é¡¹ç›®åŒºåŸŸ -->
            <div class="fee-section">
                <div class="fee-section-header">
                    <h3 class="section-title">è´¹ç”¨æ˜ç»†</h3>
                    <button type="button" class="add-fee-btn" onclick="showAddFeeModal()">
                        <i class="fas fa-plus-circle"></i>
                        æ·»åŠ è´¹ç”¨é¡¹ç›®
                    </button>
                </div>
                
                <div class="fee-table">
                    <!-- è¡¨å¤´ -->
                    <div class="table-header">
                        <div class="table-header-cell">è´¹ç”¨åç§°</div>
                        <div class="table-header-cell">å‚è€ƒå•ä»·</div>
                        <div class="table-header-cell">å®é™…å•ä»·</div>
                        <div class="table-header-cell">æ•°é‡</div>
                        <div class="table-header-cell">é™„åŠ è´¹</div>
                        <div class="table-header-cell">æ€»ä»·</div>
                        <div class="table-header-cell">å¤‡æ³¨</div>
                        <div class="table-header-cell">æ“ä½œ</div>
                    </div>

                    <!-- è´¹ç”¨è¡Œ -->
                    <div id="fee-items-container">
                        {% for fee in fee_data %}
                        <div class="fee-row {% if fee.description == 'ææ‹†/æ‰“æ‰˜ç¼ è†œ' and not fee.id %}system-calculated{% endif %}
                            {% if fee.amount == 0 %}amount-zero-row{% endif %}" 
                            data-fee-id="{{ fee.id }}">
                            <input type="hidden" name="fee_id" value="{{ fee.id|default_if_none:'' }}">
                            <input type="hidden" name="fee_description" value="{{ fee.description }}">
                            
                            <div class="fee-cell">
                                <span class="fee-name">{{ fee.description }}</span>
                                {% if fee.description == 'ææ‹†/æ‰“æ‰˜ç¼ è†œ' and not fee.id %}
                                <span style="color: var(--success-color); margin-left: 8px; font-size: 0.8rem;">
                                    <i class="fas fa-calculator"></i> ç³»ç»Ÿè®¡ç®—
                                </span>
                                {% endif %}
                            </div>
                            
                            <div class="fee-cell">
                                <span class="reference-price">
                                    {{ fee.reference_price|default:FS|get_item:fee.description }}
                                </span>
                            </div>
                            
                            <div class="fee-cell">
                                {% if fee.description == 'ææ‹†/æ‰“æ‰˜ç¼ è†œ' and not fee.id %}
                                <input type="number" class="input-field" name="fee_rate" 
                                       value="{{ fee.rate }}" step="0.01" readonly 
                                       style="background: #f5f5f5; color: #666;">
                                {% else %}
                                <input type="number" class="input-field rate-input" name="fee_rate" 
                                       value="{{ fee.rate }}" step="0.01" min="0"
                                       onchange="calculateFeeTotal(this)">
                                {% endif %}
                            </div>
                            
                            <div class="fee-cell">
                                {% if fee.description == 'ææ‹†/æ‰“æ‰˜ç¼ è†œ' and not fee.id %}
                                <input type="number" class="input-field" name="fee_qty" 
                                       value="{{ fee.qty }}" step="0.1" readonly 
                                       style="background: #f5f5f5; color: #666;">
                                {% else %}
                                <input type="number" class="input-field qty-input" name="fee_qty" 
                                       value="{{ fee.qty }}" step="0.1" min="0"
                                       onchange="calculateFeeTotal(this)">
                                {% endif %}
                            </div>
                            <div class="fee-cell">
                                <input type="number" class="input-field surcharge-input" name="fee_surcharges" 
                                    value="{{ fee.surcharges|default:0 }}" step="0.01"
                                    onchange="calculateFeeTotal(this)"
                                    placeholder="é™„åŠ è´¹">
                            </div>
                            <div class="fee-cell">
                                <span class="amount-display {% if fee.amount == 0 %}amount-zero{% endif %}">{{ fee.amount|floatformat:2 }}</span>
                                <input type="hidden" name="fee_amount" value="{{ fee.amount }}">
                            </div>
                            
                            <div class="fee-cell">
                                <input type="text" class="input-field note-input" name="fee_note" 
                                       value="{{ fee.note }}" placeholder="å¤‡æ³¨ä¿¡æ¯">
                            </div>
                            
                            <div class="fee-cell">
                                {% if not fee.description == 'ææ‹†/æ‰“æ‰˜ç¼ è†œ' or fee.id %}
                                <button type="button" class="remove-btn" onclick="removeFeeItem(this)">
                                    Ã—
                                </button>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- æ€»é‡‘é¢ -->
            <div class="total-section">
                <h3 class="total-amount">
                    <i class="fas fa-dollar-sign"></i>
                    æ€»é‡‘é¢: $<span id="total-amount">0.00</span>
                </h3>
                <input type="hidden" name="total_amount" id="total-amount-input" value="0">
            </div>

            <!-- éšè—å­—æ®µ -->
            <input type="hidden" name="step" value="preport_save">
            <input type="hidden" name="save_type" id="save_type" value="">
            <input type="hidden" name="container_number" value="{{ container_number }}">
            <input type="hidden" name="invoice_id" value="{{ invoice.id }}">
            <input type="hidden" name="start_date" value="{{ start_date }}">
            <input type="hidden" name="end_date" value="{{ end_date }}">

            <!-- æ“ä½œæŒ‰é’® -->
            {% if not receivable_is_locked %}
                <div class="action-buttons">
                    {% if "invoice_preport" in groups or "staff" in groups %}
                    <button type="submit" class="btn btn-success" onclick="setSaveType('pending_review')">
                        <i class="fas fa-check-circle"></i>
                        ä¿å­˜å®Œæˆ
                    </button>
                    <button type="submit" class="btn btn-primary" onclick="setSaveType('in_progress')">
                        <i class="fas fa-save"></i>
                        æš‚å­˜æœªå®Œæˆ
                    </button>
                    {% endif %}
                    
                    {% if "invoice_preport_leader" in groups or "staff" in groups %}
                    <button type="submit" class="btn btn-warning" onclick="setSaveType('completed')">
                        <i class="fas fa-thumbs-up"></i>
                        å®¡æ ¸é€šè¿‡
                    </button>
                    <button type="submit" class="btn btn-danger" onclick="setSaveType('rejected')">
                        <i class="fas fa-thumbs-down"></i>
                        å®¡æ ¸ä¸é€šè¿‡
                    </button>
                    <input type="text" placeholder="å®¡æ ¸å¤±è´¥åŸå› " name="reject_reason" 
                        style="padding: 12px; border: 1px solid #e2e8f0; border-radius: 8px; min-width: 200px;">
                    {% endif %}
                </div>
            {% endif %}
        </form>
    </div>
</div>

<!-- æ·»åŠ è´¹ç”¨æ¨¡æ€æ¡† -->
<div id="addFeeModal" class="modal-overlay">
    <div class="modal-content">
        <h3 class="modal-title">é€‰æ‹©è´¹ç”¨é¡¹ç›®</h3>
        
        <div id="standard-fee-list" style="max-height: 300px; overflow-y: auto;">
            {% for fee_item in standard_fee_items %}
            {% if fee_item not in existing_descriptions %}
            <div class="fee-option" data-fee-name="{{ fee_item }}"
                onclick="selectStandardFee('{{ fee_item }}', '{{ FS|get_item:fee_item }}')">
                <span class="fee-option-name">{{ fee_item }}</span>
                <span class="fee-option-price">å‚è€ƒ: {{ FS|get_item:fee_item }}</span>
            </div>
            {% endif %}
            {% endfor %}
        </div>
        
        <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #e2e8f0;">
            <h4 style="margin-bottom: 10px; color: var(--secondary-color);">è‡ªå®šä¹‰è´¹ç”¨</h4>
            <input type="text" id="custom-fee-name" placeholder="è¾“å…¥è‡ªå®šä¹‰è´¹ç”¨åç§°" 
                   class="custom-fee-input">
            <button type="button" class="btn btn-primary" onclick="addCustomFee()" 
                    style="width: 100%; margin-top: 10px;">
                <i class="fas fa-plus-circle"></i>
                æ·»åŠ è‡ªå®šä¹‰è´¹ç”¨
            </button>
        </div>
        
        <div style="text-align: right; margin-top: 20px;">
            <button type="button" class="btn" onclick="closeAddFeeModal()" 
                    style="background: #78909c; color: white;">
                <i class="fas fa-times"></i>
                å–æ¶ˆ
            </button>
        </div>
    </div>
</div>

{% include 'receivable_accounting/modals/message_modal.html' %}
<script>
    function setOrderType(orderType) {
        document.getElementById('new_order_type').value = orderType;
    }
    // è®¡ç®—å•ä¸ªè´¹ç”¨é¡¹ç›®çš„æ€»ä»·
    function calculateFeeTotal(input) {
        const feeRow = input.closest('.fee-row');
        const rateInput = feeRow.querySelector('.rate-input');
        const qtyInput = feeRow.querySelector('.qty-input');
        const surchargeInput = feeRow.querySelector('.surcharge-input');
        const amountDisplay = feeRow.querySelector('.amount-display');
        const amountInput = feeRow.querySelector('input[name="fee_amount"]');
        
        const rate = parseFloat(rateInput?.value) || 0;
        const qty = parseFloat(qtyInput?.value) || 0;
        const surcharges = parseFloat(surchargeInput?.value) || 0;
        const amount = Math.round((rate * qty + surcharges) * 100) / 100;
        
        if (amountDisplay) {
            amountDisplay.textContent = amount.toFixed(2);
            // åŠ¨æ€åˆ‡æ¢ç°è‰²ç±»
            if (amount === 0) {
                amountDisplay.classList.add('amount-zero');
            } else {
                amountDisplay.classList.remove('amount-zero');
            }
        }
        if (amountInput) amountInput.value = amount;
        
        calculateTotalAmount();
    }
    
    // è®¡ç®—æ€»é‡‘é¢
    function calculateTotalAmount() {
        let total = 0;
        document.querySelectorAll('input[name="fee_amount"]').forEach(input => {
            total += parseFloat(input.value) || 0;
        });
        
        const formattedTotal = Math.round(total * 100) / 100;
        document.getElementById('total-amount').textContent = formattedTotal.toFixed(2);
        document.getElementById('total-amount-input').value = formattedTotal;
    }
    
    // ç§»é™¤è´¹ç”¨é¡¹ç›®
    function removeFeeItem(button) {
        if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè´¹ç”¨é¡¹ç›®å—ï¼Ÿ')) {
            button.closest('.fee-row').remove();
            calculateTotalAmount();
        }
    }
    
    // åˆ¤æ–­è´¹ç”¨æ˜¯å¦å·²å­˜åœ¨è¡¨æ ¼é‡Œ
    function isFeeAlreadyAdded(feeName) {
        const existingItems = document.querySelectorAll('input[name="fee_description"]');
        for (let item of existingItems) {
            if (item.value.trim() === feeName.trim()) {
                return true;
            }
        }
        return false;
    }

    // é€‰æ‹©æ ‡å‡†è´¹ç”¨
    function selectStandardFee(feeName, referencePrice) {
        if (isFeeAlreadyAdded(feeName)) {
            alert('è¯¥è´¹ç”¨é¡¹ç›®å·²å­˜åœ¨'); // å·²å­˜åœ¨å°±ä¸æ·»åŠ 
            return;
        }
        addFeeItem(feeName, referencePrice); // æ·»åŠ åˆ°è¡¨æ ¼
        closeAddFeeModal();
    }

    // æ‰“å¼€å¼¹æ¡†æ—¶åˆ·æ–°å¯é€‰è´¹ç”¨åˆ—è¡¨
    function refreshFeeOptions() {
        const existingItems = Array.from(document.querySelectorAll('input[name="fee_description"]')).map(i => i.value.trim());
        document.querySelectorAll('.fee-option').forEach(option => {
            const feeName = option.dataset.feeName.trim();
            option.style.display = existingItems.includes(feeName) ? 'none' : 'flex';
        });
    }

    // æ˜¾ç¤ºæ·»åŠ è´¹ç”¨æ¨¡æ€æ¡†
    function showAddFeeModal() {
        document.getElementById('addFeeModal').style.display = 'block';
        refreshFeeOptions(); // æ¯æ¬¡æ‰“å¼€å¼¹æ¡†éƒ½åˆ·æ–°æ˜¾ç¤º
    }

    // å…³é—­æ·»åŠ è´¹ç”¨æ¨¡æ€æ¡†
    function closeAddFeeModal() {
        document.getElementById('addFeeModal').style.display = 'none';
        document.getElementById('custom-fee-name').value = '';
        // åˆ·æ–°å¼¹æ¡†ï¼Œæ˜¾ç¤ºæ‰€æœ‰æœªæ·»åŠ è´¹ç”¨
        refreshFeeOptions();
    }
    
    // æ·»åŠ è‡ªå®šä¹‰è´¹ç”¨
    function addCustomFee() {
        const customFeeName = document.getElementById('custom-fee-name').value.trim();
        if (customFeeName) {
            addFeeItem(customFeeName, 'N/A');
            closeAddFeeModal();
        } else {
            alert('è¯·è¾“å…¥è´¹ç”¨åç§°');
        }
    }
    
    // æ·»åŠ è´¹ç”¨é¡¹ç›®åˆ°åˆ—è¡¨
    function addFeeItem(feeName, referencePrice) {
        // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
        const existingItems = document.querySelectorAll('input[name="fee_description"]');
        for (let item of existingItems) {
            if (item.value === feeName) {
                alert('è¯¥è´¹ç”¨é¡¹ç›®å·²å­˜åœ¨');
                return;
            }
        }
        
        const container = document.getElementById('fee-items-container');
        const newRow = document.createElement('div');
        newRow.className = 'fee-row';
        newRow.innerHTML = `
            <input type="hidden" name="fee_id" value="">
            <input type="hidden" name="fee_description" value="${feeName}">
            
            <div class="fee-cell">
                <span class="fee-name">${feeName}</span>
            </div>
            
            <div class="fee-cell">
                <span class="reference-price">${referencePrice}</span>
            </div>
            
            <div class="fee-cell">
                <input type="number" class="input-field rate-input" name="fee_rate" 
                       value="0" step="0.01" min="0"
                       oninput="calculateFeeTotal(this)">
            </div>
            
            <div class="fee-cell">
                <input type="number" class="input-field qty-input" name="fee_qty" 
                       value="1" step="0.1" min="0"
                       oninput="calculateFeeTotal(this)">
            </div>
            <div class="fee-cell">
                <input type="number" class="input-field surcharge-input" name="fee_surcharges" 
                    value="0" step="0.01"
                    oninput="calculateFeeTotal(this)"
                    placeholder="é™„åŠ è´¹">
            </div>
            <div class="fee-cell">
                <span class="amount-display">0.00</span>
                <input type="hidden" name="fee_amount" value="0">
            </div>
            
            <div class="fee-cell">
                <input type="text" class="input-field note-input" name="fee_note" 
                       value="" placeholder="å¤‡æ³¨ä¿¡æ¯">
            </div>
            
            <div class="fee-cell">
                <button type="button" class="remove-btn" onclick="removeFeeItem(this)">
                    Ã—
                </button>
            </div>
        `;
        container.appendChild(newRow);
        calculateTotalAmount();
    }
    
    // è®¾ç½®ä¿å­˜ç±»å‹
    function setSaveType(type) {
        document.getElementById('save_type').value = type;
    }
    
    // åˆå§‹åŒ–è®¡ç®—æ€»é‡‘é¢
    document.addEventListener('DOMContentLoaded', function() {
        calculateTotalAmount();
        
        // ä¸ºæ‰€æœ‰ç°æœ‰çš„è¾“å…¥æ¡†æ·»åŠ äº‹ä»¶ç›‘å¬
        document.querySelectorAll('.rate-input, .qty-input, .surcharge-input').forEach(input => {
            input.addEventListener('input', function() {
                calculateFeeTotal(this);
            });
        });
    });
    function openRulesModal() {
        document.getElementById("rules-modal").style.display = "flex";
    }

    function closeRulesModal() {
        document.getElementById("rules-modal").style.display = "none";
    }
</script>
{% endblock %}