{% extends 'base.html' %}

{% block content %}
<style>
    .status-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 6px;
        font-size: 13px;
        align-items: center;
    }
    .status-item {
        padding: 4px 6px;
        border-radius: 6px;
        text-align: center;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        border: 1px solid #ddd;
        background: #fafafa;
        line-height: 1.4;
    }
    .status-completed {
        background: #e9f7ef;
        color: #1e7e34;
        border-color: #b7e1cd;
    }

    .status-pending {
        background: #fff8e6;
        color: #8a6d3b;
        border-color: #f2ddb0;
    }

    .status-rejected {
        background: #fdecea;
        color: #b02a37;
        border-color: #f5c2c7;
    }

    .status-unstarted {
        background: #f2f3f5;
        color: #555;
        border-color: #dcdfe6;
    }

    .status-inprogress {
        background: #eef5ff;
        color: #1d4ed8;
        border-color: #c7ddff;
    }

    .same-container-row {
        background-color: #f7f9fc;
    }

    .invoice-number-cell {
        font-weight: 600;
        color: #2d7cf0;
    }
    .export-panel-wrap {
        display: flex;
        justify-content: center;
    }

    .export-panel {
        background: #f8fafc;
        border: 1px solid #e3e6eb;
        border-radius: 8px;
        padding: 12px 18px;
        margin: 12px 0 18px;
        display: flex;
        align-items: flex-end;
        gap: 14px;
    }

    .export-panel label {
        font-size: 13px;
        color: #444;
        margin-bottom: 6px;
    }

    .export-panel textarea {
        min-width: 360px;
        padding: 8px;
        border-radius: 6px;
        border: 1px solid #d0d5dd;
        font-size: 13px;
        resize: vertical;
    }

    .export-panel textarea:focus {
        outline: none;
        border-color: #2d7cf0;
        box-shadow: 0 0 0 2px rgba(45,124,240,0.1);
    }

    .export-panel button {
        padding: 8px 18px;
        border-radius: 6px;
        border: none;
        background: #2d7cf0;
        color: #fff;
        font-size: 13px;
        cursor: pointer;
        height: 36px;
    }

    .export-panel button:hover {
        background: #1f66d1;
    }
</style>

<div><h4><b>新账单表录入进度</b></h4></div>
<div style="width: 100%; display: flex; justify-content: space-between;">
    <form method="post" action="" style="width: 80%;">
        {% csrf_token %}
        <div>
            <b style="margin-right: 5px;">客户:</b>
            {{ order_form.customer_name }}
            <b style="margin-right: 5px; margin-left: 10px;">ETD时间:</b>
            <input type="date" name="start_date" value="{{ start_date }}">
            <input type="date" name="end_date" value="{{ end_date }}" style="margin-right: 5px;">
            <b style="margin-right: 5px;">选择仓点区域:</b>
                <select name="warehouse_filter">
                    {% for k, v in warehouse_options.items %}
                        {% if warehouse_filter == v %}
                            <option value="{{ v }}" selected>{{ k }}</option>
                        {% else %}
                            <option value="{{ v }}">{{ k }}</option>
                        {% endif %}
                    {% endfor %}
                </select>
            </b>
            <input type="hidden" name="step" value="invoice_search">
            <button id="submit-btn" type="submit" class="btn btn-primary" style="width: 100px; height: 35px; margin-left: 20px;">查询</button>
        </div>
    </form>
</div>

<div class="export-panel-wrap">
    <form method="post" class="export-panel">
        {% csrf_token %}
        <input type="hidden" name="step" value="export_details_invoicestatus">

        <div style="display:flex; flex-direction:column;">
            <label>Container 列表（空格分隔）</label>
            <textarea name="search_containers"
                      rows="3"
                      placeholder="例如: ABC123 DEF456 GHI789"></textarea>
        </div>

        <button type="submit">
            导出未录入详情
        </button>
    </form>
</div>

<div style="max-height: 100%; max-width: 1200px; padding: 20px; margin: 0 auto; background-color: #fff; border-radius: 8px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);">
    <table id="quote-table" class="table" style="font-size: 14px; width: 100%; border-collapse: collapse;">
        <thead>
            <tr style="background-color: #f1f1f1;">
                <th class="th" style="padding: 12px; border: 1px solid #ddd;text-align: center;">客户</th>
                <th class="th" style="padding: 12px; border: 1px solid #ddd;text-align: center;">柜号</th>
                <th class="th" style="padding: 12px; border: 1px solid #ddd;text-align: center;">发票号</th>
                <th class="th" style="padding: 12px; border: 1px solid #ddd;text-align: center;">分类</th>
                <th class="th" style="padding: 12px; border: 1px solid #ddd;text-align: center;">应付状态</th>
                <th class="th" style="padding: 12px; border: 1px solid #ddd;text-align: center;">应收状态</th>             
                <th class="th" style="padding: 12px; border: 1px solid #ddd;text-align: center;">应收是否拒绝</th>
                <th class="th" style="padding: 12px; border: 1px solid #ddd;text-align: center;">应收拒绝原因</th>
            </tr>
            <tr style="position: sticky; top: 28px;">
                <th class="th"></th>
                <th class="th" style="padding: 12px; border: 1px solid #ddd;text-align: center;">
                    <input type="text" id="containerSearchInput" placeholder="输入多个柜号（空格或换行分隔）..." oninput="filterTableByMultipleContainers(this)" size="20" style="font-size: 14px;">
                </th>
                <th class="th" style="padding: 12px; border: 1px solid #ddd;text-align: center;">
                    <input type="text" id="invoiceSearchInput" placeholder="搜索发票号..." oninput="filterTable(this, 2)" size="16" style="font-size: 14px;">
                </th>
                <th class="th"></th>
                <th class="th"></th>
                <th class="th" style="padding: 12px; border: 1px solid #ddd;text-align: center;">
                    <!-- 新增：应收状态搜索框 -->
                    <input type="text" id="receivableStatusSearchInput" placeholder="搜索状态..." oninput="filterReceivableStatus(this)" size="16" style="font-size: 14px;">
                </th>
                <th class="th"></th>
                <th class="th"></th>
            </tr>
        </thead>
        <tbody>
            {% for item in order_items %}
            {% with forloop.counter0 as row_index %}
            <form id="quote-form" method="post" enctype="multipart/form-data" action="">
                {% csrf_token %}
                <tr style="background-color: {% if item.invoice_number %}{% cycle '#fff' '#f9f9f9' %}{% else %}#f5f5f5{% endif %};"
                    class="{% if row_index > 0 and item.container_number == previous_container_number %}same-container-row{% endif %}">
                    <td class="td" style="padding: 12px; border: 1px solid #ddd; text-align: center;vertical-align: middle">
                        {{ item.customer_name.zem_name }}
                    </td>
                    <td class="td" style="padding: 12px; border: 1px solid #ddd; text-align: center;vertical-align: middle">
                        {{ item.container_number }}
                    </td>
                    <td class="td invoice-number-cell" style="padding: 12px; border: 1px solid #ddd; text-align: center;vertical-align: middle">
                        {% if item.invoice_number %}
                            {{ item.invoice_number }}
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td class="td" style="padding: 12px; border: 1px solid #ddd; text-align: center;vertical-align: middle">
                        {% if item.container_number.delivery_type == 'mixed' %}
                            混合
                        {% elif item.container_number.delivery_type == 'public' %}
                            公仓
                        {% elif item.container_number.delivery_type == 'other' %}
                            私仓
                        {% else %}
                            {{ item.container_number.delivery_type }} 
                        {% endif %}
                    </td>
                    <td class="td" style="padding: 12px; border: 1px solid #ddd; text-align: center;vertical-align: middle; white-space: pre-line;">
                        {% if item.payable_status %}{{ item.display_stage }}
                        {% elif not item.receivable_status and not item.payable_status %}{{ item.display_stage }}{% endif %}
                    </td>
                    <td class="td" style="padding: 10px; border: 1px solid #ddd; text-align: center;vertical-align: middle;">
                        {% if item.display_key_status %}
                            {{ item.display_key_status }}
                        {% else %}
                            <div class="status-grid">
                                <div class="status-item status-{{ item.display_preport_status_class }}">港前:{{ item.display_preport_status }}</div>
                                <div class="status-item status-{{ item.display_warehouse_public_status_class }}">公仓仓库:{{ item.display_warehouse_public_status }}</div>
                                <div class="status-item status-{{ item.display_warehouse_other_status_class }}">私仓仓库:{{ item.display_warehouse_other_status }}</div>
                                <div class="status-item status-{{ item.display_delivery_public_status_class }}">公仓派送:{{ item.display_delivery_public_status }}</div>
                                <div class="status-item status-{{ item.display_delivery_other_status_class }}">私仓派送:{{ item.display_delivery_other_status }}</div>
                                <div class="status-item status-{{ item.display_finance_status_class }}">财务:{{ item.display_finance_status }}</div>
                            </div>
                        {% endif %}
                    </td>
                    
                    <td class="td" style="padding: 12px; border: 1px solid #ddd; text-align: center;vertical-align: middle">
                        {{ item.receivable_is_rejected }}
                    </td>
                    <td class="td" style="padding: 12px; border: 1px solid #ddd; text-align: center;vertical-align: middle">
                        {{ item.receivable_reject_reason }}
                    </td>
                </tr>
                {% with item.container_number as previous_container_number %}
            </form>
            {% endwith %}
            {% endwith %}
            {% endfor %}
        </tbody>
    </table>
</div>
<script>
    // 修改柜号搜索函数，支持多个柜号搜索
    function filterTableByMultipleContainers(filterInput) {
        var searchText = filterInput.value.toUpperCase();
        var table = filterInput.closest('table');
        var tbody = table.getElementsByTagName("tbody")[0];
        var tr = tbody.getElementsByTagName("tr");
        
        // 分割搜索条件：支持空格、逗号、分号、换行符作为分隔符
        var searchTerms = searchText.split(/[\s,;\n]+/).filter(term => term.trim() !== '');
        
        // 如果没有搜索条件，显示所有行
        if (searchTerms.length === 0) {
            for (var i = 0; i < tr.length; i++) {
                tr[i].style.display = "";
            }
            return;
        }
        
        for (var i = 0; i < tr.length; i++) {
            var containerTd = tr[i].getElementsByTagName("td")[1]; // 柜号在第2列（索引1）
            if (containerTd) {
                var containerText = containerTd.textContent || containerTd.innerText;
                containerText = containerText.toUpperCase().trim();
                
                var shouldShow = false;
                
                // 检查柜号是否匹配任何一个搜索条件
                for (var j = 0; j < searchTerms.length; j++) {
                    if (containerText.indexOf(searchTerms[j]) > -1) {
                        shouldShow = true;
                        break;
                    }
                }
                
                if (shouldShow) {
                    tr[i].style.display = "";
                } else {
                    tr[i].style.display = "none";
                }
            }
        }
    };
    function filterTable(filterInput, col_idx) {
        var containerInput, containerFilter, table, tbody, tr, containerTd, i, containerTxtValue;
        containerFilter = filterInput.value.toUpperCase();
        var table = filterInput.closest('table');
        tbody = table.getElementsByTagName("tbody")[0];
        tr = tbody.getElementsByTagName("tr");

        for (i = 0; i < tr.length; i++) {
            containerTd = tr[i].getElementsByTagName("td")[col_idx];
            if (containerTd) {
                containerTxtValue = containerTd.textContent || containerTd.innerText;
                containerTxtValue = containerTxtValue.toUpperCase();
                
                if (containerTxtValue.indexOf(containerFilter) > -1) {
                    tr[i].style.display = "";
                } else {
                    tr[i].style.display = "none";
                }
            }
        }
    };
    
    // 新增：应收状态搜索函数
    function filterReceivableStatus(filterInput) {
        var statusFilter = filterInput.value.toUpperCase();
        var table = filterInput.closest('table');
        var tbody = table.getElementsByTagName("tbody")[0];
        var tr = tbody.getElementsByTagName("tr");

        for (var i = 0; i < tr.length; i++) {
            var statusTd = tr[i].getElementsByTagName("td")[5]; // 应收状态在第6列（索引5）
            if (statusTd) {
                var statusText = statusTd.textContent || statusTd.innerText;
                statusText = statusText.toUpperCase();
                
                if (statusText.indexOf(statusFilter) > -1) {
                    tr[i].style.display = "";
                } else {
                    tr[i].style.display = "none";
                }
            }
        }
    };
    window.addEventListener('load', function () {
        const customerSelect = document.getElementById('id_customer_name');
        const selectedCustomerId = "{{ selected_customer_id|default:'' }}";

        if (selectedCustomerId && customerSelect) {
            customerSelect.value = selectedCustomerId;
        }
    });
</script>
{% endblock %}