{% extends 'base.html' %}
{% load static %}

{% block title %}应收账单明细管理 - {{ container_number }}{% endblock %}

{% block content %}
<style>
    :root {
        --primary-color: #1b5e20;
        --primary-light: #4caf50;
        --primary-dark: #0d3d14;
        --secondary-color: #2e7d32;
        --accent-color: #ff9800;
        --text-primary: #212121;
        --text-secondary: #666;
        --border-color: #e0e0e0;
        --table-header-bg: #f5f7fa;
        --row-hover-bg: #fafdf8;
        --disabled-bg: #f8f9fa;
        --success-color: #2e7d32;
        --warning-color: #ff9800;
        --error-color: #d32f2f;
        --info-color: #1976d2;
    }

    .finance-container {
        max-width: 100%;
        margin: 0 auto;
        padding: 0;
        background: white;
        min-height: 100vh;
    }

    /* 头部样式 */
    .system-header {
        background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary-color) 100%);
        color: white;
        padding: 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .header-main {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 24px 30px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .header-title {
        display: flex;
        align-items: center;
        gap: 16px;
    }

    .header-title h1 {
        margin: 0;
        font-weight: 500;
        font-size: 1.8rem;
        letter-spacing: -0.3px;
    }

    .header-subtitle {
        font-size: 1rem;
        opacity: 0.8;
        margin-top: 4px;
    }

    .header-status {
        display: flex;
        flex-direction: column;
        gap: 12px;
        background: rgba(255, 255, 255, 0.1);
        padding: 16px 20px;
        border-radius: 8px;
        backdrop-filter: blur(8px);
        border: 1px solid rgba(255, 255, 255, 0.15);
    }

    .info-group {
        display: flex;
        gap: 20px;
        align-items: center;
    }

    .info-badge {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 0.95rem;
        background: rgba(255, 255, 255, 0.08);
        padding: 6px 12px;
        border-radius: 6px;
        border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .info-badge i {
        font-size: 0.9rem;
        opacity: 0.8;
    }

    .info-badge strong {
        color: #c8e6c9;
        margin-right: 4px;
        font-weight: 500;
    }

    /* 按钮样式 */
    .btn {
        padding: 9px 20px;
        border-radius: 6px;
        font-weight: 500;
        font-size: 0.9rem;
        border: 1px solid var(--border-color);
        cursor: pointer;
        transition: all 0.2s ease;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        background: white;
        color: var(--text-primary);
    }

    .btn:hover {
        background: #f5f5f5;
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .btn-primary {
        background: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
    }

    .btn-primary:hover {
        background: var(--primary-dark);
    }

    .btn-success {
        background: var(--success-color);
        color: white;
        border-color: var(--success-color);
    }

    .btn-success:hover {
        background: #1b5e20;
    }

    .btn-add {
        background: #2196f3;
        color: white;
        border: none;
    }

    .btn-add:hover {
        background: #1976d2;
    }

    .btn-delete {
        background: #f44336;
        color: white;
        border: none;
        padding: 6px 12px;
        border-radius: 4px;
        font-size: 0.85rem;
        cursor: pointer;
    }

    .btn-delete:hover {
        background: #d32f2f;
    }

    /* 表格样式 */
    .table-container {
        padding: 0 30px 30px;
        overflow-x: auto;
    }

    .advanced-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.9rem;
        background: white;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        overflow: hidden;
        min-width: 1600px;
    }

    .advanced-table thead {
        background: var(--table-header-bg);
    }

    .advanced-table th {
        padding: 16px 12px;
        text-align: left;
        font-weight: 600;
        color: var(--text-primary);
        border-bottom: 2px solid var(--border-color);
        font-size: 0.85rem;
        white-space: nowrap;
        position: relative;
    }

    .advanced-table tbody tr {
        border-bottom: 1px solid var(--border-color);
        transition: background-color 0.2s ease;
    }

    .advanced-table tbody tr:last-child {
        border-bottom: none;
    }

    .advanced-table tbody tr:hover {
        background-color: var(--row-hover-bg);
    }

    .advanced-table td {
        padding: 16px 12px;
        vertical-align: middle;
        color: var(--text-primary);
        border-right: 1px solid #f0f0f0;
    }

    .advanced-table td:last-child {
        border-right: none;
    }

    /* 表单控件样式 */
    .form-control {
        width: 100%;
        padding: 8px 10px;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        background: white;
        color: var(--text-primary);
        font-size: 0.9rem;
        transition: all 0.2s ease;
        box-sizing: border-box;
    }

    .form-control:focus {
        outline: none;
        border-color: var(--primary-light);
        box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.1);
    }

    .form-control-sm {
        padding: 6px 8px;
        font-size: 0.85rem;
    }

    /* 选择器样式 */
    .select-wrapper {
        position: relative;
    }

    .select-control {
        width: 100%;
        padding: 8px 30px 8px 10px;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        background: white;
        color: var(--text-primary);
        font-size: 0.9rem;
        appearance: none;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .select-control:focus {
        outline: none;
        border-color: var(--primary-light);
        box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.1);
    }

    .select-wrapper::after {
        content: '▼';
        position: absolute;
        right: 12px;
        top: 50%;
        transform: translateY(-50%);
        font-size: 0.7rem;
        color: var(--text-secondary);
        pointer-events: none;
    }

    /* 数字输入框 */
    .number-input {
        text-align: right;
    }

    .number-input:focus {
        text-align: right;
    }

    /* 金额输入框 */
    .amount-input {
        font-weight: 600;
        color: var(--primary-color);
        background: #f8f9fa;
        border-color: #c8e6c9;
        text-align: right;
    }

    /* 新增行样式 */
    .row-new {
        background-color: #fffaf0 !important;
        animation: highlightNewRow 2s ease-in-out;
    }

    @keyframes highlightNewRow {
        0% { background-color: #fffaf0; }
        50% { background-color: #fff3e0; }
        100% { background-color: #fffaf0; }
    }

    /* 操作列 */
    .cell-action {
        min-width: 120px;
        white-space: nowrap;
    }

    .action-buttons {
        display: flex;
        gap: 8px;
        justify-content: center;
    }

    /* 总计区域 */
    .total-section {
        margin: 20px 30px 0;
        padding: 20px;
        background: linear-gradient(135deg, #f8f9fa 0%, #f5f7fa 100%);
        border-radius: 8px;
        border: 1px solid var(--border-color);
    }

    .total-row {
        display: flex;
        justify-content: flex-end;
        align-items: center;
        gap: 30px;
    }

    .total-item {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
    }

    .total-label {
        font-size: 0.9rem;
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 5px;
    }

    .total-value {
        font-size: 1.6rem;
        font-weight: 600;
        color: var(--primary-color);
    }

    /* 表单操作区域 */
    .form-actions {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 25px 30px;
        border-top: 1px solid var(--border-color);
        background: white;
        margin-top: 20px;
    }

    .form-buttons {
        display: flex;
        gap: 12px;
    }

    /* 响应式调整 */
    @media (max-width: 1400px) {
        .table-container {
            overflow-x: auto;
            padding: 0 20px 20px;
        }
        
        .advanced-table {
            min-width: 1800px;
        }
    }

    /* 类别标签样式 */
    .category-badge {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 0.8rem;
        font-weight: 500;
        text-align: center;
        white-space: nowrap;
        border: 1px solid transparent;
    }

    .category-preport {
        background: #e3f2fd;
        color: #1565c0;
        border-color: #bbdefb;
    }

    .category-warehouse_public {
        background: #e8f5e9;
        color: #2e7d32;
        border-color: #c8e6c9;
    }

    .category-warehouse_other {
        background: #fff3e0;
        color: #ef6c00;
        border-color: #ffe0b2;
    }

    .category-delivery_public {
        background: #f3e5f5;
        color: #7b1fa2;
        border-color: #e1bee7;
    }

    .category-delivery_other {
        background: #e0f2f1;
        color: #00695c;
        border-color: #b2dfdb;
    }

    .category-activation_fee {
        background: #ffebee;
        color: #c62828;
        border-color: #ffcdd2;
    }

    /* 必填字段标识 */
    .required-field::after {
        content: ' *';
        color: #f44336;
    }

    /* 工具提示 */
    .tooltip-wrapper {
        position: relative;
        display: inline-block;
    }

    .tooltip-wrapper:hover .tooltip-text {
        visibility: visible;
        opacity: 1;
    }

    .tooltip-text {
        visibility: hidden;
        width: 200px;
        background-color: rgba(0, 0, 0, 0.9);
        color: #fff;
        text-align: center;
        border-radius: 6px;
        padding: 8px;
        position: absolute;
        z-index: 1;
        bottom: 125%;
        left: 50%;
        transform: translateX(-50%);
        opacity: 0;
        transition: opacity 0.3s;
        font-size: 0.8rem;
        font-weight: normal;
        white-space: normal;
    }

    .tooltip-text::after {
        content: "";
        position: absolute;
        top: 100%;
        left: 50%;
        margin-left: -5px;
        border-width: 5px;
        border-style: solid;
        border-color: rgba(0, 0, 0, 0.9) transparent transparent transparent;
    }
</style>

<div class="finance-container">
    <!-- 头部 -->
    <header class="system-header">
        <div class="header-main">
            <div class="header-title">
                <div>
                    <h1>应收账单明细管理</h1>
                    <div class="header-subtitle">柜号：{{ container_number }}</div>
                </div>
            </div>
            <div class="header-status">
                <div class="info-group">
                    <button onclick="window.history.back()" style="background: linear-gradient(135deg, #9ca3af, #6b7280);
                            border: 1px solid rgba(255,255,255,0.3);
                            color: white;
                            padding: 10px 20px;
                            border-radius: 8px;
                            cursor: pointer;
                            display: flex;
                            align-items: center;
                            gap: 8px;
                            transition: all 0.2s ease;">
                        <i class="fas fa-arrow-left"></i>
                        返回
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- 主要内容 -->
    <main class="main-content">
        <form method="post" id="invoice-items-form">
            {% csrf_token %}
            <input type="hidden" name="container_number" value="{{ container_number }}">
            <input type="hidden" name="invoice_id" value="{{ invoice_id }}">
            <input type="hidden" name="step" value="save_all_items">
            
            <!-- 按钮区域 -->
            <div class="form-actions" style="border-top: none; padding: 20px 30px;">
                <button type="button" class="btn btn-add" onclick="addNewRow()">
                    <i class="fas fa-plus"></i>
                    新增费用项
                </button>
                <div class="form-buttons">
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-save"></i>
                        保存所有修改
                    </button>
                    <button type="button" class="btn btn-primary" onclick="recalculateAll()">
                        <i class="fas fa-calculator"></i>
                        重新计算
                    </button>
                </div>
            </div>

            <!-- 费用明细表格 -->
            <div class="table-container">
                <table class="advanced-table" id="invoice-items-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th class="required-field">费用类别</th>
                            <th>描述</th>
                            <th>CBM</th>
                            <th>体积占比</th>
                            <th>重量</th>
                            <th>数量</th>
                            <th>单价</th>
                            <th>附加费</th>
                            <th>总金额</th>
                            <th>PO_ID</th>
                            <th>派送类型</th>
                            <th>仓库代码</th>
                            <th>区域</th>
                            <th>区域价格</th>
                            <th>备注</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="invoice-items-body">
                        {% for item in items %}
                        <tr data-item-id="{{ item.id }}">
                            <!-- ID -->
                            <td>
                                <input type="hidden" name="item_id_{{ forloop.counter0 }}" value="{{ item.id }}">
                                {{ item.id|default:"新记录" }}
                            </td>
                            
                            <!-- 费用类别 -->
                            <td>
                                <div class="select-wrapper">
                                    <select name="item_category_{{ forloop.counter0 }}" class="select-control item-category" 
                                            onchange="updateCategoryDisplay(this)" required>
                                        <option value="">请选择</option>
                                        <option value="preport" {% if item.item_category == 'preport' %}selected{% endif %}>港前</option>
                                        <option value="warehouse_public" {% if item.item_category == 'warehouse_public' %}selected{% endif %}>公仓库内</option>
                                        <option value="warehouse_other" {% if item.item_category == 'warehouse_other' %}selected{% endif %}>私仓库内</option>
                                        <option value="delivery_public" {% if item.item_category == 'delivery_public' %}selected{% endif %}>公仓派送</option>
                                        <option value="delivery_other" {% if item.item_category == 'delivery_other' %}selected{% endif %}>私仓派送</option>
                                        <option value="activation_fee" {% if item.item_category == 'activation_fee' %}selected{% endif %}>激活费</option>
                                    </select>
                                </div>
                                <div class="category-display mt-2">
                                    {% if item.item_category %}
                                    <span class="category-badge category-{{ item.item_category }}">
                                        {% if item.item_category == 'preport' %}港前
                                        {% elif item.item_category == 'warehouse_public' %}公仓库内
                                        {% elif item.item_category == 'warehouse_other' %}私仓库内
                                        {% elif item.item_category == 'delivery_public' %}公仓派送
                                        {% elif item.item_category == 'delivery_other' %}私仓派送
                                        {% elif item.item_category == 'activation_fee' %}激活费
                                        {% endif %}
                                    </span>
                                    {% endif %}
                                </div>
                            </td>
                            
                            <!-- 描述 -->
                            <td>
                                <input type="text" name="description_{{ forloop.counter0 }}" 
                                       class="form-control" 
                                       value="{{ item.description|default:'' }}"
                                       placeholder="费用名称">
                            </td>
                            
                            <!-- CBM -->
                            <td>
                                <input type="number" name="cbm_{{ forloop.counter0 }}" 
                                       class="form-control number-input" 
                                       value="{{ item.cbm|default:'' }}"
                                       step="0.01" 
                                       min="0"
                                       placeholder="0.00"
                                       onchange="calculateAmount({{ forloop.counter0 }})">
                            </td>
                            
                            <!-- 体积占比 (对于delivery_public且delivery_type=combine时显示) -->
                            <td>
                                {% if item.item_category == 'delivery_public' and item.delivery_type == 'combine' %}
                                    <input type="number" name="cbm_ratio_{{ forloop.counter0 }}" 
                                           class="form-control number-input" 
                                           value="{{ item.cbm_ratio|default:'' }}"
                                           step="0.01" 
                                           min="0" 
                                           max="1"
                                           placeholder="0.00"
                                           onchange="calculateCombineDelivery({{ forloop.counter0 }})">
                                {% else %}
                                    <input type="number" name="cbm_ratio_{{ forloop.counter0 }}" 
                                           class="form-control number-input" 
                                           value="{{ item.cbm_ratio|default:'' }}"
                                           step="0.01" 
                                           min="0" 
                                           max="1"
                                           placeholder="0.00"
                                           style="display: none;"
                                           onchange="calculateAmount({{ forloop.counter0 }})">
                                    {{ item.cbm_ratio|default:'' }}
                                {% endif %}
                            </td>
                            
                            <!-- 重量 -->
                            <td>
                                <input type="number" name="weight_{{ forloop.counter0 }}" 
                                       class="form-control number-input" 
                                       value="{{ item.weight|default:'' }}"
                                       step="0.01" 
                                       min="0"
                                       placeholder="0.00"
                                       onchange="calculateAmount({{ forloop.counter0 }})">
                            </td>
                            
                            <!-- 数量 (对于delivery_public且delivery_type=combine时隐藏) -->
                            <td>
                                {% if item.item_category == 'delivery_public' and item.delivery_type == 'combine' %}
                                    <input type="number" name="qty_{{ forloop.counter0 }}" 
                                           class="form-control number-input" 
                                           value="{{ item.qty|default:'' }}"
                                           step="0.01" 
                                           min="0"
                                           placeholder="0.00"
                                           style="display: none;"
                                           onchange="calculateAmount({{ forloop.counter0 }})">
                                    <span class="text-muted">使用CBM占比</span>
                                {% else %}
                                    <input type="number" name="qty_{{ forloop.counter0 }}" 
                                           class="form-control number-input" 
                                           value="{{ item.qty|default:'' }}"
                                           step="0.01" 
                                           min="0"
                                           placeholder="0.00"
                                           onchange="calculateAmount({{ forloop.counter0 }})">
                                {% endif %}
                            </td>
                            
                            <!-- 单价 -->
                            <td>
                                <input type="number" name="rate_{{ forloop.counter0 }}" 
                                       class="form-control number-input" 
                                       value="{{ item.rate|default:'' }}"
                                       step="0.01" 
                                       min="0"
                                       placeholder="0.00"
                                       onchange="calculateAmount({{ forloop.counter0 }})">
                            </td>
                            
                            <!-- 附加费 -->
                            <td>
                                <input type="number" name="surcharges_{{ forloop.counter0 }}" 
                                       class="form-control number-input" 
                                       value="{{ item.surcharges|default:0 }}"
                                       step="0.01" 
                                       min="0"
                                       placeholder="0.00"
                                       onchange="calculateAmount({{ forloop.counter0 }})">
                            </td>
                            
                            <!-- 总金额 -->
                            <td>
                                <input type="number" name="amount_{{ forloop.counter0 }}" 
                                       class="form-control amount-input" 
                                       value="{{ item.amount|default:0 }}"
                                       step="0.01" 
                                       min="0"
                                       placeholder="0.00"
                                       readonly>
                            </td>
                            
                            <!-- PO_ID -->
                            <td>
                                <input type="text" name="PO_ID_{{ forloop.counter0 }}" 
                                       class="form-control form-control-sm" 
                                       value="{{ item.PO_ID|default:'' }}"
                                       placeholder="PO号">
                            </td>
                            
                            <!-- 派送类型 -->
                            <td>
                                <div class="select-wrapper">
                                    <select name="delivery_type_{{ forloop.counter0 }}" 
                                            class="select-control delivery-type"
                                            onchange="updateDeliveryTypeDisplay({{ forloop.counter0 }})">
                                        <option value="">请选择</option>
                                        <option value="amazon" {% if item.delivery_type == 'amazon' %}selected{% endif %}>亚马逊</option>
                                        <option value="combine" {% if item.delivery_type == 'combine' %}selected{% endif %}>组合柜</option>
                                        <option value="direct" {% if item.delivery_type == 'direct' %}selected{% endif %}>直送</option>
                                    </select>
                                </div>
                            </td>
                            
                            <!-- 仓库代码 -->
                            <td>
                                <input type="text" name="warehouse_code_{{ forloop.counter0 }}" 
                                       class="form-control form-control-sm" 
                                       value="{{ item.warehouse_code|default:'' }}"
                                       placeholder="目的地">
                            </td>
                            
                            <!-- 区域 -->
                            <td>
                                <input type="text" name="region_{{ forloop.counter0 }}" 
                                       class="form-control form-control-sm" 
                                       value="{{ item.region|default:'' }}"
                                       placeholder="区域">
                            </td>
                            
                            <!-- 区域价格 -->
                            <td>
                                <input type="number" name="regionPrice_{{ forloop.counter0 }}" 
                                       class="form-control number-input form-control-sm" 
                                       value="{{ item.regionPrice|default:'' }}"
                                       step="0.01" 
                                       min="0"
                                       placeholder="0.00">
                            </td>
                            
                            <!-- 备注 -->
                            <td>
                                <input type="text" name="note_{{ forloop.counter0 }}" 
                                       class="form-control form-control-sm" 
                                       value="{{ item.note|default:'' }}"
                                       placeholder="备注">
                            </td>
                            
                            <!-- 操作 -->
                            <td class="cell-action">
                                <div class="action-buttons">
                                    <button type="button" class="btn-delete" onclick="deleteRow({{ forloop.counter0 }}, {{ item.id|default:'null' }})">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% empty %}
                        <tr id="no-data-row">
                            <td colspan="17" style="text-align: center; padding: 60px 20px; color: var(--text-secondary);">
                                <i class="fas fa-clipboard-list" style="font-size: 3rem; margin-bottom: 20px; color: #e0e0e0;"></i>
                                <p>暂无费用明细，请点击"新增费用项"添加</p>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- 总计区域 -->
            <div class="total-section">
                <div class="total-row">
                    <div class="total-item">
                        <div class="total-label">总金额 (USD)</div>
                        <div class="total-value" id="total-amount">0.00</div>
                    </div>
                </div>
            </div>

            <!-- 表单操作按钮 -->
            <div class="form-actions">
                <button type="button" class="btn btn-add" onclick="addNewRow()">
                    <i class="fas fa-plus"></i>
                    新增费用项
                </button>
                <div class="form-buttons">
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-save"></i>
                        保存所有修改
                    </button>
                    <button type="button" class="btn btn-primary" onclick="recalculateAll()">
                        <i class="fas fa-calculator"></i>
                        重新计算
                    </button>
                </div>
            </div>
        </form>
    </main>
</div>

<script>
// 全局变量
let rowCounter = {{ items|length|default:0 }};

// 页面加载完成后初始化
$(document).ready(function() {
    // 计算初始总金额
    calculateTotalAmount();
    
    // 为所有输入框绑定事件
    $('.item-category').each(function() {
        updateCategoryDisplay(this);
    });
    
    // 检查是否有delivery_public且delivery_type=combine的行
    $('tr[data-item-id]').each(function() {
        const rowIndex = $(this).index();
        updateDeliveryTypeDisplay(rowIndex);
    });
});

// 更新类别显示
function updateCategoryDisplay(selectElement) {
    const $select = $(selectElement);
    const $row = $select.closest('tr');
    const $display = $row.find('.category-display');
    const category = $select.val();
    
    $display.empty();
    
    if (category) {
        let categoryText = '';
        let categoryClass = '';
        
        switch(category) {
            case 'preport':
                categoryText = '港前';
                categoryClass = 'category-preport';
                break;
            case 'warehouse_public':
                categoryText = '公仓库内';
                categoryClass = 'category-warehouse_public';
                break;
            case 'warehouse_other':
                categoryText = '私仓库内';
                categoryClass = 'category-warehouse_other';
                break;
            case 'delivery_public':
                categoryText = '公仓派送';
                categoryClass = 'category-delivery_public';
                break;
            case 'delivery_other':
                categoryText = '私仓派送';
                categoryClass = 'category-delivery_other';
                break;
            case 'activation_fee':
                categoryText = '激活费';
                categoryClass = 'category-activation_fee';
                break;
        }
        
        $display.html(`<span class="category-badge ${categoryClass}">${categoryText}</span>`);
        
        // 更新派送类型显示
        const rowIndex = $row.index();
        updateDeliveryTypeDisplay(rowIndex);
    }
}

// 更新派送类型显示逻辑
function updateDeliveryTypeDisplay(rowIndex) {
    const $row = $(`#invoice-items-body tr:eq(${rowIndex})`);
    const category = $row.find('.item-category').val();
    const deliveryType = $row.find('.delivery-type').val();
    
    const $cbmRatioInput = $row.find('input[name^="cbm_ratio_"]');
    const $qtyInput = $row.find('input[name^="qty_"]');
    const $cbmRatioCell = $row.find('td:nth-child(5)');
    const $qtyCell = $row.find('td:nth-child(7)');
    
    // 重置显示
    $cbmRatioInput.show();
    $qtyInput.show();
    $qtyCell.find('.text-muted').remove();
    
    if (category === 'delivery_public' && deliveryType === 'combine') {
        // 组合柜公仓派送：显示cbm_ratio，隐藏qty
        $cbmRatioInput.show().attr('required', 'required');
        $qtyInput.hide();
        
        // 在数量列显示提示
        if ($qtyCell.find('.text-muted').length === 0) {
            $qtyCell.append('<div class="text-muted" style="font-size: 0.8rem; margin-top: 5px;">使用CBM占比</div>');
        }
        
        // 重新计算组合柜金额
        calculateCombineDelivery(rowIndex);
    } else {
        // 其他情况：正常显示
        $cbmRatioInput.removeAttr('required');
        $qtyInput.show();
        $qtyCell.find('.text-muted').remove();
        
        // 重新计算普通金额
        calculateAmount(rowIndex);
    }
}

// 计算组合柜派送金额
function calculateCombineDelivery(rowIndex) {
    const $row = $(`#invoice-items-body tr:eq(${rowIndex})`);
    
    const cbm = parseFloat($row.find('input[name^="cbm_"]').val()) || 0;
    const cbmRatio = parseFloat($row.find('input[name^="cbm_ratio_"]').val()) || 0;
    const rate = parseFloat($row.find('input[name^="rate_"]').val()) || 0;
    const surcharges = parseFloat($row.find('input[name^="surcharges_"]').val()) || 0;
    
    // 组合柜逻辑：amount = cbm * cbmRatio * rate + surcharges
    const amount = (cbm * cbmRatio * rate) + surcharges;
    
    $row.find('input[name^="amount_"]').val(amount.toFixed(2));
    
    // 更新总金额
    calculateTotalAmount();
}

// 计算单行金额
function calculateAmount(rowIndex) {
    const $row = $(`#invoice-items-body tr:eq(${rowIndex})`);
    
    const category = $row.find('.item-category').val();
    const deliveryType = $row.find('.delivery-type').val();
    
    // 如果是组合柜公仓派送，使用特殊计算
    if (category === 'delivery_public' && deliveryType === 'combine') {
        calculateCombineDelivery(rowIndex);
        return;
    }
    
    // 普通计算逻辑
    const qty = parseFloat($row.find('input[name^="qty_"]').val()) || 0;
    const rate = parseFloat($row.find('input[name^="rate_"]').val()) || 0;
    const surcharges = parseFloat($row.find('input[name^="surcharges_"]').val()) || 0;
    
    // 普通逻辑：amount = qty * rate + surcharges
    const amount = (qty * rate) + surcharges;
    
    $row.find('input[name^="amount_"]').val(amount.toFixed(2));
    
    // 更新总金额
    calculateTotalAmount();
}

// 计算总金额
function calculateTotalAmount() {
    let total = 0;
    
    $('input[name^="amount_"]').each(function() {
        const amount = parseFloat($(this).val()) || 0;
        total += amount;
    });
    
    $('#total-amount').text(total.toFixed(2));
    return total;
}

// 重新计算所有行
function recalculateAll() {
    $('tr[data-item-id]').each(function(index) {
        calculateAmount(index);
    });
    
    calculateTotalAmount();
    showToast('所有金额已重新计算', 'success');
}

// 新增行
function addNewRow() {
    // 移除"暂无数据"行
    $('#no-data-row').remove();
    
    const newRowIndex = rowCounter;
    rowCounter++;
    
    const newRow = `
    <tr data-item-id="new-${newRowIndex}" class="row-new">
        <!-- ID -->
        <td>
            <input type="hidden" name="item_id_${newRowIndex}" value="">
            新记录
        </td>
        
        <!-- 费用类别 -->
        <td>
            <div class="select-wrapper">
                <select name="item_category_${newRowIndex}" class="select-control item-category" 
                        onchange="updateCategoryDisplay(this)" required>
                    <option value="">请选择</option>
                    <option value="preport">港前</option>
                    <option value="warehouse_public">公仓库内</option>
                    <option value="warehouse_other">私仓库内</option>
                    <option value="delivery_public">公仓派送</option>
                    <option value="delivery_other">私仓派送</option>
                    <option value="activation_fee">激活费</option>
                </select>
            </div>
            <div class="category-display mt-2"></div>
        </td>
        
        <!-- 描述 -->
        <td>
            <input type="text" name="description_${newRowIndex}" 
                   class="form-control" 
                   value=""
                   placeholder="费用名称">
        </td>
        
        <!-- CBM -->
        <td>
            <input type="number" name="cbm_${newRowIndex}" 
                   class="form-control number-input" 
                   value=""
                   step="0.01" 
                   min="0"
                   placeholder="0.00"
                   onchange="calculateAmount(${newRowIndex})">
        </td>
        
        <!-- 体积占比 -->
        <td>
            <input type="number" name="cbm_ratio_${newRowIndex}" 
                   class="form-control number-input" 
                   value=""
                   step="0.01" 
                   min="0" 
                   max="1"
                   placeholder="0.00"
                   style="display: none;"
                   onchange="calculateAmount(${newRowIndex})">
        </td>
        
        <!-- 重量 -->
        <td>
            <input type="number" name="weight_${newRowIndex}" 
                   class="form-control number-input" 
                   value=""
                   step="0.01" 
                   min="0"
                   placeholder="0.00"
                   onchange="calculateAmount(${newRowIndex})">
        </td>
        
        <!-- 数量 -->
        <td>
            <input type="number" name="qty_${newRowIndex}" 
                   class="form-control number-input" 
                   value=""
                   step="0.01" 
                   min="0"
                   placeholder="0.00"
                   onchange="calculateAmount(${newRowIndex})">
        </td>
        
        <!-- 单价 -->
        <td>
            <input type="number" name="rate_${newRowIndex}" 
                   class="form-control number-input" 
                   value=""
                   step="0.01" 
                   min="0"
                   placeholder="0.00"
                   onchange="calculateAmount(${newRowIndex})">
        </td>
        
        <!-- 附加费 -->
        <td>
            <input type="number" name="surcharges_${newRowIndex}" 
                   class="form-control number-input" 
                   value="0"
                   step="0.01" 
                   min="0"
                   placeholder="0.00"
                   onchange="calculateAmount(${newRowIndex})">
        </td>
        
        <!-- 总金额 -->
        <td>
            <input type="number" name="amount_${newRowIndex}" 
                   class="form-control amount-input" 
                   value="0"
                   step="0.01" 
                   min="0"
                   placeholder="0.00"
                   readonly>
        </td>
        
        <!-- PO_ID -->
        <td>
            <input type="text" name="PO_ID_${newRowIndex}" 
                   class="form-control form-control-sm" 
                   value=""
                   placeholder="PO号">
        </td>
        
        <!-- 派送类型 -->
        <td>
            <div class="select-wrapper">
                <select name="delivery_type_${newRowIndex}" 
                        class="select-control delivery-type"
                        onchange="updateDeliveryTypeDisplay(${newRowIndex})">
                    <option value="">请选择</option>
                    <option value="amazon">亚马逊</option>
                    <option value="combine">组合柜</option>
                    <option value="direct">直送</option>
                </select>
            </div>
        </td>
        
        <!-- 仓库代码 -->
        <td>
            <input type="text" name="warehouse_code_${newRowIndex}" 
                   class="form-control form-control-sm" 
                   value=""
                   placeholder="目的地">
        </td>
        
        <!-- 区域 -->
        <td>
            <input type="text" name="region_${newRowIndex}" 
                   class="form-control form-control-sm" 
                   value=""
                   placeholder="区域">
        </td>
        
        <!-- 区域价格 -->
        <td>
            <input type="number" name="regionPrice_${newRowIndex}" 
                   class="form-control number-input form-control-sm" 
                   value=""
                   step="0.01" 
                   min="0"
                   placeholder="0.00">
        </td>
        
        <!-- 备注 -->
        <td>
            <input type="text" name="note_${newRowIndex}" 
                   class="form-control form-control-sm" 
                   value=""
                   placeholder="备注">
        </td>
        
        <!-- 操作 -->
        <td class="cell-action">
            <div class="action-buttons">
                <button type="button" class="btn-delete" onclick="deleteRow(${newRowIndex}, null)">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </td>
    </tr>`;
    
    $('#invoice-items-body').append(newRow);
    
    // 滚动到新行
    const $newRow = $(`tr[data-item-id="new-${newRowIndex}"]`);
    $('html, body').animate({
        scrollTop: $newRow.offset().top - 100
    }, 500);
    
    showToast('新增费用项成功', 'success');
}

// 删除行
function deleteRow(rowIndex, itemId) {
    if (!confirm('确定要删除这条记录吗？')) {
        return;
    }
    
    const $row = $(`#invoice-items-body tr:eq(${rowIndex})`);
    const isNew = $row.data('item-id').toString().startsWith('new');
    
    if (!isNew && itemId) {
        // 已有记录，需要向后端发送删除请求
        $.ajax({
            url: window.location.pathname,
            method: 'POST',
            data: {
                csrfmiddlewaretoken: $('input[name="csrfmiddlewaretoken"]').val(),
                step: 'delete_item',
                item_id: itemId,
                container_number: '{{ container_number }}',
                invoice_id: '{{ invoice_id }}'
            },
            success: function(response) {
                if (response.success) {
                    $row.remove();
                    recalculateTotalAmount();
                    showToast('删除成功', 'success');
                } else {
                    showToast('删除失败：' + response.message, 'error');
                }
            },
            error: function() {
                showToast('删除失败，请重试', 'error');
            }
        });
    } else {
        // 新记录，直接删除
        $row.remove();
        recalculateTotalAmount();
        showToast('删除成功', 'success');
    }
    
    // 如果没有数据行了，显示"暂无数据"
    if ($('#invoice-items-body tr').length === 0) {
        $('#invoice-items-body').html(`
            <tr id="no-data-row">
                <td colspan="17" style="text-align: center; padding: 60px 20px; color: var(--text-secondary);">
                    <i class="fas fa-clipboard-list" style="font-size: 3rem; margin-bottom: 20px; color: #e0e0e0;"></i>
                    <p>暂无费用明细，请点击"新增费用项"添加</p>
                </td>
            </tr>
        `);
    }
}

// 表单提交前验证
$('#invoice-items-form').on('submit', function(e) {
    let hasError = false;
    
    // 检查必填字段
    $('.item-category').each(function() {
        if (!$(this).val()) {
            showToast('请选择所有费用类别', 'error');
            $(this).focus();
            hasError = true;
            return false;
        }
    });
    
    if (hasError) {
        e.preventDefault();
        return false;
    }
    
    // 显示加载提示
    const $submitBtn = $(this).find('button[type="submit"]');
    const originalText = $submitBtn.html();
    $submitBtn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> 保存中...');
    
    // 5秒后恢复按钮（防止卡死）
    setTimeout(() => {
        $submitBtn.prop('disabled', false).html(originalText);
    }, 5000);
    
    return true;
});

// Toast提示函数
function showToast(message, type = 'success') {
    // 移除现有的toast
    $('.custom-toast').remove();
    
    const toastClass = type === 'success' ? 'bg-success' : 'bg-danger';
    const icon = type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle';
    
    const toast = `
        <div class="toast custom-toast align-items-center text-white ${toastClass} border-0 show" 
             role="alert" aria-live="assertive" aria-atomic="true" style="position: fixed; top: 20px; right: 20px; z-index: 9999;">
            <div class="d-flex">
                <div class="toast-body">
                    <i class="fas ${icon} me-2"></i>
                    ${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        </div>
    `;
    
    $('body').append(toast);
    
    // 5秒后自动移除
    setTimeout(() => {
        $('.custom-toast').remove();
    }, 5000);
}

// 重新计算总金额（删除后使用）
function recalculateTotalAmount() {
    calculateTotalAmount();
}
</script>

{% endblock %}