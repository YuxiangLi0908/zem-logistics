{% extends 'base.html' %}
{% load static %}

{% block title %}私仓派送账单录入 - {{ container_number }}{% endblock %}

{% block content %}
<style>
    :root {
        --primary-color: #1b5e20;
        --primary-light: #4caf50;
        --primary-dark: #0d3d14;
        --secondary-color: #2e7d32;
        --accent-color: #ff9800;
        --text-primary: #212121;
        --text-secondary: #666;
        --border-color: #e0e0e0;
        --table-header-bg: #f5f7fa;
        --row-hover-bg: #fafdf8;
        --disabled-bg: #f8f9fa;
        --success-color: #2e7d32;
        --warning-color: #ff9800;
        --error-color: #d32f2f;
    }

    .finance-container {
        max-width: 100%;
        margin: 0 auto;
        padding: 0;
        background: white;
        min-height: 100vh;
    }

    /* 头部样式 */
    .system-header {
        background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary-color) 100%);
        color: white;
        padding: 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .header-main {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 24px 30px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .header-title {
        display: flex;
        align-items: center;
        gap: 16px;
    }

    .header-title h1 {
        margin: 0;
        font-weight: 500;
        font-size: 1.8rem;
        letter-spacing: -0.3px;
    }

    .header-subtitle {
        font-size: 1rem;
        opacity: 0.8;
        margin-top: 4px;
    }

    .header-status {
        display: flex;
        flex-direction: column;
        gap: 12px;
        background: rgba(255, 255, 255, 0.1);
        padding: 16px 20px;
        border-radius: 8px;
        backdrop-filter: blur(8px);
        border: 1px solid rgba(255, 255, 255, 0.15);
    }
    .info-group {
        display: flex;
        gap: 20px;
        align-items: center;
    }

    .info-badge {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 0.95rem;
        background: rgba(255, 255, 255, 0.08);
        padding: 6px 12px;
        border-radius: 6px;
        border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .info-badge i {
        font-size: 0.9rem;
        opacity: 0.8;
    }

    .info-badge strong {
        color: #c8e6c9;
        margin-right: 4px;
        font-weight: 500;
    }

    /* 信息栏 */
    .info-bar {
        padding: 20px 30px;
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: 20px;
        background: rgba(0, 0, 0, 0.02);
        border-bottom: 1px solid rgba(0, 0, 0, 0.05);
    }

    .info-item {
        position: relative;
    }

    .info-label {
        font-size: 0.8rem;
        color: #666;
        margin-bottom: 6px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-weight: 500;
    }

    .info-value {
        font-size: 1rem;
        color: var(--text-primary);
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .info-value .icon {
        color: var(--primary-color);
        font-size: 0.9rem;
        opacity: 0.7;
    }

    .info-item:not(:last-child)::after {
        content: '';
        position: absolute;
        right: -10px;
        top: 50%;
        transform: translateY(-50%);
        height: 40px;
        width: 1px;
        background: rgba(0, 0, 0, 0.1);
    }

    /* 主要内容区域 */
    .main-content {
        padding: 0;
    }

    /* 操作工具栏 */
    .toolbar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 18px 30px;
        border-bottom: 1px solid var(--border-color);
        background: white;
    }

    .toolbar-title {
        font-size: 1.1rem;
        font-weight: 500;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .toolbar-title .count {
        background: var(--primary-light);
        color: white;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.9rem;
        font-weight: 500;
    }

    .toolbar-actions {
        display: flex;
        gap: 10px;
    }

    /* 按钮样式 */
    .btn {
        padding: 9px 20px;
        border-radius: 6px;
        font-weight: 500;
        font-size: 0.9rem;
        border: 1px solid var(--border-color);
        cursor: pointer;
        transition: all 0.2s ease;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        background: white;
        color: var(--text-primary);
    }

    .btn:hover {
        background: #f5f5f5;
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .btn-primary {
        background: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
    }

    .btn-primary:hover {
        background: var(--primary-dark);
    }

    .btn-success {
        background: var(--success-color);
        color: white;
        border-color: var(--success-color);
    }

    .btn-success:hover {
        background: #1b5e20;
    }

    /* 高级表格样式 */
    .table-container {
        padding: 0 30px 30px;
    }

    .advanced-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.9rem;
        background: white;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        overflow: hidden;
    }

    .advanced-table thead {
        background: var(--table-header-bg);
    }

    .advanced-table th {
        padding: 16px 14px;
        text-align: left;
        font-weight: 600;
        color: var(--text-primary);
        border-bottom: 1px solid var(--border-color);
        text-transform: uppercase;
        letter-spacing: 0.3px;
        font-size: 0.85rem;
        white-space: nowrap;
    }

    .advanced-table tbody tr {
        border-bottom: 1px solid var(--border-color);
        transition: background-color 0.2s ease;
        position: relative;
    }

    .advanced-table tbody tr:last-child {
        border-bottom: none;
    }

    .advanced-table tbody tr:hover {
        background-color: var(--row-hover-bg);
    }

    .row-new {
        background-color: #fffaf0;
    }

    .row-new:hover {
        background-color: #fff8e6 !important;
    }

    .row-existing {
        background-color: white;
    }

    .advanced-table td {
        padding: 18px 14px;
        vertical-align: middle;
        color: var(--text-primary);
        border-right: 1px solid #f0f0f0;
    }

    .advanced-table td:last-child {
        border-right: none;
    }

    /* 单元格特定样式 */
    .cell-mark {
        max-width: 220px;
        min-width: 200px;
    }

    .mark-text {
        font-weight: 500;
        line-height: 1.4;
        font-size: 0.95rem;
        overflow: hidden;
        text-overflow: ellipsis;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
    }

    .cell-destination {
        min-width: 140px;
        font-weight: 500;
    }

    .cell-stats {
        text-align: center;
    }

    .stat-value {
        font-weight: 500;
        color: var(--text-primary);
    }

    /* 选择器样式 */
    .select-wrapper {
        position: relative;
        min-width: 140px;
    }

    .select-control {
        width: 100%;
        padding: 9px 32px 9px 12px;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        background: white;
        color: var(--text-primary);
        font-size: 0.9rem;
        appearance: none;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .select-control:focus {
        outline: none;
        border-color: var(--primary-light);
        box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.1);
    }

    .select-wrapper::after {
        content: '▼';
        position: absolute;
        right: 12px;
        top: 50%;
        transform: translateY(-50%);
        font-size: 0.7rem;
        color: var(--text-secondary);
        pointer-events: none;
    }

    /* 输入框样式 */
    .input-control {
        width: 100%;
        padding: 9px 10px;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        background: white;
        color: var(--text-primary);
        font-size: 0.9rem;
        transition: all 0.2s ease;
    }

    .input-control:focus {
        outline: none;
        border-color: var(--primary-light);
        box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.1);
        background: white;
    }

    .input-control:disabled {
        background-color: #fafafa;
        border-color: #eee;
        color: #999;
        cursor: not-allowed;
    }

    .input-pallets {
        width: 70px;
        text-align: center;
        background: #f8f9fa;
        border-color: #e8f5e9;
        color: var(--primary-color);
        font-weight: 500;
    }

    .input-rate {
        width: 90px;
        text-align: right;
    }

    .input-rate:disabled {
        background: #f5f5f5;
        color: #999;
    }

    .input-surcharge {
        width: 85px;
        text-align: right;
    }

    .input-amount {
        width: 100px;
        text-align: right;
        font-weight: 600;
        color: var(--primary-color);
        border-color: #c8e6c9;
        background: #f8f9fa;
    }

    .input-note {
        width: 120px;
    }

    .cell-po {
        text-align: center;
        color: #666;
        font-size: 0.85rem;
    }

    /* 状态指示器 */
    .cell-status {
        text-align: center;
    }

    .status-indicator {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 5px 10px;
        border-radius: 4px;
        font-size: 0.8rem;
        font-weight: 500;
        background: rgba(255, 152, 0, 0.1);
        color: var(--warning-color);
    }

    .status-indicator.existing {
        background: rgba(46, 125, 50, 0.1);
        color: var(--success-color);
    }

    .status-indicator .icon {
        font-size: 0.8rem;
    }

    /* 表单提交区域 */
    .form-actions {
        display: flex;
        justify-content: flex-end;
        padding: 25px 30px;
        border-top: 1px solid var(--border-color);
        background: white;
    }

    .form-buttons {
        display: flex;
        gap: 12px;
    }

    /* Toast样式 */
    .toast-container {
        position: fixed;
        top: 30px;
        right: 30px;
        z-index: 9999;
    }

    .toast {
        border-radius: 6px;
        border: none;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
        backdrop-filter: blur(10px);
    }

    .toast-success {
        background: rgba(46, 125, 50, 0.95) !important;
        border: 1px solid rgba(76, 175, 80, 0.2);
    }

    .toast-error {
        background: rgba(211, 47, 47, 0.95) !important;
        border: 1px solid rgba(244, 67, 54, 0.2);
    }
    .header-info {
        display: flex;
        gap: 30px;
        align-items: center;
    }

    .info-badge {
        background: rgba(255, 255, 255, 0.15);
        padding: 8px 16px;
        border-radius: 8px;
        font-size: 0.9rem;
    }

    .info-badge strong {
        color: #a5d6a7;
        margin-right: 8px;
    }
    .row-hold {
        background-color: #f5f5f5 !important;
    }

    .row-hold:hover {
        background-color: #eeeeee !important;
    }

    .row-hold td {
        color: #999;
    }

    .row-hold .input-control {
        background-color: #fafafa;
        border-color: #e0e0e0;
        color: #999;
    }

    .row-hold .select-control {
        background-color: #fafafa;
        border-color: #e0e0e0;
        color: #666;
    }

    /* 操作列样式 */
    .cell-action {
        text-align: center;
        min-width: 120px;
    }

    .action-btn {
        padding: 6px 12px;
        border-radius: 4px;
        font-size: 0.85rem;
        font-weight: 500;
        cursor: pointer;
        border: none;
        transition: all 0.2s ease;
        display: inline-flex;
        align-items: center;
        gap: 6px;
    }

    .btn-save-row {
        background: var(--primary-color);
        color: white;
    }

    .btn-save-row:hover {
        background: var(--primary-dark);
        transform: translateY(-1px);
    }

    .btn-release {
        background: var(--warning-color);
        color: white;
    }

    .btn-release:hover {
        background: #f57c00;
        transform: translateY(-1px);
    }

    .btn-save-row:disabled,
    .btn-release:disabled {
        background: #ccc;
        color: #666;
        cursor: not-allowed;
        transform: none;
    }

    /* 总计区域 */
    .total-section {
        margin: 20px 30px 0;
        padding: 20px;
        background: linear-gradient(135deg, #f8f9fa 0%, #f5f7fa 100%);
        border-radius: 8px;
        border: 1px solid var(--border-color);
    }

    .total-row {
        display: flex;
        justify-content: flex-end;
        align-items: center;
        gap: 30px;
    }

    .total-item {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
    }

    .total-label {
        font-size: 0.9rem;
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 5px;
    }

    .total-value {
        font-size: 1.6rem;
        font-weight: 600;
        color: var(--primary-color);
    }

    .status-hold {
        background: rgba(117, 117, 117, 0.1);
        color: #757575;
        border: 1px solid rgba(117, 117, 117, 0.2);
    }

    .select-control option[value="hold"] {
        color: #757575;
        font-style: italic;
    }
    .modal-dialog {
        position: absolute;
        top: 50% !important;
        left: 50%;
        transform: translate(-50%, -50%) !important;
        margin: 0;
        max-height: 90vh;
        overflow-y: auto;
        width: 50%;         
        max-width: 500px;   
    }
    .single-row-form {
        display: none;
    }
    .green-modal-header {
        background: linear-gradient(135deg, var(--primary-light), var(--primary-color));
        color: white !important;
        padding: 14px 20px;
        border-bottom: none;
    }
    .btn-green {
        background-color: var(--primary-light);
        border: none;
        color: white;
    }
    .btn-green:hover {
        background-color: var(--primary-color);
        color: #fff;
    }

    .btn-green-outline {
        border: 1px solid var(--primary-light);
        color: var(--primary-light);
        background: white;
    }
    .btn-green-outline:hover {
        background: var(--primary-light);
        color: white;
    }

    /* 下拉框样式 */
    .green-select {
        padding: 12px;
        border-radius: 6px;
        border: 1px solid var(--border-color);
        font-size: 1rem;
        width: 100%;
    }

    /* tooltip（与你第二段完全一致） */
    .filter-info-tooltip {
        position: relative;
        display: inline-block;
    }
    .filter-info-tooltip:hover::after {
        opacity: 1;
        visibility: visible;
    }
    .filter-info-tooltip::before {
        content: "";
        position: absolute;
        top: 50%;
        left: 100%;
        transform: translateY(-50%);
        border-width: 6px;
        border-style: solid;
        border-color: transparent rgba(60, 60, 60, 0.95) transparent transparent;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.2s ease;
    }
    .filter-info-tooltip:hover::before {
        opacity: 1;
        visibility: visible;
    }
    .filter-info-tooltip::after {
        content: attr(data-tooltip);
        white-space: pre-line;
        position: absolute;
        top: calc(50% + 6px);
        left: 120%;
        transform: translateY(-35%);
        background-color: rgba(60, 60, 60, 0.95);
        color: #fff;
        padding: 6px 10px;
        border-radius: 6px;
        font-size: 12px;
        line-height: 1.4;
        width: max-content;
        max-width: 260px;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.2s ease;
        z-index: 1000;
        pointer-events: none;
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }
    /* 响应式调整 */
    @media (max-width: 1400px) {
        .table-container {
            overflow-x: auto;
            padding: 0 20px 20px;
        }
        
        .advanced-table {
            min-width: 1300px;
        }
        
        .info-bar {
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }
        
        .info-item:nth-child(3)::after {
            display: none;
        }
    }
</style>

<div class="finance-container">
    <!-- 头部 -->
    <header class="system-header">
        <div class="header-main">
            <div class="header-title">
                <div>
                    <h1>私仓派送账单录入</h1>
                    <div class="header-subtitle">柜号：{{ container_number }}</div>
                </div>
            </div>
            <div class="header-status">
                <!-- 柜型到客户信息 -->
                <div class="info-group">
                    <span class="info-badge">
                        <i class="fas fa-box"></i>
                        <strong>柜型:</strong> {{ container_type }}
                    </span>
                    <span class="info-badge">
                        <i class="fas fa-warehouse"></i>
                        <strong>仓库:</strong> {{ warehouse }}
                    </span>
                    <span class="info-badge">
                        <i class="fas fa-user-tie"></i>
                        <strong>客户:</strong> {{ customer_name }}
                    </span>
                </div>
            </div>
        </div>
    </header>

    <!-- 主要内容 -->
    <main class="main-content">   
        <form method="post" id="delivery-billing-form">
            {% csrf_token %}
            <input type="hidden" name="container_number" value="{{ container_number }}">
            <input type="hidden" name="invoice_id" value="{{ invoice_id }}">        
            <!-- 工具栏 -->
            <div class="toolbar">
                <div class="toolbar-left">
                    <div class="toolbar-title">
                        <i class="fas fa-list-ul"></i>
                        费用录入明细
                        <span class="count">{{ billing_items|length }} 项</span>
                    </div>
                </div>
                <div class="toolbar-actions">
                    <button type="button" class="btn" onclick="window.history.back()">
                        <i class="fas fa-arrow-left"></i>
                        返回
                    </button>
                </div>
            </div>

            <!-- 高级表格 -->
            <div class="table-container">
                <table class="advanced-table">
                    <thead>
                        <tr>
                            <th>唛头</th>
                            <th>目的地</th>
                            <th>CBM</th>
                            <th>重量(lbs)</th>
                            <th>派送类型</th>
                            <th>板数</th>
                            <th>单价(USD)</th>
                            <th>附加费(USD)</th>
                            <th>金额(USD)</th>
                            <th>备注</th>
                            <th>PO号</th>
                            <th>状态</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in billing_items %}                  
                        <tr data-row="{{ forloop.counter0 }}" data-item-id="{{ item.id|default:'' }}" data-po="{{ item.PO_ID|default:'' }}" data-is-hold="{% if item.delivery_category == 'hold' %}true{% else %}false{% endif %}">                      
                            <!-- 唛头 -->
                            <td class="cell-mark">
                                <div class="mark-text" title="{{ item.shipping_marks|default:'' }}">
                                    {{ item.shipping_marks|default:"-" }}
                                </div>
                            </td>
                            
                            <!-- 目的地 -->
                            <td class="cell-destination">
                                {{ item.destination|default:"-" }}
                            </td>
                            
                            <!-- CBM -->
                            <td class="cell-stats">
                                <div class="stat-value">{{ item.total_cbm|floatformat:2|default:"0.00" }}</div>
                            </td>
                            
                            <!-- 重量 -->
                            <td class="cell-stats">
                                <div class="stat-value">{{ item.total_weight_lbs|floatformat:2|default:"0.00" }}</div>
                            </td>
                            
                            <!-- 派送类型 -->
                            <td>
                                <div class="select-wrapper">
                                    <select name="delivery_category_{{ forloop.counter0 }}" 
                                            class="select-control delivery-type-select"
                                            data-row="{{ forloop.counter0 }}"
                                            form="row-form-{{ forloop.counter0 }}"
                                            {% if item.delivery_category == "hold" %}disabled{% else %}required{% endif %}>
                                        <option value="">请选择</option>
                                        <option value="selfpickup" {% if item.delivery_category == "selfpickup" %}selected{% endif %}>客户自提</option>
                                        <option value="selfdelivery" {% if item.delivery_category == "selfdelivery" %}selected{% endif %}>自发派送</option>
                                        <option value="hold" {% if item.delivery_category == "hold" %}selected{% endif %}>暂扣留仓</option>
                                    </select>
                                </div>
                            </td>
                            
                            <!-- 板数 -->
                            <td>
                                <input type="number" 
                                    name="pallets_{{ forloop.counter0 }}" 
                                    class="input-control input-pallets"
                                    value="{{ item.total_pallets|default:0 }}"
                                    min="0"
                                    step="0.5"
                                    data-row="{{ forloop.counter0 }}"
                                    form="row-form-{{ forloop.counter0 }}"
                                    placeholder="0"
                                    {% if item.delivery_category == "hold" %}disabled{% endif %}>
                            </td>
                            
                            <!-- 单价 -->
                            <td>
                                <input type="number" 
                                    name="rate_{{ forloop.counter0 }}" 
                                    class="input-control input-rate"
                                    value="{{ item.rate|default:'' }}"
                                    step="0.01" 
                                    min="0"
                                    data-row="{{ forloop.counter0 }}"
                                    form="row-form-{{ forloop.counter0 }}"
                                    placeholder="0.00"
                                    {% if item.delivery_category == "hold" %}disabled{% endif %}>
                            </td>
                            
                            <!-- 附加费 -->
                            <td>
                                <input type="number" 
                                    name="surcharges_{{ forloop.counter0 }}"
                                    class="input-control input-surcharge"
                                    value="{{ item.surcharges|default:0 }}"
                                    step="0.01" 
                                    min="0"
                                    data-row="{{ forloop.counter0 }}"
                                    form="row-form-{{ forloop.counter0 }}"
                                    placeholder="0.00"
                                    {% if item.delivery_category == "hold" %}disabled{% endif %}>
                            </td>
                            
                            <!-- 金额 -->
                            <td>
                                <input type="number" 
                                    name="amount_{{ forloop.counter0 }}" 
                                    class="input-control input-amount amount-input"
                                    value="{{ item.amount|default:'' }}"
                                    step="0.01" 
                                    min="0"
                                    data-row="{{ forloop.counter0 }}"
                                    form="row-form-{{ forloop.counter0 }}"
                                    placeholder="0.00"
                                    readonly>
                            </td>
                            
                            <!-- 备注 -->
                            <td>
                                <input type="text" 
                                    name="note_{{ forloop.counter0 }}" 
                                    class="input-control input-note"
                                    value="{{ item.note|default:'' }}"
                                    form="row-form-{{ forloop.counter0 }}"
                                    placeholder="备注"
                                    {% if item.delivery_category == "hold" %}disabled{% endif %}>
                            </td>
                            
                            <!-- PO号 -->
                            <td class="cell-po">
                                {{ item.PO_ID|default:"-" }}
                            </td>
                            
                            <!-- 状态 -->
                            <td class="cell-status">
                                {% if item.delivery_category == "hold" %}
                                <span class="status-indicator status-hold">                                   
                                    暂扣
                                </span>
                                {% elif not item.is_existing %}
                                <span class="status-indicator">                                   
                                    未录
                                </span>
                                {% else %}
                                <span class="status-indicator existing">                                   
                                    已录
                                </span>
                                {% endif %}
                            </td>
                            
                            <!-- 操作列（新增） -->
                            <td class="cell-action">
                                {% if item.delivery_category == "hold" %}
                                <!-- 解扣按钮 -->
                                <button type="button" class="action-btn btn-release"
                                        onclick="releaseHoldItem('{{ container_number }}', '{{ item.PO_ID|default:'' }}', '{{ item.pallet_ids|join:','|default:'' }}', '{{ forloop.counter0 }}')">
                                    <i class="fas fa-unlock"></i>
                                    解扣
                                </button>
                                {% else %}
                                <!-- 保存按钮 -->
                                <button type="button" class="action-btn btn-save-row"
                                        onclick="saveSingleRow({{ forloop.counter0 }}, '{{ item.id|default:'' }}')"
                                        {% if not item.delivery_category %}disabled{% endif %}>
                                    <i class="fas fa-save"></i>
                                    保存
                                </button>
                                {% endif %}
                            </td>
                        </tr>
                        <form method="post" id="delivery-billing-form">
                            {% csrf_token %}
                            <input type="hidden" name="step" value="save_all_items" id="step-input">
                            <input type="hidden" name="container_number" value="{{ container_number }}">
                            <input type="hidden" name="delivery_type" value="other">
                            <input type="hidden" name="invoice_id" value="{{ invoice_id }}">
                            
                            <!-- 在表格后面添加隐藏字段用于存储所有行数据 -->
                            <input type="hidden" name="items_data" id="items-data">
                        </form>
                        {% empty %}
                        <tr>
                            <td colspan="13" style="text-align: center; padding: 60px 20px; color: var(--text-secondary);">
                                <i class="fas fa-clipboard-list" style="font-size: 3rem; margin-bottom: 20px; color: #e0e0e0;"></i>
                                <p>暂无账单数据</p>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <!-- 总计区域 -->
            <div class="total-section">
                <div class="total-row">
                    <div class="total-item">
                        <div class="total-label">总金额 (USD)</div>
                        <div class="total-value" id="total-amount">0.00</div>
                    </div>
                </div>
            </div>
            <!-- 表单操作按钮 -->
            <div class="form-actions">
                <div class="form-buttons">
                    <button type="submit" name="step" value="save_all" class="btn btn-success">
                        <i class="fas fa-save"></i>
                        保存账单
                    </button>
                    {% if can_finish %}
                    <button type="submit" name="step" value="finish" class="btn btn-primary">
                        <i class="fas fa-check-double"></i>
                        完成账单
                    </button>
                    {% endif %}
                </div>
            </div>
        </form>
    </main>
</div>
<!-- 解扣模态框 -->
<div class="modal fade" id="releaseModal" tabindex="-1" aria-labelledby="releaseModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">

            <div class="modal-header green-modal-header">
                <h5 class="modal-title" id="releaseModalLabel">
                    <i class="fas fa-unlock me-2"></i> 解除暂扣
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>

            <form id="release-form" method="post">
                {% csrf_token %}
                <input type="hidden" name="step" value="release_hold">
                <input type="hidden" id="release-container-number" name="container_number" value="{{ container_number }}">
                <input type="hidden" id="release-po-id" name="po_id" value="">
                <input type="hidden" name="invoice_id" value="{{ invoice_id }}">
                <input type="hidden" name="delivery_type" value="other">
                <input type="hidden" id="release-pallet-ids" name="pallet_ids" value="">
                
                <div class="modal-body">

                    <!-- 派送方式 -->
                    <div class="mb-4">
                        <h6 class="mb-3">
                            选择派送方式：
                            <span class="filter-info-tooltip"
                                data-tooltip="解扣后需要指定派送方式\n此项为必填">
                                <i class="fas fa-question-circle" style="color:#e0e0e0; font-size:0.8em; cursor:help;"></i>
                            </span>
                        </h6>

                        <select name="delivery_method" class="green-select" required>
                            <option value="">请选择派送方式...</option>
                            {% for value, label in delivery_method_options %}
                                {% if value %}
                                    <option value="{{ value }}">{{ label }}</option>
                                {% endif %}
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <!-- 按钮区 -->
                <div class="modal-footer">
                    <button type="button" class="btn btn-green-outline" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i> 取消
                    </button>
                    <button type="submit" class="btn btn-green">
                        <i class="fas fa-unlock"></i> 确认解扣
                    </button>
                </div>

            </form>
        </div>
    </div>
</div>
<form method="post" id="single-row-form" style="display: none;">
    {% csrf_token %}
    <input type="hidden" name="step" value="save_single">
    <input type="hidden" name="container_number" value="{{ container_number }}">
    <input type="hidden" name="invoice_id" value="{{ invoice_id }}">
    <input type="hidden" name="row_index" id="single-row-index" value="">
    <input type="hidden" name="item_id" id="single-item-id" value="">
    <input type="hidden" name="po_id" id="single-po-id" value="">
    <input type="hidden" name="shipping_marks" id="single-shipping-marks" value="">
    <input type="hidden" name="destination" id="single-destination" value="">
    <input type="hidden" name="delivery_category" id="single-delivery-category" value="">
    <input type="hidden" name="delivery_type" value="other">
    <input type="hidden" name="rate" id="single-rate" value="">
    <input type="hidden" name="pallets" id="single-pallets" value="">
    <input type="hidden" name="surcharges" id="single-surcharges" value="">
    <input type="hidden" name="amount" id="single-amount" value="">
    <input type="hidden" name="note" id="single-note" value="">
</form>
{% include 'receivable_accounting/modals/message_modal.html' %}
<!-- Toast容器 -->
<div id="toast-container" class="toast-container"></div>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>


<script>
$(document).ready(function() {
    // 计算总金额
    function calculateTotalAmount() {
        let total = 0;
        $('.amount-input').each(function() {
            const amount = parseFloat($(this).val()) || 0;
            total += amount;
        });
        $('#total-amount').text(total.toFixed(2));
        return total;
    }

    // 设置输入状态（保持你原来的逻辑）
    function setupRowInputs(rowIndex, deliveryType, isHold = false) {
        const $row = $(`tr[data-row="${rowIndex}"]`);
        const $rateInput = $row.find('.input-rate');
        const $amountInput = $row.find('.amount-input');
        const $palletsInput = $row.find('.input-pallets');
        const $surchargeInput = $row.find('.input-surcharge');
        const $noteInput = $row.find('.input-note');
        const $select = $row.find('.delivery-type-select');
        const $saveBtn = $row.find('.btn-save-row');

        if (isHold) {
            $rateInput.prop('disabled', true).val('');
            $amountInput.prop('disabled', true).val('0');
            $palletsInput.prop('disabled', true);
            $surchargeInput.prop('disabled', true).val('0');
            $noteInput.prop('disabled', true);
            $select.prop('disabled', true);
            if ($saveBtn.length) $saveBtn.prop('disabled', true);
        } else if (deliveryType === 'selfdelivery') {
            $rateInput.prop('disabled', true).val('');
            $amountInput.prop('readonly', false).prop('disabled', false);
            $palletsInput.prop('disabled', false);
            $surchargeInput.prop('disabled', false);
            $noteInput.prop('disabled', false);
            $select.prop('disabled', false);
            if ($saveBtn.length) $saveBtn.prop('disabled', false);
        } else if (deliveryType === 'selfpickup') {
            $rateInput.prop('disabled', false);
            $amountInput.prop('readonly', true).prop('disabled', false);
            $palletsInput.prop('disabled', false);
            $surchargeInput.prop('disabled', false);
            $noteInput.prop('disabled', false);
            $select.prop('disabled', false);
            if ($saveBtn.length) $saveBtn.prop('disabled', false);
        } else if (deliveryType === 'hold') {
            $rateInput.prop('disabled', true).val('');
            $amountInput.prop('disabled', true).val('0');
            $palletsInput.prop('disabled', true);
            $surchargeInput.prop('disabled', true).val('0');
            $noteInput.prop('disabled', false);
            $select.prop('disabled', false);
            if ($saveBtn.length) $saveBtn.prop('disabled', false);
        } else {
            if ($saveBtn.length) $saveBtn.prop('disabled', true);
        }
    }

    // 计算单行金额（**保证金额一定包含附加费**）
    function calculateRowAmount(rowIndex) {
        const $row = $(`tr[data-row="${rowIndex}"]`);
        const deliveryType = $row.find('.delivery-type-select').val();
        const isHold = $row.data('is-hold') === 'true' || deliveryType === 'hold';

        const $rateInput = $row.find('.input-rate');
        const $palletsInput = $row.find('.input-pallets');
        const $surchargeInput = $row.find('.input-surcharge');
        const $amountInput = $row.find('.amount-input');

        if (isHold) {
            $amountInput.val('0.00');
            return 0;
        }

        const rate = parseFloat($rateInput.val()) || 0;
        const pallets = parseFloat($palletsInput.val()) || 0;
        const surcharges = parseFloat($surchargeInput.val()) || 0;

        let amount = 0;
        if (deliveryType === 'selfpickup') {
            amount = (rate * pallets) + surcharges;
        } else if (deliveryType === 'selfdelivery') {
            // 自发派送允许用户输入金额主体，但我们要确保附加费也累加进去
            const userAmount = parseFloat($amountInput.val()) || 0;
            amount = userAmount + surcharges;
        } else {
            // 未选择类型时不自动计算（保持为0）
            amount = surcharges; // 保证至少包含附加费
        }

        $amountInput.val(amount.toFixed(2));
        return amount;
    }

    // 事件：派送类型变动
    $(document).on('change', '.delivery-type-select', function() {
        const rowIndex = $(this).data('row');
        const deliveryType = $(this).val();
        const $row = $(`tr[data-row="${rowIndex}"]`);
        const isHold = $row.data('is-hold') === 'true';
        setupRowInputs(rowIndex, deliveryType, isHold);

        // 变动后重新计算（确保附加费纳入）
        calculateRowAmount(rowIndex);
        calculateTotalAmount();
    });

    // 事件：任意相关输入变化 -> 重新计算金额（注意使用统一的 class .input-surcharge）
    $(document).on('input', '.input-rate, .input-pallets, .input-surcharge, .amount-input', function() {
        const rowIndex = $(this).closest('tr').data('row');
        if (typeof rowIndex === 'undefined') return;
        // 只要与金额相关的输入变动，都触发重新计算
        calculateRowAmount(rowIndex);
        calculateTotalAmount();
    });

    // 初始化每行状态并计算金额
    $('tbody tr[data-row]').each(function() {
        const rowIndex = $(this).data('row');
        const isHold = $(this).data('is-hold') === 'true';
        const deliveryType = $(this).find('.delivery-type-select').val();

        if (isHold) {
            setupRowInputs(rowIndex, 'hold', true);
        } else if (deliveryType) {
            setupRowInputs(rowIndex, deliveryType, false);
        }
        // 计算金额（确保包含附加费）
        calculateRowAmount(rowIndex);
    });

    // 初始总额
    calculateTotalAmount();

    // ---------- 单行保存：把当前行数据写到隐藏 single-row-form 并提交 ----------
    window.saveSingleRow = function(rowIndex, itemId) {
        const $row = $(`tr[data-row="${rowIndex}"]`);
        const deliveryCategory = $row.find('.delivery-type-select').val();
        const rate = $row.find('.input-rate').val();
        const pallets = $row.find('.input-pallets').val();
        const surcharges = $row.find('.input-surcharge').val();
        const amount = $row.find('.amount-input').val();
        const note = $row.find('.input-note').val();
        const poId = $row.data('po') || '';
        const shippingMarks = $row.find('.mark-text').attr('title') || '';
        const destination = $row.find('.cell-destination').text().trim();

        // 验证
        if (!deliveryCategory) {
            showToast('请选择派送类型', 'error');
            return;
        }
        if (deliveryCategory === 'selfpickup' && (!rate || parseFloat(rate) <= 0)) {
            showToast('请输入有效的单价', 'error');
            return;
        }
        if (!amount || parseFloat(amount) < 0) {
            showToast('请输入有效的金额', 'error');
            return;
        }

        // 填充隐藏表单（single-row-form）
        $('#single-row-index').val(rowIndex);
        $('#single-item-id').val(itemId || $row.data('item-id') || '');
        $('#single-po-id').val(poId);
        $('#single-shipping-marks').val(shippingMarks);
        $('#single-destination').val(destination);
        $('#single-delivery-category').val(deliveryCategory);
        $('#single-rate').val(rate || '');
        $('#single-pallets').val(pallets || '0');
        $('#single-surcharges').val(surcharges || '0');   // ← 确保把附加费写入
        $('#single-amount').val(amount || '0');          // ← 确保把金额写入
        $('#single-note').val(note || '');

        // 状态变更
        const $btn = $row.find('.btn-save-row');
        $btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> 保存中...');

        // 提交隐藏表单
        setTimeout(() => {
            $('#single-row-form').submit();
        }, 60);
    };

    // ---------- 整表提交：在 submit 前把每行收集成 JSON 塞进 #items-data ----------
    $('#delivery-billing-form').on('submit', function(e) {
        // only intercept for save_all step (如果你还有 finish 等不同 step，可根据需要判断)
        const stepVal = $(this).find('input[name="step"]').val();
        if (stepVal !== 'save_all' && stepVal !== 'save_all_items' && stepVal !== 'save_all') {
            // allow other steps (like finish) to submit normally
            return true;
        }

        // 构造 items 数组
        const items = [];
        $('tbody tr[data-row]').each(function() {
            const rowIndex = $(this).data('row');
            const itemId = $(this).data('item-id') || '';
            const poId = $(this).data('po') || '';
            const shippingMarks = $(this).find('.mark-text').attr('title') || '';
            const destination = $(this).find('.cell-destination').text().trim();
            const deliveryCategory = $(this).find('.delivery-type-select').val() || '';
            const rate = $(this).find('.input-rate').val() || '';
            const pallets = $(this).find('.input-pallets').val() || '0';
            const surcharges = $(this).find('.input-surcharge').val() || '0';
            const amount = $(this).find('.amount-input').val() || '0';
            const note = $(this).find('.input-note').val() || '';

            items.push({
                rowIndex: rowIndex,
                item_id: itemId,
                po_id: poId,
                shipping_marks: shippingMarks,
                destination: destination,
                delivery_category: deliveryCategory,
                rate: rate,
                pallets: pallets,
                surcharges: surcharges,
                amount: amount,
                note: note
            });
        });

        // put into hidden input
        $('#items-data').val(JSON.stringify(items));

        // allow actual submission to proceed
        return true;
    });

    // 辅助：toast（复用你原来 showToast，如果没有则用 alert）
    function showToast(msg, type='success') {
        // 你原始页面有 showToast 实现，这里调用已有函数；如果不存在可回退到 alert
        if (typeof window.showToast === 'function') {
            window.showToast(msg, type);
        } else {
            alert(msg);
        }
    }
});
function releaseHoldItem(containerNumber, poId, palletIds, rowIndex) {
    // 填充模态框数据
    $('#release-container-number').val(containerNumber);
    $('#release-po-id').val(poId);
    $('#release-pallet-ids').val(palletIds);
    
    // 显示模态框
    const modal = new bootstrap.Modal(document.getElementById('releaseModal'));
    modal.show();
}
</script>
{% endblock %} 