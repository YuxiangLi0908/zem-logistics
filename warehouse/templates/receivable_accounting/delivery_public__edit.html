{% extends 'base.html' %}
{% load static %}
{% load custom_filters %}

{% block title %}å…¬ä»“æ´¾é€è´¦å•å½•å…¥ - {{ container_number }}{% endblock %}

{% block content %}
<style>
    :root {
        --primary-color: #1b5e20;
        --primary-light: #4caf50;
        --primary-dark: #0d3d14;
        --secondary-color: #2e7d32;
        --accent-color: #ff9800;
        --text-primary: #212121;
        --text-secondary: #666;
        --border-color: #e0e0e0;
        --table-header-bg: #f5f7fa;
        --row-hover-bg: #fafdf8;
        --disabled-bg: #f8f9fa;
        --success-color: #2e7d32;
        --warning-color: #ff9800;
        --error-color: #d32f2f;
    }

    .finance-container {
        max-width: 100%;
        margin: 0 auto;
        padding: 0;
        background: white;
        min-height: 100vh;
    }

    /* å¤´éƒ¨æ ·å¼ */
    .system-header {
        background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary-color) 100%);
        color: white;
        padding: 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .header-main {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 24px 30px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .header-title {
        display: flex;
        align-items: center;
        gap: 16px;
    }

    .header-title h1 {
        margin: 0;
        font-weight: 500;
        font-size: 1.8rem;
        letter-spacing: -0.3px;
    }

    .header-subtitle {
        font-size: 1rem;
        opacity: 0.8;
        margin-top: 4px;
    }

    .header-status {
        display: flex;
        flex-direction: column;
        gap: 12px;
        background: rgba(255, 255, 255, 0.1);
        padding: 16px 20px;
        border-radius: 8px;
        backdrop-filter: blur(8px);
        border: 1px solid rgba(255, 255, 255, 0.15);
    }
    .top-actions-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px 30px;
        background: white;
        border-bottom: 1px solid var(--border-color);
        margin-top: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }

    .cbm-display {
        display: flex;
        align-items: center;
        gap: 15px;
        font-size: 1.1rem;
    }

    .cbm-item {
        display: flex;
        flex-direction: column;
        align-items: flex-start;
    }

    .cbm-label {
        font-size: 0.85rem;
        color: var(--text-secondary);
        margin-bottom: 4px;
    }

    .cbm-value {
        font-weight: 600;
        color: var(--primary-color);
        font-size: 1.2rem;
    }

    .total-display {
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .total-item {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
    }

    .total-label {
        font-size: 0.85rem;
        color: var(--text-secondary);
        margin-bottom: 4px;
    }

    .total-value {
        font-size: 1.4rem;
        font-weight: 600;
        color: var(--primary-color);
    }

    .save-button-container {
        display: flex;
        gap: 10px;
    }

    .combina-action-bar,
    .activation-action-bar {
        display: none !important;
    }

    .info-group {
        display: flex;
        gap: 20px;
        align-items: center;
    }

    .info-badge {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 0.95rem;
        background: rgba(255, 255, 255, 0.08);
        padding: 6px 12px;
        border-radius: 6px;
        border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .info-badge i {
        font-size: 0.9rem;
        opacity: 0.8;
    }

    .info-badge strong {
        color: #c8e6c9;
        margin-right: 4px;
        font-weight: 500;
    }

    /* ä¿¡æ¯æ  */
    .info-bar {
        padding: 20px 30px;
        display: grid;
        grid-template-columns: 3fr 2fr;
        gap: 20px;
        background: rgba(0, 0, 0, 0.02);
        border-bottom: 1px solid rgba(0, 0, 0, 0.05);
    }

    .info-item {
        position: relative;
    }

    .info-label {
        font-size: 0.8rem;
        color: #666;
        margin-bottom: 6px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-weight: 500;
    }

    .info-value {
        font-size: 1rem;
        color: var(--text-primary);
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .info-value .icon {
        color: var(--primary-color);
        font-size: 0.9rem;
        opacity: 0.7;
    }

    .info-item:not(:last-child)::after {
        content: '';
        position: absolute;
        right: -10px;
        top: 50%;
        transform: translateY(-50%);
        height: 40px;
        width: 1px;
        background: rgba(0, 0, 0, 0.1);
    }

    /* ä¸»è¦å†…å®¹åŒºåŸŸ */
    .main-content {
        padding: 0;
    }

    /* æ“ä½œå·¥å…·æ  */
    .toolbar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 18px 30px;
        border-bottom: 1px solid var(--border-color);
        background: white;
    }

    .toolbar-title {
        font-size: 1.1rem;
        font-weight: 500;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .toolbar-title .count {
        background: var(--primary-light);
        color: white;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.9rem;
        font-weight: 500;
    }

    .toolbar-actions {
        display: flex;
        gap: 10px;
    }

    /* æŒ‰é’®æ ·å¼ */
    .btn {
        padding: 9px 20px;
        border-radius: 6px;
        font-weight: 500;
        font-size: 0.9rem;
        border: 1px solid var(--border-color);
        cursor: pointer;
        transition: all 0.2s ease;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        background: white;
        color: var(--text-primary);
    }

    .btn:hover {
        background: #f5f5f5;
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .btn-primary {
        background: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
    }

    .btn-primary:hover {
        background: var(--primary-dark);
    }

    .btn-success {
        background: var(--success-color);
        color: white;
        border-color: var(--success-color);
    }

    .btn-success:hover {
        background: #1b5e20;
    }

    /* é«˜çº§è¡¨æ ¼æ ·å¼ */
    .table-container {
        padding: 0;
    }

    .advanced-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.9rem;
        background: white;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        overflow: hidden;
    }

    .advanced-table thead {
        background: var(--table-header-bg);
    }

    .advanced-table th {
        padding: 16px 14px;
        text-align: left;
        font-weight: 600;
        color: var(--text-primary);
        border-bottom: 1px solid var(--border-color);
        text-transform: uppercase;
        letter-spacing: 0.3px;
        font-size: 0.85rem;
        white-space: nowrap;
    }

    .advanced-table tbody tr {
        border-bottom: 1px solid var(--border-color);
        transition: background-color 0.2s ease;
        position: relative;
    }

    .advanced-table tbody tr:last-child {
        border-bottom: none;
    }

    .advanced-table tbody tr:hover {
        background-color: var(--row-hover-bg);
    }

    .row-new {
        background-color: #fffaf0;
    }

    .row-new:hover {
        background-color: #fff8e6 !important;
    }

    .row-existing {
        background-color: white;
    }

    .advanced-table td {
        padding: 18px 14px;
        vertical-align: middle;
        color: var(--text-primary);
        border-right: 1px solid #f0f0f0;
    }

    .advanced-table td:last-child {
        border-right: none;
    }

    /* å•å…ƒæ ¼ç‰¹å®šæ ·å¼ */
    .cell-mark {
        max-width: 220px;
        min-width: 200px;
    }

    .mark-text {
        font-weight: 500;
        line-height: 1.4;
        font-size: 0.95rem;
        overflow: hidden;
        text-overflow: ellipsis;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
    }

    .cell-destination {
        min-width: 140px;
        font-weight: 500;
    }

    .stat-value {
        font-weight: 500;
        color: var(--text-primary);
    }

    /* é€‰æ‹©å™¨æ ·å¼ */
    .select-wrapper {
        position: relative;
        min-width: 140px;
    }

    .select-control {
        width: 100%;
        padding: 9px 32px 9px 12px;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        background: white;
        color: var(--text-primary);
        font-size: 0.9rem;
        appearance: none;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .select-control:focus {
        outline: none;
        border-color: var(--primary-light);
        box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.1);
    }

    .select-wrapper::after {
        content: 'â–¼';
        position: absolute;
        right: 12px;
        top: 50%;
        transform: translateY(-50%);
        font-size: 0.7rem;
        color: var(--text-secondary);
        pointer-events: none;
    }

    /* è¾“å…¥æ¡†æ ·å¼ */
    .input-control {
        width: 100%;
        padding: 9px 10px;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        background: white;
        color: var(--text-primary);
        font-size: 0.9rem;
        transition: all 0.2s ease;
    }

    .input-control:focus {
        outline: none;
        border-color: var(--primary-light);
        box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.1);
        background: white;
    }

    .input-control:disabled {
        background-color: #fafafa;
        border-color: #eee;
        color: #999;
        cursor: not-allowed;
    }

    .input-pallets {
        width: 70px;
        text-align: center;
        background: #f8f9fa;
        border-color: #e8f5e9;
        color: var(--primary-color);
        font-weight: 500;
    }

    .input-rate {
        width: 90px;
        text-align: right;
    }

    .input-rate:disabled {
        background: #f5f5f5;
        color: #999;
    }

    .input-surcharge {
        width: 85px;
        text-align: right;
    }

    .input-amount {
        width: 100px;
        text-align: right;
        font-weight: 600;
        color: var(--primary-color);
        border-color: #c8e6c9;
        background: #f8f9fa;
    }

    .input-note {
        width: 120px;
    }


    /* çŠ¶æ€æŒ‡ç¤ºå™¨ */
    .cell-status {
        text-align: center;
    }

    .status-indicator {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 5px 10px;
        border-radius: 4px;
        font-size: 0.8rem;
        font-weight: 500;
        background: rgba(255, 152, 0, 0.1);
        color: var(--warning-color);
    }

    .status-indicator.existing {
        background: rgba(46, 125, 50, 0.1);
        color: var(--success-color);
    }

    .status-indicator .icon {
        font-size: 0.8rem;
    }

    /* è¡¨å•æäº¤åŒºåŸŸ */
    .form-actions {
        display: flex;
        justify-content: flex-end;
        padding: 25px 30px;
        border-top: 1px solid var(--border-color);
        background: white;
    }

    .form-buttons {
        display: flex;
        gap: 12px;
    }

    /* Toastæ ·å¼ */
    .toast-container {
        position: fixed;
        top: 30px;
        right: 30px;
        z-index: 9999;
    }

    .toast {
        border-radius: 6px;
        border: none;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
        backdrop-filter: blur(10px);
    }

    .toast-success {
        background: rgba(46, 125, 50, 0.95) !important;
        border: 1px solid rgba(76, 175, 80, 0.2);
    }

    .toast-error {
        background: rgba(211, 47, 47, 0.95) !important;
        border: 1px solid rgba(244, 67, 54, 0.2);
    }
    .header-info {
        display: flex;
        gap: 30px;
        align-items: center;
    }

    .info-badge {
        background: rgba(255, 255, 255, 0.15);
        padding: 8px 16px;
        border-radius: 8px;
        font-size: 0.9rem;
    }

    .info-badge strong {
        color: #a5d6a7;
        margin-right: 8px;
    }
    .row-hold {
        background-color: #f5f5f5 !important;
    }

    .row-hold:hover {
        background-color: #eeeeee !important;
    }

    .row-hold td {
        color: #999;
    }

    .row-hold .input-control {
        background-color: #fafafa;
        border-color: #e0e0e0;
        color: #999;
    }

    .row-hold .select-control {
        background-color: #fafafa;
        border-color: #e0e0e0;
        color: #666;
    }

    /* æ“ä½œåˆ—æ ·å¼ */
    .cell-action {
        text-align: center;
        min-width: 120px;
    }

    .action-btn {
        padding: 6px 12px;
        border-radius: 4px;
        font-size: 0.85rem;
        font-weight: 500;
        cursor: pointer;
        border: none;
        transition: all 0.2s ease;
        display: inline-flex;
        align-items: center;
        gap: 6px;
    }

    .btn-save-row {
        background: var(--primary-color);
        color: white;
    }

    .btn-save-row:hover {
        background: var(--primary-dark);
        transform: translateY(-1px);
    }

    .btn-release {
        background: var(--warning-color);
        color: white;
    }

    .btn-release:hover {
        background: #f57c00;
        transform: translateY(-1px);
    }

    .btn-save-row:disabled,
    .btn-release:disabled {
        background: #ccc;
        color: #666;
        cursor: not-allowed;
        transform: none;
    }

    /* æ€»è®¡åŒºåŸŸ */
    .total-section {
        margin: 0;
        padding: 20px;
        background: linear-gradient(135deg, #f8f9fa 0%, #f5f7fa 100%);
        border-radius: 8px;
        border: 1px solid var(--border-color);
    }

    .total-row {
        display: flex;
        justify-content: flex-end;
        align-items: center;
        gap: 30px;
    }

    .total-item {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
    }

    .total-label {
        font-size: 0.9rem;
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 5px;
    }

    .total-value {
        font-size: 1.6rem;
        font-weight: 600;
        color: var(--primary-color);
    }

    .status-hold {
        background: rgba(117, 117, 117, 0.1);
        color: #757575;
        border: 1px solid rgba(117, 117, 117, 0.2);
    }

    .select-control option[value="hold"] {
        color: #757575;
        font-style: italic;
    }
    .modal-dialog {
        position: absolute;
        top: 50% !important;
        left: 50%;
        transform: translate(-50%, -50%) !important;
        margin: 0;
        max-height: 90vh;
        overflow-y: auto;
        width: 50%;         
        max-width: 500px;   
    }
    .single-row-form {
        display: none;
    }
    .green-modal-header {
        background: linear-gradient(135deg, var(--primary-light), var(--primary-color));
        color: white !important;
        padding: 14px 20px;
        border-bottom: none;
    }
    .btn-green {
        background-color: var(--primary-light);
        border: none;
        color: white;
    }
    .btn-green:hover {
        background-color: var(--primary-color);
        color: #fff;
    }

    .btn-green-outline {
        border: 1px solid var(--primary-light);
        color: var(--primary-light);
        background: white;
    }
    .btn-green-outline:hover {
        background: var(--primary-light);
        color: white;
    }

    /* ä¸‹æ‹‰æ¡†æ ·å¼ */
    .green-select {
        padding: 12px;
        border-radius: 6px;
        border: 1px solid var(--border-color);
        font-size: 1rem;
        width: 100%;
    }

    /* tooltipï¼ˆä¸ä½ ç¬¬äºŒæ®µå®Œå…¨ä¸€è‡´ï¼‰ */
    .filter-info-tooltip {
        position: relative;
        display: inline-block;
    }
    .filter-info-tooltip:hover::after {
        opacity: 1;
        visibility: visible;
    }
    .filter-info-tooltip::before {
        content: "";
        position: absolute;
        top: 50%;
        left: 100%;
        transform: translateY(-50%);
        border-width: 6px;
        border-style: solid;
        border-color: transparent rgba(60, 60, 60, 0.95) transparent transparent;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.2s ease;
    }
    .filter-info-tooltip:hover::before {
        opacity: 1;
        visibility: visible;
    }

    .filter-info-tooltip::after {
        content: attr(data-tooltip);
        white-space: pre-line;
        position: absolute;
        top: calc(50% + 6px);
        left: 120%;
        transform: translateY(-35%);
        background-color: rgba(60, 60, 60, 0.95);
        color: #fff;
        padding: 6px 10px;
        border-radius: 6px;
        font-size: 12px;
        line-height: 1.4;
        width: max-content;
        max-width: 260px;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.2s ease;
        z-index: 1000;
        pointer-events: none;
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }
    .combina-header {
        background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
        padding: 20px;
        border-radius: 8px 8px 0 0;
        border: 1px solid #bbdefb;
        border-bottom: none;
        margin-bottom: 0;
    }

    .combina-header h3 {
        margin: 0 0 15px 0;
        color: #1565c0;
        font-weight: 600;
    }

    .combina-summary {
        display: flex;
        gap: 30px;
        align-items: center;
    }

    .summary-item {
        display: flex;
        align-items: baseline;
        gap: 8px;
    }

    .summary-item .label {
        color: #546e7a;
        font-size: 0.9rem;
    }

    .summary-item .value {
        font-weight: 600;
        color: #1565c0;
        font-size: 1.1rem;
    }

    .combina-table {
        border-top: none;
        border-top-left-radius: 0;
        border-top-right-radius: 0;
    }

    .combina-table th {
        background: #e3f2fd;
    }

    .row-combina {
        background-color: #f8fdff !important;
    }

    .row-combina:hover {
        background-color: #e3f2fd !important;
    }

    .highlight-select {
        border: 2px solid #ff9800 !important;
        background-color: #fff8e1 !important;
        box-shadow: 0 0 0 0.2rem rgba(255, 152, 0, 0.25) !important;
    }

    .row-no-type {
        background-color: #fffaf0 !important;
    }

    .row-no-type:hover {
        background-color: #fff8e1 !important;
    }

    .select-wrapper.warning::after {
        color: #ff9800 !important;
    }
    /* ç»„åˆæŸœè§„åˆ™ */
    
    .rules-icon {
        cursor: pointer;
        color: #2563eb;   /* è“è‰² */
        font-weight: 600;
        text-decoration: underline; /* åƒé“¾æ¥ */
    }

    .rules-icon:hover {
        color: #1e40af;
    }
    .rules-modal {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.55);
        z-index: 9999;
        justify-content: center;
        align-items: center;
    }

    .rules-content {
        width: 650px;
        background: white;
        padding: 25px 30px;
        border-radius: 12px;
        max-height: 80vh;
        overflow: auto;
    }

    .modal-title {
        margin-bottom: 20px;
        font-size: 1.4rem;
        color: #0f3e1e;
        font-weight: 700;
    }

    .section-title {
        background: #f0fdf4;
        border-left: 4px solid #16a34a;
        padding: 10px 12px;
        margin-bottom: 10px;
        font-weight: 600;
        color: #14532d;
        border-radius: 6px;
    }

    .rules-text {
        background: #f7f7f7;
        padding: 14px;
        border-radius: 6px;
        white-space: pre-line;
        font-size: 0.95rem;
        line-height: 1.6;
    }

    .divider {
        width: 100%;
        height: 1px;
        background: #e5e7eb;
        margin: 25px 0;
    }

    .close-btn {
        margin-top: 15px;
        padding: 10px 20px;
        background: #14532d;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
    }
    
    /* ç»„åˆæŸœè§„åˆ™ç»“æŸ*/
    .cell-region {
        background: #e8f5e9 !important;
        font-weight: 600;
        color: #1b5e20;
        text-align: center;
        vertical-align: middle;
    }

    .region-name {
        font-size: 1rem;
        margin-bottom: 5px;
    }

    .region-cbm {
        font-size: 0.85rem;
        color: #4caf50;
        font-weight: 500;
    }

    .region-region-price {
        font-size: 1rem;
        margin-bottom: 5px;
    }

    /* å•ä»·å•å…ƒæ ¼æ ·å¼ */
    .cell-price {
        background: #fff8e1 !important;
        font-weight: 600;
        color: #ff9800;
        text-align: center;
        vertical-align: middle;
    }

    .price-value {
        font-size: 0.85rem;
        color: #4caf50;
        font-weight: 500;
    }

    /* éç»„åˆæŸœå¤´éƒ¨æ ·å¼ */
    .normal-header {
        background: linear-gradient(135deg, #f5f5f5 0%, #eeeeee 100%);
        padding: 20px;
        border-radius: 8px 8px 0 0;
        border: 1px solid #e0e0e0;
        border-bottom: none;
        margin-bottom: 0;
        margin-top: 30px;
    }

    .normal-header h3 {
        margin: 0;
        color: #424242;
        font-weight: 600;
    }

    .normal-count {
        color: #757575;
        font-size: 0.9rem;
        margin-top: 8px;
    }

    /* ç»„åˆæŸœè¡¨å•å­—æ®µå‰ç¼€ */
    input[name^="pallets_combina_"],
    input[name^="amount_combina_"],
    select[name^="delivery_category_combina_"] {
        background-color: #f5f9ff;
        border-color: #bbdefb;
    }

    input[name^="pallets_combina_"]:disabled,
    input[name^="amount_combina_"]:disabled {
        background-color: #f0f7ff;
        color: #1976d2;
        font-weight: 500;
    }

    .section-header {
        background: linear-gradient(135deg, #f8f9fa 0%, #f5f7fa 100%);
        padding: 20px 30px;
        border-radius: 8px 8px 0 0;
        border: 1px solid var(--border-color);
        border-bottom: none;
        margin-top: 30px;
    }
    
    .section-header h3 {
        margin: 0;
        color: #424242;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .section-count {
        color: #757575;
        font-size: 0.9rem;
        margin-top: 8px;
    }
    
    .combina-section .section-header {
        background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
        border-color: #bbdefb;
    }
    
    .combina-section .section-header h3 {
        color: #1565c0;
    }
    
    .activation-fee-section .section-header {
        background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
        border-color: #bbdefb;
    }

    .transfer-section .section-header {
        background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
        border-color: #c8e6c9;
    }
    
    .transfer-section .section-header h3 {
        color: #2e7d32;
    }
    
    .other-section .section-header {
        background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
        border-color: #ffe0b2;
    }
    
    .other-section .section-header h3 {
        color: #ef6c00;
    }
    
    /* è½¬æ¢ç±»å‹æŒ‰é’®æ ·å¼ */
    .btn-convert {
        background: #9c27b0;
        color: white;
        border: none;
        padding: 6px 12px;
        border-radius: 4px;
        font-size: 0.85rem;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        transition: all 0.2s ease;
    }
    
    .btn-convert:hover {
        background: #7b1fa2;
        transform: translateY(-1px);
    }
    .invoice-content {
        padding: 20px 0px;
    }

    .info-card {
        background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
        border: 1px solid #bae6fd;
        border-radius: var(--radius);
        padding: 15px 20px;
        border-radius: 12px; 
        box-shadow: var(--shadow-soft);
        height: fit-content;
        margin: 0;
        text-align: left;
    }
    .info-cards-container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 0;
        padding: 0;
        align-items: stretch; 
    }

    .quotation-card {
        background: linear-gradient(135deg, #f8fff8, #f0f9f0);
        border: 1px solid #d1fae5;
        border-radius: var(--radius);
        padding: 15px 20px;
        border-radius: 12px; 
        box-shadow: var(--shadow-soft);
        height: fit-content;
        margin: 0;
        text-align: left;
    }
    .quotation-title, .info-title {
        font-size: 1rem;
        font-weight: 700;
        color: var(--primary-color);
        margin-bottom: 6px;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .quotation-details, .info-details {
        font-size: 0.9rem;
        color: var(--text-dark);
        line-height: 1.4;
    }
    .quotation-details {
        margin-top: 18px;
    }

    .quotation-highlight {
        color: var(--primary-color);
        font-weight: 600;
    }
    .info-highlight {
        color: #0369a1;
        font-weight: 600;
    }
    .btn-change-order-type {
        margin-left: 10px;
        padding: 6px 16px;
        font-size: 0.9rem;
        font-weight: 600;
        border-radius: 6px;
        border: 1px solid transparent;
        cursor: pointer;
        transition: all 0.2s ease;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        background: linear-gradient(135deg, #1e40af, #3b82f6);
        color: white;
        box-shadow: 0 2px 8px rgba(59, 130, 246, 0.2);
    }

    .btn-change-order-type:hover {
        background: linear-gradient(135deg, #1d4ed8, #2563eb);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }

    .btn-change-order-type:active {
        transform: translateY(0);
    }
    
    input[name="actual_non_combina_reason"] {
        margin-left: 10px;
        padding: 8px 12px;
        font-size: 0.9rem;
        border-radius: 6px;
        border: 1px solid #cbd5e1;
        min-width: 200px;
    }

    input[name="actual_non_combina_reason"]:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    @media (max-width: 1400px) {
        .table-container {
            overflow-x: auto;
            padding: 0 20px 20px;
        }
        
        .advanced-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 0 0 8px 8px;  /* åªæœ‰åº•éƒ¨åœ†è§’ */
            overflow: hidden;
        }
        
        .info-bar {
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }
        
        .info-item:nth-child(3)::after {
            display: none;
        }
        .combina-summary {
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .summary-item {
            flex: 0 0 auto;
        }
    }
    @media (max-width: 1200px) {
        .info-cards-container {
            grid-template-columns: 1fr;
            gap: 15px; 
        }
        
        .quotation-card, .info-card {
            text-align: left;  
        }
    }
   
</style>

<div id="rules-modal" class="rules-modal">
    <div class="rules-content">
        <h3 class="modal-title">ç»„åˆæŸœè§„åˆ™è¯¦æƒ…</h3>

        <div class="rules-section">
            <div class="section-title">ğŸ“Œ åŸºç¡€è§„åˆ™ï¼ˆGlobal Rulesï¼‰</div>
            <pre class="rules-text">{{ combina_rules_text.global_rules }}</pre>
        </div>

        <div class="divider"></div>

        

        <div class="rules-section">
            <div class="section-title">ğŸ¬ éç»„åˆæŸœææ‹†è®¡è´¹ï¼ˆWarehouse Rulesï¼‰</div>
            <pre class="rules-text">{{ combina_rules_text.warehouse_rules }}</pre>
        </div>
        <div class="divider"></div>

        <div class="rules-section">
            <div class="section-title">âš–ï¸ ç‰¹æ®Šä»“ç‚¹è®¡è´¹ï¼ˆWeight Rulesï¼‰</div>
            <pre class="rules-text">{{ combina_rules_text.special_des_rules }}</pre>
        </div>

        <div class="divider"></div>

        <div class="rules-section">
            <div class="section-title">ğŸ’² è¶…å‡ºä»“ç‚¹é˜¶æ¢¯è®¡è´¹ï¼ˆTiered Pricingï¼‰</div>
            <pre class="rules-text">{{ combina_rules_text.tiered_pricing }}</pre>
        </div>

        <button class="close-btn" onclick="closeRulesModal()">å…³é—­</button>
    </div>
</div>

<div class="finance-container">
    <!-- å¤´éƒ¨ -->
    <header class="system-header">
        <div class="header-main">
            <div class="header-title">
                <div>
                    <h1>å…¬ä»“æ´¾é€è´¦å•å½•å…¥</h1>
                    <div class="header-subtitle">æŸœå·ï¼š{{ container_number }}-{{ invoice_number }}</div>
                </div>
            </div>
            <div class="header-status">
                <!-- æŸœå‹åˆ°å®¢æˆ·ä¿¡æ¯ -->
                <div class="info-group">
                    <span class="info-badge">
                        <i class="fas fa-box"></i>
                        <strong>æŸœå‹:</strong> {{ container_type }}
                    </span>
                    <span class="info-badge">
                        <i class="fas fa-warehouse"></i>
                        <strong>ä»“åº“:</strong> {{ warehouse }}
                    </span>
                    <span class="info-badge">
                        <i class="fas fa-user-tie"></i>
                        <strong>å®¢æˆ·:</strong> {{ customer_name }}
                    </span>
                    <button onclick="window.history.back()" style="background: linear-gradient(135deg, #9ca3af, #6b7280);
                            border: 1px solid rgba(255,255,255,0.3);
                            color: white;
                            padding: 10px 20px;
                            border-radius: 8px;
                            cursor: pointer;
                            display: flex;
                            align-items: center;
                            gap: 8px;
                            transition: all 0.2s ease;">
                        <i class="fas fa-arrow-left"></i>
                        è¿”å›
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!--æ§åˆ¶è®¢å•æ˜¯å¦ä¸ºç»„åˆæŸœ-->
    <div class="invoice-content">
        <!-- ä¿¡æ¯å¡ç‰‡å®¹å™¨ -->
        <div class="info-cards-container">
            <!-- æŠ¥ä»·è¡¨ä¿¡æ¯å¡ç‰‡ -->
            <div class="quotation-card">
                <div class="quotation-title">
                    <i class="fas fa-file-invoice-dollar"></i>
                    å‚è€ƒæŠ¥ä»·è¡¨
                </div>
                <div class="quotation-details">
                    <strong>æ–‡ä»¶:</strong> <span class="quotation-highlight">{{ quotation_info.filename }}</span> 
                        <span class="divider-line"></span>
                        <strong>ç‰ˆæœ¬:</strong> {{ quotation_info.version }}
                        <span class="divider-line"></span>
                        <strong>ç”Ÿæ•ˆæ—¥æœŸ:</strong> {{ quotation_info.effective_date }}
                    {% if quotation_info.is_user_exclusive %}
                        <span class="divider-line"></span>
                        <strong style="color: #dc2626;">ä¸“å±ç”¨æˆ·:</strong> {{ quotation_info.exclusive_user }}
                    {% else %}
                        <span class="divider-line"></span>
                        <strong style="color: #16a34a;">é€šç”¨æŠ¥ä»·</strong>
                    {% endif %}
                        <span class="divider-line"></span>
                        <strong>çŠ¶æ€:</strong> 
                    <span style="color: {% if preport_status == 'completed' %}#16a34a{% elif preport_status == 'in_progress' %}#ea580c{% else %}#dc2626{% endif %};">
                        {% if preport_status == 'completed' %}å·²å®Œæˆ
                        {% elif preport_status == 'in_progress' %}å½•å…¥ä¸­
                        {% elif preport_status == 'rejected' %}å·²é©³å›
                        {% elif preport_status == 'pending_review' %}å¾…å®¡æ ¸
                        {% else %}æœªå¼€å§‹
                        {% endif %}
                    </span>
                </div>
            </div>

            <!-- ç»„åˆæŸœä¿¡æ¯å¡ç‰‡ -->
            <div class="info-card">
                <div class="info-title">
                    <i class="fas fa-boxes"></i>
                    ç»„åˆæŸœä¿¡æ¯
                </div>
                <div class="info-details">
                    {% if order_type == 'è½¬è¿' %}
                        <!-- åŸæœ¬å°±æ˜¯è½¬è¿å• -->
                        <strong>ç±»å‹:</strong> <span class="info-highlight">è½¬è¿</span>

                    {% elif order_type == 'è½¬è¿ç»„åˆ' %}
                        <form method="post" action="" class="order-type-form">
                            {% csrf_token %}
                            <input type="hidden" name="step" value="modify_order_type">
                            <input type="hidden" name="start_date" value="{{ start_date }}">
                            <input type="hidden" name="end_date" value="{{ end_date }}">
                            <input type="hidden" name="new_order_type" id="new_order_type" value="">
                            <input type="hidden" name="container_number" value="{{ container_number }}">
                            <input type="hidden" name="invoice_id" value="{{ invoice.id }}">                        
                            <input type="hidden" name="warehouse_filter" value="{{ warehouse_filter }}">
                            <input type="hidden" name="page" value="delivery_edit">
                            <!-- æ˜¯ç»„åˆæŸœç±»å‹ -->
                            <strong>ç»„åˆæŸœçŠ¶æ€:</strong>
                            {% if is_combina %}
                                <span class="info-highlight" style="color: #16a34a;">ç¬¦åˆç»„åˆæŸœ</span>
                                <span class="divider-line"></span>
                                <button type="submit" class="btn-change-order-type" 
                                        onclick="setOrderType('è½¬è¿')">
                                    <i class="fas fa-exchange-alt"></i>
                                    æ”¹ä¸ºè½¬è¿
                                </button> &nbsp;&nbsp;                              
                                <input type="text" name="actual_non_combina_reason" placeholder="ä¸ç¬¦åˆåŸå› ">
                                <span class="divider-line"></span>
                                <span class="rules-icon" onclick="openRulesModal()">ğŸ“˜ ç»„åˆæŸœè§„åˆ™æŸ¥çœ‹</span>
                            {% else %}
                                <span class="info-highlight" style="color: #dc2626;">ä¸ç¬¦åˆç»„åˆæŸœ</span>
                                {% if non_combina_reason %}
                                    <span class="divider-line"></span>
                                    <strong style="color:#dc2626;">åŸå› :</strong> 
                                    <span class="badge" style="background: rgba(255, 193, 7, 0.2); color: #ffa000;">
                                        âš ï¸{{ non_combina_reason }}
                                    </span>
                                {% endif %}
                                <button type="submit" class="btn-change-order-type" 
                                        onclick="setOrderType('è½¬è¿ç»„åˆ')">
                                    <i class="fas fa-exchange-alt"></i>
                                    æ”¹ä¸ºç»„åˆæŸœ
                                </button>
                                <span class="divider-line"></span>
                                <span class="rules-icon" onclick="openRulesModal()">ğŸ“˜ ç»„åˆæŸœè§„åˆ™æŸ¥çœ‹</span>
                            {% endif %}
                        </form>
                        
                    {% else %}
                        <!-- å…¶ä»–ç±»å‹ï¼ˆéè½¬è¿ / éè½¬è¿ç»„åˆï¼‰ -->
                        <strong>ç±»å‹:</strong> <span class="info-highlight">{{ order_type }}</span>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    <!-- ä¸»è¦å†…å®¹ -->
    <main class="main-content">   
        <form method="post" id="delivery-billing-form">
            {% csrf_token %}
            <input type="hidden" name="container_number" value="{{ container_number }}">
            <input type="hidden" name="invoice_id" value="{{ invoice_id }}">
            <input type="hidden" name="delivery_type" value="public">
            <input type="hidden" name="step" value="save_all">
            <input type="hidden" name="start_date" value="{{ start_date }}">
            <input type="hidden" name="end_date" value="{{ end_date }}">
            <input type="hidden" name="warehouse_filter" value="{{ warehouse_filter }}">
            
            <!-- ================ é¡¶éƒ¨æ“ä½œæ  ================ -->
            <div class="top-actions-bar">
                <!-- CBMä¿¡æ¯ -->
                <div class="cbm-display">
                    <div class="cbm-item">
                        <div class="cbm-label">æŸœå­æ€»CBM</div>
                        <div class="cbm-value">{{ total_container_cbm|floatformat:2 }}</div>
                    </div>
                </div>
                
                <!-- æ€»é‡‘é¢ -->
                <div class="total-display">
                    <div class="total-item">
                        <div class="total-label">æ€»é‡‘é¢ (USD)</div>
                        <div class="total-value" id="total-amount">0.00</div>
                    </div>
                </div>
                
                <!-- ä¿å­˜æŒ‰é’® -->
                {% if not receivable_is_locked%}
                <div class="save-button-container">
                    <button id="save-bill-btn" type="button" class="btn btn-success" style="padding: 12px 30px; font-size: 1rem;">
                        <i class="fas fa-save"></i>ä¿å­˜è´¦å•
                    </button>
                </div>
                {% else %}
                    è´¢åŠ¡å·²ç¡®è®¤ï¼Œä¸å¯ç¼–è¾‘
                {% endif %}
            </div>
            <!-- ================ ç»„åˆæŸœè®¡è´¹åŒºåŸŸ ================ -->
            {% if is_combina and combina_groups %}
            <div class="combina-section">
                <div class="section-header">
                    <h3><i class="fas fa-boxes me-2"></i>ç»„åˆæŸœè®¡è´¹</h3>
                    <div class="section-count">
                        å…± {{ combina_groups|length }} ä¸ªåŒºåŸŸï¼Œæ€»è´¹ç”¨ï¼š${{ combina_info.base_fee|default:0|floatformat:2 }}ï¼Œæ€»CBMï¼š{{ combina_info.total_cbm|default:0|floatformat:2 }}
                    </div>
                </div>
                
                <div class="table-container">
                    <table class="advanced-table combina-table">
                        <!-- ç»„åˆæŸœè¡¨æ ¼å†…å®¹ä¿æŒä¸å˜ -->
                        <thead>
                            <tr>
                                <th>åŒºåŸŸ</th>
                                <th>å•ä»·</th>
                                <th>ç›®çš„åœ°</th>
                                <th>CBM</th>
                                <th>é‡é‡(lbs)</th>
                                <th>PO_ID</th>
                                <th>æ´¾é€æ–¹å¼</th>
                                <th>æ¿æ•°</th>
                                <th>é‡‘é¢(USD)</th>
                                <th>å¤‡æ³¨</th>
                                <th>çŠ¶æ€</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for group in combina_groups %}
                            {% with region_rowspan=group.items|length %}
                            {% for item in group.items %}
                            <tr data-row="{{ forloop.parentloop.counter0 }}_{{ forloop.counter0 }}" 
                                data-item-id="{{ item.id|default:'' }}" 
                                data-po="{{ item.PO_ID|default:'' }}" 
                                data-is-hold="false"
                                data-combina-region="{{ item.combina_region|default:'' }}"
                                data-combina-price="{{ item.combina_price|default:0 }}"
                                data-cbm="{{ item.total_cbm|default:0 }}"
                                data-cbm-ratio="{{ item.cbm_ratio|default:0 }}"
                                data-weight="{{ item.total_weight_lbs|default:0 }}"
                                class="row-combina">
                                
                                <!-- åŒºåŸŸï¼ˆåˆå¹¶è¡Œï¼‰ -->
                                {% if forloop.first %}
                                <td rowspan="{{ region_rowspan }}" class="cell-region">
                                    <div class="region-name">{{ group.region }}</div>
                                    <div class="region-cbm">{{ group.total_cbm|floatformat:2 }} CBM</div>
                                </td>
                                {% endif %}
                                
                                <!-- å•ä»·ï¼ˆåˆå¹¶è¡Œï¼‰ -->
                                {% if forloop.first %}
                                <td rowspan="{{ region_rowspan }}" class="cell-price">
                                    <div class="region-region-price">
                                        ${{ group.region_price }}
                                    </div>
                                    <!-- å•ä»· -->
                                    <div class="price-value">å•ä»·: ${{ group.price|floatformat:2 }}</div>
                                </td>
                                {% endif %}
                                
                                <!-- ç›®çš„åœ° -->
                                <td class="cell-destination">{{ item.destination|default:"-" }}</td>
                                
                                <!-- CBM -->
                                <td class="cell-stats">
                                    <div class="stat-value">
                                        {{ item.total_cbm|floatformat:2|default:"0.00" }}
                                        {% if item.cbm_ratio %}
                                        <div class="text-muted small">{{ item.cbm_ratio }}%</div>
                                        {% endif %}
                                    </div>
                                </td>
                                
                                <!-- é‡é‡ -->
                                <td class="cell-stats">
                                    <div class="stat-value">{{ item.total_weight_lbs|floatformat:2|default:"0.00" }}</div>
                                </td>
                                
                                <!-- PO_ID -->
                                <td class="cell-po">{{ item.PO_ID|default:"-" }}</td>
                                
                                <!-- æ´¾é€æ–¹å¼ï¼ˆåªè¯»ï¼‰ -->
                                <td>
                                    <div class="select-wrapper">
                                        <select name="delivery_category_combina_{{ forloop.parentloop.counter0 }}_{{ forloop.counter0 }}" 
                                                class="select-control" disabled>
                                            <option value="combine" selected>ç»„åˆæŸœ</option>
                                        </select>
                                    </div>
                                </td>
                                
                                <!-- æ¿æ•° -->
                                <td>
                                    <input type="number" 
                                        name="pallets_combina_{{ forloop.parentloop.counter0 }}_{{ forloop.counter0 }}" 
                                        class="input-control input-pallets"
                                        value="{{ item.total_pallets|default:0 }}">
                                </td>
                                
                                <!-- é‡‘é¢ -->
                                <td>
                                    <input type="number" 
                                        name="amount_combina_{{ forloop.parentloop.counter0 }}_{{ forloop.counter0 }}" 
                                        class="input-control input-amount combina-amount-input"
                                        value="{{ item.amount|default:'' }}" readonly>
                                </td>
                                
                                <!-- å¤‡æ³¨ï¼ˆå¯ç¼–è¾‘ï¼‰ -->
                                <td>
                                    <input type="text" 
                                        name="note_combina_{{ forloop.parentloop.counter0 }}_{{ forloop.counter0 }}" 
                                        class="input-control input-note combina-note-input"
                                        value="{{ item.note|default:'' }}"
                                        placeholder="å¤‡æ³¨"
                                        >
                                </td>
                                
                                <!-- çŠ¶æ€ -->
                                <td class="cell-status">
                                    {% if item.is_previous_existing %}
                                        ä¹‹å‰è´¦å•å·²å½•
                                    {% else %}
                                        {% if item.is_existing %}
                                        <span class="status-indicator existing">
                                            <i class="fas fa-check-circle icon"></i>å·²å½•
                                        </span>
                                        {% else %}
                                        <span class="status-indicator">
                                            <i class="fas fa-clock icon"></i>æœªå½•
                                        </span>
                                        {% endif %}
                                    {% endif %}
                                </td>
                                
                            </tr>
                            {% endfor %}
                            {% endwith %}
                            {% endfor %}
                        </tbody>
                    </table>
                    <!-- ç»„åˆæŸœæ•´ä½“ä¿å­˜æŒ‰é’® -->
                    <div class="combina-action-bar" style="padding: 15px 30px; text-align: right; background: #f8fdff; border: 1px solid #bbdefb; border-top: none; border-radius: 0 0 8px 8px;">
                        <button type="button" class="btn btn-success" onclick="saveAllCombina()">
                            <i class="fas fa-save"></i>ä¿å­˜æ‰€æœ‰ç»„åˆæŸœ
                        </button>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- ================ è½¬è¿è®¡è´¹åŒºåŸŸ ================ -->
            {% if normal_items %}
            <div class="transfer-section">
                <div class="section-header">
                    <h3><i class="fas fa-truck me-2"></i>è½¬è¿è®¡è´¹</h3>
                    <div class="section-count">
                        å…± {{ normal_items|length }} æ¡è®°å½•
                    </div>
                </div>
                
                <div class="table-container">
                    <table class="advanced-table normal-table">
                        <thead>
                            <tr>
                                <!-- ç§»é™¤äº†å”›å¤´åˆ— -->
                                <th>ç›®çš„åœ°</th>
                                <th>CBM</th>
                                <th>é‡é‡(lbs)</th>
                                <th>æ´¾é€ç±»å‹</th>
                                <th>æ¿æ•°</th>
                                <th>å•ä»·(USD)</th>
                                <th>é™„åŠ è´¹(USD)</th>
                                <th>é‡‘é¢(USD)</th>
                                <th>å¤‡æ³¨</th>
                                <th>PO_ID</th>
                                <th>çŠ¶æ€</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in normal_items %}
                            <tr data-row="{{ forloop.counter0 }}" 
                                data-item-id="{{ item.id|default:'' }}" 
                                data-po="{{ item.PO_ID|default:'' }}" 
                                data-is-hold="{% if item.delivery_category == 'hold' %}true{% else %}false{% endif %}"
                                data-base-amount="{{ item.amount|floatformat:2 }}"
                                data-cbm="{{ item.total_cbm|default:0 }}"
                                data-weight="{{ item.total_weight_lbs|default:0 }}"
                                {% if not item.delivery_category %}class="row-no-type"{% endif %}>
                                
                                <!-- ç›®çš„åœ° -->
                                <td class="cell-destination">{{ item.destination|default:"-" }}</td>
                                
                                <!-- CBM -->
                                <td class="cell-stats">
                                    <div class="stat-value">{{ item.total_cbm|floatformat:2|default:"0.00" }}</div>
                                </td>
                                
                                <!-- é‡é‡ -->
                                <td class="cell-stats">
                                    <div class="stat-value">{{ item.total_weight_lbs|floatformat:2|default:"0.00" }}</div>
                                </td>
                                
                                <!-- æ´¾é€ç±»å‹ï¼ˆç©ºå€¼æ—¶é«˜äº®ï¼‰ -->
                                <td>
                                    <div class="select-wrapper">
                                        <select name="delivery_category_{{ forloop.counter0 }}" 
                                                class="select-control delivery-type-select {% if not item.delivery_category %}highlight-select{% endif %}"
                                                data-row="{{ forloop.counter0 }}">
                                            <option value="">è¯·é€‰æ‹©</option>
                                            <option value="upsdelivery" {% if item.delivery_category == "upsdelivery" %}selected{% endif %}>å¿«é€’</option>
                                            <option value="walmart" {% if item.delivery_category == "walmart" %}selected{% endif %}>æ²ƒå°”ç›</option>
                                            <option value="amazon" {% if item.delivery_category == "amazon" %}selected{% endif %}>äºšé©¬é€Š</option>
                                            <option value="hold" {% if item.delivery_category == "hold" %}selected{% endif %}>æš‚æ‰£ç•™ä»“</option>
                                        </select>
                                    </div>
                                </td>
                                
                                <!-- æ¿æ•° -->
                                <td>
                                    <input type="number" 
                                        name="pallets_{{ forloop.counter0 }}" 
                                        class="input-control input-pallets"
                                        value="{{ item.total_pallets|default:0 }}"
                                        min="0" step="0.5" data-row="{{ forloop.counter0 }}"
                                        placeholder="0"
                                        {% if item.delivery_category == "hold" %}disabled{% endif %}>
                                </td>
                                
                                <!-- å•ä»· -->
                                <td>
                                    <input type="number" 
                                        name="rate_{{ forloop.counter0 }}" 
                                        class="input-control input-rate"
                                        value="{{ item.rate|default:'' }}"
                                        step="0.01" data-row="{{ forloop.counter0 }}"
                                        placeholder="0.00"
                                        {% if item.delivery_category == "hold" %}disabled{% endif %}>
                                </td>
                                
                                <!-- é™„åŠ è´¹ -->
                                <td>
                                    <input type="number" 
                                        name="surcharges_{{ forloop.counter0 }}"
                                        class="input-control input-surcharge"
                                        value="{{ item.surcharges|default:0 }}"
                                        step="0.01" data-row="{{ forloop.counter0 }}"
                                        placeholder="0.00"
                                        {% if item.delivery_category == "hold" %}disabled{% endif %}>
                                </td>
                                
                                <!-- é‡‘é¢ï¼ˆåˆå§‹åŒ–=åŸå§‹å€¼ï¼Œé™„åŠ è´¹å˜åŒ–æ—¶ç´¯åŠ ï¼‰ -->
                                <td>
                                    <input type="number" 
                                        name="amount_{{ forloop.counter0 }}" 
                                        class="input-control input-amount amount-input"
                                        value="{{ item.amount|default_if_none:'0.00' }}"
                                        step="0.01" data-row="{{ forloop.counter0 }}"
                                        placeholder="0.00" readonly>
                                </td>
                                
                                <!-- å¤‡æ³¨ -->
                                <td>
                                    <input type="text" 
                                        name="note_{{ forloop.counter0 }}" 
                                        class="input-control input-note"
                                        value="{{ item.note|default:'' }}"
                                        placeholder="å¤‡æ³¨"
                                        {% if item.delivery_category == "hold" %}disabled{% endif %}>
                                </td>
                                
                                
                                <!-- POå· -->
                                <td class="cell-po">{{ item.PO_ID|default:"-" }}</td>
                                
                                <!-- çŠ¶æ€ -->
                                <td class="cell-status">
                                    {% if item.delivery_category == "hold" %}
                                    <span class="status-indicator status-hold">æš‚æ‰£</span>
                                    {% elif not item.is_existing %}
                                    <span class="status-indicator">æœªå½•</span>
                                    {% else %}
                                    <span class="status-indicator existing">å·²å½•</span>
                                    {% endif %}
                                </td>
                                
                                <!-- æ“ä½œåˆ— -->
                                <td class="cell-action">
                                    {% if item.delivery_category == "hold" %}
                                    <button type="button" class="action-btn btn-release"
                                            onclick="releaseHoldItem('{{ container_number }}', '{{ item.PO_ID|default:'' }}', '{{ item.pallet_ids|join:','|default:'' }}', '{{ forloop.counter0 }}')">
                                        <i class="fas fa-unlock"></i>è§£æ‰£
                                    </button>
                                    {% else %}
                                    <button type="button" class="action-btn btn-save-row"
                                            onclick="saveSingleRow({{ forloop.counter0 }}, '{{ item.id|default:'' }}')"
                                            {% if not item.delivery_category %}disabled{% endif %}>
                                        <i class="fas fa-save"></i>ä¿å­˜
                                    </button>
                                    {% endif %}
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="12" style="text-align: center; padding: 60px 20px; color: var(--text-secondary);">
                                    <i class="fas fa-clipboard-list" style="font-size: 3rem; margin-bottom: 20px; color: #e0e0e0;"></i>
                                    <p>æš‚æ— è½¬è¿è®¡è´¹æ•°æ®</p>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% endif %}

            <div class="activation-fee-section">
                <div class="section-header">
                    <h3><i class="fas fa-bolt me-2"></i>POæ¿€æ´»è´¹</h3>
                    <div class="section-header-actions" style="display: flex; align-items: center; gap: 10px;">
                        <span class="section-count" style="margin-left: 10px; font-size: 0.9rem; color: #666;">
                            å…± {{ activation_fee_groups|length }} æ¡è®°å½•
                        </span>
                        <button type="button" class="btn btn-primary" onclick="openActivationModal()" style="margin-left: auto;">
                            <i class="fas fa-plus"></i>æ·»åŠ POæ¿€æ´»è´¹
                        </button>
                    </div>
                </div>
                
                <div class="table-container">
                    <table class="advanced-table activation-table">
                        <thead>
                            <tr>
                                <th>PO_ID</th>
                                <th>ç›®çš„åœ°</th>
                                <th>CBM</th>
                                <th>é‡é‡(lbs)</th>
                                <th>æ¿æ•°</th>
                                <th>è´¹ç”¨(USD)</th>
                                <th>å¤‡æ³¨</th>
                                <th>çŠ¶æ€</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="activation-fee-tbody">
                            {% for item in activation_fee_groups %}
                            <tr data-activation-id="{{ item.id }}" data-po="{{ item.PO_ID }}">
                                <td class="cell-po">{{ item.PO_ID|default:"-" }}</td>
                                <td>{{ item.destination|default:"-" }}</td>
                                <td>{{ item.cbm|floatformat:2|default:"0.00" }}</td>
                                <td>{{ item.weight|floatformat:2|default:"0.00" }}</td>
                                <td>{{ item.pallet|floatformat:2|default:"0.00" }}</td>
                                <td>
                                    <input type="number" 
                                        name="activation_amount_{{ forloop.counter0 }}"
                                        class="input-control input-amount activation-amount-input"
                                        value="{{ item.amount|default:'' }}"
                                        step="0.01" min="0"
                                        data-index="{{ forloop.counter0 }}"
                                        placeholder="0.00">
                                </td>
                                <td>
                                    <input type="text" 
                                        name="activation_note_{{ forloop.counter0 }}"
                                        class="input-control input-note"
                                        value="{{ item.note|default:'' }}"
                                        placeholder="å¤‡æ³¨"
                                        data-index="{{ forloop.counter0 }}">
                                </td>
                                <td class="cell-status">
                                    {% if item.is_existing %}
                                    <span class="status-indicator existing">å·²å½•</span>
                                    {% else %}
                                    <span class="status-indicator">æœªå½•</span>
                                    {% endif %}
                                </td>
                                <td class="cell-action">
                                    <button type="button" class="action-btn btn-danger" onclick="removeActivationItem('{{ item.PO_ID }}')">
                                        <i class="fas fa-trash"></i>ç§»é™¤
                                    </button>
                                </td>
                            </tr>
                            {% empty %}
                            <tr id="no-activation-row">
                                <td colspan="8" style="text-align: center; padding: 40px 20px; color: var(--text-secondary);">
                                    <i class="fas fa-bolt" style="font-size: 2.5rem; margin-bottom: 15px; color: #e0e0e0;"></i>
                                    <p>æš‚æ— POæ¿€æ´»è´¹è®°å½•</p>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    
                    <!-- POæ¿€æ´»è´¹å•ç‹¬ä¿å­˜æŒ‰é’® -->
                    <div class="activation-action-bar" style="padding: 15px 30px; text-align: right; background: #f8f9fa; border: 1px solid var(--border-color); border-top: none; border-radius: 0 0 8px 8px;">
                        <button type="button" class="btn btn-success" onclick="saveAllActivationFees()">
                            <i class="fas fa-save"></i>ä¿å­˜æ‰€æœ‰POæ¿€æ´»è´¹
                        </button>
                    </div>
                </div>
            </div>

            

            <!-- ================ å…¶ä»–ç±»å‹POåŒºåŸŸ ================ -->
            {% if other_pallet_groups %}
            <div class="other-section">
                <div class="section-header">
                    <h3 style="margin: 0;">
                        <i class="fas fa-exchange-alt me-2"></i>æ‰€æœ‰PO
                        <span class="section-count" style="margin-left: 10px; font-size: 0.9rem; color: #666;">
                            å…± {{ other_pallet_groups|length }} æ¡è®°å½•
                        </span>
                    </h3>
                </div>
                
                <div class="table-container">
                    <table class="advanced-table other-table">
                        <thead>
                            <tr>
                                <th>ç›®çš„åœ°</th>
                                <th>æ´¾é€æ–¹å¼</th>
                                <th>CBM</th>
                                <th>é‡é‡(lbs)</th>                               
                                <th>æ¿æ•°</th>
                                <th>PO_ID</th>
                                <th>çŠ¶æ€</th>
                                <th>ç±»å‹</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for group in other_pallet_groups %}
                            <tr data-other-po="{{ group.PO_ID }}" data-other-delivery-type="{{ group.delivery_type }}">
                                
                                <td class="cell-destination">{{ group.destination|default:"-" }}</td>
                                <td>{{ group.delivery_method|default:"-" }}</td>
                                <td>{{ group.total_cbm|floatformat:2|default:"0.00" }}</td>
                                <td>{{ group.total_weight_lbs|floatformat:2|default:"0.00" }}</td>                               
                                <td>{{ group.total_pallets|default:0 }}</td>
                                <td class="cell-po">{{ group.PO_ID|default:"-" }}</td>
                                <td class="cell-po">
                                    {% if group.item_id %}
                                    <span class="status-indicator status-hold">                                   
                                        å·²å½•
                                    </span>
                                    {% else %}
                                    <span class="status-indicator existing">                                   
                                        æœªå½•
                                    </span>
                                    {% endif %}
                                </td>
                                <td class="cell-po" style="{% if group.delivery_type == 'public' %}background-color: #e6f7ff; color: #0066cc;
                                        {% elif group.delivery_type == 'other' %}background-color: #f6ffed; color: #52c41a;
                                        {% else %}background-color: #fff2e8; color: #fa8c16;
                                        {% endif %}">
                                    {% if group.delivery_type == "public" %}
                                        å…¬ä»“
                                    {% elif group.delivery_type == "other" %}
                                        ç§ä»“
                                    {% else %}
                                        å¼‚å¸¸
                                    {% endif %}
                                </td>
                                <td class="cell-action" style="{% if group.delivery_type == 'public' %}background-color: #e6f7ff; color: #0066cc;
                                    {% elif group.delivery_type == 'other' %}background-color: #f6ffed; color: #52c41a;
                                    {% else %}background-color: #fff2e8; color: #fa8c16;
                                    {% endif %}">
                                    <!-- è½¬æ¢ç±»å‹æŒ‰é’® -->
                                    {% if group.delivery_type == "public" %}
                                        <button type="button" class="btn-convert"
                                                onclick="convertToCurrentType('{{ group.PO_ID }}', '{{ group.item_id }}','other')"
                                                style="background-color: #bae7ff; color: #0050b3; border: 1px solid #69c0ff;">
                                            <i class="fas fa-sync-alt"></i>è½¬ç§ä»“
                                        </button>
                                    {% elif group.delivery_type == "other" %}
                                        <button type="button" class="btn-convert"
                                                onclick="convertToCurrentType('{{ group.PO_ID }}', '{{ group.item_id }}','public')"
                                                style="background-color: #d9f7be; color: #389e0d; border: 1px solid #95de64;">
                                            <i class="fas fa-sync-alt"></i>è½¬å…¬ä»“
                                        </button>
                                    {% else %}
                                        {{ group.delivery_type }}
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% endif %}
        </form>
    </main>
</div>

<!-- é€‰æ‹©POæ¿€æ´»è´¹æ¨¡æ€æ¡† -->
<div class="modal fade" id="activationModal" tabindex="-1" aria-labelledby="activationModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" style="max-width: 90%;">
        <div class="modal-content">
            <div class="modal-header green-modal-header">
                <h5 class="modal-title" id="activationModalLabel">
                    <i class="fas fa-bolt me-2"></i> é€‰æ‹©POæ¿€æ´»è´¹é¡¹ç›®
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            
            <div class="modal-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th style="width: 50px;">
                                    <input type="checkbox" id="select-all-activation">
                                </th>                             
                                <th>ç›®çš„åœ°</th>
                                <th>CBM</th>
                                <th>é‡é‡(lbs)</th>
                                <th>æ¿æ•°</th>
                                <th>æ´¾é€æ–¹å¼</th>
                                <th>PO_ID</th>
                            </tr>
                        </thead>
                        <tbody id="activation-modal-tbody">
                            {% for group in activation_table %}
                            <tr data-po="{{ group.PO_ID }}">
                                <td>
                                    <input type="checkbox" class="activation-po-checkbox" 
                                           value="{{ group.PO_ID }}"
                                           data-destination="{{ group.destination }}"
                                           data-cbm="{{ group.total_cbm }}"
                                           data-weight="{{ group.total_weight_lbs }}"
                                           data-pallet="{{ group.total_pallets }}">
                                </td>
                                
                                <td>{{ group.destination }}</td>
                                <td>{{ group.total_cbm|floatformat:2 }}</td>
                                <td>{{ group.total_weight_lbs|floatformat:2 }}</td>
                                <td>{{ group.total_pallets }}</td>
                                <td>{{ group.delivery_method }}</td>
                                <td>{{ group.PO_ID }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="modal-footer">
                <button type="button" class="btn btn-green-outline" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> å–æ¶ˆ
                </button>
                <button type="button" class="btn btn-green" onclick="addSelectedActivationItems()">
                    <i class="fas fa-plus"></i> æ·»åŠ é€‰ä¸­é¡¹
                </button>
            </div>
        </div>
    </div>
</div>

<!-- è½¬æ¢ç±»å‹çš„form -->
<form method="post" id="convert-form" style="display: none;">
    {% csrf_token %}
    <input type="hidden" name="step" value="convert_type">
    <input type="hidden" name="container_number" value="{{ container_number }}">
    <input type="hidden" name="warehouse_filter" value="{{ warehouse_filter }}">
    <input type="hidden" name="invoice_id" value="{{ invoice_id }}">
    <input type="hidden" name="template_delivery_type" value="public">
    <input type="hidden" name="to_delivery_type" id="to-delivery-type">
    <input type="hidden" name="po_id" id="convert-po-id" value="">
    <input type="hidden" name="item_id" id="convert-item-id" value="">
    <input type="hidden" name="start_date" value="{{ start_date }}">
    <input type="hidden" name="end_date" value="{{ end_date }}">
</form>

<!-- å•è¡Œä¿å­˜çš„formï¼ˆç‹¬ç«‹formï¼‰ -->
<form method="post" id="single-row-form" style="display: none;">
    {% csrf_token %}
    <input type="hidden" name="step" value="save_single">
    <input type="hidden" name="start_date" value="{{ start_date }}">
    <input type="hidden" name="end_date" value="{{ end_date }}">
    <input type="hidden" name="warehouse_filter" value="{{ warehouse_filter }}">
    <input type="hidden" name="container_number" value="{{ container_number }}">
    <input type="hidden" name="invoice_id" value="{{ invoice_id }}">
    <input type="hidden" name="delivery_type" value="public">
    <input type="hidden" name="row_index" id="single-row-index" value="">
    <input type="hidden" name="item_id" id="single-item-id" value="">
    <input type="hidden" name="po_id" id="single-po-id" value="">
    <input type="hidden" name="destination" id="single-destination" value="">
    <input type="hidden" name="delivery_category" id="single-delivery-category" value="">
    <input type="hidden" name="rate" id="single-rate" value="">
    <input type="hidden" name="pallets" id="single-pallets" value="">
    <input type="hidden" name="surcharges" id="single-surcharges" value="">
    <input type="hidden" name="amount" id="single-amount" value="">
    <input type="hidden" name="note" id="single-note" value="">
    <input type="hidden" name="cbm" id="single-cbm" value="">
    <input type="hidden" name="weight" id="single-weight" value="">
</form>

<!-- ä¿å­˜æ‰€æœ‰ç»„åˆæŸœçš„formï¼ˆç‹¬ç«‹formï¼‰ -->
<form method="post" id="all-combina-form" style="display: none;">
    {% csrf_token %}
    <input type="hidden" name="step" value="save_all_combina">
    <input type="hidden" name="warehouse_filter" value="{{ warehouse_filter }}">
    <input type="hidden" name="container_number" value="{{ container_number }}">
    <input type="hidden" name="invoice_id" value="{{ invoice_id }}">
    <input type="hidden" name="delivery_type" value="public">
    <input type="hidden" name="combina_items" id="all-combina-items" value="">
    <input type="hidden" name="start_date" value="{{ start_date }}">
    <input type="hidden" name="end_date" value="{{ end_date }}">
</form>

{% include 'receivable_accounting/modals/message_modal.html' %}
<div id="toast-container" class="toast-container"></div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>

    // POæ¿€æ´»è´¹åŠŸèƒ½
    let activationItems = [];
    function calculateTotalAmount() {
        let total = 0;
        
        // 1. è®¡ç®—ç»„åˆæŸœæ€»é‡‘é¢
        $('.combina-amount-input').each(function() {
            const amount = parseFloat($(this).val()) || 0;
            total += amount;
        });
        console.log('ç»„åˆæŸœ',total);
        // 2. è®¡ç®—è½¬è¿è®¡è´¹æ€»é‡‘é¢
        $('.amount-input').each(function() {
            const amount = parseFloat($(this).val()) || 0;
            total += amount;
        });
        console.log('è½¬è¿',total);
        $('.activation-amount-input').each(function() {
            const amount = parseFloat($(this).val()) || 0;
            total += amount;
        });
        $('#total-amount').text(total.toFixed(2));
        return total;
    }
    $(document).ready(function() {
        // è®¡ç®—æ€»é‡‘é¢
        
        // åˆå§‹åŒ–æ—¶è®¡ç®—æ€»é‡‘é¢
        calculateTotalAmount();

        // æ·»åŠ POæ¿€æ´»è´¹é‡‘é¢å˜åŒ–çš„ç›‘å¬
        $(document).on('input', '.activation-amount-input', function() {
            const index = $(this).data('index');
            const amount = $(this).val();
            if (activationItems[index]) {
                activationItems[index].amount = amount;
            }
            // é‡æ–°è®¡ç®—æ€»é‡‘é¢
            calculateTotalAmount();
        });
        $(document).on('input change', '.input-rate, .input-pallets, .input-surcharge, .delivery-type-select', function() {
            const $row = $(this).closest('tr');
            const rowIndex = $row.data('row');
            if (typeof rowIndex === 'undefined') return;
            
            // é‡æ–°è®¡ç®—è¯¥è¡Œé‡‘é¢
            calculateRowAmount(rowIndex);
            // é‡æ–°è®¡ç®—æ€»é‡‘é¢
            calculateTotalAmount();
        });
        // ç›‘å¬ä»å•è¡Œä¿å­˜è¿”å›æ—¶çš„é‡‘é¢å˜åŒ–
        $(document).on('focus', '.amount-input', function() {
            const $row = $(this).closest('tr');
            const rowIndex = $row.data('row');
            if (typeof rowIndex === 'undefined') return;
            
            // è®°å½•ç„¦ç‚¹å‰çš„å€¼ï¼Œç”¨äºæ£€æµ‹å˜åŒ–
            $(this).data('previous-value', $(this).val());
        });
        
        $(document).on('blur input', '.amount-input', function() {
            const $row = $(this).closest('tr');
            const rowIndex = $row.data('row');
            if (typeof rowIndex === 'undefined') return;
            
            const previousValue = $(this).data('previous-value') || '';
            const currentValue = $(this).val();
            
            // å¦‚æœé‡‘é¢å‘ç”Ÿå˜åŒ–ï¼Œé‡æ–°è®¡ç®—æ€»é‡‘é¢
            if (previousValue !== currentValue) {
                calculateTotalAmount();
                $(this).data('previous-value', currentValue);
            }
        });

        // è®¡ç®—å•è¡Œé‡‘é¢çš„å‡½æ•°ï¼ˆä¿æŒåŸæœ‰é€»è¾‘ï¼‰
        function calculateRowAmount(rowIndex) {
            const $row = $(`tr[data-row="${rowIndex}"]`);
            if (!$row.length) return 0;
            
            const deliveryType = $row.find('.delivery-type-select').val();
            const isHold = $row.data('is-hold') === 'true' || deliveryType === 'hold';
            const $amountInput = $row.find('.amount-input');
            
            if (isHold) {
                $amountInput.val('0.00');
                return 0;
            }
            
            // è·å–åŸºç¡€é‡‘é¢ï¼ˆæ¥è‡ªåç«¯æ•°æ®ï¼‰
            const baseAmount = parseFloat($row.data('base-amount')) || 0;
            // è·å–å½“å‰é™„åŠ è´¹
            const surcharges = parseFloat($row.find('.input-surcharge').val()) || 0;
            
            // é‡‘é¢ = åŸºç¡€é‡‘é¢ + é™„åŠ è´¹
            const finalAmount = baseAmount + surcharges;
            
            $amountInput.val(finalAmount.toFixed(2));
            return finalAmount;
        }

        // è®¾ç½®è¡Œè¾“å…¥çŠ¶æ€
        function setupRowInputs(rowIndex, deliveryType, isHold = false) {
            const $row = $(`tr[data-row="${rowIndex}"]`);
            if (!$row.length) return;
            
            const $rateInput = $row.find('.input-rate');
            const $amountInput = $row.find('.amount-input');
            const $palletsInput = $row.find('.input-pallets');
            const $surchargeInput = $row.find('.input-surcharge');
            const $noteInput = $row.find('.input-note');
            
            const $select = $row.find('.delivery-type-select');
            const $saveBtn = $row.find('.btn-save-row');
            
            // æ ¹æ®æ´¾é€ç±»å‹è®¾ç½®è¾“å…¥æ¡†çŠ¶æ€
            if (isHold || deliveryType === 'hold') {
                // æš‚æ‰£çŠ¶æ€
                $rateInput.prop('disabled', true).val('');
                $amountInput.prop('disabled', true).val('0');
                $palletsInput.prop('disabled', true);
                $surchargeInput.prop('disabled', true).val('0');
                $noteInput.prop('disabled', true);
                $select.removeClass('highlight-select');
                if ($saveBtn.length) $saveBtn.prop('disabled', false);
            } else if (deliveryType && deliveryType !== 'hold') {
                // å·²é€‰æ‹©éholdç±»å‹ï¼ˆUPS/æ²ƒå°”ç›/äºšé©¬é€Šï¼‰
                $rateInput.prop('disabled', false);
                $amountInput.prop('readonly', true).prop('disabled', false);
                $palletsInput.prop('disabled', false);
                $surchargeInput.prop('disabled', false);
                $noteInput.prop('disabled', false);
                $select.removeClass('highlight-select');
                if ($saveBtn.length) $saveBtn.prop('disabled', false);
            } else {
                // æœªé€‰æ‹©ç±»å‹
                $rateInput.prop('disabled', true);
                $amountInput.prop('readonly', true);
                $palletsInput.prop('disabled', false);
                $surchargeInput.prop('disabled', true);
                $noteInput.prop('disabled', false);
                $select.addClass('highlight-select'); // é«˜äº®æ˜¾ç¤º
                if ($saveBtn.length) $saveBtn.prop('disabled', false);
            }
        }

        // è®¡ç®—å•è¡Œé‡‘é¢
        function calculateRowAmount(rowIndex) {
            const $row = $(`tr[data-row="${rowIndex}"]`);
            if (!$row.length) return 0;

            // hold ç±»å‹ä»ç„¶é‡‘é¢ä¸º 0
            const deliveryType = $row.find('.delivery-type-select').val();
            const isHold = $row.data('is-hold') === 'true' || deliveryType === 'hold';
            if (isHold) {
                $row.find('.amount-input').val('0.00');
                return 0;
            }

            // æ¿æ•° * å•ä»· = åŸ amount
            const rate = parseFloat($row.find('.input-rate').val()) || 0;
            const pallets = parseFloat($row.find('.input-pallets').val()) || 0;
            const baseAmount = rate * pallets;

            // é™„åŠ è´¹
            const surcharges = parseFloat($row.find('.input-surcharge').val()) || 0;

            // æœ€ç»ˆé‡‘é¢ = åŸºç¡€é‡‘é¢ + é™„åŠ è´¹
            const amount = baseAmount + surcharges;

            $row.find('.amount-input').val(amount.toFixed(2));
            return amount;
        }

        // äº‹ä»¶ç›‘å¬ï¼šæ´¾é€ç±»å‹å˜åŒ–
        $(document).on('change', '.delivery-type-select', function() {
            const $select = $(this);
            const rowIndex = $select.data('row');
            const deliveryType = $select.val();
            const $row = $(`tr[data-row="${rowIndex}"]`);
            const isHold = $row.data('is-hold') === 'true';
            
            // æ›´æ–°é«˜äº®çŠ¶æ€
            if (!deliveryType) {
                $select.addClass('highlight-select');
                $row.addClass('row-no-type');
            } else {
                $select.removeClass('highlight-select');
                $row.removeClass('row-no-type');
            }
            
            setupRowInputs(rowIndex, deliveryType, isHold);
            calculateRowAmount(rowIndex);
            calculateTotalAmount();
        });

        // äº‹ä»¶ç›‘å¬ï¼šè¾“å…¥æ¡†å˜åŒ–
        $(document).on('input', '.input-surcharge', function() {
            const $row = $(this).closest('tr');
            const rowIndex = $row.data('row');
            if (typeof rowIndex === 'undefined') return;
            
            // é‡æ–°è®¡ç®—é‡‘é¢ï¼ˆåŸºç¡€é‡‘é¢ + æ–°é™„åŠ è´¹ï¼‰
            calculateRowAmount(rowIndex);
            calculateTotalAmount();
        });

        $(document).on('input', '.input-rate, .input-pallets', function() {
            const $row = $(this).closest('tr');
            const rowIndex = $row.data('row');
            if (typeof rowIndex === 'undefined') return;
            
            // å¦‚æœå•ä»·å’Œæ¿æ•°éƒ½æœ‰å€¼ï¼Œå¯ä»¥å®æ—¶è®¡ç®—æ–°é‡‘é¢
            const rate = parseFloat($row.find('.input-rate').val()) || 0;
            const pallets = parseFloat($row.find('.input-pallets').val()) || 0;
            const surcharges = parseFloat($row.find('.input-surcharge').val()) || 0;
            
            if (rate > 0 && pallets > 0) {
                const newBaseAmount = rate * pallets;
                // æ›´æ–°data-base-amountå±æ€§
                $row.data('base-amount', newBaseAmount);
                // é‡æ–°è®¡ç®—é‡‘é¢
                calculateRowAmount(rowIndex);
                calculateTotalAmount();
            }
        });
        // ç›‘å¬ä»å•è¡Œä¿å­˜è¿”å›æ—¶çš„é‡‘é¢å˜åŒ–
        $(document).on('focus', '.amount-input', function() {
            const $row = $(this).closest('tr');
            const rowIndex = $row.data('row');
            if (typeof rowIndex === 'undefined') return;
            
            $(this).data('previous-value', $(this).val());
        });
        
        $(document).on('blur input', '.amount-input', function() {
            const $row = $(this).closest('tr');
            const rowIndex = $row.data('row');
            if (typeof rowIndex === 'undefined') return;
            
            const previousValue = $(this).data('previous-value') || '';
            const currentValue = $(this).val();
            
            if (previousValue !== currentValue) {
                calculateTotalAmount();
                $(this).data('previous-value', currentValue);
            }
        });

        // åˆå§‹åŒ–æ‰€æœ‰è¡Œ
        $('tbody tr[data-row]').each(function() {
            const rowIndex = $(this).data('row');
            const isHold = $(this).data('is-hold') === 'true';
            const deliveryType = $(this).find('.delivery-type-select').val();
            const $select = $(this).find('.delivery-type-select');
            
            // è®¾ç½®åˆå§‹é«˜äº®çŠ¶æ€
            if (!deliveryType) {
                $select.addClass('highlight-select');
                $(this).addClass('row-no-type');
            }
            
            setupRowInputs(rowIndex, deliveryType, isHold);
            // åˆå§‹è®¡ç®—é‡‘é¢
            calculateRowAmount(rowIndex);
        });

        // è®¡ç®—åˆå§‹æ€»é‡‘é¢
        calculateTotalAmount();
    });

    // ================ ä¿å­˜å•è¡Œ ================
    function saveSingleRow(rowIndex, itemId) {
        const $row = $(`tr[data-row="${rowIndex}"]`);
        if (!$row.length) return;
        
        const deliveryCategory = $row.find('.delivery-type-select').val();
        const rate = $row.find('.input-rate').val();
        const pallets = $row.find('.input-pallets').val();
        const surcharges = $row.find('.input-surcharge').val();
        const amount = $row.find('.amount-input').val();
        const note = $row.find('.input-note').val();
        const poId = $row.data('po') || '';
        const destination = $row.find('.cell-destination').text().trim();
        const cbm = $row.find('.cell-stats').first().find('.stat-value').text().trim();
        const weight = $row.find('.cell-stats').eq(1).find('.stat-value').text().trim();

        // éªŒè¯
        if (!deliveryCategory) {
            alert('è¯·é€‰æ‹©æ´¾é€ç±»å‹ï¼ˆUPSã€æ²ƒå°”ç›æˆ–äºšé©¬é€Šï¼‰');
            $row.find('.delivery-type-select').focus();
            return;
        }
        
        if (deliveryCategory !== 'hold') {
            // å…¬ä»“ï¼šéœ€è¦å¡«å†™å•ä»·å’Œæ¿æ•°
            if (!rate || parseFloat(rate) <= 0) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„å•ä»·ï¼ˆå¿…é¡»å¤§äº0ï¼‰');
                $row.find('.input-rate').focus();
                return;
            }
            
            if (!pallets || parseFloat(pallets) <= 0) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„æ¿æ•°ï¼ˆå¿…é¡»å¤§äº0ï¼‰');
                $row.find('.input-pallets').focus();
                return;
            }
            
            if (!amount || parseFloat(amount) <= 0) {
                alert('é‡‘é¢å¿…é¡»å¤§äº0');
                $row.find('.amount-input').focus();
                return;
            }
        }

        // å¡«å……è¡¨å•
        $('#single-row-index').val(rowIndex);
        $('#single-item-id').val(itemId || $row.data('item-id') || '');
        $('#single-po-id').val(poId);
        $('#single-destination').val(destination);
        $('#single-delivery-category').val(deliveryCategory);
        $('#single-rate').val(rate || '');
        $('#single-pallets').val(pallets || '0');
        $('#single-surcharges').val(surcharges || '0');
        $('#single-amount').val(amount || '0');
        $('#single-note').val(note || '');
        $('#single-cbm').val(cbm || '0');
        $('#single-weight').val(weight || '0');

        // æäº¤è¡¨å•
        $('#single-row-form').submit();
    }

    // ================ è½¬æ¢ç±»å‹ ================
    function convertToCurrentType(poId, item_id, deliveryType) {
        $('#convert-po-id').val(poId);
        $('#convert-item-id').val(item_id);
        $('#to-delivery-type').val(deliveryType);
        $('#convert-form').submit();
    }

    // ================ è§£æ‰£ ================
    function releaseHoldItem(containerNumber, poId, palletIds, rowIndex) {
        // è¿™é‡Œä½¿ç”¨æ¨¡æ€æ¡†ï¼Œä½†ä¸ºäº†ç®€æ´æˆ‘ç®€åŒ–äº†
        // ä½ å¯ä»¥ç”¨å¦ä¸€ä¸ªç‹¬ç«‹çš„formæ¥æäº¤
        if (confirm(`ç¡®å®šè¦è§£é™¤PO ${poId} çš„æš‚æ‰£çŠ¶æ€å—ï¼Ÿ`)) {
            // åˆ›å»ºä¸´æ—¶formæäº¤
            const form = document.createElement('form');
            form.method = 'post';
            form.style.display = 'none';
            
            const csrf = document.createElement('input');
            csrf.type = 'hidden';
            csrf.name = 'csrfmiddlewaretoken';
            csrf.value = document.querySelector('[name=csrfmiddlewaretoken]').value;
            form.appendChild(csrf);
            
            const step = document.createElement('input');
            step.type = 'hidden';
            step.name = 'step';
            step.value = 'release_hold';
            form.appendChild(step);
            
            const container = document.createElement('input');
            container.type = 'hidden';
            container.name = 'container_number';
            container.value = containerNumber;
            form.appendChild(container);
            
            const po = document.createElement('input');
            po.type = 'hidden';
            po.name = 'po_id';
            po.value = poId;
            form.appendChild(po);
            
            const pallets = document.createElement('input');
            pallets.type = 'hidden';
            pallets.name = 'pallet_ids';
            pallets.value = palletIds;
            form.appendChild(pallets);
            
            document.body.appendChild(form);
            form.submit();
        }
    }

    // ================ ä¿å­˜æ‰€æœ‰ç»„åˆæŸœ ================
    function saveAllCombina() {
        // æ”¶é›†æ‰€æœ‰ç»„åˆæŸœæ•°æ®
        const combinaItems = [];
        let hasError = false;
        
        // éå†æ‰€æœ‰ç»„åˆæŸœè¡Œ
        $('.row-combina').each(function() {
            const $row = $(this);
            const itemId = $row.data('item-id') || '';
            const poId = $row.data('po') || '';
            const destination = $row.find('.cell-destination').text().trim();
            const amount = $row.find('.combina-amount-input').val() || '0';
            const note = $row.find('.combina-note-input').val() || '';
            const pallets = $row.find('.input-pallets').val() || '0';
            const cbm = $row.data('cbm') || '0';
            const weight = $row.data('weight') || '0';
            const groupIndex = $row.data('group-index') || '';
            const itemIndex = $row.data('item-index') || '';

            const combinaRegion = $row.data('combina-region') || '';
            const combinaPrice = $row.data('combina-price') || '0';
            const cbmRatio = $row.data('cbm-ratio') || '0';
            // éªŒè¯å¿…å¡«å­—æ®µ
            if (!amount || parseFloat(amount) <= 0) {
                alert(`PO ${poId} çš„é‡‘é¢æ— æ•ˆ`);
                hasError = true;
                return false; // é€€å‡ºå¾ªç¯
            }
            
            combinaItems.push({
                item_id: itemId,
                po_id: poId,
                destination: destination,
                delivery_category: 'combine',
                rate: combinaPrice, // ç»„åˆæŸœæ²¡æœ‰å•ä»·
                pallets: pallets,
                surcharges: '0',
                amount: amount,
                note: note,
                cbm: cbm, // æ–°å¢ï¼šCBM
                weight: weight, // æ–°å¢ï¼šé‡é‡
                group_index: groupIndex,
                item_index: itemIndex,
                combina_region: combinaRegion,
                cbmRatio: cbmRatio,
            });
        });
        
        if (hasError) return;
        
        if (combinaItems.length === 0) {
            alert('æ²¡æœ‰éœ€è¦ä¿å­˜çš„ç»„åˆæŸœæ•°æ®');
            return;
        }
        
        // åˆ›å»ºéšè—è¡¨å•æäº¤
        const form = document.createElement('form');
        form.method = 'post';
        form.style.display = 'none';
        
        const csrf = document.createElement('input');
        csrf.type = 'hidden';
        csrf.name = 'csrfmiddlewaretoken';
        csrf.value = document.querySelector('[name=csrfmiddlewaretoken]').value;
        form.appendChild(csrf);
        
        const step = document.createElement('input');
        step.type = 'hidden';
        step.name = 'step';
        step.value = 'save_all_combina';
        form.appendChild(step);
        
        const container = document.createElement('input');
        container.type = 'hidden';
        container.name = 'container_number';
        container.value = '{{ container_number }}';
        form.appendChild(container);
        
        const invoice = document.createElement('input');
        invoice.type = 'hidden';
        invoice.name = 'invoice_id';
        invoice.value = '{{ invoice_id }}';
        form.appendChild(invoice);
        
        const items = document.createElement('input');
        items.type = 'hidden';
        items.name = 'combina_items';
        items.value = JSON.stringify(combinaItems);
        form.appendChild(items);
        
        const startDate = document.createElement('input');
        startDate.type = 'hidden';
        startDate.name = 'start_date';
        startDate.value = '{{ start_date }}';
        form.appendChild(startDate);
        
        const endDate = document.createElement('input');
        endDate.type = 'hidden';
        endDate.name = 'end_date';
        endDate.value = '{{ end_date }}';
        form.appendChild(endDate);

        document.body.appendChild(form);
        form.submit();
    }
    // ç®€å•æç¤ºå‡½æ•°
    function showToast(msg, type = 'success') {
        // ç®€åŒ–ç‰ˆï¼Œä½ å¯ä»¥ç”¨æ›´å¤æ‚çš„toast
        if (type === 'success') {
            alert('æˆåŠŸï¼š' + msg);
        } else {
            alert('é”™è¯¯ï¼š' + msg);
        }
    }
    // === ä¿å­˜æ•´ä¸ªè´¦å•å‰çš„æœ€ç»ˆå¤„ç† ===
    document.getElementById("save-bill-btn").addEventListener("click", function (event) {
        // é˜»æ­¢é»˜è®¤æäº¤
        event.preventDefault();

        // 1. éªŒè¯æ‰€æœ‰ normal_items æ˜¯å¦é€‰æ‹©æ´¾é€ç±»å‹
        let errorMessages = [];
        let hasError = false;

        // 1. éªŒè¯æ‰€æœ‰ normal_items æ˜¯å¦é€‰æ‹©æ´¾é€ç±»å‹
        $('.normal-table .delivery-type-select').each(function () {
            const val = $(this).val();
            const $row = $(this).closest('tr');
            const poId = $row.data('po') || 'æœªçŸ¥PO';
            
            if (!val) {
                errorMessages.push(`PO ${poId}: è¯·é€‰æ‹©æ´¾é€ç±»å‹`);
                hasError = true;
                $(this).addClass('highlight-select');
            } else {
                $(this).removeClass('highlight-select');
            }
        });

        // 3. éªŒè¯ç»„åˆæŸœé‡‘é¢æ˜¯å¦æœ‰æ•ˆ
        $('.combina-table tbody tr.row-combina').each(function () {
            const $row = $(this);
            const poId = $row.data('po') || "";
            const amount = parseFloat($row.find('.combina-amount-input').val()) || 0;
            
            // ç»„åˆæŸœä¸æ˜¯UPSç±»å‹ï¼Œå¿…é¡»æ£€æŸ¥é‡‘é¢
            if (isNaN(amount)) {
                errorMessages.push(`ç»„åˆæŸœPO ${poId}: é‡‘é¢å¿…é¡»æ˜¯æœ‰æ•ˆæ•°å­—`);
                hasError = true;
                $row.find('.combina-amount-input').css('border-color', 'var(--error-color)');
            } else {
                $row.find('.combina-amount-input').css('border-color', '');
            }
        });
        // 4. éªŒè¯POæ¿€æ´»è´¹é‡‘é¢
        $('.activation-amount-input').each(function() {
            const amount = parseFloat($(this).val()) || 0;
            const $row = $(this).closest('tr');
            const poId = $row.data('po') || 'æœªçŸ¥PO';
            
            if (amount <= 0) {
                errorMessages.push(`æ¿€æ´»è´¹PO ${poId}: é‡‘é¢å¿…é¡»å¤§äº0`);
                hasError = true;
                $(this).css('border-color', 'var(--error-color)');
            } else {
                $(this).css('border-color', '');
            }
        });

        if (hasError) {
            // æ˜¾ç¤ºæ‰€æœ‰é”™è¯¯ä¿¡æ¯
            const errorHtml = errorMessages.map(msg => `<div style="margin-bottom: 8px;">â€¢ ${msg}</div>`).join('');
            showToast('éªŒè¯é”™è¯¯', errorHtml, 'error');
            return;
        }

        // 2. æ”¶é›†æ‰€æœ‰æ•°æ®
        const allItems = [];
        // 2.1 æ”¶é›†è½¬è¿è®¡è´¹è¡¨æ ¼æ•°æ®
        $('table.normal-table tbody tr').each(function () {
            const rowIndex = $(this).data('row');
            const $row = $(this);
        
            // è·å–CBMå’Œé‡é‡
            const cbm = $row.find('.cell-stats').first().find('.stat-value').text().trim() || "0";
            const weight = $row.find('.cell-stats').eq(1).find('.stat-value').text().trim() || "0";
            allItems.push({
                rowIndex: rowIndex,
                item_id: $(this).data('item-id') || "",
                po_id: $(this).data('po') || "",
                shipping_marks: "",
                destination: $(this).find('.cell-destination').text().trim(),
                delivery_category: $(this).find('.delivery-type-select').val(),
                rate: $(this).find(`input[name="rate_${rowIndex}"]`).val() || "",
                pallets: $(this).find(`input[name="pallets_${rowIndex}"]`).val() || "0",
                surcharges: $(this).find(`input[name="surcharges_${rowIndex}"]`).val() || "0",
                amount: $(this).find(`input[name="amount_${rowIndex}"]`).val() || "0.00",
                note: $(this).find(`input[name="note_${rowIndex}"]`).val() || "",
                cbm: cbm, // æ–°å¢ï¼šCBM
                weight: weight, // æ–°å¢ï¼šé‡é‡
            });
        });

        // 2.2 æ”¶é›†ç»„åˆæŸœè¡¨æ ¼æ•°æ®
        $('.combina-table tbody tr.row-combina').each(function (index) {
            const $row = $(this);
            const rowIdParts = $row.data('row').split('_');
            const groupIndex = rowIdParts[0] || "0";
            const itemIndex = rowIdParts[1] || "0";
            const combinaRegion = $row.data('combina-region') || '';
            const combinaPrice = $row.data('combina-price') || '0';
            const cbm = $row.data('cbm') || '0';
            const cbmRatio = $row.data('cbm-ratio') || '0';
            const weight = $row.data('weight') || '0';
            
            // ç»„åˆæŸœçš„æ•°æ®ç»“æ„
            const combinaItem = {
                rowIndex: allItems.length, // ç»­æ¥åœ¨è½¬è¿æ•°æ®åé¢
                item_id: $row.data('item-id') || "",
                po_id: $row.data('po') || "",
                shipping_marks: "",
                destination: $row.find('.cell-destination').text().trim(),
                delivery_category: "combine", // å›ºå®šä¸ºcombine
                rate: combinaPrice, // ç»„åˆæŸœæ²¡æœ‰å•ä»·å­—æ®µï¼Œä¼ 0æˆ–ç©º
                pallets: $row.find('.input-pallets').val() || "0",
                surcharges: "0", // ç»„åˆæŸœæ²¡æœ‰é™„åŠ è´¹
                amount: $row.find('.combina-amount-input').val() || "0.00",
                note: $row.find('.combina-note-input').val() || "",
                // é¢å¤–ä¿¡æ¯ï¼ˆå¦‚æœéœ€è¦å¯ä»¥ä¼ ç»™åå°ï¼‰
                combina_group: groupIndex,
                combina_item: itemIndex,
                combina_region: combinaRegion,
                cbm: cbm, 
                weight: weight, 
                cbmRatio: cbmRatio,
            };
            
            allItems.push(combinaItem);
        });
        
        // 2.3 æ”¶é›†POæ¿€æ´»è´¹æ•°æ®ï¼ˆæ–°å¢éƒ¨åˆ†ï¼‰
        const activationData = [];
        let activationHasError = false;
        
        $('.activation-amount-input').each(function() {
            const index = $(this).data('index');
            const amount = parseFloat($(this).val()) || 0;
            const note = $(`input[name="activation_note_${index}"]`).val() || '';
            const item = activationItems[index];
            
            // éªŒè¯
            if (amount <= 0) {
                showToast(`PO ${item.po_id} çš„æ¿€æ´»è´¹å¿…é¡»å¤§äº0`, 'error');
                hasError = true;
                return false;
            }
            
            activationData.push({
                po_id: item.po_id,
                destination: item.destination,
                cbm: item.cbm,
                weight: item.weight,
                pallet: item.pallet,
                amount: amount,
                note: note,
                item_id: item.id || '',  // å¦‚æœæœ‰å·²å­˜åœ¨çš„è®°å½•
            });
        });

        // 3. éªŒè¯ç»„åˆæŸœé‡‘é¢æ˜¯å¦æœ‰æ•ˆ
        let combinaHasError = false;
        let combinaErrorMsg = "";
        
        $('.combina-table tbody tr.row-combina').each(function () {
            const $row = $(this);
            const poId = $row.data('po') || "";
            const amount = parseFloat($row.find('.combina-amount-input').val()) || 0;
            
            if (amount <= 0) {
                combinaHasError = true;
                combinaErrorMsg = `ç»„åˆæŸœPO ${poId} çš„é‡‘é¢å¿…é¡»å¤§äº0`;
                return false; // é€€å‡ºå¾ªç¯
            }
        });
        
        if (combinaHasError) {
            showToast(combinaErrorMsg, "danger");
            return;
        }

        // 4. è½¬æ¢ä¸ºJSONå­—ç¬¦ä¸²
        const itemsDataJson = JSON.stringify(allItems);

        // 5. åˆ›å»ºæˆ–æ›´æ–°hidden input
        // 5.1 è½¬è¿å’Œç»„åˆæŸœæ•°æ®
        let hidden = document.querySelector('input[name="items_data"]');
        if (!hidden) {
            hidden = document.createElement("input");
            hidden.type = "hidden";
            hidden.name = "items_data";
            document.getElementById("delivery-billing-form").appendChild(hidden);
        }
        hidden.value = itemsDataJson;

        let hidden1 = document.querySelector('input[name="activation_fee_data"]');
        if (!hidden1) {
            hidden1 = document.createElement("input");
            hidden1.type = "hidden";
            hidden1.name = "activation_fee_data";
            document.getElementById("delivery-billing-form").appendChild(hidden1);
        }
        activationJson = JSON.stringify(activationData);
        hidden1.value = activationJson;

        // 6. è®¾ç½®stepå€¼
        let stepInput = document.querySelector('input[name="step"]');
        if (!stepInput) {
            stepInput = document.createElement("input");
            stepInput.type = "hidden";
            stepInput.name = "step";
            document.getElementById('delivery-billing-form').appendChild(stepInput);
        }
        stepInput.value = "save_all";

        // 7. æäº¤å‰ç¡®è®¤
        const totalItems = allItems.length;
        const normalCount = $('table.normal-table tbody tr').length;
        const combinaCount = $('.combina-table tbody tr.row-combina').length;
        const activationCount = activationData.length;
        
        const confirmMsg = `ç¡®è®¤ä¿å­˜è´¦å•å—ï¼Ÿ\n` +
                        `åŒ…å«æ•°æ®ï¼š\n` +
                        `- è½¬è¿è®¡è´¹ï¼š${normalCount} æ¡\n` +
                        `- ç»„åˆæŸœè®¡è´¹ï¼š${combinaCount} æ¡\n` +
                        `- POæ¿€æ´»è´¹ï¼š${activationCount} æ¡\n` +
                        `æ€»è®¡ï¼š${totalItems} æ¡è®°å½•+ ${activationCount} æ¡æ¿€æ´»è´¹è®°å½•`;
        
        if (confirm(confirmMsg)) {
            // 8. æäº¤è¡¨å•
            document.getElementById('delivery-billing-form').submit();
        }

    });
    function setOrderType(orderType) {
        document.getElementById('new_order_type').value = orderType;
    }
    function openRulesModal() {
        document.getElementById("rules-modal").style.display = "flex";
    }

    function closeRulesModal() {
        document.getElementById("rules-modal").style.display = "none";
    }

    // æ‰“å¼€é€‰æ‹©æ¨¡æ€æ¡†
    function openActivationModal() {
        // æ¯æ¬¡æ‰“å¼€æ—¶é‡ç½®çŠ¶æ€
        resetActivationModal();

        const modal = new bootstrap.Modal(document.getElementById('activationModal'));
        modal.show();
    }

    // å…¨é€‰/å–æ¶ˆå…¨é€‰
    $('#select-all-activation').on('change', function() {
        const isChecked = $(this).prop('checked');
        $('.activation-po-checkbox').prop('checked', isChecked);
    });
    // æ·»åŠ é€‰ä¸­çš„POæ¿€æ´»è´¹
    function addSelectedActivationItems() {
        const selectedItems = [];
        
        $('.activation-po-checkbox:checked').each(function() {
            const poId = $(this).val();
            const destination = $(this).data('destination');
            const cbm = $(this).data('cbm');
            const weight = $(this).data('weight');
            const pallet = $(this).closest('tr').find('td:nth-child(5)').text().trim();
            const palletValue = parseFloat(pallet) || 0;
            
            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
            if (!activationItems.some(item => item.po_id === poId)) {
                selectedItems.push({
                    po_id: poId,
                    destination: destination,
                    cbm: cbm,
                    weight: weight,
                    pallet: palletValue,
                    amount: '',
                    note: '',
                    is_existing: false
                });
            }
        });
        
        if (selectedItems.length === 0) {
            showToast('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªPO', 'error');
            return;
        }
        
        // æ·»åŠ åˆ°ç°æœ‰åˆ—è¡¨
        activationItems.push(...selectedItems);
        
        // æ›´æ–°è¡¨æ ¼æ˜¾ç¤º
        updateActivationTable();
        
        // å…³é—­æ¨¡æ€æ¡†
        const modal = bootstrap.Modal.getInstance(document.getElementById('activationModal'));
        modal.hide();
    }

    // æ›´æ–°æ¿€æ´»è´¹è¡¨æ ¼æ˜¾ç¤º
    function updateActivationTable() {
        const $tbody = $('#activation-fee-tbody');
        $tbody.empty();
        
        if (activationItems.length === 0) {
            $tbody.append(`
                <tr id="no-activation-row">
                    <td colspan="8" style="text-align: center; padding: 40px 20px; color: var(--text-secondary);">
                        <i class="fas fa-bolt" style="font-size: 2.5rem; margin-bottom: 15px; color: #e0e0e0;"></i>
                        <p>æš‚æ— POæ¿€æ´»è´¹è®°å½•</p>
                    </td>
                </tr>
            `);
            return;
        }
        
        activationItems.forEach((item, index) => {
            const row = `
                <tr data-activation-index="${index}" data-po="${item.po_id}">
                    <td class="cell-po">${item.po_id}</td>
                    <td>${item.destination || '-'}</td>
                    <td>${parseFloat(item.cbm || 0).toFixed(2)}</td>
                    <td>${parseFloat(item.weight || 0).toFixed(2)}</td>
                    <td>${parseFloat(item.pallet || 0).toFixed(2)}</td>
                    <td>
                        <input type="number" 
                            name="activation_amount_${index}"
                            class="input-control input-amount activation-amount-input"
                            value="${item.amount || ''}"
                            step="0.01" min="0"
                            data-index="${index}"
                            placeholder="0.00">
                    </td>
                    <td>
                        <input type="text" 
                            name="activation_note_${index}"
                            class="input-control input-note"
                            value="${item.note || ''}"
                            placeholder="å¤‡æ³¨"
                            data-index="${index}">
                    </td>
                    <td class="cell-status">
                        ${item.is_existing ? 
                            '<span class="status-indicator existing">å·²å½•</span>' : 
                            '<span class="status-indicator">æœªå½•</span>'}
                    </td>
                    <td class="cell-action">
                        <button type="button" class="action-btn btn-danger" onclick="removeActivationItem('${item.po_id}')">
                            <i class="fas fa-trash"></i>ç§»é™¤
                        </button>
                    </td>
                </tr>
            `;
            $tbody.append(row);
        });
    }

    // ç§»é™¤æ¿€æ´»è´¹é¡¹ç›®
    function removeActivationItem(poId) {
        if (!confirm(`ç¡®å®šè¦ç§»é™¤PO ${poId} çš„æ¿€æ´»è´¹å—ï¼Ÿ`)) return;
        
        activationItems = activationItems.filter(item => item.po_id !== poId);
        updateActivationTable();
        calculateTotalAmount(); // é‡æ–°è®¡ç®—æ€»é‡‘é¢
    }

    // ä¿å­˜æ‰€æœ‰POæ¿€æ´»è´¹
    function saveAllActivationFees() {
        // æ”¶é›†æ‰€æœ‰æ¿€æ´»è´¹æ•°æ®
        const activationData = [];
        let hasError = false;
        
        $('.activation-amount-input').each(function() {
            const index = $(this).data('index');
            const amount = parseFloat($(this).val()) || 0;
            const note = $(`input[name="activation_note_${index}"]`).val() || '';
            const item = activationItems[index];
            
            // éªŒè¯
            if (amount <= 0) {
                showToast(`PO ${item.po_id} çš„æ¿€æ´»è´¹å¿…é¡»å¤§äº0`, 'error');
                hasError = true;
                return false;
            }
            
            activationData.push({
                po_id: item.po_id,
                destination: item.destination,
                cbm: item.cbm,
                weight: item.weight,
                pallet: item.pallet,
                amount: amount,
                note: note,
                item_id: item.id || '',  // å¦‚æœæœ‰å·²å­˜åœ¨çš„è®°å½•
            });
        });
        
        if (hasError) return;
        
        if (activationData.length === 0) {
            showToast('æ²¡æœ‰POæ¿€æ´»è´¹æ•°æ®', 'error');
            return;
        }
        
        // åˆ›å»ºè¡¨å•æäº¤
        const form = document.createElement('form');
        form.method = 'post';
        form.style.display = 'none';
        
        const csrf = document.createElement('input');
        csrf.type = 'hidden';
        csrf.name = 'csrfmiddlewaretoken';
        csrf.value = document.querySelector('[name=csrfmiddlewaretoken]').value;
        form.appendChild(csrf);
        
        const step = document.createElement('input');
        step.type = 'hidden';
        step.name = 'step';
        step.value = 'save_activation_fees';
        form.appendChild(step);
        
        const container = document.createElement('input');
        container.type = 'hidden';
        container.name = 'container_number';
        container.value = '{{ container_number }}';
        form.appendChild(container);
        
        const invoice = document.createElement('input');
        invoice.type = 'hidden';
        invoice.name = 'invoice_id';
        invoice.value = '{{ invoice_id }}';
        form.appendChild(invoice);
        
        const dataInput = document.createElement('input');
        dataInput.type = 'hidden';
        dataInput.name = 'activation_fee_data';
        dataInput.value = JSON.stringify(activationData);
        form.appendChild(dataInput);
        
        document.body.appendChild(form);
        form.submit();
    }

    // è®¡ç®—æ¿€æ´»è´¹æ€»é‡‘é¢
    function calculateActivationTotal() {
        let total = 0;
        $('.activation-amount-input').each(function() {
            const amount = parseFloat($(this).val()) || 0;
            total += amount;
        });
        return total;
    }

    // åœ¨é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–æ¿€æ´»è´¹æ•°æ®
    $(document).ready(function() {
        // åˆå§‹åŒ–ä»åç«¯ä¼ æ¥çš„æ¿€æ´»è´¹æ•°æ®
        activationItems = [
            {% for item in activation_fee_groups %}
            {
                id: '{{ item.id }}',
                po_id: '{{ item.PO_ID }}',
                destination: '{{ item.destination }}',
                cbm: {{ item.cbm|default:0 }},
                weight: {{ item.weight|default:0 }},
                pallet: {{ item.pallet|default:0 }},
                amount: '{{ item.amount|default:'' }}',
                note: '{{ item.note|default:'' }}',
                is_existing: {% if item.is_existing %}true{% else %}false{% endif %}
            },
            {% endfor %}
        ];
        
        // ç›‘å¬æ¿€æ´»è´¹é‡‘é¢å˜åŒ–
        $(document).on('input', '.activation-amount-input', function() {
            const index = $(this).data('index');
            const amount = $(this).val();
            if (activationItems[index]) {
                activationItems[index].amount = amount;
            }
            // è‡ªåŠ¨é‡æ–°è®¡ç®—æ€»é‡‘é¢
            calculateTotalAmount();
        });
        
        // ç›‘å¬å¤‡æ³¨å˜åŒ–
        $(document).on('input', 'input[name^="activation_note_"]', function() {
            const index = $(this).data('index');
            const note = $(this).val();
            if (activationItems[index]) {
                activationItems[index].note = note;
            }
        });
        calculateTotalAmount();
    });
    // é‡ç½®æ¿€æ´»è´¹æ¨¡æ€æ¡†çŠ¶æ€
    function resetActivationModal() {
        // å–æ¶ˆå…¨é€‰
        $('#select-all-activation').prop('checked', false);
        
        // è·å–å½“å‰å·²æ·»åŠ çš„PO_IDåˆ—è¡¨
        const currentPoIds = activationItems.map(item => item.po_id);
        
        // é‡ç½®æ‰€æœ‰å¤é€‰æ¡†çŠ¶æ€
        $('.activation-po-checkbox').each(function() {
            const poId = $(this).val();
            // å¦‚æœè¿™ä¸ªPOå·²ç»æ·»åŠ è¿‡äº†ï¼Œå°±ç¦ç”¨å¹¶å–æ¶ˆé€‰ä¸­
            if (currentPoIds.includes(poId)) {
                $(this).prop('checked', false).prop('disabled', true);
                // æ·»åŠ å·²æ·»åŠ æ ‡è®°
                $(this).closest('tr').addClass('already-added');
            } else {
                $(this).prop('checked', false).prop('disabled', false);
                $(this).closest('tr').removeClass('already-added');
            }
        });
    }
</script>
{% endblock %}
