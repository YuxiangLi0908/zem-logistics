{% extends 'base.html' %}
{% load custom_filters %}
{% block content %}
<style>
    .finance-system {
        width: 100%;
        margin: 20px auto;
        background: white;
        border-radius: 12px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
        overflow: hidden;
    }

    :root {
        --primary-color: #1b5e20;
        --secondary-color: #0d3d14;
        --success-color: #2e7d32;
        --warning-color: #ff6f00;
        --danger-color: #b71c1c;
        --light-bg: #f8f9fa;
        --card-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        --border-radius: 12px;
    }

    .finance-header { 
        background: linear-gradient(135deg, #0d3d14, #1b5e20);
        color: white; 
        padding: 25px 30px;
        display: flex; 
        justify-content: space-between; 
        align-items: center; 
    }
    
    .finance-logo {
        display: flex;
        align-items: center;
        font-size: 1.5rem;
        font-weight: bold;
    }

    .finance-logo i {
        margin-right: 12px;
        font-size: 1.8rem;
    }

    .filter-controls {
        display: flex;
        align-items: center;
        justify-content: flex-end;
        gap: 20px;
        background: rgba(255, 255, 255, 0.15);
        padding: 15px 25px;
        border-radius: 10px;
    }

    .filter-group {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .filter-group label {
        font-weight: 600;
        font-size: 0.9rem;
        color: white;
    }

    .filter-controls select,
    .filter-controls input {
        padding: 10px 15px;
        border: none;
        border-radius: 6px;
        background: white;
        font-size: 0.95rem;
        min-width: 150px;
    }
    .status-finished,
    .status-completed {
        background: linear-gradient(135deg, #f6ffed, #d9f7be);
        color: #389e0d;
        border: 1px solid #b7eb8f;
    }

    .status-unrecorded,
    .status-unstarted {
        background: #f5f5f5;
        color: #8c8c8c;
        border: 1px solid #d9d9d9;
    }

    .status-rejected {
        background: #fff1f0;
        color: #cf1322;
        border: 1px solid #ffa39e;
    }
    .btn-filter {
        padding: 10px 20px;
        background: var(--success-color);
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s ease;
    }

    .btn-filter:hover {
        background: #219652;
        transform: translateY(-1px);
    }

    .finance-main {
        padding: 25px;
    }

    .table-container {
        overflow-x: auto;
        background: white;
        border-radius: var(--border-radius);
        box-shadow: var(--card-shadow);
        border: 1px solid #f0f0f0;
        max-height: 700px;
    }
    #invoice-table {
        font-size: 16px;            /* 原来 12~13，整体抬一档 */
    }

    /* 表头 */
    #invoice-table .th {
        font-size: 18px;
        padding: 16px 10px;         /* 增加呼吸感 */
    }

    /* 单元格 */
    #invoice-table .td {
        font-size: 16px;
        padding: 14px 10px;
    }

    #invoice-table thead tr:nth-child(2) .th {
        text-align: center;
    }

    .status-badge {
        font-size: 13px;
        padding: 4px 10px;
        font-weight: 600;
    }
    .status-badge[data-status="已完成"] {
        background: linear-gradient(135deg, #f6ffed, #d9f7be);
        color: #389e0d;
        border: 1px solid #b7eb8f;
    }

    /* 未录入 */
    .status-badge[data-status="未录入"],
    .status-badge[data-status="未开始"] {
        background: #f5f5f5;
        color: #8c8c8c;
        border: 1px solid #d9d9d9;
    }

    /* 已驳回 */
    .status-badge[data-status="已驳回"] {
        background: #fff1f0;
        color: #cf1322;
        border: 1px solid #ffa39e;
    }
    .status-badge[data-status="待确认"] {
        background: #f5f5f5;   /* 灰色背景 */
        color: #8c8c8c;        /* 灰色文字 */
        border: 1px solid #d9d9d9;
    }
    .status-label {
        font-size: 12px;
    }

    .amount-cell {
        font-size: 15px;
    }

    .amount-cell strong {
        font-size: 16px;
    }


    .cost-type {
        font-size: 13px;
    }

    .cost-amount {
        font-weight: 600;
        color: #1890ff;
        font-size: 14px;  
        text-align: center; 
        display: block;
    }


    .container-link {
        font-size: 14px;
    }

    .invoice-link,
    .statement-link {
        font-size: 13px;
    }

    #invoice-table tr {
        line-height: 1.45;
    }
    .table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        background: white;
        min-width: 1400px; 
    }

    .th {
        background: linear-gradient(135deg, #f8f9fa, #e9ecef);
        padding: 14px 8px;
        text-align: left;
        font-weight: 600;
        border-bottom: 2px solid #dee2e6;
        position: sticky;
        top: 0;
        z-index: 10;
        color: var(--secondary-color);
        font-size: 0.9rem;
        border-right: 1px solid #e9ecef;
        white-space: nowrap;
    }

    .th:last-child {
        border-right: none;
    }

    .td {
        padding: 12px 8px;
        border-bottom: 1px solid #f0f0f0;
        vertical-align: middle;
        font-size: 12px;
    }

    /* 合并后的状态样式 */
    .status-combined {
        display: flex;
        flex-direction: column;
        gap: 2px;
    }

    .status-item {
        display: flex;
        align-items: center;
        gap: 4px;
    }

    .status-label {
        font-size: 11px;
        color: #666;
        min-width: 40px;
        text-align: right;
    }

    .status-value {
        font-weight: 500;
        padding: 2px 6px;
        border-radius: 10px;
        font-size: 11px;
        min-width: 70px;
        text-align: center;
        white-space: nowrap;
    }

    /* 合并后的费用样式 */
    .cost-combined {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

    .cost-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 10px;
    }

    .cost-type {
        font-size: 11px;
        color: #666;
    }

    .status-badge {
        display: inline-block;
        padding: 3px 8px;
        border-radius: 10px;
        font-size: 11px;
        font-weight: 500;
        text-align: center;
        white-space: nowrap;
        min-width: 60px;
    }

    .status-unstarted {
        background: #f5f5f5;
        color: #8c8c8c;
        border: 1px solid #d9d9d9;
    }

    .status-in_progress {
        background: #e6f7ff;
        color: #1890ff;
        border: 1px solid #91d5ff;
    }

    .status-pending_review {
        background: #fff7e6;
        color: #fa8c16;
        border: 1px solid #ffd591;
    }

    .status-completed {
        background: #f6ffed;
        color: #52c41a;
        border: 1px solid #b7eb8f;
    }

    .status-rejected {
        background: #fff1f0;
        color: #f5222d;
        border: 1px solid #ffa39e;
    }

    .status-tobeconfirmed {
        background: #f0f8ff;
        color: #096dd9;
        border: 1px solid #69c0ff;
    }

    /* 金额样式 */
    .amount-cell {
        font-weight: 600;
        text-align: right;
    }

    .amount-total {
        color: var(--primary-color);
    }

    .amount-section {
        color: #096dd9;
    }

    .amount-zero {
        color: #8c8c8c;
        font-weight: normal;
    }

    /* 链接样式 */
    .container-link {
        color: #1890ff;
        text-decoration: none;
        font-weight: 500;
        transition: color 0.3s ease;
    }

    .container-link:hover {
        color: #096dd9;
        text-decoration: underline;
    }

    .invoice-link {
        color: #52c41a;
        text-decoration: none;
    }

    .invoice-link:hover {
        text-decoration: underline;
    }

    .statement-link {
        color: #722ed1;
        text-decoration: none;
    }

    .statement-link:hover {
        text-decoration: underline;
    }

    /* 行样式 */
    .no-invoice-row {
        background-color: #fff7e6 !important;
        border-left: 3px solid #ffd591;
    }

    .has-unrecorded-po {
        background-color: #fff1f0 !important;
        border-left: 3px solid #ffa39e;
    }

    tr:hover {
        background-color: #fafafa !important;
    }

    /* 空状态 */
    .empty-state {
        text-align: center;
        padding: 40px;
        color: #8c8c8c;
        font-size: 14px;
    }

    /* PO徽章 */
    .po-badge {
        display: inline-block;
        padding: 2px 6px;
        background: #f0f8ff;
        border: 1px solid #91d5ff;
        border-radius: 10px;
        font-size: 11px;
        color: #096dd9;
        margin-right: 4px;
        margin-bottom: 4px;
    }

    /* 响应式调整 */
    @media (max-width: 1600px) {
        .finance-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 20px;
        }
        
        .filter-controls {
            flex-wrap: wrap;
            width: 100%;
        }
    }

    @media (max-width: 1200px) {
        .table-container {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .table {
            min-width: 1200px;
        }
    }

    /* 表头分组样式 - 新增 */
    .header-group {
        background: linear-gradient(135deg, #e6f7ff, #bae7ff);
        border-bottom: 2px solid #91d5ff;
        color: #096dd9;
        font-weight: bold;
        text-align: center;
    }

    /* 费用总计样式 */
    .cost-total {
        background: linear-gradient(135deg, #f6ffed, #d9f7be);
        border-top: 1px solid #b7eb8f;
        font-weight: bold;
        color: var(--primary-color);
    }
</style>

<div class="finance-system">
    <form method="post" action="" class="warehouse-selector">
        {% csrf_token %}
        <div class="finance-header">
            <div class="finance-logo">
                <i class="fas fa-file-invoice-dollar"></i>
                <span>应收账单手动编辑</span>
            </div>       
            <div class="filter-controls">
                <div class="filter-group" style="position: relative;">
                    <label>柜号：</label>
                    <input type="text" name="container_number" 
                        value="{{ container_number|default:'' }}"
                        placeholder="输入柜号（可选）"
                        style="width: 180px; padding-right: 30px;"
                        title="输入柜号时，仓点和时间筛选将自动忽略">
                    <i class="fas fa-info-circle" 
                    style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); color: #999; font-size: 14px; cursor: help;"
                    title="输入柜号时，仓点和时间筛选将自动忽略"></i>
                </div>
                <div class="filter-group">
                    <label>客户：</label>
                    {{ order_form.customer_name }}
                </div>
                <div class="filter-group">
                    <label>ETD时间：</label>
                    <input type="date" name="start_date_confirm" value="{{ start_date|default:'' }}">
                    <span style="color: white; margin: 0 5px;">至</span>
                    <input type="date" name="end_date_confirm" value="{{ end_date|default:'' }}">
                </div>
                <div class="filter-group">
                    <label>仓点区域：</label>
                    <select name="warehouse_filter">
                        {% for k, v in warehouse_options.items %}
                            <option value="{{ v }}" {% if warehouse_filter == v %}selected{% endif %}>{{ k }}</option>
                        {% endfor %}
                    </select>
                </div>
                <input type="hidden" name="step" value="manual_process_search">
                <button type="submit" class="btn-filter">
                    <i class="fas fa-search"></i> 查询
                </button>
            </div>      
        </div>
    </form>


    <div class="table-container">
        <table class="table" id="invoice-table">
            <thead>
                <tr>
                    <th class="th" rowspan="2">客户</th>
                    <th class="th" rowspan="2">柜号</th>
                    <th class="th" rowspan="2">订单类型</th>
                    <th class="th" rowspan="2">仓库</th>
                    <th class="th" rowspan="2">Invoice #</th>

                    <!-- 应收合计放这里 -->
                    <th class="th" rowspan="2">应收合计</th>

                    <!-- 操作状态 -->
                    <th class="th" colspan="4" style="text-align:center;">操作状态</th>

                    <!-- 费用详情 -->
                    <th class="th" colspan="4" style="text-align:center;">费用详情</th>
                </tr>
                <tr>
                    <th class="th sub-header">港前</th>
                    <th class="th sub-header">库内</th>
                    <th class="th sub-header">派送</th>
                    <th class="th sub-header">财务</th>

                    <th class="th sub-header">港前费用</th>
                    <th class="th sub-header">仓库费用</th>
                    <th class="th sub-header">派送费用</th>
                    <th class="th sub-header">直送费用</th>
                </tr>
            </thead>

            <tbody>
            {% for r in rows %}
                <tr>
                    <!-- 基础信息 -->
                    <td class="td">{{ r.customer_name }}</td>

                    <td class="td">
                        <a class="container-link"
                        href="/receivable_accounting/?step=invoice_manual
                        &container_number={{ r.container_number }}
                        &invoice_id={{ r.invoice_id }}">
                            {{ r.container_number }}
                        </a>
                    </td>

                    <td class="td">{{ r.order_type }}</td>
                    <td class="td">{{ r.warehouse|default_if_none:"" }}</td>
                    <td class="td">{{ r.invoice_number }}</td>

                    <!-- 应收合计 -->
                    <td class="td amount-cell">
                        <strong style="color: var(--primary-color);">
                            ${{ r.receivable_total_amount|floatformat:2 }}
                        </strong>
                    </td>

                    <!-- 操作状态：港前 -->
                    <td class="td">
                        <span class="status-badge" data-status="{{ r.preport_status }}">
                            {{ r.preport_status }}
                        </span>
                    </td>

                    <!-- 操作状态：仓库内 -->
                    <td class="td">
                        <div class="status-combined">
                            <div class="status-item">
                                <span class="status-label">公：</span>
                                <span class="status-badge"
                                    data-status="{{ r.warehouse_public_status }}">
                                    {{ r.warehouse_public_status }}
                                </span>
                            </div>
                            <div class="status-item">
                                <span class="status-label">私：</span>
                                <span class="status-badge"
                                    data-status="{{ r.warehouse_other_status }}">
                                    {{ r.warehouse_other_status }}
                                </span>
                            </div>
                        </div>
                    </td>

                    <!-- 操作状态：派送 -->
                    <td class="td">
                        <div class="status-combined">
                            <div class="status-item">
                                <span class="status-label">公：</span>
                                <span class="status-badge"
                                    data-status="{{ r.delivery_public_status }}">
                                    {{ r.delivery_public_status }}
                                </span>
                            </div>
                            <div class="status-item">
                                <span class="status-label">私：</span>
                                <span class="status-badge"
                                    data-status="{{ r.delivery_other_status }}">
                                    {{ r.delivery_other_status }}
                                </span>
                            </div>
                        </div>
                    </td>

                    <!-- 操作状态：财务 -->
                    <td class="td">
                        <span class="status-badge" data-status="{{ r.finance_status }}">
                            {{ r.finance_status }}
                        </span>
                    </td>

                    <!-- 港前费用 -->
                    <td class="cost-amount">  
                        ${{ r.receivable_preport_amount|floatformat:2 }}                       
                    </td>

                    <!-- 仓库费用（无合计） -->
                    <td class="td cost-column">
                        <div class="cost-combined">
                            <div class="cost-item">
                                <span class="cost-type">公仓：</span>
                                <span class="cost-amount">
                                    ${{ r.receivable_wh_public_amount|floatformat:2 }}
                                </span>
                            </div>
                            <div class="cost-item">
                                <span class="cost-type">私仓：</span>
                                <span class="cost-amount">
                                    ${{ r.receivable_wh_other_amount|floatformat:2 }}
                                </span>
                            </div>
                        </div>
                    </td>

                    <!-- 派送费用（无合计） -->
                    <td class="td cost-column">
                        <div class="cost-combined">
                            <div class="cost-item">
                                <span class="cost-type">公派：</span>
                                <span class="cost-amount">
                                    ${{ r.receivable_delivery_public_amount|floatformat:2 }}
                                </span>
                            </div>
                            <div class="cost-item">
                                <span class="cost-type">私派：</span>
                                <span class="cost-amount">
                                    ${{ r.receivable_delivery_other_amount|floatformat:2 }}
                                </span>
                            </div>
                        </div>
                    </td>

                    <!-- 直送费用 -->
                    <td class="cost-amount">
                        ${{ r.receivable_direct_amount|floatformat:2 }}
                    </td>
                </tr>
            {% empty %}
                <tr>
                    <td colspan="14" class="td" style="text-align:center;">
                        暂无数据
                    </td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
// 表格筛选函数
function filterTable(input, columnIndex) {
    const table = document.getElementById('invoice-table');
    const filterValue = input.value.toLowerCase();
    const rows = table.getElementsByTagName('tr');
    
    for (let i = 2; i < rows.length; i++) { // 从第2行开始（跳过表头）
        const cells = rows[i].getElementsByTagName('td');
        if (cells.length > columnIndex) {
            const cell = cells[columnIndex];
            const cellText = cell.textContent || cell.innerText;
            
            if (cellText.toLowerCase().indexOf(filterValue) > -1) {
                rows[i].style.display = "";
            } else {
                rows[i].style.display = "none";
            }
        }
    }
}

// 查看发票详情
function viewInvoiceDetails(invoiceId) {
    if (invoiceId) {
        window.open(`/receivable_accounting/?step=invoice_details&invoice_id=${invoiceId}`, '_blank');
    }
}

// 创建发票
function createInvoice(orderId, containerNumber) {
    if (confirm(`确定要为柜号 ${containerNumber} 创建发票吗？`)) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '';
        
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        const csrfInput = document.createElement('input');
        csrfInput.type = 'hidden';
        csrfInput.name = 'csrfmiddlewaretoken';
        csrfInput.value = csrfToken;
        form.appendChild(csrfInput);
        
        const stepInput = document.createElement('input');
        stepInput.type = 'hidden';
        stepInput.name = 'step';
        stepInput.value = 'create_invoice';
        form.appendChild(stepInput);
        
        const orderIdInput = document.createElement('input');
        orderIdInput.type = 'hidden';
        orderIdInput.name = 'order_id';
        orderIdInput.value = orderId;
        form.appendChild(orderIdInput);
        
        const containerInput = document.createElement('input');
        containerInput.type = 'hidden';
        containerInput.name = 'container_number';
        containerInput.value = containerNumber;
        form.appendChild(containerInput);
        
        document.body.appendChild(form);
        form.submit();
    }
}

// 发送通知
function sendNotification(invoiceId) {
    if (confirm('确定要发送发票通知吗？')) {
        // 这里可以添加发送通知的AJAX请求
        alert('通知发送功能待实现');
    }
}

// 重新发送通知
function resendNotification(invoiceId) {
    if (confirm('确定要重新发送发票通知吗？')) {
        // 这里可以添加重新发送通知的AJAX请求
        alert('重新发送通知功能待实现');
    }
}

// 页面加载完成后初始化
document.addEventListener('DOMContentLoaded', function() {
    // 如果URL中有柜号参数，自动填入搜索框
    const urlParams = new URLSearchParams(window.location.search);
    const containerNumber = urlParams.get('container_number');
    if (containerNumber) {
        const containerInput = document.querySelector('input[name="container_number"]');
        if (containerInput) {
            containerInput.value = containerNumber;
        }
    }
    
    // 高亮有未记录PO的行
    const unrecordedRows = document.querySelectorAll('.has-unrecorded-po');
    unrecordedRows.forEach(row => {
        row.addEventListener('mouseenter', function() {
            this.style.backgroundColor = '#fff2f0';
        });
        row.addEventListener('mouseleave', function() {
            this.style.backgroundColor = '#fff1f0';
        });
    });
});
</script>

{% endblock %}