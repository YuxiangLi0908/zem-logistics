{% extends 'base.html' %}
{% load static %}
{% load custom_filters %}

{% block content %}
<style>
    /* 复用港前账单的样式，可以稍作调整 */
    :root {
        --primary-color: #166534;
        --secondary-color: #0f3e1e;
        --success-color: #15803d;
        --warning-color: #ea580c;
        --danger-color: #b91c1c;
        --light-bg: #f1f5f9;
        --text-dark: #0f172a;
        --radius: 14px;
        --shadow-strong: 0 10px 40px rgba(0,0,0,0.12);
        --shadow-soft: 0 4px 18px rgba(0,0,0,0.06);

        --page-padding: 40px;
        --content-max-width: 1800px;
        --font-large: 1.1rem;
        --font-xl: 1.4rem;
         --scale-factor: 0.8;
    }
    
    body {
        background: #eef2f7;
        padding: var(--page-padding);
        font-size: var(--font-large);
    }
    
    .invoice-container {
        zoom: 0.8; 
        width: 100%;
        max-width: var(--content-max-width);
        margin: auto;
        background: white;
        border-radius: var(--radius);
        box-shadow: var(--shadow-strong);
        overflow: hidden;
    }

    .invoice-header {
        background: linear-gradient(135deg, #0f3e1e, #166534);
        padding: 40px 50px;
        color: white;
    }

    .header-main {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
    }

    .header-title {
        font-size: 2.4rem;
        font-weight: 700;
        letter-spacing: 1px;
    }

    .header-badges {
        margin-top: 12px;
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
    }
    
    .badge {
        display: flex; 
        padding: 8px 18px;
        font-size: 1rem;
        background: rgba(255,255,255,0.18);
        border-radius: 999px;
        backdrop-filter: blur(4px);
        align-items: center;
    }
    
    .delivery-type-badge {
        background: linear-gradient(to right, #d4380d, #ff7a45);
        display: flex; 
        color: white;
        padding: 6px 16px;
        border-radius: 20px;
        font-weight: 600;
        font-size: 1rem;
        align-items: center;
    }

    .invoice-content {
        padding: 40px 50px;
    }

    .fee-section {
        margin-bottom: 30px;
    }
    
    .amount-zero {
        color: #94a3b8 !important;
        font-style: italic;
        opacity: 0.7;
        font-weight: 400;
    }

    .amount-zero-row .fee-cell:not(:first-child):not(:last-child) {
        opacity: 0.8;
    }
    
    .section-title {
        font-size: 1.8rem;
        margin: 0;
        color: var(--text-dark);
        font-weight: 700;
        border-left: 6px solid var(--primary-color);
        padding-left: 14px;
    }
    
    .fee-section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 25px;
    }
    
    .fee-table {
        width: 100%;
        background: white;
        overflow: hidden;
        border-radius: var(--radius);
        box-shadow: var(--shadow-soft);
        margin-top: 20px;
    }

    .table-header {
        display: grid;
        grid-template-columns: 2.2fr 1.5fr 1.2fr 1.2fr 1.2fr 1.4fr 2fr 80px;
        background: #f8fafc;
        font-size: 1.6rem;
    }

    .table-header-cell {
        padding: 22px 10px;
        font-weight: 700;
        text-align: center;
        color: #000000;
        font-size: 1.3rem;
        border-right: 1px solid #e2e8f0;
    }

    .table-header-cell:last-child {
        border-right: none;
    }

    .fee-row {
        display: grid;
        grid-template-columns: 2.2fr 1.5fr 1.2fr 1.2fr 1.2fr 1.4fr 2fr 80px;
        padding: 8px 0;
        border-bottom: 1px solid #e2e8f0;
        font-size: 1.3rem;
        transition: background 0.15s;
    }
    
    .fee-row:hover {
        background: #f9fafb;
    }

    .fee-cell {
        padding: 14px 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        text-align: center;
        font-size: inherit;
    }

    .fee-name {
        font-weight: 500;
        color: var(--secondary-color);
    }

    .reference-price {
        color: #718096;
        font-size: 1rem;
        text-align: center;
    }
    
    .surcharge-input {
        background-color: #fff8e1 !important;
        border-color: #ffd54f !important;
    }

    .surcharge-input:focus {
        border-color: #ffb300 !important;
        box-shadow: 0 0 0 3px rgba(255, 179, 0, 0.2) !important;
    }

    .input-field {
        padding: 12px 10px;
        font-size: 1.2rem;
        border-radius: 8px;
        border: 1px solid #cbd5e1;
        width: 100%;
    }

    .input-field:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(30, 64, 175, 0.1);
    }

    .amount-display {
        font-size: 1.4rem;
        font-weight: 700;
        color: var(--text-dark);
    }

    .note-input {
        text-align: left !important;
    }

    .remove-btn {
        width: 42px;
        height: 42px;
        font-size: 1.4rem;
        border-radius: 8px;
        background: #dc2626;
        color: white;
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .remove-btn:hover {
        background: #b91c1c;
        transform: scale(1.05);
    }

    .action-buttons {
        margin-top: 40px;
        display: flex;
        flex-wrap: wrap;
        gap: 18px;
        justify-content: center;
    }

    .btn {
        padding: 14px 30px;
        font-size: 1.1rem;
        font-weight: 700;
        border-radius: 10px;
        border: none;
        cursor: pointer;
        box-shadow: var(--shadow-soft);
        transition: all 0.3s ease;
    }

    .btn-primary {
        background: var(--primary-color);
        color: white;
    }

    .btn-primary:hover {
        background: #1d4ed8;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(29, 78, 216, 0.3);
    }

    .btn-success {
        background: var(--success-color);
        color: white;
    }

    .btn-success:hover {
        background: #047857;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(5, 150, 105, 0.3);
    }

    .btn-warning {
        background: var(--warning-color);
        color: white;
    }

    .btn-warning:hover {
        background: #b45309;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(217, 119, 6, 0.3);
    }

    .btn-danger {
        background: var(--danger-color);
        color: white;
    }

    .btn-danger:hover {
        background: #b91c1c;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3);
    }

    .total-section {
        margin-top: 40px;
        padding: 25px;
        border-radius: var(--radius);
        background: #f1f5f9;
        border: 1px solid #e2e8f0;
        text-align: center;
    }

    .total-amount {
        font-size: 2.4rem;
        font-weight: 800;
        color: var(--secondary-color);
    }

    .add-fee-btn {
        background: var(--primary-color);
        color: white;
        border-radius: 10px;
        padding: 12px 26px;
        font-size: 1.05rem;
        font-weight: 700;
        border: none;
        box-shadow: var(--shadow-soft);
        transition: 0.25s;
        margin: 0;
        cursor: pointer;
    }
    
    .add-fee-btn:hover {
        background: #1d4ed8;
        transform: translateY(-2px);
        box-shadow: var(--shadow-strong);
    }
    
    .info-cards-container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 25px;
    }
    
    .quotation-card {
        background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
        border: 1px solid #bae6fd;
        border-radius: var(--radius);
        padding: 20px 25px;
        box-shadow: var(--shadow-soft);
        height: fit-content;
    }
    
    .quotation-title {
        font-size: 1.1rem;
        font-weight: 700;
        color: var(--primary-color);
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .quotation-details {
        font-size: 1rem;
        color: var(--text-dark);
        line-height: 1.5;
    }

    .quotation-highlight {
        color: var(--primary-color);
        font-weight: 600;
    }
    
    .status-card {
        background: linear-gradient(135deg, #f8fff8, #f0f9f0);
        border: 1px solid #d1fae5;
        border-radius: var(--radius);
        padding: 20px 25px;
        box-shadow: var(--shadow-soft);
        height: fit-content;
    }
    
    .status-title {
        font-size: 1.1rem;
        font-weight: 700;
        color: var(--success-color);
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .status-badge {
        padding: 6px 16px;
        border-radius: 20px;
        font-weight: 600;
        font-size: 0.9rem;
        display: inline-block;
    }
    
    .status-completed {
        background: linear-gradient(135deg, #d1fae5, #a7f3d0);
        color: #065f46;
    }
    
    .status-in_progress {
        background: linear-gradient(135deg, #fed7aa, #fdba74);
        color: #92400e;
    }
    
    .status-unstarted {
        background: linear-gradient(135deg, #fecaca, #fca5a5);
        color: #991b1b;
    }
    
    .status-confirmed {
        background: linear-gradient(135deg, #bfdbfe, #93c5fd);
        color: #1e40af;
    }
    
    @media (max-width: 1200px) {
        .info-cards-container {
            grid-template-columns: 1fr;
        }
    }
    
    /* 模态框样式 */
    .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        backdrop-filter: blur(5px);
    }

    .modal-content {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        padding: 30px;
        border-radius: var(--radius);
        width: 90%;
        max-width: 600px;
        max-height: 80vh;
        overflow-y: auto;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
    }

    .modal-title {
        font-size: 1.4rem;
        font-weight: 600;
        margin-bottom: 20px;
        color: var(--secondary-color);
    }

    .fee-option {
        padding: 12px 16px;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        margin-bottom: 10px;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .fee-option:hover {
        border-color: var(--primary-color);
        background: #f0f9ff;
    }

    .fee-option-name {
        font-weight: 500;
        color: var(--secondary-color);
    }

    .fee-option-price {
        color: #718096;
        font-size: 0.9rem;
    }

    .custom-fee-input {
        width: 100%;
        padding: 12px;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        font-size: 1rem;
        margin-top: 15px;
    }
    
    .system-calculated {
        background: #f0f9ff;
        border-left: 4px solid var(--primary-color);
    }

    .system-calculated .fee-cell:first-child {
        color: var(--primary-color);
        font-weight: 600;
    }
</style>

<div class="invoice-container">
    <!-- 头部信息 -->
    <div class="invoice-header">
        <div class="header-main">
            <h1 class="header-title">仓库账单编辑 - {{ container_number }}</h1>
            <div class="header-badges">
                <span class="badge">仓库: {{ warehouse }}</span>
                <span class="delivery-type-badge">
                    {% if delivery_type == 'public' %}
                        <i class="fas fa-warehouse"></i> 公仓
                    {% else %}
                        <i class="fas fa-building"></i> 私仓
                    {% endif %}
                </span>
                <button onclick="window.history.back()" style="background: linear-gradient(135deg, #9ca3af, #6b7280);
                           border: 1px solid rgba(255,255,255,0.3);
                           color: white;
                           padding: 10px 20px;
                           border-radius: 8px;
                           cursor: pointer;
                           display: flex;
                           align-items: center;
                           gap: 8px;
                           transition: all 0.2s ease;">
                    <i class="fas fa-arrow-left"></i>
                    返回
                </button>
            </div>
        </div>
    </div>
    
    <div class="invoice-content">
        <!-- 信息卡片容器 -->
        <div class="info-cards-container">
            <!-- 报价表信息卡片 -->
            <div class="quotation-card">
                <div class="quotation-title">
                    <i class="fas fa-file-invoice-dollar"></i>
                    参考报价表
                </div>
                <div class="quotation-details">
                    <strong>文件:</strong> <span class="quotation-highlight">{{ quotation_info.filename }}</span> 
                    | <strong>版本:</strong> {{ quotation_info.version }}
                    | <strong>生效日期:</strong> {{ quotation_info.effective_date }}
                    {% if quotation_info.is_user_exclusive %}
                    | <strong style="color: #dc2626;">专属用户:</strong> {{ quotation_info.exclusive_user }}
                    {% else %}
                    | <strong style="color: #16a34a;">通用报价</strong>
                    {% endif %}
                </div>
            </div>

            <!-- 状态信息卡片 -->
            <div class="status-card">
                <div class="status-title">
                    <i class="fas fa-info-circle"></i>
                    账单状态
                </div>
                <div class="quotation-details">
                    <strong>当前状态:</strong> 
                    <span class="status-badge 
                        {% if warehouse_status == 'completed' %}status-completed
                        {% elif warehouse_status == 'in_progress' %}status-in_progress
                        {% elif warehouse_status == 'confirmed' %}status-confirmed
                        {% else %}status-unstarted{% endif %}">
                        {% if warehouse_status == 'completed' %}<i class="fas fa-check-circle"></i> 已完成
                        {% elif warehouse_status == 'in_progress' %}<i class="fas fa-spinner"></i> 录入中
                        {% elif warehouse_status == 'confirmed' %}<i class="fas fa-lock"></i> 已确认
                        {% else %}<i class="fas fa-clock"></i> 未开始{% endif %}
                    </span>
                    {% if warehouse_status == 'confirmed' %}
                    <div style="margin-top: 10px; color: #64748b; font-size: 0.9rem;">
                        <i class="fas fa-lock"></i> 账单已确认，不可编辑
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        {% if receivable_is_locked or warehouse_status == 'confirmed' %}
        <div style="background: #ffebee; color: #c62828; padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: center; border: 1px solid #ffcdd2;">
            <i class="fas fa-lock"></i> 账单已确认，不可编辑
        </div>
        {% endif %}

        <form method="post" action="" id="invoice-form">
            {% csrf_token %}
            <!-- 费用项目区域 -->
            <div class="fee-section">
                <div class="fee-section-header">
                    <h3 class="section-title">仓库费用明细</h3>
                    <button type="button" class="add-fee-btn" onclick="showAddFeeModal()">
                        <i class="fas fa-plus-circle"></i>
                        添加费用项目
                    </button>
                </div>
                
                <div class="fee-table">
                    <!-- 表头 -->
                    <div class="table-header">
                        <div class="table-header-cell">费用名称</div>
                        <div class="table-header-cell">参考单价</div>
                        <div class="table-header-cell">实际单价</div>
                        <div class="table-header-cell">数量</div>
                        <div class="table-header-cell">附加费</div>
                        <div class="table-header-cell">总价</div>
                        <div class="table-header-cell">备注</div>
                        <div class="table-header-cell">操作</div>
                    </div>

                    <!-- 费用行 -->
                    <div id="fee-items-container">
                        {% for fee in fee_data %}
                        <div class="fee-row {% if fee.description == '提拆/打托缠膜' and not fee.id %}system-calculated{% endif %}
                            {% if fee.amount == 0 %}amount-zero-row{% endif %}" 
                            data-fee-id="{{ fee.id }}">
                            <input type="hidden" name="fee_id" value="{{ fee.id|default_if_none:'' }}">
                            <input type="hidden" name="fee_description" value="{{ fee.description }}">
                            
                            <div class="fee-cell">
                                <span class="fee-name">{{ fee.description }}</span>
                            </div>
                            
                            <div class="fee-cell">
                                <span class="reference-price">
                                    {{ FS|get_item:fee.description|default:"N/A" }}
                                </span>
                            </div>
                            
                            <div class="fee-cell">
                                <input type="number" class="input-field rate-input" name="fee_rate" 
                                       value="{{ fee.rate }}" step="0.01" min="0"
                                       onchange="calculateFeeTotal(this)">
                            </div>
                            
                            <div class="fee-cell">
                                <input type="number" class="input-field qty-input" name="fee_qty" 
                                       value="{{ fee.qty }}" step="0.1" min="0"
                                       onchange="calculateFeeTotal(this)">
                            </div>
                            
                            <div class="fee-cell">
                                <input type="number" class="input-field surcharge-input" name="fee_surcharges" 
                                       value="{{ fee.surcharges|default:0 }}" step="0.01"
                                       onchange="calculateFeeTotal(this)"
                                       placeholder="附加费">
                            </div>
                            
                            <div class="fee-cell">
                                <span class="amount-display {% if fee.amount == 0 %}amount-zero{% endif %}">{{ fee.amount|floatformat:2 }}</span>
                                <input type="hidden" name="fee_amount" value="{{ fee.amount }}">
                            </div>
                            
                            <div class="fee-cell">
                                <input type="text" class="input-field note-input" name="fee_note" 
                                       value="{{ fee.note }}" placeholder="备注信息">
                            </div>
                            
                            <div class="fee-cell">
                                <button type="button" class="remove-btn" onclick="removeFeeItem(this)">
                                    ×
                                </button>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- 总金额 -->
            <div class="total-section">
                <h3 class="total-amount">
                    <i class="fas fa-dollar-sign"></i>
                    总金额: $<span id="total-amount">0.00</span>
                </h3>
                <input type="hidden" name="total_amount" id="total-amount-input" value="0">
            </div>

            <!-- 隐藏字段 -->
            <input type="hidden" name="step" value="warehouse_save">
            <input type="hidden" name="save_type" id="save_type" value="">
            <input type="hidden" name="container_number" value="{{ container_number }}">
            <input type="hidden" name="invoice_id" value="{{ invoice.id }}">
            <input type="hidden" name="start_date" value="{{ start_date }}">
            <input type="hidden" name="end_date" value="{{ end_date }}">
            <input type="hidden" name="delivery_type" value="{{ delivery_type }}">

            <!-- 操作按钮 -->
            {% if not receivable_is_locked and warehouse_status != 'confirmed' %}
                <div class="action-buttons">
                    {% if "warehouse_public" in groups or "warehouse_other" in groups or "staff" in groups %}
                    <button type="submit" class="btn btn-success" onclick="setSaveType('completed')">
                        <i class="fas fa-check-circle"></i>
                        保存完成
                    </button>
                    <button type="submit" class="btn btn-primary" onclick="setSaveType('in_progress')">
                        <i class="fas fa-save"></i>
                        暂存未完成
                    </button>
                    {% endif %}
                </div>
            {% endif %}
        </form>
    </div>
</div>

<!-- 添加费用模态框 -->
<div id="addFeeModal" class="modal-overlay">
    <div class="modal-content">
        <h3 class="modal-title">选择费用项目</h3>
        
        <div id="standard-fee-list" style="max-height: 300px; overflow-y: auto;">
            {% for fee_item in available_standard_items %}
            <div class="fee-option" data-fee-name="{{ fee_item }}"
                onclick="selectStandardFee('{{ fee_item }}', '{{ FS|get_item:fee_item }}')">
                <span class="fee-option-name">{{ fee_item }}</span>
                <span class="fee-option-price">参考: {{ FS|get_item:fee_item }}</span>
            </div>
            {% empty %}
            <div style="text-align: center; color: #666; padding: 20px;">
                所有标准费用项目已添加
            </div>
            {% endfor %}
        </div>
        
        <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #e2e8f0;">
            <h4 style="margin-bottom: 10px; color: var(--secondary-color);">自定义费用</h4>
            <input type="text" id="custom-fee-name" placeholder="输入自定义费用名称" 
                   class="custom-fee-input">
            <button type="button" class="btn btn-primary" onclick="addCustomFee()" 
                    style="width: 100%; margin-top: 10px;">
                <i class="fas fa-plus-circle"></i>
                添加自定义费用
            </button>
        </div>
        
        <div style="text-align: right; margin-top: 20px;">
            <button type="button" class="btn" onclick="closeAddFeeModal()" 
                    style="background: #78909c; color: white;">
                <i class="fas fa-times"></i>
                取消
            </button>
        </div>
    </div>
</div>

<script>
    // 计算单个费用项目的总价
    function calculateFeeTotal(input) {
        const feeRow = input.closest('.fee-row');
        const rateInput = feeRow.querySelector('.rate-input');
        const qtyInput = feeRow.querySelector('.qty-input');
        const surchargeInput = feeRow.querySelector('.surcharge-input');
        const amountDisplay = feeRow.querySelector('.amount-display');
        const amountInput = feeRow.querySelector('input[name="fee_amount"]');
        
        const rate = parseFloat(rateInput?.value) || 0;
        const qty = parseFloat(qtyInput?.value) || 0;
        const surcharges = parseFloat(surchargeInput?.value) || 0;
        const amount = Math.round((rate * qty + surcharges) * 100) / 100;
        
        if (amountDisplay) {
            amountDisplay.textContent = amount.toFixed(2);
            // 动态切换灰色类
            if (amount === 0) {
                amountDisplay.classList.add('amount-zero');
            } else {
                amountDisplay.classList.remove('amount-zero');
            }
        }
        if (amountInput) amountInput.value = amount;
        
        calculateTotalAmount();
    }
    
    // 计算总金额
    function calculateTotalAmount() {
        let total = 0;
        document.querySelectorAll('input[name="fee_amount"]').forEach(input => {
            total += parseFloat(input.value) || 0;
        });
        
        const formattedTotal = Math.round(total * 100) / 100;
        document.getElementById('total-amount').textContent = formattedTotal.toFixed(2);
        document.getElementById('total-amount-input').value = formattedTotal;
    }
    
    // 移除费用项目
    function removeFeeItem(button) {
        if (confirm('确定要删除这个费用项目吗？')) {
            button.closest('.fee-row').remove();
            calculateTotalAmount();
        }
    }
    
    // 获取所有已存在的费用名称
    function getExistingFeeNames() {
        const existingNames = new Set();
        document.querySelectorAll('input[name="fee_description"]').forEach(input => {
            existingNames.add(input.value.trim());
        });
        return existingNames;
    }
    
    // 检查费用是否已存在
    function isFeeAlreadyAdded(feeName) {
        return getExistingFeeNames().has(feeName.trim());
    }

    // 选择标准费用
    function selectStandardFee(feeName, referencePrice) {
        if (isFeeAlreadyAdded(feeName)) {
            alert('该费用项目已存在，无法重复添加');
            return;
        }
        addFeeItem(feeName, referencePrice);
        closeAddFeeModal();
    }

    // 打开弹框时刷新可选费用列表
    function refreshFeeOptions() {
        const existingItems = Array.from(document.querySelectorAll('input[name="fee_description"]')).map(i => i.value.trim());
        document.querySelectorAll('.fee-option').forEach(option => {
            const feeName = option.dataset.feeName.trim();
            option.style.display = existingItems.includes(feeName) ? 'none' : 'flex';
        });
    }

    // 显示添加费用模态框
    function showAddFeeModal() {
        document.getElementById('addFeeModal').style.display = 'block';
        refreshFeeOptions();
    }

    // 关闭添加费用模态框
    function closeAddFeeModal() {
        document.getElementById('addFeeModal').style.display = 'none';
        document.getElementById('custom-fee-name').value = '';
        refreshFeeOptions();
    }
    
    // 添加自定义费用
    function addCustomFee() {
        const customFeeName = document.getElementById('custom-fee-name').value.trim();
        if (!customFeeName) {
            alert('请输入费用名称');
            return;
        }
        
        if (isFeeAlreadyAdded(customFeeName)) {
            alert('该费用项目已存在，无法重复添加');
            return;
        }
        
        // 检查是否与标准费用项目同名
        const standardFeeItems = [
            "分拣费", "拦截费", "亚马逊PO激活", "客户自提", "重新打板",
            "货品清点费", "仓租", "指定贴标", "内外箱", "托盘标签",
            "开封箱", "销毁", "拍照", "拍视频", "重复操作费"
        ];
        
        if (standardFeeItems.includes(customFeeName)) {
            alert('"' + customFeeName + '" 是标准费用项目，请从标准费用列表中选择添加');
            return;
        }
        
        addFeeItem(customFeeName, 'N/A');
        closeAddFeeModal();
    }
    function extractSingleNumber(str) {
        // 匹配整数或小数（正负都行）
        const matches = str.match(/-?\d+(\.\d+)?/g);

        if (!matches || matches.length !== 1) {
            return 0;   // 没数字或数字太多，都返回 0
        }

        return parseFloat(matches[0]);
    }
    // 添加费用项目到列表
    function addFeeItem(feeName, referencePrice) {
        // 再次检查是否已存在（防止并发添加）
        if (isFeeAlreadyAdded(feeName)) {
            alert('该费用项目已存在');
            return;
        }
        
        const container = document.getElementById('fee-items-container');
        const ref = extractSingleNumber(referencePrice);
        const newRow = document.createElement('div');
        newRow.className = 'fee-row';
        newRow.innerHTML = `
            <input type="hidden" name="fee_id" value="">
            <input type="hidden" name="fee_description" value="${feeName}">
            
            <div class="fee-cell">
                <span class="fee-name">${feeName}</span>
            </div>
            
            <div class="fee-cell">
                <span class="reference-price">${referencePrice}</span>
            </div>
            
            <div class="fee-cell">
                <input type="number" class="input-field rate-input" name="fee_rate" 
                       value="${ref}" step="0.01" min="0"
                       onchange="calculateFeeTotal(this)">
            </div>
            
            <div class="fee-cell">
                <input type="number" class="input-field qty-input" name="fee_qty" 
                       value="1" step="0.1" min="0"
                       onchange="calculateFeeTotal(this)">
            </div>
            
            <div class="fee-cell">
                <input type="number" class="input-field surcharge-input" name="fee_surcharges" 
                       value="0" step="0.01"
                       onchange="calculateFeeTotal(this)"
                       placeholder="附加费">
            </div>
            
            <div class="fee-cell">
                <span class="amount-display">${ref.toFixed(2)}</span>
                <input type="hidden" name="fee_amount" value="${ref}">
            </div>
            
            <div class="fee-cell">
                <input type="text" class="input-field note-input" name="fee_note" 
                       value="" placeholder="备注信息">
            </div>
            
            <div class="fee-cell">
                <button type="button" class="remove-btn" onclick="removeFeeItem(this)">
                    ×
                </button>
            </div>
        `;
        container.appendChild(newRow);
        calculateTotalAmount();
        
        // 添加后刷新可用费用列表
        refreshAvailableFeeOptions();
    }
    // 刷新可用的费用选项
    function refreshAvailableFeeOptions() {
        const existingNames = getExistingFeeNames();
        const allFeeOptions = document.querySelectorAll('.fee-option');
        let hasVisibleOptions = false;
        
        allFeeOptions.forEach(option => {
            const feeName = option.dataset.feeName.trim();
            if (existingNames.has(feeName)) {
                option.style.display = 'none';
            } else {
                option.style.display = 'flex';
                hasVisibleOptions = true;
            }
        });
        
        // 如果没有可用的标准费用选项，显示提示
        const standardFeeList = document.getElementById('standard-fee-list');
        const noItemsMsg = standardFeeList.querySelector('.no-items-msg');
        
        if (!hasVisibleOptions && !noItemsMsg) {
            const msg = document.createElement('div');
            msg.className = 'no-items-msg';
            msg.style.textAlign = 'center';
            msg.style.color = '#666';
            msg.style.padding = '20px';
            msg.textContent = '所有标准费用项目已添加';
            standardFeeList.appendChild(msg);
        } else if (hasVisibleOptions && noItemsMsg) {
            noItemsMsg.remove();
        }
    }
    // 设置保存类型
    function setSaveType(type) {
        document.getElementById('save_type').value = type;
    }
    
    // 初始化计算总金额
    document.addEventListener('DOMContentLoaded', function() {
        calculateTotalAmount();
        
        // 为所有现有的输入框添加事件监听
        const container = document.getElementById('fee-items-container');
        container.addEventListener('input', function(event) {
            if (event.target.classList.contains('rate-input') ||
                event.target.classList.contains('qty-input') ||
                event.target.classList.contains('surcharge-input')) {

                calculateFeeTotal(event.target);
            }
        });
    });
</script>
{% endblock %}