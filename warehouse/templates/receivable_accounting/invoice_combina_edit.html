{% extends 'base.html' %}
{% load custom_filters %}
{% block content %}
<style>
    .invoice-content {
        padding: 20px 0px;
        padding-bottom: 0;
    }
    .info-card {
        background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
        border: 1px solid #bae6fd;
        border-radius: var(--radius);
        padding: 15px 20px;
        border-radius: 12px; 
        box-shadow: var(--shadow-soft);
        height: fit-content;
        margin: 0;
        text-align: left;
    }
    .info-cards-container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 0;
        padding: 0;
        align-items: stretch; 
    }

    .quotation-card {
        background: linear-gradient(135deg, #f8fff8, #f0f9f0);
        border: 1px solid #d1fae5;
        border-radius: var(--radius);
        padding: 15px 20px;
        border-radius: 12px; 
        box-shadow: var(--shadow-soft);
        height: fit-content;
        margin: 0;
        text-align: left;
    }
    .quotation-title, .info-title {
        font-size: 1rem;
        font-weight: 700;
        color: var(--primary-color);
        margin-bottom: 6px;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .quotation-details, .info-details {
        font-size: 0.9rem;
        color: var(--text-dark);
        line-height: 1.4;
    }
    .quotation-details {
        margin-top: 18px;
    }

    .quotation-highlight {
        color: var(--primary-color);
        font-weight: 600;
    }
    .info-highlight {
        color: #0369a1;
        font-weight: 600;
    }
    .btn-change-order-type {
        margin-left: 10px;
        padding: 6px 16px;
        font-size: 0.9rem;
        font-weight: 600;
        border-radius: 6px;
        border: 1px solid transparent;
        cursor: pointer;
        transition: all 0.2s ease;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        background: linear-gradient(135deg, #1e40af, #3b82f6);
        color: white;
        box-shadow: 0 2px 8px rgba(59, 130, 246, 0.2);
    }

    .btn-change-order-type:hover {
        background: linear-gradient(135deg, #1d4ed8, #2563eb);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }

    .btn-change-order-type:active {
        transform: translateY(0);
    }
    
    input[name="actual_non_combina_reason"] {
        margin-left: 10px;
        padding: 8px 12px;
        font-size: 0.9rem;
        border-radius: 6px;
        border: 1px solid #cbd5e1;
        min-width: 200px;
    }

    input[name="actual_non_combina_reason"]:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    .rules-icon {
        cursor: pointer;
        color: #2563eb;   /* è“è‰² */
        font-weight: 600;
        text-decoration: underline; /* åƒé“¾æ¥ */
    }

    .rules-icon:hover {
        color: #1e40af;
    }
    .rules-modal {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.55);
        z-index: 9999;
        justify-content: center;
        align-items: center;
    }

    .rules-content {
        width: 650px;
        background: white;
        padding: 25px 30px;
        border-radius: 12px;
        max-height: 80vh;
        overflow: auto;
    }

    @media (max-width: 1200px) {
        .info-cards-container {
            grid-template-columns: 1fr;
            gap: 15px; 
        }
        
        .quotation-card, .info-card {
            text-align: left;  
        }
    }
</style>
<div id="rules-modal" class="rules-modal">
    <div class="rules-content">
        <h3 class="modal-title">ç»„åˆæŸœè§„åˆ™è¯¦æƒ…</h3>

        <div class="rules-section">
            <div class="section-title">ğŸ“Œ åŸºç¡€è§„åˆ™ï¼ˆGlobal Rulesï¼‰</div>
            <pre class="rules-text">{{ combina_rules_text.global_rules }}</pre>
        </div>

        <div class="divider"></div>

        

        <div class="rules-section">
            <div class="section-title">ğŸ¬ éç»„åˆæŸœææ‹†è®¡è´¹ï¼ˆWarehouse Rulesï¼‰</div>
            <pre class="rules-text">{{ combina_rules_text.warehouse_rules }}</pre>
        </div>
        <div class="divider"></div>

        <div class="rules-section">
            <div class="section-title">âš–ï¸ ç‰¹æ®Šä»“ç‚¹è®¡è´¹ï¼ˆWeight Rulesï¼‰</div>
            <pre class="rules-text">{{ combina_rules_text.special_des_rules }}</pre>
        </div>

        <div class="divider"></div>

        <div class="rules-section">
            <div class="section-title">ğŸ’² è¶…å‡ºä»“ç‚¹é˜¶æ¢¯è®¡è´¹ï¼ˆTiered Pricingï¼‰</div>
            <pre class="rules-text">{{ combina_rules_text.tiered_pricing }}</pre>
        </div>

        <button class="close-btn" onclick="closeRulesModal()">å…³é—­</button>
    </div>
</div>
<div class="invoice-content">
    <!-- ä¿¡æ¯å¡ç‰‡å®¹å™¨ -->
    <div class="info-cards-container">
        <!-- æŠ¥ä»·è¡¨ä¿¡æ¯å¡ç‰‡ -->
        <div class="quotation-card">
            <div class="quotation-title">
                <i class="fas fa-file-invoice-dollar"></i>
                å‚è€ƒæŠ¥ä»·è¡¨
            </div>
            <div class="quotation-details">
                <strong>æ–‡ä»¶:</strong> <span class="quotation-highlight">{{ quotation_info.filename }}</span> 
                    <span class="divider-line"></span>
                    <strong>ç‰ˆæœ¬:</strong> {{ quotation_info.version }}
                    <span class="divider-line"></span>
                    <strong>ç”Ÿæ•ˆæ—¥æœŸ:</strong> {{ quotation_info.effective_date }}
                {% if quotation_info.is_user_exclusive %}
                    <span class="divider-line"></span>
                    <strong style="color: #dc2626;">ä¸“å±ç”¨æˆ·:</strong> {{ quotation_info.exclusive_user }}
                {% else %}
                    <span class="divider-line"></span>
                    <strong style="color: #16a34a;">é€šç”¨æŠ¥ä»·</strong>
                {% endif %}
                    <span class="divider-line"></span>
                    <strong>çŠ¶æ€:</strong> 
                <span style="color: {% if preport_status == 'completed' %}#16a34a{% elif preport_status == 'in_progress' %}#ea580c{% else %}#dc2626{% endif %};">
                    {% if preport_status == 'completed' %}å·²å®Œæˆ
                    {% elif preport_status == 'in_progress' %}å½•å…¥ä¸­
                    {% elif preport_status == 'rejected' %}å·²é©³å›
                    {% elif preport_status == 'pending_review' %}å¾…å®¡æ ¸
                    {% else %}æœªå¼€å§‹
                    {% endif %}
                </span>
            </div>
        </div>

        <!-- ç»„åˆæŸœä¿¡æ¯å¡ç‰‡ -->
        <div class="info-card">
            <div class="info-title">
                <i class="fas fa-boxes"></i>
                ç»„åˆæŸœä¿¡æ¯
            </div>
            <div class="info-details">
                {% if order_type == 'è½¬è¿' %}
                    <!-- åŸæœ¬å°±æ˜¯è½¬è¿å• -->
                    <strong>ç±»å‹:</strong> <span class="info-highlight">è½¬è¿</span>

                {% elif order_type == 'è½¬è¿ç»„åˆ' %}
                    <form method="post" action="" class="order-type-form">
                        {% csrf_token %}
                        <input type="hidden" name="step" value="modify_order_type">
                        <input type="hidden" name="new_order_type" id="new_order_type" value="">
                        <input type="hidden" name="container_number" value="{{ container_number }}">
                        <input type="hidden" name="invoice_id" value="{{ invoice.id }}">
                        <input type="hidden" name="page" value="delivery_edit">
                        <!-- æ˜¯ç»„åˆæŸœç±»å‹ -->
                        <strong>ç»„åˆæŸœçŠ¶æ€:</strong>
                        {% if is_combina %}
                            <span class="info-highlight" style="color: #16a34a;">ç¬¦åˆç»„åˆæŸœ</span>
                            <span class="divider-line"></span>
                            <button type="submit" class="btn-change-order-type" 
                                    onclick="setOrderType('è½¬è¿')">
                                <i class="fas fa-exchange-alt"></i>
                                æ”¹ä¸ºè½¬è¿
                            </button> &nbsp;&nbsp;                              
                            <input type="text" name="actual_non_combina_reason" placeholder="ä¸ç¬¦åˆåŸå› ">
                            <span class="divider-line"></span>
                            <span class="rules-icon" onclick="openRulesModal()">ğŸ“˜ ç»„åˆæŸœè§„åˆ™æŸ¥çœ‹</span>
                        {% else %}
                            <span class="info-highlight" style="color: #dc2626;">ä¸ç¬¦åˆç»„åˆæŸœ</span>
                            {% if non_combina_reason %}
                                <span class="divider-line"></span>
                                <strong style="color:#dc2626;">åŸå› :</strong> 
                                <span class="badge" style="background: rgba(255, 193, 7, 0.2); color: #ffa000;">
                                    âš ï¸{{ non_combina_reason }}
                                </span>
                            {% endif %}
                            <button type="submit" class="btn-change-order-type" 
                                    onclick="setOrderType('è½¬è¿ç»„åˆ')">
                                <i class="fas fa-exchange-alt"></i>
                                æ”¹ä¸ºç»„åˆæŸœ
                            </button>
                            <span class="divider-line"></span>
                            <span class="rules-icon" onclick="openRulesModal()">ğŸ“˜ ç»„åˆæŸœè§„åˆ™æŸ¥çœ‹</span>
                        {% endif %}
                    </form>
                    
                {% else %}
                    <!-- å…¶ä»–ç±»å‹ï¼ˆéè½¬è¿ / éè½¬è¿ç»„åˆï¼‰ -->
                    <strong>ç±»å‹:</strong> <span class="info-highlight">{{ order_type }}</span>
                {% endif %}
            </div>
        </div>
    </div>
</div>
<form method="post" action="" class="mb-0">
    {% csrf_token %}
    <input type="hidden" name="container_number" value="{{ container_number }}">
    <input type="hidden" name="invoice_number" value="{{ invoice_number }}">
    <input type="hidden" name="step" value="confirm_combina_save">
    <input type="hidden" name="save_type" id="save_type" value="">
    <input type="hidden" name="plts_by_destination" value="{{ plts_by_destination }}">
    <input type="hidden" name="start_date" value="{{ start_date }}">
    <input type="hidden" name="end_date" value="{{ end_date }}">
    <input type="hidden" name="start_date_confirm" value="{{ start_date_confirm }}">
    <input type="hidden" name="end_date_confirm" value="{{ end_date_confirm }}">
    <input type="hidden" name="customer" value="{{ customer }}">
    <input type="hidden" name="warehouse" value="{{ warehouse }}">


<div class="container-fluid mt-3">
    
    <div class="card-header p-2" style="background-color: #2c3e50; color: white; border-bottom: 1px solid #34495e;">
        <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0 d-flex align-items-center">
                <i class="bi bi-cash-stack me-1"></i>
                ç»„åˆæŸœè´¹ç”¨æ€»è®¡: $
                <span id="totalAmountDisplay" name="totalAmountDisplay" class="mx-1"></span>
                <input type="hidden" id="totalAmount" name="totalAmount">
            </h5>
    
            <span class="mx-auto" style="font-size: 1rem; color: white;">{{ invoice_number }}-{{ container_number }}-{{ container_type }}</span>            
            &nbsp;&nbsp;
            <button type="submit" class="btn btn-success btn-sm" onclick="modifyStatus('complete')">
                <i class="bi bi-check-circle me-1"></i>ç¡®è®¤è´¦å•
            </button>
            &nbsp;&nbsp;
            <button onclick="window.history.back()" style="background: linear-gradient(135deg, #9ca3af, #6b7280);
                                border: 1px solid rgba(255,255,255,0.3);
                                color: white;
                                padding: 6px 12px;
                                border-radius: 6px;
                                cursor: pointer;
                                display: flex;
                                align-items: center;
                                gap: 6px;
                                transition: all 0.2s ease;
                                font-size: 14px;
                                height: 32px;">
                <i class="fas fa-arrow-left" style="font-size: 12px;"></i>
                è¿”å›
            </button>
        </div>   
    </div>
    

    <!-- é”™è¯¯æç¤º -->
    {% if reason %}
    <div class="alert alert-danger mb-3 p-2" role="alert">
        <i class="bi bi-exclamation-triangle-fill me-1"></i>
        é”™è¯¯: {{ reason }}
    </div>
    {% endif %}
    {% if display_data.combina_data %}
    <!-- ç»„åˆæŸœè´¹ç”¨ -->
    <div class="card mb-3 shadow-sm">
        <div class="card-header bg-light text-dark p-2 border-bottom">
            <h6 class="mb-0 fw-bold fs-5 text-white bg-primary px-2 py-1 rounded d-inline-block">
                <i class="bi bi-boxes me-1"></i>
                ç»„åˆæŸœè®¡è´¹
            </h6>
        </div>
        
        <div class="card-body p-2">
            <div class="row">
                <div class="col-md-4 border-end">
                    <div class="mb-3">
                        <h6 class="text-muted">å›ºå®šè´¹ç”¨</h6>
                        <!--æ´¾é€è´¹-->
                        <input 
                            type="number" 
                            class="form-control text-primary" 
                            name="base_fee" 
                            id="base_fee"
                            step="0.01" 
                            style="width:150px; font-size: 1.5rem; font-weight: bold;"
                            value="{{ display_data.combina_data.base_fee }}"                         
                        >
                    </div>
                </div>
                <div class="col-md-8">
                    <!-- ç»„åˆæŸœæ˜ç»†è¡¨æ ¼ -->
                    <div class="table-responsive">
                        <table class="table table-sm table-bordered mb-0 advanced-table combina-table">
                            <thead class="table-light">
                                <tr>
                                    <th>åŒºåŸŸ</th>
                                    <th>å•ä»·</th>
                                    <th>ç›®çš„åœ°</th>
                                    <th>CBM</th>
                                    <th>é‡é‡(lbs)</th>
                                    <th>æ¿æ•°</th>
                                    <th>é‡‘é¢(USD)</th>
                                    <th>ç™»è®°äºº</th>
                                </tr>
                            </thead>

                            <tbody>
                                {% if display_data.combina_data.combina_groups %}
                                    {% for group in display_data.combina_data.combina_groups %}
                                    {% with region_rowspan=group.items|length %}
                                    {% for item in group.items %}

                                    <tr data-row="{{ forloop.parentloop.counter0 }}_{{ forloop.counter0 }}" 
                                        data-item-id="{{ item.id|default:'' }}" 
                                        data-po="{{ item.PO_ID|default:'' }}"
                                        data-is-hold="false"
                                        data-combina-region="{{ item.combina_region|default:'' }}"
                                        data-combina-price="{{ item.combina_price|default:0 }}"
                                        data-cbm="{{ item.total_cbm|default:0 }}"
                                        data-cbm-ratio="{{ item.cbm_ratio|default:0 }}"
                                        data-weight="{{ item.total_weight_lbs|default:0 }}"
                                        class="row-combina">

                                        {% if forloop.first %}
                                        <td rowspan="{{ region_rowspan }}" class="cell-region">
                                            <div class="region-name">{{ group.region }}</div>
                                            <div class="region-cbm">{{ group.total_cbm|floatformat:2 }} CBM</div>
                                        </td>
                                        {% endif %}

                                        {% if forloop.first %}
                                        <td rowspan="{{ region_rowspan }}" class="cell-price">
                                            <div class="region-region-price">${{ group.region_price }}</div>
                                            <div class="price-value"> ${{ group.price|floatformat:2 }}</div>
                                            <div class="cbm-ratio-value"> {{ group.total_cbm_ratio }}%</div>                                       
                                        </td>
                                        {% endif %}

                                        <td class="cell-destination">{{ item.destination|default:"-" }}</td>

                                        <td class="cell-stats">
                                            <div class="stat-value">
                                                {{ item.total_cbm|floatformat:2|default:"0.00" }}
                                                {% if item.cbm_ratio %}
                                                <span class="separator" style="color: #ccc; margin: 0 4px;">|</span>
                                                <span class="cbm-ratio-value">{{ item.cbm_ratio|floatformat:4 }}%</span>
                                                {% endif %}
                                            </div>
                                        </td>

                                        <td class="cell-stats">
                                            <div class="stat-value">{{ item.total_weight_lbs|floatformat:2|default:"0.00" }}</div>
                                        </td>

                                        <td>
                                            <div class="stat-value">{{ item.total_pallets }}</div>
                                        </td>

                                        <td>
                                            <div class="stat-value">{{ item.amount }}</div>
                                        </td>
                                        <td>
                                            <div class="stat-value">{{ item.registered_user|default_if_none:"" }}</div>
                                        </td>

                                    </tr>

                                    {% endfor %}
                                    {% endwith %}
                                    {% endfor %}
                                {% else %}
                                    <tr>
                                        <td colspan="11" class="text-center text-muted py-3">
                                            æš‚æ— ç»„åˆæŸœæ˜ç»†æ•°æ®
                                        </td>
                                    </tr>
                                {% endif %}
                            </tbody>

                            <tfoot>
                                <tr class="table-info">
                                    <td colspan="3" class="text-end"><strong>æ€»è®¡:</strong></td>

                                    <td>
                                        <strong>
                                            <input type="number" class="form-control form-control-sm text-center"
                                                value="{{ display_data.combina_data.combina_total_cbm|floatformat:2 }}" readonly>
                                        </strong>
                                    </td>

                                    <td>
                                        <strong>
                                            <input type="number" class="form-control form-control-sm"
                                                value="{{ display_data.combina_data.combina_total_weight|floatformat:2 }}" readonly>
                                        </strong>
                                    </td>

                                    <td>
                                        <strong>
                                            <input type="number" class="form-control form-control-sm"
                                                value="{{ display_data.combina_data.combina_total_pallets|default:0 }}" readonly>
                                        </strong>
                                    </td>

                                    <td>
                                        <strong>
                                            <input type="number" class="form-control form-control-sm"
                                                value="{{ display_data.combina_data.base_fee|floatformat:2 }}" readonly>
                                        </strong>
                                    </td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>           
        </div>
    </div>
    {% endif %}

    {% if display_data.extra_fees.overweight %}
    <!-- è¶…é‡è´¹ç”¨ -->
    <div class="card mb-3 shadow-sm">
        <div class="card-header bg-light text-dark p-2">
            <h6 class="mb-0 fw-bold fs-5 text-white bg-primary px-2 py-1 rounded d-inline-block">
                <i class="bi bi-box-seam me-1"></i>
                è¶…é‡è¯¦æƒ…
            </h6>
        </div>
        <div class="card-body p-2">
            <div class="row">
                <div class="col-md-4 border-end">
                    <div class="card bg-light mb-3">
                        <div class="card-body p-3">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <div>
                                    <h6 class="text-muted mb-1">è¶…é‡è´¹</h6>
                                    <input 
                                        type="number" 
                                        id="overweight_fee"
                                        class="form-control text-primary" 
                                        name="overweight_fee" 
                                        step="0.01" 
                                        style="width:120px; font-size: 1.5rem; font-weight: bold;"
                                        value="0.0"
                                        placeholder="è¯·è¾“å…¥é‡‘é¢"
                                    >
                                </div>
                            </div>
                            <hr class="my-2">
                            <div class="d-flex flex-wrap gap-2">
                                <div class="flex-grow-1 p-3 border rounded text-center">
                                    <small class="text-muted d-block mb-1">å½“å‰é‡é‡</small>
                                    <strong class="text-muted d-block">{{ display_data.extra_fees.overweight.current_weight }} ç£…</strong>
                                </div>
                                
                                <div class="flex-grow-1 p-3 border rounded bg-light text-center">
                                    <small class="text-muted d-block mb-1">é™åˆ¶é‡é‡</small>
                                    <strong class="text-muted d-block">{{ display_data.extra_fees.overweight.limit_weight }} ç£…</strong>
                                </div>
                                {% if display_data.extra_fees.overweight.is_over %}
                                <div class="flex-grow-1 p-3 border rounded bg-light text-center">
                                    <small class="text-muted d-block mb-1">è¶…å‡ºé‡é‡</small>
                                    <strong class="text-muted d-block">
                                        <input type="text" name="overweight_extra_weight" style="width:80px;" value="{{ display_data.extra_fees.overweight.extra_weight }}">ç£…</strong>
                                </div> 
                                {% endif %}  
                            </div>
                            <div class="progress mt-2" style="height: 20px;">
                                <div class="progress-bar bg-{% if display_data.extra_fees.overweight.is_over %}danger{% else %}success{% endif %}" 
                                    role="progressbar" 
                                    style="width: {% widthratio display_data.extra_fees.overweight.current_weight display_data.extra_fees.overweight.limit_weight 100 %}%" 
                                    aria-valuenow="{{ display_data.extra_fees.overweight.current_weight }}" 
                                    aria-valuemin="0" 
                                    aria-valuemax="{{ display_data.extra_fees.overweight.limit_weight }}">
                                </div>
                                {% widthratio display_data.extra_fees.overweight.current_weight display_data.extra_fees.overweight.limit_weight 100 %}%
                            </div>
                        </div>
                    </div>
                </div>  
                
                <div class="col-md-8">
                    <div class="alert alert-{% if display_data.extra_fees.overweight.is_over %}danger{% else %}success{% endif %} mb-0">
                        <div class="input-group" style="width: 180px;">
                        <i class="bi bi-{% if display_data.extra_fees.overweight.is_over %}exclamation-triangle{% else %}check-circle{% endif %}-fill me-1"></i>
                        {% if display_data.extra_fees.overweight.is_over %}                     
                            å·²è¶…é‡ 
                        {% else %}
                        é‡é‡åœ¨å…è®¸èŒƒå›´å†…
                        {% endif %}
                    </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    {% if display_data.extra_fees.overpallets %}
    <!-- è¶…æ¿è´¹ç”¨ -->
    <div class="card mb-3 shadow-sm">
        <div class="card-header bg-light text-dark p-2">
            <h6 class="mb-0 fw-bold fs-5 text-white bg-primary px-2 py-1 rounded d-inline-block">
                <i class="bi bi-box-seam me-1"></i>
                è¶…æ¿è¯¦æƒ…
            </h6>     
        </div>
        <div class="card-body p-2">
            <div class="row">
                <div class="col-md-4 border-end">
                    <div class="card bg-light mb-3">
                        <div class="card-body p-3">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <div>
                                    <h6 class="text-muted mb-1">è¶…æ¿è´¹ç”¨</h6>
                                    <input 
                                        type="number" 
                                        id="overpallet_fee"
                                        class="form-control text-primary" 
                                        name="overpallet_fee" 
                                        step="0.01" 
                                        style="width:150px; font-size: 1.5rem; font-weight: bold;"
                                        value="{{ display_data.extra_fees.overpallets.max_price_used }}"
                                        placeholder="è¯·è¾“å…¥é‡‘é¢"
                                    >
                                </div>
                            </div>
                            <hr class="my-2">
                            <div class="row g-2">
                                <div class="col-6">
                                    <div class="p-2 border rounded">
                                        <small class="text-muted d-block">å½“å‰æ¿æ•°</small>
                                        <strong class="h5">
                                            <input 
                                                type="number" 
                                                id="current_pallets"
                                                class="form-control" 
                                                name="current_pallets" 
                                                step="any" 
                                                style="width:100px; font-size: 1rem; font-weight: bold;"
                                                value="{{ display_data.extra_fees.overpallets.current_pallets }}"
                                            >
                                        </strong>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="p-2 border rounded bg-light">
                                        <small class="text-muted d-block">é™åˆ¶æ¿æ•°</small>
                                        <strong class="h5">
                                            <input 
                                                type="number" 
                                                id="limit_pallets"
                                                class="form-control" 
                                                name="limit_pallets" 
                                                step="any" 
                                                style="width:100px; font-size: 1rem; font-weight: bold;"
                                                value="{{ display_data.extra_fees.overpallets.limit_pallets }}"
                                            >
                                        </strong>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="alert alert-warning mt-3 p-2 mb-0">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    <div>
                                        <small>è¶…å‡º <strong id="overCountDisplay" class="text-danger">{{ display_data.extra_fees.overpallets.over_count }}</strong> æ¿</small>
                                        <div class="progress mt-1" style="height: 4px;width:150px;">
                                            <div class="progress-bar bg-danger" 
                                                 style="width: {% widthratio display_data.extra_fees.overpallets.over_count display_data.extra_fees.overpallets.limit_pallets 100 %}%">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                        </div>
                    </div>
                </div>
                <div class="col-md-8">
                    <table class="table table-sm table-bordered mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>ä»“ç‚¹</th>
                                <th class="text-end">ä»·æ ¼</th>
                                <th class="text-end">ç±»å‹</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for detail in display_data.extra_fees.overpallets.pallet_details %}
                            <tr class="{% if detail.is_max_used %}table-success{% endif %}">
                                <td>{{ detail.destination }}</td>
                                <td class="text-end">${{ detail.price }}</td>
                                <td class="text-end">
                                    {% if detail.is_fixed_price %}
                                    ä¸€å£ä»·
                                    {% else %}
                                    å•ä»·
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    {% if display_data.extra_fees.overregion %}
    <!-- è¶…åŒºè´¹ç”¨ -->
    <div class="card mb-3 shadow-sm">
        <div class="card-header bg-light text-dark p-2">
            <h6 class="mb-0 fw-bold fs-5 text-white bg-primary px-2 py-1 rounded d-inline-block">
                <i class="bi bi-box-seam me-1"></i>
                è¶…åŒºè¯¦æƒ…
            </h6>
            <span class="badge" style="background-color: #e0f7fa; color: #00acc1;" title="ç³»ç»Ÿè‡ªåŠ¨è®¡ç®—">
                <i class="bi bi-calculator me-1"></i>è‡ªåŠ¨è®¡ç®—
            </span>
        </div>
        {% if is_overregion %}
        <div class="card-body p-2">
            <div class="row">
                <div class="col-md-4 border-end">
                    <div class="card bg-light mb-3">
                        <div class="card-body p-3">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <div>
                                    <h6 class="text-muted mb-1">ææ‹†è´¹</h6>
                                    <div class="d-flex align-items-center">
                                        <input 
                                            type="number" 
                                            class="form-control text-primary" 
                                            name="overregion_pickup_fee" 
                                            id="overregion_pickup_fee"
                                            step="0.01" 
                                            style="width:150px; font-size: 1.5rem; font-weight: bold;"
                                            value="{{ display_data.extra_fees.overregion.pickup.fee }}"
                                            placeholder="è¯·è¾“å…¥é‡‘é¢"
                                        >&nbsp;&nbsp;
                                        <button type="button" class="btn btn-sm btn-outline-danger ms-2" 
                                            onclick="
                                                document.getElementById('overregion_pickup_fee').value = '0';
                                                updateTotalAmount();
                                            ">
                                            <i class="bi bi-x-circle"></i> æ¸…é›¶
                                        </button>
                                 </div>
                                </div>
                            </div>
                            <hr class="my-2">
                            <div class="d-flex flex-wrap gap-2">
                                <div class="flex-grow-1 p-3 border rounded text-center">
                                    <small class="text-muted d-block mb-1">è¶…åŒºä½“ç§¯</small>
                                    <strong class="text-muted d-block">
                                        <input type="number" id="overregion_pickup_cbm" name="overregion_pickup_non_combina_cbm" style="width:80px;" value="{{ display_data.extra_fees.overregion.pickup.non_combina_cbm }}"> CBM</strong>
                                </div>
                                
                                <div class="flex-grow-1 p-3 border rounded bg-light text-center" id="total-cbm-container">
                                    <small class="text-muted d-block mb-1">æ€»ä½“ç§¯</small>
                                    <strong class="text-muted d-block">{{ display_data.extra_fees.overregion.pickup.total_cbm }} CBM</strong>
                                </div>
                                <div class="flex-grow-1 p-3 border rounded bg-light text-center">
                                    <small class="text-muted d-block mb-1">æ•´æŸœææ‹†è´¹</small>
                                    <strong class="text-muted d-block">
                                        <input type="number" id="overregion_pickup_base_fee" name="overregion_pickup_non_combina_base_fee" style="width:80px;" value="{{ display_data.extra_fees.overregion.pickup.base_fee }}"></strong>
                                </div>   
                            </div>
                            <div class="progress mt-2" style="height: 20px;">
                                <div class="progress-bar bg-{% if display_data.extra_fees.overregion.pickup.ratio > 100 %}danger{% else %}info{% endif %}" 
                                     role="progressbar" 
                                     style="width: {{ display_data.extra_fees.overregion.pickup.ratio|floatformat:"0" }}%" 
                                     aria-valuenow="{{ display_data.extra_fees.overregion.pickup.ratio }}" 
                                     aria-valuemin="0" 
                                     aria-valuemax="100">
                                </div>
                                <input type="hidden" id="overregion_pickup_cbm_ratio" name="overregion_pickup_non_combina_cbm_ratio" style="width:80px;" value="{{ display_data.extra_fees.overregion.pickup.ratio }}">
                                {{ display_data.extra_fees.overregion.pickup.ratio|floatformat:"2" }}%
                            </div>
                        </div>
                    </div>
                </div>  
                <div class="col-md-8">
                    <div class="mb-3">
                        <h6 class="text-muted">æ´¾é€è´¹</h6>  
                        <div class="d-flex align-items-center">                      
                            <input 
                                type="number" 
                                class="form-control text-primary" 
                                name="overregion_delivery_fee" 
                                id="overregion_delivery_fee"
                                step="0.01" 
                                style="width:150px; font-size: 1.5rem; font-weight: bold;"
                                value="{{ display_data.extra_fees.overregion.delivery.fee }}"
                                placeholder="è¯·è¾“å…¥é‡‘é¢"
                            >&nbsp;&nbsp;
                            <button type="button" class="btn btn-sm btn-outline-danger ms-2" 
                                onclick="
                                    document.getElementById('overregion_delivery_fee').value = '0';
                                    updateTotalAmount();
                                ">
                                <i class="bi bi-x-circle"></i> æ¸…é›¶
                            </button>
                        </div>
                    </div>
                    <!--æ´¾é€è´¹-->
                    <table class="table table-sm table-bordered mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>ä»“ç‚¹</th>
                                <th class="text-end">æ¿æ•°</th>
                                <th class="text-end">cbm</th>
                                <th class="text-end">å•ä»·</th>
                                <th class="text-end">å°è®¡</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for detail in display_data.extra_fees.overregion.delivery.details %}
                            <tr>
                                <td><input type="text" name="overregion_delivery_destination" style="width:80px;" value="{{ detail.destination }}"></td>
                                <td class="text-end"><input type="number" id="overregion_delivery_pallet" step="any" name="overregion_delivery_pallets" style="width:80px;" value="{{ detail.pallets }}"></td>
                                <td class="text-end"><input type="number" id="overregion_delivery_cbm" name="overregion_delivery_cbm" style="width:80px;" value="{{ detail.cbm }}"></td>
                                <td class="text-end"><input type="number" id="overregion_delivery_price" name="overregion_delivery_price" style="width:80px;" value="{{ detail.price }}"></td>
                                <td class="text-end"><input type="number" name="overregion_delivery_subtotal" style="width:80px;" value="{{ detail.subtotal }}"></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% else %}
        <div class="alert alert-success mb-0">
            <div class="input-group" style="width: 180px;">
                <i class="bi bi-check-circle-fill me-1"></i>
                æ²¡æœ‰è¶…åŒº
            </div>
        </div>
        {% endif %}
    </div>
    {% endif %}

    {% if display_data.extra_fees.addition_fee %}
    <div class="card mb-3 shadow-sm">
        <div class="card-header bg-light text-dark p-2">
            <h6 class="mb-0 fw-bold fs-5 text-white bg-primary px-2 py-1 rounded d-inline-block">
                <i class="bi bi-pin-map me-1"></i>
                è¶…ä»“ç‚¹å›ºå®šè´¹ç”¨
            </h6>
        </div>
        <div class="card-body p-2">
            <div class="row">
                <div class="col-md-4 border-end">
                    <div class="card bg-light mb-3">
                        <div class="card-body p-3">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <div>
                                    <h6 class="text-muted mb-1">è¶…ä»“ç‚¹è´¹</h6>
                                    <input 
                                        type="number" 
                                        class="form-control price-input" 
                                        name="addition_fee" 
                                        id="addition_fee"
                                        step="0.01" 
                                        style="width:150px; font-size: 1.5rem; font-weight: bold;"
                                        value="{{ display_data.extra_fees.addition_fee.add_fee }}"
                                    >
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-8">
                    <table class="table table-sm table-bordered mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>ä»“ç‚¹æ•°é‡ä¸‹é™</th>
                                <th class="text-end">ä»“ç‚¹æ•°é‡ä¸Šé™</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>{{ display_data.extra_fees.addition_fee.min_points }}ä¸ª</td>
                                <td>{{ display_data.extra_fees.addition_fee.max_points }}ä¸ª</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    
    <!-- é¢å¤–è´¹ç”¨ -->
    <div class="card mb-3 shadow-sm">
        <div class="card-header bg-light text-dark p-2">
            <h6 class="mb-0 fw-bold fs-5 text-white bg-primary px-2 py-1 rounded d-inline-block">
                <i class="bi bi-box-seam me-1"></i>
                é¢å¤–è´¹ç”¨
            </h6>
            <span class="badge bg-warning text-dark ms-2" title="å®¢æœæ‰‹åŠ¨å½•å…¥">
                <i class="bi bi-pencil-square me-1"></i>å®¢æœå½•å…¥
            </span>
            <!--
            <button type="button" class="btn btn-sm btn-primary ms-2" onclick="showAddFeeModal()">
                <i class="bi bi-plus-circle me-1"></i>æ·»åŠ è´¹ç”¨
            </button>
            -->
        </div>
        <div class="card-body p-2">
            <div id="feeTypeModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1000;">
                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 5px; max-width: 500px; width: 90%;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h5 style="margin: 0;">é€‰æ‹©è´¹ç”¨ç±»å‹</h5>
                        <button type="button" onclick="hideAddFeeModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">&times;</button>
                    </div>
                    <div>
                        <div class="list-group">
                            <button type="button" class="list-group-item list-group-item-action" onclick="addFeeRow('port')" style="padding: 10px; border: 1px solid #ddd; margin-bottom: 5px; background: none; width: 100%; text-align: left; cursor: pointer;">
                                <i class="bi bi-building me-2"></i>æ¸¯å£ç›¸å…³è´¹ç”¨
                            </button>
                            <button type="button" class="list-group-item list-group-item-action" onclick="addFeeRow('warehouse')" style="padding: 10px; border: 1px solid #ddd; margin-bottom: 5px; background: none; width: 100%; text-align: left; cursor: pointer;">
                                <i class="bi bi-shop me-2"></i>ä»“åº“ç›¸å…³è´¹ç”¨
                            </button>
                            <button type="button" class="list-group-item list-group-item-action" onclick="addFeeRow('delivery')" style="padding: 10px; border: 1px solid #ddd; margin-bottom: 5px; background: none; width: 100%; text-align: left; cursor: pointer;">
                                <i class="bi bi-truck me-2"></i>æ´¾é€è´¹ç”¨
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- æ¸¯å£ç›¸å…³è´¹ç”¨ -->       
            <div id="portFeesSection" class="card mb-3 border-0 shadow-sm">
                <div class="card-header bg-light p-2 d-flex justify-content-between align-items-center">
                    <h6 class="mb-0 fw-bold text-dark">
                        <i class="bi bi-building me-1"></i>
                        æ¸¯å£ç›¸å…³è´¹ç”¨
                    </h6>
                </div>
                <div class="card-body p-2">
                    <div class="row mb-2 g-2 d-none d-md-flex">
                        <div class="col-md-2">
                            <small class="text-muted">è´¹ç”¨åç§°</small>
                        </div>
                        <div class="col-md-1">
                            <small class="text-muted">å•ä»·</small>
                        </div>
                        <div class="col-md-1">
                            <small class="text-muted">æ•°é‡</small>
                        </div>                        
                        <div class="col-md-1">
                            <small class="text-muted">é™„åŠ è´¹</small>
                        </div>
                        <div class="col-md-1">
                            <small class="text-muted">æ€»ä»·</small>
                        </div>
                        <div class="col-md-2">
                            <small class="text-muted">è¯´æ˜</small>
                        </div>
                        <div class="col-md-2">
                            <small class="text-muted">ç™»è®°äºº</small>
                        </div>
                        <div class="col-md-2">
                            <small class="text-muted">æ“ä½œ</small>
                        </div>
                    </div>
                    <div id="portFeesContainer">
                        {% if extra_fees and extra_fees.preports %}
                            {% for fee in extra_fees.preports %}
                            <div class="row align-items-center mb-2 g-2">
                                <div class="col-md-2">
                                    <label class="form-label fw-bold d-md-none">è´¹ç”¨åç§°:</label>
                                    <div>
                                        {{ fee.name }}
                                        <input type="hidden" class="form-control form-control-sm name-input" 
                                            name="port_fees[{{ forloop.counter0 }}][id]" value="{{ fee.id }}">
                                        <input type="hidden" class="form-control form-control-sm name-input" 
                                            name="port_fees[{{ forloop.counter0 }}][name]" value="{{ fee.name }}">
                                    </div>
                                </div>
                                <div class="col-md-1">
                                    <label class="form-label fw-bold d-md-none">å•ä»·:</label>
                                    <input type="number" class="form-control form-control-sm price-input" step="0.01" 
                                        name="port_fees[{{ forloop.counter0 }}][price]" value="{{ fee.rate }}">
                                </div>
                                <div class="col-md-1">
                                    <label class="form-label fw-bold d-md-none">æ•°é‡:</label>
                                    <input type="number" class="form-control form-control-sm quantity-input" step="0.1" 
                                        name="port_fees[{{ forloop.counter0 }}][quantity]" value="{{ fee.qty }}">
                                </div>
                                <div class="col-md-1">
                                    <label class="form-label fw-bold d-md-none">é™„åŠ è´¹:</label>
                                    <input type="number" class="form-control form-control-sm surcharge-input" step="0.01"
                                        name="port_fees[{{ forloop.counter0 }}][surcharge]" value="{{ fee.surcharge }}">
                                </div>
                                <div class="col-md-1">
                                    <label class="form-label fw-bold d-md-none">æ€»ä»·:</label>
                                    <input type="number" class="form-control form-control-sm total-input" readonly
                                        name="port_fees[{{ forloop.counter0 }}][value]" value="{{ fee.value }}">
                                </div>                      
                                <div class="col-md-2">
                                    <label class="form-label fw-bold d-md-none">è¯´æ˜:</label>
                                    <input type="text" class="form-control form-control-sm" 
                                        name="port_fees[{{ forloop.counter0 }}][surcharge_note]" value="{{ fee.surcharge_note|default:'' }}">
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label fw-bold d-md-none">ç™»è®°äºº:</label>
                                    <input type="text" class="form-control form-control-sm" readonly
                                        name="port_fees[{{ forloop.counter0 }}][registered_user]" value="{{ fee.registered_user|default:'' }}">
                                </div>   
                                <div class="col-md-2">
                                    <label class="form-label fw-bold d-md-none">æ“ä½œ:</label>
                                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeFeeRow(this, 'port')">
                                        <i class="bi bi-trash"></i> <span class="d-md-none">åˆ é™¤</span>
                                    </button>
                                </div>
                            </div>
                            {% endfor %}
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- ä»“åº“ç›¸å…³è´¹ç”¨ -->
            <div id="warehouseFeesSection" class="card mb-3 border-0 shadow-sm">
                <div class="card-header bg-light p-2 d-flex justify-content-between align-items-center">
                    <h6 class="mb-0 fw-bold text-dark">
                        <i class="bi bi-shop me-1"></i>
                        ä»“åº“ç›¸å…³è´¹ç”¨
                    </h6>
                </div>
                <div class="card-body p-2">
                    <div class="row mb-2 g-2 d-none d-md-flex">
                        <div class="col-md-2">
                            <small class="text-muted">è´¹ç”¨åç§°</small>
                        </div>
                        <div class="col-md-1">
                            <small class="text-muted">å•ä»·</small>
                        </div>
                        <div class="col-md-1">
                            <small class="text-muted">æ•°é‡</small>
                        </div>
                        <div class="col-md-1">
                            <small class="text-muted">é™„åŠ è´¹</small>
                        </div>
                        <div class="col-md-1">
                            <small class="text-muted">æ€»ä»·</small>
                        </div>                      
                        <div class="col-md-2">
                            <small class="text-muted">è¯´æ˜</small>
                        </div>
                        <div class="col-md-2">
                            <small class="text-muted">ç™»è®°äºº</small>
                        </div>
                        <div class="col-md-2">
                            <small class="text-muted">æ“ä½œ</small>
                        </div>
                    </div>
                    <div id="warehouseFeesContainer">
                        {% if extra_fees and extra_fees.warehouse %}
                            {% for fee in extra_fees.warehouse %}
                            <div class="row align-items-center mb-2 g-2">
                                <div class="col-md-2">
                                    <label class="form-label fw-bold d-md-none">è´¹ç”¨åç§°:</label>
                                    <div>
                                        {{ fee.name }}
                                        <input type="hidden" class="form-control form-control-sm name-input" 
                                            name="warehouse_fees[{{ forloop.counter0 }}][id]" value="{{ fee.id }}">
                                        <input type="hidden" class="form-control form-control-sm name-input" 
                                            name="warehouse_fees[{{ forloop.counter0 }}][name]" value="{{ fee.name }}">
                                    </div>
                                </div>
                                <div class="col-md-1">
                                    <label class="form-label fw-bold d-md-none">å•ä»·:</label>
                                    <input type="number" class="form-control form-control-sm price-input" step="0.01" 
                                        name="warehouse_fees[{{ forloop.counter0 }}][price]" value="{{ fee.rate }}">
                                </div>
                                <div class="col-md-1">
                                    <label class="form-label fw-bold d-md-none">æ•°é‡:</label>
                                    <input type="number" class="form-control form-control-sm quantity-input" step="0.1" 
                                        name="warehouse_fees[{{ forloop.counter0 }}][quantity]" value="{{ fee.qty }}">
                                </div>
                                <div class="col-md-1">
                                    <label class="form-label fw-bold d-md-none">é™„åŠ è´¹:</label>
                                    <input type="number" class="form-control form-control-sm surcharge-input" step="0.01"
                                        name="warehouse_fees[{{ forloop.counter0 }}][surcharge]" value="{{ fee.surcharge }}">
                                </div>
                                <div class="col-md-1">
                                    <label class="form-label fw-bold d-md-none">æ€»ä»·:</label>
                                    <input type="number" class="form-control form-control-sm total-input" readonly
                                        name="warehouse_fees[{{ forloop.counter0 }}][value]" value="{{ fee.value }}">
                                </div>                   
                                <div class="col-md-2">
                                    <label class="form-label fw-bold d-md-none">è¯´æ˜:</label>
                                    <input type="text" class="form-control form-control-sm" 
                                        name="warehouse_fees[{{ forloop.counter0 }}][surcharge_note]" value="{{ fee.surcharge_note|default:'' }}">
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label fw-bold d-md-none">ç™»è®°äºº:</label>
                                    <input type="text" class="form-control form-control-sm" readonly
                                        name="warehouse_fees[{{ forloop.counter0 }}][registered_user]" value="{{ fee.registered_user|default:'' }}">
                                </div>   
                                <div class="col-md-2">
                                    <label class="form-label fw-bold d-md-none">æ“ä½œ:</label>
                                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeFeeRow(this, 'warehouse')">
                                        <i class="bi bi-trash"></i> <span class="d-md-none">åˆ é™¤</span>
                                    </button>
                                </div>
                            </div>
                            {% endfor %}
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- æ´¾é€ç›¸å…³è´¹ç”¨ -->
            <div id="deliveryFeesSection" class="card mb-3 border-0 shadow-sm">
                <div class="card-header bg-light p-2 d-flex justify-content-between align-items-center">
                    <h6 class="mb-0 fw-bold text-dark">
                        <i class="bi bi-truck me-1"></i>
                        æ´¾é€è´¹ç”¨
                    </h6>
                </div>
                <div class="card-body p-2">
                    <!-- æ¡Œé¢ç«¯è¡¨å¤´ -->
                    <div class="row mb-2 g-2 d-none d-md-flex">
                        <div class="col-md-1">
                            <small class="text-muted">æ´¾é€ç±»å‹</small>
                        </div>
                        <div class="col-md-1">
                            <small class="text-muted">ç›®çš„åœ°</small>
                        </div>
                        <div class="col-md-1">
                            <small class="text-muted">å•ä»·</small>
                        </div>
                        <div class="col-md-1">
                            <small class="text-muted">æ¿æ•°</small>
                        </div>
                        <div class="col-md-1">
                            <small class="text-muted">ä½“ç§¯</small>
                        </div>
                        <div class="col-md-1">
                            <small class="text-muted">é‡é‡</small>
                        </div>
                        <div class="col-md-1">
                            <small class="text-muted">æ€»è´¹ç”¨</small>
                        </div>
                        <div class="col-md-2">
                            <small class="text-muted">å¤‡æ³¨</small>
                        </div>
                        <div class="col-md-2">
                            <small class="text-muted">ç™»è®°äºº</small>
                        </div>
                        <div class="col-md-1">
                            <small class="text-muted">æ“ä½œ</small>
                        </div>
                    </div>
                    
                    <div id="deliveryFeesContainer">
                        {% if extra_fees and extra_fees.deliverys %}
                            {% for delivery in extra_fees.deliverys %}
                            <div class="row align-items-center mb-2 g-2">
                                <!-- æ´¾é€ç±»å‹ -->
                                <div class="col-6 col-md-1">
                                    <label class="form-label fw-bold d-md-none">æ´¾é€ç±»å‹:</label>
                                    <input type="text" class="form-control form-control-sm" 
                                        name="deliverys[{{ forloop.counter0 }}][type]" 
                                        value="{{ delivery.type|default:'' }}">
                                    <input type="hidden" 
                                        name="deliverys[{{ forloop.counter0 }}][id]" 
                                        value="{{ delivery.id|default:'' }}">
                                </div>
                                
                                <!-- ç›®çš„åœ° -->
                                <div class="col-6 col-md-1">
                                    <label class="form-label fw-bold d-md-none">ç›®çš„åœ°:</label>
                                    <input type="text" class="form-control form-control-sm" 
                                        name="deliverys[{{ forloop.counter0 }}][destination]" 
                                        value="{{ delivery.destination|default:'' }}">
                                </div>
                                
                                <!-- å•ä»· -->
                                <div class="col-4 col-md-1">
                                    <label class="form-label fw-bold d-md-none">å•ä»·:</label>
                                    <input type="number" class="form-control form-control-sm price-input" step="0.1"
                                        name="deliverys[{{ forloop.counter0 }}][cost]" 
                                        value="{{ delivery.cost|default:0 }}">
                                </div>
                                
                                <!-- æ¿æ•° -->
                                <div class="col-4 col-md-1">
                                    <label class="form-label fw-bold d-md-none">æ¿æ•°:</label>
                                    <input type="number" class="form-control form-control-sm quantity-input" step="any"
                                        name="deliverys[{{ forloop.counter0 }}][total_pallet]" 
                                        value="{{ delivery.total_pallet|default:0 }}">
                                </div>
                                
                                <!-- ä½“ç§¯ -->
                                <div class="col-4 col-md-1">
                                    <label class="form-label fw-bold d-md-none">ä½“ç§¯(CBM):</label>
                                    <input type="number" class="form-control form-control-sm" step="0.01"
                                        name="deliverys[{{ forloop.counter0 }}][total_cbm]" 
                                        value="{{ delivery.total_cbm|default:0 }}">
                                </div>
                                
                                <!-- é‡é‡ -->
                                <div class="col-4 col-md-1">
                                    <label class="form-label fw-bold d-md-none">é‡é‡(LBS):</label>
                                    <input type="number" class="form-control form-control-sm" step="0.1"
                                        name="deliverys[{{ forloop.counter0 }}][total_weight_lbs]" 
                                        value="{{ delivery.total_weight_lbs|default:0 }}">
                                </div>
                                
                                <!-- æ€»è´¹ç”¨ -->
                                <div class="col-4 col-md-1">
                                    <label class="form-label fw-bold d-md-none">æ€»è´¹ç”¨:</label>
                                    <input type="number" class="form-control form-control-sm total-input" step="0.01"
                                        name="deliverys[{{ forloop.counter0 }}][total_cost]" 
                                        value="{{ delivery.total_cost|default:0 }}">
                                </div>
                                
                                <!-- å¤‡æ³¨ -->
                                <div class="col-8 col-md-2">
                                    <label class="form-label fw-bold d-md-none">å¤‡æ³¨:</label>
                                    <input type="text" class="form-control form-control-sm"
                                        name="deliverys[{{ forloop.counter0 }}][note]" 
                                        value="{{ delivery.note|default:'' }}">
                                </div>
                                
                                <!-- ç™»è®°äºº -->
                                <div class="col-6 col-md-2">
                                    <label class="form-label fw-bold d-md-none">ç™»è®°äºº:</label>
                                    <input type="text" class="form-control form-control-sm" readonly
                                        name="deliverys[{{ forloop.counter0 }}][registered_user]" 
                                        value="{{ delivery.registered_user|default:'' }}">
                                </div>
                                
                                <!-- æ“ä½œ -->
                                <div class="col-6 col-md-1">
                                    <label class="form-label fw-bold d-md-none">æ“ä½œ:</label>
                                    <button type="button" class="btn btn-sm btn-outline-danger w-100" 
                                            onclick="removeFeeRow(this, 'delivery')">
                                        <i class="bi bi-trash"></i> 
                                        <span class="d-none d-md-inline">åˆ é™¤</span>
                                        <span class="d-md-none">åˆ </span>
                                    </button>
                                </div>
                            </div>
                            
                            <!-- ç§»åŠ¨ç«¯åˆ†éš”çº¿ -->
                            {% if not forloop.last %}
                            <div class="d-md-none">
                                <hr class="my-2">
                            </div>
                            {% endif %}
                            {% endfor %}
                        {% endif %}
                    </div>
                </div>
        </div>
    </div> 
</div>
</form>
<form method="post" action="" class="mb-0">
    {% csrf_token %}
    <input type="hidden" name="container_number" value="{{ container_number }}">
    <input type="hidden" name="invoice_number" value="{{ invoice_number }}">
    <input type="hidden" name="step" value="dismiss">
    <input type="hidden" name="invoice_type" value="receivable">
    <input type="hidden" name="start_date" value="{{ start_date }}">
    <input type="hidden" name="end_date" value="{{ end_date }}">
    <input type="hidden" name="start_date_confirm" value="{{ start_date_confirm }}">
    <input type="hidden" name="end_date_confirm" value="{{ end_date_confirm }}">
    <div class="card mb-3 shadow-sm">
        <div class="card-header bg-danger text-white p-2">
            <h6 class="mb-0">
                <i class="bi bi-x-circle me-1"></i>
                é©³å›è´¦å•
            </h6>
        </div>
        <div class="card-body p-3">
            <div class="row align-items-center">
                <div class="col-md-4 mb-2 mb-md-0">
                    <label class="form-label">é©³å›åŸå› :</label>
                    <select class="form-select" name="status" id="rejectPhase" required>
                        <option value="">-- è¯·é€‰æ‹©é©³å›é˜¶æ®µ --</option>
                        <option value="preport">æ¸¯å‰é—®é¢˜</option>
                        <option value="warehouse">åº“å†…é—®é¢˜</option>
                        <option value="delivery">æ´¾é€é—®é¢˜</option>
                    </select>
                </div>
                <div class="col-md-4 mb-2 mb-md-0" id="warehouseTypeContainer" style="display:none;">
                    <label class="form-label">ä»“åº“ç±»å‹:</label>
                    <select class="form-select" name="reject_type" id="warehouseType">
                        <option value="">-- è¯·é€‰æ‹©ä»“åº“ç±»å‹ --</option>
                        <option value="public">å…¬ä»“</option>
                        <option value="other">ç§ä»“</option>
                    </select>
                </div>
                <div class="col-md-6 mb-2 mb-md-0">
                    <label class="form-label">é©³å›è¯´æ˜:</label>
                    <input type="text" class="form-control" name="reject_reason" placeholder="è¯·è¾“å…¥å…·ä½“é©³å›åŸå› ..." required>
                </div>
                <div class="col-md-2">
                    <button type="submit" class="btn btn-danger w-100">
                        <i class="bi bi-x-circle me-1"></i> é©³å›
                    </button>
                </div>
            </div>
        </div>
    </div>
</form>

<!--ç»„åˆæŸœå’Œéç»„åˆæŸœåŒºåŸŸ-->
<div class="card mb-3 shadow-sm">
    <div class="card-header bg-light text-dark p-2">
        <h6 class="mb-0 fw-bold fs-5 text-white bg-primary px-2 py-1 rounded d-inline-block">
            <i class="bi bi-list-check me-1"></i>
            åŒºåŸŸè¯¦æƒ…å±•ç¤º
        </h6>
    </div>
    <div class="card-body p-3">
        <div class="row">
            <!-- ç»„åˆæŸœåŒºåŸŸ -->
            <div class="col-md-6 mb-3 mb-md-0">
                <div class="card h-100 border-primary">
                    <div class="card-header bg-primary text-white py-2">
                        <h6 class="mb-0">
                            <i class="bi bi-collection me-2"></i>
                            ç»„åˆæŸœåŒºåŸŸ
                        </h6>
                    </div>
                    <div class="card-body">
                        {% if destination_matches %}
                            <ul class="list-group list-group-flush">
                                {% for dest in destination_matches %}
                                    <li class="list-group-item d-flex justify-content-between align-items-center py-2">
                                        {{ dest }}
                                        <span class="badge bg-primary rounded-pill">
                                            <i class="bi bi-check-circle me-1"></i>
                                            å·²åŒ¹é…
                                        </span>
                                    </li>
                                {% endfor %}
                            </ul>
                        {% else %}
                            <div class="alert alert-warning mb-0 py-2">
                                <i class="bi bi-exclamation-triangle me-2"></i>
                                æ— ç»„åˆæŸœåŒºåŸŸæ•°æ®
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- éç»„åˆæŸœåŒºåŸŸ -->
            <div class="col-md-6">
                <div class="card h-100 border-warning">
                    <div class="card-header bg-warning text-dark py-2">
                        <h6 class="mb-0">
                            <i class="bi bi-box-seam me-2"></i>
                            éç»„åˆæŸœåŒºåŸŸ
                        </h6>
                    </div>
                    <div class="card-body">
                        {% if non_combina_dests %}
                            <ul class="list-group list-group-flush">
                                {% for dest in non_combina_dests %}
                                    <li class="list-group-item d-flex justify-content-between align-items-center py-2">
                                        {{ dest }}
                                        <span class="badge bg-warning text-dark rounded-pill">
                                            <i class="bi bi-info-circle me-1"></i>
                                            éç»„åˆ
                                        </span>
                                    </li>
                                {% endfor %}
                            </ul>
                        {% else %}
                            <div class="alert alert-success mb-0 py-2">
                                <i class="bi bi-check-circle me-2"></i>
                                æ— éç»„åˆæŸœåŒºåŸŸ
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% include 'receivable_accounting/modals/message_modal.html' %}
<style>
    .card {
        border-radius: 5px;
    }
    .card-header {
        border-radius: 5px 5px 0 0 !important;
    }
    .table th, .table td {
        padding: 0.3rem;
    }
    .badge {
        font-size: 0.75em;
        padding: 0.25em 0.4em;
    }
    .border-end {
        border-right: 1px solid #dee2e6;
    }
        .combina-table th {
        background: #f8f9fa;
        font-weight: 600;
        text-align: center;
        vertical-align: middle;
    }

    .combina-table td {
        vertical-align: middle;
        padding: 6px 8px !important;
    }

    /* åŒºåŸŸ/å•ä»·åˆå¹¶åˆ—æ ·å¼ */
    .combina-table .cell-region,
    .combina-table .cell-price {
        background: #fafafa;
        border-right: 1px solid #e1e1e1;
        text-align: center;
    }

    .combina-table .region-name {
        font-weight: 600;
        font-size: 14px;
    }
    .combina-table .region-cbm {
        font-size: 12px;
        color: #6c757d;
    }

    .combina-table .cell-destination {
        font-weight: 500;
    }

    .combina-table .stat-value {
        text-align: center;
        font-weight: 500;
    }

    /* è¾“å…¥æ¡†æ›´ç´§å‡‘ */
    .combina-table .input-control {
        height: 28px;
        font-size: 13px;
        padding: 2px 6px;
    }

    /* tfoot æ€»è®¡æ  */
    .combina-table tfoot td {
        background: #eef7ff !important;
        vertical-align: middle;
    }

    .combina-table tfoot input {
        font-weight: 600;
        text-align: right;
    }
    .combina-table tr[data-row^="0_"] > td { background-color: #fff9e8; }
    .combina-table tr[data-row^="1_"] > td { background-color: #d8e9fb; }
    .combina-table tr[data-row^="2_"] > td { background-color: #edf9ff; }
    .combina-table tr[data-row^="3_"] > td { background-color: #f8eef9; }
    .combina-table tr[data-row^="4_"] > td { background-color: #f1faf2; }
    .combina-table tr[data-row^="5_"] > td { background-color: #fdf0f5; }

    .combina-table tfoot td {
        background-color: #f0f6ff !important;
    }
    .price-value {
        font-size: 0.7rem;
        color: #4caf50;
        font-weight: 500;
    }
    .cbm-ratio-value {
        font-size: 0.65rem;
        color: #868e96;
        font-weight: 500;
        font-style: italic;
    }
</style>
<script>
    function showAddFeeModal() {
        document.getElementById('feeTypeModal').style.display = 'block';
    }
    function hideAddFeeModal() {
        document.getElementById('feeTypeModal').style.display = 'none';
    }


    function addFeeRow(feeType) {
        let containerId, namePrefix, index;
        switch(feeType) {



            case 'port':
                containerId = 'portFeesContainer';
                namePrefix = 'port_fees';
                index = document.querySelectorAll('#portFeesContainer .row.align-items-center.mb-2.g-2').length;
                break;
            case 'warehouse':
                containerId = 'warehouseFeesContainer';
                namePrefix = 'warehouse_fees';
                index = document.querySelectorAll('#warehouseFeesContainer .row.align-items-center.mb-2.g-2').length;
                break;
            case 'delivery':
                containerId = 'deliveryFeesContainer';
                namePrefix = 'deliverys';
                index = document.querySelectorAll('#deliveryFeesContainer .row.align-items-center.mb-2.g-2').length;
                break;
            default:
                return;
        }

        const container = document.getElementById(containerId);     

        let newRow;

        if (feeType === 'port' || feeType === 'warehouse') {
            newRow = document.createElement('div');
            newRow.className = 'row align-items-center mb-2 g-2';
            newRow.innerHTML = `
                <div class="col-md-3">
                    <small class="text-muted d-md-none">è´¹ç”¨åç§°</small>
                    <input type="text" class="form-control form-control-sm name-input" 
                        name="${namePrefix}[${index}][name]" value="" placeholder="è¾“å…¥è´¹ç”¨åç§°">
                </div>
                <div class="col-md-2">
                    <small class="text-muted d-md-none">å•ä»·</small>
                    <input type="number" class="form-control form-control-sm price-input" step="0.01" 
                        name="${namePrefix}[${index}][price]" value="0">
                </div>
                <div class="col-md-1">
                    <small class="text-muted d-md-none">æ•°é‡</small>
                    <input type="number" class="form-control form-control-sm quantity-input" step="0.1" 
                        name="${namePrefix}[${index}][quantity]" value="0">
                </div>
                <div class="col-md-2">
                    <small class="text-muted d-md-none">é™„åŠ è´¹</small>
                    <input type="number" class="form-control form-control-sm surcharge-input" step="0.01"
                        name="${namePrefix}[${index}][surcharge]" value="0">
                </div>
                <div class="col-md-2">
                    <small class="text-muted d-md-none">æ€»ä»·</small>
                    <input type="number" class="form-control form-control-sm total-input" readonly
                        name="${namePrefix}[${index}][value]" value="0">
                </div>                      
                <div class="col-md-2">
                    <small class="text-muted d-md-none">è¯´æ˜</small>
                    <input type="text" class="form-control form-control-sm" 
                        name="${namePrefix}[${index}][surcharge_note]" value="">
                    <button type="button" class="btn btn-sm btn-outline-danger mt-1" onclick="removeFeeRow(this, '${feeType}')">
                        <i class="bi bi-trash"></i> åˆ é™¤
                    </button>
                </div>
            `;
        } else if (feeType === 'delivery') {
            newRow = document.createElement('div');
            newRow.className = 'row align-items-center mb-2 g-2';
            newRow.innerHTML = `
                <div class="col-md-1">
                    <small class="text-muted d-md-none">æ´¾é€ç±»å‹</small>
                    <input type="text" class="form-control form-control-sm" 
                        name="${namePrefix}[${index}][type]" value="">
                </div>
                <div class="col-md-1">
                    <small class="text-muted d-md-none">ç›®çš„åœ°</small>
                    <input type="text" class="form-control form-control-sm" 
                        name="${namePrefix}[${index}][destination]" value="">
                </div>
                <div class="col-md-1">
                    <small class="text-muted d-md-none">å•ä»·</small>
                    <input type="number" class="form-control form-control-sm price-input" step="0.1"
                        name="${namePrefix}[${index}][cost]" value="0">
                </div>
                <div class="col-md-1">
                    <small class="text-muted d-md-none">æ¿æ•°</small>
                    <input type="number" class="form-control form-control-sm quantity-input" step="any"
                        name="${namePrefix}[${index}][total_pallet]" value="0">
                </div>
                <div class="col-md-1">
                    <small class="text-muted d-md-none">ä½“ç§¯(CBM)</small>
                    <input type="number" class="form-control form-control-sm" step="0.01"
                        name="${namePrefix}[${index}][total_cbm]" value="0">
                </div>
                <div class="col-md-1">
                    <small class="text-muted d-md-none">é‡é‡(LBS)</small>
                    <input type="number" class="form-control form-control-sm" step="0.1"
                        name="${namePrefix}[${index}][total_weight_lbs]" value="0">
                </div>
                <div class="col-md-2">
                    <small class="text-muted d-md-none">æ€»è´¹ç”¨</small>
                    <input type="number" class="form-control form-control-sm total-input" step="0.01"
                        name="${namePrefix}[${index}][total_cost]" value="0">
                </div>
                <div class="col-md-4">
                    <small class="text-muted d-md-none">å¤‡æ³¨</small>
                    <input type="text" class="form-control form-control-sm"
                        name="${namePrefix}[${index}][note]" value="">
                    <button type="button" class="btn btn-sm btn-outline-danger mt-1" onclick="removeFeeRow(this, '${feeType}')">
                        <i class="bi bi-trash"></i> åˆ é™¤
                    </button>
                </div>
            `;
        }

        container.appendChild(newRow);
        
        // ä¸ºæ–°å¢è¡Œçš„è¾“å…¥æ¡†æ·»åŠ äº‹ä»¶ç›‘å¬
        const inputs = newRow.querySelectorAll('.price-input, .quantity-input, .surcharge-input');
        inputs.forEach(input => {
            input.addEventListener('input', function() {
                const row = this.closest('.row.align-items-center.mb-2.g-2');
                if (row) {
                    calculateFeeTotal(row);
                    updateTotalAmount();
                }
            });
        });

        // éšè—æ¨¡æ€æ¡†
        hideAddFeeModal();
    }

    function removeFeeRow(button, feeType) {
        const row = button.closest('.row.align-items-center.mb-2.g-2');
        if (row) {
            // è·å–è®°å½•çš„IDï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
            const recordId = row.querySelector('input[name*="[id]"]') ? 
                            row.querySelector('input[name*="[id]"]').value : '';
            
            // å°†IDæ·»åŠ åˆ°åˆ é™¤åˆ—è¡¨ä¸­
            if (recordId) {
                addToDeleteList(feeType, recordId);
            }
            
            row.remove();
            updateTotalAmount();
        }
    }

    // åˆ›å»ºåˆ é™¤åˆ—è¡¨
    let deleteRecords = {
        'port': [],
        'warehouse': [],
        'delivery': []
    };

    function addToDeleteList(feeType, recordId) {
        if (recordId && !deleteRecords[feeType].includes(recordId)) {
            deleteRecords[feeType].push(recordId);
            
            // åˆ›å»ºæˆ–æ›´æ–°éšè—çš„åˆ é™¤åˆ—è¡¨å­—æ®µ
            let deleteInput = document.getElementById('delete_records');
            if (!deleteInput) {
                deleteInput = document.createElement('input');
                deleteInput.type = 'hidden';
                deleteInput.name = 'delete_records';
                deleteInput.id = 'delete_records';
                document.querySelector('form[method="post"]').appendChild(deleteInput);
            }
            deleteInput.value = JSON.stringify(deleteRecords);
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        const rejectPhase = document.getElementById('rejectPhase');
        const warehouseTypeContainer = document.getElementById('warehouseTypeContainer');
        const warehouseType = document.getElementById('warehouseType');

        rejectPhase.addEventListener('change', function() {
            if (this.value === 'warehouse' || this.value === 'delivery') {
                warehouseTypeContainer.style.display = 'block';
                warehouseType.required = true;
                warehouseType.name = "delivery_type";
            } else {
                warehouseTypeContainer.style.display = 'none';
                warehouseType.required = false;
                warehouseType.name = "reject_type";
            }
        });
    });
    function shouldCalculateDeliveryTotal(type) {
        // è¿™äº›ç±»å‹ä¸è‡ªåŠ¨è®¡ç®—
        const noCalcTypes = ["è‡ªå‘", "UPS", "æœ¬åœ°æ´¾é€","å®¢æˆ·è‡ªæ","selfpickup"];
        return !noCalcTypes.includes(type);
    }
    document.querySelectorAll('.total-input').forEach(input => {
        if (!input.readOnly) { 
            input.addEventListener('input', updateTotalAmount);
        }
    });
    //è®¡ç®—æ¯ä¸ªè´¹ç”¨çš„æ€»ä»·
    function calculateFeeTotal(row) {
        const typeInput = row.querySelector('input[name*="[type]"]');
        const totalInput = row.querySelector('.total-input');
        if (typeInput) {  //åˆ¤æ–­æ˜¯ä¸æ˜¯é¢å¤–è´¹ç”¨çš„æ´¾é€è´¹ç”¨
            const type = typeInput.value.trim();
            const price = parseFloat(row.querySelector('.price-input').value) || 0;
            const quantity = parseFloat(row.querySelector('.quantity-input').value) || 0;
            const totalInput = row.querySelector('.total-input');
            
            if (shouldCalculateDeliveryTotal(type) && totalInput) {
                const total = price * quantity;
                totalInput.value = total.toFixed(2);
                return total;
            }
            return parseFloat(totalInput ? totalInput.value : 0) || 0;
        } else {
            const price = parseFloat(row.querySelector('.price-input').value) || 0;
            const quantity = parseFloat(row.querySelector('.quantity-input').value) || 0;

            const surchargeInput = row.querySelector('.surcharge-input');
            const surcharge = surchargeInput ? parseFloat(surchargeInput.value) || 0 : 0;
            const total = (price * quantity) + surcharge;
            const totalInput = row.querySelector('.total-input');
            if (totalInput) {
                totalInput.value = total.toFixed(2);
            }
            return total;
        }     
    }

    function calculateExtraFeesTotal() {
        let extraTotal = 0;
        document.querySelectorAll('.row.align-items-center.mb-2.g-2').forEach(row => {
            extraTotal += calculateFeeTotal(row);
        });
        return extraTotal;
    }

    // ä¸ºæ‰€æœ‰å•ä»·å’Œæ•°é‡è¾“å…¥æ¡†æ·»åŠ äº‹ä»¶ç›‘å¬
    document.addEventListener('DOMContentLoaded', function() {
        // ä¸ºæ‰€æœ‰å•ä»·ã€æ•°é‡å’Œé™„åŠ è´¹è¾“å…¥æ¡†æ·»åŠ äº‹ä»¶ç›‘å¬
        document.querySelectorAll('.price-input, .quantity-input, .surcharge-input, input[name*="[type]"]').forEach(input => {
            input.addEventListener('input', function() {
                const row = this.closest('.row.align-items-center.mb-2.g-2');
                if (row) {
                    calculateFeeTotal(row);
                    updateTotalAmount();
                }
            });
        });
        document.querySelectorAll('.region-price-input').forEach(input => {
            input.addEventListener('input', updateTotalAmount);
        });

        // åˆå§‹åŒ–è®¡ç®—æ‰€æœ‰è´¹ç”¨
        updateTotalAmount();
    });

    document.addEventListener('DOMContentLoaded', function() {
        const currentPalletsInput = document.getElementById('current_pallets');
        const limitPalletsInput = document.getElementById('limit_pallets'); 
        const overpalletFeeInput = document.getElementById('overpallet_fee');
        const maxPriceRow = document.querySelector('tr.table-success');
        const palletPrice = maxPriceRow ? parseFloat(maxPriceRow.querySelector('td.text-end').textContent.replace('$', '')) : 0;
        function calculateOverpalletFee() {
            const currentPallets = parseFloat(currentPalletsInput.value) || 0;
            const limitPallets = parseFloat(limitPalletsInput.value) || 0;
            const overCount = currentPallets - limitPallets;
            document.getElementById("overCountDisplay").textContent = overCount;
            if (overCount > 0) {
                overpalletFeeInput.value = (overCount * palletPrice).toFixed(2);
            } else {
                overpalletFeeInput.value = "0.00";
            }
            
            updateTotalAmount();
        }
        if (currentPalletsInput && limitPalletsInput) {
            currentPalletsInput.addEventListener('input', calculateOverpalletFee);
            limitPalletsInput.addEventListener('input', calculateOverpalletFee);
        }

        const overregionDeliveryPriceInput = document.getElementById('overregion_delivery_price');
        const overregionDeliveryPalletInput = document.getElementById('overregion_delivery_pallet');
        const overregion_delivery_fee = document.getElementById('overregion_delivery_fee');
        if (overregionDeliveryPriceInput&&overregionDeliveryPalletInput) {
            overregionDeliveryPriceInput.addEventListener('input', calculateOverregionFee);
            overregionDeliveryPalletInput.addEventListener('input', calculateOverregionFee);
        }
        function calculateOverregionFee(){
            const deliveryPrice = parseFloat(overregionDeliveryPriceInput.value) || 0;
            const deliveryPallet = parseFloat(overregionDeliveryPalletInput.value) || 0;
            overregion_delivery_fee.value = (deliveryPrice * deliveryPallet).toFixed(2);
            updateTotalAmount();
        }

        const overregionPickupBaseFeeInput = document.getElementById('overregion_pickup_base_fee');
        const overregionPickupCbmInput = document.getElementById('overregion_pickup_cbm');
        const overregion_pickup_fee = document.getElementById('overregion_pickup_fee');

        const totalCbmDisplay = document.querySelector('#total-cbm-container strong');
        if (totalCbmDisplay) totalCbmText = totalCbmDisplay.textContent;
        if (overregionPickupBaseFeeInput&&overregionPickupCbmInput) {
            overregionPickupBaseFeeInput.addEventListener('input', calculateOverregionPickup);
            overregionPickupCbmInput.addEventListener('input', calculateOverregionPickup);
        }
        function calculateOverregionPickup(){
            const pickupBaseFee = parseFloat(overregionPickupBaseFeeInput.value) || 0;
            const pickupCbm = parseFloat(overregionPickupCbmInput.value) || 0;
            const amountCbm = parseFloat(totalCbmText) || 0;
            overregion_pickup_fee.value = (pickupBaseFee * pickupCbm / amountCbm).toFixed(2);
            updateTotalAmount();
        }

        const totalAmountDisplay = document.getElementById('totalAmountDisplay');
        const totalAmount = document.getElementById('totalAmount');
        const base_fee = document.getElementById('base_fee');
        const overpallet_fee = document.getElementById('overpallet_fee');
        const overweight_fee = document.getElementById('overweight_fee');
        const addition_fee = document.getElementById('addition_fee');
    
        [base_fee, overweight_fee, overpallet_fee, overregion_pickup_fee, overregion_delivery_fee,addition_fee].forEach(input => {
            if (input) {
                input.addEventListener('input', updateTotalAmount);
            }
        });
        updateTotalAmount();
    });
    function updateTotalAmount() {
        const getSafeNumberValue = (elementId) => {
            const element = document.getElementById(elementId);
            return element ? parseFloat(element.value) || 0 : 0;
        };
        let amount = 0;

        amount += getSafeNumberValue('base_fee');

        // è®¡ç®—ç»„åˆæŸœåŒºåŸŸè´¹ç”¨
        let combinaRegionsTotal = 0;
        document.querySelectorAll('.region-price-input').forEach(input => {
            combinaRegionsTotal += parseFloat(input.value) || 0;
        });
        
        // æ›´æ–°ç»„åˆæŸœåŒºåŸŸæ€»è®¡æ˜¾ç¤º
        const combinaRegionsTotalElement = document.getElementById('combina_regions_total');
        if (combinaRegionsTotalElement) {
            combinaRegionsTotalElement.textContent = combinaRegionsTotal.toFixed(2);
        }
        
        // å°†ç»„åˆæŸœåŒºåŸŸè´¹ç”¨åŠ å…¥æ€»é‡‘é¢
        amount += combinaRegionsTotal;

        amount += getSafeNumberValue('overpallet_fee');
        amount += getSafeNumberValue('overweight_fee');
        amount += getSafeNumberValue('overregion_pickup_fee');
        amount += getSafeNumberValue('overregion_delivery_fee');
        // è¶…ä»“ç‚¹çš„å›ºå®šè´¹ç”¨
        amount += getSafeNumberValue('addition_fee');
        amount += calculateExtraFeesTotal();
        
        const totalDisplay = document.getElementById('totalAmountDisplay');
        if (totalDisplay) totalDisplay.textContent = amount.toFixed(2);
        
        const totalInput = document.getElementById('totalAmount');
        if (totalInput) totalInput.value = amount.toFixed(2);       
    }
    function modifyStatus(type) {
        const saveTypeInput = document.getElementById('save_type');
        saveTypeInput.value = type; 
    }
    function openRulesModal() {
        document.getElementById("rules-modal").style.display = "flex";
    }

    function closeRulesModal() {
        document.getElementById("rules-modal").style.display = "none";
    }
</script>
{% endblock %}