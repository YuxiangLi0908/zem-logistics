{% extends 'base.html' %}

{% block content %}
<div  style="display: inline-block; width: 100%; margin: 0; padding: 0; max-width: 100%;">
    <p style="text-align:center;"><b>{{ invoice }}</b></p>
</div>
    
    <form method="post" action="">
        {% csrf_token %}
        <div class="pallet-window" style="display: none; z-index:999; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: white; border: 1px solid gray; padding: 20px; max-height: 50%; overflow-y: scroll;">
            <div style="display: flex;">
                <input type="hidden" name="step" value="add_delivery_type">
                <input type="hidden" id="alter_type" name="alter_type">
                <input type="hidden" name="container_number" value={{ container_number }}>
                <button type="submit" class="btn btn-primary" onclick="add_delivery_plt(this)" style="font-size: 11px; margin-right: 5px;">确认添加</button>
                <button id="editButton" type="button" class="btn btn-danger" onclick="add_delivery(this)" style="font-size: 11px;">返回</button>
            </div>
            <table class="table" id="invoice-table" style="font-size: 13px;">
                <thead>
                    <tr style="position: sticky; top: 0;">
                        <th class="th" style="min-width: 40px;"></th>
                        <th class="th">板数</th>
                        <th class="th">派送类型</th>
                        <th class="th">目的地</th>
                        <th class="th">CBM</th>
                        <th class="th">重量</th>
                        <th class="th">邮编</th>
                    </tr>
                </thead>
                <tbody>
                    {% for plt in pallet %}
                    <tr draggable="true" id="pallet-{{ plt.id }}">
                        <td class="td" style="min-width: 40px; text-align: center;">
                            <input type='checkbox' name='is_type_added' onclick="toggleRowBackground(this)" {% if plt.delivery %}checked{% endif %}>
                            <input type="hidden" name="is_type_added", value='off'>
                            <input type="hidden" name="added_plt_ids", value='{{ plt.ids }}'>
                        </td>
                        <td class="td"><input type="text" name="total_n_pallet" value="{{ plt.total_n_pallet }}" disabled></td>
                        <td class="td"><input type="text" name="delivery_type" value="{{ plt.delivery_type }}" disabled></td>
                        <td class="td"><input type="text" name="destination" value="{{ plt.destination }}"></td>
                        <td class="td"><input type="number" name="cbm" step = 0.01 value="{{ plt.total_cbm|floatformat:2 }}"></td>
                        <td class="td"><input type="number" name="weight_lbs" step = 0.01 value="{{ plt.total_weight_lbs }}" oninput="updateAmount(this)"></td>
                        <td class="td"><input type="number" name="zipcode" step = 0.01 value="{{ plt.zipcode|floatformat:2 }}"></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </form>
    
    <form method="post" action="">
        <button id="editButton" type="button" class="btn btn-primary" onclick="add_delivery(this)" style="font-size: 11px;">亚马逊派送</button>
        {% if amazon %}
            <table class="table" id="invoice-table" style="font-size: 13px">
                <thead>
                    <tr style="position: sticky; top: 0;">
                        <th class="th" style="min-width: 40px;"></th>
                        <th class="th">价格</th>
                        <th class="th">目的地</th>
                        <th class="th">CBM</th>
                        <th class="th">重量</th>
                        <th class="th">邮编</th>
                    </tr>
                </thead>
                <tbody>
                    {% for plt in amazon %}
                    <tr draggable="true" id="pallet-{{ plt.id }}">
                        <td class="td" style="min-width: 40px; text-align: center;">
                            <input type='checkbox' onclick="toggleRowBackground(this)">
                            <input type="hidden" name="added_plt_ids", value='{{ plt.ids }}'>
                        </td>
                        <td class="td"><input type="text" name="total_n_pallet" value="{{ plt.total_cost }}">
                        ({{ plt.total_n_pallet }}板，${{ plt.cost }}/板)
                        </td>
                        <td class="td"><input type="text" name="destination" value="{{ plt.destination }}"></td>
                        <td class="td"><input type="number" name="cbm" step = 0.01 value="{{ plt.total_cbm|floatformat:2 }}"></td>
                        <td class="td"><input type="number" name="weight_lbs" step = 0.01 value="{{ plt.total_weight_lbs }}" oninput="updateAmount(this)"></td>
                        <td class="td"><input type="number" name="zipcode" step = 0.01 value="{{ plt.zipcode|floatformat:2 }}"></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% endif %}
        {% if warehouse == "NJ" %}
            <button id="editButton" type="button" class="btn btn-primary" onclick="add_delivery(this)" style="font-size: 11px;">本地派送</button>
            {% if local %}
                <table class="table" id="invoice-table" style="font-size: 13px;">
                    <thead>
                        <tr style="position: sticky; top: 0;">
                            <th class="th" style="min-width: 40px;"></th>
                            <th class="th">价格</th>
                            <th class="th">目的地</th>
                            <th class="th">CBM</th>
                            <th class="th">重量</th>
                            <th class="th">邮编</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for plt in local %}
                        <tr draggable="true" id="pallet-{{ plt.id }}">
                            <td class="td" style="min-width: 40px; text-align: center;">
                                <input type='checkbox' onclick="toggleRowBackground(this)">
                                <input type="hidden" name="added_plt_ids", value='{{ plt.ids }}'>
                            </td>
                            <td class="td"><input type="text" name="total_n_pallet" value="{{ plt.total_cost }}"></td>
                            <td class="td"><input type="text" name="destination" value="{{ plt.destination }}"></td>
                            <td class="td"><input type="number" name="cbm" step = 0.01 value="{{ plt.total_cbm|floatformat:2 }}"></td>
                            <td class="td"><input type="number" name="weight_lbs" step = 0.01 value="{{ plt.total_weight_lbs }}" oninput="updateAmount(this)"></td>
                            <td class="td"><input type="number" name="zipcode" step = 0.01 value="{{ plt.zipcode|floatformat:2 }}"></td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            {% endif %}
        {% endif %}
        <button id="editButton" type="button" class="btn btn-primary" onclick="add_delivery(this)" style="font-size: 11px;">组合柜派送</button>
        {% if combine %}
            <table class="table" id="invoice-table" style="font-size: 13px;">
                <thead>
                    <tr style="position: sticky; top: 0;">
                        <th class="th" style="min-width: 40px;"></th>
                        <th class="th">价格</th>
                        <th class="th">目的地</th>
                        <th class="th">CBM</th>
                        <th class="th">重量</th>
                        <th class="th">邮编</th>
                    </tr>
                </thead>
                <tbody>
                    {% for plt in combine %}
                    <tr draggable="true" id="pallet-{{ plt.id }}">
                        <td class="td" style="min-width: 40px; text-align: center;">
                            <input type='checkbox' onclick="toggleRowBackground(this)">
                            <input type="hidden" name="added_plt_ids", value='{{ plt.ids }}'>
                        </td>
                        <td class="td"><input type="text" name="total_n_pallet" value="{{ plt.total_cost }}"></td>
                        <td class="td"><input type="text" name="destination" value="{{ plt.destination }}"></td>
                        <td class="td"><input type="number" name="cbm" step = 0.01 value="{{ plt.total_cbm|floatformat:2 }}"></td>
                        <td class="td"><input type="number" name="weight_lbs" step = 0.01 value="{{ plt.total_weight_lbs }}" oninput="updateAmount(this)"></td>
                        <td class="td"><input type="number" name="zipcode" step = 0.01 value="{{ plt.zipcode|floatformat:2 }}"></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% endif %}
    </form>

    
<script>
    function add_delivery_plt(button) {
        const checkBoxes = document.getElementsByName('is_type_added');
        for (let i = 0; i < checkBoxes.length; i+=2) {
            if (checkBoxes[i].checked) {
                checkBoxes[i+1].disabled = true;
            };
        };
    };

    function add_delivery(button) {
        var popup = document.querySelector('.pallet-window');
        if (popup.style.display === 'none') {
            popup.style.display = 'block';
        } else {
            popup.style.display = 'none';
        };
        const type = document.getElementById('alter_type');
        text = button.textContent;
        if (text === '亚马逊派送') {
            type.value = 'amazon';
        } else if (text === '本地派送') {
            type.value = 'local';
        } else if (text === '组合柜派送') {
            type.value = 'combine';
        }   
    };

    function toggleRowBackground(checkbox) {
        var row = checkbox.closest('tr');
        if (checkbox.checked) {
            row.style.backgroundColor = '#ADD8E6'; 
        } else {
            row.style.backgroundColor = ''; 
        }
    };
    function removeRows() {
        const checkboxes = document.querySelectorAll('input[name="is_item_selected"]:checked');
        checkboxes.forEach(checkbox => {
            const row = checkbox.closest('tr');
            row.remove();
        });
    };
</script>
{% endblock %}