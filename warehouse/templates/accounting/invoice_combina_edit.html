{% extends 'base.html' %}

{% block content %}
<form method="post" action="" class="mb-0">
    {% csrf_token %}
    <input type="hidden" name="container_number" value="{{ container_number }}">
    <input type="hidden" name="invoice_number" value="{{ invoice_number }}">
    <input type="hidden" name="step" value="confirm_combina_save">
    <input type="hidden" name="save_type" id="save_type" value="">
    <input type="hidden" name="plts_by_destination" value="{{ plts_by_destination }}">
    <input type="hidden" name="start_date" value="{{ start_date }}">
    <input type="hidden" name="end_date" value="{{ end_date }}">
    <input type="hidden" name="is_from_account_confirmation" value="{{ is_from_account_confirmation }}">
    <input type="hidden" name="start_date_confirm" value="{{ start_date_confirm }}">
    <input type="hidden" name="end_date_confirm" value="{{ end_date_confirm }}">
    <input type="hidden" name="customer" value="{{ customer }}">
    <input type="hidden" name="warehouse" value="{{ warehouse }}">
<div class="container-fluid mt-3">
    <div class="card-header p-2" style="background-color: #2c3e50; color: white; border-bottom: 1px solid #34495e;">
        <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0 d-flex align-items-center">
                <i class="bi bi-cash-stack me-1"></i>
                组合柜费用总计: $
                <span id="totalAmountDisplay" name="totalAmountDisplay" class="mx-1"></span>
                <input type="hidden" id="totalAmount" name="totalAmount">
            </h5>
    
            <span class="mx-auto" style="font-size: 1rem; color: white;">{{ invoice_number }}-{{ container_number }}</span>            
            &nbsp;&nbsp;
            <button type="submit" class="btn btn-success btn-sm" onclick="modifyStatus('complete')">
                <i class="bi bi-check-circle me-1"></i>确认账单
            </button>
        </div>   
    </div>
    

    <!-- 错误提示 -->
    {% if reason %}
    <div class="alert alert-danger mb-3 p-2" role="alert">
        <i class="bi bi-exclamation-triangle-fill me-1"></i>
        错误: {{ reason }}
    </div>
    {% endif %}
    {% if display_data.combina_data %}
    <!-- 组合柜费用 -->
    <div class="card mb-3 shadow-sm">
        <div class="card-header bg-light text-dark p-2 border-bottom">
            <h6 class="mb-0 fw-bold fs-5 text-white bg-primary px-2 py-1 rounded d-inline-block">
                <i class="bi bi-box-seam me-1"></i>
                组合柜区域
            </h6>         
        </div>
        <div class="card-body p-2">
            <div class="row">
                <div class="col-md-4 border-end">
                    <div class="mb-3">
                        <h6 class="text-muted">固定费用</h6>
                        <!--派送费-->
                        <input 
                            type="number" 
                            class="form-control text-primary" 
                            name="base_fee" 
                            id="base_fee"
                            step="0.01" 
                            style="width:150px; font-size: 1.5rem; font-weight: bold;"
                            value="{{ display_data.combina_data.base_fee }}"                         
                        >
                    </div>
                </div>
                
                <div class="col-md-8">
                    <table class="table table-sm table-bordered mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>区域</th>
                                <th>cbm</th>
                                <th class="text-end">价格</th>
                                <th class="text-end">仓点</th>
                                <th>cbm占比</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for dest in display_data.combina_data.destinations %}
                            <tr>
                                <td><input type="text" name="combina_data_des_key" value="{{ dest.key }}"></td>
                                <td><input type="number" name="combina_data_des_cbm" value="{{ dest.cbm }}"></td>
                                <td class="text-end"><input type="number" name="combina_data_des_price" value="{{ dest.price }}"></td>
                                <td class="text-end"><input type="text" name="combina_data_des_location" value="{{ dest.location }}"></td>
                                <td><input type="number" name="combina_data_des_rate" value="{{ dest.rate }}"></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    {% if display_data.extra_fees.overweight %}
    <!-- 超重费用 -->
    <div class="card mb-3 shadow-sm">
        <div class="card-header bg-light text-dark p-2">
            <h6 class="mb-0 fw-bold fs-5 text-white bg-primary px-2 py-1 rounded d-inline-block">
                <i class="bi bi-box-seam me-1"></i>
                超重详情
            </h6>
        </div>
        <div class="card-body p-2">
            <div class="row">
                <div class="col-md-4 border-end">
                    <div class="card bg-light mb-3">
                        <div class="card-body p-3">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <div>
                                    <h6 class="text-muted mb-1">超重费</h6>
                                    <input 
                                        type="number" 
                                        id="overweight_fee"
                                        class="form-control text-primary" 
                                        name="overweight_fee" 
                                        step="0.01" 
                                        style="width:120px; font-size: 1.5rem; font-weight: bold;"
                                        value="0.0"
                                        placeholder="请输入金额"
                                    >
                                </div>
                            </div>
                            <hr class="my-2">
                            <div class="d-flex flex-wrap gap-2">
                                <div class="flex-grow-1 p-3 border rounded text-center">
                                    <small class="text-muted d-block mb-1">当前重量</small>
                                    <strong class="text-muted d-block">{{ display_data.extra_fees.overweight.current_weight }} 磅</strong>
                                </div>
                                
                                <div class="flex-grow-1 p-3 border rounded bg-light text-center">
                                    <small class="text-muted d-block mb-1">限制重量</small>
                                    <strong class="text-muted d-block">{{ display_data.extra_fees.overweight.limit_weight }} 磅</strong>
                                </div>
                                {% if display_data.extra_fees.overweight.is_over %}
                                <div class="flex-grow-1 p-3 border rounded bg-light text-center">
                                    <small class="text-muted d-block mb-1">超出重量</small>
                                    <strong class="text-muted d-block">
                                        <input type="text" name="overweight_extra_weight" style="width:80px;" value="{{ display_data.extra_fees.overweight.extra_weight }}">磅</strong>
                                </div> 
                                {% endif %}  
                            </div>
                            <div class="progress mt-2" style="height: 20px;">
                                <div class="progress-bar bg-{% if display_data.extra_fees.overweight.is_over %}danger{% else %}success{% endif %}" 
                                    role="progressbar" 
                                    style="width: {% widthratio display_data.extra_fees.overweight.current_weight display_data.extra_fees.overweight.limit_weight 100 %}%" 
                                    aria-valuenow="{{ display_data.extra_fees.overweight.current_weight }}" 
                                    aria-valuemin="0" 
                                    aria-valuemax="{{ display_data.extra_fees.overweight.limit_weight }}">
                                </div>
                                {% widthratio display_data.extra_fees.overweight.current_weight display_data.extra_fees.overweight.limit_weight 100 %}%
                            </div>
                        </div>
                    </div>
                </div>  
                
                <div class="col-md-8">
                    <div class="alert alert-{% if display_data.extra_fees.overweight.is_over %}danger{% else %}success{% endif %} mb-0">
                        <div class="input-group" style="width: 180px;">
                        <i class="bi bi-{% if display_data.extra_fees.overweight.is_over %}exclamation-triangle{% else %}check-circle{% endif %}-fill me-1"></i>
                        {% if display_data.extra_fees.overweight.is_over %}                     
                            已超重 
                        {% else %}
                        重量在允许范围内
                        {% endif %}
                    </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    {% if display_data.extra_fees.overpallets %}
    <!-- 超板费用 -->
    <div class="card mb-3 shadow-sm">
        <div class="card-header bg-light text-dark p-2">
            <h6 class="mb-0 fw-bold fs-5 text-white bg-primary px-2 py-1 rounded d-inline-block">
                <i class="bi bi-box-seam me-1"></i>
                超板详情
            </h6>     
        </div>
        <div class="card-body p-2">
            <div class="row">
                <div class="col-md-4 border-end">
                    <div class="card bg-light mb-3">
                        <div class="card-body p-3">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <div>
                                    <h6 class="text-muted mb-1">超板费用</h6>
                                    <input 
                                        type="number" 
                                        id="overpallet_fee"
                                        class="form-control text-primary" 
                                        name="overpallet_fee" 
                                        step="0.01" 
                                        style="width:150px; font-size: 1.5rem; font-weight: bold;"
                                        value="{{ display_data.extra_fees.overpallets.max_price_used }}"
                                        placeholder="请输入金额"
                                    >
                                </div>
                            </div>
                            <hr class="my-2">
                            <div class="row g-2">
                                <div class="col-6">
                                    <div class="p-2 border rounded">
                                        <small class="text-muted d-block">当前板数</small>
                                        <strong class="h5">
                                            <input 
                                                type="number" 
                                                id="current_pallets"
                                                class="form-control" 
                                                name="current_pallets" 
                                                step="0.01" 
                                                style="width:100px; font-size: 1rem; font-weight: bold;"
                                                value="{{ display_data.extra_fees.overpallets.current_pallets }}"
                                            >
                                        </strong>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="p-2 border rounded bg-light">
                                        <small class="text-muted d-block">限制板数</small>
                                        <strong class="h5">
                                            <input 
                                                type="number" 
                                                id="limit_pallets"
                                                class="form-control" 
                                                name="limit_pallets" 
                                                step="0.01" 
                                                style="width:100px; font-size: 1rem; font-weight: bold;"
                                                value="{{ display_data.extra_fees.overpallets.limit_pallets }}"
                                            >
                                        </strong>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="alert alert-warning mt-3 p-2 mb-0">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    <div>
                                        <small>超出 <strong id="overCountDisplay" class="text-danger">{{ display_data.extra_fees.overpallets.over_count }}</strong> 板</small>
                                        <div class="progress mt-1" style="height: 4px;width:150px;">
                                            <div class="progress-bar bg-danger" 
                                                 style="width: {% widthratio display_data.extra_fees.overpallets.over_count display_data.extra_fees.overpallets.limit_pallets 100 %}%">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                        </div>
                    </div>
                </div>
                <div class="col-md-8">
                    <table class="table table-sm table-bordered mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>仓点</th>
                                <th class="text-end">价格</th>
                                <th class="text-end">类型</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for detail in display_data.extra_fees.overpallets.pallet_details %}
                            <tr class="{% if detail.is_max_used %}table-success{% endif %}">
                                <td>{{ detail.destination }}</td>
                                <td class="text-end">${{ detail.price }}</td>
                                <td class="text-end">
                                    {% if detail.is_fixed_price %}
                                    一口价
                                    {% else %}
                                    单价
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    {% if display_data.extra_fees.overregion %}
    <!-- 超区费用 -->
    <div class="card mb-3 shadow-sm">
        <div class="card-header bg-light text-dark p-2">
            <h6 class="mb-0 fw-bold fs-5 text-white bg-primary px-2 py-1 rounded d-inline-block">
                <i class="bi bi-box-seam me-1"></i>
                超区详情
            </h6>
            <span class="badge" style="background-color: #e0f7fa; color: #00acc1;" title="系统自动计算">
                <i class="bi bi-calculator me-1"></i>自动计算
            </span>
        </div>
        {% if is_overregion %}
        <div class="card-body p-2">
            <div class="row">
                <div class="col-md-4 border-end">
                    <div class="card bg-light mb-3">
                        <div class="card-body p-3">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <div>
                                    <h6 class="text-muted mb-1">提拆费</h6>
                                    <div class="d-flex align-items-center">
                                        <input 
                                            type="number" 
                                            class="form-control text-primary" 
                                            name="overregion_pickup_fee" 
                                            id="overregion_pickup_fee"
                                            step="0.01" 
                                            style="width:150px; font-size: 1.5rem; font-weight: bold;"
                                            value="{{ display_data.extra_fees.overregion.pickup.fee }}"
                                            placeholder="请输入金额"
                                        >&nbsp;&nbsp;
                                        <button type="button" class="btn btn-sm btn-outline-danger ms-2" 
                                            onclick="
                                                document.getElementById('overregion_pickup_fee').value = '0';
                                                updateTotalAmount();
                                            ">
                                            <i class="bi bi-x-circle"></i> 清零
                                        </button>
                                 </div>
                                </div>
                            </div>
                            <hr class="my-2">
                            <div class="d-flex flex-wrap gap-2">
                                <div class="flex-grow-1 p-3 border rounded text-center">
                                    <small class="text-muted d-block mb-1">超区体积</small>
                                    <strong class="text-muted d-block">
                                        <input type="number" id="overregion_pickup_cbm" name="overregion_pickup_non_combina_cbm" style="width:80px;" value="{{ display_data.extra_fees.overregion.pickup.non_combina_cbm }}"> CBM</strong>
                                </div>
                                
                                <div class="flex-grow-1 p-3 border rounded bg-light text-center" id="total-cbm-container">
                                    <small class="text-muted d-block mb-1">总体积</small>
                                    <strong class="text-muted d-block">{{ display_data.extra_fees.overregion.pickup.total_cbm }} CBM</strong>
                                </div>
                                <div class="flex-grow-1 p-3 border rounded bg-light text-center">
                                    <small class="text-muted d-block mb-1">整柜提拆费</small>
                                    <strong class="text-muted d-block">
                                        <input type="number" id="overregion_pickup_base_fee" name="overregion_pickup_non_combina_base_fee" style="width:80px;" value="{{ display_data.extra_fees.overregion.pickup.base_fee }}"></strong>
                                </div>   
                            </div>
                            <div class="progress mt-2" style="height: 20px;">
                                <div class="progress-bar bg-{% if display_data.extra_fees.overregion.pickup.ratio > 100 %}danger{% else %}info{% endif %}" 
                                     role="progressbar" 
                                     style="width: {{ display_data.extra_fees.overregion.pickup.ratio|floatformat:"0" }}%" 
                                     aria-valuenow="{{ display_data.extra_fees.overregion.pickup.ratio }}" 
                                     aria-valuemin="0" 
                                     aria-valuemax="100">
                                </div>
                                <input type="number" id="overregion_pickup_cbm_ratio" name="overregion_pickup_non_combina_cbm_ratio" style="width:80px;" value="{{ display_data.extra_fees.overregion.pickup.ratio }}">
                                {{ display_data.extra_fees.overregion.pickup.ratio|floatformat:"2" }}%
                            </div>
                        </div>
                    </div>
                </div>  
                <div class="col-md-8">
                    <div class="mb-3">
                        <h6 class="text-muted">派送费</h6>  
                        <div class="d-flex align-items-center">                      
                            <input 
                                type="number" 
                                class="form-control text-primary" 
                                name="overregion_delivery_fee" 
                                id="overregion_delivery_fee"
                                step="0.01" 
                                style="width:150px; font-size: 1.5rem; font-weight: bold;"
                                value="{{ display_data.extra_fees.overregion.delivery.fee }}"
                                placeholder="请输入金额"
                            >&nbsp;&nbsp;
                            <button type="button" class="btn btn-sm btn-outline-danger ms-2" 
                                onclick="
                                    document.getElementById('overregion_delivery_fee').value = '0';
                                    updateTotalAmount();
                                ">
                                <i class="bi bi-x-circle"></i> 清零
                            </button>
                        </div>
                    </div>
                    <!--派送费-->
                    <table class="table table-sm table-bordered mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>仓点</th>
                                <th class="text-end">板数</th>
                                <th class="text-end">cbm</th>
                                <th class="text-end">单价</th>
                                <th class="text-end">小计</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for detail in display_data.extra_fees.overregion.delivery.details %}
                            <tr>
                                <td><input type="text" name="overregion_delivery_destination" style="width:80px;" value="{{ detail.destination }}"></td>
                                <td class="text-end"><input type="number" id="overregion_delivery_pallet" name="overregion_delivery_pallets" style="width:80px;" value="{{ detail.pallets }}"></td>
                                <td class="text-end"><input type="number" id="overregion_delivery_cbm" name="overregion_delivery_cbm" style="width:80px;" value="{{ detail.cbm }}"></td>
                                <td class="text-end"><input type="number" id="overregion_delivery_price" name="overregion_delivery_price" style="width:80px;" value="{{ detail.price }}"></td>
                                <td class="text-end"><input type="number" name="overregion_delivery_subtotal" style="width:80px;" value="{{ detail.subtotal }}"></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% else %}
        <div class="alert alert-success mb-0">
            <div class="input-group" style="width: 180px;">
                <i class="bi bi-check-circle-fill me-1"></i>
                没有超区
            </div>
        </div>
        {% endif %}
    </div>
    {% endif %}

    {% if display_data.extra_fees.addition_fee %}
    <div class="card mb-3 shadow-sm">
        <div class="card-header bg-light text-dark p-2">
            <h6 class="mb-0 fw-bold fs-5 text-white bg-primary px-2 py-1 rounded d-inline-block">
                <i class="bi bi-pin-map me-1"></i>
                超仓点固定费用
            </h6>
        </div>
        <div class="card-body p-2">
            <div class="row">
                <div class="col-md-4 border-end">
                    <div class="card bg-light mb-3">
                        <div class="card-body p-3">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <div>
                                    <h6 class="text-muted mb-1">超仓点费</h6>
                                    <input 
                                        type="number" 
                                        class="form-control text-primary" 
                                        name="addition_fee" 
                                        id="addition_fee"
                                        step="0.01" 
                                        style="width:150px; font-size: 1.5rem; font-weight: bold;"
                                        value="{{ display_data.extra_fees.addition_fee.add_fee }}"
                                    >
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-8">
                    <table class="table table-sm table-bordered mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>仓点数量下限</th>
                                <th class="text-end">仓点数量上限</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>{{ display_data.extra_fees.addition_fee.min_points }}个</td>
                                <td>{{ display_data.extra_fees.addition_fee.max_points }}个</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    
    <!-- 额外费用 -->
    <div class="card mb-3 shadow-sm">
        <div class="card-header bg-light text-dark p-2">
            <h6 class="mb-0 fw-bold fs-5 text-white bg-primary px-2 py-1 rounded d-inline-block">
                <i class="bi bi-box-seam me-1"></i>
                额外费用
            </h6>
            <span class="badge bg-warning text-dark ms-2" title="客服手动录入">
                <i class="bi bi-pencil-square me-1"></i>客服录入
            </span>
            <button type="button" class="btn btn-sm btn-primary ms-2" onclick="showAddFeeModal()">
                <i class="bi bi-plus-circle me-1"></i>添加费用
            </button>
        </div>
        <div class="card-body p-2">
            <div id="feeTypeModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1000;">
                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 5px; max-width: 500px; width: 90%;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h5 style="margin: 0;">选择费用类型</h5>
                        <button type="button" onclick="hideAddFeeModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">&times;</button>
                    </div>
                    <div>
                        <div class="list-group">
                            <button type="button" class="list-group-item list-group-item-action" onclick="addFeeRow('port')" style="padding: 10px; border: 1px solid #ddd; margin-bottom: 5px; background: none; width: 100%; text-align: left; cursor: pointer;">
                                <i class="bi bi-building me-2"></i>港口相关费用
                            </button>
                            <button type="button" class="list-group-item list-group-item-action" onclick="addFeeRow('warehouse')" style="padding: 10px; border: 1px solid #ddd; margin-bottom: 5px; background: none; width: 100%; text-align: left; cursor: pointer;">
                                <i class="bi bi-shop me-2"></i>仓库相关费用
                            </button>
                            <button type="button" class="list-group-item list-group-item-action" onclick="addFeeRow('delivery')" style="padding: 10px; border: 1px solid #ddd; margin-bottom: 5px; background: none; width: 100%; text-align: left; cursor: pointer;">
                                <i class="bi bi-truck me-2"></i>派送费用
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- 港口相关费用 -->       
            <div id="portFeesSection" class="card mb-3 border-0 shadow-sm">
                <div class="card-header bg-light p-2 d-flex justify-content-between align-items-center">
                    <h6 class="mb-0 fw-bold text-dark">
                        <i class="bi bi-building me-1"></i>
                        港口相关费用
                    </h6>
                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="addFeeRow('port')">
                        <i class="bi bi-plus"></i> 添加
                    </button>
                </div>
                <div class="card-body p-2">
                    <div class="row mb-2 g-2 d-none d-md-flex">
                        <div class="col-md-3"></div>
                        <div class="col-md-2">
                            <small class="text-muted">单价</small>
                        </div>
                        <div class="col-md-1">
                            <small class="text-muted">数量</small>
                        </div>                        
                        <div class="col-md-2">
                            <small class="text-muted">附加费</small>
                        </div>
                        <div class="col-md-2">
                            <small class="text-muted">总价</small>
                        </div>
                        <div class="col-md-2">
                            <small class="text-muted">说明</small>
                        </div>
                    </div>
                    <div id="portFeesContainer">
                        {% if extra_fees and extra_fees.preports %}
                            {% for fee in extra_fees.preports %}
                            <div class="row align-items-center mb-2 g-2">
                                <div class="col-md-3">
                                    <label class="form-label fw-bold">{{ fee.name }}:</label>
                                    <input type="hidden" class="form-control form-control-sm name-input" 
                                        name="port_fees[{{ forloop.counter0 }}][name]" value="{{ fee.name }}">
                                </div>
                                <div class="col-md-2">
                                    <small class="text-muted d-md-none">单价</small>
                                    <input type="number" class="form-control form-control-sm price-input" step="0.01" 
                                        name="port_fees[{{ forloop.counter0 }}][price]" value="{{ fee.rate }}">
                                </div>
                                <div class="col-md-1">
                                    <small class="text-muted d-md-none">数量</small>
                                    <input type="number" class="form-control form-control-sm quantity-input" step="0.1" 
                                        name="port_fees[{{ forloop.counter0 }}][quantity]" value="{{ fee.qty }}">
                                </div>
                                <div class="col-md-2">
                                    <small class="text-muted d-md-none">附加费</small>
                                    <input type="number" class="form-control form-control-sm surcharge-input" step="0.01"
                                        name="port_fees[{{ forloop.counter0 }}][surcharge]" value="{{ fee.surcharge }}">
                                </div>
                                <div class="col-md-2">
                                    <small class="text-muted d-md-none">总价</small>
                                    <input type="number" class="form-control form-control-sm total-input" readonly
                                        name="port_fees[{{ forloop.counter0 }}][value]" value="{{ fee.value }}">
                                </div>                      
                                <div class="col-md-2">
                                    <small class="text-muted d-md-none">说明</small>
                                    <input type="text" class="form-control form-control-sm" 
                                        name="port_fees[{{ forloop.counter0 }}][surcharge_note]" value="{{ fee.surcharge_note|default:'' }}">
                                    <button type="button" class="btn btn-sm btn-outline-danger mt-1" onclick="removeFeeRow(this, 'port')">
                                        <i class="bi bi-trash"></i> 删除
                                    </button>
                                </div>
                            </div>
                            {% endfor %}
                        {% endif %}
                    </div>
                </div>
            </div>
                     
            <!-- 仓库相关费用 -->
            <div id="warehouseFeesSection" class="card mb-3 border-0 shadow-sm">
                <div class="card-header bg-light p-2 d-flex justify-content-between align-items-center">
                    <h6 class="mb-0 fw-bold text-dark">
                        <i class="bi bi-shop me-1"></i>
                        仓库相关费用
                    </h6>
                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="addFeeRow('warehouse')">
                        <i class="bi bi-plus"></i> 添加
                    </button>
                </div>
                <div class="card-body p-2">
                    <div class="row mb-2 g-2 d-none d-md-flex">
                        <div class="col-md-3"></div>
                        <div class="col-md-2">
                            <small class="text-muted">单价</small>
                        </div>
                        <div class="col-md-1">
                            <small class="text-muted">数量</small>
                        </div>
                        <div class="col-md-2">
                            <small class="text-muted">附加费</small>
                        </div>
                        <div class="col-md-2">
                            <small class="text-muted">总价</small>
                        </div>                      
                        <div class="col-md-2">
                            <small class="text-muted">说明</small>
                        </div>
                    </div>
                    <div id="warehouseFeesContainer">
                        {% if extra_fees and extra_fees.warehouse %}
                            {% for fee in extra_fees.warehouse %}
                            <div class="row align-items-center mb-2 g-2">
                                <div class="col-md-3">
                                    <label class="form-label fw-bold">{{ fee.name }}:</label>
                                    <input type="hidden" class="form-control form-control-sm name-input" 
                                        name="warehouse_fees[{{ forloop.counter0 }}][name]" value="{{ fee.name }}">
                                </div>
                                <div class="col-md-2">
                                    <small class="text-muted d-md-none">单价</small>
                                    <input type="number" class="form-control form-control-sm price-input" step="0.01" 
                                        name="warehouse_fees[{{ forloop.counter0 }}][price]" value="{{ fee.rate }}">
                                </div>
                                <div class="col-md-1">
                                    <small class="text-muted d-md-none">数量</small>
                                    <input type="number" class="form-control form-control-sm quantity-input" step="0.1" 
                                        name="warehouse_fees[{{ forloop.counter0 }}][quantity]" value="{{ fee.qty }}">
                                </div>
                                <div class="col-md-2">
                                    <small class="text-muted d-md-none">附加费</small>
                                    <input type="number" class="form-control form-control-sm surcharge-input" step="0.01"
                                        name="warehouse_fees[{{ forloop.counter0 }}][surcharge]" value="{{ fee.surcharge }}">
                                </div>
                                <div class="col-md-2">
                                    <small class="text-muted d-md-none">总价</small>
                                    <input type="number" class="form-control form-control-sm total-input" readonly
                                        name="warehouse_fees[{{ forloop.counter0 }}][value]" value="{{ fee.value }}">
                                </div>                   
                                <div class="col-md-2">
                                    <small class="text-muted d-md-none">说明</small>
                                    <input type="text" class="form-control form-control-sm" 
                                        name="warehouse_fees[{{ forloop.counter0 }}][surcharge_note]" value="{{ fee.surcharge_note|default:'' }}">
                                    <button type="button" class="btn btn-sm btn-outline-danger mt-1" onclick="removeFeeRow(this, 'warehouse')">
                                        <i class="bi bi-trash"></i> 删除
                                    </button>
                                </div>
                            </div>
                            {% endfor %}
                        {% endif %}
                    </div>
                </div>
            </div>
            <!-- 派送相关费用 -->
            <div id="deliveryFeesSection" class="card mb-3 border-0 shadow-sm">
                <div class="card-header bg-light p-2 d-flex justify-content-between align-items-center">
                    <h6 class="mb-0 fw-bold text-dark">
                        <i class="bi bi-truck me-1"></i>
                        派送费用
                    </h6>
                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="addFeeRow('delivery')">
                        <i class="bi bi-plus"></i> 添加
                    </button>
                </div>
                <div class="card-body p-2">
                    <div class="row mb-2 g-2 d-none d-md-flex">
                        <div class="col-md-1">
                            <small class="text-muted">派送类型</small>
                        </div>
                        <div class="col-md-1">
                            <small class="text-muted">目的地</small>
                        </div>
                        <div class="col-md-1">
                            <small class="text-muted">单价</small>
                        </div>
                        <div class="col-md-1">
                            <small class="text-muted">板数</small>
                        </div>
                        <div class="col-md-1">
                            <small class="text-muted">体积(CBM)</small>
                        </div>
                        <div class="col-md-1">
                            <small class="text-muted">重量(LBS)</small>
                        </div>
                        <div class="col-md-2">
                            <small class="text-muted">总费用</small>
                        </div>
                        <div class="col-md-4">
                            <small class="text-muted">备注</small>
                        </div>
                    </div>
                    <div id="deliveryFeesContainer">
                        {% if extra_fees and extra_fees.deliverys %}
                            {% for delivery in extra_fees.deliverys %}
                            <div class="row align-items-center mb-2 g-2">
                                <div class="col-md-1">
                                    <small class="text-muted d-md-none">派送类型</small>
                                    <input type="text" class="form-control form-control-sm" 
                                        name="deliverys[{{ forloop.counter0 }}][type]" 
                                        value="{{ delivery.type|default:'' }}">
                                </div>
                                <div class="col-md-1">
                                    <small class="text-muted d-md-none">目的地</small>
                                    <input type="text" class="form-control form-control-sm" 
                                        name="deliverys[{{ forloop.counter0 }}][destination]" 
                                        value="{{ delivery.destination|default:'' }}">
                                </div>
                                <div class="col-md-1">
                                    <small class="text-muted d-md-none">单价</small>
                                    <input type="number" class="form-control form-control-sm price-input" step="0.1"
                                        name="deliverys[{{ forloop.counter0 }}][cost]" 
                                        value="{{ delivery.cost|default:0 }}">
                                </div>
                                <div class="col-md-1">
                                    <small class="text-muted d-md-none">板数</small>
                                    <input type="number" class="form-control form-control-sm quantity-input" step="0.1"
                                        name="deliverys[{{ forloop.counter0 }}][total_pallet]" 
                                        value="{{ delivery.total_pallet|default:0 }}">
                                </div>
                                <div class="col-md-1">
                                    <small class="text-muted d-md-none">体积(CBM)</small>
                                    <input type="number" class="form-control form-control-sm" step="0.01"
                                        name="deliverys[{{ forloop.counter0 }}][total_cbm]" 
                                        value="{{ delivery.total_cbm|default:0 }}">
                                </div>
                                <div class="col-md-1">
                                    <small class="text-muted d-md-none">重量(LBS)</small>
                                    <input type="number" class="form-control form-control-sm" step="0.1"
                                        name="deliverys[{{ forloop.counter0 }}][total_weight_lbs]" 
                                        value="{{ delivery.total_weight_lbs|default:0 }}">
                                </div>
                                <div class="col-md-2">
                                    <small class="text-muted d-md-none">总费用</small>
                                    <input type="number" class="form-control form-control-sm total-input" step="0.01"
                                        name="deliverys[{{ forloop.counter0 }}][total_cost]" 
                                        value="{{ delivery.total_cost|default:0 }}">
                                </div>
                                <div class="col-md-4">
                                    <small class="text-muted d-md-none">备注</small>
                                    <input type="text" class="form-control form-control-sm"
                                        name="deliverys[{{ forloop.counter0 }}][note]" 
                                        value="{{ delivery.note|default:'' }}">
                                    <button type="button" class="btn btn-sm btn-outline-danger mt-1" onclick="removeFeeRow(this, 'delivery')">
                                        <i class="bi bi-trash"></i> 删除
                                    </button>
                                </div>
                            </div>
                            {% endfor %}
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div> 
</div>
</form>
<form method="post" action="" class="mb-0">
    {% csrf_token %}
    <input type="hidden" name="container_number" value="{{ container_number }}">
    <input type="hidden" name="invoice_number" value="{{ invoice_number }}">
    <input type="hidden" name="step" value="dismiss">
    <input type="hidden" name="invoice_type" value="receivable">
    <input type="hidden" name="start_date" value="{{ start_date }}">
    <input type="hidden" name="end_date" value="{{ end_date }}">
    <input type="hidden" name="start_date_confirm" value="{{ start_date_confirm }}">
    <input type="hidden" name="end_date_confirm" value="{{ end_date_confirm }}">
    <div class="card mb-3 shadow-sm">
        <div class="card-header bg-danger text-white p-2">
            <h6 class="mb-0">
                <i class="bi bi-x-circle me-1"></i>
                驳回账单
            </h6>
        </div>
        <div class="card-body p-3">
            <div class="row align-items-center">
                <div class="col-md-4 mb-2 mb-md-0">
                    <label class="form-label">驳回原因:</label>
                    <select class="form-select" name="status" id="rejectPhase" required>
                        <option value="">-- 请选择驳回阶段 --</option>
                        <option value="preport">港前问题</option>
                        <option value="warehouse">库内问题</option>
                        <option value="delivery">派送问题</option>
                    </select>
                </div>
                <div class="col-md-4 mb-2 mb-md-0" id="warehouseTypeContainer" style="display:none;">
                    <label class="form-label">仓库类型:</label>
                    <select class="form-select" name="reject_type" id="warehouseType">
                        <option value="">-- 请选择仓库类型 --</option>
                        <option value="public">公仓</option>
                        <option value="other">私仓</option>
                    </select>
                </div>
                <div class="col-md-6 mb-2 mb-md-0">
                    <label class="form-label">驳回说明:</label>
                    <input type="text" class="form-control" name="reject_reason" placeholder="请输入具体驳回原因..." required>
                </div>
                <div class="col-md-2">
                    <button type="submit" class="btn btn-danger w-100">
                        <i class="bi bi-x-circle me-1"></i> 驳回
                    </button>
                </div>
            </div>
        </div>
    </div>
</form>

<!--组合柜和非组合柜区域-->
<div class="card mb-3 shadow-sm">
    <div class="card-header bg-light text-dark p-2">
        <h6 class="mb-0 fw-bold fs-5 text-white bg-primary px-2 py-1 rounded d-inline-block">
            <i class="bi bi-list-check me-1"></i>
            区域详情展示
        </h6>
    </div>
    <div class="card-body p-3">
        <div class="row">
            <!-- 组合柜区域 -->
            <div class="col-md-6 mb-3 mb-md-0">
                <div class="card h-100 border-primary">
                    <div class="card-header bg-primary text-white py-2">
                        <h6 class="mb-0">
                            <i class="bi bi-collection me-2"></i>
                            组合柜区域
                        </h6>
                    </div>
                    <div class="card-body">
                        {% if destination_matches %}
                            <ul class="list-group list-group-flush">
                                {% for dest in destination_matches %}
                                    <li class="list-group-item d-flex justify-content-between align-items-center py-2">
                                        {{ dest }}
                                        <span class="badge bg-primary rounded-pill">
                                            <i class="bi bi-check-circle me-1"></i>
                                            已匹配
                                        </span>
                                    </li>
                                {% endfor %}
                            </ul>
                        {% else %}
                            <div class="alert alert-warning mb-0 py-2">
                                <i class="bi bi-exclamation-triangle me-2"></i>
                                无组合柜区域数据
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- 非组合柜区域 -->
            <div class="col-md-6">
                <div class="card h-100 border-warning">
                    <div class="card-header bg-warning text-dark py-2">
                        <h6 class="mb-0">
                            <i class="bi bi-box-seam me-2"></i>
                            非组合柜区域
                        </h6>
                    </div>
                    <div class="card-body">
                        {% if non_combina_dests %}
                            <ul class="list-group list-group-flush">
                                {% for dest in non_combina_dests %}
                                    <li class="list-group-item d-flex justify-content-between align-items-center py-2">
                                        {{ dest }}
                                        <span class="badge bg-warning text-dark rounded-pill">
                                            <i class="bi bi-info-circle me-1"></i>
                                            非组合
                                        </span>
                                    </li>
                                {% endfor %}
                            </ul>
                        {% else %}
                            <div class="alert alert-success mb-0 py-2">
                                <i class="bi bi-check-circle me-2"></i>
                                无非组合柜区域
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<style>
    .card {
        border-radius: 5px;
    }
    .card-header {
        border-radius: 5px 5px 0 0 !important;
    }
    .table th, .table td {
        padding: 0.3rem;
    }
    .badge {
        font-size: 0.75em;
        padding: 0.25em 0.4em;
    }
    .border-end {
        border-right: 1px solid #dee2e6;
    }
</style>
<script>
    function showAddFeeModal() {
        document.getElementById('feeTypeModal').style.display = 'block';
    }
    function hideAddFeeModal() {
        document.getElementById('feeTypeModal').style.display = 'none';
    }

    function addFeeRow(feeType) {
        let containerId, namePrefix, index;
        switch(feeType) {
            case 'port':
                containerId = 'portFeesContainer';
                namePrefix = 'port_fees';
                index = document.querySelectorAll('#portFeesContainer .row.align-items-center.mb-2.g-2').length;
                break;
            case 'warehouse':
                containerId = 'warehouseFeesContainer';
                namePrefix = 'warehouse_fees';
                index = document.querySelectorAll('#warehouseFeesContainer .row.align-items-center.mb-2.g-2').length;
                break;
            case 'delivery':
                containerId = 'deliveryFeesContainer';
                namePrefix = 'deliverys';
                index = document.querySelectorAll('#deliveryFeesContainer .row.align-items-center.mb-2.g-2').length;
                break;
            default:
                return;
        }

        const container = document.getElementById(containerId);     

        let newRow;

        if (feeType === 'port' || feeType === 'warehouse') {
            newRow = document.createElement('div');
            newRow.className = 'row align-items-center mb-2 g-2';
            newRow.innerHTML = `
                <div class="col-md-3">
                    <small class="text-muted d-md-none">费用名称</small>
                    <input type="text" class="form-control form-control-sm name-input" 
                        name="${namePrefix}[${index}][name]" value="" placeholder="输入费用名称">
                </div>
                <div class="col-md-2">
                    <small class="text-muted d-md-none">单价</small>
                    <input type="number" class="form-control form-control-sm price-input" step="0.01" 
                        name="${namePrefix}[${index}][price]" value="0">
                </div>
                <div class="col-md-1">
                    <small class="text-muted d-md-none">数量</small>
                    <input type="number" class="form-control form-control-sm quantity-input" step="0.1" 
                        name="${namePrefix}[${index}][quantity]" value="0">
                </div>
                <div class="col-md-2">
                    <small class="text-muted d-md-none">附加费</small>
                    <input type="number" class="form-control form-control-sm surcharge-input" step="0.01"
                        name="${namePrefix}[${index}][surcharge]" value="0">
                </div>
                <div class="col-md-2">
                    <small class="text-muted d-md-none">总价</small>
                    <input type="number" class="form-control form-control-sm total-input" readonly
                        name="${namePrefix}[${index}][value]" value="0">
                </div>                      
                <div class="col-md-2">
                    <small class="text-muted d-md-none">说明</small>
                    <input type="text" class="form-control form-control-sm" 
                        name="${namePrefix}[${index}][surcharge_note]" value="">
                    <button type="button" class="btn btn-sm btn-outline-danger mt-1" onclick="removeFeeRow(this, '${feeType}')">
                        <i class="bi bi-trash"></i> 删除
                    </button>
                </div>
            `;
        } else if (feeType === 'delivery') {
            newRow = document.createElement('div');
            newRow.className = 'row align-items-center mb-2 g-2';
            newRow.innerHTML = `
                <div class="col-md-1">
                    <small class="text-muted d-md-none">派送类型</small>
                    <input type="text" class="form-control form-control-sm" 
                        name="${namePrefix}[${index}][type]" value="">
                </div>
                <div class="col-md-1">
                    <small class="text-muted d-md-none">目的地</small>
                    <input type="text" class="form-control form-control-sm" 
                        name="${namePrefix}[${index}][destination]" value="">
                </div>
                <div class="col-md-1">
                    <small class="text-muted d-md-none">单价</small>
                    <input type="number" class="form-control form-control-sm price-input" step="0.1"
                        name="${namePrefix}[${index}][cost]" value="0">
                </div>
                <div class="col-md-1">
                    <small class="text-muted d-md-none">板数</small>
                    <input type="number" class="form-control form-control-sm quantity-input" step="0.1"
                        name="${namePrefix}[${index}][total_pallet]" value="0">
                </div>
                <div class="col-md-1">
                    <small class="text-muted d-md-none">体积(CBM)</small>
                    <input type="number" class="form-control form-control-sm" step="0.01"
                        name="${namePrefix}[${index}][total_cbm]" value="0">
                </div>
                <div class="col-md-1">
                    <small class="text-muted d-md-none">重量(LBS)</small>
                    <input type="number" class="form-control form-control-sm" step="0.1"
                        name="${namePrefix}[${index}][total_weight_lbs]" value="0">
                </div>
                <div class="col-md-2">
                    <small class="text-muted d-md-none">总费用</small>
                    <input type="number" class="form-control form-control-sm total-input" step="0.01"
                        name="${namePrefix}[${index}][total_cost]" value="0">
                </div>
                <div class="col-md-4">
                    <small class="text-muted d-md-none">备注</small>
                    <input type="text" class="form-control form-control-sm"
                        name="${namePrefix}[${index}][note]" value="">
                    <button type="button" class="btn btn-sm btn-outline-danger mt-1" onclick="removeFeeRow(this, '${feeType}')">
                        <i class="bi bi-trash"></i> 删除
                    </button>
                </div>
            `;
        }

        container.appendChild(newRow);
        
        // 为新增行的输入框添加事件监听
        const inputs = newRow.querySelectorAll('.price-input, .quantity-input, .surcharge-input');
        inputs.forEach(input => {
            input.addEventListener('input', function() {
                const row = this.closest('.row.align-items-center.mb-2.g-2');
                if (row) {
                    calculateFeeTotal(row);
                    updateTotalAmount();
                }
            });
        });

        // 隐藏模态框
        hideAddFeeModal();
    }

    function removeFeeRow(button, feeType) {
        const row = button.closest('.row.align-items-center.mb-2.g-2');
        if (row) {
            row.remove();
            updateTotalAmount();
        }
    }
    document.addEventListener('DOMContentLoaded', function() {
        const rejectPhase = document.getElementById('rejectPhase');
        const warehouseTypeContainer = document.getElementById('warehouseTypeContainer');
        const warehouseType = document.getElementById('warehouseType');

        rejectPhase.addEventListener('change', function() {
            if (this.value === 'warehouse' || this.value === 'delivery') {
                warehouseTypeContainer.style.display = 'block';
                warehouseType.required = true;
                warehouseType.name = "delivery_type";
            } else {
                warehouseTypeContainer.style.display = 'none';
                warehouseType.required = false;
                warehouseType.name = "reject_type";
            }
        });
    });
    function shouldCalculateDeliveryTotal(type) {
        // 这些类型不自动计算
        const noCalcTypes = ["自发", "UPS", "本地派送","客户自提","selfpickup"];
        return !noCalcTypes.includes(type);
    }
    document.querySelectorAll('.total-input').forEach(input => {
        if (!input.readOnly) { 
            input.addEventListener('input', updateTotalAmount);
        }
    });
    //计算每个费用的总价
    function calculateFeeTotal(row) {
        const typeInput = row.querySelector('input[name*="[type]"]');
        const totalInput = row.querySelector('.total-input');
        if (typeInput) {  //判断是不是额外费用的派送费用
            const type = typeInput.value.trim();
            const price = parseFloat(row.querySelector('.price-input').value) || 0;
            const quantity = parseFloat(row.querySelector('.quantity-input').value) || 0;
            const totalInput = row.querySelector('.total-input');
            
            if (shouldCalculateDeliveryTotal(type) && totalInput) {
                const total = price * quantity;
                totalInput.value = total.toFixed(2);
                return total;
            }
            return parseFloat(totalInput ? totalInput.value : 0) || 0;
        } else {
            const price = parseFloat(row.querySelector('.price-input').value) || 0;
            const quantity = parseFloat(row.querySelector('.quantity-input').value) || 0;

            const surchargeInput = row.querySelector('.surcharge-input');
            const surcharge = surchargeInput ? parseFloat(surchargeInput.value) || 0 : 0;
            const total = (price * quantity) + surcharge;
            const totalInput = row.querySelector('.total-input');
            if (totalInput) {
                totalInput.value = total.toFixed(2);
            }
            return total;
        }     
    }

    function calculateExtraFeesTotal() {
        let extraTotal = 0;
        document.querySelectorAll('.row.align-items-center.mb-2.g-2').forEach(row => {
            extraTotal += calculateFeeTotal(row);
        });
        return extraTotal;
    }

    // 为所有单价和数量输入框添加事件监听
    document.addEventListener('DOMContentLoaded', function() {
        // 为所有单价、数量和附加费输入框添加事件监听
        document.querySelectorAll('.price-input, .quantity-input, .surcharge-input, input[name*="[type]"]').forEach(input => {
            input.addEventListener('input', function() {
                const row = this.closest('.row.align-items-center.mb-2.g-2');
                if (row) {
                    calculateFeeTotal(row);
                    updateTotalAmount();
                }
            });
        });

        // 初始化计算所有费用
        updateTotalAmount();
    });

    document.addEventListener('DOMContentLoaded', function() {
        const currentPalletsInput = document.getElementById('current_pallets');
        const limitPalletsInput = document.getElementById('limit_pallets'); 
        const overpalletFeeInput = document.getElementById('overpallet_fee');
        const maxPriceRow = document.querySelector('tr.table-success');
        const palletPrice = maxPriceRow ? parseFloat(maxPriceRow.querySelector('td.text-end').textContent.replace('$', '')) : 0;
        function calculateOverpalletFee() {
            const currentPallets = parseFloat(currentPalletsInput.value) || 0;
            const limitPallets = parseFloat(limitPalletsInput.value) || 0;
            const overCount = currentPallets - limitPallets;
            document.getElementById("overCountDisplay").textContent = overCount;
            if (overCount > 0) {
                overpalletFeeInput.value = (overCount * palletPrice).toFixed(2);
            } else {
                overpalletFeeInput.value = "0.00";
            }
            
            updateTotalAmount();
        }
        if (currentPalletsInput && limitPalletsInput) {
            currentPalletsInput.addEventListener('input', calculateOverpalletFee);
            limitPalletsInput.addEventListener('input', calculateOverpalletFee);
        }

        const overregionDeliveryPriceInput = document.getElementById('overregion_delivery_price');
        const overregionDeliveryPalletInput = document.getElementById('overregion_delivery_pallet');
        const overregion_delivery_fee = document.getElementById('overregion_delivery_fee');
        if (overregionDeliveryPriceInput&&overregionDeliveryPalletInput) {
            overregionDeliveryPriceInput.addEventListener('input', calculateOverregionFee);
            overregionDeliveryPalletInput.addEventListener('input', calculateOverregionFee);
        }
        function calculateOverregionFee(){
            const deliveryPrice = parseFloat(overregionDeliveryPriceInput.value) || 0;
            const deliveryPallet = parseFloat(overregionDeliveryPalletInput.value) || 0;
            overregion_delivery_fee.value = (deliveryPrice * deliveryPallet).toFixed(2);
            updateTotalAmount();
        }

        const overregionPickupBaseFeeInput = document.getElementById('overregion_pickup_base_fee');
        const overregionPickupCbmInput = document.getElementById('overregion_pickup_cbm');
        const overregion_pickup_fee = document.getElementById('overregion_pickup_fee');

        const totalCbmDisplay = document.querySelector('#total-cbm-container strong');
        if (totalCbmDisplay) totalCbmText = totalCbmDisplay.textContent;
        if (overregionPickupBaseFeeInput&&overregionPickupCbmInput) {
            overregionPickupBaseFeeInput.addEventListener('input', calculateOverregionPickup);
            overregionPickupCbmInput.addEventListener('input', calculateOverregionPickup);
        }
        function calculateOverregionPickup(){
            const pickupBaseFee = parseFloat(overregionPickupBaseFeeInput.value) || 0;
            const pickupCbm = parseFloat(overregionPickupCbmInput.value) || 0;
            const amountCbm = parseFloat(totalCbmText) || 0;
            overregion_pickup_fee.value = (pickupBaseFee * pickupCbm / amountCbm).toFixed(2);
            updateTotalAmount();
        }

        const totalAmountDisplay = document.getElementById('totalAmountDisplay');
        const totalAmount = document.getElementById('totalAmount');
        const base_fee = document.getElementById('base_fee');
        const overpallet_fee = document.getElementById('overpallet_fee');
        const overweight_fee = document.getElementById('overweight_fee');
    
        [base_fee, overweight_fee, overpallet_fee, overregion_pickup_fee, overregion_delivery_fee].forEach(input => {
            if (input) {
                input.addEventListener('input', updateTotalAmount);
            }
        });
        updateTotalAmount();
    });
    function updateTotalAmount() {
        const getSafeNumberValue = (elementId) => {
            const element = document.getElementById(elementId);
            return element ? parseFloat(element.value) || 0 : 0;
        };
        let amount = 0;

        amount += getSafeNumberValue('base_fee');
        amount += getSafeNumberValue('overpallet_fee');
        amount += getSafeNumberValue('overweight_fee');
        amount += getSafeNumberValue('overregion_pickup_fee');
        amount += getSafeNumberValue('overregion_delivery_fee');
        amount += calculateExtraFeesTotal();
        
        const totalDisplay = document.getElementById('totalAmountDisplay');
        if (totalDisplay) totalDisplay.textContent = amount.toFixed(2);
        
        const totalInput = document.getElementById('totalAmount');
        if (totalInput) totalInput.value = amount.toFixed(2);       
    }
    function modifyStatus(type) {
        const saveTypeInput = document.getElementById('save_type');
        saveTypeInput.value = type; 
    }
</script>
{% endblock %}