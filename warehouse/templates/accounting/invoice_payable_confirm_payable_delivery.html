{% extends 'base.html' %}
{% load custom_filters %}
{% block content %}
    <style>
        /* 复用第一个页面的核心样式变量 */
        :root {
            --primary-color: #1b5e20;
            --secondary-color: #0d3d14;
            --success-color: #2e7d32;
            --warning-color: #ff6f00;
            --danger-color: #b71c1c;
            --light-bg: #f8f9fa;
            --card-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            --border-radius: 12px;
        }

        /* 整体容器样式 */
        .finance-system {
            max-width: 102%;
            margin: 20px auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
            overflow: hidden;
        }

        /* 头部筛选区域 */
        .finance-header {
            background: linear-gradient(135deg, #0d3d14, #1b5e20);
            color: white;
            padding: 25px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        /* 修复：所有费用列（包括其他/总费用）居中对齐 */
        .td, .td_fee, .td_fee_other, .td_fee_total {
            text-align: center !important;
            vertical-align: middle !important;
            min-height: 20px !important;
            line-height: 20px !important;
            position: relative !important;
        }

        /* 其他/总费用的合计文字也居中 */
        .fee-total {
            display: flex !important;
            justify-content: center !important;
            align-items: center !important;
            width: 100% !important;
        }

        /* 修复：其他/总费用无内容时也显示$0.00 */
        .td_fee_other:empty::after,
        .td_fee_other:not(:has(.total-amount))::after,
        .td_fee_total:empty::after,
        .td_fee_total:not(:has(.total-amount))::after {
            content: "$0.00" !important;
            display: inline-block !important;
            color: inherit !important;
            position: absolute !important;
            top: 50% !important;
            left: 50% !important;
            transform: translate(-50%, -50%) !important;
        }

        /* 确保金额span覆盖伪元素 */
        .td_fee_other .total-amount,
        .td_fee_total .total-amount {
            position: relative !important;
            z-index: 1 !important;
            background: white !important;
            padding: 0 2px !important;
        }

        /* 派送账单输入框+按钮同行显示 */
        .delivery-input-group {
            display: flex;
            align-items: center;
            gap: 5px; /* 输入框和按钮之间的间距 */
            width: 100%;
        }

        .delivery-input-group input {
            flex: 1; /* 输入框占满剩余空间 */
            min-width: 0; /* 解决flex布局下输入框宽度溢出 */
        }

        .delivery-input-group .btn {
            flex-shrink: 0; /* 按钮不被挤压 */
            padding: 4px 8px !important;
            font-size: 0.75rem !important;
            height: auto !important;
        }

        /* 新增：操作按钮容器（表格左下方） */
        .table-actions {
            padding: 15px 20px;
            display: flex;
            gap: 15px;
            align-items: center;
            background: var(--light-bg);
            border-top: 1px solid #eaecef;
        }

        /* 新增：回到底部按钮样式 */
        .to-bottom-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 999;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--primary-color);
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            transition: all 0.3s ease;
        }

        .to-bottom-btn:hover {
            background: var(--secondary-color);
            transform: translateY(-2px);
        }

        .filter-controls {
            display: flex;
            align-items: center;
            gap: 45px;
            width: 100%;
            justify-content: flex-start;
        }

        .filter-group {
            display: flex;
            align-items: flex-end;
            gap: 10px;
        }

        .filter-group label {
            font-weight: 600;
            font-size: 0.9rem;
            width: 100%;
        }

        /* 标签页样式 */
        .content-tabs {
            display: flex;
            margin-bottom: 25px;
            border-bottom: 2px solid #eaecef;
            gap: 5px;
        }

        .content-tab {
            padding: 15px 30px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            font-weight: 500;
            position: relative;
            background: var(--light-bg);
            border-radius: 8px 8px 0 0;
        }

        .content-tab.active {
            background: white;
            color: var(--primary-color);
            border-bottom: 3px solid var(--primary-color);
            font-weight: 600;
        }

        .content-tab .tab-badge {
            position: absolute;
            top: 8px;
            right: 8px;
            background: var(--primary-color);
            color: white;
            border-radius: 12px;
            padding: 2px 8px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .tab-content {
            display: none;
            background: white;
            border-radius: 0 0 var(--border-radius) var(--border-radius);
            min-height: 500px;
        }

        .tab-content.active {
            display: block;
        }

        /* 子标签页样式 */
        .sub-content-tabs {
            display: flex;
            margin: 15px 0;
            border-bottom: 2px solid #eaecef;
            gap: 5px;
        }

        .sub-content-tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            font-weight: 500;
            position: relative;
            background: var(--light-bg);
            border-radius: 8px 8px 0 0;
            font-size: 0.9rem;
        }

        .sub-content-tab.active {
            background: white;
            color: var(--primary-color);
            border-bottom: 3px solid var(--primary-color);
            font-weight: 600;
        }

        /* 容器区域样式 */
        .container-section {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--card-shadow);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            margin-bottom: 25px;
            border: 1px solid #f0f0f0;
            position: relative;
        }

        .section-header {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            padding: 20px;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .section-header h3 {
            margin: 0;
            color: var(--secondary-color);
            font-size: 1.2rem;
            font-weight: 600;
        }

        .section-count {
            background: var(--primary-color);
            color: white;
            border-radius: 20px;
            padding: 4px 12px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        /* 表格样式 */
        .table-container {
            overflow-x: auto;
            overflow-y: auto;
            flex: 1;
            background: #fafbfc;
            max-height: 600px;
        }

        .table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            font-size: 14px;
            background: white;
            table-layout: fixed;
        }

        .th {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            padding: 18px 14px 18px 20px;
            text-align: center;
            font-weight: 700;
            border-bottom: 2px solid #dee2e6;
            position: sticky;
            top: 0;
            z-index: 10;
            color: var(--secondary-color);
            font-size: 0.95rem;
            border-right: 1px solid #e9ecef;
            height: 50px;
        }

        .th:last-child {
            border-right: none;
        }

        .td {
            padding: 18px 14px 18px 20px;
            border-bottom: 1px solid #f0f0f0;
            vertical-align: middle;
            transition: all 0.2s ease;
            border-right: 1px solid #f5f5f5;
            font-size: 14px;
            height: 60px;
            line-height: 1.5;
            text-align: center;
        }

        .td:last-child {
            border-right: none;
        }

        .table tbody tr {
            transition: all 0.2s ease;
            height: 60px;
        }

        .table tbody tr:hover {
            background: linear-gradient(135deg, #f8f9fa, #f0f4f8);
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1);
            transform: translateY(-1px);
        }

        /* 搜索行样式 */
        .search-row .th {
            background: #e9ecef;
            position: sticky;
            top: 50px;
            z-index: 9;
            padding: 4px 14px 4px 20px !important;
            height: 30px;
        }

        .search-input {
            width: 100%;
            padding: 4px 8px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 12px;
            box-sizing: border-box;
            transition: all 0.3s ease;
            background: white;
            height: 26px;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(27, 94, 32, 0.1);
        }

        /* 按钮样式 */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .btn-sm {
            padding: 0.375rem 0.75rem;
            font-size: 0.875rem;
            border-radius: 6px;
        }

        .btn-primary {
            background: #007bff;
            color: white;
        }

        .btn-primary:hover {
            background: #0069d9;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .btn-success {
            background: var(--success-color);
            color: white;
        }

        .btn-success:hover {
            background: #219652;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .btn-danger {
            background: var(--danger-color);
            color: white;
        }

        .btn-danger:hover {
            background: #d32f2f;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .btn-info {
            background: #17a2b8;
            color: white;
        }

        .btn-info:hover {
            background: #138496;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .btn-warning {
            background: var(--warning-color);
            color: white;
        }

        .btn-warning:hover {
            background: #e65c00;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        /* 表单控件样式 */
        select, input[type="date"], input[type="text"], textarea {
            padding: 8px 15px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            background: white;
            font-size: 0.95rem;
            min-width: 150px;
            transition: all 0.3s ease;
        }

        select:focus, input[type="date"]:focus, input[type="text"]:focus, textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(27, 94, 32, 0.1);
        }

        textarea {
            width: 100%;
            min-height: 100px;
            resize: vertical;
        }

        /* 提示框样式 */
        .alert {
            padding: 15px;
            margin: 20px 0;
            border: 1px solid transparent;
            border-radius: 8px;
            font-size: 0.95rem;
            text-align: center;
        }

        .alert-info {
            color: #0c5460;
            background-color: #d1ecf1;
            border-color: #bee5eb;
        }

        /* 模态框样式 */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.4);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 10% auto;
            padding: 30px;
            border: 1px solid #888;
            width: 50%;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
        }

        .modal-content h5 {
            margin-top: 0;
            color: var(--secondary-color);
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 20px;
        }

        /* 链接样式 */
        .container-link {
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s ease;
            padding: 3px 6px;
            border-radius: 4px;
            font-size: 14px;
        }

        .container-link:hover {
            text-decoration: underline;
            background: rgba(27, 94, 32, 0.1);
        }

        /* 操作按钮区域 - 隐藏原有按钮 */
        .action-buttons {
            display: none !important;
        }

        /* 导出控件样式 - 核心修改：解决换行问题 */
        .export-controls {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 12px 20px;
            background: var(--light-bg);
            border-radius: 8px;
            margin: 15px 0;
            /* 核心：强制不换行，且设置最小宽度避免挤压 */
            flex-wrap: nowrap;
            white-space: nowrap;
            width: 100%;
            box-sizing: border-box;
            align-items: center !important;
        }

        .export-controls h6 {
            margin: 0 !important;
            white-space: nowrap;
            font-size: 0.9rem;
            /* 固定标题宽度，避免挤压 */
            width: 80px;
            flex-shrink: 0;
        }

        .export-controls .export-filter-form {
            display: flex;
            align-items: center !important;
            gap: 15px;
            width: auto !important;
            margin: 0;
            padding: 0;
            /* 允许表单区域自适应，不强制100%宽度 */
            flex-grow: 0;
            flex-shrink: 0;
        }

        /* 核心修改：供应商类型筛选组 - 强制单行 */
        .export-controls .filter-group {
            display: flex;
            align-items: center !important;
            gap: 8px;
            margin: 0;
            padding: 0;
            /* 强制不换行，固定行高 */
            white-space: nowrap;
            height: 38px;
            align-items: center !important;
        }

        .export-controls .filter-group label {
            margin: 0;
            padding: 0;
            font-size: 0.85rem;
            white-space: nowrap;
            /* 固定标签宽度，避免换行 */
            width: 70px;
            text-align: right;
            flex-shrink: 0;
        }

        .export-controls select,
        .export-controls input[type="date"] {
            min-width: 120px !important;
            width: 120px !important;
            padding: 6px 10px;
            font-size: 0.85rem;
            height: 32px;
            /* 禁止拉伸，固定宽度 */
            flex-shrink: 0;
        }

        /* ========== 重点修改：查询和导出按钮样式 ========== */
        .export-controls .btn {
            white-space: nowrap;
            height: 38px;
            padding: 0 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.85rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            /* 按钮固定宽度，避免挤压 */
            flex-shrink: 0;
        }

        /* 查询按钮样式强化 */
        .query-btn {
            background: var(--primary-color) !important;
            color: white !important;
            font-weight: 600 !important;
            min-width: 80px !important;
        }

        .query-btn:hover {
            background: var(--secondary-color) !important;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15) !important;
        }

        /* 导出勾选按钮样式强化 */
        .export-selected-btn {
            background: #28a745 !important;
            color: white !important;
            font-weight: 600 !important;
            min-width: 100px !important;
        }

        .export-selected-btn:hover {
            background: #218838 !important;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15) !important;
        }

        /* ========== 按钮样式修改结束 ========== */

        /* 费用合计样式 */
        .fee-total {
            font-weight: 600;
            color: var(--danger-color);
        }

        /* 响应式适配 */
        @media (max-width: 1400px) {
            .finance-header {
                padding: 20px;
            }

            .filter-controls {
                gap: 15px;
            }

            /* 响应式时导出控件允许换行（避免移动端挤压） */
            .export-controls {
                flex-wrap: wrap;
            }

            .export-controls .export-filter-form {
                width: 100% !important;
                margin-top: 10px;
            }

            /* 响应式时固定按钮换行 */
            .table-actions {
                flex-wrap: wrap;
            }

            .to-bottom-btn {
                width: 40px;
                height: 40px;
                bottom: 20px;
                right: 20px;
            }
        }

        @media (max-width: 768px) {
            .finance-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .content-tabs, .sub-content-tabs {
                flex-wrap: wrap;
            }

            .content-tab, .sub-content-tab {
                flex: 1;
                min-width: 120px;
                text-align: center;
                padding: 12px 15px;
            }

            .modal-content {
                width: 90%;
            }

            .btn {
                width: 100%;
            }

            /* 移动端导出控件堆叠显示 */
            .export-controls {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .export-controls h6 {
                width: 100%;
                text-align: left;
            }

            .export-controls .export-filter-form {
                flex-direction: column;
                align-items: flex-start;
                width: 100%;
            }

            .export-controls .filter-group {
                width: 100%;
                height: auto;
            }

            .export-controls .filter-group label {
                width: 100%;
                text-align: left;
                margin-bottom: 5px;
            }

            .export-controls select,
            .export-controls input[type="date"] {
                width: 100%;
                min-width: unset;
            }

            .export-controls .btn {
                width: 100%;
            }
        }

        /* 勾选列样式 */
        .export-checkbox-col {
            width: 50px !important;
            min-width: 50px !important;
            text-align: center !important;
        }

        .export-select-all-container {
            padding: 10px 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            background: var(--light-bg);
            border-bottom: 1px solid #eaecef;
        }

        .export-selected-count {
            color: var(--primary-color);
            font-weight: 600;
        }
    </style>

    <div class="finance-system">
        <!-- 头部筛选区域 -->
        <div class="finance-header">
            <div class="finance-logo">
                <i class="fas fa-file-invoice-dollar"></i>
                <span>待确认账单管理-派送账单</span>
            </div>
            <form method="post" action="" class="filter-controls">
                {% csrf_token %}
                <div class="filter-group">
                    <label><i class="fas fa-user"></i> 客户:</label>
                    <!-- 修复：直接渲染表单控件，删除错误的if判断 -->
                    {{ order_form.customer_name }}
                    <script>
                        document.addEventListener('DOMContentLoaded', function () {
                            const customerSelect = document.getElementById('id_customer_name');
                            const selectedCustomerId = "{{ selected_customer_id|default:'' }}";
                            if (selectedCustomerId && customerSelect) {
                                // 确保选项存在再赋值，避免报错
                                const option = customerSelect.querySelector(`option[value="${selectedCustomerId}"]`);
                                if (option) {
                                    customerSelect.value = selectedCustomerId;
                                }
                            }
                        });
                    </script>
                </div>
                <div class="filter-group">
                    <label>
                        {% if invoice_type_filter == 'payable' %}
                            <i class="fas fa-calendar-alt"></i> ETD时间:
                        {% endif %}
                    </label>
                    <input type="date" name="start_date_confirm" value="{{ start_date_confirm }}">
                    <input type="date" name="end_date_confirm" value="{{ end_date_confirm }}">
                </div>
                <div class="filter-group">
                    <label><i class="fas fa-warehouse"></i> 仓点区域:</label>
                    <select name="warehouse_filter">
                        {% for k, v in warehouse_options.items %}
                            <option value="{{ v }}" {% if warehouse_filter == v %}selected{% endif %}>{{ k }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="filter-group">
                    <label><i class="fas fa-file-invoice"></i> 账单类型:</label>
                    <select name="invoice_type">
                        <option value="payable" {% if invoice_type_filter == 'payable' %}selected{% endif %}>应付账单
                        </option>
                    </select>
                </div>
                <input type="hidden" name="step" value="invoice_order_confirm_payable_delivery">
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-search"></i> 查询
                </button>
            </form>
        </div>

        <!-- 主内容区域 -->
        <div style="padding: 25px;">
            <!-- 主标签页 -->
            <div class="content-tabs" id="billTypeTabs">
                <div class="content-tab" data-tab="delivery">
                    派送账单
                </div>
            </div>
            <!-- 派送账单内容 -->
            <div id="delivery-content" class="tab-content">
                <div class="container-section">
                    <div class="section-header">
                        <h3>派送账单</h3>
                    </div>

                    <!-- 子标签页 -->
                    <div class="sub-content-tabs">
                        <div class="sub-content-tab active" data-subtab="delivery-pending">
                            待确认 <span class="tab-badge">{{ delivery_pending_orders|length }}</span>
                        </div>
                        <div class="sub-content-tab" data-subtab="delivery-confirm">
                            已确认 <span class="tab-badge">{{ delivery_confirm_orders|length }}</span>
                        </div>
                    </div>

                    <!-- 待确认派送账单 -->
                    <div id="delivery-pending" class="tab-content active">
                        <div class="table-container">
                            {% if delivery_pending_orders %}
                                <div class="export-controls" style="margin-top: 15px;">
                                    <h6><b>待确认导出：</b></h6>
                                    <!-- 全选区域 -->
                                    <div class="export-select-all-container" style="margin-right: 15px;">
                                        <input type="checkbox" id="delivery-pending-select-all"
                                               onclick="toggleSelectAll('delivery-pending-select-all', 'delivery-pending-checkbox')"
                                               style="width: 18px; height: 18px; cursor: pointer;">
                                        <label for="delivery-pending-select-all"
                                               style="margin: 0; font-weight: 500; cursor: pointer;">全选</label>
                                        <span class="export-selected-count" id="delivery-pending-selected-count">已选：0 条</span>
                                    </div>
                                    <!-- 待确认导出表单 - 传递fleet_number -->
                                    <form method="post" class="export-filter-form" id="delivery-pending-export-form"
                                          onsubmit="return collectSelectedPendingFleetIds()">
                                        {% csrf_token %}
                                        <input type="hidden" name="step" value="export_carrier_payable_delivery">
                                        <!-- 后端区分待确认/已确认的step -->
                                        <input type="hidden" name="confirm_phase" value="delivery_pending">
                                        <input type="hidden" name="start_date_export" value="{{ start_date_confirm }}">
                                        <input type="hidden" name="end_date_export" value="{{ end_date_confirm }}">
                                        <input type="hidden" name="warehouse_filter" value="{{ warehouse_filter }}">
                                        <input type="hidden" name="customer_name"
                                               value="{{ selected_customer_id|default:'' }}">
                                        <!-- 隐藏字段存储选中的fleet_number -->
                                        <input type="hidden" name="selected_fleet_ids" id="selected_pending_fleet_ids"
                                               value="">
                                        <button type="submit" class="btn btn-warning btn-sm export-selected-btn">
                                            <i class="fas fa-file-excel"></i> 导出待确认Excel
                                        </button>
                                    </form>
                                </div>
                                <form method="post" id="delivery-confirm-form">
                                    {% csrf_token %}
                                    <input type="hidden" name="step" value="payable_confirm_phase">
                                    <input type="hidden" name="confirm_phase" value="delivery">
                                    <table class="table">
                                        <thead>
                                        <tr>
                                            <th class="th export-checkbox-col"
                                                style="vertical-align: middle; width: 50px;">
                                                <input type="checkbox" id="delivery-pending-select-all-header"
                                                       onclick="toggleSelectAll('delivery-pending-select-all-header', 'delivery-pending-checkbox')"
                                                       style="width: 18px; height: 18px; cursor: pointer;">
                                            </th>
                                            <th class="th" style="vertical-align: middle;">车次</th>
                                            <th class="th" style="vertical-align: middle;">Carrier</th>
                                            <th class="th" style="vertical-align: middle;">Pickup Number</th>
                                            <th class="th" style="vertical-align: middle;">ISA</th>
                                            <th class="th" style="vertical-align: middle;">柜号</th>
                                            <th class="th" style="vertical-align: middle;">目的地</th>
                                            <th class="th" style="vertical-align: middle;">板数</th>
                                            <th class="th" style="vertical-align: middle;">价格</th>
                                            <th class="th" style="vertical-align: middle;">单板成本</th>
                                            <th class="th" style="vertical-align: middle;">车次总板数</th>
                                            <th class="th" style="vertical-align: middle;">车次总成本</th>
                                            <th class="th" style="vertical-align: middle;">核销金额</th>
                                            <th class="th" style="vertical-align: middle;">备注</th>
                                        </tr>
                                        </thead>
                                        <tr class="search-row">
                                            <th class="th export-checkbox-col"></th>
                                            <th class="th"><input type="text" class="search-input" data-column-index="1"
                                                                  placeholder="搜索车次"
                                                                  onkeyup="filterDeliveryTable('delivery-pending', this); updateDeliveryPendingSelectAllStatus()">
                                            </th>
                                            <th class="th"><input type="text" class="search-input" data-column-index="2"
                                                                  placeholder="搜索Carrier"
                                                                  onkeyup="filterDeliveryTable('delivery-pending', this); updateDeliveryPendingSelectAllStatus()">
                                            </th>
                                            <th class="th"><input type="text" class="search-input" data-column-index="3"
                                                                  placeholder="搜索Pickup Number"
                                                                  onkeyup="filterDeliveryTable('delivery-pending', this); updateDeliveryPendingSelectAllStatus()">
                                            </th>
                                            <th class="th"><input type="text" class="search-input" data-column-index="4"
                                                                  placeholder="搜索ISA"
                                                                  onkeyup="filterDeliveryTable('delivery-pending', this); updateDeliveryPendingSelectAllStatus()">
                                            </th>
                                            <th class="th"><input type="text" class="search-input" data-column-index="5"
                                                                  placeholder="搜索柜号"
                                                                  onkeyup="filterDeliveryTable('delivery-pending', this); updateDeliveryPendingSelectAllStatus()">
                                            </th>
                                            <th class="th"><input type="text" class="search-input" data-column-index="6"
                                                                  placeholder="搜索目的地"
                                                                  onkeyup="filterDeliveryTable('delivery-pending', this); updateDeliveryPendingSelectAllStatus()">
                                            </th>
                                            <th class="th"><input type="number" class="search-input"
                                                                  data-column-index="7" min="0"
                                                                  placeholder="板数≥"
                                                                  onkeyup="filterDeliveryTable('delivery-pending', this); updateDeliveryPendingSelectAllStatus()">
                                            </th>
                                            <th class="th"></th>
                                            <th class="th"></th>
                                            <th class="th"></th>
                                            <th class="th"></th>
                                            <th class="th"></th>
                                            <th class="th"></th>
                                        </tr>
                                        <tbody>
                                        {% for fleet in delivery_pending_orders %}
                                            {% for pickup_number, pickup_data in fleet.fleets.items %}
                                                {% for appointment_id, appointment_data in pickup_data.appointments.items %}
                                                    {% for order in appointment_data.orders %}
                                                        <tr>
                                                            {% if forloop.parentloop.first and forloop.first %}
                                                                <td class="td export-checkbox-col"
                                                                    rowspan="{{ pickup_data.total_rows }}"
                                                                    style="vertical-align: middle;">
                                                                    <input type="checkbox"
                                                                           class="delivery-pending-checkbox"
                                                                           value="{{ fleet.fleet_id|default:'' }}"
                                                                           data-fleet-id="{{ fleet.fleet_id|default:'' }}"
                                                                           style="width: 16px; height: 16px;">
                                                                </td>
                                                                <td class="td" rowspan="{{ pickup_data.total_rows }}"
                                                                    style="vertical-align: middle;">
                                                                    {{ fleet.fleet_number|default_if_none:"" }}
                                                                </td>
                                                                <td class="td" rowspan="{{ pickup_data.total_rows }}"
                                                                    style="vertical-align: middle;">
                                                                    {{ fleet.carrier|default_if_none:"" }}
                                                                </td>
                                                                <td class="td" rowspan="{{ pickup_data.total_rows }}"
                                                                    style="vertical-align: middle;">
                                                                    {{ pickup_number|default_if_none:"" }}
                                                                </td>
                                                            {% endif %}

                                                            {% if forloop.first %}
                                                                <td class="td" rowspan="{{ appointment_data.rowspan }}"
                                                                    style="vertical-align: middle;">
                                                                    {{ appointment_id|default_if_none:"" }}
                                                                </td>
                                                            {% endif %}

                                                            <td class="td"
                                                                style="vertical-align: middle;">{{ order.container_num }}</td>
                                                            <td class="td"
                                                                style="vertical-align: middle;">{{ order.pallet_destination }}</td>
                                                            <td class="td"
                                                                style="vertical-align: middle;">{{ order.cn_total_pallet }}</td>
                                                            <td class="td"
                                                                style="vertical-align: middle;">{{ order.cn_total_expense }}</td>
                                                            <td class="td"
                                                                style="vertical-align: middle;">{{ order.cn_per_expense }}</td>
                                                            {% if forloop.parentloop.first and forloop.first %}
                                                                <td class="td" rowspan="{{ pickup_data.total_rows }}"
                                                                    style="vertical-align: middle;">
                                                                    {{ pickup_data.ISA_total_pallets }}
                                                                </td>
                                                                <td class="td" rowspan="{{ pickup_data.total_rows }}"
                                                                    style="vertical-align: middle;">
                                                                    ${{ pickup_data.ISA_total_expense }}
                                                                </td>
                                                                <td class="td" rowspan="{{ pickup_data.total_rows }}"
                                                                    style="vertical-align: middle;">
                                                                    <div class="delivery-input-group">
                                                                        <input type="number" name="write_off_amount"
                                                                               class="write-off-amount"
                                                                               data-container-id="{{ order.object.container_number.id }}"
                                                                               step="0.01" min="0"
                                                                               placeholder="输入核销金额"
                                                                               style="padding: 4px 8px; border: 1px solid #ced4da; border-radius: 4px; text-align: center;">
                                                                        <form action="" method="post"
                                                                              class="single-writeoff-form"
                                                                              style="margin: 0;">
                                                                            {% csrf_token %}
                                                                            <input type="hidden" name="step"
                                                                                   value="write_off_amount_post_delivery">
                                                                            <input type="hidden" name="container_id"
                                                                                   value="{{ order.object.container_number.id }}">
                                                                            <input type="hidden" name="write_off_type"
                                                                                   value="pick-x">
                                                                            <input type="hidden"
                                                                                   name="start_date_confirm"
                                                                                   value="{{ start_date_confirm }}">
                                                                            <input type="hidden" name="end_date_confirm"
                                                                                   value="{{ end_date_confirm }}">
                                                                            <input type="hidden" name="warehouse_filter"
                                                                                   value="{{ warehouse_filter }}">
                                                                            <input type="hidden" name="customer_name"
                                                                                   value="{{ selected_customer_id|default:'' }}">
                                                                            <button type="submit"
                                                                                    class="btn btn-success btn-sm">确认
                                                                            </button>
                                                                        </form>
                                                                    </div>
                                                                </td>
                                                                <td class="td" rowspan="{{ pickup_data.total_rows }}"
                                                                    style="vertical-align: middle;">
                                                                    <div class="delivery-input-group">
                                                                        <input type="text" name="note_delivery"
                                                                               class="write-off-amount-note"
                                                                               data-container-id="{{ order.object.container_number.id }}"
                                                                               placeholder="输入备注"
                                                                               value="{{ order.itemv2_data.note }}"
                                                                               style="padding: 4px 8px; border: 1px solid #ced4da; border-radius: 4px; text-align: center;">
                                                                        <form action="" method="post"
                                                                              class="note-submit-form"
                                                                              style="margin: 0;">
                                                                            {% csrf_token %}
                                                                            <input type="hidden" name="step"
                                                                                   value="note_post_delivery">
                                                                            <input type="hidden" name="container_id"
                                                                                   value="{{ order.object.container_number.id }}">
                                                                            <input type="hidden" name="write_off_type"
                                                                                   value="pick-x">
                                                                            <input type="hidden"
                                                                                   name="start_date_confirm"
                                                                                   value="{{ start_date_confirm }}">
                                                                            <input type="hidden" name="end_date_confirm"
                                                                                   value="{{ end_date_confirm }}">
                                                                            <input type="hidden" name="warehouse_filter"
                                                                                   value="{{ warehouse_filter }}">
                                                                            <input type="hidden" name="customer_name"
                                                                                   value="{{ selected_customer_id|default:'' }}">
                                                                            <button type="submit"
                                                                                    class="btn btn-success btn-sm">确认
                                                                            </button>
                                                                        </form>
                                                                    </div>
                                                                </td>
                                                            {% endif %}
                                                        </tr>
                                                    {% endfor %}
                                                {% endfor %}
                                            {% endfor %}
                                        {% endfor %}
                                        </tbody>
                                    </table>
                                </form>
                            {% else %}
                                <div class="alert alert-info">暂无待确认的派送账单</div>
                            {% endif %}
                        </div>
                    </div>
                    <!-- 已确认派送账单 -->
                    <div id="delivery-confirm" class="tab-content">
                        <div class="table-container">
                            {% if delivery_confirm_orders %}
                                <!-- 导出控件 - 新增全选和选中数量显示 -->
                                <div class="export-controls">
                                    <h6><b>导出选项：</b></h6>
                                    <!-- 新增全选区域 -->
                                    <div class="export-select-all-container" style="margin-right: 15px;">
                                        <input type="checkbox" id="delivery-select-all"
                                               onclick="toggleSelectAll('delivery-select-all', 'delivery-export-checkbox')"
                                               style="width: 18px; height: 18px; cursor: pointer;">
                                        <label for="delivery-select-all"
                                               style="margin: 0; font-weight: 500; cursor: pointer;">全选</label>
                                        <span class="export-selected-count"
                                              id="delivery-selected-count">已选：0 条</span>
                                    </div>

                                    <form method="post" class="export-filter-form" id="delivery-query-form"
                                          style="margin-bottom: 10px;">
                                        {% csrf_token %}
                                        <div class="filter-group">
                                            <label>供应商：</label>
                                            <select name="select_carrier">
                                                {% for key,value in CARRIER_FLEET.items %}
                                                    <option value="{{ key }}"
                                                            {% if selected_carrier == key %}selected{% endif %}>
                                                        {{ value }}
                                                    </option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                        <input type="hidden" name="step"
                                               value="export_delivery_by_month_carrier_v1_search">
                                        <input type="hidden" name="start_date_confirm" value="{{ start_date_confirm }}">
                                        <input type="hidden" name="end_date_confirm" value="{{ end_date_confirm }}">
                                        <input type="hidden" name="warehouse_filter" value="{{ warehouse_filter }}">
                                        <input type="hidden" name="customer_name"
                                               value="{{ selected_customer_id|default:'' }}">
                                        <button type="submit" class="btn query-btn btn-sm btn-primary"
                                                style="margin-right: 10px; margin-top: 13px;">
                                            <i class="fas fa-search"></i> 查询
                                        </button>
                                    </form>

                                    <!-- 导出表单 - 新增传递选中的 fleet id -->
                                    <form method="post" class="export-filter-form" id="delivery-export-form"
                                          onsubmit="return collectSelectedFleetIds()">
                                        {% csrf_token %}
                                        <input type="hidden" name="step" value="export_carrier_payable_delivery">
                                        <input type="hidden" name="confirm_phase" value="delivery">
                                        <input type="hidden" name="start_date_export" value="{{ start_date_confirm }}">
                                        <input type="hidden" name="end_date_export" value="{{ end_date_confirm }}">
                                        <input type="hidden" name="select_carrier"
                                               value="{{ selected_carrier|default:'' }}">
                                        <!-- 新增隐藏字段存储选中的 fleet id -->
                                        <input type="hidden" name="selected_fleet_ids" id="selected_fleet_ids" value="">
                                        <button type="submit" class="btn btn-warning btn-sm">
                                            <i class="fas fa-file-excel"></i> 导出Excel
                                        </button>
                                    </form>
                                </div>

                                <form method="post" id="delivery-confirm-form">
                                    {% csrf_token %}
                                    <input type="hidden" name="step" value="payable_confirm_phase">
                                    <input type="hidden" name="confirm_phase" value="delivery">
                                    <table class="table">
                                        <thead>
                                        <tr>
                                            <!-- 新增：多选框列 -->
                                            <th class="th export-checkbox-col"
                                                style="vertical-align: middle; width: 50px;">
                                                <input type="checkbox" id="delivery-select-all-header"
                                                       onclick="toggleSelectAll('delivery-select-all-header', 'delivery-export-checkbox')"
                                                       style="width: 18px; height: 18px; cursor: pointer;">
                                            </th>
                                            <th class="th" style="vertical-align: middle;">车次</th>
                                            <th class="th" style="vertical-align: middle;">Carrier</th>
                                            <th class="th" style="vertical-align: middle;">Pickup Number</th>
                                            <th class="th" style="vertical-align: middle;">ISA</th>
                                            <th class="th" style="vertical-align: middle;">柜号</th>
                                            <th class="th" style="vertical-align: middle;">目的地</th>
                                            <th class="th" style="vertical-align: middle;">板数</th>
                                            <th class="th" style="vertical-align: middle;">价格</th>
                                            <th class="th" style="vertical-align: middle;">单板成本</th>
                                            <th class="th" style="vertical-align: middle;">车次总板数</th>
                                            <th class="th" style="vertical-align: middle;">车次总成本</th>
                                            <th class="th" style="vertical-align: middle;">核销金额</th>
                                            <th class="th" style="vertical-align: middle;">核销时间</th>
                                            <th class="th" style="vertical-align: middle;">备注</th>
                                        </tr>
                                        </thead>
                                        <tr class="search-row">
                                            <th class="th export-checkbox-col"></th>
                                            <th class="th"><input type="text" class="search-input" data-column-index="1"
                                                                  placeholder="搜索车次"
                                                                  onkeyup="filterDeliveryTable('delivery-confirm', this)">
                                            </th>
                                            <th class="th"><input type="text" class="search-input" data-column-index="2"
                                                                  placeholder="搜索Carrier"
                                                                  onkeyup="filterDeliveryTable('delivery-confirm', this)">
                                            </th>
                                            <th class="th"><input type="text" class="search-input" data-column-index="3"
                                                                  placeholder="搜索Pickup Number"
                                                                  onkeyup="filterDeliveryTable('delivery-confirm', this)">
                                            </th>
                                            <th class="th"><input type="text" class="search-input" data-column-index="4"
                                                                  placeholder="搜索ISA"
                                                                  onkeyup="filterDeliveryTable('delivery-confirm', this)">
                                            </th>
                                            <th class="th"><input type="text" class="search-input" data-column-index="5"
                                                                  placeholder="搜索柜号"
                                                                  onkeyup="filterDeliveryTable('delivery-confirm', this)">
                                            </th>
                                            <th class="th"><input type="text" class="search-input" data-column-index="6"
                                                                  placeholder="搜索目的地"
                                                                  onkeyup="filterDeliveryTable('delivery-confirm', this)">
                                            </th>
                                            <th class="th"></th>
                                            <th class="th"></th>
                                            <th class="th"></th>
                                            <th class="th"></th>
                                            <th class="th"></th>
                                            <th class="th"></th>
                                            <th class="th"></th>
                                            <th class="th"></th>
                                        </tr>
                                        <tbody>
                                        {% for fleet in delivery_confirm_orders %}
                                            {% for pickup_number, pickup_data in fleet.fleets.items %}
                                                {% for appointment_id, appointment_data in pickup_data.appointments.items %}
                                                    {% for order in appointment_data.orders %}
                                                        <tr>
                                                            <!-- 新增：多选框单元格 -->
                                                            {% if forloop.parentloop.first and forloop.first %}
                                                                <td class="td export-checkbox-col"
                                                                    rowspan="{{ pickup_data.total_rows }}"
                                                                    style="vertical-align: middle;">
                                                                    <input type="checkbox"
                                                                           class="delivery-export-checkbox"
                                                                           value="{{ fleet.fleet_id|default:'' }}"
                                                                           data-fleet-id="{{ fleet.fleet_id|default:'' }}"
                                                                           style="width: 16px; height: 16px;">
                                                                </td>
                                                            {% endif %}

                                                            {% if forloop.parentloop.first and forloop.first %}
                                                                <td class="td" rowspan="{{ pickup_data.total_rows }}"
                                                                    style="vertical-align: middle;">
                                                                    {{ fleet.fleet_number|default_if_none:"" }}
                                                                </td>
                                                                <td class="td" rowspan="{{ pickup_data.total_rows }}"
                                                                    style="vertical-align: middle;">
                                                                    {{ fleet.carrier|default_if_none:"" }}
                                                                </td>
                                                                <td class="td" rowspan="{{ pickup_data.total_rows }}"
                                                                    style="vertical-align: middle;">
                                                                    {{ pickup_number|default_if_none:"" }}
                                                                </td>
                                                            {% endif %}

                                                            {% if forloop.first %}
                                                                <td class="td" rowspan="{{ appointment_data.rowspan }}"
                                                                    style="vertical-align: middle;">
                                                                    {{ appointment_id|default_if_none:"" }}
                                                                </td>
                                                            {% endif %}

                                                            <td class="td"
                                                                style="vertical-align: middle;">{{ order.container_num }}</td>
                                                            <td class="td"
                                                                style="vertical-align: middle;">{{ order.pallet_destination }}</td>
                                                            <td class="td"
                                                                style="vertical-align: middle;">{{ order.cn_total_pallet }}</td>
                                                            <td class="td"
                                                                style="vertical-align: middle;">{{ order.cn_total_expense }}</td>
                                                            <td class="td"
                                                                style="vertical-align: middle;">{{ order.cn_per_expense }}</td>
                                                            {% if forloop.parentloop.first and forloop.first %}
                                                                <td class="td" rowspan="{{ pickup_data.total_rows }}"
                                                                    style="vertical-align: middle;">
                                                                    {{ pickup_data.ISA_total_pallets }}
                                                                </td>
                                                                <td class="td" rowspan="{{ pickup_data.total_rows }}"
                                                                    style="vertical-align: middle;">
                                                                    ${{ pickup_data.ISA_total_expense }}
                                                                </td>
                                                            {% endif %}
                                                            <td class="td" rowspan="{{ pickup_data.total_rows }}" style="vertical-align: middle;">
                                                                {{ order.itemv2_data.write_off_amount|default:"0.00" }}
                                                            </td>
                                                            <td class="td" rowspan="{{ pickup_data.total_rows }}" style="vertical-align: middle;">
                                                                {{ order.itemv2_data.write_off_time|date:"Y-m-d"|default:"未核销" }}
                                                            </td>
                                                            <td class="td" rowspan="{{ pickup_data.total_rows }}" style="vertical-align: middle;">
                                                                {{ order.itemv2_data.note|default:"无" }}
                                                            </td>
                                                        </tr>
                                                    {% endfor %}
                                                {% endfor %}
                                            {% endfor %}
                                        {% endfor %}
                                        </tbody>
                                    </table>
                                </form>
                            {% else %}
                                <div class="alert alert-info">暂无已确认的派送账单</div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <!-- 新增：直达底部按钮 -->
    <button class="to-bottom-btn" onclick="scrollToBottom()">
        <i class="fas fa-arrow-down"></i>
    </button>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- 引入字体图标（用于直达底部按钮） -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        // 页面初始化总入口（唯一的DOMContentLoaded事件，整合所有初始化逻辑）
        document.addEventListener('DOMContentLoaded', function () {
            // 1. 初始化费用计算
            calculateAllFees();

            // 2. 初始化供应商列表显示（根据后端传的 supplier_type）
            const supplierType = "{{ supplier_type|default:'pickup_carrier' }}";
            const pickupList = document.getElementById("pickup_carrier_list");
            const unloadList = document.getElementById("unload_carrier_list");
            if (pickupList && unloadList) {
                if (supplierType === "pickup_carrier") {
                    pickupList.style.display = "inline-block";
                    unloadList.style.display = "none";
                } else {
                    pickupList.style.display = "none";
                    unloadList.style.display = "inline-block";
                }
            }

            // 3. 初始化全选功能（包含待核销表格）
            initSelectAllFunctions();

            // ========== 核心修复：主动激活派送账单主标签 + 强制显示子标签 ==========
            // 3.1 强制激活派送账单主标签（添加active类）
            const deliveryTab = document.querySelector('.content-tab[data-tab="delivery"]');
            if (deliveryTab) {
                // 先移除所有主标签的active类，再给派送账单添加
                document.querySelectorAll('.content-tab').forEach(t => t.classList.remove('active'));
                deliveryTab.classList.add('active');

                // 3.2 强制显示派送账单主内容
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                const deliveryContent = document.getElementById('delivery-content');
                if (deliveryContent) {
                    deliveryContent.classList.add('active');

                    // 3.3 强制激活第一个子标签（待确认）并显示其内容
                    const firstSubTab = deliveryContent.querySelector('.sub-content-tab');
                    if (firstSubTab) {
                        // 先移除所有子标签的active类
                        deliveryContent.querySelectorAll('.sub-content-tab').forEach(t => t.classList.remove('active'));
                        firstSubTab.classList.add('active');

                        // 强制显示第一个子标签的内容
                        const firstSubTabName = firstSubTab.getAttribute('data-subtab');
                        if (firstSubTabName) {
                            deliveryContent.querySelectorAll('.tab-content').forEach(content => {
                                content.classList.remove('active');
                            });
                            const firstSubContent = document.getElementById(firstSubTabName);
                            if (firstSubContent) {
                                firstSubContent.classList.add('active');

                                // 子标签显示后重新初始化相关功能
                                setTimeout(() => {
                                    calculateAllFees(firstSubTabName + '-table');
                                    bindWriteOffCheckboxEvents();
                                    initSingleWriteOff();
                                    initDeliverySelectAll(); // 初始化派送账单全选
                                    // 新增：初始化待确认派送账单全选功能
                                    initDeliveryPendingSelectAll();
                                }, 100);
                            }
                        }
                    }
                }
            }

            // ========== 保留原有的标签点击事件逻辑（用于手动切换） ==========
            // 4. 主标签页切换逻辑（修复定位+稳定性）
            const mainTabs = document.querySelectorAll('.content-tab');
            mainTabs.forEach(tab => {
                tab.addEventListener('click', function () {
                    const tabName = this.getAttribute('data-tab');
                    if (!tabName) return;

                    // 移除所有主标签激活状态
                    mainTabs.forEach(t => t.classList.remove('active'));
                    this.classList.add('active');

                    // 切换主内容显示
                    document.querySelectorAll('.tab-content').forEach(content => {
                        content.classList.remove('active');
                    });
                    const targetMainContent = document.getElementById(tabName + '-content');
                    if (targetMainContent) {
                        targetMainContent.classList.add('active');

                        // 强制激活第一个子标签页
                        const firstSubTab = targetMainContent.querySelector('.sub-content-tab');
                        if (firstSubTab) {
                            setTimeout(() => {
                                targetMainContent.querySelectorAll('.sub-content-tab').forEach(t => t.classList.remove('active'));
                                firstSubTab.classList.add('active');
                                firstSubTab.click(); // 触发子标签点击
                            }, 50);
                        }
                    }
                });
            });

            // 5. 子标签页切换逻辑（重构+防错）
            const subTabs = document.querySelectorAll('.sub-content-tab');
            subTabs.forEach(tab => {
                tab.addEventListener('click', function () {
                    // 获取子标签容器，移除同级别激活状态
                    const subTabContainer = this.closest('.sub-content-tabs');
                    if (!subTabContainer) return;
                    subTabContainer.querySelectorAll('.sub-content-tab').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');

                    // 获取子内容ID，切换显示
                    const subTabName = this.getAttribute('data-subtab');
                    if (!subTabName) return;
                    const parentContent = this.closest('.tab-content');
                    if (parentContent) {
                        parentContent.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                        const targetSubContent = document.getElementById(subTabName);
                        if (targetSubContent) {
                            targetSubContent.classList.add('active');
                            // 切换后重新计算费用 + 重新绑定勾选事件
                            setTimeout(() => {
                                calculateAllFees(subTabName + '-table');
                                bindWriteOffCheckboxEvents(); // 切换标签后重新绑定
                                initSingleWriteOff(); // 重新绑定单个核销事件
                            }, 100);
                        }
                    }
                });
            });

            // 6. 表单控件样式优化
            document.querySelectorAll('select, input[type="date"], input[type="text"], textarea').forEach(el => {
                if (!el.classList.contains('form-control')) {
                    el.classList.add('form-control', 'form-control-sm');
                }
            });

            // 7. 初始化表格（包含导出功能的核心表格）
            initTable("pick-confirmed-table");
            // 初始化待核销表格
            initTable("pick-t-waited-table");
            initTable("pick-x-waited-table");

            // 8. 初始化核销勾选框事件（核心修复：独立函数，支持重复绑定）
            bindWriteOffCheckboxEvents();

            // 9. 初始化单个核销事件（提柜+卸柜都适配）
            initSingleWriteOff();

            // 10. 暴露批量核销函数到全局
            window.batchWriteOff = batchWriteOff;   // 提柜批量核销
            window.batchWriteOffX = batchWriteOffX; // 卸柜批量核销
            // 初始化派送账单全选功能（已整合到主标签激活逻辑中，这里可保留兜底）
            initDeliverySelectAll();
            // 新增：派送账单搜索框回车触发搜索
            document.querySelectorAll('.search-input').forEach(input => {
                input.addEventListener('keydown', function (e) {
                    if (e.key === 'Enter') {
                        const tableType = this.closest('.tab-content').id; // 获取当前标签页ID
                        if (tableType === 'delivery-pending' || tableType === 'delivery-confirm') {
                            filterDeliveryTable(tableType, this);
                            // 同步对应全选状态
                            tableType === 'delivery-pending'
                                ? updateDeliveryPendingSelectAllStatus()
                                : updateDeliverySelectAllStatus();
                        }
                    }
                });
            });
        });

        // 初始化派送账单全选功能

        // 重写待确认账单全选点击逻辑（仅勾选可见行）
        function initDeliveryPendingSelectAll() {
            const pendingSelectAll = document.getElementById('delivery-pending-select-all');
            const pendingSelectAllHeader = document.getElementById('delivery-pending-select-all-header');
            const pendingCheckboxes = document.querySelectorAll('.delivery-pending-checkbox');

            // 同步两个全选框状态 + 仅勾选可见行
            if (pendingSelectAll && pendingSelectAllHeader) {
                pendingSelectAll.addEventListener('click', function () {
                    pendingSelectAllHeader.checked = this.checked;
                    pendingCheckboxes.forEach(checkbox => {
                        const tr = checkbox.closest('tr');
                        // 仅操作可见、非合并子行的复选框
                        if (tr && tr.style.display !== 'none' && !tr.dataset.mergedHidden) {
                            checkbox.checked = this.checked;
                        }
                    });
                    updateDeliveryPendingSelectedCount();
                });

                pendingSelectAllHeader.addEventListener('click', function () {
                    pendingSelectAll.checked = this.checked;
                    pendingCheckboxes.forEach(checkbox => {
                        const tr = checkbox.closest('tr');
                        if (tr && tr.style.display !== 'none' && !tr.dataset.mergedHidden) {
                            checkbox.checked = this.checked;
                        }
                    });
                    updateDeliveryPendingSelectedCount();
                });
            }

            // 单个复选框变化：仅统计可见行
            pendingCheckboxes.forEach(checkbox => {
                checkbox.addEventListener('change', function () {
                    updateDeliveryPendingSelectAllStatus(); // 替换为新的状态同步
                });
            });

            updateDeliveryPendingSelectedCount();
        }

        // 重写已确认账单全选点击逻辑（仅勾选可见行）
        function initDeliverySelectAll() {
            const deliverySelectAll = document.getElementById('delivery-select-all');
            const deliverySelectAllHeader = document.getElementById('delivery-select-all-header');
            const deliveryCheckboxes = document.querySelectorAll('.delivery-export-checkbox');

            // 同步两个全选框状态 + 仅勾选可见行
            if (deliverySelectAll && deliverySelectAllHeader) {
                deliverySelectAll.addEventListener('click', function () {
                    deliverySelectAllHeader.checked = this.checked;
                    deliveryCheckboxes.forEach(checkbox => {
                        const tr = checkbox.closest('tr');
                        if (tr && tr.style.display !== 'none' && !tr.dataset.mergedHidden) {
                            checkbox.checked = this.checked;
                        }
                    });
                    updateDeliverySelectedCount();
                });

                deliverySelectAllHeader.addEventListener('click', function () {
                    deliverySelectAll.checked = this.checked;
                    deliveryCheckboxes.forEach(checkbox => {
                        const tr = checkbox.closest('tr');
                        if (tr && tr.style.display !== 'none' && !tr.dataset.mergedHidden) {
                            checkbox.checked = this.checked;
                        }
                    });
                    updateDeliverySelectedCount();
                });
            }

            // 单个复选框变化：仅统计可见行
            deliveryCheckboxes.forEach(checkbox => {
                checkbox.addEventListener('change', function () {
                    updateDeliverySelectAllStatus(); // 替换为新的状态同步
                });
            });

            updateDeliverySelectedCount();
        }

        // 更新待确认派送账单选中数量
        function updateDeliveryPendingSelectedCount() {
            const checkboxes = document.querySelectorAll('.delivery-pending-checkbox:checked');
            const countElement = document.getElementById('delivery-pending-selected-count');
            if (countElement) {
                countElement.textContent = `已选：${checkboxes.length} 条`;
            }
        }

        // 待确认派送账单 - 收集选中的fleet_number（优化后）
        function collectSelectedPendingFleetIds() {
            const checkedCheckboxes = document.querySelectorAll('.delivery-pending-checkbox:checked');
            const fleetNumbers = new Set(); // Set自动去重

            // 1. 过滤空值，收集有效车次编号
            checkedCheckboxes.forEach(checkbox => {
                const fleetNum = (checkbox.getAttribute('data-fleet-id') || '').trim();
                if (fleetNum) { // 仅收集非空的有效车次
                    fleetNumbers.add(fleetNum);
                }
            });

            // 2. 校验：无有效车次直接提示
            if (fleetNumbers.size === 0) {
                alert('请勾选包含有效车次编号的记录后再导出！');
                return false;
            }

            // 3. 赋值给隐藏字段（逗号分隔，后端可直接分割）
            document.getElementById('selected_pending_fleet_ids').value = Array.from(fleetNumbers).join(',');
            return true;
        }

        // 更新派送账单选中数量
        function updateDeliverySelectedCount() {
            const checkboxes = document.querySelectorAll('.delivery-export-checkbox:checked');
            const countElement = document.getElementById('delivery-selected-count');
            if (countElement) {
                countElement.textContent = `已选：${checkboxes.length} 条`;
            }
        }

        // 已确认派送账单 - 收集选中的fleet_number（优化后，移除冗余全选判断）
        function collectSelectedFleetIds() {
            const checkedCheckboxes = document.querySelectorAll('.delivery-export-checkbox:checked');
            console.log('当前勾选的复选框数量：', checkedCheckboxes.length); // 调试日志1
            const fleetNumbers = new Set(); // Set自动去重

            // 1. 过滤空值，收集有效车次编号
            checkedCheckboxes.forEach(checkbox => {
                const fleetNum = (checkbox.getAttribute('data-fleet-id') || '').trim();
                if (fleetNum) { // 仅收集非空的有效车次
                    fleetNumbers.add(fleetNum);
                }
            });
            console.log('最终收集的有效车次编号：', Array.from(fleetNumbers));

            // 2. 校验：无有效车次直接提示
            if (fleetNumbers.size === 0) {
                alert('请勾选包含有效车次编号的记录后再导出！');
                return false;
            }

            // 3. 赋值给隐藏字段（逗号分隔，后端可直接分割）
            document.getElementById('selected_fleet_ids').value = Array.from(fleetNumbers).join(',');
            return true;
        }

        // ===================== 核心修复：核销勾选框事件绑定（独立函数） =====================
        function bindWriteOffCheckboxEvents() {
            // 移除旧事件（避免重复绑定）
            const allCheckboxes = document.querySelectorAll('.pick-t-writeoff, .pick-x-writeoff');
            allCheckboxes.forEach(checkbox => {
                // 重置事件监听（简单方案：克隆节点替换）
                const newCheckbox = checkbox.cloneNode(true);
                checkbox.parentNode.replaceChild(newCheckbox, checkbox);
            });

            // 重新绑定提柜待核销勾选框
            const pickTCheckboxes = document.querySelectorAll('.pick-t-writeoff');
            pickTCheckboxes.forEach(checkbox => {
                checkbox.addEventListener('change', function () {
                    updateSelectedCount('pick-t');
                    // 同步全选状态
                    updateSelectAllStatusFiltered('pick-confirmed-select-all', 'pick-t-writeoff', 'pick-t-waited-table');
                });
            });

            // 重新绑定卸柜待核销勾选框
            const pickXCheckboxes = document.querySelectorAll('.pick-x-writeoff');
            pickXCheckboxes.forEach(checkbox => {
                checkbox.addEventListener('change', function () {
                    updateSelectedCount('pick-x');
                    // 同步全选状态
                    updateSelectAllStatusFiltered('pick-x-select-all', 'pick-x-writeoff', 'pick-x-waited-table');
                });
            });

            // 初始化选中数量
            updateSelectedCount('pick-t');
            updateSelectedCount('pick-x');
        }

        // ===================== 核心功能函数：全选（新增过滤表格的全选逻辑） =====================
        function initSelectAllFunctions() {
            // 待确认表格全选
            const pickSelectAll = document.getElementById('pick-select-all');
            if (pickSelectAll) {
                pickSelectAll.addEventListener('click', function () {
                    toggleSelectAll('pick-select-all', 'pick-orders');
                });
                updateSelectAllStatus('pick-select-all', 'pick-orders');
            }

            // 已确认表格全选（导出功能依赖）
            const pickConfirmSelectAll = document.getElementById('pick-confirm-select-all');
            if (pickConfirmSelectAll) {
                pickConfirmSelectAll.addEventListener('click', function () {
                    toggleSelectAll('pick-confirm-select-all', 'export-record-checkbox');
                });
                updateSelectAllStatus('pick-confirm-select-all', 'export-record-checkbox');
            }

            // 提柜待核销全选（核心新增）
            const pickTSelectAll = document.getElementById('pick-confirmed-select-all');
            if (pickTSelectAll) {
                pickTSelectAll.addEventListener('click', function () {
                    toggleSelectAllFiltered('pick-confirmed-select-all', 'pick-t-writeoff', 'pick-t-waited-table');
                });
                updateSelectAllStatusFiltered('pick-confirmed-select-all', 'pick-t-writeoff', 'pick-t-waited-table');
            }

            // 卸柜待核销全选（核心新增）
            const pickXSelectAll = document.getElementById('pick-x-select-all');
            if (pickXSelectAll) {
                pickXSelectAll.addEventListener('click', function () {
                    toggleSelectAllFiltered('pick-x-select-all', 'pick-x-writeoff', 'pick-x-waited-table');
                });
                updateSelectAllStatusFiltered('pick-x-select-all', 'pick-x-writeoff', 'pick-x-waited-table');
            }
        }

        // 适配表格过滤的全选函数（核心修复）
        function toggleSelectAllFiltered(selectAllId, checkboxClass, tableId) {
            const selectAll = document.getElementById(selectAllId);
            if (!selectAll) return;

            const table = document.getElementById(tableId);
            if (!table) return;

            const checkboxes = table.querySelectorAll('.' + checkboxClass);
            let visibleCount = 0;
            let checkedVisibleCount = 0;

            // 仅操作可见行的复选框
            checkboxes.forEach(checkbox => {
                const tr = checkbox.closest('tr');
                if (tr && tr.style.display !== 'none') {
                    visibleCount++;
                    checkbox.checked = selectAll.checked;
                    if (checkbox.checked) checkedVisibleCount++;
                }
            });

            // 更新选中数量
            if (checkboxClass === 'pick-t-writeoff') {
                updateSelectedCount('pick-t');
            } else if (checkboxClass === 'pick-x-writeoff') {
                updateSelectedCount('pick-x');
            }
        }

        // 适配表格过滤的全选状态更新（核心修复）
        function updateSelectAllStatusFiltered(selectAllId, checkboxClass, tableId) {
            const selectAll = document.getElementById(selectAllId);
            if (!selectAll) return;

            const table = document.getElementById(tableId);
            if (!table) return;

            const checkboxes = table.querySelectorAll('.' + checkboxClass);
            let visibleCount = 0;
            let checkedVisibleCount = 0;

            checkboxes.forEach(checkbox => {
                const tr = checkbox.closest('tr');
                if (tr && tr.style.display !== 'none') {
                    visibleCount++;
                    if (checkbox.checked) checkedVisibleCount++;
                }
            });

            // 更新全选框状态
            selectAll.checked = (visibleCount > 0 && checkedVisibleCount === visibleCount);
        }

        function toggleSelectAll(selectAllId, checkboxClass) {
            const selectAll = document.getElementById(selectAllId);
            if (!selectAll) return;

            const checkboxes = document.getElementsByClassName(checkboxClass);
            let visibleCount = 0;
            let checkedVisibleCount = 0;

            // 仅操作可见行的复选框
            for (let checkbox of checkboxes) {
                const tr = checkbox.closest('tr');
                if (tr && tr.style.display !== 'none') {
                    visibleCount++;
                    checkbox.checked = selectAll.checked;
                    if (checkbox.checked) checkedVisibleCount++;
                }
            }

            // 监听单个复选框变化，同步全选状态
            for (let checkbox of checkboxes) {
                checkbox.addEventListener('change', function () {
                    updateSelectAllStatus(selectAllId, checkboxClass);
                });
            }
        }

        function updateSelectAllStatus(selectAllId, checkboxClass) {
            const selectAll = document.getElementById(selectAllId);
            if (!selectAll) return;

            const checkboxes = document.getElementsByClassName(checkboxClass);
            let visibleCount = 0;
            let checkedVisibleCount = 0;

            for (let checkbox of checkboxes) {
                const tr = checkbox.closest('tr');
                if (tr && tr.style.display !== 'none') {
                    visibleCount++;
                    if (checkbox.checked) checkedVisibleCount++;
                }
            }

            selectAll.checked = (visibleCount > 0 && checkedVisibleCount === visibleCount);
        }

        // ===================== 核心功能函数：费用计算 =====================
        function calculateAllFees(tableId) {
            // 1. 计算单元格内的费用合计（其他费用/总费用）
            document.querySelectorAll('.td_fee_other, .td_fee_total').forEach(cell => {
                const feesStr = cell.getAttribute('data-fees') || '';
                const fees = feesStr
                    .split(',')
                    .filter(fee => fee.trim() !== '' && !isNaN(fee.trim()))
                    .map(fee => Number(fee.trim()));

                const total = fees.reduce((sum, fee) => sum + (isNaN(fee) ? 0 : fee), 0);
                const totalElement = cell.querySelector('.total-amount');
                if (totalElement) {
                    totalElement.textContent = `$${total.toFixed(2)}`;
                }
            });

            // 2. 处理重复的费用span显示
            document.querySelectorAll('.td_fee').forEach(cell => {
                const spans = cell.querySelectorAll('.pickup-fee-amount, .unpickup-fee-amount');
                if (spans.length > 1) {
                    spans.forEach((span, index) => {
                        span.style.display = index === spans.length - 1 ? 'inline-block' : 'none';
                    });
                }
            });

            // 3. 按表格ID计算显示行的总费用
            if (tableId) {
                const table = document.getElementById(tableId);
                if (!table) return;

                let totalFee = 0;
                const tr = table.getElementsByTagName("tr");
                for (let i = 2; i < tr.length; i++) {
                    if (tr[i].style.display !== "none") {
                        const tdList = tr[i].getElementsByTagName("td");
                        const feeText = tdList[13]?.textContent || "0"; // 总费用列索引修正
                        const fee = parseFloat(feeText.replace(/[^0-9.]/g, "")) || 0;
                        totalFee += fee;
                    }
                }

                const totalElement = document.getElementById(`total-fee-${tableId}`);
                if (totalElement) {
                    totalElement.textContent = `$${totalFee.toFixed(2)}`;
                }
            }
        }

        // ===================== 核心功能函数：表格过滤 =====================
        function filterTable(tableId, columnIndex) {
            const table = document.getElementById(tableId);
            if (!table) return;

            const inputEvent = event || window.event;
            let inputValue = inputEvent.target.value.trim();
            const searchTerms = inputValue.split(/\s+/).filter(term => term.length > 0);
            const tr = table.getElementsByTagName("tr");

            // 过滤数据行（跳过表头/搜索行）
            for (let i = 2; i < tr.length; i++) {
                let found = false;
                const td = tr[i].getElementsByTagName("td");

                if (td[columnIndex]) {
                    const cellText = td[columnIndex].textContent.toUpperCase();
                    if (searchTerms.length === 0) {
                        found = true;
                    } else {
                        found = searchTerms.some(term => cellText.includes(term.toUpperCase()));
                    }
                }

                tr[i].style.display = found ? "" : "none";
            }

            // 过滤后重新计算费用+同步全选状态
            calculateAllFees(tableId);
            if (tableId === 'pick-pending-table') {
                updateSelectAllStatus('pick-select-all', 'pick-orders');
            } else if (tableId === 'pick-confirmed-table') {
                updateSelectAllStatus('pick-confirm-select-all', 'export-record-checkbox');
            } else if (tableId === 'pick-t-waited-table') {
                updateSelectAllStatusFiltered('pick-confirmed-select-all', 'pick-t-writeoff', 'pick-t-waited-table');
                updateSelectedCount('pick-t');
            } else if (tableId === 'pick-x-waited-table') {
                updateSelectAllStatusFiltered('pick-x-select-all', 'pick-x-writeoff', 'pick-x-waited-table');
                updateSelectedCount('pick-x');
            }
        }

        // ===================== 核心功能函数：表格初始化（含导出依赖） =====================
        function initTable(tableId) {
            const table = document.getElementById(tableId);
            if (!table) return;

            // 初始化表格总费用
            calculateAllFees(tableId);

            // 搜索框回车事件
            const searchInputs = table.parentNode.querySelectorAll(".search-input");
            searchInputs.forEach(input => {
                input.addEventListener("keydown", function (e) {
                    if (e.key === "Enter") {
                        const colIndex = this.dataset.columnIndex || this.getAttribute('data-column-index');
                        if (colIndex) filterTable(tableId, colIndex);
                    }
                });
            });

            // 重置过滤按钮
            const resetBtn = table.parentNode.querySelector(".reset-filter");
            if (resetBtn) {
                resetBtn.addEventListener("click", function () {
                    searchInputs.forEach(input => input.value = "");
                    const tr = table.getElementsByTagName("tr");
                    for (let i = 2; i < tr.length; i++) {
                        tr[i].style.display = "";
                    }
                    calculateAllFees(tableId);
                });
            }
        }

        // ===================== 核心功能函数：导出勾选记录（完整保留） =====================
        function collectSelectedContainers() {
            // 1. 校验是否勾选记录
            const checkboxes = document.querySelectorAll('.export-record-checkbox:checked');
            if (checkboxes.length === 0) {
                alert('请至少勾选一个集装箱！');
                return false;
            }

            // 2. 收集勾选的集装箱ID
            const selectedIds = [];
            checkboxes.forEach(checkbox => {
                selectedIds.push(checkbox.value);
            });

            // 3. 填充到隐藏字段（导出接口依赖）
            const hiddenInput = document.getElementById('selected_container_ids');
            if (hiddenInput) {
                hiddenInput.value = JSON.stringify(selectedIds);
            }

            // 4. 填充供应商筛选条件
            const supplierType = document.getElementById('supplier_type')?.value;
            const exportSupplierTypeInput = document.getElementById('export_supplier_type');
            if (supplierType && exportSupplierTypeInput) {
                exportSupplierTypeInput.value = supplierType;
            }

            const carrierSelect = supplierType === 'pickup_carrier'
                ? document.getElementById('pickup_carrier_list')
                : document.getElementById('unload_carrier_list');
            const exportCarrierInput = document.getElementById('export_carrier');
            if (carrierSelect && exportCarrierInput) {
                exportCarrierInput.value = carrierSelect.value;
            }

            return true;
        }

        // ===================== 辅助功能函数：供应商切换 =====================
        function switchCarrierList() {
            const type = document.getElementById('supplier_type')?.value;
            const pickupList = document.getElementById("pickup_carrier_list");
            const unloadList = document.getElementById("unload_carrier_list");

            if (!type || !pickupList || !unloadList) return;

            if (type === "pickup_carrier") {
                pickupList.style.display = "inline-block";
                unloadList.style.display = "none";
            } else {
                pickupList.style.display = "none";
                unloadList.style.display = "inline-block";
            }
        }

        // ===================== 辅助功能函数：核销相关（修复更新逻辑） =====================
        function updateSelectedCount(type) {
            // 直接执行更新，不再返回函数（修复事件绑定问题）
            const checkboxes = document.querySelectorAll(`.${type}-writeoff:checked`);
            const countElement = document.getElementById(`${type}-selected-count`);
            if (countElement) {
                countElement.textContent = `已选：${checkboxes.length} 条`;
            }
        }

        // ===================== 单个核销函数（适配提柜+卸柜） =====================
        function initSingleWriteOff() {
            // 先移除旧的事件绑定（避免重复）
            document.querySelectorAll('.single-writeoff-form').forEach(form => {
                const newForm = form.cloneNode(true);
                form.parentNode.replaceChild(newForm, form);
            });

            // 只给核销金额的表单绑定校验逻辑（.single-writeoff-form）
            const singleWriteOffForms = document.querySelectorAll('.single-writeoff-form');
            singleWriteOffForms.forEach(form => {
                form.addEventListener('submit', function (e) {
                    // 1. 阻止默认提交，先做校验
                    e.preventDefault();

                    // 2. 获取当前表单对应的container_id和核销金额输入框
                    const containerId = this.querySelector('input[name="container_id"]').value;
                    const amountInput = document.querySelector(`.write-off-amount[data-container-id="${containerId}"]`);

                    // 3. 校验金额输入框是否存在
                    if (!amountInput) {
                        alert('未找到对应的核销金额输入框！');
                        return;
                    }

                    // 4. 校验金额有效性
                    const writeOffAmount = parseFloat(amountInput.value) || 0;
                    if (writeOffAmount <= 0) {
                        alert('请输入有效的核销金额（大于0）！');
                        amountInput.focus(); // 聚焦到输入框，方便用户修改
                        return;
                    }

                    // 5. 给表单添加核销金额的隐藏字段（因为输入框不在表单内，需要手动传）
                    let amountField = this.querySelector('input[name="write_off_amount"]');
                    if (!amountField) {
                        amountField = document.createElement('input');
                        amountField.type = 'hidden';
                        amountField.name = 'write_off_amount';
                        this.appendChild(amountField);
                    }
                    amountField.value = writeOffAmount;

                    // 6. 确认提交（可选：增加确认提示）
                    if (confirm(`确认核销柜号ID【${containerId}】的金额：$${writeOffAmount.toFixed(2)}？`)) {
                        this.submit(); // 提交表单
                    }
                });
            });

            // 给备注表单单独绑定逻辑（修复：直接通过表单相邻元素查找输入框）
            const noteSubmitForms = document.querySelectorAll('.note-submit-form');
            noteSubmitForms.forEach(form => {
                form.addEventListener('submit', function (e) {
                    // 1. 阻止默认提交
                    e.preventDefault();

                    // 2. 修复：不再通过data-container-id查找，直接找当前行的备注输入框
                    // 找到当前表单所在的单元格，然后找前面的备注输入框
                    const tdElement = this.closest('td');
                    if (!tdElement) {
                        alert('无法定位到备注输入框！');
                        return;
                    }

                    // 直接查找当前单元格内的备注输入框（最可靠的方式）
                    let noteInput = tdElement.querySelector('.write-off-amount-note');
                    if (!noteInput) {
                        // 备用方案：查找上一个兄弟td中的输入框
                        const prevTd = tdElement.previousElementSibling;
                        if (prevTd) {
                            noteInput = prevTd.querySelector('.write-off-amount-note');
                        }
                    }

                    // 3. 校验输入框是否存在
                    if (!noteInput) {
                        alert('未找到备注输入框，请刷新页面重试！');
                        return;
                    }

                    // 4. 校验备注内容
                    const noteText = noteInput.value.trim();
                    if (!noteText) {
                        alert('请输入备注内容！');
                        noteInput.focus();
                        return;
                    }

                    // 5. 添加备注到表单隐藏字段
                    let noteField = this.querySelector('input[name="note"]');
                    if (!noteField) {
                        noteField = document.createElement('input');
                        noteField.type = 'hidden';
                        noteField.name = 'note';
                        this.appendChild(noteField);
                    }
                    noteField.value = noteText;

                    // 6. 提交表单
                    this.submit();
                });
            });
        }

        // ===================== 批量核销函数 - 提柜（pick-t） =====================
        function batchWriteOff(type) {
            const batchAmountInput = document.getElementById(`${type}-batch-amount`);
            if (!batchAmountInput) {
                console.error('批量核销金额输入框不存在：', `${type}-batch-amount`);
                return;
            }

            const batchAmount = parseFloat(batchAmountInput.value) || 0;
            if (batchAmount <= 0) {
                alert('请输入有效的核销金额！');
                return;
            }

            // 1. 获取勾选的复选框
            const checkboxes = document.querySelectorAll(`.${type}-writeoff:checked`);
            if (checkboxes.length === 0) {
                alert('请至少勾选一条记录！');
                return;
            }

            // 2. 批量填写金额到输入框（保留原有逻辑）
            checkboxes.forEach(checkbox => {
                const containerId = checkbox.getAttribute('data-container-id');
                const amountInput = document.querySelector(`.write-off-amount[data-container-id="${containerId}"]`);
                if (amountInput) {
                    amountInput.value = batchAmount;
                }
            });

            // 3. 收集container_number_id（替换itemv2_id，过滤空值）
            const containerIds = [];
            const emptyIdIndexes = [];
            checkboxes.forEach((checkbox, index) => {
                // 核心：获取data-container-id（即container_number_id）
                const containerId = checkbox.getAttribute('data-container-id')?.trim() || '';
                console.log(`勾选框${index + 1}的container_number_id：`, containerId);
                if (containerId) {
                    containerIds.push(containerId);
                } else {
                    emptyIdIndexes.push(index + 1);
                    console.warn(`勾选框${index + 1}的data-container-id为空`);
                }
            });

            // 提示空ID（保留原有逻辑）
            if (emptyIdIndexes.length > 0) {
                const confirmContinue = confirm(`注意：勾选框${emptyIdIndexes.join(',')}无有效集装箱ID，是否继续处理其他记录？`);
                if (!confirmContinue) {
                    return;
                }
            }
            if (containerIds.length === 0) {
                alert('所有勾选的记录都没有有效集装箱ID，无法执行批量核销！');
                return;
            }

            // 4. 给隐藏form赋值（核心：替换为container_number_ids）
            const batchForm = document.getElementById('batch-writeoff-form');
            document.getElementById('batch-writeoff-type').value = type;
            document.getElementById('batch-writeoff-amount').value = batchAmount;
            document.getElementById('batch-writeoff-container-ids').value = containerIds.join(','); // 多个集装箱ID用逗号分隔

            // 5. 提交form表单（自动携带CSRF Token）
            batchForm.submit();
        }

        // ===================== 批量核销函数 - 卸柜（pick-x） =====================
        function batchWriteOffX(type) {
            const batchAmountInput = document.getElementById(`${type}-batch-amount`);
            if (!batchAmountInput) {
                console.error('批量核销金额输入框不存在：', `${type}-batch-amount`);
                return;
            }

            const batchAmount = parseFloat(batchAmountInput.value) || 0;
            if (batchAmount <= 0) {
                alert('请输入有效的核销金额！');
                return;
            }

            // 1. 获取勾选的复选框
            const checkboxes = document.querySelectorAll(`.${type}-writeoff:checked`);
            if (checkboxes.length === 0) {
                alert('请至少勾选一条记录！');
                return;
            }

            // 2. 批量填写金额到输入框（保留原有逻辑）
            checkboxes.forEach(checkbox => {
                const containerId = checkbox.getAttribute('data-container-id');
                const amountInput = document.querySelector(`.write-off-amount[data-container-id="${containerId}"]`);
                if (amountInput) {
                    amountInput.value = batchAmount;
                }
            });

            // 3. 收集container_number_id（替换itemv2_id，过滤空值）
            const containerIds = [];
            const emptyIdIndexes = [];
            checkboxes.forEach((checkbox, index) => {
                // 核心：获取data-container-id（即container_number_id）
                const containerId = checkbox.getAttribute('data-container-id')?.trim() || '';
                console.log(`勾选框${index + 1}的container_number_id：`, containerId);
                if (containerId) {
                    containerIds.push(containerId);
                } else {
                    emptyIdIndexes.push(index + 1);
                    console.warn(`勾选框${index + 1}的data-container-id为空`);
                }
            });

            // 提示空ID（保留原有逻辑）
            if (emptyIdIndexes.length > 0) {
                const confirmContinue = confirm(`注意：勾选框${emptyIdIndexes.join(',')}无有效集装箱ID，是否继续处理其他记录？`);
                if (!confirmContinue) {
                    return;
                }
            }
            if (containerIds.length === 0) {
                alert('所有勾选的记录都没有有效集装箱ID，无法执行批量核销！');
                return;
            }

            // 4. 给卸柜隐藏form赋值（核心：替换为container_number_ids）
            const batchForm = document.getElementById('batch-writeoff-form-x');
            document.getElementById('batch-writeoff-type-x').value = type;
            document.getElementById('batch-writeoff-amount-x').value = batchAmount;
            document.getElementById('batch-writeoff-container-ids-x').value = containerIds.join(','); // 多个集装箱ID用逗号分隔

            // 5. 提交form表单（自动携带CSRF Token）
            batchForm.submit();
        }

        // ===================== 辅助功能函数：通用 =====================
        // 客户下拉框选中状态修复
        window.addEventListener('load', function () {
            const customerSelect = document.getElementById('id_customer_name');
            const selectedCustomerId = "{{ selected_customer_id|default:'' }}";
            if (selectedCustomerId && customerSelect) {
                customerSelect.value = selectedCustomerId;
            }
        });

        // 模态框外部点击关闭
        window.onclick = function (event) {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (event.target === modal) {
                    modal.style.display = "none";
                }
            });
        }

        // 滚动到页面底部
        function scrollToBottom() {
            window.scrollTo({
                top: document.body.scrollHeight,
                behavior: 'smooth'
            });
        }

        // 驳回模态框相关
        function showRejectModal(type) {
            const checkboxes = document.querySelectorAll('.' + type + '-orders:checked');
            if (checkboxes.length === 0) {
                alert('请至少选择一条记录');
                return;
            }
            const modal = document.getElementById(type + '-rejectModal');
            if (modal) modal.style.display = 'block';
        }

        function hideRejectModal(type) {
            const modal = document.getElementById(type + '-rejectModal');
            if (modal) modal.style.display = 'none';
        }

        function setRejectReason(type) {
            const reasonInput = document.getElementById(type + '-rejectReason');
            const hiddenInput = document.getElementById(type + '-rejectReasonInput');
            if (!reasonInput || !hiddenInput) return;

            const reason = reasonInput.value.trim();
            if (!reason) {
                alert('请输入驳回原因');
                return;
            }
            hiddenInput.value = reason;
        }

        // 派送账单表格专用过滤函数（新增板数≥数值过滤）
        function filterDeliveryTable(tableType, input) {
            const colIndex = input.dataset.columnIndex;
            const keyword = input.value.trim().toUpperCase();
            // 关键修复：从当前激活的tab-content中查找表格，而非全局查找
            const activeTabContent = document.getElementById(tableType);
            if (!activeTabContent) return;
            const table = activeTabContent.querySelector('.table');
            if (!table) return;

            // 仅过滤数据行，跳过表头/搜索行
            const rows = table.querySelectorAll('tbody tr');
            rows.forEach(row => {
                // 只处理原始显示的行（避免过滤后再过滤导致的合并行错乱）
                if (row.dataset.originalDisplay === undefined) {
                    row.dataset.originalDisplay = row.style.display || '';
                }
                // 恢复原始显示状态，再重新过滤
                row.style.display = row.dataset.originalDisplay;
                if (row.style.display === 'none') return;

                const cell = row.querySelectorAll('td')[colIndex];
                if (!cell) return;
                const cellText = cell.textContent.trim();
                let isMatch = true;

                // 核心新增：判断是否为板数列（index=7），做数值≥比较；其他列做文本包含匹配
                if (colIndex === '7' && keyword) {
                    // 板数列：转数字做 ≥ 比较
                    const cellNum = parseFloat(cellText) || 0;
                    const keywordNum = parseFloat(keyword) || 0;
                    isMatch = cellNum >= keywordNum;
                } else if (keyword) {
                    // 其他列：原文本包含匹配逻辑
                    isMatch = cellText.toUpperCase().includes(keyword);
                }

                row.style.display = isMatch ? '' : 'none';
            });

            // 合并行联动：主行隐藏则子行同步隐藏（仅处理可见主行的合并）
            const mergedRows = table.querySelectorAll('td[rowspan]');
            mergedRows.forEach(td => {
                const mainRow = td.closest('tr');
                if (mainRow.style.display === 'none' && !mainRow.dataset.mergedHidden) {
                    const rowspan = parseInt(td.getAttribute('rowspan'));
                    let currentRow = mainRow;
                    for (let i = 1; i < rowspan; i++) {
                        currentRow = currentRow.nextElementSibling;
                        if (currentRow) {
                            currentRow.dataset.mergedHidden = 'true'; // 标记合并隐藏
                            currentRow.style.display = 'none';
                        }
                    }
                } else if (mainRow.style.display !== 'none' && mainRow.dataset.mergedHidden) {
                    // 主行显示，恢复合并子行
                    const rowspan = parseInt(td.getAttribute('rowspan'));
                    let currentRow = mainRow;
                    for (let i = 1; i < rowspan; i++) {
                        currentRow = currentRow.nextElementSibling;
                        if (currentRow) {
                            delete currentRow.dataset.mergedHidden;
                            currentRow.style.display = currentRow.dataset.originalDisplay || '';
                        }
                    }
                    delete mainRow.dataset.mergedHidden;
                }
            });
        }

        // 待确认账单：过滤后更新全选状态+选中数量（仅作用于可见行）
        function updateDeliveryPendingSelectAllStatus() {
            const pendingCheckboxes = document.querySelectorAll('.delivery-pending-checkbox');
            const pendingSelectAll = document.getElementById('delivery-pending-select-all');
            const pendingSelectAllHeader = document.getElementById('delivery-pending-select-all-header');

            let visibleCount = 0; // 可见行数量
            let checkedVisibleCount = 0; // 可见行中已勾选数量

            pendingCheckboxes.forEach(checkbox => {
                const tr = checkbox.closest('tr');
                // 仅统计未隐藏、非合并子行的复选框
                if (tr && tr.style.display !== 'none' && !tr.dataset.mergedHidden) {
                    visibleCount++;
                    if (checkbox.checked) checkedVisibleCount++;
                }
            });

            // 更新全选框状态：可见行全部勾选则选中，否则取消
            if (pendingSelectAll) pendingSelectAll.checked = (visibleCount > 0 && checkedVisibleCount === visibleCount);
            if (pendingSelectAllHeader) pendingSelectAllHeader.checked = (visibleCount > 0 && checkedVisibleCount === visibleCount);
            // 更新选中数量
            updateDeliveryPendingSelectedCount();
        }

        // 已确认账单：过滤后更新全选状态+选中数量（仅作用于可见行）
        function updateDeliverySelectAllStatus() {
            const deliveryCheckboxes = document.querySelectorAll('.delivery-export-checkbox');
            const deliverySelectAll = document.getElementById('delivery-select-all');
            const deliverySelectAllHeader = document.getElementById('delivery-select-all-header');

            let visibleCount = 0;
            let checkedVisibleCount = 0;

            deliveryCheckboxes.forEach(checkbox => {
                const tr = checkbox.closest('tr');
                if (tr && tr.style.display !== 'none' && !tr.dataset.mergedHidden) {
                    visibleCount++;
                    if (checkbox.checked) checkedVisibleCount++;
                }
            });

            // 更新全选框状态
            if (deliverySelectAll) deliverySelectAll.checked = (visibleCount > 0 && checkedVisibleCount === visibleCount);
            if (deliverySelectAllHeader) deliverySelectAllHeader.checked = (visibleCount > 0 && checkedVisibleCount === visibleCount);
            // 更新选中数量
            updateDeliverySelectedCount();
        }
    </script>
{% endblock %}