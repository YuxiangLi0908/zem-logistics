{% extends 'base.html' %}
{% load custom_filters %}
{% block content %}
    <style>
        /* 复用第一个页面的核心样式变量 */
        :root {
            --primary-color: #1b5e20;
            --secondary-color: #0d3d14;
            --success-color: #2e7d32;
            --warning-color: #ff6f00;
            --danger-color: #b71c1c;
            --light-bg: #f8f9fa;
            --card-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            --border-radius: 12px;
        }

        /* 整体容器样式 */
        .finance-system {
            max-width: 102%;
            margin: 20px auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
            overflow: hidden;
        }

        /* 头部筛选区域 */
        .finance-header {
            background: linear-gradient(135deg, #0d3d14, #1b5e20);
            color: white;
            padding: 25px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        /* 修复：所有费用列（包括其他/总费用）居中对齐 */
        .td, .td_fee, .td_fee_other, .td_fee_total {
            text-align: center !important;
            vertical-align: middle !important;
            min-height: 20px !important;
            line-height: 20px !important;
            position: relative !important;
        }

        /* 其他/总费用的合计文字也居中 */
        .fee-total {
            display: flex !important;
            justify-content: center !important;
            align-items: center !important;
            width: 100% !important;
        }

        /* 修复：其他/总费用无内容时也显示$0.00 */
        .td_fee_other:empty::after,
        .td_fee_other:not(:has(.total-amount))::after,
        .td_fee_total:empty::after,
        .td_fee_total:not(:has(.total-amount))::after {
            content: "$0.00" !important;
            display: inline-block !important;
            color: inherit !important;
            position: absolute !important;
            top: 50% !important;
            left: 50% !important;
            transform: translate(-50%, -50%) !important;
        }

        /* 确保金额span覆盖伪元素 */
        .td_fee_other .total-amount,
        .td_fee_total .total-amount {
            position: relative !important;
            z-index: 1 !important;
            background: white !important;
            padding: 0 2px !important;
        }

        /* 派送账单输入框+按钮同行显示 */
        .delivery-input-group {
            display: flex;
            align-items: center;
            gap: 5px; /* 输入框和按钮之间的间距 */
            width: 100%;
        }

        .delivery-input-group input {
            flex: 1; /* 输入框占满剩余空间 */
            min-width: 0; /* 解决flex布局下输入框宽度溢出 */
        }

        .delivery-input-group .btn {
            flex-shrink: 0; /* 按钮不被挤压 */
            padding: 4px 8px !important;
            font-size: 0.75rem !important;
            height: auto !important;
        }

        /* 新增：操作按钮容器（表格左下方） */
        .table-actions {
            padding: 15px 20px;
            display: flex;
            gap: 15px;
            align-items: center;
            background: var(--light-bg);
            border-top: 1px solid #eaecef;
        }

        /* 新增：回到底部按钮样式 */
        .to-bottom-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 999;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--primary-color);
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            transition: all 0.3s ease;
        }

        .to-bottom-btn:hover {
            background: var(--secondary-color);
            transform: translateY(-2px);
        }

        .filter-controls {
            display: flex;
            align-items: center;
            gap: 45px;
            width: 100%;
            justify-content: flex-start;
        }

        .filter-group {
            display: flex;
            align-items: flex-end;
            gap: 10px;
        }

        .filter-group label {
            font-weight: 600;
            font-size: 0.9rem;
            width: 100%;
        }

        /* 标签页样式 */
        .content-tabs {
            display: flex;
            margin-bottom: 25px;
            border-bottom: 2px solid #eaecef;
            gap: 5px;
        }

        .content-tab {
            padding: 15px 30px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            font-weight: 500;
            position: relative;
            background: var(--light-bg);
            border-radius: 8px 8px 0 0;
        }

        .content-tab.active {
            background: white;
            color: var(--primary-color);
            border-bottom: 3px solid var(--primary-color);
            font-weight: 600;
        }

        .content-tab .tab-badge {
            position: absolute;
            top: 8px;
            right: 8px;
            background: var(--primary-color);
            color: white;
            border-radius: 12px;
            padding: 2px 8px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .tab-content {
            display: none;
            background: white;
            border-radius: 0 0 var(--border-radius) var(--border-radius);
            min-height: 500px;
        }

        .tab-content.active {
            display: block;
        }

        /* 子标签页样式 */
        .sub-content-tabs {
            display: flex;
            margin: 15px 0;
            border-bottom: 2px solid #eaecef;
            gap: 5px;
        }

        .sub-content-tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            font-weight: 500;
            position: relative;
            background: var(--light-bg);
            border-radius: 8px 8px 0 0;
            font-size: 0.9rem;
        }

        .sub-content-tab.active {
            background: white;
            color: var(--primary-color);
            border-bottom: 3px solid var(--primary-color);
            font-weight: 600;
        }

        /* 容器区域样式 */
        .container-section {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--card-shadow);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            margin-bottom: 25px;
            border: 1px solid #f0f0f0;
            position: relative;
        }

        .section-header {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            padding: 20px;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .section-header h3 {
            margin: 0;
            color: var(--secondary-color);
            font-size: 1.2rem;
            font-weight: 600;
        }

        .section-count {
            background: var(--primary-color);
            color: white;
            border-radius: 20px;
            padding: 4px 12px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        /* 彻底锁定表格容器宽度，禁止任何收缩/扩展 */
        .table-container {
            width: 100% !important;
            min-width: 100% !important;
            max-width: 100% !important;
            overflow-x: auto !important;
            box-sizing: border-box !important;
            flex: none !important;
            position: relative !important;
            transition: none !important;
        }

        /* 强制表格固定布局，列宽仅由<th>决定 */
        .table {
            width: 100% !important;
            min-width: 100% !important;
            max-width: 100% !important;
            table-layout: fixed !important; /* 固定布局核心 */
            border-collapse: separate !important;
            border-spacing: 0 !important;
            box-sizing: border-box !important;
            transition: none !important;
        }

        /* 给每个表头设置固定像素宽度，禁止自动计算 */
        .table th {
            box-sizing: border-box !important;
            padding: 8px !important;
            white-space: nowrap !important;
            overflow: hidden !important;
            text-overflow: ellipsis !important;
            vertical-align: middle !important;
        }

        /* 待确认账单列宽（14列） */
        #delivery-pending .table th:nth-child(1) {
            width: 50px !important;
        }

        /* 复选框 */
        #delivery-pending .table th:nth-child(2) {
            width: 100px !important;
        }

        /* 车次 */
        #delivery-pending .table th:nth-child(3) {
            width: 120px !important;
        }

        /* Carrier */
        #delivery-pending .table th:nth-child(4) {
            width: 150px !important;
        }

        /* Pickup Number */
        #delivery-pending .table th:nth-child(5) {
            width: 80px !important;
        }

        /* ISA */
        #delivery-pending .table th:nth-child(6) {
            width: 100px !important;
        }

        /* 柜号 */
        #delivery-pending .table th:nth-child(7) {
            width: 120px !important;
        }

        /* 目的地 */
        #delivery-pending .table th:nth-child(8) {
            width: 80px !important;
        }

        /* 板数 */
        #delivery-pending .table th:nth-child(9) {
            width: 80px !important;
        }

        /* 价格 */
        #delivery-pending .table th:nth-child(10) {
            width: 80px !important;
        }

        /* 单板成本 */
        #delivery-pending .table th:nth-child(11) {
            width: 80px !important;
        }

        /* 车次总板数 */
        #delivery-pending .table th:nth-child(12) {
            width: 100px !important;
        }

        /* 车次总成本 */
        #delivery-pending .table th:nth-child(13) {
            width: 100px !important;
        }

        /* 核销金额 */
        #delivery-pending .table th:nth-child(14) {
            width: 150px !important;
        }

        /* 备注 */

        /* 已确认账单列宽（15列，多核销时间） */
        #delivery-confirm .table th:nth-child(1) {
            width: 50px !important;
        }

        /* 复选框 */
        #delivery-confirm .table th:nth-child(2) {
            width: 100px !important;
        }

        /* 车次 */
        #delivery-confirm .table th:nth-child(3) {
            width: 120px !important;
        }

        /* Carrier */
        #delivery-confirm .table th:nth-child(4) {
            width: 150px !important;
        }

        /* Pickup Number */
        #delivery-confirm .table th:nth-child(5) {
            width: 80px !important;
        }

        /* ISA */
        #delivery-confirm .table th:nth-child(6) {
            width: 100px !important;
        }

        /* 柜号 */
        #delivery-confirm .table th:nth-child(7) {
            width: 120px !important;
        }

        /* 目的地 */
        #delivery-confirm .table th:nth-child(8) {
            width: 80px !important;
        }

        /* 板数 */
        #delivery-confirm .table th:nth-child(9) {
            width: 80px !important;
        }

        /* 价格 */
        #delivery-confirm .table th:nth-child(10) {
            width: 80px !important;
        }

        /* 单板成本 */
        #delivery-confirm .table th:nth-child(11) {
            width: 80px !important;
        }

        /* 车次总板数 */
        #delivery-confirm .table th:nth-child(12) {
            width: 100px !important;
        }

        /* 车次总成本 */
        #delivery-confirm .table th:nth-child(13) {
            width: 100px !important;
        }

        /* 核销金额 */
        #delivery-confirm .table th:nth-child(14) {
            width: 100px !important;
        }

        /* 核销时间 */
        #delivery-confirm .table th:nth-child(15) {
            width: 150px !important;
        }

        /* 备注 */

        /* 表格单元格统一样式，禁止溢出 */
        .table td {
            box-sizing: border-box !important;
            white-space: nowrap !important;
            overflow: hidden !important;
            text-overflow: ellipsis !important;
            vertical-align: middle !important;
        }

        /* 禁止动态添加的单元格影响布局 */
        .added-empty-cell {
            width: inherit !important;
            min-width: inherit !important;
            max-width: inherit !important;
            padding: 0 !important;
            border: none !important;
        }

        /* 合并行单元格强制继承列宽，禁止干扰布局 */
        .table td[rowspan], .table th[rowspan],
        .table td[colspan], .table th[colspan] {
            width: 100% !important; /* 改为100%，继承列宽 */
            min-width: inherit !important;
            max-width: inherit !important;
            box-sizing: border-box !important;
            white-space: nowrap !important; /* 禁止单元格内容换行导致宽度变化 */
            overflow: hidden !important;
            text-overflow: ellipsis !important;
        }

        /* 搜索行的输入框禁止影响列宽 */
        .search-row input {
            width: 100% !important;
            min-width: 0 !important;
            box-sizing: border-box !important;
            border: 1px solid #eee !important;
            padding: 4px !important;
        }


        .search-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(27, 94, 32, 0.1);
        }

        /* 按钮样式 */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .btn-sm {
            padding: 0.375rem 0.75rem;
            font-size: 0.875rem;
            border-radius: 6px;
        }

        .btn-primary {
            background: #007bff;
            color: white;
        }

        .btn-primary:hover {
            background: #0069d9;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .btn-success {
            background: var(--success-color);
            color: white;
        }

        .btn-success:hover {
            background: #219652;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .btn-danger {
            background: var(--danger-color);
            color: white;
        }

        .btn-danger:hover {
            background: #d32f2f;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .btn-info {
            background: #17a2b8;
            color: white;
        }

        .btn-info:hover {
            background: #138496;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .btn-warning {
            background: var(--warning-color);
            color: white;
        }

        .btn-warning:hover {
            background: #e65c00;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        /* 表单控件样式 */
        select, input[type="date"], input[type="text"], textarea {
            padding: 8px 15px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            background: white;
            font-size: 0.95rem;
            min-width: 150px;
            transition: all 0.3s ease;
        }

        select:focus, input[type="date"]:focus, input[type="text"]:focus, textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(27, 94, 32, 0.1);
        }

        textarea {
            width: 100%;
            min-height: 100px;
            resize: vertical;
        }

        /* 提示框样式 */
        .alert {
            padding: 15px;
            margin: 20px 0;
            border: 1px solid transparent;
            border-radius: 8px;
            font-size: 0.95rem;
            text-align: center;
        }

        .alert-info {
            color: #0c5460;
            background-color: #d1ecf1;
            border-color: #bee5eb;
        }

        /* 模态框样式 */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.4);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 10% auto;
            padding: 30px;
            border: 1px solid #888;
            width: 50%;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
        }

        .modal-content h5 {
            margin-top: 0;
            color: var(--secondary-color);
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 20px;
        }

        /* 链接样式 */
        .container-link {
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s ease;
            padding: 3px 6px;
            border-radius: 4px;
            font-size: 14px;
        }

        .container-link:hover {
            text-decoration: underline;
            background: rgba(27, 94, 32, 0.1);
        }

        /* 操作按钮区域 - 隐藏原有按钮 */
        .action-buttons {
            display: none !important;
        }

        /* 导出控件样式 - 核心修改：解决换行问题 */
        .export-controls {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 12px 20px;
            background: var(--light-bg);
            border-radius: 8px;
            margin: 15px 0;
            /* 核心：强制不换行，且设置最小宽度避免挤压 */
            flex-wrap: nowrap;
            white-space: nowrap;
            width: 100%;
            box-sizing: border-box;
            align-items: center !important;
        }

        .export-controls h6 {
            margin: 0 !important;
            white-space: nowrap;
            font-size: 0.9rem;
            /* 固定标题宽度，避免挤压 */
            width: 80px;
            flex-shrink: 0;
        }

        .export-controls .export-filter-form {
            display: flex;
            align-items: center !important;
            gap: 15px;
            width: auto !important;
            margin: 0;
            padding: 0;
            /* 允许表单区域自适应，不强制100%宽度 */
            flex-grow: 0;
            flex-shrink: 0;
        }

        /* 核心修改：供应商类型筛选组 - 强制单行 */
        .export-controls .filter-group {
            display: flex;
            align-items: center !important;
            gap: 8px;
            margin: 0;
            padding: 0;
            /* 强制不换行，固定行高 */
            white-space: nowrap;
            height: 38px;
            align-items: center !important;
        }

        .export-controls .filter-group label {
            margin: 0;
            padding: 0;
            font-size: 0.85rem;
            white-space: nowrap;
            /* 固定标签宽度，避免换行 */
            width: 70px;
            text-align: right;
            flex-shrink: 0;
        }

        .export-controls select,
        .export-controls input[type="date"] {
            min-width: 120px !important;
            width: 120px !important;
            padding: 6px 10px;
            font-size: 0.85rem;
            height: 32px;
            /* 禁止拉伸，固定宽度 */
            flex-shrink: 0;
        }

        /* ========== 重点修改：查询和导出按钮样式 ========== */
        .export-controls .btn {
            white-space: nowrap;
            height: 38px;
            padding: 0 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.85rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            /* 按钮固定宽度，避免挤压 */
            flex-shrink: 0;
        }

        /* 查询按钮样式强化 */
        .query-btn {
            background: var(--primary-color) !important;
            color: white !important;
            font-weight: 600 !important;
            min-width: 80px !important;
        }

        .query-btn:hover {
            background: var(--secondary-color) !important;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15) !important;
        }

        /* 导出勾选按钮样式强化 */
        .export-selected-btn {
            background: #28a745 !important;
            color: white !important;
            font-weight: 600 !important;
            min-width: 100px !important;
        }

        .export-selected-btn:hover {
            background: #218838 !important;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15) !important;
        }

        /* ========== 按钮样式修改结束 ========== */

        /* 费用合计样式 */
        .fee-total {
            font-weight: 600;
            color: var(--danger-color);
        }

        /* 响应式适配 */
        @media (max-width: 1400px) {
            .finance-header {
                padding: 20px;
            }

            .filter-controls {
                gap: 15px;
            }

            /* 响应式时导出控件允许换行（避免移动端挤压） */
            .export-controls {
                flex-wrap: wrap;
            }

            .export-controls .export-filter-form {
                width: 100% !important;
                margin-top: 10px;
            }

            /* 响应式时固定按钮换行 */
            .table-actions {
                flex-wrap: wrap;
            }

            .to-bottom-btn {
                width: 40px;
                height: 40px;
                bottom: 20px;
                right: 20px;
            }
        }

        @media (max-width: 768px) {
            .finance-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .content-tabs, .sub-content-tabs {
                flex-wrap: wrap;
            }

            .content-tab, .sub-content-tab {
                flex: 1;
                min-width: 120px;
                text-align: center;
                padding: 12px 15px;
            }

            .modal-content {
                width: 90%;
            }

            .btn {
                width: 100%;
            }

            /* 移动端导出控件堆叠显示 */
            .export-controls {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .export-controls h6 {
                width: 100%;
                text-align: left;
            }

            .export-controls .export-filter-form {
                flex-direction: column;
                align-items: flex-start;
                width: 100%;
            }

            .export-controls .filter-group {
                width: 100%;
                height: auto;
            }

            .export-controls .filter-group label {
                width: 100%;
                text-align: left;
                margin-bottom: 5px;
            }

            .export-controls select,
            .export-controls input[type="date"] {
                width: 100%;
                min-width: unset;
            }

            .export-controls .btn {
                width: 100%;
            }
        }

        /* 勾选列样式 */
        .export-checkbox-col {
            width: 50px !important;
            min-width: 50px !important;
            text-align: center !important;
        }

        .export-select-all-container {
            padding: 10px 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            background: var(--light-bg);
            border-bottom: 1px solid #eaecef;
        }

        .export-selected-count {
            color: var(--primary-color);
            font-weight: 600;
        }
    </style>

    <div class="finance-system">
        <!-- 头部筛选区域 -->
        <div class="finance-header">
            <div class="finance-logo">
                <i class="fas fa-file-invoice-dollar"></i>
                <span>待确认账单管理-派送账单</span>
            </div>
            <form method="post" action="" class="filter-controls">
                {% csrf_token %}
                <div class="filter-group">
                    <label><i class="fas fa-user"></i> 客户:</label>
                    <!-- 修复：直接渲染表单控件，删除错误的if判断 -->
                    {{ order_form.customer_name }}
                    <script>
                        document.addEventListener('DOMContentLoaded', function () {
                            const customerSelect = document.getElementById('id_customer_name');
                            const selectedCustomerId = "{{ selected_customer_id|default:'' }}";
                            if (selectedCustomerId && customerSelect) {
                                // 确保选项存在再赋值，避免报错
                                const option = customerSelect.querySelector(`option[value="${selectedCustomerId}"]`);
                                if (option) {
                                    customerSelect.value = selectedCustomerId;
                                }
                            }
                        });
                    </script>
                </div>
                <div class="filter-group">
                    <label>
                        {% if invoice_type_filter == 'payable' %}
                            <i class="fas fa-calendar-alt"></i> ETD时间:
                        {% endif %}
                    </label>
                    <input type="date" name="start_date_confirm" value="{{ start_date_confirm }}">
                    <input type="date" name="end_date_confirm" value="{{ end_date_confirm }}">
                </div>
                <div class="filter-group">
                    <label><i class="fas fa-warehouse"></i> 仓点区域:</label>
                    <select name="warehouse_filter">
                        {% for k, v in warehouse_options.items %}
                            <option value="{{ v }}" {% if warehouse_filter == v %}selected{% endif %}>{{ k }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="filter-group">
                    <label><i class="fas fa-file-invoice"></i> 账单类型:</label>
                    <select name="invoice_type">
                        <option value="payable" {% if invoice_type_filter == 'payable' %}selected{% endif %}>应付账单
                        </option>
                    </select>
                </div>
                <input type="hidden" name="step" value="invoice_order_confirm_payable_delivery">
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-search"></i> 查询
                </button>
            </form>
        </div>

        <!-- 主内容区域 -->
        <div style="padding: 25px;">
            <!-- 主标签页 -->
            <div class="content-tabs" id="billTypeTabs">
                <div class="content-tab" data-tab="delivery">
                    派送账单
                </div>
            </div>
            <!-- 派送账单内容 -->
            <div id="delivery-content" class="tab-content">
                <div class="container-section">
                    <div class="section-header">
                        <h3>派送账单</h3>
                    </div>

                    <!-- 子标签页 -->
                    <div class="sub-content-tabs">
                        <div class="sub-content-tab active" data-subtab="delivery-pending">
                            待确认 <span class="tab-badge">{{ delivery_pending_orders|length }}</span>
                        </div>
                        <div class="sub-content-tab" data-subtab="delivery-confirm">
                            已确认 <span class="tab-badge">{{ delivery_confirm_orders|length }}</span>
                        </div>
                    </div>

                    <!-- 待确认派送账单 -->
                    <div id="delivery-pending" class="tab-content active">
                        <div class="table-container">
                            {% if delivery_pending_orders %}
                                <div class="export-controls" style="margin-top: 15px;">
                                    <h6><b>待确认导出：</b></h6>
                                    <!-- 全选区域 -->
                                    <div class="export-select-all-container" style="margin-right: 15px;">
                                        <input type="checkbox" id="delivery-pending-select-all"
                                               onclick="toggleSelectAll('delivery-pending-select-all', 'delivery-pending-checkbox')"
                                               style="width: 18px; height: 18px; cursor: pointer;">
                                        <label for="delivery-pending-select-all"
                                               style="margin: 0; font-weight: 500; cursor: pointer;">全选</label>
                                        <span class="export-selected-count" id="delivery-pending-selected-count">已选：0 条</span>
                                    </div>
                                    <!-- 待确认导出表单 - 传递fleet_number -->
                                    <form method="post" class="export-filter-form" id="delivery-pending-export-form"
                                          onsubmit="return collectSelectedPendingFleetIds()">
                                        {% csrf_token %}
                                        <input type="hidden" name="step" value="export_carrier_payable_delivery">
                                        <!-- 后端区分待确认/已确认的step -->
                                        <input type="hidden" name="confirm_phase" value="delivery_pending">
                                        <input type="hidden" name="start_date_export" value="{{ start_date_confirm }}">
                                        <input type="hidden" name="end_date_export" value="{{ end_date_confirm }}">
                                        <input type="hidden" name="warehouse_filter" value="{{ warehouse_filter }}">
                                        <input type="hidden" name="customer_name"
                                               value="{{ selected_customer_id|default:'' }}">
                                        <!-- 隐藏字段存储选中的fleet_number -->
                                        <input type="hidden" name="selected_fleet_ids" id="selected_pending_fleet_ids"
                                               value="">
                                        <button type="submit" class="btn btn-warning btn-sm export-selected-btn">
                                            <i class="fas fa-file-excel"></i> 导出待确认Excel
                                        </button>
                                    </form>
                                </div>
                                <form method="post" id="delivery-confirm-form">
                                    {% csrf_token %}
                                    <input type="hidden" name="step" value="payable_confirm_phase">
                                    <input type="hidden" name="confirm_phase" value="delivery">
                                    <table class="table">
                                        <thead>
                                        <tr>
                                            <th class="th export-checkbox-col"
                                                style="vertical-align: middle; width: 50px;">
                                                <input type="checkbox" id="delivery-pending-select-all-header"
                                                       onclick="toggleSelectAll('delivery-pending-select-all-header', 'delivery-pending-checkbox')"
                                                       style="width: 18px; height: 18px; cursor: pointer;">
                                            </th>
                                            <th class="th" style="vertical-align: middle;">车次</th>
                                            <th class="th" style="vertical-align: middle;">Carrier</th>
                                            <th class="th" style="vertical-align: middle;">Pickup Number</th>
                                            <th class="th" style="vertical-align: middle;">ISA</th>
                                            <th class="th" style="vertical-align: middle;">柜号</th>
                                            <th class="th" style="vertical-align: middle;">目的地</th>
                                            <th class="th" style="vertical-align: middle;">板数</th>
                                            <th class="th" style="vertical-align: middle;">价格</th>
                                            <th class="th" style="vertical-align: middle;">单板成本</th>
                                            <th class="th" style="vertical-align: middle;">车次总板数</th>
                                            <th class="th" style="vertical-align: middle;">车次总成本</th>
                                            <th class="th" style="vertical-align: middle;">核销金额</th>
                                            <th class="th" style="vertical-align: middle;">备注</th>
                                        </tr>
                                        </thead>
                                        <tr class="search-row">
                                            <th class="th export-checkbox-col"></th>
                                            <th class="th">
                                                <input type="text" class="search-input"
                                                       data-column-index="1"
                                                       placeholder="搜索车次"
                                                       data-column-name="车次">
                                            </th>
                                            <th class="th">
                                                <input type="text" class="search-input"
                                                       data-column-index="2"
                                                       placeholder="搜索Carrier"
                                                       data-column-name="Carrier">
                                            </th>
                                            <th class="th">
                                                <input type="text" class="search-input"
                                                       data-column-index="3"
                                                       placeholder="搜索Pickup Number"
                                                       data-column-name="Pickup Number">
                                            </th>
                                            <th class="th">
                                                <input type="text" class="search-input"
                                                       data-column-index="4"
                                                       placeholder="搜索ISA"
                                                       data-column-name="ISA"> <!-- 关键：添加列名 -->
                                            </th>
                                            <th class="th">
                                                <input type="text" class="search-input"
                                                       data-column-index="5"
                                                       placeholder="搜索柜号"
                                                       data-column-name="柜号"> <!-- 关键：添加列名 -->
                                            </th>
                                            <th class="th">
                                                <input type="text" class="search-input"
                                                       data-column-index="6"
                                                       placeholder="搜索目的地"
                                                       data-column-name="目的地"> <!-- 关键：添加列名 -->
                                            </th>
                                            <th class="th">
                                                <input type="number" class="search-input"
                                                       data-column-index="7"
                                                       min="0"
                                                       placeholder="板数≥"
                                                       data-column-name="板数"> <!-- 关键：添加列名 -->
                                            </th>
                                            <th class="th"></th>
                                            <th class="th"></th>
                                            <th class="th"></th>
                                            <th class="th"></th>
                                            <th class="th"></th>
                                            <th class="th"></th>
                                        </tr>
                                        <tbody>
                                        {% for fleet in delivery_pending_orders %}
                                            {% for pickup_number, pickup_data in fleet.fleets.items %}
                                                {% for appointment_id, appointment_data in pickup_data.appointments.items %}
                                                    {% for order in appointment_data.orders %}
                                                        <tr>
                                                            {% if forloop.parentloop.first and forloop.first %}
                                                                <td class="td export-checkbox-col"
                                                                    rowspan="{{ pickup_data.total_rows }}"
                                                                    style="vertical-align: middle;">
                                                                    <input type="checkbox"
                                                                           class="delivery-pending-checkbox"
                                                                           value="{{ fleet.fleet_id|default:'' }}"
                                                                           data-fleet-id="{{ fleet.fleet_id|default:'' }}"
                                                                           style="width: 16px; height: 16px;">
                                                                </td>
                                                                <td class="td" rowspan="{{ pickup_data.total_rows }}"
                                                                    style="vertical-align: middle;">
                                                                    {{ fleet.fleet_number|default_if_none:"" }}
                                                                </td>
                                                                <td class="td" rowspan="{{ pickup_data.total_rows }}"
                                                                    style="vertical-align: middle;">
                                                                    {{ fleet.carrier|default_if_none:"" }}
                                                                </td>
                                                                <td class="td" rowspan="{{ pickup_data.total_rows }}"
                                                                    style="vertical-align: middle;">
                                                                    {{ pickup_number|default_if_none:"" }}
                                                                </td>
                                                            {% endif %}

                                                            {% if forloop.first %}
                                                                <td class="td" rowspan="{{ appointment_data.rowspan }}"
                                                                    style="vertical-align: middle;">
                                                                    {{ appointment_id|default_if_none:"" }}
                                                                </td>
                                                            {% endif %}

                                                            <td class="td"
                                                                style="vertical-align: middle;">{{ order.container_num }}</td>
                                                            <td class="td"
                                                                style="vertical-align: middle;">{{ order.pallet_destination }}</td>
                                                            <td class="td"
                                                                style="vertical-align: middle;">{{ order.cn_total_pallet }}</td>
                                                            <td class="td"
                                                                style="vertical-align: middle;">{{ order.cn_total_expense }}</td>
                                                            <td class="td"
                                                                style="vertical-align: middle;">{{ order.cn_per_expense }}</td>
                                                            {% if forloop.parentloop.first and forloop.first %}
                                                                <td class="td" rowspan="{{ pickup_data.total_rows }}"
                                                                    style="vertical-align: middle;">
                                                                    {{ pickup_data.ISA_total_pallets }}
                                                                </td>
                                                                <td class="td" rowspan="{{ pickup_data.total_rows }}"
                                                                    style="vertical-align: middle;">
                                                                    ${{ pickup_data.ISA_total_expense }}
                                                                </td>
                                                                <td class="td" rowspan="{{ pickup_data.total_rows }}"
                                                                    style="vertical-align: middle;">
                                                                    <div class="delivery-input-group">
                                                                        <input type="number" name="write_off_amount"
                                                                               class="write-off-amount"
                                                                               data-container-id="{{ order.object.container_number.id }}"
                                                                               step="0.01" min="0"
                                                                               placeholder="输入核销金额"
                                                                               style="padding: 4px 8px; border: 1px solid #ced4da; border-radius: 4px; text-align: center;">
                                                                        <form action="" method="post"
                                                                              class="single-writeoff-form"
                                                                              style="margin: 0;">
                                                                            {% csrf_token %}
                                                                            <input type="hidden" name="step"
                                                                                   value="write_off_amount_post_delivery">
                                                                            <input type="hidden" name="container_id"
                                                                                   value="{{ order.object.container_number.id }}">
                                                                            <input type="hidden" name="write_off_type"
                                                                                   value="pick-x">
                                                                            <input type="hidden"
                                                                                   name="start_date_confirm"
                                                                                   value="{{ start_date_confirm }}">
                                                                            <input type="hidden" name="end_date_confirm"
                                                                                   value="{{ end_date_confirm }}">
                                                                            <input type="hidden" name="warehouse_filter"
                                                                                   value="{{ warehouse_filter }}">
                                                                            <input type="hidden" name="customer_name"
                                                                                   value="{{ selected_customer_id|default:'' }}">
                                                                            <button type="submit"
                                                                                    class="btn btn-success btn-sm">确认
                                                                            </button>
                                                                        </form>
                                                                    </div>
                                                                </td>
                                                                <td class="td" rowspan="{{ pickup_data.total_rows }}"
                                                                    style="vertical-align: middle;">
                                                                    <div class="delivery-input-group">
                                                                        <input type="text" name="note_delivery"
                                                                               class="write-off-amount-note"
                                                                               data-container-id="{{ order.object.container_number.id }}"
                                                                               placeholder="输入备注"
                                                                               value="{{ order.itemv2_data.note }}"
                                                                               style="padding: 4px 8px; border: 1px solid #ced4da; border-radius: 4px; text-align: center;">
                                                                        <form action="" method="post"
                                                                              class="note-submit-form"
                                                                              style="margin: 0;">
                                                                            {% csrf_token %}
                                                                            <input type="hidden" name="step"
                                                                                   value="note_post_delivery">
                                                                            <input type="hidden" name="container_id"
                                                                                   value="{{ order.object.container_number.id }}">
                                                                            <input type="hidden" name="write_off_type"
                                                                                   value="pick-x">
                                                                            <input type="hidden"
                                                                                   name="start_date_confirm"
                                                                                   value="{{ start_date_confirm }}">
                                                                            <input type="hidden" name="end_date_confirm"
                                                                                   value="{{ end_date_confirm }}">
                                                                            <input type="hidden" name="warehouse_filter"
                                                                                   value="{{ warehouse_filter }}">
                                                                            <input type="hidden" name="customer_name"
                                                                                   value="{{ selected_customer_id|default:'' }}">
                                                                            <button type="submit"
                                                                                    class="btn btn-success btn-sm">确认
                                                                            </button>
                                                                        </form>
                                                                    </div>
                                                                </td>
                                                            {% endif %}
                                                        </tr>
                                                    {% endfor %}
                                                {% endfor %}
                                            {% endfor %}
                                        {% endfor %}
                                        </tbody>
                                    </table>
                                </form>
                            {% else %}
                                <div class="alert alert-info">暂无待确认的派送账单</div>
                            {% endif %}
                        </div>
                    </div>
                    <!-- 已确认派送账单 -->
                    <div id="delivery-confirm" class="tab-content">
                        <div class="table-container">
                            {% if delivery_confirm_orders %}
                                <!-- 导出控件 - 新增全选和选中数量显示 -->
                                <div class="export-controls">
                                    <h6><b>导出选项：</b></h6>
                                    <!-- 新增全选区域 -->
                                    <div class="export-select-all-container" style="margin-right: 15px;">
                                        <input type="checkbox" id="delivery-select-all"
                                               onclick="toggleSelectAll('delivery-select-all', 'delivery-export-checkbox')"
                                               style="width: 18px; height: 18px; cursor: pointer;">
                                        <label for="delivery-select-all"
                                               style="margin: 0; font-weight: 500; cursor: pointer;">全选</label>
                                        <span class="export-selected-count"
                                              id="delivery-selected-count">已选：0 条</span>
                                    </div>

                                    <form method="post" class="export-filter-form" id="delivery-query-form"
                                          style="margin-bottom: 10px;">
                                        {% csrf_token %}
                                        <div class="filter-group">
                                            <label>供应商：</label>
                                            <select name="select_carrier">
                                                {% for key,value in CARRIER_FLEET.items %}
                                                    <option value="{{ key }}"
                                                            {% if selected_carrier == key %}selected{% endif %}>
                                                        {{ value }}
                                                    </option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                        <input type="hidden" name="step"
                                               value="export_delivery_by_month_carrier_v1_search">
                                        <input type="hidden" name="start_date_confirm" value="{{ start_date_confirm }}">
                                        <input type="hidden" name="end_date_confirm" value="{{ end_date_confirm }}">
                                        <input type="hidden" name="warehouse_filter" value="{{ warehouse_filter }}">
                                        <input type="hidden" name="customer_name"
                                               value="{{ selected_customer_id|default:'' }}">
                                        <button type="submit" class="btn query-btn btn-sm btn-primary"
                                                style="margin-right: 10px; margin-top: 13px;">
                                            <i class="fas fa-search"></i> 查询
                                        </button>
                                    </form>

                                    <!-- 导出表单 - 新增传递选中的 fleet id -->
                                    <form method="post" class="export-filter-form" id="delivery-export-form"
                                          onsubmit="return collectSelectedFleetIds()">
                                        {% csrf_token %}
                                        <input type="hidden" name="step" value="export_carrier_payable_delivery">
                                        <input type="hidden" name="confirm_phase" value="delivery">
                                        <input type="hidden" name="start_date_export" value="{{ start_date_confirm }}">
                                        <input type="hidden" name="end_date_export" value="{{ end_date_confirm }}">
                                        <input type="hidden" name="select_carrier"
                                               value="{{ selected_carrier|default:'' }}">
                                        <!-- 新增隐藏字段存储选中的 fleet id -->
                                        <input type="hidden" name="selected_fleet_ids" id="selected_fleet_ids" value="">
                                        <button type="submit" class="btn btn-warning btn-sm">
                                            <i class="fas fa-file-excel"></i> 导出Excel
                                        </button>
                                    </form>
                                </div>

                                <form method="post" id="delivery-confirm-form">
                                    {% csrf_token %}
                                    <input type="hidden" name="step" value="payable_confirm_phase">
                                    <input type="hidden" name="confirm_phase" value="delivery">
                                    <table class="table">
                                        <thead>
                                        <tr>
                                            <!-- 新增：多选框列 -->
                                            <th class="th export-checkbox-col"
                                                style="vertical-align: middle; width: 50px;">
                                                <input type="checkbox" id="delivery-select-all-header"
                                                       onclick="toggleSelectAll('delivery-select-all-header', 'delivery-export-checkbox')"
                                                       style="width: 18px; height: 18px; cursor: pointer;">
                                            </th>
                                            <th class="th" style="vertical-align: middle;">车次</th>
                                            <th class="th" style="vertical-align: middle;">Carrier</th>
                                            <th class="th" style="vertical-align: middle;">Pickup Number</th>
                                            <th class="th" style="vertical-align: middle;">ISA</th>
                                            <th class="th" style="vertical-align: middle;">柜号</th>
                                            <th class="th" style="vertical-align: middle;">目的地</th>
                                            <th class="th" style="vertical-align: middle;">板数</th>
                                            <th class="th" style="vertical-align: middle;">价格</th>
                                            <th class="th" style="vertical-align: middle;">单板成本</th>
                                            <th class="th" style="vertical-align: middle;">车次总板数</th>
                                            <th class="th" style="vertical-align: middle;">车次总成本</th>
                                            <th class="th" style="vertical-align: middle;">核销金额</th>
                                            <th class="th" style="vertical-align: middle;">核销时间</th>
                                            <th class="th" style="vertical-align: middle;">备注</th>
                                        </tr>
                                        </thead>
                                        <tr class="search-row">
                                            <th class="th export-checkbox-col"></th>
                                            <th class="th">
                                                <input type="text" class="search-input"
                                                       data-column-index="1"
                                                       placeholder="搜索车次"
                                                       data-column-name="车次">
                                            </th>
                                            <th class="th">
                                                <input type="text" class="search-input"
                                                       data-column-index="2"
                                                       placeholder="搜索Carrier"
                                                       data-column-name="Carrier">
                                            </th>
                                            <th class="th">
                                                <input type="text" class="search-input"
                                                       data-column-index="3"
                                                       placeholder="搜索Pickup Number"
                                                       data-column-name="Pickup Number">
                                            </th>
                                            <th class="th">
                                                <input type="text" class="search-input"
                                                       data-column-index="4"
                                                       placeholder="搜索ISA"
                                                       data-column-name="ISA"> <!-- 关键：添加列名 -->
                                            </th>
                                            <th class="th">
                                                <input type="text" class="search-input"
                                                       data-column-index="5"
                                                       placeholder="搜索柜号"
                                                       data-column-name="柜号"> <!-- 关键：添加列名 -->
                                            </th>
                                            <th class="th">
                                                <input type="text" class="search-input"
                                                       data-column-index="6"
                                                       placeholder="搜索目的地"
                                                       data-column-name="目的地"> <!-- 关键：添加列名 -->
                                            </th>
                                            <th class="th">
                                                <input type="number" class="search-input"
                                                       data-column-index="7"
                                                       min="0"
                                                       placeholder="板数≥"
                                                       data-column-name="板数"> <!-- 关键：添加列名 -->
                                            </th>
                                            <th class="th"></th>
                                            <th class="th"></th>
                                            <th class="th"></th>
                                            <th class="th"></th>
                                            <th class="th"></th>
                                            <th class="th"></th>
                                        </tr>
                                        <tbody>
                                        {% for fleet in delivery_confirm_orders %}
                                            {% for pickup_number, pickup_data in fleet.fleets.items %}
                                                {% for appointment_id, appointment_data in pickup_data.appointments.items %}
                                                    {% for order in appointment_data.orders %}
                                                        <tr>
                                                            <!-- 新增：多选框单元格 -->
                                                            {% if forloop.parentloop.first and forloop.first %}
                                                                <td class="td export-checkbox-col"
                                                                    rowspan="{{ pickup_data.total_rows }}"
                                                                    style="vertical-align: middle;">
                                                                    <input type="checkbox"
                                                                           class="delivery-export-checkbox"
                                                                           value="{{ fleet.fleet_id|default:'' }}"
                                                                           data-fleet-id="{{ fleet.fleet_id|default:'' }}"
                                                                           style="width: 16px; height: 16px;">
                                                                </td>
                                                            {% endif %}

                                                            {% if forloop.parentloop.first and forloop.first %}
                                                                <td class="td" rowspan="{{ pickup_data.total_rows }}"
                                                                    style="vertical-align: middle;">
                                                                    {{ fleet.fleet_number|default_if_none:"" }}
                                                                </td>
                                                                <td class="td" rowspan="{{ pickup_data.total_rows }}"
                                                                    style="vertical-align: middle;">
                                                                    {{ fleet.carrier|default_if_none:"" }}
                                                                </td>
                                                                <td class="td" rowspan="{{ pickup_data.total_rows }}"
                                                                    style="vertical-align: middle;">
                                                                    {{ pickup_number|default_if_none:"" }}
                                                                </td>
                                                            {% endif %}

                                                            {% if forloop.first %}
                                                                <td class="td" rowspan="{{ appointment_data.rowspan }}"
                                                                    style="vertical-align: middle;">
                                                                    {{ appointment_id|default_if_none:"" }}
                                                                </td>
                                                            {% endif %}

                                                            <td class="td"
                                                                style="vertical-align: middle;">{{ order.container_num }}</td>
                                                            <td class="td"
                                                                style="vertical-align: middle;">{{ order.pallet_destination }}</td>
                                                            <td class="td"
                                                                style="vertical-align: middle;">{{ order.cn_total_pallet }}</td>
                                                            <td class="td"
                                                                style="vertical-align: middle;">{{ order.cn_total_expense }}</td>
                                                            <td class="td"
                                                                style="vertical-align: middle;">{{ order.cn_per_expense }}</td>
                                                            {% if forloop.parentloop.first and forloop.first %}
                                                                <td class="td" rowspan="{{ pickup_data.total_rows }}"
                                                                    style="vertical-align: middle;">
                                                                    {{ pickup_data.ISA_total_pallets }}
                                                                </td>
                                                                <td class="td" rowspan="{{ pickup_data.total_rows }}"
                                                                    style="vertical-align: middle;">
                                                                    ${{ pickup_data.ISA_total_expense }}
                                                                </td>
                                                            {% endif %}
                                                            <td class="td" rowspan="{{ pickup_data.total_rows }}" style="vertical-align: middle;">
                                                                {{ order.itemv2_data.write_off_amount|default:"0.00" }}
                                                            </td>
                                                            <td class="td" rowspan="{{ pickup_data.total_rows }}" style="vertical-align: middle;">
                                                                {{ order.itemv2_data.write_off_time|date:"Y-m-d"|default:"未核销" }}
                                                            </td>
                                                            <td class="td" rowspan="{{ pickup_data.total_rows }}" style="vertical-align: middle;">
                                                                {{ order.itemv2_data.note|default:"无" }}
                                                            </td>
                                                        </tr>
                                                    {% endfor %}
                                                {% endfor %}
                                            {% endfor %}
                                        {% endfor %}
                                        </tbody>
                                    </table>
                                </form>
                            {% else %}
                                <div class="alert alert-info">暂无已确认的派送账单</div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <!-- 新增：直达底部按钮 -->
    <button class="to-bottom-btn" onclick="scrollToBottom()">
        <i class="fas fa-arrow-down"></i>
    </button>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- 引入字体图标（用于直达底部按钮） -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function () {
            // 初始化标签页切换
            initTabs();

            // 初始化全选功能
            initSelectAll();

            // 绑定所有搜索框事件（核心：替换内联事件）
            bindSearchEvents();

            // 初始化导出收集功能
            initExportCollect();

            // 预加载所有组合行映射关系（一次加载，永久使用）
            preloadCombinedRowsMap();
        });

        // 全局变量：存储每个行对应的组合行列表
        let combinedRowsMap = {
            'delivery-pending': new Map(), // 待确认账单：行元素 → 组合行数组
            'delivery-confirm': new Map()  // 已确认账单：行元素 → 组合行数组
        };

        // ========== 核心：预加载组合行映射（解决子行关联主行问题） ==========
        function preloadCombinedRowsMap() {
            // 处理待确认账单
            buildCombinedRowsMap('delivery-pending');
            // 处理已确认账单
            buildCombinedRowsMap('delivery-confirm');
        }

        function buildCombinedRowsMap(tableType) {
            const tabContent = document.getElementById(tableType);
            if (!tabContent) return;

            const table = tabContent.querySelector('.table');
            const allRows = Array.from(table.querySelectorAll('tr')).filter(row =>
                !row.querySelector('th') && !row.classList.contains('search-row')
            );

            // 第一步：找出所有主行及其覆盖的行范围
            const mainRowsInfo = [];
            let currentRow = 0;

            while (currentRow < allRows.length) {
                const row = allRows[currentRow];
                const rowspanCells = row.querySelectorAll('td[rowspan]');

                if (rowspanCells.length > 0) {
                    // 主行：获取最大rowspan值
                    const maxRowspan = Math.max(...Array.from(rowspanCells).map(cell => parseInt(cell.getAttribute('rowspan')) || 1));
                    // 记录主行覆盖的行范围
                    mainRowsInfo.push({
                        mainRowIndex: currentRow,
                        start: currentRow,
                        end: currentRow + maxRowspan - 1,
                        rows: allRows.slice(currentRow, currentRow + maxRowspan)
                    });
                    // 跳过已覆盖的行
                    currentRow += maxRowspan;
                } else {
                    // 非主行：单独作为一组
                    mainRowsInfo.push({
                        mainRowIndex: currentRow,
                        start: currentRow,
                        end: currentRow,
                        rows: [row]
                    });
                    currentRow++;
                }
            }

            // 第二步：为每个行建立映射（子行→主行的所有组合行）
            const map = new Map();
            mainRowsInfo.forEach(info => {
                info.rows.forEach(row => {
                    map.set(row, info.rows);
                });
            });

            // 保存映射
            combinedRowsMap[tableType] = map;
        }

        // ========== 核心修复：不添加空白单元格，避免表格宽度变化 ==========
        function filterCombinedRows(tableType, input) {
            // 获取搜索列名和全局索引
            const colName = input.dataset.columnName || '';
            const globalColIndex = parseInt(input.dataset.columnIndex);
            const keyword = input.value.trim().toLowerCase();
            const tabContent = document.getElementById(tableType);

            if (!tabContent || isNaN(globalColIndex)) return;

            // 1. 获取所有数据行
            const table = tabContent.querySelector('.table');
            const allRows = Array.from(table.querySelectorAll('tr')).filter(row =>
                !row.querySelector('th') && !row.classList.contains('search-row')
            );

            // 2. 无关键词：显示所有行 + 清理新增的空白列
            if (keyword === '') {
                allRows.forEach(row => {
                    row.style.display = '';
                    // 移除之前添加的空白单元格（彻底清理）
                    const addedCells = row.querySelectorAll('.added-empty-cell');
                    addedCells.forEach(cell => cell.remove());
                });
                updateSelectAllStatus(tableType);
                return;
            }

            // 3. 先隐藏所有行 + 清理空白列
            allRows.forEach(row => {
                row.style.display = 'none';
                const addedCells = row.querySelectorAll('.added-empty-cell');
                addedCells.forEach(cell => cell.remove());
            });

            // 4. 区分待确认/已确认的列索引映射
            const columnConfig = {
                'delivery-pending': {
                    '车次': {main: 1, sub: -1},
                    'Carrier': {main: 2, sub: -1},
                    'Pickup Number': {main: 3, sub: -1},
                    'ISA': {main: 4, sub: 0},
                    '柜号': {main: 5, sub: 1},
                    '目的地': {main: 6, sub: 2},
                    '板数': {main: 7, sub: 3},
                    '价格': {main: 8, sub: 4},
                    '单板成本': {main: 9, sub: 5}
                },
                'delivery-confirm': {
                    '车次': {main: 1, sub: -1},
                    'Carrier': {main: 2, sub: -1},
                    'Pickup Number': {main: 3, sub: -1},
                    'ISA': {main: 4, sub: 0},
                    '柜号': {main: 5, sub: 1},
                    '目的地': {main: 6, sub: 2},
                    '板数': {main: 7, sub: 3},
                    '价格': {main: 8, sub: 4},
                    '单板成本': {main: 9, sub: 5}
                }
            };

            // 获取当前表格类型的列映射
            const columnMap = columnConfig[tableType] || columnConfig['delivery-pending'];
            // 获取当前表格主行列数（用于判断是否为主行）
            const mainRowCellCount = tableType === 'delivery-pending' ? 14 : 15;

            // 5. 找出所有匹配的行（核心：不添加单元格，只显示/隐藏）
            const rowsToShow = new Set();
            const map = combinedRowsMap[tableType];

            allRows.forEach((row) => {
                const cells = row.querySelectorAll('td');
                const isMainRow = cells.length === mainRowCellCount;
                let cellValue = '';
                let isMatch = false;

                // 根据行类型匹配对应索引
                if (isMainRow) {
                    // 主行：用全局索引
                    if (cells.length > globalColIndex) {
                        cellValue = cells[globalColIndex].textContent.trim().toLowerCase();
                        isMatch = cellValue.includes(keyword);
                    }
                } else {
                    // 子行：用列名找子行本地索引
                    const colConfig = columnMap[colName];
                    if (colConfig && colConfig.sub !== -1 && cells.length > colConfig.sub) {
                        cellValue = cells[colConfig.sub].textContent.trim().toLowerCase();
                        isMatch = cellValue.includes(keyword);
                    }
                }

                // 板数列特殊处理（≥ 匹配）
                if (colName === '板数') {
                    const numValue = parseFloat(cellValue) || 0;
                    const keywordNum = parseFloat(keyword) || 0;
                    isMatch = numValue >= keywordNum;
                }

                // 匹配成功则添加整个组合行（不修改DOM结构）
                if (isMatch) {
                    const combinedRows = map.get(row) || [row];
                    combinedRows.forEach(r => rowsToShow.add(r));
                }
            });

            // 6. 显示匹配的组合行（仅修改display，不修改DOM）
            rowsToShow.forEach(row => row.style.display = '');

            // 7. 更新全选状态
            updateSelectAllStatus(tableType);
        }

        // ========== 标签页切换初始化 ==========
        function initTabs() {
            // 主标签
            document.querySelectorAll('.content-tab').forEach(tab => {
                tab.addEventListener('click', function () {
                    document.querySelectorAll('.content-tab').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    const tabName = this.dataset.tab;
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    document.getElementById(`${tabName}-content`).classList.add('active');

                    // 激活第一个子标签
                    const firstSubTab = document.querySelector(`#${tabName}-content .sub-content-tab`);
                    if (firstSubTab) firstSubTab.click();
                });
            });

            // 子标签
            document.querySelectorAll('.sub-content-tab').forEach(tab => {
                tab.addEventListener('click', function () {
                    const parent = this.closest('.sub-content-tabs');
                    parent.querySelectorAll('.sub-content-tab').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    const subTabName = this.dataset.subtab;
                    const parentContent = this.closest('.tab-content');
                    parentContent.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    document.getElementById(subTabName).classList.add('active');

                    // 切换标签后重新加载组合行映射
                    setTimeout(() => {
                        preloadCombinedRowsMap();
                    }, 100);
                });
            });

            // 默认激活派送账单标签
            document.querySelector('.content-tab[data-tab="delivery"]').click();
        }

        // ========== 全选功能 ==========
        function initSelectAll() {
            // 待确认账单全选
            bindSelectAll('delivery-pending-select-all', 'delivery-pending-select-all-header', 'delivery-pending-checkbox', 'delivery-pending');
            // 已确认账单全选
            bindSelectAll('delivery-select-all', 'delivery-select-all-header', 'delivery-export-checkbox', 'delivery-confirm');
        }

        function bindSelectAll(selectAllId, headerId, checkboxClass, tableType) {
            const selectAll = document.getElementById(selectAllId);
            const headerSelectAll = document.getElementById(headerId);
            if (!selectAll || !headerSelectAll) return;

            // 同步两个全选框
            const syncCheckboxes = (checked) => {
                const checkboxes = document.querySelectorAll(`.${checkboxClass}`);
                checkboxes.forEach(checkbox => {
                    const tr = checkbox.closest('tr');
                    if (tr && tr.style.display !== 'none') {
                        checkbox.checked = checked;
                    }
                });
                updateSelectedCount(checkboxClass, tableType);
            };

            selectAll.addEventListener('click', function () {
                headerSelectAll.checked = this.checked;
                syncCheckboxes(this.checked);
            });

            headerSelectAll.addEventListener('click', function () {
                selectAll.checked = this.checked;
                syncCheckboxes(this.checked);
            });

            // 单个复选框变化
            document.querySelectorAll(`.${checkboxClass}`).forEach(checkbox => {
                checkbox.addEventListener('change', function () {
                    updateSelectAllStatus(tableType);
                });
            });

            updateSelectedCount(checkboxClass, tableType);
        }

        function updateSelectAllStatus(tableType) {
            let checkboxClass, selectAllId, headerId;
            if (tableType === 'delivery-pending') {
                checkboxClass = 'delivery-pending-checkbox';
                selectAllId = 'delivery-pending-select-all';
                headerId = 'delivery-pending-select-all-header';
            } else {
                checkboxClass = 'delivery-export-checkbox';
                selectAllId = 'delivery-select-all';
                headerId = 'delivery-select-all-header';
            }

            const checkboxes = document.querySelectorAll(`.${checkboxClass}`);
            let visibleCount = 0, checkedCount = 0;

            checkboxes.forEach(checkbox => {
                const tr = checkbox.closest('tr');
                if (tr && tr.style.display !== 'none') {
                    visibleCount++;
                    if (checkbox.checked) checkedCount++;
                }
            });

            const isAllChecked = visibleCount > 0 && checkedCount === visibleCount;
            document.getElementById(selectAllId).checked = isAllChecked;
            document.getElementById(headerId).checked = isAllChecked;
            updateSelectedCount(checkboxClass, tableType);
        }

        function updateSelectedCount(checkboxClass, tableType) {
            const count = document.querySelectorAll(`.${checkboxClass}:checked`).length;
            const countId = tableType === 'delivery-pending' ? 'delivery-pending-selected-count' : 'delivery-selected-count';
            document.getElementById(countId).textContent = `已选：${count} 条`;
        }

        // ========== 绑定搜索框事件 ==========
        function bindSearchEvents() {
            document.querySelectorAll('.search-input').forEach(input => {
                // 移除原有内联事件
                input.removeAttribute('onkeyup');

                // 绑定输入/回车事件
                input.addEventListener('input', function () {
                    const tableType = this.closest('.tab-content').id;
                    filterCombinedRows(tableType, this);
                });

                input.addEventListener('keydown', function (e) {
                    if (e.key === 'Enter') {
                        const tableType = this.closest('.tab-content').id;
                        filterCombinedRows(tableType, this);
                    }
                });
            });
        }

        // ========== 导出收集选中的车次ID ==========
        function initExportCollect() {
            // 待确认导出
            document.getElementById('delivery-pending-export-form').addEventListener('submit', function (e) {
                const checked = document.querySelectorAll('.delivery-pending-checkbox:checked');
                const fleetIds = Array.from(checked).map(c => c.dataset.fleetId).filter(id => id);
                if (fleetIds.length === 0) {
                    alert('请勾选至少一条记录！');
                    e.preventDefault();
                    return;
                }
                document.getElementById('selected_pending_fleet_ids').value = fleetIds.join(',');
            });

            // 已确认导出
            document.getElementById('delivery-export-form').addEventListener('submit', function (e) {
                const checked = document.querySelectorAll('.delivery-export-checkbox:checked');
                const fleetIds = Array.from(checked).map(c => c.dataset.fleetId).filter(id => id);
                if (fleetIds.length === 0) {
                    alert('请勾选至少一条记录！');
                    e.preventDefault();
                    return;
                }
                document.getElementById('selected_fleet_ids').value = fleetIds.join(',');
            });
        }

        // ========== 保留原有必要函数 ==========
        function scrollToBottom() {
            window.scrollTo({top: document.body.scrollHeight, behavior: 'smooth'});
        }

        window.onclick = function (event) {
            document.querySelectorAll('.modal').forEach(modal => {
                if (event.target === modal) modal.style.display = 'none';
            });
        };
    </script>
{% endblock %}