{% extends 'base.html' %}

{% block content %}
<form method="post" action="" class="mb-0">
    {% csrf_token %}
    <input type="hidden" name="step" value="payable_save">
    <input type="hidden" name="save_type" id="save_type" value="">
    <input type="hidden" name="container_number" value="{{ container_number }}">
    <input type="hidden" name="start_date" value="{{ start_date }}">
    <input type="hidden" name="end_date" value="{{ end_date }}">
    <input type="hidden" name="warehouse_filter" value="{{ warehouse_filter }}">
    <input type="hidden" name="invoice_number" value="{{ invoice_number }}">
    <input type="hidden" name="preport_carrier" value="{{ preport_carrier }}">
    <input type="hidden" id="total_amount_input" name="total_amount" value="0">

<style>
    .fee-table {
        border-collapse: separate;
        border-spacing: 0;
        width: 100%;
    }
    .fee-table thead th {
        background-color: #f1f5f9; 
        color: #2c3e50; 
        border-bottom: 2px solid #dee2e6;
    }
    .fee-table tbody tr {
        transition: all 0.2s ease;
    }
    .fee-table tbody tr:hover {
        background-color: #f8f9fa !important;
    }
    .fee-table td {
        padding: 12px 15px;
        border-bottom: 1px solid #e9ecef;
        vertical-align: middle;
    }
    .fee-table tbody tr:last-child td {
        border-bottom: 2px solid #dee2e6;
    }
    .fee-item {
        display: flex;
        align-items: center;
        gap: 10px;
    }
    .fee-icon-container {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background-color: #e9f5ff;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .fee-icon {
        color: #3498db;
        font-size: 16px;
    }
    .fee-detail {
        color: #7f8c8d;
        font-size: 0.85rem;
    }
    .fee-amount {
        font-weight: 600;
        color: #2c3e50;
    }
    .supplier-select {
        border: 1px solid #dfe6e9;
        border-radius: 6px;
        padding: 6px 12px;
        background-color: white;
        width: 100%;
        max-width: 250px;
    }
    .invoice-header {
        background-color: #2c3e50;
        color: white;
        border-bottom: 1px solid #34495e;
    }
    .total-amount {
        font-size: 1.5rem;
        color: #212529;
    }
    .fee-table {
        background-color: #fff;
    }
    .fee-table thead {
        background-color: #f8f9fa;
    }
    .fee-icon {
        color: #6c757d;
        margin-right: 8px;
    }
    .border-highlight {
        border-left: 3px solid #e9ecef;
        padding-left: 12px;
    }
    .btn-outline-light {
        border-color: #dee2e6;
    }
    /* 其他费用样的样式 */
    .additional-fees-header {
        display: flex;
        align-items: center;
        margin-bottom: 15px;
    }
    .additional-fees-title {
        flex-grow: 1;
        color: #6c757d;
    }
    .add-fee-btn {
        opacity: 1; 
        transition: all 0.3s ease;
    }
    .add-fee-btn:hover {
        transform: translateY(-1px);
    }
    .readonly-amount {
        display: inline-block;
        min-width: 80px;
        padding: 6px 12px;
        background-color: #f8f9fa;
        border-radius: 4px;
        font-weight: 600;
        color: #2c3e50;
    }
</style>
{% if reason %}
    <div class="alert alert-danger d-flex align-items-center py-2 px-3 mb-0">
        <i class="bi bi-exclamation-triangle-fill me-2"></i>
        <span>{{ reason }}</span>
    </div>
{% else %}
<div class="container-fluid mt-3">
    <div class="card-header p-2 invoice-header">
        <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0 d-flex align-items-center">
                <i class="bi bi-cash-stack me-1"></i>
                应付费用账单: $        
                {% if not is_confirm %}     
                    <span id="totalAmountDisplay" name="totalAmountDisplay" class="mx-1">0.0</span>
                {% else %}
                    <span> {{ payable_total_amount }} </span>
                {% endif %}
            </h5>
    
            <span class="mx-auto" style="font-size: 1rem; color: white;">{{ invoice_number }}-{{ container_number }}
                {% if is_save_invoice %} （已存数据）{% else %}（报价表计算）{% endif %}
            </span>            
            
            {% if is_confirm %}
                <!-- 已审核/已录入页面：只显示返回按钮 -->
                <button type="submit" class="btn btn-success btn-sm" onclick="modifyStatus('return')">
                    <i class="bi bi-arrow-left-circle me-1"></i>返回
                </button>
            {% elif not is_save_invoice %}
                <div class="d-flex align-items-center">
                    <button type="submit" class="btn btn-success btn-sm me-2" onclick="modifyStatus('complete')">
                        <i class="bi bi-check-circle me-1"></i>确认账单1
                    </button>
                </div>
            {% elif is_save_invoice and is_rejected%}
                <div class="d-flex align-items-center">
                    <button type="submit" class="btn btn-success btn-sm me-2" onclick="modifyStatus('complete')">
                        <i class="bi bi-check-circle me-1"></i>确认账单2
                    </button>
                </div>
                &nbsp;&nbsp;
                <!-- 如果是驳回状态，显示驳回原因 -->
                <div class="alert alert-warning py-1 mb-0 d-flex align-items-center ms-2">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                    <div>
                        <strong>驳回原因：</strong>
                        <span>{{ reject_reason }}</span>
                    </div>
                </div>
            {% else %}
                <!-- 待审核/待录入页面 -->
                {% if user_is_leader %}
                    <!-- 待审核页面（组长看到的审核按钮） -->
                    <div class="d-flex align-items-stretch" style="gap: 1rem;">
                        <div class="d-flex align-items-center position-relative">
                            <button type="submit" class="btn btn-danger btn-sm px-3" onclick="modifyStatus('reject_check')">
                                <i class="bi bi-x-circle me-1"></i>初级审核驳回
                            </button>
                            
                            <div class="mx-3" style="width: 200px;">
                                <input type="text" class="form-control form-control-sm" 
                                    placeholder="请输入驳回原因" name="reject_reason">
                            </div>
                            
                            <div class="vr mx-2" style="height: 30px;"></div>
                            
                            <button type="submit" class="btn btn-success btn-sm px-3" onclick="modifyStatus('check_confirm')">
                                <i class="bi bi-check-circle me-1"></i>初级审核通过
                            </button>
                        </div>
                    </div>
                {% endif %}
            {% endif %}
        </div>   
    </div>

    <div class="card shadow-sm border-0 rounded-bottom">
        <div class="card-body p-4">
            <div class="row mb-4 g-4">
                <div class="col-md-4">
                    <div class="border-highlight">
                        <h6 class="text-muted mb-2">仓库信息</h6>
                        <h5 class="mb-0">{{ warehouse }}</h5>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="border-highlight">
                        <h6 class="text-muted mb-2">柜型</h6>
                        <h5 class="mb-0">{{ container_type }}</h5>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="border-highlight">
                        <h6 class="text-muted mb-2">提柜供应商</h6>
                        <h5 class="mb-0">{{ preport_carrier }}</h5>
                    </div>
                </div>
            </div>

            <div class="table-responsive">
                <table class="table fee-table">
                    <thead>
                        <tr>
                            <th width="40%">费用项目</th>
                            <th width="40%">详情</th>
                            <th width="20%" class="text-end">金额 (USD)</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- 提柜费用 -->
                        <tr>
                            <td>
                                <div class="fee-item">
                                    <div class="fee-icon-container" style="background-color: #e3f2fd;">
                                        <i class="bi bi-truck fee-icon" style="color: #1565c0;"></i>
                                    </div>
                                    <span>提柜费用</span>
                                </div>
                            </td>
                            <td>
                                <small class="fee-detail">基础费用</small>
                            </td>
                            <td class="text-end fee-amount">
                                {% if not is_confirm %}
                                    <!-- 驳回状态：显示数据库值，但旁边显示报价表参考值 -->
                                    <input type="text" name="basic_fee" value="{{ basic_fee }}" oninput="calculateTotal()">
                                {% else %}
                                    <!-- 只读状态 -->
                                    <span class="readonly-amount">{{ basic_fee|floatformat:2 }}</span>
                                {% endif %}                         
                            </td>
                        </tr>

                        <!-- 入库费/拆柜费 -->
                        {% if not arrive_fee %}
                            {%if pallet_details or palletization_carrier or palletization_fee %}                            
                                <tr>
                                    <td>
                                        <div class="fee-item">
                                            <div class="fee-icon-container">
                                                <i class="bi bi-box-seam fee-icon"></i>
                                            </div>
                                            <span>拆柜费用</span>
                                        </div>
                                    </td>
                                    <td>
                                        {% if is_confirm %}
                                            <!-- 只读状态下显示供应商名称 -->
                                            {% if palletization_carrier %}
                                                <small class="fee-detail">{{ palletization_carrier }}</small>
                                            {% endif %}
                                        {% else %}
                                            {% if pallet_details %}
                                                <select class="supplier-select" id="select_carrier" onchange="updateUnloadingFee(this)">
                                                    <option value="">-- 选择供应商 --</option>
                                                    {% for key,value in pallet_details.items %}
                                                    <option value="{{ value }}" data-name="{{ key }}" 
                                                            {% if key == palletization_carrier %}selected{% endif %}>
                                                        {{ key }} - ${{ value }}
                                                    </option>
                                                    {% endfor %}
                                                </select>
                                                <input type="hidden" name="palletization_carrier" id="palletization_carrier" value="{{ palletization_carrier }}">
                                            {% endif %}                          
                                        {% endif %}
                                    </td>
                                    <td class="text-end fee-amount">
                                        {% if not is_confirm %}
                                            <!-- 可编辑或驳回状态下显示输入框 -->
                                            <input type="text" name="palletization_fee" id="palletization_fee_input" value="{{ palletization_fee|default:0 }}" oninput="calculateTotal()">
                                        {% else %}
                                            <!-- 只读状态下显示金额 -->
                                            <span class="readonly-amount">{{ palletization_fee|floatformat:2 }}</span>
                                        {% endif %}
                                    </td>
                                </tr>
                            {% endif %}
                        {% endif %}

                        {% if arrive_fee %}
                        <tr>
                            <td>
                                <div class="fee-item">
                                    <div class="fee-icon-container" style="background-color: #e8f5e9;">
                                        <i class="bi bi-box-arrow-in-down fee-icon" style="color: #27ae60;"></i>
                                    </div>
                                    <span>入库拆柜费</span>
                                </div>
                            </td>
                            <td>
                                <div class="fee-detail">基础费用</div>
                            </td>
                            <td class="text-end fee-amount">
                                {% if not is_confirm %}
                                    <input type="text" name="arrive_fee" value="{{ arrive_fee }}" oninput="calculateTotal()">
                                {% elif is_save_invoice %}
                                    <span id="unloading_fee_display">{{ arrive_fee }}</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endif %}
                        
                        <!-- 超重费 -->
                        <tr>
                            <td>
                                <div class="fee-item">
                                    <div class="fee-icon-container" style="background-color: #ffebee;">
                                        <i class="bi bi-exclamation-triangle fee-icon" style="color: #e74c3c;"></i>
                                    </div>
                                    <span>超重费用</span>
                                </div>
                            </td>
                            <td>
                                <div class="fee-detail">当前重量: {{ actual_weight }} 磅 {% if overweight_fee %}(超过42,000磅){% else %}未超重{% endif %}</div>
                            </td>
                            
                            {% if overweight_fee %}
                            <td class="text-end fee-amount">
                                {% if not is_confirm %}
                                    <input type="text" name="overweight_fee" value="{{ overweight_fee }}" oninput="calculateTotal()">
                                {% else %}
                                    <span class="readonly-amount">{{ overweight_fee|floatformat:2 }}</span>
                                {% endif %}
                            </td>   
                            {% else %}
                                <td>不产生费用</td>
                            {% endif %}                       
                            </td>
                        </tr>
                        
                        <!-- 车架费 -->
                        <tr>
                            <td>
                                <div class="fee-item">
                                    <div class="fee-icon-container" style="background-color: #fff8e1;">
                                        <i class="bi bi-truck-flatbed fee-icon" style="color: #f39c12;"></i>
                                    </div>
                                    <span>车架费用</span>
                                </div>
                            </td>
                            {% if actual_day %}
                                {% if chassis_fee %}
                                    <td>
                                        <div class="d-flex align-items-center gap-2">
                                            <span class="badge bg-danger">已超期</span>
                                            <span class="day-count">{{ actual_day }} 天</span>
                                        </div>
                                        <div class="timestamp-container bg-light rounded p-2">
                                            <div class="d-flex align-items-center timestamp-item">
                                                <i class="bi bi-calendar2-event me-2 text-secondary"></i>&nbsp;&nbsp;
                                                <span class="text-muted small">提柜:&nbsp;&nbsp;</span>
                                                <span class="ms-2 small fw-medium">{{ actual_retrieval_timestamp|date:"Y-m-d H:i"|default:"缺少时间" }}</span>
                                            </div>
                                            <div class="d-flex align-items-center timestamp-item">
                                                <i class="bi bi-calendar2-event me-2 text-secondary"></i>&nbsp;&nbsp;
                                                <span class="text-muted small">LFD:&nbsp;&nbsp;</span>
                                                <span class="ms-2 small fw-medium">{{ lfd|date:"Y-m-d"|default:"缺少时间" }}</span>
                                            </div>
                                            <div class="d-flex align-items-center timestamp-item mt-1">
                                                <i class="bi bi-calendar2-check me-2 text-secondary"></i>&nbsp;&nbsp;
                                                <span class="text-muted small">还空:&nbsp;&nbsp;</span>
                                                <span class="ms-2 small fw-medium">{{ empty_returned_at|date:"Y-m-d H:i"|default:"缺少时间" }}</span>
                                            </div>
                                        </div>                                   
                                    </td>
                                    <td class="text-end fee-amount">
                                        {% if not is_confirm %}
                                            <input type="text" name="chassis_fee" value="{{ chassis_fee }}" oninput="calculateTotal()">
                                        {% elif is_save_invoice %}
                                            <span class="readonly-amount">{{ chassis_fee|floatformat:2 }}</span>
                                        {% endif %}                           
                                    </td>
                                {% else %}                                
                                    <td>
                                        <div class="d-flex align-items-center gap-2">
                                            <span class="badge bg-success">未超期</span>
                                            <span class="day-count">{{ actual_day }} 天</span>
                                        </div>
                                        <div class="timestamp-container bg-light rounded p-2">
                                            <div class="d-flex align-items-center timestamp-item">
                                                <i class="bi bi-calendar2-event me-2 text-secondary"></i>
                                                <span class="text-muted small">提柜:</span>
                                                <span class="ms-2 small fw-medium">{{ actual_retrieval_timestamp|date:"Y-m-d H:i" }}</span>
                                            </div>
                                            <div class="d-flex align-items-center timestamp-item mt-1">
                                                <i class="bi bi-calendar2-check me-2 text-secondary"></i>
                                                <span class="text-muted small">还空:</span>
                                                <span class="ms-2 small fw-medium">{{ empty_returned_at|date:"Y-m-d H:i" }}</span>
                                            </div>
                                        </div>    
                                    </td>
                                    <td>不产生费用</td>
                                {% endif %}
                            {% else %}
                                {% if preport_carrier == '东海岸' %}
                                <td colspan="2">缺少LFD，无法计算</td>
                                {% else %}
                                <td colspan="2">不产生车架费</td>
                                {% endif %}
                            {% endif %}
                        </tr>

                        <!-- 港内滞港费 -->
                        <tr>
                            <td>
                                <div class="fee-item">
                                   <div class="fee-icon-container" style="background-color: #e3f2fd;">
                                        <i class="bi bi-shop" style="color: #1565c0;"></i>
                                    </div>
                                    <span>滞港费用</span>
                                </div>
                            </td>                       
                            <td colspan="2">
                                {% if not is_confirm %}
                                    <input type="text" name="demurrage_fee" value="{{ demurrage_fee|default_if_none:'' }}" oninput="calculateTotal()">
                                {% else %}
                                    <span class="readonly-amount">{{ demurrage_fee }}</span>
                                {% endif %}
                            </td>                      
                        </tr>

                         <!-- 港外滞港费 -->
                        <tr>
                            <td>
                                <div class="fee-item">
                                    <div class="fee-icon-container" style="background-color: #ffebee;">
                                        <i class="bi bi-box-seam" style="color: #b71c1c;"></i>
                                    </div>
                                    <span>滞箱费用</span>
                                </div>
                            </td>                       
                            <td colspan="2">
                                {% if not is_confirm %}
                                    <input type="text" name="per_diem_fee" value="{{ per_diem_fee|default_if_none:'' }}" oninput="calculateTotal()">
                                {% else %}
                                    <span class="readonly-amount">{{ per_diem_fee }}</span>
                                {% endif %}
                            </td>                      
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="mt-4 pt-3 border-top">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6 class="mb-3 d-flex align-items-center text-muted">
                        <i class="bi bi-plus-circle fee-icon me-2"></i>
                        <span>其他费用&nbsp;&nbsp;</span>
                    </h6>
                </div>
                
                <div class="row">
                    <!-- 提柜其他费用 (左侧) -->
                    <div class="col-md-6">
                        <div class="card mb-4">
                            <div class="card-header py-2" style="background-color: #e3f7ff; border-left: 4px solid #1890ff;">
                                <span class="fw-bold text-primary">
                                    <i class="bi bi-truck me-2"></i>提柜其他费用
                                </span>
                                <button type="button" class="btn btn-primary btn-sm" onclick="addFeeGroup('pickup')">
                                    <i class="bi bi-plus me-1"></i>添加费用
                                </button>
                            </div>
                            <div class="card-body p-2">
                                <div id="pickup-fees-container">
                                    {% for fee_name, fee_amount in pickup_other_fee.items %}
                                    <div class="fee-group row g-2 mb-2 align-items-center">
                                        <div class="col-7">
                                            {% if not is_confirm %}
                                                <input type="text" class="form-control form-control-sm" 
                                                    name="pickup_fee_name" value="{{ fee_name }}" placeholder="费用名称">
                                            {% else %}
                                                <span class="readonly-amount">{{ fee_name }}</span>
                                            {% endif %}
                                        </div>
                                        <div class="col-4">
                                            {% if not is_confirm %}
                                                <input type="number" step="0.01" class="form-control form-control-sm fee-amount-input" 
                                                    name="pickup_fee_amount" value="{{ fee_amount|floatformat:2 }}" 
                                                    placeholder="金额" oninput="calculateTotal()">
                                            {% else %}
                                                <span class="readonly-amount">{{ fee_amount|floatformat:2 }}</span>
                                            {% endif %}
                                        </div>
                                        <div class="col-1">
                                            {% if not is_confirm %}
                                            <button type="button" class="btn btn-outline-danger btn-sm" 
                                                    onclick="removeFeeGroup(this, 'pickup')">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                            {% endif %}
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 拆柜其他费用 (右侧) -->
                    <div class="col-md-6">
                        <div class="card mb-4">
                            <div class="card-header py-2" style="background-color: #fff8e6; border-left: 4px solid #ffa940;">
                                <span class="fw-bold" style="color: #d46b08;">
                                    <i class="bi bi-box-seam me-2"></i>拆柜其他费用
                                </span>
                                <button type="button" class="btn btn-sm" style="background-color: #ffa940; color: white;" onclick="addFeeGroup('pallet')">
                                    <i class="bi bi-plus me-1"></i>添加费用
                                </button>
                            </div>
                            <div class="card-body p-2">
                                <div id="pallet-fees-container">
                                    {% for fee_name, fee_amount in pallet_other_fee.items %}
                                    <div class="fee-group row g-2 mb-2 align-items-center">
                                        <div class="col-7">
                                            {% if not is_confirm %}
                                                <input type="text" class="form-control form-control-sm" 
                                                    name="pallet_fee_name" value="{{ fee_name }}" placeholder="费用名称">
                                            {% else %}
                                                <span class="readonly-amount">{{ fee_name }}</span>
                                            {% endif %}
                                        </div>
                                        <div class="col-4">
                                            {% if not is_confirm %}
                                                <input type="number" step="0.01" class="form-control form-control-sm fee-amount-input" 
                                                    name="pallet_fee_amount" value="{{ fee_amount|floatformat:2 }}" 
                                                    placeholder="金额" oninput="calculateTotal()">
                                            {% else %}
                                            
                                                <span class="readonly-amount">{{ fee_amount|floatformat:2 }}</span>
                                            {% endif %}
                                        </div>
                                        <div class="col-1">
                                            {% if not is_confirm %}
                                            <button type="button" class="btn btn-outline-danger btn-sm" 
                                                    onclick="removeFeeGroup(this, 'pallet')">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                            {% endif %}
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>        
            </div>

            <!-- 模板部分 -->
            <div id="pickup-fee-template" style="display: none;">
                <div class="fee-group row g-2 mb-2 align-items-center">
                    <div class="col-7">
                        <input type="text" class="form-control form-control-sm" name="pickup_fee_name" placeholder="费用名称">
                    </div>
                    <div class="col-4">
                        <input type="number" step="0.01" class="form-control form-control-sm fee-amount-input" 
                            name="pickup_fee_amount" placeholder="金额" oninput="calculateTotal()">
                    </div>
                    <div class="col-1">
                        <button type="button" class="btn btn-outline-danger btn-sm" 
                                onclick="removeFeeGroup(this, 'pickup')">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </div>
            </div>

            <div id="pallet-fee-template" style="display: none;">
                <div class="fee-group row g-2 mb-2 align-items-center">
                    <div class="col-7">
                        <input type="text" class="form-control form-control-sm" name="pallet_fee_name" placeholder="费用名称">
                    </div>
                    <div class="col-4">
                        <input type="number" step="0.01" class="form-control form-control-sm fee-amount-input" 
                            name="pallet_fee_amount" placeholder="金额" oninput="calculateTotal()">
                    </div>
                    <div class="col-1">
                        <button type="button" class="btn btn-outline-danger btn-sm" 
                                onclick="removeFeeGroup(this, 'pallet')">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}
</form>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const selectCarrier = document.getElementById('select_carrier');
        if (selectCarrier) {
            updateUnloadingFee(selectCarrier);
        }
        calculateTotal();
    });

    function setSaveType(type) {
        document.getElementById('save_type').value = type;
    }

    function addFeeGroup(type) {
        const container = document.getElementById(`${type}-fees-container`);
        const template = document.getElementById(`${type}-fee-template`);
        const newGroup = template.cloneNode(true);
        newGroup.style.display = 'flex';
        newGroup.removeAttribute('id');
        container.appendChild(newGroup);
    }

    function removeFeeGroup(button) {
        if (confirm('确定要删除此费用吗？')) {
            const group = button.closest('.fee-group');
            group.remove();
            calculateTotal();
        }
    }

    function updateUnloadingFee(select) {
        const selectedOption = select.options[select.selectedIndex];
        const feeValue = selectedOption.value;
        const feeInput = document.getElementById('palletization_fee_input');
        if (feeInput) {
            feeInput.value = feeValue;
        }
        
        const plt_carrier = selectedOption.dataset.name;
        document.getElementById('palletization_carrier').value = plt_carrier;       
        calculateTotal();

    }

    function calculateTotal() {
        let total = 0;
        
        const feeFields = [
            'basic_fee',
            'overweight_fee',
            'chassis_fee',
            'arrive_fee',
            'palletization_fee',
            'demurrage_fee',
            'per_diem_fee'
        ];
        
        feeFields.forEach(field => {        
            const input = document.querySelector(`input[name="${field}"]`);
            if (input && input.value) {
                total += parseFloat(input.value) || 0;
                console.log('加的值是',input.value);
            }
        });
        console.log('总费用-1',total);

        document.querySelectorAll('input[name="pickup_fee_amount"]').forEach(input => {
            total += parseFloat(input.value) || 0;
        });
        console.log('总费用-2',total);
        document.querySelectorAll('input[name="pallet_fee_amount"]').forEach(input => {
            total += parseFloat(input.value) || 0;
        });
        console.log('总费用-3',total);
        document.getElementById('totalAmountDisplay').textContent = total.toFixed(2);
        document.getElementById('total_amount_input').value = total.toFixed(2);
    }
    function modifyStatus(type) {
        const saveTypeInput = document.getElementById('save_type');
        saveTypeInput.value = type; 
    }
</script>
{% endblock %}